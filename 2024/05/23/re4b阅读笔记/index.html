<!DOCTYPE html><html lang="[&quot;en&quot;,&quot;zh-CN&quot;,&quot;default&quot;]"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="Npc"><meta name="copyright" content="Npc"><meta name="generator" content="Hexo 7.1.1"><meta name="theme" content="hexo-theme-yun"><title>re4bé˜…è¯»ç¬”è®° | Npc | Blog</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/star-markdown-css@0.4.1/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/my_blog_prism@1.0.5/prism.css"><script src="https://cdn.jsdelivr.net/npm/my_blog_prism@1.0.5/prism.js"></script><script src="https://fastly.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".markdown-body img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link rel="stylesheet" type="text/css" href="https://fastly.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script defer src="https://fastly.jsdelivr.net/npm/katex@latest/dist/katex.min.js"></script><link rel="stylesheet" type="text/css" href="https://fastly.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.min.css"><script defer src="https://fastly.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.min.js"></script><script defer src="https://fastly.jsdelivr.net/npm/katex@latest/dist/contrib/auto-render.min.js"></script><script type="module">import { renderKatex } from '/js/utils.js'
document.addEventListener("DOMContentLoaded", () => {
  renderKatex({
    ...{},
    ...true?.options,
  });
});</script><link rel="icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="preconnect" href="https://fastly.jsdelivr.net/npm/" crossorigin><script id="yun-config">
    window.Yun = {}
    window.CONFIG = {"hostname":"npc0vo.github.io","root":"/","title":"Npcå°ç«™","version":"1.10.11","mode":"light","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}.","hits":"${hits} results found","hits_time":"${hits} results found in ${time} ms"},"anonymous_image":"https://cdn.yunyoujun.cn/img/avatar/none.jpg","say":{"api":"https://el-bot-api.vercel.app/api/words/young"},"local_search":{"path":"/search.xml"},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"fireworks":{"colors":null},"waline":{"config":{"enable":true,"serverURL":"https://waline-onelastchicks-projects.vercel.app/","comment":false,"el":"#waline","lang":["en","zh-CN","default"]},"cdn":"https://fastly.jsdelivr.net/npm/@waline/client@v2/dist/waline.js","dark":"html.dark"},"vendors":{"host":"https://fastly.jsdelivr.net/npm/","darken":"https://fastly.jsdelivr.net/npm/darken@1.5.0"}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/hexo-theme-yun.js" type="module"></script><script src="//at.alicdn.com/t/font_1140697_dxory92pb0h.js" async></script><link rel="preconnect" href="https://www.google-analytics.com" crossorigin><script async src="https://www.googletagmanager.com/gtag/js?id=G-1LL0D86CY9"></script><script>if (CONFIG.hostname === location.hostname) {
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-1LL0D86CY9');
}</script><script data-ad-client="ca-pub-2245427233262012" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(function(){
  var bp = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https') {
    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else {
    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})();</script><!-- Google Tag Manager --><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-M9KWR9L');</script><!-- End Google Tag Manager --><meta name="description" content="Part.1 å‰è¨€ å¯¹äºé€†å‘å·¥ç¨‹æƒå¨æŒ‡å—å…³é”®éƒ¨åˆ†çš„æ‘˜å½•,æ•´ç†ä»¥åŠä¸ªäººçš„ç†è§£ é€†å‘å·¥ç¨‹æƒå¨æŒ‡å—æ˜¯å…¥é—¨é€†å‘å¿…è¯»çš„ä¸€æœ¬ä¹¦ç± ç”±äºæˆ‘æ˜¯åˆå­¦è€…ï¼Œæ‰€ä»¥æˆ‘ç›®å‰åªå­¦ä¹ re4b x86æ±‡ç¼–éƒ¨åˆ†ï¼Œå¯¹äºARMä»¥åŠMIPSæ¶æ„å¾…ä»¥åè¿›é˜¶åå†è¿›è¡Œå­¦ä¹   Part.2 æŒ‡ä»¤è®²è§£  Chapter1 CPU **æŒ‡ä»¤ç ï¼šCPUå—ç†çš„åº•å±‚å‘½ä»¤ã€‚å…¸å‹çš„åº•å±‚å‘½ä»¤æœ‰ï¼šå°†æ•°æ®åœ¨å¯„å­˜å™¨é—´è½¬ç§»ã€æ“ä½œå†…å­˜ã€è®¡ç®—è¿ç®—ç­‰æŒ‡ä»¤ã€‚æ¯ç±»CPUéƒ½æœ‰è‡ªå·±">
<meta property="og:type" content="article">
<meta property="og:title" content="re4bé˜…è¯»ç¬”è®°">
<meta property="og:url" content="http://npc0vo.github.io/2024/05/23/re4b%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="Npc | Blog">
<meta property="og:description" content="Part.1 å‰è¨€ å¯¹äºé€†å‘å·¥ç¨‹æƒå¨æŒ‡å—å…³é”®éƒ¨åˆ†çš„æ‘˜å½•,æ•´ç†ä»¥åŠä¸ªäººçš„ç†è§£ é€†å‘å·¥ç¨‹æƒå¨æŒ‡å—æ˜¯å…¥é—¨é€†å‘å¿…è¯»çš„ä¸€æœ¬ä¹¦ç± ç”±äºæˆ‘æ˜¯åˆå­¦è€…ï¼Œæ‰€ä»¥æˆ‘ç›®å‰åªå­¦ä¹ re4b x86æ±‡ç¼–éƒ¨åˆ†ï¼Œå¯¹äºARMä»¥åŠMIPSæ¶æ„å¾…ä»¥åè¿›é˜¶åå†è¿›è¡Œå­¦ä¹   Part.2 æŒ‡ä»¤è®²è§£  Chapter1 CPU **æŒ‡ä»¤ç ï¼šCPUå—ç†çš„åº•å±‚å‘½ä»¤ã€‚å…¸å‹çš„åº•å±‚å‘½ä»¤æœ‰ï¼šå°†æ•°æ®åœ¨å¯„å­˜å™¨é—´è½¬ç§»ã€æ“ä½œå†…å­˜ã€è®¡ç®—è¿ç®—ç­‰æŒ‡ä»¤ã€‚æ¯ç±»CPUéƒ½æœ‰è‡ªå·±">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://npc0vo.github.io/2024/05/23/re4b%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image-20240609142026432.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/05/23/re4b%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image-20240609153017613.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/05/23/re4b%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image-20240609202329684.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/05/23/re4b%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image-20240610211849193.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/05/23/re4b%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image-20240610144056548.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/05/23/re4b%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image-20240610144124263.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/05/23/re4b%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image-20240612161235490.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/05/23/re4b%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image-20240612161445800.png">
<meta property="article:published_time" content="2024-05-23T08:25:47.000Z">
<meta property="article:modified_time" content="2025-01-13T11:50:45.421Z">
<meta property="article:author" content="Npc">
<meta property="article:tag" content="å­¦ä¹ ç¬”è®°">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://npc0vo.github.io/2024/05/23/re4b%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image-20240609142026432.png"><script>(function() {
  if (CONFIG.mode !== 'auto') return
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script></head><body><script src="https://code.iconify.design/2/2.1.1/iconify.min.js"></script><script>// Define global variable
IconifyProviders = {
  // Empty prefix: overwrite default API provider configuration
  '': {
    // Use custom API first, use Iconify public API as backup
    resources: [
        'https://api.iconify.design',
    ],
    // Wait for 1 second before switching API hosts
    rotate: 1000,
  },
};</script><script defer src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js" type="module"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="Table of Contents"><span class="icon iconify" data-icon="ri:list-ordered"></span></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="Overview"><span class="icon iconify" data-icon="ri:passport-line"></span></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="Npc"><img width="96" loading="lazy" src="/images/avatar.jpg" alt="Npc"><span class="site-author-status">ğŸ˜­</span></a><div class="site-author-name"><a href="/about/">Npc</a></div><span class="site-name">Npc | Blog</span><sub class="site-subtitle">åˆæ´»äº†ä¸€å¤©</sub><div class="site-description"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="Home"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:home-4-line"></span></span></a><div class="site-state-item"><a href="/archives/" title="Archives"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:archive-line"></span></span><span class="site-state-item-count">81</span></a></div><div class="site-state-item"><a href="/categories/" title="Categories"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:folder-2-line"></span></span><span class="site-state-item-count">13</span></a></div><div class="site-state-item"><a href="/tags/" title="Tags"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="site-state-item-count">17</span></a></div><a class="site-state-item hty-icon-button" href="/about/#comment" title="ç•™è¨€æ¿"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:clipboard-line"></span></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/npc0vo" title="GitHub" target="_blank" style="color:#6e5494"><span class="icon iconify" data-icon="ri:github-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:me@1930278836@qq.com" title="E-Mail" target="_blank" style="color:#8E71C1"><span class="icon iconify" data-icon="ri:mail-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.yuque.com/npc0vo" title="Yuque" target="_blank" style="color:#a0c69d"><span class="icon iconify" data-icon="ri:yuque-line"></span></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="æˆ‘çš„å°ä¼™ä¼´ä»¬" style="color:dodgerblue"><span class="icon iconify" data-icon="ri:genderless-line"></span></a></div></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#part1-%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text"> Part.1 å‰è¨€</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#part2-%E6%8C%87%E4%BB%A4%E8%AE%B2%E8%A7%A3"><span class="toc-number">2.</span> <span class="toc-text"> Part.2 æŒ‡ä»¤è®²è§£</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#chapter1-cpu"><span class="toc-number">2.1.</span> <span class="toc-text"> Chapter1 CPU</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap2-%E6%9C%80%E7%AE%80%E5%87%BD%E6%95%B0"><span class="toc-number">2.2.</span> <span class="toc-text"> Chap2 æœ€ç®€å‡½æ•°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap3-helloworld"><span class="toc-number">2.3.</span> <span class="toc-text"> Chap3 Hello,World!</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#msvs"><span class="toc-number">2.3.1.</span> <span class="toc-text"> msvs</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gcc"><span class="toc-number">2.3.2.</span> <span class="toc-text"> gcc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#msvs-x86-64"><span class="toc-number">2.3.3.</span> <span class="toc-text"> msvs x86-64</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gcc-x86-64"><span class="toc-number">2.3.4.</span> <span class="toc-text"> gcc x86-64</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#problems"><span class="toc-number">2.3.5.</span> <span class="toc-text"> Problems</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap4-%E5%87%BD%E6%95%B0%E5%BA%8F%E8%A8%80%E5%92%8C%E5%87%BD%E6%95%B0%E5%B0%BE%E5%A3%B0"><span class="toc-number">2.4.</span> <span class="toc-text"> Chap4 å‡½æ•°åºè¨€å’Œå‡½æ•°å°¾å£°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap5-%E6%A0%88"><span class="toc-number">2.5.</span> <span class="toc-text"> Chap5 æ ˆ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%88%E7%9A%84%E7%94%A8%E9%80%94"><span class="toc-number">2.5.1.</span> <span class="toc-text"> æ ˆçš„ç”¨é€”</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%88%E7%9A%84%E5%99%AA%E9%9F%B3"><span class="toc-number">2.5.2.</span> <span class="toc-text"> æ ˆçš„å™ªéŸ³</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#problems-2"><span class="toc-number">2.5.3.</span> <span class="toc-text"> Problems</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#51"><span class="toc-number">2.5.3.1.</span> <span class="toc-text"> 5.1</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#52"><span class="toc-number">2.5.3.2.</span> <span class="toc-text"> 5.2</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap6-printf%E5%87%BD%E6%95%B0%E4%B8%8E%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92"><span class="toc-number">2.6.</span> <span class="toc-text"> Chap6 printf()å‡½æ•°ä¸å‚æ•°ä¼ é€’</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#x86"><span class="toc-number">2.6.1.</span> <span class="toc-text"> x86</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap7-scanf"><span class="toc-number">2.7.</span> <span class="toc-text"> Chap7 scanf()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#x86-2"><span class="toc-number">2.7.1.</span> <span class="toc-text"> x86</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F"><span class="toc-number">2.7.2.</span> <span class="toc-text"> å…¨å±€å˜é‡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#problem"><span class="toc-number">2.7.3.</span> <span class="toc-text"> Problem</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap8-%E5%8F%82%E6%95%B0%E8%8E%B7%E5%8F%96"><span class="toc-number">2.8.</span> <span class="toc-text"> Chap8 å‚æ•°è·å–</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap9-%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="toc-number">2.9.</span> <span class="toc-text"> Chap9 è¿”å›å€¼</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#void%E7%B1%BB%E5%9E%8B%E7%9A%84%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="toc-number">2.9.1.</span> <span class="toc-text"> voidç±»å‹çš„è¿”å›å€¼</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E5%80%BC%E4%B8%BA%E7%BB%93%E6%9E%84%E4%BD%93%E5%9E%8B%E6%95%B0%E6%8D%AE"><span class="toc-number">2.9.2.</span> <span class="toc-text"> è¿”å›å€¼ä¸ºç»“æ„ä½“å‹æ•°æ®</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap10-%E6%8C%87%E9%92%88"><span class="toc-number">2.10.</span> <span class="toc-text"> Chap10 æŒ‡é’ˆ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap12-%E6%9D%A1%E4%BB%B6%E8%BD%AC%E7%A7%BB"><span class="toc-number">2.11.</span> <span class="toc-text"> Chap12 æ¡ä»¶è½¬ç§»</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E5%80%BC%E6%AF%94%E8%BE%83"><span class="toc-number">2.11.1.</span> <span class="toc-text"> æ•°å€¼æ¯”è¾ƒ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97%E7%BB%9D%E5%AF%B9%E5%80%BC"><span class="toc-number">2.11.2.</span> <span class="toc-text"> è®¡ç®—ç»å¯¹å€¼</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E8%BF%90%E7%AE%97%E7%AC%A6"><span class="toc-number">2.11.3.</span> <span class="toc-text"> æ¡ä»¶è¿ç®—ç¬¦</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AF%94%E8%BE%83%E5%A4%A7%E5%B0%8F"><span class="toc-number">2.11.4.</span> <span class="toc-text"> æ¯”è¾ƒå¤§å°</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap13-switch"><span class="toc-number">2.12.</span> <span class="toc-text"> Chap13 Switch</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#case%E8%BE%83%E5%B0%91%E7%9A%84%E6%83%85%E5%BD%A2"><span class="toc-number">2.12.1.</span> <span class="toc-text"> caseè¾ƒå°‘çš„æƒ…å½¢</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#case%E8%BE%83%E5%A4%9A%E7%9A%84%E6%83%85%E5%BD%A2"><span class="toc-number">2.12.2.</span> <span class="toc-text"> caseè¾ƒå¤šçš„æƒ…å½¢</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#case%E4%BB%8E%E5%8F%A5%E5%A4%9A%E5%AF%B9%E4%B8%80"><span class="toc-number">2.12.3.</span> <span class="toc-text"> caseä»å¥å¤šå¯¹ä¸€</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fall-through"><span class="toc-number">2.12.4.</span> <span class="toc-text"> fall-through</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap14-%E5%BE%AA%E7%8E%AF"><span class="toc-number">2.13.</span> <span class="toc-text"> Chap14 å¾ªç¯</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#for"><span class="toc-number">2.13.1.</span> <span class="toc-text"> for</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%9D%97%E5%A4%8D%E5%88%B6"><span class="toc-number">2.13.2.</span> <span class="toc-text"> å†…å­˜å—å¤åˆ¶</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">2.13.3.</span> <span class="toc-text"> æ€»ç»“</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#problem-2"><span class="toc-number">2.13.4.</span> <span class="toc-text"> Problem</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap15-c%E8%AF%AD%E8%A8%80%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E5%87%BD%E6%95%B0"><span class="toc-number">2.14.</span> <span class="toc-text"> Chap15 Cè¯­è¨€å­—ç¬¦ä¸²çš„å‡½æ•°</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#strlen"><span class="toc-number">2.14.1.</span> <span class="toc-text"> strlen()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap16-%E6%95%B0%E5%AD%A6%E8%AE%A1%E7%AE%97%E6%8C%87%E4%BB%A4%E7%9A%84%E6%9B%BF%E6%8D%A2"><span class="toc-number">2.15.</span> <span class="toc-text"> Chap16 æ•°å­¦è®¡ç®—æŒ‡ä»¤çš„æ›¿æ¢</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B9%98%E6%B3%95"><span class="toc-number">2.15.1.</span> <span class="toc-text"> ä¹˜æ³•</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9B%BF%E6%8D%A2%E4%B8%BA%E5%8A%A0%E6%B3%95%E8%BF%90%E7%AE%97"><span class="toc-number">2.15.1.1.</span> <span class="toc-text"> æ›¿æ¢ä¸ºåŠ æ³•è¿ç®—</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9B%BF%E6%8D%A2%E4%B8%BA%E7%A7%BB%E4%BD%8D%E8%BF%90%E7%AE%97"><span class="toc-number">2.15.1.2.</span> <span class="toc-text"> æ›¿æ¢ä¸ºç§»ä½è¿ç®—</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9B%BF%E6%8D%A2%E4%B8%BA%E7%A7%BB%E4%BD%8D%E5%8A%A0%E5%87%8F%E6%B3%95%E7%9A%84%E6%B7%B7%E5%90%88%E8%BF%90%E7%AE%97"><span class="toc-number">2.15.1.3.</span> <span class="toc-text"> æ›¿æ¢ä¸ºç§»ä½,åŠ å‡æ³•çš„æ··åˆè¿ç®—</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%99%A4%E6%B3%95%E8%BF%90%E7%AE%97"><span class="toc-number">2.15.2.</span> <span class="toc-text"> é™¤æ³•è¿ç®—</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9B%BF%E6%8D%A2%E4%B8%BA%E4%BD%8D%E7%A7%BB%E8%BF%90%E7%AE%97"><span class="toc-number">2.15.2.1.</span> <span class="toc-text"> æ›¿æ¢ä¸ºä½ç§»è¿ç®—</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#problem-3"><span class="toc-number">2.15.3.</span> <span class="toc-text"> Problem</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap17-fpu"><span class="toc-number">2.16.</span> <span class="toc-text"> Chap17 FPU</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92%E6%B5%AE%E7%82%B9%E5%9E%8B"><span class="toc-number">2.16.1.</span> <span class="toc-text"> åˆ©ç”¨å‚æ•°ä¼ é€’æµ®ç‚¹å‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AF%94%E8%BE%83%E8%AF%B4%E6%98%8E"><span class="toc-number">2.16.2.</span> <span class="toc-text"> æ¯”è¾ƒè¯´æ˜</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap18-%E6%95%B0%E7%BB%84"><span class="toc-number">2.17.</span> <span class="toc-text"> Chap18 æ•°ç»„</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA"><span class="toc-number">2.17.1.</span> <span class="toc-text"> ç¼“å†²åŒºæº¢å‡º</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B6%E4%BB%96"><span class="toc-number">2.17.2.</span> <span class="toc-text"> å…¶ä»–</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%8C%87%E9%92%88"><span class="toc-number">2.17.3.</span> <span class="toc-text"> å­—ç¬¦ä¸²æŒ‡é’ˆ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E7%BB%B4%E6%95%B0%E7%BB%84"><span class="toc-number">2.17.4.</span> <span class="toc-text"> å¤šç»´æ•°ç»„</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C%E7%BB%B4%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%95%B0%E7%BB%84%E7%9A%84%E5%B0%81%E8%A3%85%E6%A0%BC%E5%BC%8F"><span class="toc-number">2.17.5.</span> <span class="toc-text"> äºŒç»´å­—ç¬¦ä¸²æ•°ç»„çš„å°è£…æ ¼å¼</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#problem-4"><span class="toc-number">2.17.6.</span> <span class="toc-text"> Problem</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap19-%E4%BD%8D%E8%BF%90%E7%AE%97"><span class="toc-number">2.18.</span> <span class="toc-text"> Chap19 ä½è¿ç®—</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%89%B9%E5%AE%9A%E4%BD%8D"><span class="toc-number">2.18.1.</span> <span class="toc-text"> ç‰¹å®šä½</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#x86-3"><span class="toc-number">2.18.1.1.</span> <span class="toc-text"> x86</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B8%85%E9%99%A4%E4%BD%8D"><span class="toc-number">2.18.2.</span> <span class="toc-text"> æ¸…é™¤ä½</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%8D%E7%A7%BB"><span class="toc-number">2.18.3.</span> <span class="toc-text"> ä½ç§»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8fpu%E4%B8%8A%E8%AE%BE%E7%BD%AE%E7%89%B9%E5%AE%9A%E4%BD%8D"><span class="toc-number">2.18.4.</span> <span class="toc-text"> åœ¨FPUä¸Šè®¾ç½®ç‰¹å®šä½</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%8D%E6%A0%A1%E9%AA%8C"><span class="toc-number">2.18.4.1.</span> <span class="toc-text"> ä½æ ¡éªŒ</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#promblem"><span class="toc-number">2.18.5.</span> <span class="toc-text"> Promblem</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap20-%E7%BA%BF%E6%80%A7%E5%90%8C%E4%BD%99%E6%B3%95%E4%B8%8E%E4%BC%AA%E9%9A%8F%E6%9C%BA%E6%95%B0"><span class="toc-number">2.19.</span> <span class="toc-text"> Chap20 çº¿æ€§åŒä½™æ³•ä¸ä¼ªéšæœºæ•°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap21-%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">2.20.</span> <span class="toc-text"> Chap21 ç»“æ„ä½“</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#systemtime"><span class="toc-number">2.20.1.</span> <span class="toc-text"> systemtime</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%A5%E6%95%B0%E7%BB%84%E6%9B%BF%E4%BB%A3%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">2.20.1.1.</span> <span class="toc-text"> ä»¥æ•°ç»„æ›¿ä»£ç»“æ„ä½“</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#malloc"><span class="toc-number">2.20.2.</span> <span class="toc-text"> malloc()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#unix-struct-tm"><span class="toc-number">2.20.3.</span> <span class="toc-text"> UNIX: struct tm</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E4%BD%93%E7%9A%84%E5%AD%97%E6%AE%B5%E5%B0%81%E8%A3%85"><span class="toc-number">2.20.4.</span> <span class="toc-text"> ç»“æ„ä½“çš„å­—æ®µå°è£…</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E4%BD%93%E7%9A%84%E5%B5%8C%E5%A5%97"><span class="toc-number">2.20.5.</span> <span class="toc-text"> ç»“æ„ä½“çš„åµŒå¥—</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E4%BD%93%E7%9A%84%E4%BD%8D%E6%93%8D%E4%BD%9C"><span class="toc-number">2.20.6.</span> <span class="toc-text"> ç»“æ„ä½“çš„ä½æ“ä½œ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap22-union%E5%85%B1%E7%94%A8%E4%BD%93"><span class="toc-number">2.21.</span> <span class="toc-text"> Chap22 Unionå…±ç”¨ä½“</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%AA%E9%9A%8F%E6%9C%BA%E6%95%B0%E7%94%9F%E6%88%90"><span class="toc-number">2.21.1.</span> <span class="toc-text"> ä¼ªéšæœºæ•°ç”Ÿæˆ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%99%A8%E7%B2%BE%E5%BA%A6"><span class="toc-number">2.21.2.</span> <span class="toc-text"> è®¡ç®—æœºå™¨ç²¾åº¦</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E5%B9%B3%E6%96%B9%E6%A0%B9%E8%AE%A1%E7%AE%97"><span class="toc-number">2.21.3.</span> <span class="toc-text"> å¿«é€Ÿå¹³æ–¹æ ¹è®¡ç®—</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap23-%E5%87%BD%E6%95%B0%E6%8C%87%E9%92%88"><span class="toc-number">2.22.</span> <span class="toc-text"> Chap23 å‡½æ•°æŒ‡é’ˆ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap24-32%E4%BD%8D%E7%B3%BB%E7%BB%9F%E5%A4%84%E7%90%8664%E4%BD%8D%E6%95%B0%E6%8D%AE"><span class="toc-number">2.23.</span> <span class="toc-text"> Chap24 32ä½ç³»ç»Ÿå¤„ç†64ä½æ•°æ®</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92%E5%8F%8A%E5%8A%A0%E5%87%8F%E8%BF%90%E7%AE%97"><span class="toc-number">2.23.1.</span> <span class="toc-text"> å‚æ•°ä¼ é€’åŠåŠ å‡è¿ç®—</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B9%98%E6%B3%95%E5%92%8C%E9%99%A4%E6%B3%95%E8%BF%90%E7%AE%97"><span class="toc-number">2.23.2.</span> <span class="toc-text"> ä¹˜æ³•å’Œé™¤æ³•è¿ç®—</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%B3%E7%A7%BB"><span class="toc-number">2.23.3.</span> <span class="toc-text"> å³ç§»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#32%E4%BD%8D%E6%95%B0%E6%8D%AE%E8%BD%AC%E6%8D%A2%E4%B8%BA64%E4%BD%8D%E6%95%B0%E6%8D%AE"><span class="toc-number">2.23.4.</span> <span class="toc-text"> 32ä½æ•°æ®è½¬æ¢ä¸º64ä½æ•°æ®</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap25-simd"><span class="toc-number">2.24.</span> <span class="toc-text"> *Chap25 SIMD</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9F%A2%E9%87%8F%E5%8C%96"><span class="toc-number">2.24.1.</span> <span class="toc-text"> çŸ¢é‡åŒ–</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#simd%E5%AE%9E%E7%8E%B0strlen"><span class="toc-number">2.24.2.</span> <span class="toc-text"> SIMDå®ç°strlen()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap26-64%E4%BD%8D%E5%B9%B3%E5%8F%B0"><span class="toc-number">2.25.</span> <span class="toc-text"> Chap26 64ä½å¹³å°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap27-simd%E4%B8%8E%E6%B5%AE%E7%82%B9%E6%95%B0%E7%9A%84%E5%B9%B6%E8%A1%8C%E8%BF%90%E7%AE%97"><span class="toc-number">2.26.</span> <span class="toc-text"> *Chap27 SIMDä¸æµ®ç‚¹æ•°çš„å¹¶è¡Œè¿ç®—</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap28-arm%E6%8C%87%E4%BB%A4%E8%AF%A6%E8%A7%A3"><span class="toc-number">2.27.</span> <span class="toc-text"> *Chap28 ARMæŒ‡ä»¤è¯¦è§£</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap29-mips%E7%9A%84%E7%89%B9%E7%82%B9"><span class="toc-number">2.28.</span> <span class="toc-text"> *Chap29 MIPSçš„ç‰¹ç‚¹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#part3-%E7%A1%AC%E4%BB%B6%E5%9F%BA%E7%A1%80"><span class="toc-number">3.</span> <span class="toc-text"> Part.3 ç¡¬ä»¶åŸºç¡€</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#chap30-%E6%9C%89%E7%AC%A6%E5%8F%B7%E6%95%B0%E7%9A%84%E8%A1%A8%E7%A4%BA%E6%96%B9%E6%B3%95"><span class="toc-number">3.1.</span> <span class="toc-text"> Chap30 æœ‰ç¬¦å·æ•°çš„è¡¨ç¤ºæ–¹æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap31-%E5%AD%97%E8%8A%82%E5%BA%8F"><span class="toc-number">3.2.</span> <span class="toc-text"> Chap31 å­—èŠ‚åº</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%A7%E7%AB%AF%E5%AD%97%E8%8A%82%E5%BA%8F"><span class="toc-number">3.2.1.</span> <span class="toc-text"> å¤§ç«¯å­—èŠ‚åº</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%8F%E7%AB%AF%E5%AD%97%E8%8A%82%E5%BA%8F"><span class="toc-number">3.2.2.</span> <span class="toc-text"> å°ç«¯å­—èŠ‚åº</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8C%E6%A8%A1%E4%BA%8C%E5%85%83%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F"><span class="toc-number">3.2.3.</span> <span class="toc-text"> åŒæ¨¡äºŒå…ƒæ•°æ®æ ¼å¼</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BD%AC%E6%8D%A2%E5%AD%97%E8%8A%82%E5%BA%8F"><span class="toc-number">3.2.4.</span> <span class="toc-text"> è½¬æ¢å­—èŠ‚åº</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap32-%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80"><span class="toc-number">3.3.</span> <span class="toc-text"> Chap32 å†…å­˜å¸ƒå±€</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap33-cpu"><span class="toc-number">3.4.</span> <span class="toc-text"> Chap33 CPU</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E6%94%AF%E9%A2%84%E6%B5%8B"><span class="toc-number">3.4.1.</span> <span class="toc-text"> åˆ†æ”¯é¢„æµ‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%9B%B8%E5%85%B3%E6%80%A7"><span class="toc-number">3.4.2.</span> <span class="toc-text"> æ•°æ®ç›¸å…³æ€§</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap34-hash"><span class="toc-number">3.5.</span> <span class="toc-text"> Chap34 hash</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#part4-%E4%B8%80%E4%BA%9B%E9%AB%98%E7%BA%A7%E7%9A%84%E4%BE%8B%E5%AD%90"><span class="toc-number">4.</span> <span class="toc-text"> Part.4 ä¸€äº›é«˜çº§çš„ä¾‹å­</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#chap35-%E6%B8%A9%E5%BA%A6%E8%BD%AC%E6%8D%A2"><span class="toc-number">4.1.</span> <span class="toc-text"> Chap35 æ¸©åº¦è½¬æ¢</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap36-%E6%96%90%E6%B3%A2%E9%82%A3%E5%A5%91%E6%95%B0%E5%88%97"><span class="toc-number">4.2.</span> <span class="toc-text"> Chap36 æ–æ³¢é‚£å¥‘æ•°åˆ—</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap37-crc32"><span class="toc-number">4.3.</span> <span class="toc-text"> Chap37 CRC32</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap38-%E7%BD%91%E7%BB%9C%E5%9C%B0%E5%9D%80%E8%AE%A1%E7%AE%97"><span class="toc-number">4.4.</span> <span class="toc-text"> Chap38 ç½‘ç»œåœ°å€è®¡ç®—</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap39-%E5%BE%AA%E7%8E%AF%E5%87%A0%E4%B8%AA%E8%BF%AD%E4%BB%A3"><span class="toc-number">4.5.</span> <span class="toc-text"> Chap39 å¾ªç¯ï¼šå‡ ä¸ªè¿­ä»£ï¼Ÿ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap40-%E8%BE%BE%E5%A4%AB%E8%A3%85%E7%BD%AE"><span class="toc-number">4.6.</span> <span class="toc-text"> Chap40 è¾¾å¤«è£…ç½®</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap41-%E9%99%A4%E4%BB%A59"><span class="toc-number">4.7.</span> <span class="toc-text"> Chap41 é™¤ä»¥9</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B"><span class="toc-number">4.7.1.</span> <span class="toc-text"> å®ä¾‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">4.7.2.</span> <span class="toc-text"> åŸç†</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#more"><span class="toc-number">4.7.3.</span> <span class="toc-text"> More</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap42-str2numatoi%E5%87%BD%E6%95%B0"><span class="toc-number">4.8.</span> <span class="toc-text"> Chap42 str2numï¼Œatoi()å‡½æ•°</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#exmaple1"><span class="toc-number">4.8.1.</span> <span class="toc-text"> exmaple1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#example2"><span class="toc-number">4.8.2.</span> <span class="toc-text"> example2</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap43-%E5%86%85%E8%81%94%E5%87%BD%E6%95%B0"><span class="toc-number">4.9.</span> <span class="toc-text"> Chap43 å†…è”å‡½æ•°</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#strcmp"><span class="toc-number">4.9.1.</span> <span class="toc-text"> strcmp</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#strlen-2"><span class="toc-number">4.9.2.</span> <span class="toc-text"> strlen</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#strcpy"><span class="toc-number">4.9.3.</span> <span class="toc-text"> strcpy</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#memset"><span class="toc-number">4.9.4.</span> <span class="toc-text"> memset</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#memcpy"><span class="toc-number">4.9.5.</span> <span class="toc-text"> memcpy</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#memcmp"><span class="toc-number">4.9.6.</span> <span class="toc-text"> memcmp</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap44-c99%E6%A0%87%E5%87%86%E7%9A%84%E5%8F%97%E9%99%90%E6%8C%87%E9%92%88"><span class="toc-number">4.10.</span> <span class="toc-text"> Chap44 C99æ ‡å‡†çš„å—é™æŒ‡é’ˆ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap45-%E6%89%93%E9%80%A0%E6%97%A0%E5%88%86%E6%94%AF%E7%9A%84abs%E5%87%BD%E6%95%B0"><span class="toc-number">4.11.</span> <span class="toc-text"> Chap45 æ‰“é€ æ— åˆ†æ”¯çš„abs()å‡½æ•°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap46-%E5%8F%98%E9%95%BF%E5%8F%82%E6%95%B0%E5%87%BD%E6%95%B0"><span class="toc-number">4.12.</span> <span class="toc-text"> Chap46 å˜é•¿å‚æ•°å‡½æ•°</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97%E7%AE%97%E6%9C%AF%E5%B9%B3%E5%9D%87%E5%80%BC"><span class="toc-number">4.12.1.</span> <span class="toc-text"> è®¡ç®—ç®—æœ¯å¹³å‡å€¼</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#vprintf"><span class="toc-number">4.12.2.</span> <span class="toc-text"> vprintf()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap47-%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%89%AA%E5%88%87"><span class="toc-number">4.13.</span> <span class="toc-text"> Chap47 å­—ç¬¦ä¸²å‰ªåˆ‡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap48-toupper"><span class="toc-number">4.14.</span> <span class="toc-text"> Chap48 toupper()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap49-%E4%B8%8D%E6%AD%A3%E7%A1%AE%E7%9A%84%E5%8F%8D%E6%B1%87%E7%BC%96%E4%BB%A3%E7%A0%81"><span class="toc-number">4.15.</span> <span class="toc-text"> Chap49 ä¸æ­£ç¡®çš„åæ±‡ç¼–ä»£ç </span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#x86%E7%8E%AF%E5%A2%83%E4%B8%8B%E7%9A%84%E4%BB%8E%E4%B8%80%E5%BC%80%E5%A7%8B%E5%B0%B1%E9%94%99%E8%AF%AF%E7%9A%84%E5%8F%8D%E6%B1%87%E7%BC%96"><span class="toc-number">4.15.1.</span> <span class="toc-text"> x86ç¯å¢ƒä¸‹çš„ä»ä¸€å¼€å§‹å°±é”™è¯¯çš„åæ±‡ç¼–</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap50-%E6%B7%B7%E6%B7%86%E6%8A%80%E6%9C%AF"><span class="toc-number">4.16.</span> <span class="toc-text"> Chap50 æ··æ·†æŠ€æœ¯</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%8F%98%E6%8D%A2"><span class="toc-number">4.16.1.</span> <span class="toc-text"> å­—ç¬¦ä¸²å˜æ¢</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%AF%E6%89%A7%E8%A1%8C%E4%BB%A3%E7%A0%81"><span class="toc-number">4.16.2.</span> <span class="toc-text"> å¯æ‰§è¡Œä»£ç </span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8F%92%E5%85%A5%E5%9E%83%E5%9C%BE%E4%BB%A3%E7%A0%81"><span class="toc-number">4.16.2.1.</span> <span class="toc-text"> æ’å…¥åƒåœ¾ä»£ç </span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%94%A8%E5%A4%9A%E4%B8%AA%E6%8C%87%E4%BB%A4%E7%BB%84%E5%90%88%E4%BB%A3%E6%9B%BF%E5%8E%9F%E6%9D%A5%E7%9A%84%E4%B8%80%E4%B8%AA%E6%8C%87%E4%BB%A4"><span class="toc-number">4.16.2.2.</span> <span class="toc-text"> ç”¨å¤šä¸ªæŒ‡ä»¤ç»„åˆä»£æ›¿åŸæ¥çš„ä¸€ä¸ªæŒ‡ä»¤</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A7%8B%E7%BB%88%E6%89%A7%E8%A1%8C%E6%88%96%E4%BB%8E%E6%9D%A5%E4%B8%8D%E4%BC%9A%E6%89%A7%E8%A1%8C%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="toc-number">4.16.2.3.</span> <span class="toc-text"> å§‹ç»ˆæ‰§è¡Œæˆ–ä»æ¥ä¸ä¼šæ‰§è¡Œçš„ä»£ç </span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%89%93%E4%B9%B1%E6%8C%87%E4%BB%A4%E5%BA%8F%E5%88%97"><span class="toc-number">4.16.2.4.</span> <span class="toc-text"> æ‰“ä¹±æŒ‡ä»¤åºåˆ—</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E9%97%B4%E6%8E%A5%E6%8C%87%E9%92%88"><span class="toc-number">4.16.2.5.</span> <span class="toc-text"> ä½¿ç”¨é—´æ¥æŒ‡é’ˆ</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%BB%A5%E5%8F%8A%E4%BC%AA%E4%BB%A3%E7%A0%81"><span class="toc-number">4.16.3.</span> <span class="toc-text"> è™šæ‹Ÿæœºä»¥åŠä¼ªä»£ç </span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap51-c"><span class="toc-number">4.17.</span> <span class="toc-text"> Chap51* C++</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B1%BB"><span class="toc-number">4.17.1.</span> <span class="toc-text"> ç±»</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E4%BE%8B%E5%AD%90"><span class="toc-number">4.17.1.1.</span> <span class="toc-text"> ä¸€ä¸ªç®€å•çš„ä¾‹å­</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%B1%BB%E7%BB%A7%E6%89%BF"><span class="toc-number">4.17.1.2.</span> <span class="toc-text"> ç±»ç»§æ‰¿</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B0%81%E8%A3%85"><span class="toc-number">4.17.1.3.</span> <span class="toc-text"> å°è£…</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%9A%E9%87%8D%E7%BB%A7%E6%89%BF"><span class="toc-number">4.17.1.4.</span> <span class="toc-text"> å¤šé‡ç»§æ‰¿</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%96%B9%E6%B3%95"><span class="toc-number">4.17.1.5.</span> <span class="toc-text"> è™šæ‹Ÿæ–¹æ³•</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ostream%E8%BE%93%E5%87%BA%E6%B5%81"><span class="toc-number">4.17.2.</span> <span class="toc-text"> ostreamè¾“å‡ºæµ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%95%E7%94%A8"><span class="toc-number">4.17.3.</span> <span class="toc-text"> å¼•ç”¨</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#stlstandard-template-library"><span class="toc-number">4.17.4.</span> <span class="toc-text"> *stl(standard template library)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#stdstring%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-number">4.17.4.1.</span> <span class="toc-text"> std::string(å­—ç¬¦ä¸²)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap52-%E6%95%B0%E7%BB%84%E4%B8%8E%E8%B4%9F%E6%95%B0%E7%B4%A2%E5%BC%95"><span class="toc-number">4.18.</span> <span class="toc-text"> Chap52 æ•°ç»„ä¸è´Ÿæ•°ç´¢å¼•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap53-16%E4%BD%8Dwindows%E7%A8%8B%E5%BA%8F"><span class="toc-number">4.19.</span> <span class="toc-text"> Chap53 16ä½windowsç¨‹åº</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap54-java"><span class="toc-number">4.20.</span> <span class="toc-text"> Chap54* Java</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#part5-%E5%9C%A8%E4%BB%A3%E7%A0%81%E4%B8%AD%E5%8F%91%E7%8E%B0%E6%9C%89%E8%B6%A3%E7%9A%84%E5%86%85%E5%AE%B9"><span class="toc-number">5.</span> <span class="toc-text"> Part.5 åœ¨ä»£ç ä¸­å‘ç°æœ‰è¶£çš„å†…å®¹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#chap55%E7%BC%96%E8%AF%91%E5%99%A8%E4%BA%A7%E7%94%9F%E7%9A%84%E6%96%87%E4%BB%B6%E7%89%B9%E5%BE%81"><span class="toc-number">5.1.</span> <span class="toc-text"> Chap55ç¼–è¯‘å™¨äº§ç”Ÿçš„æ–‡ä»¶ç‰¹å¾</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#microsoft-visual-c"><span class="toc-number">5.1.1.</span> <span class="toc-text"> Microsoft Visual C++</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gcc-2"><span class="toc-number">5.1.2.</span> <span class="toc-text"> gcc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#intel-fortran"><span class="toc-number">5.1.3.</span> <span class="toc-text"> intel fortran</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#watcom%E5%92%8Copenwatcom"><span class="toc-number">5.1.4.</span> <span class="toc-text"> watcomå’Œopenwatcom</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#borland"><span class="toc-number">5.1.5.</span> <span class="toc-text"> borland</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#delphi"><span class="toc-number">5.1.6.</span> <span class="toc-text"> delphi</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E7%9A%84dll"><span class="toc-number">5.1.7.</span> <span class="toc-text"> å…¶ä»–çš„dll</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap56win32%E7%8E%AF%E5%A2%83%E4%B8%8E%E5%A4%96%E9%83%A8%E9%80%9A%E4%BF%A1"><span class="toc-number">5.2.</span> <span class="toc-text"> Chap56Win32ç¯å¢ƒä¸å¤–éƒ¨é€šä¿¡</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8windowsapi"><span class="toc-number">5.2.1.</span> <span class="toc-text"> å¸¸ç”¨WindowsAPI</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap57%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-number">5.3.</span> <span class="toc-text"> Chap57å­—ç¬¦ä¸²</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap58-assert"><span class="toc-number">5.4.</span> <span class="toc-text"> Chap58 assert()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap59-%E5%B8%B8%E6%95%B0"><span class="toc-number">5.5.</span> <span class="toc-text"> Chap59 å¸¸æ•°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap60%E6%A3%80%E7%B4%A2%E5%85%B3%E9%94%AE%E6%8C%87%E4%BB%A4"><span class="toc-number">5.6.</span> <span class="toc-text"> Chap60æ£€ç´¢å…³é”®æŒ‡ä»¤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap61%E5%8F%AF%E7%96%91%E4%BB%A3%E7%A0%81%E6%A8%A1%E5%9E%8B"><span class="toc-number">5.7.</span> <span class="toc-text"> Chap61å¯ç–‘ä»£ç æ¨¡å‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap62-%E9%AD%94%E6%95%B0%E5%AD%97%E4%B8%8E%E7%A8%8B%E5%BA%8F%E8%B0%83%E8%AF%95"><span class="toc-number">5.8.</span> <span class="toc-text"> Chap62 é­”æ•°å­—ä¸ç¨‹åºè°ƒè¯•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap63-otherthing"><span class="toc-number">5.9.</span> <span class="toc-text"> Chap63 Otherthing</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#part6-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9B%B8%E5%85%B3"><span class="toc-number">6.</span> <span class="toc-text"> Part.6 æ“ä½œç³»ç»Ÿç›¸å…³</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#chap64%E5%8F%82%E6%95%B0%E7%9A%84%E4%BC%A0%E9%80%92%E6%96%B9%E6%B3%95"><span class="toc-number">6.1.</span> <span class="toc-text"> Chap64.å‚æ•°çš„ä¼ é€’æ–¹æ³•</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#cdecl"><span class="toc-number">6.1.1.</span> <span class="toc-text"> cdecl</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#stdcall"><span class="toc-number">6.1.2.</span> <span class="toc-text"> stdcall</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#fastcall"><span class="toc-number">6.1.3.</span> <span class="toc-text"> fastcall</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#thiscall"><span class="toc-number">6.1.4.</span> <span class="toc-text"> thiscall</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#64%E4%BD%8D%E4%B8%8B%E7%9A%84x86"><span class="toc-number">6.1.5.</span> <span class="toc-text"> 64ä½ä¸‹çš„x86</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#64%E4%BD%8D%E4%B8%8Blinux"><span class="toc-number">6.1.6.</span> <span class="toc-text"> 64ä½ä¸‹Linux</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E5%8F%8C%E7%B2%BE%E5%BA%A6%E5%9E%8B%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="toc-number">6.1.7.</span> <span class="toc-text"> å•åŒç²¾åº¦å‹è¿”å›å€¼</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%8F%82%E6%95%B0"><span class="toc-number">6.1.8.</span> <span class="toc-text"> ä¿®æ”¹å‚æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%87%E9%92%88%E5%9E%8B%E5%87%BD%E6%95%B0%E5%8F%82%E6%95%B0"><span class="toc-number">6.1.9.</span> <span class="toc-text"> æŒ‡é’ˆå‹å‡½æ•°å‚æ•°</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap65-%E7%BA%BF%E7%A8%8B%E6%9C%AC%E5%9C%B0%E5%AD%98%E5%82%A8tls"><span class="toc-number">6.2.</span> <span class="toc-text"> Chap65 çº¿ç¨‹æœ¬åœ°å­˜å‚¨TLS</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#tls%E5%9B%9E%E8%B0%83"><span class="toc-number">6.2.1.</span> <span class="toc-text"> TLSå›è°ƒ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap66%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="toc-number">6.3.</span> <span class="toc-text"> Chap66ç³»ç»Ÿè°ƒç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#linux"><span class="toc-number">6.3.1.</span> <span class="toc-text"> linux</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#windows"><span class="toc-number">6.3.2.</span> <span class="toc-text"> windows</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap67-linux"><span class="toc-number">6.4.</span> <span class="toc-text"> Chap67 Linux</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%8D%E7%BD%AE%E6%97%A0%E5%85%B3%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="toc-number">6.4.1.</span> <span class="toc-text"> ä½ç½®æ— å…³çš„ä»£ç </span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ld_preload"><span class="toc-number">6.4.2.</span> <span class="toc-text"> LD_PRELOAD</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chap68-windowsnt"><span class="toc-number">6.5.</span> <span class="toc-text"> chap68 WindowsNT</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#crt"><span class="toc-number">6.5.1.</span> <span class="toc-text"> CRT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pe"><span class="toc-number">6.5.2.</span> <span class="toc-text"> PE</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%AF%E8%AF%AD"><span class="toc-number">6.5.2.1.</span> <span class="toc-text"> æœ¯è¯­</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E5%9C%B0%E5%9D%80"><span class="toc-number">6.5.2.2.</span> <span class="toc-text"> åŸºåœ°å€</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AD%90%E7%B3%BB%E7%BB%9F"><span class="toc-number">6.5.2.3.</span> <span class="toc-text"> å­ç³»ç»Ÿ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AE%B5"><span class="toc-number">6.5.2.4.</span> <span class="toc-text"> æ®µ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#tls"><span class="toc-number">6.5.2.5.</span> <span class="toc-text"> TLS</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#seh"><span class="toc-number">6.5.3.</span> <span class="toc-text"> SEH</span></a></li></ol></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#0078E7;"><link itemprop="mainEntityOfPage" href="http://npc0vo.github.io/2024/05/23/re4b%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="Npc"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="Npc | Blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">re4bé˜…è¯»ç¬”è®°</h1><div class="post-meta"><div class="post-time" style="display:block"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-line"></span></span> <time title="Created: 2024-05-23 16:25:47" itemprop="dateCreated datePublished" datetime="2024-05-23T16:25:47+08:00">2024-05-23</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-2-line"></span></span> <time title="Modified: 2025-01-13 19:50:45" itemprop="dateModified" datetime="2025-01-13T19:50:45+08:00">2025-01-13</time></div><span class="post-count"><span class="post-symbolcount"><span class="post-meta-item-icon" title="Word count in article"><span class="icon iconify" data-icon="ri:file-word-line"></span></span> <span title="Word count in article">79.9k</span><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="Reading time"><span class="icon iconify" data-icon="ri:timer-line"></span></span> <span title="Reading time">357m</span></span></span><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><span class="icon iconify" data-icon="ri:folder-line"></span></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/Reverse/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">Reverse</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="tag-name">å­¦ä¹ ç¬”è®°</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><h2 id="part1-å‰è¨€"><a class="markdownIt-Anchor" href="#part1-å‰è¨€"></a> Part.1 å‰è¨€</h2>
<p>å¯¹äºé€†å‘å·¥ç¨‹æƒå¨æŒ‡å—å…³é”®éƒ¨åˆ†çš„æ‘˜å½•,æ•´ç†ä»¥åŠä¸ªäººçš„ç†è§£</p>
<p>é€†å‘å·¥ç¨‹æƒå¨æŒ‡å—æ˜¯å…¥é—¨é€†å‘å¿…è¯»çš„ä¸€æœ¬ä¹¦ç±</p>
<p>ç”±äºæˆ‘æ˜¯åˆå­¦è€…ï¼Œæ‰€ä»¥æˆ‘ç›®å‰åªå­¦ä¹ re4b x86æ±‡ç¼–éƒ¨åˆ†ï¼Œå¯¹äºARMä»¥åŠMIPSæ¶æ„å¾…ä»¥åè¿›é˜¶åå†è¿›è¡Œå­¦ä¹ </p>
<h2 id="part2-æŒ‡ä»¤è®²è§£"><a class="markdownIt-Anchor" href="#part2-æŒ‡ä»¤è®²è§£"></a> Part.2 æŒ‡ä»¤è®²è§£</h2>
<h3 id="chapter1-cpu"><a class="markdownIt-Anchor" href="#chapter1-cpu"></a> Chapter1 CPU</h3>
<p>**æŒ‡ä»¤ç ï¼šCPUå—ç†çš„åº•å±‚å‘½ä»¤ã€‚å…¸å‹çš„åº•å±‚å‘½ä»¤æœ‰ï¼šå°†æ•°æ®åœ¨å¯„å­˜å™¨é—´è½¬ç§»ã€æ“ä½œå†…å­˜ã€è®¡ç®—è¿ç®—ç­‰æŒ‡ä»¤ã€‚æ¯ç±»CPUéƒ½æœ‰è‡ªå·±çš„æŒ‡ä»¤é›†æ¶æ„ï¼ˆInstruction Set Architectureï¼ŒISAï¼‰ã€‚</p>
<p>**æœºå™¨ç ï¼šå‘é€ç»™CPUçš„ç¨‹åºä»£ç ã€‚ä¸€æ¡æŒ‡ä»¤é€šå¸¸è¢«å°è£…ä¸ºè‹¥å¹²å­—èŠ‚ã€‚</p>
<p>**æ±‡ç¼–è¯­è¨€ï¼šä¸ºäº†è®©ç¨‹åºå‘˜å°‘é•¿ç™½å¤´å‘è€Œåˆ›é€ å‡ºæ¥çš„ã€æ˜“è¯»æ˜“è®°çš„ä»£ç ï¼Œå®ƒæœ‰å¾ˆå¤šç±»ä¼¼å®çš„æ‰©å±•åŠŸèƒ½ã€‚</p>
<p>**CPUå¯„å­˜å™¨ï¼šæ¯ç§CPUéƒ½æœ‰å…¶å›ºå®šçš„é€šç”¨å¯„å­˜å™¨ï¼ˆGPRï¼‰ã€‚x86 CPUé‡Œä¸€èˆ¬æœ‰8ä¸ªGPRï¼Œx64é‡Œå¾€å¾€æœ‰16ä¸ªGPRï¼Œè€ŒARMé‡Œåˆ™é€šå¸¸æœ‰16ä¸ªGPRã€‚æ‚¨å¯ä»¥è®¤ä¸ºCPUå¯„å­˜å™¨æ˜¯ä¸€ç§å­˜å‚¨å•å…ƒï¼Œå®ƒèƒ½å¤Ÿæ— å·®åˆ«åœ°å­˜å‚¨æ‰€æœ‰ç±»å‹çš„ä¸´æ—¶å˜é‡ã€‚å‡å¦‚æ‚¨ä½¿ç”¨ä¸€ç§é«˜çº§çš„ç¼–ç¨‹è¯­è¨€ï¼Œä¸”ä»…ä¼šä½¿ç”¨åˆ°8ä¸ª32ä½å˜é‡ï¼Œé‚£ä¹ˆå…‰CPUè‡ªå¸¦çš„å¯„å­˜å™¨å°±èƒ½å®Œæˆä¸å°‘ä»»åŠ¡äº†ï¼</p>
<p><strong>æŒ‡ä»¤é›†æ¶æ„</strong></p>
<p>æœ€å¸¸è§çš„ä¸‰ç§</p>
<ul>
<li>
<p>ARMæŒ‡ä»¤é›†åˆ†ä¸º3ç±»ï¼šARMæ¨¡å¼æŒ‡ä»¤é›†ã€Thumbæ¨¡å¼æŒ‡ä»¤é›†ï¼ˆåŒ…æ‹¬Thumb-2ï¼‰å’ŒARM64çš„æŒ‡ä»¤é›†ã€‚éœ€è¦å¼ºè°ƒçš„æ˜¯ï¼šä¸åŒçš„æŒ‡ä»¤é›†åˆ†åˆ«</p>
<p>å±äºä¸åŒçš„æŒ‡ä»¤é›†æ¶æ„ï¼›ä¸€ä¸ªæŒ‡ä»¤é›†ç»éå¦ä¸€ä¸ªæŒ‡ä»¤é›†çš„å˜ç§ã€‚</p>
</li>
<li>
<p>x86æŒ‡ä»¤é›† å„opcodeï¼ˆæ±‡ç¼–æŒ‡ä»¤å¯¹åº”çš„æœºå™¨ç ï¼‰çš„é•¿åº¦ä¸å°½ç›¸åŒ</p>
</li>
<li>
<p>MIPSæŒ‡ä»¤é›† å¤šæ•°éƒ½ä½¿ç”¨äº†å›ºå®šé•¿åº¦çš„32ä½opcode</p>
</li>
</ul>
<p><strong>æ±‡ç¼–è¯­è¨€</strong>å­˜åœ¨ä¸¤ç§ä¸»æµè¯­ä½“ï¼Œå³<strong>Intelè¯­ä½“</strong>å’Œ<strong>AT&amp;Tè¯­ä½“</strong></p>
<h3 id="chap2-æœ€ç®€å‡½æ•°"><a class="markdownIt-Anchor" href="#chap2-æœ€ç®€å‡½æ•°"></a> Chap2 æœ€ç®€å‡½æ•°</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token number">123</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token label function">f:</span>
	mov <span class="token register variable">eax</span>,<span class="token number">123</span>
	ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>è¿™ä¸ªå‡½æ•°ä»…ç”±ä¸¤æ¡æŒ‡ä»¤æ„æˆï¼šç¬¬ä¸€æ¡æŒ‡ä»¤æŠŠæ•°å€¼123å­˜æ”¾åœ¨EAXå¯„å­˜å™¨é‡Œï¼›æ ¹æ®å‡½æ•°è°ƒç”¨çº¦å®š,åé¢ä¸€æ¡æŒ‡ä»¤ä¼šæŠŠEAXçš„å€¼å½“ä½œè¿”å›å€¼ä¼ é€’ç»™è°ƒç”¨è€…å‡½æ•°ï¼Œè€Œè°ƒç”¨è€…å‡½æ•°ï¼ˆcallerï¼‰ä¼šä»EAXå¯„å­˜å™¨é‡Œå–å€¼ï¼ŒæŠŠå®ƒå½“ä½œè¿”å›ç»“æœã€‚</p>
<h3 id="chap3-helloworld"><a class="markdownIt-Anchor" href="#chap3-helloworld"></a> Chap3 Hello,World!</h3>
<h4 id="msvs"><a class="markdownIt-Anchor" href="#msvs"></a> msvs</h4>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"hello,world!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç”¨MSVS<code>cl 1.cpp /Fa1.asm</code>ç”Ÿæˆ<code>1.asm</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">CONST   SEGMENT
<span class="token operator">$</span>SG3830 DB       <span class="token string">'hello, world'</span>, <span class="token number">0AH</span>, <span class="token number">00H</span>
CONST   ENDS
PUBLIC  _main
EXTRN   _printf:PROC
<span class="token comment">; Function compile flags: /Odtp</span>
_TEXT   SEGMENT
_main   PROC
        push    <span class="token register variable">ebp</span>
        mov     <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
        push    OFFSET <span class="token operator">$</span>SG3830
        call    _printf
        add     <span class="token register variable">esp</span>, <span class="token number">4</span>
        xor     <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
        pop     <span class="token register variable">ebp</span>
        ret     <span class="token number">0</span>
_main   ENDP
_TEXT   ENDS<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç”Ÿæˆ<code>1.asm</code>åï¼Œç¼–è¯‘å™¨ä¼šç”Ÿæˆ<code>1.obj</code>ç„¶åå†é“¾æ¥ä¸º<code>1.exe</code></p>
<p>å¯¹è¿™æ®µæ±‡ç¼–çš„è§£è¯»</p>
<ul>
<li>
<p>æ–‡ä»¶åˆ†ä¸ºä¸¤ä¸ªä»£ç æ®µï¼Œå³CONSTå’Œ_TEXTæ®µï¼Œå®ƒä»¬åˆ†åˆ«ä»£è¡¨æ•°æ®æ®µå’Œä»£ç æ®µã€‚</p>
</li>
<li>
<p>å­—ç¬¦ä¸²å¸¸é‡â€œhelloï¼Œworldâ€åˆ†é…äº†ä¸€ä¸ªæŒ‡é’ˆï¼ˆconst char[]ï¼‰ï¼Œåªæ˜¯åœ¨ä»£ç ä¸­è¿™ä¸ªæŒ‡é’ˆçš„åç§°å¹¶ä¸æ˜æ˜¾</p>
</li>
<li>
<p>ç¼–è¯‘å™¨è¿›è¡Œäº†è‡ªå·±çš„å¤„ç†ï¼Œå¹¶åœ¨å†…éƒ¨æŠŠå­—ç¬¦ä¸²å¸¸é‡å‘½åä¸º$SG3830,<code>0AH</code>æ˜¯æ¢è¡Œç¬¦</p>
<p>å¯ä»¥å‘ç°åœ¨å­—ç¬¦ä¸²å¸¸é‡å°¾éƒ¨æ·»åŠ äº†<code>00H</code>è¿™ä¸ªæ˜¯å­—ç¬¦ä¸²å¸¸é‡çš„ç»“æŸæ ‡å¿—,ç¼–è¯‘å™¨æ·»åŠ çš„</p>
</li>
<li>
<p>åœ¨ä»£ç æ®µ<code>_TEXT</code>åªæœ‰ä¸€ä¸ªå‡½æ•°ï¼Œå³<code>main()</code>,å…¶ä¸­<code>PROC</code>æ˜¯<code>Procdure</code>çš„ç¼©å†™ï¼Œè¡¨ç¤ºç¨‹åºçš„å¼€å§‹,ä¸<code>ENDP</code>é…å¯¹ä½¿ç”¨</p>
</li>
<li>
<p>ä¸»å‡½æ•°çš„å‡½æ•°ä½“æœ‰æ ‡å¿—æ€§çš„å‡½æ•°åºè¨€ï¼ˆfunction prologueï¼‰</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">push <span class="token register variable">ebp</span>        <span class="token comment">; ä¿å­˜è°ƒç”¨è€…çš„æ ˆå¸§æŒ‡é’ˆ</span>
mov <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>    <span class="token comment">; å»ºç«‹å½“å‰å‡½æ•°çš„æ ˆå¸§æŒ‡é’ˆ</span>
sub <span class="token register variable">esp</span>, N      <span class="token comment">; ä¸ºå±€éƒ¨å˜é‡åˆ†é…ç©ºé—´ï¼ˆN æ˜¯éœ€è¦åˆ†é…çš„å­—èŠ‚æ•°ï¼‰</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>ä»¥åŠå‡½æ•°å°¾å£°ï¼ˆfunction epilogueï¼‰</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">mov <span class="token register variable">esp</span>, <span class="token register variable">ebp</span>    <span class="token comment">; æ¢å¤æ ˆæŒ‡é’ˆ</span>
pop <span class="token register variable">ebp</span>         <span class="token comment">; æ¢å¤è°ƒç”¨è€…çš„æ ˆå¸§æŒ‡é’ˆ</span>
ret             <span class="token comment">; è¿”å›åˆ°è°ƒç”¨è€…</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>å®é™…ä¸Šæ‰€æœ‰çš„å‡½æ•°éƒ½æœ‰è¿™æ ·çš„åºè¨€å’Œå°¾å£°ã€‚</p>
</li>
<li>
<p>åœ¨å‡½æ•°åºè¨€ä¹‹åï¼Œçœ‹åˆ°è°ƒç”¨<code>printf()</code>çš„æŒ‡ä»¤<code>CALL _printf</code></p>
<p>é€šè¿‡<code>PUSH</code>æŒ‡ä»¤ï¼Œç¨‹åºæŠŠå­—ç¬¦ä¸²çš„æŒ‡é’ˆæ¨é€å…¥æ ˆã€‚è¿™æ ·ï¼Œ<code>printf()</code>å‡½æ•°å°±å¯ä»¥è°ƒç”¨æ ˆé‡Œçš„æŒ‡é’ˆï¼Œå³å­—ç¬¦ä¸²<code>â€œhello, world!â€</code>çš„åœ°å€ã€‚</p>
</li>
<li>
<p>åœ¨<code>printf()</code>å‡½æ•°ç»“æŸä»¥åï¼Œç¨‹åºçš„æ§åˆ¶æµä¼šè¿”å›åˆ°<code>main()</code>å‡½æ•°ä¹‹ä¸­ã€‚æ­¤æ—¶ï¼Œå­—ç¬¦ä¸²åœ°å€ï¼ˆå³æŒ‡é’ˆï¼‰ä»æ®‹ç•™åœ¨æ•°æ®æ ˆä¹‹ä¸­ã€‚è¿™ä¸ªæ—¶å€™å°±éœ€è¦è°ƒæ•´æ ˆæŒ‡é’ˆï¼ˆESPå¯„å­˜å™¨é‡Œçš„å€¼ï¼‰æ¥é‡Šæ”¾è¿™ä¸ªæŒ‡é’ˆã€‚</p>
</li>
<li>
<p>ä¸‹ä¸€æ¡è¯­å¥æ˜¯<code>â€œadd ESPï¼Œ4â€</code>ï¼ŒæŠŠESPå¯„å­˜å™¨ï¼ˆæ ˆæŒ‡é’ˆ/Stack Pointerï¼‰é‡Œçš„æ•°å€¼åŠ 4ã€‚(åœ¨32ä½ç³»ç»Ÿä¸­ï¼ŒæŒ‡é’ˆçš„å¤§å°å 4å­—èŠ‚ï¼ŒåŒç†åœ¨64ä½ä¸­ï¼Œå°±è¦+8)</p>
<p>è¿™æ¡æŒ‡ä»¤å¯ä»¥ç†è§£ä¸ºâ€œPOPæŸå¯„å­˜å™¨â€ã€‚åªæ˜¯æœ¬ä¾‹çš„æŒ‡ä»¤ç›´æ¥èˆå¼ƒäº†æ ˆé‡Œçš„æ•°æ®è€ŒPOPæŒ‡ä»¤è¿˜è¦æŠŠå¯„å­˜å™¨é‡Œçš„å€¼å­˜å‚¨åˆ°æ—¢å®šå¯„å­˜å™¨</p>
<p>æŸäº›ç¼–è¯‘å™¨ï¼ˆå¦‚Intel C<ins>ç¼–è¾‘å™¨ï¼‰ä¸ä¼šä½¿ç”¨ADDæŒ‡ä»¤æ¥é‡Šæ”¾æ•°æ®æ ˆï¼Œ<strong>å®ƒä»¬å¯èƒ½ä¼šç”¨POP ECXæŒ‡ä»¤</strong>ã€‚ä¾‹å¦‚ï¼ŒOracle RDBMSï¼ˆç”±Intel C</ins>ç¼–è¯‘å™¨ç¼–è¯‘ï¼‰å°±ä¼šç”¨POP ECXæŒ‡ä»¤ï¼Œè€Œä¸ä¼šç”¨ADDæŒ‡ä»¤ã€‚è™½ç„¶POP ECXå‘½ä»¤ç¡®å®ä¼šä¿®æ”¹ECXå¯„å­˜å™¨çš„å€¼ï¼Œä½†æ˜¯å®ƒä¹ŸåŒæ ·é‡Šæ”¾äº†æ ˆç©ºé—´ã€‚</p>
<p>Intel C++ç¼–è¯‘å™¨ä½¿ç”¨POP ECXæŒ‡ä»¤çš„å¦å¤–ä¸€ä¸ªç†ç”±å°±æ˜¯ï¼Œ<strong>POP ECXå¯¹åº”çš„OPCODEï¼ˆ1å­—èŠ‚ï¼‰æ¯”ADD ESPçš„OPCODEï¼ˆ3å­—èŠ‚ï¼‰è¦çŸ­ã€‚</strong></p>
</li>
<li>
<p>åœ¨ä¸Šè¿°ç¨‹åºä¸­printf()å‡½æ•°ç»“æŸä¹‹åï¼Œmain()å‡½æ•°ä¼šè¿”å›0ï¼ˆå‡½æ•°æ­£å¸¸é€€å‡ºçš„è¿”å›ç ï¼‰ã€‚å³main()å‡½æ•°çš„è¿ç®—ç»“æœæ˜¯0ã€‚è¿™ä¸ªè¿”å›å€¼æ˜¯ç”±<strong>æŒ‡ä»¤<code>â€œXOR EAX, EAXâ€</code>è®¡ç®—å‡ºæ¥çš„</strong>ã€‚ç¼–è¯‘å™¨é€šå¸¸é‡‡ç”¨å¼‚æˆ–è¿ç®—æŒ‡ä»¤ï¼Œè€Œä¸ä¼šä½¿ç”¨â€œMOV EAXï¼Œ0â€æŒ‡ä»¤ã€‚ä¸»è¦æ˜¯å› ä¸º<strong>å¼‚æˆ–è¿ç®—çš„opcodeè¾ƒçŸ­</strong>ï¼ˆ2å­—èŠ‚:5å­—èŠ‚ï¼‰</p>
</li>
<li>
<p>æ±‡ç¼–åˆ—è¡¨ä¸­æœ€åçš„æ“ä½œæŒ‡ä»¤æ˜¯RETï¼Œå°†æ§åˆ¶æƒäº¤ç»™è°ƒç”¨ç¨‹åºã€‚é€šå¸¸å®ƒèµ·åˆ°çš„ä½œç”¨å°±æ˜¯å°†æ§åˆ¶æƒäº¤ç»™æ“ä½œç³»ç»Ÿï¼Œè¿™éƒ¨åˆ†åŠŸèƒ½ç”±C/C++çš„<code>CRT</code>å®ç°ã€‚ï¼ˆC RUNTIME LIBRARY)</p>
</li>
</ul>
<h4 id="gcc"><a class="markdownIt-Anchor" href="#gcc"></a> gcc</h4>
<p>åˆ©ç”¨<code>gcc</code>ç¼–è¯‘å™¨ç¼–è¯‘<code>gcc 1.c -o 1</code>é‡‡ç”¨<code>-S -masm=intel</code>ç”Ÿæˆintelè¯­æ³•çš„æ±‡ç¼–åˆ—è¡¨æ–‡ä»¶</p>
<p>ç”Ÿæˆåç”¨IDAæ‰“å¼€</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">Main         proc near
var_10       <span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">10h</span>

             push    <span class="token register variable">ebp</span>
             mov     <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
             and     <span class="token register variable">esp</span>, <span class="token number">0FFFFFFF0h</span>
             sub     <span class="token register variable">esp</span>, <span class="token number">10h</span>
             mov     <span class="token register variable">eax</span>, offset aHelloWorld <span class="token comment">; "hello, world\n"</span>
             mov     <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>var_10<span class="token operator">]</span>, <span class="token register variable">eax</span>
             call    _printf
             mov     <span class="token register variable">eax</span>, <span class="token number">0</span>
             leave
             retn
main         endp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ±‡ç¼–è§£è¯»</p>
<ul>
<li>ä¸MSVCç”Ÿæˆçš„ç»“æœåŸºæœ¬ç›¸åŒã€‚å®ƒé¦–å…ˆæŠŠâ€œhello, worldâ€å­—ç¬¦ä¸²åœ¨æ•°æ®æ®µçš„åœ°å€ï¼ˆæŒ‡é’ˆï¼‰å­˜å‚¨åˆ°EAXå¯„å­˜å™¨é‡Œï¼Œç„¶åå†æŠŠå®ƒå­˜å‚¨åœ¨æ•°æ®æ ˆé‡Œã€‚</li>
<li>å¼€å¤´çš„<code>and esp,0FFFFFFF0h</code>å‘16å­—èŠ‚è¾¹ç•Œå¯¹é½ï¼ˆæˆä¸º16çš„æ•´æ•°å€ï¼‰ï¼Œå±äºåˆå§‹åŒ–çš„æŒ‡ä»¤ã€‚å¦‚æœåœ°å€ä½æ²¡æœ‰å¯¹é½ï¼Œé‚£ä¹ˆCPUå¯èƒ½éœ€è¦è®¿é—®ä¸¤æ¬¡å†…å­˜æ‰èƒ½è·å¾—æ ˆå†…æ•°æ®ã€‚è™½ç„¶åœ¨8å­—èŠ‚è¾¹ç•Œå¤„å¯¹é½å°±å¯ä»¥æ»¡è¶³32ä½x86 CPUå’Œ64ä½x64 CPUçš„è¦æ±‚ï¼Œä½†æ˜¯ä¸»æµç¼–è¯‘å™¨çš„ç¼–è¯‘è§„åˆ™è§„å®šâ€œç¨‹åºè®¿é—®çš„åœ°å€å¿…é¡»å‘16å­—èŠ‚å¯¹é½ï¼ˆè¢«16æ•´é™¤ï¼‰,ç›®çš„æ˜¯ä¸ºäº†æé«˜æ•ˆç‡</li>
<li><code>â€œSUB ESPï¼Œ10hâ€</code>å°†åœ¨æ ˆä¸­åˆ†é…0x10 bytesï¼Œå³16å­—èŠ‚ã€‚æˆ‘ä»¬åœ¨åæ–‡çœ‹åˆ°ï¼Œç¨‹åºåªä¼šç”¨åˆ°4å­—èŠ‚ç©ºé—´ã€‚ä½†æ˜¯å› ä¸ºç¼–è¯‘å™¨å¯¹æ ˆåœ°å€ï¼ˆESPï¼‰è¿›è¡Œäº†16å­—èŠ‚å¯¹é½ï¼Œæ‰€ä»¥æ¯æ¬¡éƒ½ä¼šåˆ†é…16å­—èŠ‚çš„ç©ºé—´ã€‚</li>
<li>è€Œåï¼Œç¨‹åºå°†å­—ç¬¦ä¸²åœ°å€ï¼ˆæŒ‡é’ˆçš„å€¼ï¼‰ç›´æ¥å†™å…¥åˆ°æ•°æ®æ ˆã€‚æ­¤å¤„ï¼ŒGCCä½¿ç”¨çš„æ˜¯MOVæŒ‡ä»¤ï¼›è€ŒMSVCç”Ÿæˆçš„æ˜¯PUSHæŒ‡ä»¤ã€‚å…¶ä¸­var_10æ˜¯å±€éƒ¨å˜é‡ï¼Œç”¨æ¥å‘åé¢çš„printf()å‡½æ•°ä¼ é€’å‚æ•°ã€‚</li>
<li>GCCå’ŒMSVCä¸åŒï¼Œé™¤éäººå·¥æŒ‡å®šä¼˜åŒ–é€‰é¡¹ï¼Œå¦åˆ™å®ƒä¼šç”Ÿæˆä¸æºä»£ç ç›´æ¥å¯¹åº”çš„â€œMOV EAX, 0â€æŒ‡ä»¤ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“MOVæŒ‡ä»¤çš„opcodeè‚¯å®šè¦æ¯”XORæŒ‡ä»¤çš„opcodeé•¿ã€‚</li>
<li>LEAVEæŒ‡ä»¤ï¼Œç®€åŒ–å‡½æ•°å°¾å£°ï¼Œç­‰æ•ˆäº<code>â€œMOV ESP, EBPâ€</code>å’Œâ€œ<code>POP EBPâ€</code>ä¸¤æ¡æŒ‡ä»¤ã€‚å¯è§ï¼Œè¿™ä¸ªæŒ‡ä»¤è°ƒæ•´äº†æ•°æ®æ ˆæŒ‡é’ˆESPï¼Œå¹¶å°†EBPçš„æ•°å€¼æ¢å¤åˆ°è°ƒç”¨è¿™ä¸ªå‡½æ•°ä¹‹å‰çš„åˆå§‹çŠ¶æ€ã€‚</li>
</ul>
<h4 id="msvs-x86-64"><a class="markdownIt-Anchor" href="#msvs-x86-64"></a> msvs x86-64</h4>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token operator">$</span>SG2989  DB      <span class="token string">'hello, world'</span>, <span class="token number">0AH</span> <span class="token number">00H</span>

main     PROC
         sub     <span class="token register variable">rsp</span>, <span class="token number">40</span>
         lea     <span class="token register variable">rcx</span>, OFFSET FLAT:<span class="token operator">$</span>SG2989
         call    printf
         xor     <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
         add     <span class="token register variable">rsp</span>, <span class="token number">40</span>
         ret     <span class="token number">0</span>
main     ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨x86-64æ¡†æ¶çš„CPUé‡Œï¼Œæ‰€æœ‰çš„ç‰©ç†å¯„å­˜å™¨éƒ½è¢«æ‰©å±•ä¸º64ä½å¯„å­˜å™¨ã€‚å¯„å­˜å™¨å˜ä¸ºrå­—å¼€å¤´</p>
<p>ä¸ºäº†å°½å¯èƒ½å……åˆ†åœ°åˆ©ç”¨å¯„å­˜å™¨ã€å‡å°‘è®¿é—®å†…å­˜æ•°æ®çš„æ¬¡æ•°ï¼Œç¼–è¯‘å™¨ä¼šå……åˆ†åˆ©ç”¨å¯„å­˜å™¨ä¼ é€’å‡½æ•°å‚æ•°ï¼ˆè¯·å‚è§64.3èŠ‚çš„fastcallçº¦å®šï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç¼–è¯‘å™¨ä¼šä¼˜å…ˆä½¿ç”¨å¯„å­˜å™¨ä¼ é€’éƒ¨åˆ†å‚æ•°ï¼Œå†åˆ©ç”¨å†…å­˜ï¼ˆæ•°æ®æ ˆï¼‰ä¼ é€’å…¶ä½™çš„å‚æ•°ã€‚<code>Win64çš„ç¨‹åº</code>è¿˜ä¼šä½¿ç”¨<code>RCXã€RDXã€R8ã€R9</code>è¿™4ä¸ªå¯„å­˜å™¨æ¥å­˜æ”¾å‡½æ•°å‚æ•°ã€‚æˆ‘ä»¬ç¨åå°±ä¼šçœ‹åˆ°è¿™ç§æƒ…å†µï¼šprintf()ä½¿ç”¨RCXå¯„å­˜å™¨ä¼ é€’å‚æ•°ï¼Œè€Œæ²¡æœ‰åƒ32ä½ç¨‹åºé‚£æ ·ä½¿ç”¨æ ˆä¼ é€’æ•°æ®ã€‚</p>
<p>main()å‡½æ•°çš„è¿”å›å€¼æ˜¯æ•´æ•°ç±»å‹çš„é›¶ï¼Œä½†æ˜¯å‡ºäºå…¼å®¹æ€§å’Œå¯ç§»æ¤æ€§çš„è€ƒè™‘ï¼ŒCè¯­è¨€çš„ç¼–è¯‘å™¨ä»å°†ä½¿ç”¨<code>32ä½çš„é›¶</code>ã€‚æ¢è€Œè¨€ä¹‹ï¼Œå³ä½¿æ˜¯64ä½çš„åº”ç”¨ç¨‹åºï¼Œåœ¨ç¨‹åºç»“æŸæ—¶EAXçš„å€¼æ˜¯é›¶ï¼Œè€ŒR<code>AXçš„å€¼ä¸ä¸€å®šä¼šæ˜¯é›¶ã€‚</code></p>
<p>æ•°æ®æ ˆçš„å¯¹åº”ç©ºé—´é‡Œä»ç•™æœ‰40å­—èŠ‚çš„æ•°æ®ã€‚è¿™éƒ¨åˆ†æ•°æ®ç©ºé—´æœ‰ä¸ªä¸“ç”¨çš„åè¯ï¼Œå³<code>é˜´å½±ç©ºé—´</code>ï¼ˆshadow spaceï¼‰</p>
<h4 id="gcc-x86-64"><a class="markdownIt-Anchor" href="#gcc-x86-64"></a> gcc x86-64</h4>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">.string <span class="token string">"hello, world\n"</span>
<span class="token label function">main:</span>
         sub      <span class="token register variable">rsp</span>, <span class="token number">8</span>
         mov      <span class="token register variable">edi</span>, OFFSET FLAT:.LC0 <span class="token comment">; "hello, world"</span>
         xor      <span class="token register variable">eax</span>, <span class="token register variable">eax</span>  <span class="token comment">; number of vector registers passed</span>
         call     printf
         xor      <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
         add      <span class="token register variable">rsp</span>, <span class="token number">8</span>
         ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>Linuxã€BSDå’ŒMac OS Xç³»ç»Ÿä¸­çš„åº”ç”¨ç¨‹åº</strong>ï¼Œä¼šä¼˜å…ˆä½¿ç”¨<code>RDIã€RSIã€RDXã€RCXã€R8ã€R9è¿™6ä¸ªå¯„å­˜å™¨ä¼ é€’å‡½æ•°æ‰€éœ€çš„å¤´6ä¸ªå‚æ•°</code>ï¼Œç„¶åä½¿ç”¨æ•°æ®æ ˆä¼ é€’å…¶ä½™çš„å‚æ•°ã€‚</p>
<p>ä½¿ç”¨äº†<code>EDI</code>å¯„å­˜å™¨æ¥ä¼ é€’å­—ç¬¦ä¸²æŒ‡é’ˆï¼Œä¸ºä»€ä¹ˆä¸ç”¨<code>RDI</code></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ64ä½æ±‡ç¼–æŒ‡ä»¤MOVåœ¨å†™å…¥R-å¯„å­˜å™¨çš„ä½32ä½åœ°å€ä½çš„æ—¶å€™ï¼Œå³å¯¹E-å¯„å­˜å™¨è¿›è¡Œå†™æ“ä½œçš„æ—¶å€™ï¼Œä¼šåŒæ—¶æ¸…é™¤R-å¯„å­˜å™¨ä¸­çš„é«˜32ä½åœ°å€ä½ã€‚æ‰€ä»¥, â€œMOV EAX, 011223344hâ€èƒ½å¤Ÿå¯¹RAXå¯„å­˜å™¨è¿›è¡Œæ­£ç¡®çš„èµ‹å€¼æ“ä½œï¼Œå› ä¸ºè¯¥æŒ‡ä»¤ä¼šæ¸…é™¤ï¼ˆç½®é›¶ï¼‰é«˜åœ°å€ä½çš„å†…å®¹ã€‚</p>
<p>ä½¿ç”¨<code>EDI</code>æ˜¯å› ä¸ºå¯ä»¥ä½¿<code>opcode</code>ç”±7ä¸ªå­—èŠ‚å‡å°‘åˆ°5ä¸ªå­—èŠ‚,gccä¼˜åŒ–</p>
<p><code>gcc</code>çš„ä¼˜åŒ–æœ‰å¾ˆå¤šç‰¹æ€§ï¼Œä¾‹å¦‚:å®ƒå¯èƒ½ä¼šæŠŠå­—ç¬¦ä¸²æ‹†å‡ºæ¥å•ç‹¬ä½¿ç”¨ã€‚ä»¥èŠ‚çœå†…å­˜</p>
<h4 id="problems"><a class="markdownIt-Anchor" href="#problems"></a> Problems</h4>
<p>1.ç­”:è°ƒç”¨äº†<code>MessagBeep</code>è¿™ä¸ªå‡½æ•°ï¼Œå‚æ•°ä¸º0xFFFFFFFF</p>
<h3 id="chap4-å‡½æ•°åºè¨€å’Œå‡½æ•°å°¾å£°"><a class="markdownIt-Anchor" href="#chap4-å‡½æ•°åºè¨€å’Œå‡½æ•°å°¾å£°"></a> Chap4 å‡½æ•°åºè¨€å’Œå‡½æ•°å°¾å£°</h3>
<p>ç•¥</p>
<h3 id="chap5-æ ˆ"><a class="markdownIt-Anchor" href="#chap5-æ ˆ"></a> Chap5 æ ˆ</h3>
<ul>
<li>
<p>æ ˆå°±æ˜¯CPUå¯„å­˜å™¨é‡Œçš„æŸä¸ªæŒ‡é’ˆæ‰€æŒ‡å‘çš„ä¸€ç‰‡å†…å­˜åŒºåŸŸã€‚è¿™é‡Œæ‰€è¯´çš„â€œæŸä¸ªæŒ‡é’ˆâ€é€šå¸¸ä½äºx86/x64å¹³å°çš„ESPå¯„å­˜å™¨/RSPå¯„å­˜å™¨ï¼Œä»¥åŠARMå¹³å°çš„SPå¯„å­˜å™¨ã€‚</p>
</li>
<li>
<p>æ“ä½œæ ˆçš„æœ€å¸¸è§çš„æŒ‡ä»¤æ˜¯PUSHå’ŒPOPï¼Œ<code>PUSH</code>æŒ‡ä»¤ä¼šå¯¹ESP/RSP/SPå¯„å­˜å™¨çš„å€¼è¿›è¡Œå‡æ³•è¿ç®—ï¼Œä½¿ä¹‹å‡å»4ï¼ˆ32ä½ï¼‰æˆ–8ï¼ˆ64ä½ï¼‰ï¼Œç„¶åå°†æ“ä½œæ•°å†™åˆ°ä¸Šè¿°å¯„å­˜å™¨é‡Œçš„æŒ‡é’ˆæ‰€æŒ‡å‘çš„å†…å­˜ä¸­ã€‚<code>POP</code>æŒ‡ä»¤æ˜¯PUSHæŒ‡ä»¤çš„é€†æ“ä½œï¼šå®ƒå…ˆä»æ ˆæŒ‡é’ˆï¼ˆStack Pointerï¼Œä¸Šé¢ä¸‰ä¸ªå¯„å­˜å™¨ä¹‹ä¸€ï¼‰æŒ‡å‘çš„å†…å­˜ä¸­è¯»å–æ•°æ®ï¼Œç”¨ä»¥å¤‡ç”¨ï¼ˆé€šå¸¸æ˜¯å†™åˆ°å…¶ä»–å¯„å­˜å™¨é‡Œï¼‰ï¼Œç„¶åå†å°†æ ˆæŒ‡é’ˆçš„æ•°å€¼åŠ ä¸Š4æˆ–8ã€‚</p>
</li>
<li>
<p>æ ˆæ˜¯é€†å¢é•¿çš„ï¼Œå³ä»é«˜åœ°å€å‘ä½åœ°å€å¢é•¿</p>
</li>
</ul>
<hr />
<h4 id="æ ˆçš„ç”¨é€”"><a class="markdownIt-Anchor" href="#æ ˆçš„ç”¨é€”"></a> æ ˆçš„ç”¨é€”</h4>
<ul>
<li>
<p>ä¿å­˜å‡½æ•°çš„è¿”å›åœ°å€</p>
<p><code>call</code>æŒ‡ä»¤ç­‰ä»·äº<code>push è¿”å›åœ°å€</code>ä¸<code>jmp å‡½æ•°åœ°å€</code></p>
<p><code>ret</code>æŒ‡ä»¤ä»æ ˆä¸­è¯»å–è¿”å›åœ°å€ï¼Œç„¶åè·³è½¬åˆ°è¿™ä¸ªåœ°å€ï¼Œç­‰ä»·äº<code>pop è¿”å›åœ°å€</code>ä¸<code>jmp è¿”å›åœ°å€</code></p>
<p>ç”±æ­¤å¯å®ç°å‡½æ•°çš„é€’å½’è°ƒç”¨</p>
</li>
<li>
<p>å‚æ•°ä¼ é€’</p>
<p>æœ€å¸¸ç”¨çš„å‚æ•°ä¼ é€’çº¦å®šæ˜¯<code>cdecl</code></p>
<p>ä»¥ä¸‹ä¸ºå…¶ä¸»è¦è§„åˆ™</p>
<ol>
<li><strong>å‚æ•°ä»å³åˆ°å·¦å‹å…¥æ ˆ</strong></li>
<li><strong>è°ƒç”¨è€…è´Ÿè´£æ¸…ç†æ ˆ</strong>ï¼šå‡½æ•°è°ƒç”¨ç»“æŸåï¼Œè°ƒç”¨è€…éœ€è¦è´Ÿè´£ä»æ ˆä¸­å¼¹å‡ºä¼ é€’ç»™å‡½æ•°çš„æ‰€æœ‰å‚æ•°ã€‚è¿™æ„å‘³ç€ç¼–è¯‘å™¨ä¼šåœ¨è°ƒç”¨å‡½æ•°ä¹‹åç”Ÿæˆç›¸åº”çš„ä»£ç æ¥è°ƒæ•´å †æ ˆæŒ‡é’ˆï¼Œæ¢å¤è°ƒç”¨å‰çš„çŠ¶æ€ã€‚</li>
<li><strong>å¯å˜å‚æ•°åˆ—è¡¨æ”¯æŒ</strong>ï¼šcdecl æ”¯æŒå‡½æ•°å…·æœ‰å¯å˜æ•°é‡çš„å‚æ•°ï¼ˆå¦‚ printf å‡½æ•°ï¼‰ï¼Œè¿™æ˜¯é€šè¿‡åœ¨å‚æ•°åˆ—è¡¨ä¸­ä½¿ç”¨çœç•¥å·ï¼ˆâ€¦ï¼‰æ¥è¡¨ç¤ºçš„ã€‚</li>
<li><strong>è¿”å›å€¼é€šå¸¸åœ¨EAXå¯„å­˜å™¨ä¸­</strong>ï¼ˆå¯¹äºx86æ¶æ„ï¼‰ï¼šå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå‡½æ•°çš„è¿”å›å€¼å¦‚æœå¤§å°é€‚å½“ï¼ˆæ¯”å¦‚æ•´æ•°ã€æŒ‡é’ˆï¼‰ï¼Œä¼šé€šè¿‡EAXå¯„å­˜å™¨è¿”å›ã€‚å¯¹äºæ›´å¤§çš„è¿”å›ç±»å‹ï¼Œå¯èƒ½ä¼šé€šè¿‡å…¶ä»–æ–¹å¼ï¼Œå¦‚é€šè¿‡æŒ‡é’ˆä¼ é€’ã€‚</li>
</ol>
<p>ä¾‹å¦‚</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">push arg3
push arg2
push arg1
call f
add <span class="token register variable">esp</span>.<span class="token number">12</span><span class="token comment">;4*3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¢«è°ƒç”¨çš„å‡½æ•°å¯ä»¥é€šè¿‡æ ˆæŒ‡é’ˆè·å–æ‰€éœ€å‚æ•°</p>
<table>
<thead>
<tr>
<th>ESP</th>
<th>è¿”å›åœ°å€</th>
</tr>
</thead>
<tbody>
<tr>
<td>ESP+4</td>
<td>arg1, å®ƒåœ¨IDAé‡Œè®°ä¸ºarg_0</td>
</tr>
<tr>
<td>ESP+8</td>
<td>arg2, å®ƒåœ¨IDAé‡Œè®°ä¸ºarg_4</td>
</tr>
<tr>
<td>ESP+0xC</td>
<td>arg3, å®ƒåœ¨IDAé‡Œè®°ä¸ºarg_8</td>
</tr>
</tbody>
</table>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç¨‹åºå‘˜å¯ä»¥ä½¿ç”¨æ ˆæ¥ä¼ é€’å‚æ•°ï¼Œä¹Ÿå¯ä»¥ä¸ä½¿ç”¨æ ˆä¼ é€’å‚æ•°ã€‚å‚æ•°å¤„ç†æ–¹é¢å¹¶æ²¡æœ‰ç›¸å…³çš„ç¡¬æ€§è§„å®šã€‚ä¾‹å¦‚ä¹Ÿå¯ä»¥ç”¨å¯„å­˜å™¨æˆ–è€…å †ä¸Šå¼€è¾Ÿå†…å­˜è¿›è¡Œä¼ å‚ï¼Œä¸è¿‡åœ¨x86è¿™ç§çº¦å®šå·²æ˜¯ä¹ æƒ¯</p>
<p>å¦‚æœå‡½æ•°å¯å¤„ç†çš„å‚æ•°æ•°é‡å¯å˜ï¼Œå°±éœ€è¦ç”¨è¯´æ˜ç¬¦å¦‚%dè¿›è¡Œæ ¼å¼åŒ–è¯´æ˜ï¼Œæ˜ç¡®å‚æ•°ä¿¡æ¯</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d %d %d"</span><span class="token punctuation">,</span> <span class="token number">1234</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>è¿™ä¸ªå‘½ä»¤ä¸ä»…ä¼šè®©printf()æ˜¾ç¤º1234ï¼Œè€Œä¸”è¿˜ä¼šè®©å®ƒæ˜¾ç¤ºæ•°æ®æ ˆå†…1234ä¹‹åçš„ä¸¤ä¸ªåœ°å€çš„éšæœºæ•°ã€‚</p>
<p>ç”±æ­¤å¯çŸ¥ï¼Œå£°æ˜main()å‡½æ•°çš„æ–¹æ³•å¹¶ä¸æ˜¯é‚£ä¹ˆé‡è¦ã€‚æˆ‘ä»¬å¯ä»¥å°†ä¹‹å£°æ˜ä¸º<code>main(),main(int argc, char *argv[])æˆ–main(int argc, char *argv[], char *envp[])</code>,CRTä¸­è°ƒç”¨<code>main()</code>æŒ‡ä»¤å¦‚ä¸‹:</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">push envp
push argv
push argc
call main<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>å­˜å‚¨å±€éƒ¨å˜é‡</p>
</li>
<li>
<p>x86.alloca()å‡½æ•°</p>
<p><code>malloc()</code>æ˜¯åœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼Œè€Œ<code>alloc()</code>ç›´æ¥ä½¿ç”¨æ ˆæ¥åˆ†é…å†…å­˜</p>
<p>ç”±äºå‡½æ•°å°¾å£°çš„ä»£ç ä¼šè¿˜åŸ<code>ESP</code>çš„å€¼ï¼Œä¸éœ€è¦ç‰¹åœ°ä½¿ç”¨<code>free()</code>æ¥é‡Šæ”¾å†…å­˜</p>
</li>
<li>
<p>(Win)SEHç»“æ„åŒ–å¼‚å¸¸å¤„ç†</p>
<p>å¦‚æœç¨‹åºé‡Œå­˜åœ¨<code>SEH</code>è®°å½•ï¼Œé‚£ä¹ˆè®°å½•ä¼šä¿å­˜åœ¨æ ˆä¸­</p>
</li>
<li>
<p>ç¼“å†²åŒºæº¢å‡ºä¿æŠ¤</p>
</li>
<li>
<p>å…¸å‹çš„æ ˆçš„å†…å­˜å­˜å‚¨æ ¼å¼</p>
<p>åœ¨32ä½ç³»ç»Ÿä¸­ï¼Œåœ¨ç¨‹åºè°ƒç”¨å‡½æ•°ä¹‹åã€æ‰§è¡Œå®ƒçš„ç¬¬ä¸€æ¡æŒ‡ä»¤ä¹‹å‰ï¼Œæ ˆåœ¨å†…å­˜ä¸­çš„å­˜å‚¨æ ¼å¼ä¸€èˆ¬å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token operator">|</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token operator">|</span> <span class="token comment">//é«˜ä½</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token operator">|</span> å‚æ•°      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token operator">|</span> è¿”å›åœ°å€  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>  <span class="token operator">&lt;</span><span class="token operator">-</span> <span class="token function">esp</span> <span class="token punctuation">(</span>è°ƒç”¨å<span class="token punctuation">)</span>
<span class="token operator">|</span> è°ƒç”¨è€…çš„ebp <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
<span class="token operator">|</span> å±€éƒ¨å˜é‡  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>  <span class="token operator">&lt;</span><span class="token operator">-</span> <span class="token function">esp</span> <span class="token punctuation">(</span>è®¾ç½®å®Œå±€éƒ¨å˜é‡å<span class="token punctuation">)</span><span class="token comment">//ä½ä½</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<table>
<thead>
<tr>
<th>â€¦</th>
<th>â€¦â€¦</th>
</tr>
</thead>
<tbody>
<tr>
<td>ESP-0xC</td>
<td>ç¬¬2ä¸ªå±€éƒ¨å˜é‡ï¼Œåœ¨IDAé‡Œè®°ä¸ºvar_8</td>
</tr>
<tr>
<td>ESP-8</td>
<td>ç¬¬1ä¸ªå±€éƒ¨å˜é‡ï¼Œåœ¨IDAé‡Œè®°ä¸ºvar_4</td>
</tr>
<tr>
<td>ESP-4</td>
<td>ä¿å­˜çš„EBPå€¼</td>
</tr>
<tr>
<td>ESP</td>
<td>è¿”å›åœ°å€</td>
</tr>
<tr>
<td>ESP+4</td>
<td>arg1, åœ¨IDAé‡Œè®°ä¸ºarg_0</td>
</tr>
<tr>
<td>ESP+8</td>
<td>arg2, åœ¨IDAé‡Œè®°ä¸ºarg_4</td>
</tr>
<tr>
<td>ESP+0xC</td>
<td>arg3, åœ¨IDAé‡Œè®°ä¸ºarg_8</td>
</tr>
<tr>
<td>â€¦</td>
<td>â€¦â€¦</td>
</tr>
</tbody>
</table>
</li>
</ul>
<hr />
<h4 id="æ ˆçš„å™ªéŸ³"><a class="markdownIt-Anchor" href="#æ ˆçš„å™ªéŸ³"></a> æ ˆçš„å™ªéŸ³</h4>
<p>å‡½æ•°é€€å‡ºä»¥å,åŸæœ‰æ ˆçš„ç©ºé—´é‡Œçš„å±€éƒ¨å˜é‡ä¸ä¼šè¢«è‡ªåŠ¨æ¸…é™¤ï¼Œä»ç„¶ä¿ç•™å°±æˆäº†æ ˆä¸­çš„è„æ•°æ®</p>
<p>ä¾‹å¦‚</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">void</span> <span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> a<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> b<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">f2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">;</span>
        <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"%d, %d, %d\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span>
        <span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">f2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬ä¼šå‘ç°ï¼Œæ²¡æœ‰å¯¹f2çš„å˜é‡åˆå§‹åŒ–ï¼Œä»ç„¶æ‰“å°çš„æ˜¯ 1 2 3</p>
<p>å¯ä»¥ç ”ç©¶ä¸€ä¸‹æ±‡ç¼–ä»£ç ,åˆ©ç”¨MSVSç¼–è¯‘çš„ä»£ç å¦‚ä¸‹</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token operator">$</span>SG2752 DB      <span class="token string">'%d, %d, %d'</span>, <span class="token number">0aH</span>, <span class="token number">00H</span>

_c<span class="token operator">$</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">12</span>       <span class="token comment">; size = 4</span>
_b<span class="token operator">$</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">8</span>        <span class="token comment">; size = 4</span>
_a<span class="token operator">$</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">4</span>        <span class="token comment">; size = 4</span>
_f1    PROC
       push     <span class="token register variable">ebp</span>
       mov      <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
       sub      <span class="token register variable">esp</span>, <span class="token number">12</span>
       mov      DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token number">1</span>
       mov      DWORD PTR _b<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token number">2</span>
       mov      DWORD PTR _c<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token number">3</span>
       mov      <span class="token register variable">esp</span>, <span class="token register variable">ebp</span>
       pop      <span class="token register variable">ebp</span>
       ret      <span class="token number">0</span>
_f1    ENDP

_c<span class="token operator">$</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">12</span>       <span class="token comment">; size = 4</span>
_b<span class="token operator">$</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">8</span>        <span class="token comment">; size = 4</span>
_a<span class="token operator">$</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">4</span>        <span class="token comment">; size = 4</span>
_f2    PROC
       push     <span class="token register variable">ebp</span>
       mov      <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
       sub      <span class="token register variable">esp</span>, <span class="token number">12</span>
       mov      <span class="token register variable">eax</span>, DWORD PTR _c<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
       push     <span class="token register variable">eax</span>
       mov      <span class="token register variable">ecx</span>, DWORD PTR _b<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
       push     <span class="token register variable">ecx</span>
       mov      <span class="token register variable">edx</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
       push     <span class="token register variable">edx</span>
       push     OFFSET <span class="token operator">$</span>SG2752 <span class="token comment">; â€™%d, %d, %dâ€™</span>
       call     DWORD PTR __imp__printf
       add      <span class="token register variable">esp</span>, <span class="token number">16</span>
       mov      <span class="token register variable">esp</span>, <span class="token register variable">ebp</span>
       pop      <span class="token register variable">ebp</span>
       ret      <span class="token number">0</span>
_f2    ENDP

main   PROC
       push     <span class="token register variable">ebp</span>
       mov      <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
       call     _f1
       call     _f2
       xor      <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
       pop      <span class="token register variable">ebp</span>
       ret      <span class="token number">0</span>
_main  ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨è¿™ä¸ªç‰¹ä¾‹é‡Œï¼Œç¬¬äºŒä¸ªå‡½æ•°åœ¨ç¬¬ä¸€ä¸ªå‡½æ•°ä¹‹åæ‰§è¡Œï¼Œè€Œç¬¬äºŒä¸ªå‡½æ•°å˜é‡çš„åœ°å€å’ŒSPçš„å€¼åˆä¸ç¬¬ä¸€ä¸ªå‡½æ•°çš„æƒ…å†µç›¸åŒã€‚æ‰€ä»¥ï¼Œç›¸åŒåœ°å€çš„å˜é‡è·å¾—çš„å€¼ç›¸åŒã€‚</p>
<p>æ€»è€Œè¨€ä¹‹ï¼Œåœ¨è¿è¡Œç¬¬äºŒä¸ªå‡½æ•°æ—¶ï¼Œæ ˆä¸­çš„æ‰€æœ‰å€¼ï¼ˆå³å†…å­˜ä¸­çš„å•å…ƒï¼‰å—å‰ä¸€ä¸ªå‡½æ•°çš„å½±å“ï¼Œè€Œè·å¾—äº†å‰ä¸€ä¸ªå‡½æ•°çš„å˜é‡çš„å€¼ã€‚ä¸¥æ ¼åœ°è¯´ï¼Œè¿™äº›åœ°å€çš„å€¼ä¸æ˜¯éšæœºå€¼ï¼Œè€Œæ˜¯å¯é¢„æµ‹çš„ä¼ªéšæœºå€¼ã€‚</p>
<h4 id="problems-2"><a class="markdownIt-Anchor" href="#problems-2"></a> Problems</h4>
<h5 id="51"><a class="markdownIt-Anchor" href="#51"></a> 5.1</h5>
<p>å¦‚æœä½¿ç”¨MSVCç¼–è¯‘ã€è¿è¡Œä¸‹åˆ—ç¨‹åºï¼Œå°†ä¼šæ‰“å°å‡º3ä¸ªæ•´æ•°ã€‚è¿™äº›æ•°å€¼æ¥è‡ªå“ªé‡Œï¼Ÿå¦‚æœä½¿ç”¨MSVCçš„ä¼˜åŒ–é€‰é¡¹â€œ/Oxâ€ï¼Œç¨‹åºåˆä¼šåœ¨å±å¹•ä¸Šè¾“å‡ºä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆGCCçš„æƒ…å†µå®Œå…¨ä¸åŒï¼Ÿ</p>
<pre class="line-numbers language-none"><code class="language-none">#include &lt;stdio.h&gt;

int main() 
&#123;
         printf (&quot;%d, %d, %d\n&quot;);

         return 0;
&#125;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¦‚æœæœªå¯ç”¨MSVCçš„ä¼˜åŒ–ç¼–è¯‘åŠŸèƒ½ï¼Œç¨‹åºæ˜¾ç¤ºçš„æ•°å­—åˆ†åˆ«æ˜¯EBPçš„å€¼ã€RAå’Œargcã€‚åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œç›¸åº”çš„ç¨‹åºå³å¯è¿›è¡ŒéªŒè¯ã€‚</p>
<p>å¦‚æœå¯ç”¨äº†MSVCçš„ä¼˜åŒ–ç¼–è¯‘åŠŸèƒ½ï¼Œç¨‹åºæ˜¾ç¤ºçš„æ•°å­—åˆ†åˆ«æ¥è‡ªï¼šè¿”å›åœ°å€RAã€argcå’Œæ•°ç»„argvï¼»ï¼½ã€‚</p>
<p>GCCä¼šç»™main() å‡½æ•°çš„å…¥å£åˆ†é…16å­—èŠ‚çš„åœ°å€ç©ºé—´ï¼Œæ‰€ä»¥è¾“å‡ºå†…å®¹ä¼šæœ‰ä¸åŒã€‚</p>
<h5 id="52"><a class="markdownIt-Anchor" href="#52"></a> 5.2</h5>
<p>ç­”ï¼šæ‰“å°æ—¶é—´</p>
<h3 id="chap6-printfå‡½æ•°ä¸å‚æ•°ä¼ é€’"><a class="markdownIt-Anchor" href="#chap6-printfå‡½æ•°ä¸å‚æ•°ä¼ é€’"></a> Chap6 printf()å‡½æ•°ä¸å‚æ•°ä¼ é€’</h3>
<p>æ¼”ç¤ºç¨‹åº</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"a=%d,b=%d,c=%d"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç”¨<code> g++ -m32 -o 1 1.c</code>è¿›è¡Œç¼–è¯‘æˆ–è€…ä½¿ç”¨<code>MSVS</code>å·¥å…·é“¾è¿›è¡Œç¼–è¯‘ï¼Œè·Ÿéšæœ¬ä¹¦çš„èŠ‚å¥ï¼Œé…ç½®ä¸€ä¸‹<code>MSVS</code>çš„ç¯å¢ƒ</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/cpp/build/building-on-the-command-line?view=msvc-170#download-and-install-the-tools">é€šè¿‡å‘½ä»¤è¡Œä½¿ç”¨ Microsoft C++ å·¥å…·é›† | Microsoft Learn</a></p>
<p>é¦–å…ˆå°†<code>Microsoft Visual Studio\2022\Community\VC\Auxiliary\Build</code>åŠ å…¥ç¯å¢ƒå˜é‡</p>
<p>å‘½ä»¤è¡Œè¾“å…¥<code>vcvarsall.bat x86</code></p>
<p>ç„¶å<code>cl 1.cpp</code></p>
<hr />
<p>MSVSå·¥å…·é“¾ä¸€äº›å¸¸ç”¨çš„æŒ‡ä»¤</p>
<p><code>cl /Fa 1.c</code>ç”Ÿæˆä¸å¸¦æ³¨é‡Šçš„æ±‡ç¼–ä»£ç </p>
<p><code>cl /FAs 1.c</code>ç”Ÿæˆå¸¦æ³¨é‡Šçš„æ±‡ç¼–ä»£ç ,ç”Ÿæˆ1.asm</p>
<p><code>dumpbin /all example.obj</code>æ˜¾ç¤ºç›®æ ‡æ–‡ä»¶ä¸­çš„æ‰€æœ‰ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ®µå†…å®¹ã€ç¬¦å·è¡¨å’Œé‡å®šä½ä¿¡æ¯ã€‚</p>
<p>/c ä»£è¡¨åªç¼–è¯‘ä¸é“¾æ¥ã€‚</p>
<p>/I æŒ‡å®šå¤´æ–‡ä»¶çš„ç›®å½•</p>
<p>/C åœ¨ç¼–è¯‘æœŸé—´ä¿ç•™ä»£ç æ³¨é‡Šï¼Œè¿™é‡Œå’Œ/Iè¿åœ¨ä¸€èµ·ä½¿ç”¨ï¼Œ/IC</p>
<p>é¦–å…ˆä»‹ç»ä¸€ä¸ªæ¦‚å¿µï¼ŒVCä¸­æœ‰ä¸ªPDBæ–‡ä»¶ï¼Œå…¨ç§°æ˜¯Program Databaseï¼Œç”¨æ¥å­˜æ”¾ç¨‹åºä¿¡æ¯çš„å°çš„<a target="_blank" rel="noopener" href="http://lib.csdn.net/base/14">æ•°æ®åº“</a>æ–‡ä»¶ã€‚</p>
<p>ç¼–è¯‘Debugç‰ˆæœ¬æ—¶ï¼Œè°ƒè¯•ä¿¡æ¯éœ€è¦ä¿ç•™ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©ç›´æ¥å°†è°ƒè¯•ä¿¡æ¯å†™åˆ°.objæ–‡ä»¶ä¸­ï¼Œæˆ–è€…å­˜åˆ°.pdbæ–‡ä»¶ä¸­ã€‚</p>
<p>/Z7 ä¸äº§ç”Ÿ.pdbæ–‡ä»¶ï¼Œå°†æ‰€æœ‰è°ƒè¯•ä¿¡æ¯å­˜å…¥.objæ–‡ä»¶ä¸­</p>
<p>/Ziå’Œ/ZI éƒ½äº§ç”Ÿ.pdbæ–‡ä»¶ï¼Œä¸è¿‡/ZIæ”¯æŒ&quot;ç¼–è¾‘ç»§ç»­è°ƒè¯•&quot;åŠŸèƒ½, (the edit and continue feature), çœ‹ä¸Šå»æ›´é…·ï¼Œä½†æ˜¯æˆ‘ä»æ¥æ²¡æœ‰ç”¨è¿‡è¿™ä¸ªåŠŸèƒ½ã€‚</p>
<p>/ZIæœ‰ä¸€äº›è¾¹é™…æ•ˆåº”ï¼Œä¼šç¦æ­¢#pragma optmize æŒ‡ä»¤ï¼Œä¹Ÿä¸èƒ½å’Œ/clrä¸€èµ·ç”¨ã€‚</p>
<p>/nologo- å·²ç»æ— æ•ˆï¼Œè‡ªå·±ç”Ÿæˆå‘½ä»¤è¡Œçš„æ—¶å€™ï¼Œæ²¡å¿…è¦ç”¨äº†ã€‚</p>
<p>/W3 ä¹Ÿä¸­è­¦å‘Šçº§åˆ«ï¼ŒVCæä¾›äº†å¾ˆå¤šè­¦å‘Šçº§åˆ«ï¼Œå‚è€ƒ<a target="_blank" rel="noopener" href="http://msdn.microsoft.com/en-us/library/vstudio/thxezb7y.aspx">http://msdn.microsoft.com/en-us/library/vstudio/thxezb7y.aspx</a></p>
<p>è‡ªå·±ç¼–è¯‘çš„è¯ï¼Œç›´æ¥ç”¨/Wallæœ€å¥½ã€‚</p>
<p>/WX- ä¸å¤ªæ˜ç™½ä¸ºä»€ä¹ˆæœ‰ - å·ï¼Œï¼ˆä¼°è®¡æ˜¯å’Œ:NOçš„æ„æ€ç›¸åŒï¼Œä¹Ÿå°±æ˜¯ä¸å¯ç”¨è¯¥åŠŸèƒ½ï¼‰ï¼Œ /WXçš„æ„æ€æ˜¯å°†warningè½¬å˜æˆerrorï¼Œè¿™æ ·å¼ºè¿«æ¶ˆé™¤æ‰€æœ‰çš„warningï¼Œå¦‚æœå’Œ/Wallä¸€èµ·ä½¿ç”¨ï¼Œé‚£æ˜¯æœ€å¥½çš„ã€‚</p>
<p>/sdl æ˜¯å¯¹ä»£ç è¿›è¡Œå®‰å…¨æ£€æŸ¥ï¼Œå¦‚æœå‘ç°ç›¸å…³è­¦å‘Šï¼Œè½¬å˜æˆé”™è¯¯è¾“å‡º</p>
<p>/Od ç¦æ­¢ä¼˜åŒ–</p>
<p>/Oy- ç¦æ­¢è¯¥é€‰é¡¹ï¼Œè¯¥é€‰é¡¹å¦‚æœæ²¡æœ‰ - å·ï¼Œåˆ™ä¼šåœ¨x86ä¸Šç¼–è¯‘æ—¶å¿½ç•¥frame-pointerï¼Œèµ·åˆ°åŠ é€Ÿç¨‹åºçš„ä½œç”¨ã€‚ frame-pointerï¼Œæˆ‘æš‚æ—¶ä¸çŸ¥é“æ˜¯å•¥ã€‚</p>
<p>/D é¢„å¤„ç†å®šä¹‰ï¼Œåé¢å¯ä»¥è·Ÿä¸åŒçš„å‚æ•°éƒ½æ˜¯å®å•Šï¼Œæ¯”å¦‚<br />
/Gm å¯ç”¨æœ€å°åŒ–é‡æ–°ç¼–è¯‘, VCç”¨.idbä¿ç•™äº†ä¸Šæ¬¡ç¼–è¯‘çš„ç¼“å­˜ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ–‡ä»¶ä¾èµ–å…³ç³»ã€‚ä¸‹æ¬¡ç¼–è¯‘æ—¶å¯ä»¥ä½¿ç”¨.idbæ–‡ä»¶ç”¨æ¥æ£€æŸ¥ï¼Œè·³è¿‡ä¸éœ€è¦é‡æ–°ç¼–è¯‘çš„æ–‡ä»¶ã€‚</p>
<p>å…·ä½“å‚è§:</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/cpp/build/reference/compiler-options?view=msvc-170&amp;redirectedfrom=MSDN">MSVC Compiler Options | Microsoft Learn</a></p>
<h4 id="x86"><a class="markdownIt-Anchor" href="#x86"></a> x86</h4>
<p>MSVSç¼–è¯‘å¾—åˆ°çš„æ±‡ç¼–æŒ‡ä»¤å¦‚ä¸‹</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_TEXT	SEGMENT
_main	PROC

<span class="token comment">; 3    : &#123;</span>

	push	<span class="token register variable">ebp</span>
	mov	<span class="token register variable">ebp</span>, <span class="token register variable">esp</span>

<span class="token comment">; 4    :     printf("a=%d,b=%d,c=%d",1,2,3);</span>

	push	<span class="token number">3</span>
	push	<span class="token number">2</span>
	push	<span class="token number">1</span>
	push	OFFSET <span class="token operator">$</span>SG9695
	call	_printf
	add	<span class="token register variable">esp</span>, <span class="token number">16</span>					<span class="token comment">; 00000010H</span>

<span class="token comment">; 5    :     return 0; </span>

	xor	<span class="token register variable">eax</span>, <span class="token register variable">eax</span>

<span class="token comment">; 6    : &#125;</span>

	pop	<span class="token register variable">ebp</span>
	ret	<span class="token number">0</span>
_main	ENDP
_TEXT	ENDS<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¯ä»¥çœ‹åˆ°<code>printf()</code>å‡½æ•°çš„å‚æ•°æ˜¯é€†åºå­˜å…¥æ ˆä¸­ï¼Œç¬¬ä¸€ä¸ªå‚æ•°åœ¨æœ€åå…¥æ ˆ</p>
<p>åœ¨<code>32</code>ä½ä¸‹ï¼Œ32ä½åœ°å€æŒ‡é’ˆå’Œintç±»å‹æ•°æ®éƒ½å æ®<code>32ä½</code>å³<code>4å­—èŠ‚</code>çš„ç©ºé—´ï¼Œå› æ­¤4ä¸ªå‚æ•°æ€»å…±å ç”¨<code>16</code>å­—èŠ‚çš„å­˜å‚¨ç©ºé—´</p>
<p>å› æ­¤åœ¨è°ƒç”¨å‡½æ•°ä¹‹åï¼Œâ€œADD ESP, Xâ€æŒ‡ä»¤ä¿®æ­£ESPå¯„å­˜å™¨ä¸­çš„æ ˆæŒ‡é’ˆã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡callä¹‹åçš„è¿™æ¡æŒ‡ä»¤åˆ¤æ–­å‚æ•°çš„æ•°é‡ï¼š<code>å˜é‡æ€»æ•°ï¼*X*Ã·4ã€‚</code>(ä»…é€‚ç”¨äºè°ƒç”¨çº¦å®šä¸º<code>cdecl</code>çš„ç¨‹åº)</p>
<p>å¦‚æœæŸä¸ªç¨‹åºè¿ç»­åœ°è°ƒç”¨å¤šä¸ªå‡½æ•°ï¼Œä¸”è°ƒç”¨å‡½æ•°çš„æŒ‡ä»¤ä¹‹é—´ä¸å¤¹æ‚å…¶ä»–æŒ‡ä»¤ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨å¯èƒ½æŠŠé‡Šæ”¾å‚æ•°å­˜å‚¨ç©ºé—´çš„â€œADD ESP,Xâ€æŒ‡ä»¤è¿›è¡Œåˆå¹¶ï¼Œä¸€æ¬¡æ€§åœ°é‡Šæ”¾æ‰€æœ‰ç©ºé—´</p>
<hr />
<p>ä½“éªŒç”¨<code>onlydbg</code>åŠ è½½è¿™ä¸ªç¨‹åº</p>
<p>è¿™é‡Œéœ€è¦ç”¨åˆ°debugç‰ˆæœ¬çš„ç¼–è¯‘å‘½ä»¤</p>
<p><code>cl /Z7 /EHsc 1.exe 1.c</code>ä¾¿äºè·Ÿè¸ªç¨‹åº</p>
<p>æ‰¾åˆ°<code>main</code>å‡½æ•°çš„æ–¹æ³•:æ–¹æ³•å¾ˆå¤šï¼Œä¸ç»†è¯´äº†</p>
<p>å…·ä½“æ“ä½œæŒ‰ä¹¦ä¸Šæ¥</p>
<h3 id="chap7-scanf"><a class="markdownIt-Anchor" href="#chap7-scanf"></a> Chap7 scanf()</h3>
<p>æ¼”ç¤ºç¨‹åº</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> x<span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Enter X:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"You Entered: %d\n"</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="x86-2"><a class="markdownIt-Anchor" href="#x86-2"></a> x86</h4>
<p><code>cl /FAs /Z7 2 2.c</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_DATA	SEGMENT
<span class="token operator">$</span>SG9696	DB	<span class="token string">'Enter X:'</span>, <span class="token number">0aH</span>, <span class="token number">00H</span>
	ORG <span class="token operator">$</span><span class="token operator">+</span><span class="token number">2</span>
<span class="token operator">$</span>SG9697	DB	<span class="token string">'%d'</span>, <span class="token number">00H</span>
	ORG <span class="token operator">$</span><span class="token operator">+</span><span class="token number">1</span>
<span class="token operator">$</span>SG9698	DB	<span class="token string">'You Entered: %d'</span>, <span class="token number">0aH</span>, <span class="token number">00H</span>
_DATA	ENDS
_TEXT	SEGMENT
_x<span class="token operator">$</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">4</span>						<span class="token comment">; size = 4</span>
_main	PROC

<span class="token comment">; 3    : &#123;</span>

	push	<span class="token register variable">ebp</span>
	mov	<span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
	push	<span class="token register variable">ecx</span>

<span class="token comment">; 4    :     int x;</span>
<span class="token comment">; 5    :     printf("Enter X:\n");</span>

	push	OFFSET <span class="token operator">$</span>SG9696
	call	_printf
	add	<span class="token register variable">esp</span>, <span class="token number">4</span>

<span class="token comment">; 6    :     scanf("%d", &amp;x);</span>

	lea	<span class="token register variable">eax</span>, DWORD PTR _x<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
	push	<span class="token register variable">eax</span>
	push	OFFSET <span class="token operator">$</span>SG9697
	call	_scanf
	add	<span class="token register variable">esp</span>, <span class="token number">8</span>

<span class="token comment">; 7    : </span>
<span class="token comment">; 8    :     printf("You Entered: %d\n", x);</span>

	mov	<span class="token register variable">ecx</span>, DWORD PTR _x<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
	push	<span class="token register variable">ecx</span>
	push	OFFSET <span class="token operator">$</span>SG9698
	call	_printf
	add	<span class="token register variable">esp</span>, <span class="token number">8</span>

<span class="token comment">; 9    :     return 0;</span>

	xor	<span class="token register variable">eax</span>, <span class="token register variable">eax</span>

<span class="token comment">; 10   : &#125;</span>

	mov	<span class="token register variable">esp</span>, <span class="token register variable">ebp</span>
	pop	<span class="token register variable">ebp</span>
	ret	<span class="token number">0</span>
_main	ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ±‡ç¼–è§£è¯»:</p>
<ul>
<li>
<p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>scanf()</code>ä¼ é€’çš„ç¬¬äºŒä¸ªå‚æ•°(eax)æ˜¯ä¸€ä¸ªæŒ‡å‘æ ˆä¸­çš„æŒ‡é’ˆï¼Œxæ˜¯å±€éƒ¨å˜é‡ï¼Œå­˜å‚¨åœ¨æ ˆä¸­ã€‚åœ¨æ ˆä¸­åˆ†é…äº†4å­—èŠ‚ç©ºé—´ï¼Œå­˜å‚¨å±€éƒ¨å˜é‡x</p>
</li>
<li>
<p>**æ±‡ç¼–å®_x$ ï¼ˆå…¶å€¼ä¸ºâˆ’4ï¼‰**ç”¨äºè®¿é—®å±€éƒ¨å˜é‡<em>x</em>ï¼Œè€ŒEBPå¯„å­˜å™¨ç”¨æ¥å­˜å‚¨æ ˆå½“å‰å¸§çš„æŒ‡é’ˆã€‚</p>
<p>åœ¨å‡½æ•°è¿è¡Œçš„æœŸé—´ï¼ŒEBPä¸€ç›´æŒ‡å‘å½“å‰çš„æ ˆå¸§ï¼ˆstack frameï¼‰ã€‚è¿™æ ·ï¼Œå‡½æ•°å³å¯é€šè¿‡<strong>EBP+offsetçš„æ–¹å¼è®¿é—®æœ¬åœ°å˜é‡ã€ä»¥åŠå¤–éƒ¨ä¼ å…¥çš„å‡½æ•°å‚æ•°</strong>ã€‚</p>
<p>ESPä¹Ÿå¯ä»¥ç”¨æ¥è®¿é—®æœ¬åœ°å˜é‡ï¼Œè·å–å‡½æ•°æ‰€éœ€çš„è¿è¡Œå‚æ•°ã€‚ä¸è¿‡<strong>ESPçš„å€¼ç»å¸¸å‘ç”Ÿå˜åŒ–ï¼Œç”¨èµ·æ¥å¹¶ä¸æ–¹ä¾¿</strong>ã€‚å‡½æ•°åœ¨å¯åŠ¨ä¹‹åˆå°±ä¼šåˆ©ç”¨EBPå¯„å­˜å™¨ä¿å­˜ESPå¯„å­˜å™¨çš„å€¼ã€‚è¿™å°±æ˜¯ä¸ºäº†ç¡®ä¿åœ¨å‡½æ•°è¿è¡ŒæœŸé—´ä¿è¯EBPå¯„å­˜å™¨å­˜å‚¨çš„åŸå§‹ESPå€¼å›ºå®šä¸å˜ã€‚</p>
<p>åœ¨32ä½ç³»ç»Ÿé‡Œï¼Œå…¸å‹çš„æ ˆå¸§ï¼ˆstack frameï¼‰ç»“æ„å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p>
<table>
<thead>
<tr>
<th>â€¦â€¦</th>
<th>â€¦â€¦</th>
</tr>
</thead>
<tbody>
<tr>
<td>EBP-8</td>
<td>å±€éƒ¨å˜é‡ï¼ƒ2ï¼ŒIDAæ ‡è®°ä¸ºvar_8</td>
</tr>
<tr>
<td>EBP-4</td>
<td>å±€éƒ¨å˜é‡ï¼ƒ1ï¼ŒIDAæ ‡è®°ä¸ºvar_4</td>
</tr>
<tr>
<td>EBP</td>
<td>EBPçš„å€¼</td>
</tr>
<tr>
<td>EBP+4</td>
<td>è¿”å›åœ°å€Return address</td>
</tr>
<tr>
<td>EBP+8</td>
<td>å‡½æ•°å‚æ•°ï¼ƒ1ï¼ŒIDAæ ‡è®°ä¸ºarg_0</td>
</tr>
<tr>
<td>EBP+0xC</td>
<td>å‡½æ•°å‚æ•°ï¼ƒ2ï¼ŒIDAæ ‡è®°ä¸ºarg_4</td>
</tr>
<tr>
<td>EBP+0x10</td>
<td>å‡½æ•°å‚æ•°ï¼ƒ3ï¼ŒIDAæ ‡è®°ä¸ºarg_8</td>
</tr>
<tr>
<td>â€¦â€¦</td>
<td>â€¦â€¦</td>
</tr>
</tbody>
</table>
</li>
<li>
<p><code>scanf()</code>åœ¨æ­¤ä¾‹ä¸­æœ‰ä¸¤ä¸ªå‚æ•°,ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘å«æœ‰&quot;%d&quot;çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å±€éƒ¨å˜é‡<code>x</code>çš„åœ°å€</p>
<p>â€œlea eax, DWORD PTR _x$[ebp]â€æŒ‡ä»¤å°†å˜é‡<em>x</em>çš„åœ°å€æ”¾å…¥EAXå¯„å­˜å™¨ã€‚</p>
<p>åœ¨æ­¤å¤„<code>LEA</code>ä¼šå°†<code>EBP</code>å¯„å­˜å™¨å€¼ä¸å®_x$æ±‚å’Œ,ç„¶åå°†è¿™ä¸ªç»“æœå­˜å‚¨åˆ°<code>EAX</code>ï¼Œç„¶åæŠŠ<code>EAX</code>å¯„å­˜å™¨çš„å€¼é€å…¥æ ˆä¸­(å°±æ˜¯æŠŠxçš„åœ°å€é€å…¥EAXå¯„å­˜å™¨)</p>
</li>
<li>
<p>è€Œåè°ƒç”¨<code>printf()</code>å‡½æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°å³æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„æŒ‡é’ˆ</p>
<p>ç¬¬äºŒä¸ªå‚æ•°æ˜¯<code>mov ecx,[ebp-4]</code>é—´æ¥å–å€¼ï¼Œä¼ é€’ç»™ecxçš„å€¼æ˜¯<code>ebp-4</code>æŒ‡å‘çš„åœ°å€çš„å€¼ï¼Œå³å˜é‡xçš„å€¼</p>
</li>
</ul>
<hr />
<p>ç”¨<code>onlydbg</code>åŠ¨æ€è·Ÿè¸ªè¿™ä¸ªè¿‡ç¨‹ï¼Œå…·ä½“ä¹¦ä¸Šæœ‰</p>
<ul>
<li>è°ƒè¯•å¯ä»¥å‘ç°ï¼Œæ‰§è¡Œå®Œ<code>scanf()</code>å‡½æ•°,<code>EAX</code>å­˜å‚¨æœ‰å‡½æ•°çš„è¿”å›å€¼ï¼Œå…¶å€¼æ˜¯<code>scanf()</code>è¯»å–å‚æ•°çš„ä¸ªæ•°</li>
<li>æˆ‘ä»¬å¯ä»¥åœ¨æ ˆä¸­æ‰¾åˆ°å±€éƒ¨å˜é‡çš„åœ°å€ï¼Œè¿›è€Œè·Ÿè¸ªå…¶å€¼</li>
</ul>
<h4 id="å…¨å±€å˜é‡"><a class="markdownIt-Anchor" href="#å…¨å±€å˜é‡"></a> å…¨å±€å˜é‡</h4>
<p>å¦‚æœä¸Šæ–‡çš„<code>x</code>æ˜¯å…¨å±€å˜é‡,ä¼šæœ‰ä»€ä¹ˆæ ·çš„å˜åŒ–</p>
<p>å°†<code>x</code>æ”¹æˆå…¨å±€å˜é‡</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_DATA	SEGMENT
<span class="token operator">$</span>SG9696	DB	<span class="token string">'Enter X:'</span>, <span class="token number">0aH</span>, <span class="token number">00H</span>
	ORG <span class="token operator">$</span><span class="token operator">+</span><span class="token number">2</span>
<span class="token operator">$</span>SG9697	DB	<span class="token string">'%d'</span>, <span class="token number">00H</span>
	ORG <span class="token operator">$</span><span class="token operator">+</span><span class="token number">1</span>
<span class="token operator">$</span>SG9698	DB	<span class="token string">'You Entered: %d'</span>, <span class="token number">0aH</span>, <span class="token number">00H</span>
_DATA	ENDS
_TEXT	SEGMENT
_main	PROC

<span class="token comment">; 4    : &#123;</span>

	push	<span class="token register variable">ebp</span>
	mov	<span class="token register variable">ebp</span>, <span class="token register variable">esp</span>

<span class="token comment">; 5    :    </span>
<span class="token comment">; 6    :     printf("Enter X:\n");</span>

	push	OFFSET <span class="token operator">$</span>SG9696
	call	_printf
	add	<span class="token register variable">esp</span>, <span class="token number">4</span>

<span class="token comment">; 7    :     scanf("%d", &amp;x);</span>

	push	OFFSET _x
	push	OFFSET <span class="token operator">$</span>SG9697
	call	_scanf
	add	<span class="token register variable">esp</span>, <span class="token number">8</span>

<span class="token comment">; 8    : </span>
<span class="token comment">; 9    :     printf("You Entered: %d\n", x);</span>

	mov	<span class="token register variable">eax</span>, DWORD PTR _x
	push	<span class="token register variable">eax</span>
	push	OFFSET <span class="token operator">$</span>SG9698
	call	_printf
	add	<span class="token register variable">esp</span>, <span class="token number">8</span>

<span class="token comment">; 10   :     return 0;</span>

	xor	<span class="token register variable">eax</span>, <span class="token register variable">eax</span>

<span class="token comment">; 11   : &#125;</span>

	pop	<span class="token register variable">ebp</span>
	ret	<span class="token number">0</span>
_main	ENDP
_TEXT	ENDS<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p>å¯ä»¥å‘ç°<code>x</code>çš„å­˜å‚¨ç©ºé—´ä¸å†ç”±æ ˆä¸­å­˜å‚¨,è€Œæ˜¯åœ¨æ•°æ®æ®µ(ç”±äºæ²¡ç»™xèµ‹å€¼ï¼Œç¼–è¯‘å™¨è‡ªåŠ¨ä¼˜åŒ–ä¸ºbssæ®µ(ä¸å æ®ç©ºé—´))</p>
</li>
<li>
<p>å¦‚æœå¯¹ä¸Šè¿°æºä»£ç ç¨åšæ”¹åŠ¨ï¼ŒåŠ ä¸Šå˜é‡åˆå§‹åŒ–çš„æŒ‡ä»¤ï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">int x&#x3D;10; &#x2F;&#x2F;è®¾ç½®é»˜è®¤å€¼<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>é‚£ä¹ˆå¯¹åº”çš„ä»£ç ä¼šå˜ä¸ºï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">_DATA   SEGMENT
_x      DD      0aH
...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>ä¸Šè¿°æŒ‡ä»¤å°†åˆå§‹åŒ–xã€‚å…¶ä¸­DDä»£è¡¨DWORDï¼Œè¡¨ç¤º<em>x</em>æ˜¯32ä½çš„æ•°æ®ã€‚</p>
<p>è‹¥åœ¨IDAé‡Œæ‰“å¼€å¯¹xè¿›è¡Œåˆå§‹åŒ–çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæˆ‘ä»¬å°†ä¼šçœ‹åˆ°åœ¨æ•°æ®æ®µçš„å¼€å¤´éƒ¨åˆ†çœ‹åˆ°åˆå§‹åŒ–å˜é‡<em>x</em>ã€‚ç´§éšå…¶åçš„ç©ºé—´ç”¨äºå­˜å‚¨æœ¬ä¾‹ä¸­çš„å­—ç¬¦ä¸²ã€‚</p>
<p>ç”¨IDAæ‰“å¼€7.2èŠ‚é‡Œé‚£ä¸ªä¸åˆå§‹åŒ–å˜é‡<em>x</em>çš„ä¾‹å­ï¼Œé‚£ä¹ˆå°†ä¼šçœ‹</p>
<p>æœ‰å¾ˆå¤šå¸¦â€œï¼Ÿâ€æ ‡è®°çš„å˜é‡ï¼Œè¿™æ˜¯æœªåˆå§‹åŒ–çš„<em>x</em>å˜é‡çš„æ ‡è®°ã€‚è¿™æ„å‘³ç€åœ¨ç¨‹åºåŠ è½½åˆ°å†…å­˜ä¹‹åï¼Œæ“ä½œç³»ç»Ÿå°†ä¸ºè¿™äº›å˜é‡åˆ†é…ç©ºé—´ã€å¹¶å¡«å…¥æ•°å­—é›¶ã€‚ä½†æ˜¯åœ¨å¯æ‰§è¡Œæ–‡ä»¶é‡Œï¼Œè¿™äº›æœªåˆå§‹åŒ–çš„å˜é‡ä¸å ç”¨å†…å­˜ç©ºé—´ã€‚ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨å·¨å‹æ•°ç»„ä¹‹ç±»çš„å¤§å‹æ•°æ®ï¼Œäººä»¬åˆ»æ„åšäº†è¿™ç§è®¾å®šã€‚</p>
</li>
</ul>
<h4 id="problem"><a class="markdownIt-Anchor" href="#problem"></a> Problem</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">void</span> <span class="token function">alter_string</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>s<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        <span class="token function">strcpy</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"Goodbye!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"Result: %s\n"</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        <span class="token function">alter_string</span> <span class="token punctuation">(</span><span class="token string">"Hello, world!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨<code>win</code>å¯è¿è¡Œï¼Œå› ä¸ºsæ˜¯åœ¨dataæ®µ</p>
<p>è€Œåœ¨<code>linux</code>ä¸å¯è¿è¡Œï¼Œså­˜å‚¨åœ¨<code>rodata</code>æ®µï¼Œä¸å¯å†™</p>
<h3 id="chap8-å‚æ•°è·å–"><a class="markdownIt-Anchor" href="#chap8-å‚æ•°è·å–"></a> Chap8 å‚æ•°è·å–</h3>
<p>main()å‡½æ•°æŠŠ3ä¸ªæ•°å­—æ¨é€å…¥æ ˆï¼Œç„¶åè°ƒç”¨äº†f(int, int, int)ã€‚è¢«è°ƒç”¨æ–¹å‡½æ•°f()é€šè¿‡_a<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>=</mo><mn>8</mn><mtext>ä¸€ç±»çš„æ±‡ç¼–å®è®¿é—®æ‰€éœ€å‚æ•°ä»¥åŠå‡½æ•°è‡ªå®šä¹‰çš„å±€éƒ¨å˜é‡ã€‚åªä¸è¿‡ä»è¢«è°ƒç”¨æ–¹å‡½æ•°çš„æ•°æ®æ ˆçš„è§’åº¦æ¥çœ‹ï¼Œå¤–éƒ¨å‚è€ƒçš„åç§»é‡æ˜¯æ­£å€¼ï¼Œè€Œå±€éƒ¨å˜é‡çš„åç§»é‡æ˜¯è´Ÿå€¼ã€‚å¯è§ï¼Œå½“éœ€è¦è®¿é—®æ ˆå¸§ï¼ˆ</mtext><mi>s</mi><mi>t</mi><mi>a</mi><mi>c</mi><mi>k</mi><mi>f</mi><mi>r</mi><mi>a</mi><mi>m</mi><mi>e</mi><mtext>ï¼‰ä»¥å¤–çš„æ•°æ®æ—¶ï¼Œè¢«è°ƒç”¨æ–¹å‡½æ•°å¯æŠŠæ±‡ç¼–å®ï¼ˆä¾‹</mtext><msub><mtext>å¦‚</mtext><mi>a</mi></msub></mrow><annotation encoding="application/x-tex">=8ä¸€ç±»çš„æ±‡ç¼–å®è®¿é—®æ‰€éœ€å‚æ•°ä»¥åŠå‡½æ•°è‡ªå®šä¹‰çš„å±€éƒ¨å˜é‡ã€‚åªä¸è¿‡ä»è¢«è°ƒç”¨æ–¹å‡½æ•°çš„æ•°æ®æ ˆçš„è§’åº¦æ¥çœ‹ï¼Œå¤–éƒ¨å‚è€ƒçš„åç§»é‡æ˜¯æ­£å€¼ï¼Œè€Œå±€éƒ¨å˜é‡çš„åç§»é‡æ˜¯è´Ÿå€¼ã€‚å¯è§ï¼Œå½“éœ€è¦è®¿é—®æ ˆå¸§ï¼ˆstack frameï¼‰ä»¥å¤–çš„æ•°æ®æ—¶ï¼Œè¢«è°ƒç”¨æ–¹å‡½æ•°å¯æŠŠæ±‡ç¼–å®ï¼ˆä¾‹å¦‚_a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord">8</span><span class="mord cjk_fallback">ä¸€</span><span class="mord cjk_fallback">ç±»</span><span class="mord cjk_fallback">çš„</span><span class="mord cjk_fallback">æ±‡</span><span class="mord cjk_fallback">ç¼–</span><span class="mord cjk_fallback">å®</span><span class="mord cjk_fallback">è®¿</span><span class="mord cjk_fallback">é—®</span><span class="mord cjk_fallback">æ‰€</span><span class="mord cjk_fallback">éœ€</span><span class="mord cjk_fallback">å‚</span><span class="mord cjk_fallback">æ•°</span><span class="mord cjk_fallback">ä»¥</span><span class="mord cjk_fallback">åŠ</span><span class="mord cjk_fallback">å‡½</span><span class="mord cjk_fallback">æ•°</span><span class="mord cjk_fallback">è‡ª</span><span class="mord cjk_fallback">å®š</span><span class="mord cjk_fallback">ä¹‰</span><span class="mord cjk_fallback">çš„</span><span class="mord cjk_fallback">å±€</span><span class="mord cjk_fallback">éƒ¨</span><span class="mord cjk_fallback">å˜</span><span class="mord cjk_fallback">é‡</span><span class="mord cjk_fallback">ã€‚</span><span class="mord cjk_fallback">åª</span><span class="mord cjk_fallback">ä¸</span><span class="mord cjk_fallback">è¿‡</span><span class="mord cjk_fallback">ä»</span><span class="mord cjk_fallback">è¢«</span><span class="mord cjk_fallback">è°ƒ</span><span class="mord cjk_fallback">ç”¨</span><span class="mord cjk_fallback">æ–¹</span><span class="mord cjk_fallback">å‡½</span><span class="mord cjk_fallback">æ•°</span><span class="mord cjk_fallback">çš„</span><span class="mord cjk_fallback">æ•°</span><span class="mord cjk_fallback">æ®</span><span class="mord cjk_fallback">æ ˆ</span><span class="mord cjk_fallback">çš„</span><span class="mord cjk_fallback">è§’</span><span class="mord cjk_fallback">åº¦</span><span class="mord cjk_fallback">æ¥</span><span class="mord cjk_fallback">çœ‹</span><span class="mord cjk_fallback">ï¼Œ</span><span class="mord cjk_fallback">å¤–</span><span class="mord cjk_fallback">éƒ¨</span><span class="mord cjk_fallback">å‚</span><span class="mord cjk_fallback">è€ƒ</span><span class="mord cjk_fallback">çš„</span><span class="mord cjk_fallback">å</span><span class="mord cjk_fallback">ç§»</span><span class="mord cjk_fallback">é‡</span><span class="mord cjk_fallback">æ˜¯</span><span class="mord cjk_fallback">æ­£</span><span class="mord cjk_fallback">å€¼</span><span class="mord cjk_fallback">ï¼Œ</span><span class="mord cjk_fallback">è€Œ</span><span class="mord cjk_fallback">å±€</span><span class="mord cjk_fallback">éƒ¨</span><span class="mord cjk_fallback">å˜</span><span class="mord cjk_fallback">é‡</span><span class="mord cjk_fallback">çš„</span><span class="mord cjk_fallback">å</span><span class="mord cjk_fallback">ç§»</span><span class="mord cjk_fallback">é‡</span><span class="mord cjk_fallback">æ˜¯</span><span class="mord cjk_fallback">è´Ÿ</span><span class="mord cjk_fallback">å€¼</span><span class="mord cjk_fallback">ã€‚</span><span class="mord cjk_fallback">å¯</span><span class="mord cjk_fallback">è§</span><span class="mord cjk_fallback">ï¼Œ</span><span class="mord cjk_fallback">å½“</span><span class="mord cjk_fallback">éœ€</span><span class="mord cjk_fallback">è¦</span><span class="mord cjk_fallback">è®¿</span><span class="mord cjk_fallback">é—®</span><span class="mord cjk_fallback">æ ˆ</span><span class="mord cjk_fallback">å¸§</span><span class="mord cjk_fallback">ï¼ˆ</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">a</span><span class="mord mathnormal">m</span><span class="mord mathnormal">e</span><span class="mord cjk_fallback">ï¼‰</span><span class="mord cjk_fallback">ä»¥</span><span class="mord cjk_fallback">å¤–</span><span class="mord cjk_fallback">çš„</span><span class="mord cjk_fallback">æ•°</span><span class="mord cjk_fallback">æ®</span><span class="mord cjk_fallback">æ—¶</span><span class="mord cjk_fallback">ï¼Œ</span><span class="mord cjk_fallback">è¢«</span><span class="mord cjk_fallback">è°ƒ</span><span class="mord cjk_fallback">ç”¨</span><span class="mord cjk_fallback">æ–¹</span><span class="mord cjk_fallback">å‡½</span><span class="mord cjk_fallback">æ•°</span><span class="mord cjk_fallback">å¯</span><span class="mord cjk_fallback">æŠŠ</span><span class="mord cjk_fallback">æ±‡</span><span class="mord cjk_fallback">ç¼–</span><span class="mord cjk_fallback">å®</span><span class="mord cjk_fallback">ï¼ˆ</span><span class="mord cjk_fallback">ä¾‹</span><span class="mord"><span class="mord cjk_fallback">å¦‚</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>ï¼‰ä¸EBPå¯„å­˜å™¨çš„å€¼ç›¸åŠ ï¼Œä»è€Œæ±‚å¾—æ‰€éœ€åœ°å€ã€‚</p>
<p>å½“å˜é‡<em>a</em>çš„å€¼å­˜å…¥EAXå¯„å­˜å™¨ä¹‹åï¼Œf()å‡½æ•°é€šè¿‡å„å‚æ•°çš„åœ°å€ä¾æ¬¡è¿›è¡Œä¹˜æ³•å’ŒåŠ æ³•è¿ç®—ï¼Œè¿ç®—ç»“æœä¸€ç›´å­˜å‚¨äºEAXå¯„å­˜å™¨ã€‚æ­¤åEAXçš„å€¼å°±å¯ä»¥ç›´æ¥ä½œä¸ºè¿”å›å€¼ä¼ é€’ç»™è°ƒç”¨æ–¹å‡½æ•°ã€‚è°ƒç”¨æ–¹å‡½æ•°main()å†æŠŠEAXçš„å€¼å½“ä½œå‚æ•°ä¼ é€’ç»™printf()å‡½æ•°ã€‚</p>
<h3 id="chap9-è¿”å›å€¼"><a class="markdownIt-Anchor" href="#chap9-è¿”å›å€¼"></a> Chap9 è¿”å›å€¼</h3>
<p>åœ¨<strong>x86ç³»</strong>ç»Ÿé‡Œï¼Œè¢«è°ƒç”¨æ–¹å‡½æ•°é€šå¸¸é€šè¿‡EA<strong>Xå¯„å­˜å™¨è¿”å›è¿ç®—ç»“æœ</strong>ã€‚è‹¥è¿”å›å€¼å±äºbyteæˆ–charç±»å‹æ•°æ®ï¼Œè¿”å›å€¼å°†<strong>å­˜å‚¨äºEAXå¯„å­˜å™¨çš„ä½8ä½â€”â€”ALå¯„å­˜å™¨å­˜å‚¨è¿”å›å€¼</strong>ã€‚å¦‚æœ<strong>è¿”å›å€¼æ˜¯æµ®ç‚¹floatå‹æ•°æ®ï¼Œé‚£ä¹ˆè¿”å›å€¼å°†å­˜å‚¨åœ¨FPUçš„ST(0)å¯„å­˜å™¨</strong>é‡Œã€‚ARMç³»ç»Ÿçš„æƒ…å†µç›¸å¯¹ç®€å•ä¸€äº›ï¼Œå®ƒé€šå¸¸ä½¿ç”¨R0å¯„å­˜å™¨å›ä¼ è¿”å›å€¼ã€‚</p>
<h4 id="voidç±»å‹çš„è¿”å›å€¼"><a class="markdownIt-Anchor" href="#voidç±»å‹çš„è¿”å›å€¼"></a> voidç±»å‹çš„è¿”å›å€¼</h4>
<p>è°ƒç”¨<code>main</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">push envp
push argv
push argc
call main
push <span class="token register variable">eax</span>
call exit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¹Ÿå°±æ˜¯<code>exit(main(argc,argv,envp));</code></p>
<p>å¦‚æœå£°æ˜main()çš„æ•°æ®ç±»å‹æ˜¯voidï¼Œåˆ™main()å‡½æ•°ä¸ä¼šæ˜ç¡®è¿”å›ä»»ä½•å€¼ï¼ˆæ²¡æœ‰returnæŒ‡ä»¤ï¼‰ã€‚ä¸è¿‡åœ¨main()å‡½æ•°é€€å‡ºæ—¶ï¼ŒEAXå¯„å­˜å™¨è¿˜ä¼šå­˜æœ‰æ•°æ®ï¼ŒEAXå¯„å­˜å™¨ä¿å­˜çš„æ•°æ®ä¼šè¢«ä¼ é€’ç»™exit()å‡½æ•°ã€æˆä¸ºåè€…çš„è¾“å…¥å‚æ•°ã€‚é€šå¸¸EAXå¯„å­˜å™¨çš„å€¼ä¼šæ˜¯è¢«è°ƒç”¨æ–¹å‡½æ•°æ®‹ç•™çš„ç¡®å®šæ•°æ®ï¼Œæ‰€ä»¥voidç±»å‹å‡½æ•°çš„è¿”å›å€¼ã€ä¹Ÿå°±æ˜¯ä¸»å‡½æ•°é€€å‡ºä»£ç å¾€å¾€å±äºä¼ªéšæœºæ•°ï¼ˆpseudorandomï¼‰</p>
<h4 id="è¿”å›å€¼ä¸ºç»“æ„ä½“å‹æ•°æ®"><a class="markdownIt-Anchor" href="#è¿”å›å€¼ä¸ºç»“æ„ä½“å‹æ•°æ®"></a> è¿”å›å€¼ä¸ºç»“æ„ä½“å‹æ•°æ®</h4>
<p>è°ƒç”¨æ–¹å‡½æ•°ï¼ˆcallerï¼‰åˆ›å»ºäº†æ•°æ®ç»“æ„ã€åˆ†é…äº†æ•°æ®ç©ºé—´ï¼Œè¢«è°ƒç”¨çš„å‡½æ•°ä»…å‘ç»“æ„ä½“å¡«å……æ•°æ®ã€‚å…¶æ•ˆæœç­‰åŒäºè¿”å›ç»“æ„ä½“ã€‚</p>
<h3 id="chap10-æŒ‡é’ˆ"><a class="markdownIt-Anchor" href="#chap10-æŒ‡é’ˆ"></a> Chap10 æŒ‡é’ˆ</h3>
<p>æŒ‡é’ˆé€šå¸¸ç”¨æ¥å¸®åŠ©å‡½æ•°å¤„ç†è¿”å›å€¼ã€‚å½“å‡½æ•°éœ€è¦è¿”å›å¤šä¸ªå€¼æ—¶ï¼Œå®ƒé€šå¸¸éƒ½æ˜¯é€šè¿‡æŒ‡é’ˆä¼ é€’è¿”å›å€¼çš„ã€‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">void</span> <span class="token function">f1</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>sum<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>product<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
         <span class="token operator">*</span>sum<span class="token operator">=</span>x<span class="token operator">+</span>y<span class="token punctuation">;</span>
         <span class="token operator">*</span>product<span class="token operator">=</span>x<span class="token operator">*</span>y<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> sum<span class="token punctuation">,</span> product<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
         <span class="token function">f1</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">,</span> <span class="token number">456</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sum<span class="token punctuation">,</span> <span class="token operator">&amp;</span>product<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"sum=%d, product=%d\n"</span><span class="token punctuation">,</span> sum<span class="token punctuation">,</span> product<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">COMM     _product:DWORD
COMM     _sum:DWORD
<span class="token comment">; å®šä¹‰å­—ç¬¦ä¸²å¸¸é‡ $SG2803ï¼Œè¡¨ç¤ºæ ¼å¼åŒ–è¾“å‡ºçš„å­—ç¬¦ä¸² "sum=%d, product=%d\n"</span>
<span class="token operator">$</span>SG2803 DB     <span class="token string">'sum=%d, product=%d'</span>, <span class="token number">0aH</span>, <span class="token number">00H</span>
<span class="token comment">; å®šä¹‰å‚æ•°åœ¨æ ˆå¸§ä¸­çš„åç§»é‡</span>
_x<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>             <span class="token comment">; å‚æ•° _x åœ¨æ ˆå¸§ä¸­çš„åç§»é‡ï¼Œå¤§å°ä¸º 4 å­—èŠ‚</span>
_y<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">12</span>            <span class="token comment">; å‚æ•° _y åœ¨æ ˆå¸§ä¸­çš„åç§»é‡ï¼Œå¤§å°ä¸º 4 å­—èŠ‚</span>
_sum<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">16</span>          <span class="token comment">; _sum åœ¨æ ˆå¸§ä¸­çš„åç§»é‡ï¼Œå¤§å°ä¸º 4 å­—èŠ‚</span>
_product<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">20</span>      <span class="token comment">; _product åœ¨æ ˆå¸§ä¸­çš„åç§»é‡ï¼Œå¤§å°ä¸º 4 å­—èŠ‚</span>
<span class="token comment">; å®šä¹‰ _f1 å‡½æ•°</span>
_f1   PROC
      <span class="token comment">; å°†å‚æ•° _y çš„å€¼åŠ è½½åˆ° ecx å¯„å­˜å™¨</span>
      mov  <span class="token register variable">ecx</span>, DWORD PTR _y<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
      <span class="token comment">; å°†å‚æ•° _x çš„å€¼åŠ è½½åˆ° eax å¯„å­˜å™¨</span>
      mov  <span class="token register variable">eax</span>, DWORD PTR _x<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
      <span class="token comment">; è®¡ç®— _x å’Œ _y çš„å’Œï¼Œç»“æœå­˜å‚¨åˆ° edx å¯„å­˜å™¨</span>
      lea  <span class="token register variable">edx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token register variable">ecx</span><span class="token operator">]</span>
      <span class="token comment">; è®¡ç®— _x å’Œ _y çš„ä¹˜ç§¯ï¼Œç»“æœå­˜å‚¨åˆ° eax å¯„å­˜å™¨</span>
      imul <span class="token register variable">eax</span>, <span class="token register variable">ecx</span><span class="token comment">;eax=eax*ecx</span>
      <span class="token comment">; å°† _product çš„åœ°å€åŠ è½½åˆ° ecx å¯„å­˜å™¨</span>
      mov  <span class="token register variable">ecx</span>, DWORD PTR _product<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
      <span class="token comment">; ä¿å­˜ esi å¯„å­˜å™¨çš„å€¼ï¼Œä¸ºåç»­æ“ä½œåšå‡†å¤‡</span>
      push <span class="token register variable">esi</span>
      <span class="token comment">; å°† _sum çš„åœ°å€åŠ è½½åˆ° esi å¯„å­˜å™¨</span>
      mov  <span class="token register variable">esi</span>, DWORD PTR _sum<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">]</span>
      <span class="token comment">; å°†å’Œçš„ç»“æœå­˜å‚¨åˆ° _sum æŒ‡å‘çš„ä½ç½®</span>
      mov  DWORD PTR <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">]</span>, <span class="token register variable">edx</span>
      <span class="token comment">; å°†ç§¯çš„ç»“æœå­˜å‚¨åˆ° _product æŒ‡å‘çš„ä½ç½®</span>
      mov  DWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">]</span>, <span class="token register variable">eax</span>
      <span class="token comment">; æ¢å¤ esi å¯„å­˜å™¨çš„å€¼</span>
      pop  <span class="token register variable">esi</span>
      <span class="token comment">; è¿”å›åˆ°è°ƒç”¨è€…</span>
      ret  <span class="token number">0</span>
_f1   ENDP

<span class="token comment">; å®šä¹‰ _main å‡½æ•°</span>
_main PROC
      <span class="token comment">; å°† _product çš„åœ°å€å‹å…¥æ ˆä¸­</span>
      push OFFSET _product
      <span class="token comment">; å°† _sum çš„åœ°å€å‹å…¥æ ˆä¸­</span>
      push OFFSET _sum
      <span class="token comment">; å°†å‚æ•° 456 å‹å…¥æ ˆä¸­</span>
      push <span class="token number">456</span>          <span class="token comment">; 456 çš„åå…­è¿›åˆ¶è¡¨ç¤ºä¸º 0x1c8</span>
      <span class="token comment">; å°†å‚æ•° 123 å‹å…¥æ ˆä¸­</span>
      push <span class="token number">123</span>          <span class="token comment">; 123 çš„åå…­è¿›åˆ¶è¡¨ç¤ºä¸º 0x7b</span>
      <span class="token comment">; è°ƒç”¨ _f1 å‡½æ•°</span>
      call _f1
      <span class="token comment">; å°† _product çš„å€¼åŠ è½½åˆ° eax å¯„å­˜å™¨</span>
      mov  <span class="token register variable">eax</span>, DWORD PTR _product
      <span class="token comment">; å°† _sum çš„å€¼åŠ è½½åˆ° ecx å¯„å­˜å™¨</span>
      mov  <span class="token register variable">ecx</span>, DWORD PTR _sum
      <span class="token comment">; å°† _product å’Œ _sum çš„å€¼ä½œä¸ºå‚æ•°ï¼Œè°ƒç”¨ printf å‡½æ•°</span>
      push <span class="token register variable">eax</span>
      push <span class="token register variable">ecx</span>
      push OFFSET <span class="token operator">$</span>SG2803
      call DWORD PTR __imp__printf
      <span class="token comment">; è°ƒæ•´æ ˆæŒ‡é’ˆï¼Œæ¸…ç†å‚æ•°</span>
      add  <span class="token register variable">esp</span>, <span class="token number">28</span>    
      xor  <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
      <span class="token comment">; è¿”å›åˆ°è°ƒç”¨è€…</span>
      ret  <span class="token number">0</span>
_main ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="chap12-æ¡ä»¶è½¬ç§»"><a class="markdownIt-Anchor" href="#chap12-æ¡ä»¶è½¬ç§»"></a> Chap12 æ¡ä»¶è½¬ç§»</h3>
<h4 id="æ•°å€¼æ¯”è¾ƒ"><a class="markdownIt-Anchor" href="#æ•°å€¼æ¯”è¾ƒ"></a> æ•°å€¼æ¯”è¾ƒ</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">void</span> <span class="token function">f_signed</span> <span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token operator">></span>b<span class="token punctuation">)</span>
          <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"a>b\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token operator">==</span>b<span class="token punctuation">)</span>
          <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"a==b\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token operator">&lt;</span>b<span class="token punctuation">)</span>
          <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"a&lt;b\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">f_unsigned</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token operator">></span>b<span class="token punctuation">)</span>
          <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"a>b\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token operator">==</span>b<span class="token punctuation">)</span>
          <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"a==b\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token operator">&lt;</span>b<span class="token punctuation">)</span>
          <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"a&lt;b\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span>
    <span class="token function">f_signed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">f_unsigned</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_a<span class="token operator">$</span> <span class="token operator">=</span>  <span class="token number">8</span>  <span class="token comment">; size  = 4 </span>
_b<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">12</span>  <span class="token comment">; size  = 4 </span>
_f_unsigned PROC
    push   <span class="token register variable">ebp</span>
    mov    <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
    mov    <span class="token register variable">eax</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
    cmp    <span class="token register variable">eax</span>, DWORD PTR _b<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
    jbe    SHORT <span class="token operator">$</span>LN3@f_unsigned
    push   OFFSET <span class="token operator">$</span>SG2761    <span class="token comment">; 'a>b'</span>
    call   _printf
    add    <span class="token register variable">esp</span>, <span class="token number">4</span>
<span class="token label function">$LN3@f_unsigned:</span>
    mov    <span class="token register variable">ecx</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
    cmp    <span class="token register variable">ecx</span>, DWORD PTR _b<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
    jne    SHORT <span class="token operator">$</span>LN2@f_unsigned
    push   OFFSET <span class="token operator">$</span>SG2763    <span class="token comment">; 'a==b'</span>
    call   _printf
    add    <span class="token register variable">esp</span>, <span class="token number">4</span>
<span class="token label function">$LN2@f_unsigned:</span>
    mov    <span class="token register variable">edx</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
    cmp    <span class="token register variable">edx</span>, DWORD PTR _b<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
    jae    SHORT <span class="token operator">$</span>LN4@f_unsigned
    push   OFFSET <span class="token operator">$</span>SG2765    <span class="token comment">; 'a&lt;b'</span>
    call   _printf
    add    <span class="token register variable">esp</span>, <span class="token number">4</span>
<span class="token label function">LN4@f_unsigned:</span>
    Pop   <span class="token register variable">ebp</span>
    Ret   <span class="token number">0</span>
_f_unsigned ENDP
_main   PROC
        push    <span class="token register variable">ebp</span>
        mov     <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
        push    <span class="token number">2</span>
        push    <span class="token number">1</span>
        call    _f_signed
        add     <span class="token register variable">esp</span>, <span class="token number">8</span>
        push    <span class="token number">2</span>
        push    <span class="token number">1</span>
        call    _f_unsigned
        add     <span class="token register variable">esp</span>, <span class="token number">8</span>
        xor     <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
        pop     <span class="token register variable">ebp</span>
        ret     <span class="token number">0</span>
_main   ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>JLEï¼Œå³â€œJump if Less or Equalâ€ã€‚å¦‚æœä¸Šä¸€æ¡CMPæŒ‡ä»¤çš„ç¬¬ä¸€ä¸ªæ“ä½œè¡¨è¾¾å¼å°äºæˆ–ç­‰äºï¼ˆä¸å¤§äºï¼‰ç¬¬äºŒä¸ªè¡¨è¾¾å¼ï¼ŒJLEå°†è·³è½¬åˆ°æŒ‡ä»¤æ‰€æ ‡æ˜çš„åœ°å€ï¼›å¦‚æœä¸æ»¡è¶³ä¸Šè¿°æ¡ä»¶ï¼Œåˆ™è¿è¡Œä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œå°±æœ¬ä¾‹è€Œè¨€ç¨‹åºå°†ä¼šè°ƒç”¨printf()å‡½æ•°ã€‚ç¬¬äºŒä¸ªæ¡ä»¶è½¬ç§»æŒ‡ä»¤æ˜¯JNEï¼Œâ€œJump if Not Equalâ€ï¼Œå¦‚æœä¸Šä¸€æ¡CMPçš„ä¸¤ä¸ªæ“ä½œç¬¦ä¸ç›¸ç­‰ï¼Œåˆ™è¿›è¡Œç›¸åº”è·³è½¬ã€‚</li>
<li>JGEï¼Œå³â€œJump if Greater or Equalâ€ã€‚å¦‚æœCMPçš„ç¬¬ä¸€ä¸ªè¡¨è¾¾å¼å¤§äºæˆ–ç­‰äºç¬¬äºŒä¸ªè¡¨è¾¾å¼ï¼ˆä¸å°äºï¼‰ï¼Œåˆ™è¿›è¡Œè·³è½¬ã€‚è¿™æ®µç¨‹åºé‡Œï¼Œå¦‚æœä¸‰ä¸ªè·³è½¬çš„åˆ¤æ–­æ¡ä»¶éƒ½ä¸æ»¡è¶³ï¼Œå°†ä¸ä¼šè°ƒç”¨printf()å‡½æ•°ï¼›ä¸è¿‡ï¼Œé™¤éè¿›è¡Œç‰¹æ®Šå¹²é¢„ï¼Œå¦åˆ™è¿™ç§æƒ…å†µåº”è¯¥ä¸ä¼šå‘ç”Ÿ</li>
<li>ç»GCCç¼–è¯‘åï¼Œf_unsigned()å‡½æ•°ä½¿ç”¨çš„æ¡ä»¶è½¬ç§»æŒ‡ä»¤æ˜¯JBEï¼ˆJump if Below or Equalï¼Œç›¸å½“äºJLEï¼‰å’ŒJAEï¼ˆJump if Above or Equalï¼Œç›¸å½“äºJGEï¼‰ã€‚==JA/JAE/JB/JBEä¸JG/JGE/JL/JLEçš„åŒºåˆ«ï¼Œåœ¨äºå®ƒä»¬æ£€æŸ¥çš„æ ‡å¿—ä½ä¸åŒï¼šå‰è€…æ£€æŸ¥å€Ÿ/è¿›ä½æ ‡å¿—ä½CFï¼ˆ1æ„å‘³ç€å°äºï¼‰å’Œé›¶æ ‡å¿—ä½ZFï¼ˆ1æ„å‘³ç€ç›¸ç­‰ï¼‰ï¼Œåè€…æ£€æŸ¥â€œSF XOR OFâ€ï¼ˆ1æ„å‘³ç€å¼‚å·ï¼‰å’ŒZFã€‚==ä»æŒ‡ä»¤å‚æ•°çš„è§’åº¦çœ‹ï¼Œ<mark>å‰è€…é€‚ç”¨äºunsignedï¼ˆæ— ç¬¦å·ï¼‰ç±»å‹æ•°æ®çš„ï¼ˆCMPï¼‰è¿ç®—ï¼Œè€Œåè€…çš„é€‚ç”¨äºsignedï¼ˆæœ‰ç¬¦å·ï¼‰ç±»å‹æ•°æ®çš„è¿ç®—ã€‚</mark></li>
</ul>
<h4 id="è®¡ç®—ç»å¯¹å€¼"><a class="markdownIt-Anchor" href="#è®¡ç®—ç»å¯¹å€¼"></a> è®¡ç®—ç»å¯¹å€¼</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">my_abs</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
                 <span class="token keyword">return</span> <span class="token operator">-</span>i<span class="token punctuation">;</span>
         <span class="token keyword">else</span>
                 <span class="token keyword">return</span> i<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">i<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>

my_abs   PROC
<span class="token comment">; ECX = è¾“å…¥å€¼</span>
         test    <span class="token register variable">ecx</span>, <span class="token register variable">ecx</span>          <span class="token comment">; æ‰§è¡Œ ECX å’Œè‡ªèº«çš„æŒ‰ä½ä¸æ“ä½œä»¥è®¾ç½®æ ‡å¿—</span>
<span class="token comment">; æ£€æŸ¥è¾“å…¥å€¼çš„ç¬¦å·</span>
<span class="token comment">; å¦‚æœç¬¦å·ä¸ºæ­£åˆ™è·³è¿‡ NEG æŒ‡ä»¤</span>
         jns     SHORT <span class="token operator">$</span>LN2@my_abs <span class="token comment">; å¦‚æœ ECX ä¸ºéè´Ÿæ•°ï¼Œåˆ™è·³è½¬åˆ° $LN2@my_abs</span>
<span class="token comment">; å–åå€¼</span>
         neg     <span class="token register variable">ecx</span>               <span class="token comment">; å¦‚æœ ECX ä¸ºè´Ÿæ•°ï¼Œå–å ECX (ECX = -ECX)</span>
<span class="token label function">$LN2@my_abs:</span>
<span class="token comment">; å°†ç»“æœå‡†å¤‡åˆ° EAX:</span>
       mov    <span class="token register variable">eax</span>,   <span class="token register variable">ecx</span>    <span class="token comment">; å°† ECX çš„å€¼å¤åˆ¶åˆ° EAX</span>
        ret     <span class="token number">0</span>                   <span class="token comment">; ä»è¿‡ç¨‹è¿”å›ï¼ˆä¸æ¸…é™¤ä»»ä½•å‚æ•°ï¼‰</span>
my_abs  ENDP                        <span class="token comment">; è¿‡ç¨‹ my_abs çš„ç»“æŸ</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>neg</code> æŒ‡ä»¤ç”¨äºå°†å¯„å­˜å™¨æˆ–å†…å­˜ä½ç½®ä¸­çš„æ“ä½œæ•°å–åã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒå°†<mark>æ“ä½œæ•°å˜ä¸ºå®ƒçš„ç›¸åæ•°ï¼ˆå³å–è´Ÿå€¼ï¼‰</mark>ã€‚<code>neg</code> æŒ‡ä»¤å®é™…ä¸Šæ˜¯è®¡ç®—äºŒè¡¥æ•°ã€‚</p>
<p>ä»¥ä¸‹æ˜¯ <code>neg</code> æŒ‡ä»¤çš„è¯¦ç»†è§£é‡Šï¼š</p>
<ul>
<li>å¦‚æœæ“ä½œæ•°æ˜¯æ­£æ•°ï¼Œ<code>neg</code> ä¼šå°†å…¶å˜ä¸ºè´Ÿæ•°ã€‚</li>
<li>å¦‚æœæ“ä½œæ•°æ˜¯è´Ÿæ•°ï¼Œ<code>neg</code> ä¼šå°†å…¶å˜ä¸ºæ­£æ•°ã€‚</li>
<li>å¦‚æœæ“ä½œæ•°æ˜¯é›¶ï¼Œ<code>neg</code> ä¼šä¿æŒå…¶ä¸ºé›¶ã€‚</li>
</ul>
<p>åœ¨å¤„ç†è¿‡ç¨‹ä¸­ï¼Œ<code>neg</code> æŒ‡ä»¤ä¼šå½±å“æ ‡å¿—å¯„å­˜å™¨ï¼ˆFlags Registerï¼‰ä¸­çš„ä»¥ä¸‹æ ‡å¿—ï¼š</p>
<ul>
<li><strong>CFï¼ˆè¿›ä½æ ‡å¿—ï¼‰</strong>ï¼šå¦‚æœç»“æœä¸ºéé›¶ï¼Œåˆ™è®¾ç½® CFã€‚</li>
<li><strong>ZFï¼ˆé›¶æ ‡å¿—ï¼‰</strong>ï¼šå¦‚æœç»“æœä¸ºé›¶ï¼Œåˆ™è®¾ç½® ZFã€‚</li>
<li><strong>SFï¼ˆç¬¦å·æ ‡å¿—ï¼‰</strong>ï¼šæ ¹æ®ç»“æœçš„æœ€é«˜ä½è®¾ç½® SFã€‚</li>
<li><strong>OFï¼ˆæº¢å‡ºæ ‡å¿—ï¼‰</strong>ï¼šå¦‚æœæ“ä½œæ•°æ˜¯æœ€å°çš„è´Ÿæ•°ï¼Œåˆ™è®¾ç½® OFï¼ˆä¾‹å¦‚ï¼Œå¯¹äº32ä½æ•´æ•°ï¼Œ-2^31 å˜ä¸º 2^31-1 ä¼šå¯¼è‡´æº¢å‡ºï¼‰ã€‚</li>
</ul>
<p>å‡è®¾ <code>ECX</code> å¯„å­˜å™¨åŒ…å«å€¼ <code>5</code> æˆ– <code>-5</code>ï¼Œåœ¨æ‰§è¡Œ <code>neg</code> æŒ‡ä»¤åçš„å˜åŒ–å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">mov ecx, 5     ; ECX &#x3D; 5
neg ecx        ; ECX &#x3D; -5

mov ecx, -5    ; ECX &#x3D; -5
neg ecx        ; ECX &#x3D; 5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="æ¡ä»¶è¿ç®—ç¬¦"><a class="markdownIt-Anchor" href="#æ¡ä»¶è¿ç®—ç¬¦"></a> æ¡ä»¶è¿ç®—ç¬¦</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">f</span> <span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> a<span class="token operator">==</span><span class="token number">10</span> <span class="token operator">?</span> <span class="token string">"it is ten"</span> <span class="token operator">:</span> <span class="token string">"it is not ten"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p>åœ¨ç¼–è¯‘å«æœ‰æ¡ä»¶è¿ç®—ç¬¦çš„è¯­å¥æ—¶ï¼Œæ—©æœŸæ— ä¼˜åŒ–åŠŸèƒ½çš„ç¼–è¯‘å™¨ä¼šä»¥ç¼–è¯‘â€œif/elseâ€è¯­å¥çš„æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token operator">$</span>SG746   DB       <span class="token string">'it is ten'</span>, <span class="token number">00H</span>         <span class="token comment">; å®šä¹‰å­—ç¬¦ä¸² "it is ten" å¹¶ä»¥ç©ºå­—ç¬¦ç»“å°¾</span>
<span class="token operator">$</span>SG747   DB       <span class="token string">'it is not ten'</span>, <span class="token number">00H</span>     <span class="token comment">; å®šä¹‰å­—ç¬¦ä¸² "it is not ten" å¹¶ä»¥ç©ºå­—ç¬¦ç»“å°¾</span>

tv65 <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">4</span> <span class="token comment">; è¿™æ˜¯ä¸€ä¸ªä¸´æ—¶å˜é‡ï¼Œå­˜å‚¨åœ¨æ ˆå¸§ä¸­çš„åç§»é‡ä¸º -4</span>
_a<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>   <span class="token comment">; è¾“å…¥å€¼åœ¨æ ˆå¸§ä¸­çš„åç§»é‡ä¸º 8</span>

_f       PROC
         push     <span class="token register variable">ebp</span>                      <span class="token comment">; ä¿å­˜åŸºæŒ‡é’ˆ EBP</span>
         mov      <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>                 <span class="token comment">; è®¾ç½®æ–°çš„æ ˆå¸§</span>
         push     <span class="token register variable">ecx</span>                      <span class="token comment">; ä¿å­˜ ECX å¯„å­˜å™¨çš„å€¼</span>
<span class="token comment">; æ¯”è¾ƒè¾“å…¥å€¼æ˜¯å¦ä¸º10</span>
         cmp      DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token number">10</span>   <span class="token comment">; æ¯”è¾ƒä½äºæ ˆå¸§åç§» _a$ å¤„çš„å€¼æ˜¯å¦ä¸º10</span>
<span class="token comment">; å¦‚æœä¸ç­‰äº10ï¼Œåˆ™è·³è½¬åˆ° $LN3@f</span>
         jne      SHORT <span class="token operator">$</span>LN3@f             <span class="token comment">; å¦‚æœä¸ç­‰äº10ï¼Œè·³è½¬åˆ° $LN3@f</span>
<span class="token comment">; å°†æŒ‡å‘å­—ç¬¦ä¸² 'it is ten' çš„æŒ‡é’ˆå­˜å‚¨åˆ°ä¸´æ—¶å˜é‡ä¸­</span>
         mov      DWORD PTR tv65<span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, OFFSET <span class="token operator">$</span>SG746 <span class="token comment">; å°†å­—ç¬¦ä¸² "it is ten" çš„åœ°å€å­˜å‚¨åˆ° tv65 å˜é‡ä¸­</span>
<span class="token comment">; è·³è½¬åˆ°é€€å‡ºæ ‡ç­¾</span>
         jmp      SHORT <span class="token operator">$</span>LN4@f             <span class="token comment">; è·³è½¬åˆ° $LN4@f</span>
<span class="token label function">$LN3@f:</span>
<span class="token comment">; å°†æŒ‡å‘å­—ç¬¦ä¸² 'it is not ten' çš„æŒ‡é’ˆå­˜å‚¨åˆ°ä¸´æ—¶å˜é‡ä¸­</span>
         mov      DWORD PTR tv65<span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, OFFSET <span class="token operator">$</span>SG747 <span class="token comment">; å°†å­—ç¬¦ä¸² "it is not ten" çš„åœ°å€å­˜å‚¨åˆ° tv65 å˜é‡ä¸­</span>
<span class="token label function">$LN4@f:</span>
<span class="token comment">; è¿™æ˜¯é€€å‡ºéƒ¨åˆ†ã€‚ä»ä¸´æ—¶å˜é‡ä¸­å¤åˆ¶æŒ‡å‘å­—ç¬¦ä¸²çš„æŒ‡é’ˆåˆ° EAX ä¸­</span>
         mov      <span class="token register variable">eax</span>, DWORD PTR tv65<span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span> <span class="token comment">; å°† tv65 å˜é‡ä¸­çš„å€¼å¤åˆ¶åˆ° EAX å¯„å­˜å™¨</span>
         mov      <span class="token register variable">esp</span>, <span class="token register variable">ebp</span>                 <span class="token comment">; æ¢å¤æ ˆæŒ‡é’ˆ</span>
         pop      <span class="token register variable">ebp</span>                      <span class="token comment">; æ¢å¤åŸºæŒ‡é’ˆ</span>
         ret      <span class="token number">0</span>                        <span class="token comment">; è¿”å›ï¼Œæ¸…ç†æ ˆä¸Šçš„å‚æ•°</span>
_f       ENDP                              <span class="token comment">; è¿‡ç¨‹ _f ç»“æŸ</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¼€å¯ç¼–è¯‘å™¨ä¼˜åŒ–</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token operator">$</span>SG792  DB       <span class="token string">'it is ten'</span>, <span class="token number">00H</span>
<span class="token operator">$</span>SG793  DB       <span class="token string">'it is not ten'</span>, <span class="token number">00H</span>

_a<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span> <span class="token comment">; size = 4</span>
_f      PROC
<span class="token comment">; compare input value with 10</span>
        cmp      DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token number">10</span>
        mov      <span class="token register variable">eax</span>, OFFSET <span class="token operator">$</span>SG792 <span class="token comment">; 'it is ten'</span>
<span class="token comment">; jump to $LN4@f if equal</span>
        je       SHORT <span class="token operator">$</span>LN4@f
        mov      <span class="token register variable">eax</span>, OFFSET <span class="token operator">$</span>SG793 <span class="token comment">; 'it is not ten'</span>
<span class="token label function">$LN4@f:</span>
        ret      <span class="token number">0</span> 
_f      ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<h4 id="æ¯”è¾ƒå¤§å°"><a class="markdownIt-Anchor" href="#æ¯”è¾ƒå¤§å°"></a> æ¯”è¾ƒå¤§å°</h4>
<ul>
<li>å¯ç”¨ä¼˜åŒ–åŠŸèƒ½åï¼Œç¼–è¯‘å™¨ä¼šå°½å¯èƒ½é¿å…ä½¿ç”¨æ¡ä»¶è½¬ç§»æŒ‡ä»¤</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">my_max</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token operator">></span>b<span class="token punctuation">)</span>
                <span class="token keyword">return</span> a<span class="token punctuation">;</span>
        <span class="token keyword">else</span>
                <span class="token keyword">return</span> b<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">my_min</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token operator">&lt;</span>b<span class="token punctuation">)</span>
                <span class="token keyword">return</span> a<span class="token punctuation">;</span>
        <span class="token keyword">else</span>
                <span class="token keyword">return</span> b<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ²¡å¼€å¯ä¼˜åŒ–</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_a<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>
_b<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">12</span>
_my_min PROC
        push     <span class="token register variable">ebp</span>
        mov      <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
        mov      <span class="token register variable">eax</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
<span class="token comment">; compare A and B:</span>
        cmp      <span class="token register variable">eax</span>, DWORD PTR _b<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
<span class="token comment">; jump, if A is greater or equal to B:</span>
        jge      SHORT <span class="token operator">$</span>LN2@my_min
<span class="token comment">; reload A to EAX if otherwise and jump to exit</span>
        mov      <span class="token register variable">eax</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
        jmp      SHORT <span class="token operator">$</span>LN3@my_min
        jmp      SHORT <span class="token operator">$</span>LN3@my_min <span class="token comment">; this is redundant JMP</span>
<span class="token label function">$LN2@my_min:</span>
<span class="token comment">; return B</span>
        mov      <span class="token register variable">eax</span>, DWORD PTR _b<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
<span class="token label function">$LN3@my_min:</span>
        pop      <span class="token register variable">ebp</span>
        ret      <span class="token number">0</span>
_my_min ENDP

_a<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>
_b<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">12</span>
_my_max PROC
        push     <span class="token register variable">ebp</span>
        mov      <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
        mov      <span class="token register variable">eax</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
<span class="token comment">; compare A and B:</span>
        cmp      <span class="token register variable">eax</span>, DWORD PTR _b<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
<span class="token comment">; jump if A is less or equal to B:</span>
        jle      SHORT <span class="token operator">$</span>LN2@my_max
<span class="token comment">; reload A to EAX if otherwise and jump to exit</span>
        mov      <span class="token register variable">eax</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
        jmp      SHORT <span class="token operator">$</span>LN3@my_max
        jmp      SHORT <span class="token operator">$</span>LN3@my_max <span class="token comment">; this is redundant JMP</span>
<span class="token label function">$LN2@my_max:</span>
<span class="token comment">; return B</span>
        mov      <span class="token register variable">eax</span>, DWORD PTR _b<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
<span class="token label function">$LN3@my_max:</span>
        pop      <span class="token register variable">ebp</span>
        ret      <span class="token number">0</span>
_my_max ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="chap13-switch"><a class="markdownIt-Anchor" href="#chap13-switch"></a> Chap13 Switch</h3>
<h4 id="caseè¾ƒå°‘çš„æƒ…å½¢"><a class="markdownIt-Anchor" href="#caseè¾ƒå°‘çš„æƒ…å½¢"></a> caseè¾ƒå°‘çš„æƒ…å½¢</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">void</span> <span class="token function">f</span> <span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
    <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span> <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"zero\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"one\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"two\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"something unknown\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//test</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>msvsä¸å¼€å¯ä¼˜åŒ–</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">tv64 <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">4</span> <span class="token comment">; size = 4</span>
_a<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>   <span class="token comment">; size = 4</span>
_f     PROC
    push   <span class="token register variable">ebp</span>
    mov    <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
    push   <span class="token register variable">ecx</span>
    mov    <span class="token register variable">eax</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
    mov    DWORD PTR tv64<span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token register variable">eax</span>
    cmp    DWORD PTR tv64<span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token number">0</span>
    je     SHORT <span class="token operator">$</span>LN4@f 
    cmp    DWORD PTR tv64<span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token number">1</span>
    je     SHORT <span class="token operator">$</span>LN3@f
    cmp    DWORD PTR tv64<span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token number">2</span>
    je     SHORT <span class="token operator">$</span>LN2@f
    jmp    SHORT <span class="token operator">$</span>LN1@f
<span class="token label function">$LN4@f:</span><span class="token number">0</span>
    push   OFFSET <span class="token operator">$</span>SG739 <span class="token comment">; 'zero', 0aH, 00H</span>
    call   _printf
    add    <span class="token register variable">esp</span>, <span class="token number">4</span>
    jmp    SHORT <span class="token operator">$</span>LN7@f
<span class="token label function">$LN3@f:</span><span class="token number">1</span>
    push   OFFSET <span class="token operator">$</span>SG741 <span class="token comment">; 'one', 0aH, 00H</span>
    call   _printf
    add    <span class="token register variable">esp</span>, <span class="token number">4</span>
    jmp    SHORT <span class="token operator">$</span>LN7@f
<span class="token label function">$LN2@f:</span><span class="token number">2</span>
    push   OFFSET <span class="token operator">$</span>SG743 <span class="token comment">; 'two', 0aH, 00H</span>
    call   _printf
    add    <span class="token register variable">esp</span>, <span class="token number">4</span>
    jmp    SHORT <span class="token operator">$</span>LN7@f
<span class="token label function">$LN1@f:</span>default
    push   OFFSET <span class="token operator">$</span>SG745 <span class="token comment">; 'something unknown', 0aH, 00H</span>
    call   _printf
    add    <span class="token register variable">esp</span>, <span class="token number">4</span>
<span class="token label function">$LN7@f:</span>ret
    mov    <span class="token register variable">esp</span>, <span class="token register variable">ebp</span>
    pop    <span class="token register variable">ebp</span>
    ret    <span class="token number">0</span> 
_f     ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¯ä»¥å‘ç°ç¼–è¯‘å™¨æŠŠSwitchç¿»è¯‘æˆäº†if elseå½¢å¼å¯ä»¥è®¤ä¸ºï¼Œswitch()è¯­å¥æ˜¯ä¸€ç§æ—¨åœ¨ç®€åŒ–å¤§é‡åµŒå¥—if()è¯­å¥è€Œè®¾è®¡çš„è¯­æ³•ç³–</p>
<p><mark>å¼€å¯ä¼˜åŒ–</mark></p>
<p><code>cl 1.c /Fa1.asm /Ox</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_a<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span> <span class="token comment">; size = 4</span>
_f     PROC
    mov    <span class="token register variable">eax</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span><span class="token comment">;eax=a</span>
    sub    <span class="token register variable">eax</span>, <span class="token number">0</span><span class="token comment">;eax=eax-0 </span>
    je     SHORT <span class="token operator">$</span>LN4@f<span class="token comment">;if a==0</span>
    sub    <span class="token register variable">eax</span>, <span class="token number">1</span>
    je     SHORT <span class="token operator">$</span>LN3@f<span class="token comment">;if a==1</span>
    sub    <span class="token register variable">eax</span>, <span class="token number">1</span>
    je     SHORT <span class="token operator">$</span>LN2@f<span class="token comment">;if a==2</span>
    <span class="token comment">;default</span>
    mov    DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>, OFFSET <span class="token operator">$</span>SG791 <span class="token comment">; 'something unknown', 0aH, 00H</span>
    jmp    _printf
<span class="token label function">$LN2@f:</span><span class="token comment">;2</span>
    mov    DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>, OFFSET <span class="token operator">$</span>SG789 <span class="token comment">; 'two', 0aH, 00H</span>
    jmp    _printf
<span class="token label function">$LN3@f:</span><span class="token comment">;1</span>
    mov    DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>, OFFSET <span class="token operator">$</span>SG787 <span class="token comment">; 'one', 0aH, 00H</span>
    jmp    _printf
<span class="token label function">$LN4@f:</span><span class="token comment">;0</span>
    mov    DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>, OFFSET <span class="token operator">$</span>SG785 <span class="token comment">; 'zero', 0aH, 00H</span>
    jmp    _printf
_f     ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸¤å¤„ä¸åŒ</p>
<ul>
<li>
<p>aå­˜åˆ°eaxä¹‹åï¼Œeax-0ï¼›è¿™æ ·çœ‹ä¼¼æ— æ„ä¹‰,å®é™…ä¸Šå¯ä»¥æ£€æŸ¥eaxå¯„å­˜å™¨çš„å€¼æ˜¯å¦ä¸º0,å¦‚æœeaxæ˜¯0ï¼ŒZF=1,è¿›è€Œæ£€æŸ¥ç¬¬ä¸€ä¸ªåˆ¤æ–­æ¡ä»¶,å¦‚æœä¸æ˜¯å°±ç»§ç»­-1åˆ¤æ–­</p>
</li>
<li>
<p>åœ¨æŠŠå­—ç¬¦ä¸²æŒ‡é’ˆå­˜å‚¨åˆ°å˜é‡<em>a</em>ä¹‹åï¼Œå‡½æ•°ä½¿ç”¨JMPæŒ‡ä»¤è°ƒç”¨printf()å‡½æ•°ã€‚</p>
<p>è¿™ç‚¹ä¸éš¾è§£é‡Šï¼šè°ƒ<mark>ç”¨æ–¹å‡½æ•°æŠŠå‚æ•°æ¨é€å…¥æ ˆä¹‹åï¼Œçš„ç¡®é€šå¸¸é€šè¿‡CALLæŒ‡ä»¤è°ƒç”¨å…¶ä»–å‡½æ•°ã€‚è¿™ç§æƒ…å†µä¸‹ï¼ŒCALLæŒ‡ä»¤ä¼šæŠŠè¿”å›åœ°å€æ¨é€å…¥æ ˆã€å¹¶é€šè¿‡æ— æ¡ä»¶è½¬ç§»çš„æ‰‹æ®µå¯ç”¨è¢«è°ƒç”¨æ–¹å‡½æ•°</mark>ã€‚å°±æœ¬ä¾‹è€Œè¨€ï¼Œåœ¨è¢«è°ƒç”¨æ–¹å‡½æ•°è¿è¡Œçš„ä»»æ„æ—¶åˆ»ï¼Œæ ˆçš„å†…å­˜å­˜å‚¨ç»“æ„ä¸ºï¼š</p>
<ul>
<li>ESPâ€”â€”æŒ‡å‘RAã€‚</li>
<li>ESPï¼‹4â€”â€”æŒ‡å‘å˜é‡<em>a</em>ã€‚</li>
</ul>
<p>å¦ä¸€æ–¹é¢ï¼Œåœ¨æœ¬ä¾‹ç¨‹åºè°ƒç”¨printf()å‡½æ•°ä¹‹å‰ã€ä¹‹åï¼Œ<mark>é™¤äº†åˆ¶å„ç¬¬ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²çš„å‚æ•°é—®é¢˜ä»¥å¤–ï¼Œæ ˆçš„å­˜å‚¨ç»“æ„å…¶å®æ²¡æœ‰å‘ç”Ÿå˜åŒ–</mark>ã€‚æ‰€ä»¥ï¼Œç¼–è¯‘å™¨åœ¨åˆ†é…JMPæŒ‡ä»¤ä¹‹å‰ï¼ŒæŠŠå­—ç¬¦ä¸²æŒ‡é’ˆå­˜å‚¨åˆ°ç›¸åº”åœ°å€ä¸Šã€‚</p>
<p>è¿™ä¸ªç¨‹åºæŠŠ<mark>å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ›¿æ¢ä¸ºå­—ç¬¦ä¸²çš„æŒ‡é’ˆ</mark>ï¼Œç„¶åè·³è½¬åˆ°printf()å‡½æ•°çš„åœ°å€ï¼Œå°±å¥½åƒç¨‹åºæ²¡æœ‰â€œè°ƒç”¨â€è¿‡f()å‡½æ•°ã€ç›´æ¥â€œè½¬ç§»â€äº†printf()å‡½æ•°ä¸€èˆ¬ã€‚å½“printf()å‡½æ•°å®Œæˆè¾“å‡ºçš„ä½¿å‘½ä»¥åï¼Œå®ƒä¼šæ‰§è¡ŒRETè¿”å›æŒ‡ä»¤ã€‚RETæŒ‡ä»¤ä¼šä»æ ˆä¸­è¯»å–ï¼ˆPOPï¼‰è¿”å›åœ°å€RAã€å¹¶è·³è½¬åˆ°RAã€‚ä¸è¿‡<mark>è¿™ä¸ªRAä¸æ˜¯å…¶è°ƒç”¨æ–¹å‡½æ•°â€”â€”f()å‡½æ•°å†…çš„æŸä¸ªåœ°å€ï¼Œè€Œæ˜¯è°ƒç”¨f()å‡½æ•°çš„å‡½æ•°å³main()å‡½æ•°çš„æŸä¸ªåœ°å€</mark>ã€‚æ¢è€Œè¨€ä¹‹ï¼Œ==è·³è½¬åˆ°è¿™ä¸ªRAåœ°å€åï¼Œprintf()å‡½æ•°ä¼šä¼´éšå…¶è°ƒç”¨æ–¹å‡½æ•°f()==ä¸€åŒç»“æŸã€‚</p>
<p>é™¤éæ¯ä¸ªcaseä»å¥çš„æœ€åä¸€æ¡æŒ‡ä»¤éƒ½æ˜¯è°ƒç”¨printf()å‡½æ•°ï¼Œå¦åˆ™ç¼–è¯‘å™¨å°±åšä¸åˆ°è¿™ç§ç¨‹åº¦çš„ä¼˜åŒ–ã€‚æŸç§æ„ä¹‰ä¸Šè¯´è¿™ä¸longjmp()å‡½æ•°ååˆ†ç›¸ä¼¼ã€‚å½“ç„¶ï¼Œè¿™ç§ä¼˜åŒ–çš„ç›®çš„æ— éå°±æ˜¯æé«˜ç¨‹åºçš„è¿è¡Œé€Ÿåº¦ã€‚</p>
</li>
</ul>
<h4 id="caseè¾ƒå¤šçš„æƒ…å½¢"><a class="markdownIt-Anchor" href="#caseè¾ƒå¤šçš„æƒ…å½¢"></a> caseè¾ƒå¤šçš„æƒ…å½¢</h4>
<p>åœ¨switch()è¯­å¥å­˜åœ¨å¤§é‡case()åˆ†æ”¯çš„æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨å°±ä¸èƒ½ç›´æ¥å¥—ç”¨å¤§é‡JE/JNEæŒ‡ä»¤äº†ã€‚ä¼šç”Ÿæˆä¸€ç§è·³è½¬è¡¨,å¦åˆ™ç¨‹åºä»£ç è‚¯å®šä¼šéå¸¸åºå¤§ã€‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">void</span> <span class="token function">f</span> <span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
    <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span> <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"zero\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"one\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"two\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span> <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"three\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span> <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"four\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"something unknown\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// test</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>x86,æœªå¼€å¯ä¼˜åŒ–,msvs</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">tv64 <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">4</span>    <span class="token comment">; size=4 </span>
_a<span class="token operator">$</span>  <span class="token operator">=</span>  <span class="token number">8</span>    <span class="token comment">; size = 4</span>
_f     PROC
     push   <span class="token register variable">ebp</span>
     mov    <span class="token register variable">ebp</span>, <span class="token register variable">esp</span><span class="token comment">;å‡½æ•°åºè¨€</span>
     push   <span class="token register variable">ecx</span>
     mov    <span class="token register variable">eax</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span><span class="token comment">;eax=a</span>
     mov    DWORD PTR tv64<span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token register variable">eax</span><span class="token comment">;tv64=a</span>
     cmp    DWORD PTR tv64<span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token number">4</span><span class="token comment">;if a==4</span>
     ja     SHORT <span class="token operator">$</span>LN1@f<span class="token comment">;if a>4</span>
     mov    <span class="token register variable">ecx</span>, DWORD PTR tv64<span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
     jmp    DWORD PTR <span class="token operator">$</span>LN11@f<span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span><span class="token comment">;jmp è·³è½¬è¡¨</span>
<span class="token label function">$LN6@f:</span><span class="token number">0</span>
     push   OFFSET <span class="token operator">$</span>SG739 <span class="token comment">; 'zero', 0aH, 00H</span>
     call   _printf
     add    <span class="token register variable">esp</span>, <span class="token number">4</span>
     jmp    SHORT <span class="token operator">$</span>LN9@f
<span class="token label function">$LN5@f:</span><span class="token number">1</span>
     push   OFFSET <span class="token operator">$</span>SG741 <span class="token comment">; 'one', 0aH, 00H</span>
     call   _printf
     add    <span class="token register variable">esp</span>, <span class="token number">4</span>
     jmp    SHORT <span class="token operator">$</span>LN9@f
<span class="token label function">$LN4@f:</span><span class="token number">2</span>
     push   OFFSET <span class="token operator">$</span>SG743 <span class="token comment">; 'two', 0aH, 00H</span>
     call   _printf
     add    <span class="token register variable">esp</span>, <span class="token number">4</span>
     jmp    SHORT <span class="token operator">$</span>LN9@f
<span class="token label function">$LN3@f:</span><span class="token number">3</span>
     push   OFFSET <span class="token operator">$</span>SG745 <span class="token comment">; 'three', 0aH, 00H</span>
     call   _printf
     add    <span class="token register variable">esp</span>, <span class="token number">4</span>
     jmp    SHORT <span class="token operator">$</span>LN9@f
<span class="token label function">$LN2@f:</span><span class="token number">4</span>
     push   OFFSET <span class="token operator">$</span>SG747 <span class="token comment">; 'four', 0aH, 00H</span>
     call   _printf
     add    <span class="token register variable">esp</span>, <span class="token number">4</span>
     jmp    SHORT <span class="token operator">$</span>LN9@f
<span class="token label function">$LN1@f:</span>defalut
     push   OFFSET <span class="token operator">$</span>SG749 <span class="token comment">; 'something unknown', 0aH, 00H</span>
     call   _printf
     add    <span class="token register variable">esp</span>, <span class="token number">4</span>
<span class="token label function">$LN9@f:</span><span class="token comment">;ret</span>
     mov    <span class="token register variable">esp</span>, <span class="token register variable">ebp</span>
     pop    <span class="token register variable">ebp</span>
     ret    <span class="token number">0</span>
     npad    <span class="token number">2</span><span class="token comment">; align next label</span>
<span class="token label function">$LN11@f:</span><span class="token comment">;è·³è½¬è¡¨</span>
     DD    <span class="token operator">$</span>LN6@f <span class="token comment">; 0</span>
     DD    <span class="token operator">$</span>LN5@f <span class="token comment">; 1</span>
     DD    <span class="token operator">$</span>LN4@f <span class="token comment">; 2</span>
     DD    <span class="token operator">$</span>LN3@f <span class="token comment">; 3</span>
     DD    <span class="token operator">$</span>LN2@f <span class="token comment">; 4</span>
_f     ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p>æ±‡ç¼–è§£è¯»:</p>
<ul>
<li>
<p>è¿™æ®µä»£ç å¯è¢«åˆ†ä¸ºæ•°ä¸ªè°ƒç”¨<code>printf()</code>å‡½æ•°çš„æŒ‡ä»¤ç»„</p>
</li>
<li>
<p>$ln11@Fçš„åç§»é‡å¼€å§‹çš„è¡¨å«åšè·³è½¬è¡¨(jumptable)</p>
</li>
<li>
<p>å‡½æ•°æœ€åˆæŠŠå˜é‡aä¸æ•°å­—4è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœa&gt;4ï¼Œå°±æ‰“å°something unknown</p>
</li>
<li>
<p><code>jmp    DWORD PTR $LN11@f[ecx*4]</code>å¦‚æœa&lt;=4ï¼Œä¼šå…ˆè®¡ç®—a*4,ç„¶åæ ¹æ®LN11@fè¿™ä¸ªè¡¨æŸ¥è¯¢ï¼Œå¹¶è·³è½¬åˆ°è¿™ä¸ªè¡¨æ‰€æŒ‡å‘çš„åœ°å€ã€‚<mark>ä¸ºä»€ä¹ˆè¦x4?æ˜¯å› ä¸ºx86ç³»ç»Ÿçš„å†…å­˜åœ°å€éƒ½æ˜¯32ä½æ•°æ®ï¼Œæ¯ä¸ªåœ°å€å ç”¨4å­—èŠ‚ï¼Œåç§»åœ°å€éœ€è¦x4æ‰èƒ½åˆ°è¾¾</mark></p>
<p>æ­¤æ—¶çš„switchè¯­å¥ç­‰æ•ˆäº<code>jmp DWORD PTR ($LN11@f[ecx*4])$LN11@f+ecx*4</code></p>
</li>
<li>
<p>npadæŒ‡ä»¤å±äº<code>æ±‡ç¼–å®</code>ï¼Œ==å®ƒçš„ä½œç”¨æ˜¯æŠŠç´§æ¥å…¶åçš„æ ‡ç­¾åœ°å€å‘4å­—èŠ‚ï¼ˆæˆ–16å­—èŠ‚ï¼‰è¾¹ç•Œå¯¹é½ã€‚==npadçš„åœ°å€å¯¹é½åŠŸèƒ½å¯<code>æé«˜å¤„ç†å™¨çš„IOè¯»å†™æ•ˆç‡</code>ï¼Œé€šè¿‡ä¸€æ¬¡æ“ä½œå³å¯å®Œæˆå†…å­˜æ€»çº¿ã€ç¼“å†²å†…å­˜ç­‰è®¾å¤‡çš„æ•°æ®æ“ä½œã€‚</p>
</li>
</ul>
</li>
</ul>
<p>switch()çš„å¤§ä½“æ¡†æ¶</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">MOV REG,input
CMP REG,<span class="token number">4</span> <span class="token comment">; maximal number of cases</span>
JA default 
SHL REG,<span class="token number">3</span> <span class="token comment">; find element in table.shift for 3bits in x64.</span>
MOV REG, jump_table<span class="token operator">[</span>REG<span class="token operator">]</span>
JMP REG

case1<span class="token comment">;</span>
     <span class="token comment">; do something</span>
     JMP exit
case2<span class="token comment">;</span>
     <span class="token comment">; do something</span>
     JMP exit
case3<span class="token comment">;</span>
     <span class="token comment">; do something</span>
     JMP exit
case4<span class="token comment">;</span>
     <span class="token comment">; do something</span>
     JMP exit
Case5<span class="token comment">;</span>
     <span class="token comment">; do something</span>
     JMP exit

<span class="token label function">defaule:</span>

     â€¦

<span class="token label function">exit:</span>

     â€¦

jump_table dd casel
           dd case2
           dd case3
           dd case4
           dd case5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è‹¥ä¸ä½¿ç”¨ä¸Šè¿°æŒ‡ä»¤ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥<mark>åœ¨32ä½ç³»ç»Ÿä¸Šä½¿ç”¨æŒ‡ä»¤JMP jump_table[REG*4]</mark>/åœ¨<mark>64ä½ä¸Šä½¿ç”¨JMP jump_table[REG*8]</mark>ï¼Œå®ç°è½¬ç§»è¡¨ä¸­çš„å¯»å€è®¡ç®—ã€‚</p>
<p>è¯´åˆ°åº•ï¼Œè½¬ç§»è¡¨åªä¸è¿‡æ˜¯æŸç§æŒ‡é’ˆæ•°ç»„å®ƒå’Œ18.5èŠ‚ä»‹ç»çš„é‚£ç§æŒ‡é’ˆæ•°ç»„ååˆ†é›·åŒã€‚</p>
<h4 id="caseä»å¥å¤šå¯¹ä¸€"><a class="markdownIt-Anchor" href="#caseä»å¥å¤šå¯¹ä¸€"></a> caseä»å¥å¤šå¯¹ä¸€</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">void</span> <span class="token function">f</span> <span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
         <span class="token keyword">switch</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span>
         <span class="token punctuation">&#123;</span>
         <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
         <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
         <span class="token keyword">case</span> <span class="token number">7</span><span class="token operator">:</span>
         <span class="token keyword">case</span> <span class="token number">10</span><span class="token operator">:</span>
                  <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"1, 2, 7, 10\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">break</span><span class="token punctuation">;</span>
         <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
         <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>
         <span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span>
         <span class="token keyword">case</span> <span class="token number">6</span><span class="token operator">:</span>
                  <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"3, 4, 5\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">break</span><span class="token punctuation">;</span>
         <span class="token keyword">case</span> <span class="token number">8</span><span class="token operator">:</span>
         <span class="token keyword">case</span> <span class="token number">9</span><span class="token operator">:</span>
         <span class="token keyword">case</span> <span class="token number">20</span><span class="token operator">:</span>
         <span class="token keyword">case</span> <span class="token number">21</span><span class="token operator">:</span>
                  <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"8 9, 21\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">break</span><span class="token punctuation">;</span>
         <span class="token keyword">case</span> <span class="token number">22</span><span class="token operator">:</span>
                  <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"22\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">break</span><span class="token punctuation">;</span>
         <span class="token keyword">default</span><span class="token operator">:</span>
                  <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"default\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">break</span><span class="token punctuation">;</span>
         <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span>
         <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¦‚æœç¼–è¯‘å™¨åˆ»æ¿åœ°æŒ‰ç…§æ¯ç§å¯èƒ½çš„é€»è¾‘åˆ†æ”¯é€ä¸€åˆ†é…å¯¹åº”çš„æŒ‡ä»¤ç»„ï¼Œé‚£ä¹ˆç¨‹åºé‡Œå°†ä¼šå­˜åœ¨å¤§é‡çš„é‡å¤æŒ‡ä»¤ã€‚ä¸€èˆ¬è€Œè¨€ï¼Œç¼–è¯‘å™¨ä¼šé€šè¿‡æŸç§<mark>æ´¾å‘æœºåˆ¶</mark>æ¥é™ä½ä»£ç çš„å†—ä½™åº¦ã€‚</p>
<p>ä½¿ç”¨MSVS å¼€å¯/Oxä¼˜åŒ–</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"> <span class="token number">1</span> <span class="token operator">$</span>SG2798 DB        <span class="token string">'1, 2, 7, 10'</span>, <span class="token number">0aH</span>, <span class="token number">00H</span>
 <span class="token number">2</span> <span class="token operator">$</span>SG2800 DB        <span class="token string">'3, 4, 5'</span>, <span class="token number">0aH</span>, <span class="token number">00H</span>
 <span class="token number">3</span> <span class="token operator">$</span>SG2802 DB        <span class="token string">'8, 9, 21'</span>, <span class="token number">0aH</span>, <span class="token number">00H</span>
 <span class="token number">4</span> <span class="token operator">$</span>SG2804 DB        <span class="token string">'22'</span>, <span class="token number">0aH</span>, <span class="token number">00H</span>
 <span class="token number">5</span> <span class="token operator">$</span>SG2806 DB        <span class="token string">'default'</span>, <span class="token number">0aH</span>, <span class="token number">00H</span>
 <span class="token number">6</span>
 <span class="token number">7</span> _a<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>
 <span class="token number">8</span> _f      PROC
 <span class="token number">9</span>         mov       <span class="token register variable">eax</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
<span class="token number">10</span>         dec       <span class="token register variable">eax</span>
<span class="token number">11</span>         cmp       <span class="token register variable">eax</span>, <span class="token number">21</span>
<span class="token number">12</span>         ja        SHORT <span class="token operator">$</span>LN1@f
<span class="token number">13</span>         movzx     <span class="token register variable">eax</span>, BYTE PTR <span class="token operator">$</span>LN10@f<span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span><span class="token comment">;ä»eaxå¯„å­˜å™¨æŒ‡å‘çš„å†…å­˜åœ°å€ä¸­è¯»å–ä¸€ä¸ªå­—èŠ‚ï¼ˆBYTEï¼‰å¤§å°çš„æ•°æ®ï¼Œç„¶åæ— ç¬¦å·æ‰©å±•è¿™ä¸ªå­—èŠ‚åˆ°32ä½ï¼ˆDWORDï¼‰ï¼Œæœ€åå°†æ‰©å±•åçš„ç»“æœå­˜å‚¨åˆ°eaxå¯„å­˜å™¨ä¸­ã€‚</span>
<span class="token number">14</span>         jmp       DWORD PTR <span class="token operator">$</span>LN11@f<span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>
<span class="token number">15</span> <span class="token operator">$</span>LN5@f:
<span class="token number">16</span>         mov       DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>, OFFSET <span class="token operator">$</span>SG2798 <span class="token comment">; '1, 2, 7, 10'</span>
<span class="token number">17</span>         jmp       DWORD PTR __imp__printf
<span class="token number">18</span> <span class="token operator">$</span>LN4@f:
<span class="token number">19</span>         mov       DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>, OFFSET <span class="token operator">$</span>SG2800 <span class="token comment">; '3, 4, 5'</span>
<span class="token number">20</span>         jmp       DWORD PTR __imp__printf
<span class="token number">21</span> <span class="token operator">$</span>LN3@f:
<span class="token number">22</span>         mov       DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>, OFFSET <span class="token operator">$</span>SG2802 <span class="token comment">; '8, 9, 21'</span>
<span class="token number">23</span>         jmp       DWORD PTR __imp__printf
<span class="token number">24</span> <span class="token operator">$</span>LN2@f:
<span class="token number">25</span>         mov       DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>, OFFSET <span class="token operator">$</span>SG2804 <span class="token comment">; '22'</span>
<span class="token number">26</span>         jmp       DWORD PTR __imp__printf
<span class="token number">27</span> <span class="token operator">$</span>LN1@f:
<span class="token number">28</span>         mov       DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>, OFFSET <span class="token operator">$</span>SG2806 <span class="token comment">; 'default'</span>
<span class="token number">29</span>         jmp       DWORD PTR __imp__printf
<span class="token number">30</span>         npad      <span class="token number">2</span> <span class="token comment">; align $LN11@f table on 16-byte boundary</span>
<span class="token number">31</span> <span class="token operator">$</span>LN11@f:
<span class="token number">32</span>         DD        <span class="token operator">$</span>LN5@f <span class="token comment">; print '1, 2, 7, 10'</span>
<span class="token number">33</span>         DD        <span class="token operator">$</span>LN4@f <span class="token comment">; print '3, 4, 5'</span>
<span class="token number">34</span>         DD        <span class="token operator">$</span>LN3@f <span class="token comment">; print '8, 9, 21'</span>
<span class="token number">35</span>         DD        <span class="token operator">$</span>LN2@f <span class="token comment">; print '22'</span>
<span class="token number">36</span>         DD        <span class="token operator">$</span>LN1@f <span class="token comment">; print 'default'</span>
<span class="token number">37</span> <span class="token operator">$</span>LN10@f:
<span class="token number">38</span>         DB        <span class="token number">0</span> <span class="token comment">; a=1  ;byteå‹1ä¸ªå­—èŠ‚</span>
<span class="token number">39</span>         DB        <span class="token number">0</span> <span class="token comment">; a=2</span>
<span class="token number">40</span>         DB        <span class="token number">1</span> <span class="token comment">; a=3</span>
<span class="token number">41</span>         DB        <span class="token number">1</span> <span class="token comment">; a=4</span>
<span class="token number">42</span>         DB        <span class="token number">1</span> <span class="token comment">; a=5</span>
<span class="token number">43</span>         DB        <span class="token number">1</span> <span class="token comment">; a=6</span>
<span class="token number">44</span>         DB        <span class="token number">0</span> <span class="token comment">; a=7</span>
<span class="token number">45</span>         DB        <span class="token number">2</span> <span class="token comment">; a=8</span>
<span class="token number">46</span>         DB        <span class="token number">2</span> <span class="token comment">; a=9</span>
<span class="token number">47</span>         DB        <span class="token number">0</span> <span class="token comment">; a=10</span>
<span class="token number">48</span>         DB        <span class="token number">4</span> <span class="token comment">; a=11</span>
<span class="token number">49</span>         DB        <span class="token number">4</span> <span class="token comment">; a=12</span>
<span class="token number">50</span>         DB        <span class="token number">4</span> <span class="token comment">; a=13</span>
<span class="token number">51</span>         DB        <span class="token number">4</span> <span class="token comment">; a=14</span>
<span class="token number">52</span>         DB        <span class="token number">4</span> <span class="token comment">; a=15</span>
<span class="token number">53</span>         DB        <span class="token number">4</span> <span class="token comment">; a=16</span>
<span class="token number">54</span>         DB        <span class="token number">4</span> <span class="token comment">; a=17</span>
<span class="token number">55</span>         DB        <span class="token number">4</span> <span class="token comment">; a=18</span>
<span class="token number">56</span>         DB        <span class="token number">4</span> <span class="token comment">; a=19</span>
<span class="token number">57</span>         DB        <span class="token number">2</span> <span class="token comment">; a=20</span>
<span class="token number">58</span>         DB        <span class="token number">2</span> <span class="token comment">; a=21</span>
<span class="token number">59</span>         DB        <span class="token number">3</span> <span class="token comment">; a=22</span>
<span class="token number">60</span> _f      ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ±‡ç¼–è§£è¯»:</p>
<ul>
<li>
<p>è¿™é‡Œä½¿ç”¨äº†ä¸¤ä¸ªè¡¨ï¼Œä¸€ä¸ªæ˜¯ç´¢å¼•è¡¨$LN10@f,å¦ä¸€ä¸ªè½¬ç§»è¡¨æ˜¯$LN11@f</p>
</li>
<li>
<p><code>movzx</code> æ˜¯æ±‡ç¼–è¯­è¨€ä¸­çš„ä¸€ä¸ªæŒ‡ä»¤ï¼Œå®ƒæ˜¯ <code>move with zero extend</code> çš„ç¼©å†™ï¼Œç”¨äºæ— ç¬¦å·æ‰©å±•å¹¶ä¼ é€æ•°æ®ã€‚æ­¤æŒ‡ä»¤ä¸»è¦ç”¨äºå°†ä¸€ä¸ªè¾ƒå°ä½å®½çš„æ•°æ®ï¼ˆé€šå¸¸æ˜¯8ä½æˆ–16ä½ï¼‰åŠ è½½åˆ°ä¸€ä¸ªè¾ƒå¤§ä½å®½çš„å¯„å­˜å™¨æˆ–å†…å­˜ä½ç½®ä¸­ï¼Œå¹¶åœ¨<mark>æ‰©å±•é«˜ä½æ—¶ç”¨0å¡«å……ã€‚</mark></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">1mov <span class="token register variable">bl</span>, <span class="token number">80h</span>   <span class="token comment">; å°†8ä½ç«‹å³æ•°80hé€å…¥8ä½å¯„å­˜å™¨BL</span>
2movzx <span class="token register variable">ax</span>, <span class="token register variable">bl</span>  <span class="token comment">; å°†BLçš„å†…å®¹æ— ç¬¦å·æ‰©å±•åˆ°16ä½ï¼Œå¹¶æ”¾å…¥AXå¯„å­˜å™¨</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>BL</code> å¯„å­˜å™¨ä¸­çš„å€¼æ˜¯ <code>80h</code>ï¼ˆåè¿›åˆ¶128ï¼‰ï¼Œå½“ä½¿ç”¨ <code>movzx</code> æŒ‡ä»¤å°† <code>BL</code> çš„å†…å®¹å¤åˆ¶åˆ° <code>AX</code> å¯„å­˜å™¨æ—¶ï¼Œå› ä¸ºæ˜¯æ— ç¬¦å·æ‰©å±•ï¼Œæ‰€ä»¥ <code>BL</code> çš„å€¼è¢«æ‰©å±•ä¸º <code>0080h</code>ï¼ˆå‰å¯¼çš„é«˜ä½è¡¥0ï¼‰ï¼Œè¿™æ · <code>AX</code> å¯„å­˜å™¨çš„å€¼å°±å˜æˆäº† <code>0080h</code>ã€‚</p>
</li>
<li>
<p>é¦–å…ˆmovzxæŒ‡ä»¤åœ¨ç´¢å¼•è¡¨ä¸­æŸ¥è¯¢è¾“å…¥å€¼,è¿”å›0(input1,2,7,10);1(input3,4,5),2(input8,9,21),3(input 22)4(default)</p>
</li>
<li>
<p>ç„¶åæŠŠç¼©å½±è¡¨çš„è¿”å›å€¼ï¼Œåœ¨ç¬¬äºŒä¸ªè½¬ç§»è¡¨ä¸­å®Œæˆè·³è½¬s</p>
</li>
</ul>
<hr />
<h4 id="fall-through"><a class="markdownIt-Anchor" href="#fall-through"></a> fall-through</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"> <span class="token number">1</span> #define R <span class="token number">1</span>
 <span class="token number">2</span> #define W <span class="token number">2</span>
 <span class="token number">3</span> #define RW <span class="token number">3</span>
 <span class="token number">4</span>
 <span class="token number">5</span> <span class="token keyword">void</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token keyword">int</span> type<span class="token punctuation">)</span>
 <span class="token number">6</span> <span class="token punctuation">&#123;</span>
 <span class="token number">7</span>          <span class="token keyword">int</span> read<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> write<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token number">8</span>
 <span class="token number">9</span>          <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span>
<span class="token number">10</span>          <span class="token punctuation">&#123;</span>
<span class="token number">11</span>          <span class="token keyword">case</span> RW<span class="token operator">:</span>
<span class="token number">12</span>                   read<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">13</span>          <span class="token keyword">case</span> W<span class="token operator">:</span>
<span class="token number">14</span>                   write<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">15</span>                   <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token number">16</span>          <span class="token keyword">case</span> R<span class="token operator">:</span>
<span class="token number">17</span>                   read<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">18</span>                   <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token number">19</span>          <span class="token keyword">default</span><span class="token operator">:</span>
<span class="token number">20</span>                   <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token number">21</span>          <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token number">22</span>          <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"read=%d, write=%d\n"</span><span class="token punctuation">,</span> read<span class="token punctuation">,</span> write<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">23</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ— è®ºtypeçš„å€¼æ˜¯RWè¿˜æ˜¯Wï¼Œç¨‹åºéƒ½ä¼šæ‰§è¡Œç¬¬14è¡Œçš„æŒ‡ä»¤ã€‚typeä¸ºRWçš„é™ˆè¿°è¯­å¥é‡Œæ²¡æœ‰breakæŒ‡ä»¤ï¼Œä»è€Œåˆ©ç”¨switchè¯­å¥çš„fall throughæ•ˆåº”ã€‚</p>
<p>msvs x86 nasm</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token operator">$</span>SG1305 DB       <span class="token string">'read=%d, write=%d'</span>, <span class="token number">0aH</span>, <span class="token number">00H</span>

_write<span class="token operator">$</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">12</span>    <span class="token comment">; size= 4</span>
_read<span class="token operator">$</span>  <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">8</span>     <span class="token comment">; size= 4</span>
tv64  <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">4</span>       <span class="token comment">; size= 4</span>
_type<span class="token operator">$</span>  <span class="token operator">=</span> <span class="token number">8</span>      <span class="token comment">; size= 4</span>
_f        PROC
          push   <span class="token register variable">ebp</span>
          mov    <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
          sub    <span class="token register variable">esp</span>, <span class="token number">12</span><span class="token comment">;int write,read,tv64</span>
          mov    DWORD PTR _read<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token number">0</span><span class="token comment">;read=0</span>
          mov    DWORD PTR _write<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token number">0</span><span class="token comment">;write=0</span>
          mov    <span class="token register variable">eax</span>, DWORD PTR _type<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span><span class="token comment">;eax=type</span>
          mov    DWORD PTR tv64<span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token register variable">eax</span><span class="token comment">;tv64=type</span>
          cmp    DWORD PTR tv64<span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token number">1</span> <span class="token comment">; R</span>
          je     SHORT <span class="token operator">$</span>LN2@f
          cmp    DWORD PTR tv64<span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token number">2</span> <span class="token comment">; W</span>
          je     SHORT <span class="token operator">$</span>LN3@f<span class="token comment">;æ— breakè¯­å¥</span>
          cmp    DWORD PTR tv64<span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token number">3</span> <span class="token comment">; RW</span>
          je     SHORT <span class="token operator">$</span>LN4@f
          jmp    SHORT <span class="token operator">$</span>LN5@f<span class="token comment">;break</span>
<span class="token label function">$LN4@f:</span> <span class="token comment">; case RW:</span>
          mov    DWORD PTR _read<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token number">1</span>
<span class="token label function">$LN3@f:</span> <span class="token comment">; case W:</span>
          mov    DWORD PTR _write<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token number">1</span>
          jmp    SHORT <span class="token operator">$</span>LN5@f
<span class="token label function">$LN2@f:</span> <span class="token comment">; case R:</span>
          mov    DWORD PTR _read<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token number">1</span>
<span class="token label function">$LN5@f:</span> <span class="token comment">;printf</span>
          mov    <span class="token register variable">ecx</span>, DWORD PTR _write<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
          push   <span class="token register variable">ecx</span>
          mov    <span class="token register variable">edx</span>, DWORD PTR _read<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
          push   <span class="token register variable">edx</span>
          push   OFFSET <span class="token operator">$</span>SG1305 <span class="token comment">; 'read=%d, write=%d'</span>
          call   _printf
          add    <span class="token register variable">esp</span>, <span class="token number">12</span>
          mov    <span class="token register variable">esp</span>, <span class="token register variable">ebp</span>
          pop    <span class="token register variable">ebp</span>
          ret    <span class="token number">0</span>
_f        ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="chap14-å¾ªç¯"><a class="markdownIt-Anchor" href="#chap14-å¾ªç¯"></a> Chap14 å¾ªç¯</h3>
<p>x86æŒ‡ä»¤é›†é‡Œæœ‰ä¸€æ¡ä¸“é—¨çš„LOOPæŒ‡ä»¤ã€‚<mark>LOOPæŒ‡ä»¤æ£€æµ‹ECXå¯„å­˜å™¨çš„å€¼æ˜¯å¦æ˜¯0ï¼Œå¦‚æœå®ƒä¸æ˜¯0åˆ™å°†å…¶é€’å‡ï¼Œå¹¶å°†æ“ä½œæƒäº¤ç»™æ“ä½œç¬¦æ‰€æŒ‡å®šçš„æ ‡ç­¾å¤„ï¼ˆå³è·³è½¬ï¼‰</mark>ã€‚æˆ–è®¸æ˜¯å› ä¸ºå¾ªç¯æŒ‡ä»¤è¿‡äºå¤æ‚çš„ç¼˜æ•…ï¼Œè‡³ä»Šå°šæœªè§è¿‡ç›´æ¥ä½¿ç”¨LOOPæŒ‡ä»¤å°†å¾ªç¯è¯­å¥è½¬è¯‘æˆæ±‡ç¼–è¯­å¥çš„ç¼–è¯‘å™¨ã€‚æ‰€ä»¥ï¼Œå¦‚æœ<mark>å“ªä¸ªç¨‹åºç›´æ¥ä½¿ç”¨LOOPæŒ‡ä»¤è¿›è¡Œå¾ªç¯æ§åˆ¶ï¼Œé‚£å®ƒå¾ˆå¯èƒ½å°±æ˜¯æ‰‹å†™çš„æ±‡ç¼–ç¨‹åºã€‚</mark></p>
<h4 id="for"><a class="markdownIt-Anchor" href="#for"></a> for</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">void</span> <span class="token function">printing_function</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"f(%d)\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> i<span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
                <span class="token function">printing_function</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_i<span class="token operator">$</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">4</span> 
_main   PROC
    push   <span class="token register variable">ebp</span>
    mov    <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
    push   <span class="token register variable">ecx</span>
    mov    DWORD PTR _i<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token number">2</span>     <span class="token comment">; åˆå§‹æ€;i=2</span>
    jmp    SHORT <span class="token operator">$</span>LN3@main
<span class="token label function">$LN2@main:</span>
    mov    <span class="token register variable">eax</span>, DWORD PTR _i<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>     <span class="token comment">; å¾ªç¯æ§åˆ¶è¯­å¥ï¼š</span>
    add    <span class="token register variable">eax</span>, <span class="token number">1</span>                      <span class="token comment">; ié€’å¢1</span>
    mov    DWORD PTR _i<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token register variable">eax</span>
<span class="token label function">$LN3@main:</span>
    cmp    DWORD PTR _i<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token number">10</span>      <span class="token comment">; åˆ¤æ–­æ˜¯å¦æ»¡è¶³å¾ªç¯æ¡ä»¶ if i==10</span>
    jge    SHORT <span class="token operator">$</span>LN1@main             <span class="token comment">; å¦‚æœi=10 åˆ™ç»ˆæ­¢å¾ªç¯è¯­å¥</span>
    mov    <span class="token register variable">ecx</span>, DWORD PTR _i<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>     <span class="token comment">; å¾ªç¯ä½“: call f(i)</span>
    push   <span class="token register variable">ecx</span><span class="token comment">;ä¼ å‚</span>
    call   _printing_function
    add    <span class="token register variable">esp</span>, <span class="token number">4</span>
    jmp    SHORT <span class="token operator">$</span>LN2@main             <span class="token comment">; è·³åˆ°å¾ªç¯å¼€å§‹å¤„</span>
<span class="token label function">$LN1@main:</span> <span class="token comment">;exit                            ; å¾ªç¯ç»“æŸ</span>
    xor    <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
    mov    <span class="token register variable">esp</span>, <span class="token register variable">ebp</span>
    pop    <span class="token register variable">ebp</span>
    ret     <span class="token number">0</span>
_main    ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr />
<p>gcc</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">main            proc near    <span class="token comment">; å¼€å§‹å®šä¹‰ä¸»ç¨‹åºè¿‡ç¨‹</span>

var_20          <span class="token operator">=</span> dword    ptr <span class="token operator">-</span><span class="token number">20h</span>  <span class="token comment">; å®šä¹‰ä¸€ä¸ªå˜é‡var_20ï¼Œåœ¨æ ˆä¸Šè·ç¦»EBP-20hçš„ä½ç½®</span>
var_4           <span class="token operator">=</span> dword    ptr â€“<span class="token number">4</span>     <span class="token comment">; å®šä¹‰å¦ä¸€ä¸ªå˜é‡var_4ï¼Œåœ¨æ ˆä¸Šè·ç¦»EBP-4çš„ä½ç½®</span>

                push       <span class="token register variable">ebp</span>         <span class="token comment">; ä¿å­˜å½“å‰åŸºå€æŒ‡é’ˆï¼ˆEBPï¼‰</span>
                mov        <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>    <span class="token comment">; å°†æ ˆé¡¶æŒ‡é’ˆï¼ˆESPï¼‰å¤åˆ¶åˆ°åŸºå€æŒ‡é’ˆï¼ˆEBPï¼‰ï¼Œå»ºç«‹æ–°çš„å †æ ˆå¸§</span>
                and        <span class="token register variable">esp</span>, <span class="token number">0FFFFFFF0h</span> <span class="token comment">; ç¡®ä¿ESPä¸º16å­—èŠ‚å¯¹é½ï¼Œé€šè¿‡ä¸æ“ä½œå»æ‰ESPçš„ä½4ä½</span>
                sub        <span class="token register variable">esp</span>, <span class="token number">20h</span>    <span class="token comment">; åœ¨æ ˆä¸Šä¸ºå±€éƒ¨å˜é‡åˆ†é…ç©ºé—´ï¼Œå‡å°ESP 32å­—èŠ‚(20h)</span>

                mov        <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">20h</span><span class="token operator">+</span>var_4<span class="token operator">]</span>, <span class="token number">2</span> <span class="token comment">; åˆå§‹åŒ–å˜é‡var_4ï¼Œå³(i=2)ï¼Œè¿™é‡Œå­˜çš„æ˜¯å¾ªç¯èµ·å§‹å€¼</span>
                jmp        short loc_8048476 <span class="token comment">; æ— æ¡ä»¶è·³è½¬åˆ°å¾ªç¯æ¡ä»¶æ£€æŸ¥å¤„å¼€å§‹å¾ªç¯</span>

<span class="token label function">loc_8048465:</span>                  <span class="token comment">; å¾ªç¯ä½“å¼€å§‹</span>
                mov        <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">20h</span><span class="token operator">+</span>var_4<span class="token operator">]</span> <span class="token comment">; æŠŠè®¡æ•°å™¨(i)çš„å€¼åŠ è½½åˆ°EAXå¯„å­˜å™¨</span>
                mov        <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">20h</span><span class="token operator">+</span>var_20<span class="token operator">]</span>, <span class="token register variable">eax</span> <span class="token comment">; æŠŠEAXçš„å€¼ï¼ˆå³içš„å€¼ï¼‰å­˜å…¥var_20ï¼Œå¯èƒ½æ˜¯ä¸ºè°ƒç”¨å‡†å¤‡å‚æ•°</span>
                call       printing_function <span class="token comment">; è°ƒç”¨æ‰“å°å‡½æ•°ï¼Œå¯èƒ½æ‰“å°var_20ä¸­çš„å€¼</span>
                add        <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">20h</span><span class="token operator">+</span>var_4<span class="token operator">]</span>, <span class="token number">1</span> <span class="token comment">; å°†è®¡æ•°å™¨(i)åŠ 1ï¼Œå³i=i+1</span>

<span class="token label function">loc_8048476:</span>                  <span class="token comment">; å¾ªç¯æ¡ä»¶æ£€æŸ¥</span>
                cmp        <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">20h</span><span class="token operator">+</span>var_4<span class="token operator">]</span>, <span class="token number">9</span> <span class="token comment">; æ¯”è¾ƒè®¡æ•°å™¨(i)æ˜¯å¦å°äºç­‰äº9</span>
                jle        short loc_8048465 <span class="token comment">; å¦‚æœi&lt;=9ï¼Œåˆ™è·³è½¬å›å¾ªç¯ä½“ç»§ç»­æ‰§è¡Œ</span>

                mov        <span class="token register variable">eax</span>, <span class="token number">0</span>      <span class="token comment">; è®¾ç½®è¿”å›å€¼ä¸º0ï¼Œè¿™é‡Œä½œä¸ºç¨‹åºæ­£å¸¸é€€å‡ºçš„æ ‡å¿—</span>
                leave                   <span class="token comment">; æ¢å¤å…ˆå‰çš„å †æ ˆçŠ¶æ€ï¼Œå°†ESPè®¾ç½®å›EBPçš„å€¼ï¼Œç„¶åå¼¹å‡ºEBP</span>
                retn                    <span class="token comment">; è¿”å›è°ƒç”¨è€…ï¼Œç»“æŸç¨‹åº</span>

main            endp             <span class="token comment">; ç»“æŸä¸»ç¨‹åºè¿‡ç¨‹å®šä¹‰</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr />
<p>msvså¼€å¯ä¼˜åŒ–</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_main    PROC
     push   <span class="token register variable">esi</span>
     mov    <span class="token register variable">esi</span>, <span class="token number">2</span>
<span class="token label function">$LL3@main:</span>
     push   <span class="token register variable">esi</span>
     call   _printing_function
     inc    <span class="token register variable">esi</span>
     add    <span class="token register variable">esp</span>, <span class="token number">4</span>
     cmp    <span class="token register variable">esi</span>, <span class="token number">10</span>     <span class="token comment">; 0000000aH</span>
     jl     SHORT <span class="token operator">$</span>LL3@main
     xor    <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
     pop    <span class="token register variable">esi</span>
     ret    <span class="token number">0</span>
_main    ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¼€å¯ä¼˜åŒ–åï¼Œ<code>ESI</code>å¯„å­˜å™¨æˆäº†è®¡æ•°å™¨<code>i</code>çš„ä¸“ç”¨å¯„å­˜å™¨,å¤§å¹…ç®€æ´äº†æ±‡ç¼–s</p>
<p><mark>è¿›è¡Œè¿™ç§ä¼˜åŒ–çš„å‰ææ¡ä»¶æ˜¯ï¼šè¢«è°ƒç”¨æ–¹å‡½æ•°ä¸åº”å½“ä¿®æ”¹å±€éƒ¨å˜é‡ä¸“ç”¨å¯„å­˜å™¨çš„å€¼ã€‚å½“ç„¶ï¼Œåœ¨æœ¬ä¾‹ä¸­ç¼–è¯‘å™¨èƒ½å¤Ÿåˆ¤æ–­å‡½æ•°printing_function ()ä¸ä¼šä¿®æ”¹ESIå¯„å­˜å™¨çš„å€¼ã€‚åœ¨ç¼–è¯‘å™¨å†³å®šç»™å±€éƒ¨å˜é‡åˆ†é…ä¸“ç”¨å¯„å­˜å™¨çš„æ—¶å€™ï¼Œå®ƒä¼šåœ¨å‡½æ•°åºè¨€éƒ¨åˆ†ä¿å­˜è¿™äº›ä¸“ç”¨å¯„å­˜å™¨çš„åˆå§‹çŠ¶æ€ï¼Œç„¶ååœ¨å‡½æ•°å°¾å£°é‡Œè¿˜åŸè¿™äº›å¯„å­˜å™¨çš„åŸå§‹å€¼ï¼Œå› æ­¤å­˜åœ¨<code>push esi</code>å’Œ<code>pop esi</code>æ¥è¿˜åŸåŸå§‹å€¼</mark></p>
<hr />
<p><code>gcc -O3 -o 1 1,c</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">main            proc near

var_10          <span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">10h</span>

                push    <span class="token register variable">ebp</span>
                mov     <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
                and     <span class="token register variable">esp</span>, <span class="token number">0FFFFFFF0h</span>
                sub     <span class="token register variable">esp</span>, <span class="token number">10h</span>
                mov     <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>var_10<span class="token operator">]</span>, <span class="token number">2</span>
                call    printing_function
                mov     <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>var_10<span class="token operator">]</span>, <span class="token number">3</span>
                call    printing_function
                mov     <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>var_10<span class="token operator">]</span>, <span class="token number">4</span>
                call    printing_function
                mov     <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>var_10<span class="token operator">]</span>, <span class="token number">5</span>
                call    printing_function
                mov     <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>var_10<span class="token operator">]</span>, <span class="token number">6</span>
                call    printing_function
                mov     <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>var_10<span class="token operator">]</span>, <span class="token number">7</span>
                call    printing_function
                mov     <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>var_10<span class="token operator">]</span>, <span class="token number">8</span>
                call    printing_function
                mov     <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>var_10<span class="token operator">]</span>, <span class="token number">9</span>
                call    printing_function
                xor     <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
                leave
                retn
main            endp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p>åœ¨è¿™é‡Œï¼ŒgccæŠŠå¾ªç¯æŒ‡ä»¤ç»™åˆ†è§£äº†(å°±æ˜¯ç»™å±•å¼€äº†)</p>
<p>ç¼–è¯‘å™¨ä¼šå¯¹<mark>è¿­ä»£æ¬¡æ•°è¾ƒå°‘çš„å¾ªç¯è¿›è¡Œå¾ªç¯åˆ†è§£</mark>ï¼ˆLoop unwindingï¼‰å¯¹å¤„ç†ã€‚å±•å¼€å¾ªç¯ä½“ä»¥åä»£ç çš„æ‰§è¡Œæ•ˆç‡ä¼šæœ‰æ‰€æå‡ï¼Œä½†æ˜¯ä¼šå¢åŠ ç¨‹åºä»£ç çš„ä½“ç§¯ã€‚</p>
</li>
<li>
<p><mark>å¦‚æœè¿­ä»£æ¬¡æ•°å¤šçš„è¯ï¼Œgccçš„ä¼˜åŒ–ä»£ç å°±ä¸msvsç›¸å·®æ— å‡ </mark></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">                public main
main            proc near

var_20          <span class="token operator">=</span> dword    ptr <span class="token operator">-</span><span class="token number">20h</span>

                push       <span class="token register variable">ebp</span>
                mov        <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
                and        <span class="token register variable">esp</span>, <span class="token number">0FFFFFFF0h</span>
                push       <span class="token register variable">ebx</span>
                mov        <span class="token register variable">ebx</span>, <span class="token number">2</span> <span class="token comment">; i=2</span>
                sub        <span class="token register variable">esp</span>, <span class="token number">1Ch</span>

<span class="token comment">; aligning label loc_80484D0 (loop body begin) by 16-byte border:</span>
                nop
<span class="token label function">loc_80484D0:</span>
<span class="token comment">; pass (i) as first argument to printing_function():</span>
                mov        <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">20h</span><span class="token operator">+</span>var_20<span class="token operator">]</span>, <span class="token register variable">ebx</span>
                add        <span class="token register variable">ebx</span>, <span class="token number">1</span> <span class="token comment">; i++</span>
                call       printing_function
                cmp        <span class="token register variable">ebx</span>, <span class="token number">64h</span> <span class="token comment">; i==100?</span>
                jnz        short loc_80484D0 <span class="token comment">; if not, continue</span>
                add        <span class="token register variable">esp</span>, <span class="token number">1Ch</span>
                xor        <span class="token register variable">eax</span>, <span class="token register variable">eax</span> <span class="token comment">; return 0</span>
                pop        <span class="token register variable">ebx</span>
                mov        <span class="token register variable">esp</span>, <span class="token register variable">ebp</span>
                pop        <span class="token register variable">ebp</span>
                retn
main            endp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åŒºåˆ«åœ¨äºgccæ˜¯æ‹¿ebxä½œä¸ºiçš„ä¸“æœ‰å¯„å­˜å™¨ï¼Œå…¶ä»–ä¸msvsç±»ä¼¼</p>
</li>
</ul>
<hr />
<h4 id="å†…å­˜å—å¤åˆ¶"><a class="markdownIt-Anchor" href="#å†…å­˜å—å¤åˆ¶"></a> å†…å­˜å—å¤åˆ¶</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">void</span> <span class="token function">my_memcpy</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> dst<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> src<span class="token punctuation">,</span> <span class="token class-name">size_t</span> cnt<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
         <span class="token class-name">size_t</span> i<span class="token punctuation">;</span>
         <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>cnt<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
                  dst<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>src<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr />
<p><code>gcc -Os</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token comment">; RDI = ç›®æ ‡åœ°å€;dst</span>
<span class="token comment">; RSI = æºåœ°å€;src</span>
<span class="token comment">; RDX = å—å¤§å°;cnt</span>

<span class="token comment">; åœ¨ 0 çš„ä½ç½®åˆå§‹åŒ–è®¡æ•°å™¨ï¼ˆiï¼‰</span>
xor     <span class="token register variable">eax</span>, <span class="token register variable">eax</span>   
 
<span class="token label function">.L2:</span>    
<span class="token comment">; å¦‚æœæ‰€æœ‰å­—èŠ‚å·²å¤åˆ¶ï¼Œåˆ™é€€å‡ºï¼š</span>
cmp     <span class="token register variable">rax</span>, <span class="token register variable">rdx</span>   <span class="token comment">; å¯¹å¯„å­˜å™¨raxå’Œrdxçš„å€¼è¿›è¡Œæ¯”è¾ƒã€‚   </span>
je      .L5    <span class="token comment">; å¦‚æœè¿™ä¸¤ä¸ªå€¼ç›¸ç­‰ï¼ˆå³å·²ç»æ‹·è´äº†è§„å®šçš„å­—èŠ‚æ•°ï¼‰ï¼Œå°±è·³è½¬åˆ°.L5ï¼Œå³è¿”å›ï¼ˆretï¼‰ã€‚</span>

<span class="token comment">; åœ¨ RSI+i å¤„åŠ è½½å­—èŠ‚ï¼š</span>
mov     <span class="token register variable">cl</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">rsi</span><span class="token operator">+</span><span class="token register variable">rax</span><span class="token operator">]</span>   <span class="token comment">; å°†åœ°å€ä¸ºï¼ˆrsi+raxï¼‰çš„ä¸€ä¸ªå­—èŠ‚å€¼åŠ è½½åˆ°clå¯„å­˜å™¨ä¸­ã€‚</span>

<span class="token comment">; åœ¨ RDI+i å¤„å­˜å‚¨å­—èŠ‚ï¼š</span>
mov     BYTE PTR <span class="token operator">[</span><span class="token register variable">rdi</span><span class="token operator">+</span><span class="token register variable">rax</span><span class="token operator">]</span>, <span class="token register variable">cl</span>   <span class="token comment">; å°†clå¯„å­˜å™¨çš„å€¼å­˜å‚¨åˆ°åœ°å€ä¸ºï¼ˆrdi+raxï¼‰çš„å†…å­˜ä¸­ã€‚</span>

inc     <span class="token register variable">rax</span>   <span class="token comment">; i++ï¼Œå°†raxå¯„å­˜å™¨çš„å€¼å¢åŠ 1ï¼Œä»¥ä¾¿ä¸‹ä¸€æ¬¡å¤åˆ¶ä¸‹ä¸€ä¸ªå­—èŠ‚ã€‚</span>
jmp     .L2   <span class="token comment">; æ— æ¡ä»¶è·³è½¬åˆ°.L2ï¼Œè¿›è¡Œä¸‹ä¸€è½®çš„æ¯”è¾ƒå’Œå­—èŠ‚æ‹·è´ã€‚</span>

<span class="token label function">.L5:</span>
ret    <span class="token comment">; å‡½æ•°è¿”å›ï¼Œç»“æŸæ‹·è´æ“ä½œã€‚</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="æ€»ç»“"><a class="markdownIt-Anchor" href="#æ€»ç»“"></a> æ€»ç»“</h4>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">    MOV <span class="token operator">[</span>counter<span class="token operator">]</span>, <span class="token number">2</span> <span class="token comment">; initialization</span>
    JMP label_check
<span class="token label function">label_increment:</span>
    ADD <span class="token operator">[</span>counter<span class="token operator">]</span>, <span class="token number">1</span> <span class="token comment">; increment</span>
<span class="token label function">label_check:</span>
    CMP <span class="token operator">[</span>counter<span class="token operator">]</span>, <span class="token number">10</span>
    JGE exit
    <span class="token comment">; loop body</span>
    <span class="token comment">; do something here</span>
    <span class="token comment">; use counter variable in local stack</span>
    JMP label_increment
<span class="token label function">exit:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>é€šå¸¸æƒ…å†µä¸‹ï¼Œç¨‹åºåº”å½“é¦–å…ˆåˆ¤æ–­å¾ªç¯æ¡ä»¶æ˜¯å¦æ»¡è¶³ï¼Œç„¶åå†æ‰§è¡Œå¾ªç¯ä½“ã€‚ä½†æ˜¯åœ¨ç¼–è¯‘å™¨ç¡®å®šç¬¬ä¸€æ¬¡è¿­ä»£è‚¯å®šä¼šå‘ç”Ÿçš„æƒ…å†µä¸‹ï¼Œå®ƒå¯èƒ½ä¼šè°ƒæ¢å¾ªç¯ä½“å’Œåˆ¤æ–­è¯­å¥çš„é¡ºåºã€‚ä¸‹é¢è¿™ä¸ªç¨‹åºå°±æ˜¯ä¸ªå…¸å‹çš„ä¾‹å­ã€‚</p>
<p>æŒ‡ä»¤æ¸…å•14.19ã€€x86</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">    MOV REG, <span class="token number">2</span> <span class="token comment">; initialization</span>
<span class="token label function">body:</span>
    <span class="token comment">; loop body</span>
    <span class="token comment">; do something here</span>
    <span class="token comment">; use counter in REG, but do not modify it!</span>
    INC REG <span class="token comment">; increment</span>
    CMP REG, <span class="token number">10</span>
    JL body<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç¼–è¯‘å™¨ä¸ä¼šä½¿ç”¨LOOPæŒ‡ä»¤ã€‚ç”±LOOPæ§åˆ¶çš„å¾ªç¯æ§åˆ¶è¯­å¥æ¯”è¾ƒå°‘è§ã€‚å¦‚æœæŸæ®µä»£ç å¸¦æœ‰LOOPæŒ‡ä»¤ï¼Œé‚£ä¹ˆæ‚¨åº”å½“è®¤ä¸ºè¿™æ˜¯æ‰‹å†™å‡ºæ¥çš„æ±‡ç¼–ç¨‹åºã€‚</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">    <span class="token comment">; count from 10 to 1</span>
    MOV <span class="token register variable">ECX</span>, <span class="token number">10</span>
<span class="token label function">body:</span>
    <span class="token comment">; loop body</span>
    <span class="token comment">; do something here</span>
    <span class="token comment">; use counter in ECX, but do not modify it!</span>
    LOOP body<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>ECX</code>ä½œä¸ºcountçš„ä¸“ç”¨å¯„å­˜å™¨</p>
<h4 id="problem-2"><a class="markdownIt-Anchor" href="#problem-2"></a> Problem</h4>
<ol>
<li></li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">;</span>i<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">--</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">;</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="4">
<li></li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">100</span><span class="token punctuation">;</span>i<span class="token operator">+=</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="chap15-cè¯­è¨€å­—ç¬¦ä¸²çš„å‡½æ•°"><a class="markdownIt-Anchor" href="#chap15-cè¯­è¨€å­—ç¬¦ä¸²çš„å‡½æ•°"></a> Chap15 Cè¯­è¨€å­—ç¬¦ä¸²çš„å‡½æ•°</h3>
<h4 id="strlen"><a class="markdownIt-Anchor" href="#strlen"></a> strlen()</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">my_strlen</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> str<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>eos<span class="token operator">=</span>str<span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">*</span>eos<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">(</span>eos<span class="token operator">-</span>str<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">my_strlen</span><span class="token punctuation">(</span><span class="token string">"hello!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr />
<p><code>Non-optimizing MSVS</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_eos<span class="token operator">$</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">4</span>                            <span class="token comment">; å®šä¹‰å±€éƒ¨å˜é‡eosçš„æ ˆåç§»é‡ä¸º-4</span>
_str<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>                             <span class="token comment">; å®šä¹‰å‚æ•°strçš„æ ˆåç§»é‡ä¸º8</span>
_strlen PROC
    push    <span class="token register variable">ebp</span>                       <span class="token comment">; ä¿å­˜åŸºå€æŒ‡é’ˆ</span>
    mov     <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>                  <span class="token comment">; è®¾ç½®æ–°çš„åŸºå€æŒ‡é’ˆ</span>
    push    <span class="token register variable">ecx</span>                       <span class="token comment">; ä¿å­˜ecxå¯„å­˜å™¨çš„å€¼</span>
    mov     <span class="token register variable">eax</span>, DWORD PTR _str<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span> <span class="token comment">; å°†ä¼ å…¥çš„å­—ç¬¦ä¸²æŒ‡é’ˆå­˜å‚¨åˆ°eaxä¸­</span>
    mov     DWORD PTR _eos<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token register variable">eax</span> <span class="token comment">; å°†eaxçš„å€¼ï¼ˆå³å­—ç¬¦ä¸²æŒ‡é’ˆï¼‰ä¿å­˜åˆ°å±€éƒ¨å˜é‡eos ä¸­</span>
<span class="token label function">$LN2@strlen_:</span>
    mov     <span class="token register variable">ecx</span>, DWORD PTR _eos<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span> <span class="token comment">; å°†eosçš„å€¼åŠ è½½åˆ°ecxä¸­</span>

    <span class="token comment">; ä»ecxæŒ‡å‘çš„åœ°å€å¤„å–8ä½å­—èŠ‚ï¼Œå¹¶å°†å…¶ä½œä¸º32ä½å€¼ï¼ˆå¸¦ç¬¦å·æ‰©å±•ï¼‰åŠ è½½åˆ°edxä¸­</span>
    movsx   <span class="token register variable">edx</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">]</span><span class="token comment">;edx=*eos</span>
    mov     <span class="token register variable">eax</span>, DWORD PTR _eos<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span> <span class="token comment">; å°†eosçš„å€¼åŠ è½½åˆ°eaxä¸­</span>
    add     <span class="token register variable">eax</span>, <span class="token number">1</span>                    <span class="token comment">; å°†eaxè‡ªå¢1ï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªå­—ç¬¦</span>
    mov     DWORD PTR _eos<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token register variable">eax</span> <span class="token comment">; å°†æ›´æ–°åçš„eaxå€¼ä¿å­˜å›eosä¸­</span>
    test    <span class="token register variable">edx</span>, <span class="token register variable">edx</span>                  <span class="token comment">; æµ‹è¯•edxå¯„å­˜å™¨ï¼ˆå³å½“å‰å­—ç¬¦æ˜¯å¦ä¸º0ï¼‰</span>
    je      SHORT <span class="token operator">$</span>LN1@strlen_        <span class="token comment">; å¦‚æœedxä¸º0ï¼Œè·³è½¬åˆ°$LN1@strlen_ï¼Œç»“æŸå¾ªç¯</span>
    jmp     SHORT <span class="token operator">$</span>LN2@strlen_        <span class="token comment">; å¦åˆ™ï¼Œç»§ç»­å¾ªç¯</span>

<span class="token label function">$LN1@strlen_:</span>
    <span class="token comment">; è®¡ç®—ä¸¤ä¸ªæŒ‡é’ˆä¹‹é—´çš„å·®å€¼</span>

    mov    <span class="token register variable">eax</span>, DWORD PTR _eos<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>  <span class="token comment">; å°†eosçš„å€¼åŠ è½½åˆ°eaxä¸­</span>
    sub    <span class="token register variable">eax</span>, DWORD PTR _str<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>  <span class="token comment">; ç”¨eoså‡å»åŸå§‹å­—ç¬¦ä¸²æŒ‡é’ˆ</span>
    sub    <span class="token register variable">eax</span>, <span class="token number">1</span>                     <span class="token comment">; å‡å»1ï¼Œå¾—åˆ°å­—ç¬¦ä¸²é•¿åº¦ï¼ˆä¸åŒ…æ‹¬ç»“å°¾çš„ç©ºå­—ç¬¦ï¼‰</span>
    mov    <span class="token register variable">esp</span>, <span class="token register variable">ebp</span>                   <span class="token comment">; æ¢å¤æ ˆæŒ‡é’ˆ</span>
    pop    <span class="token register variable">ebp</span>                        <span class="token comment">; æ¢å¤åŸºå€æŒ‡é’ˆ</span>
    ret    <span class="token number">0</span>                          <span class="token comment">; è¿”å›ç»“æœï¼ˆeaxä¸­ä¿å­˜ç€å­—ç¬¦ä¸²é•¿åº¦ï¼‰</span>
_strlen ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p><code>MOVSX</code>,å³<code>MOV with Sign Extend</code>,ä»å†…å­˜ä¸­è¯»å–8ä½æ•°æ®ï¼Œå¹¶å­˜å‚¨åˆ°32ä½å¯„å­˜å™¨é‡Œ</p>
<p>æœ¬ä¾‹ä¸­ï¼ŒMOVSXå°†ç”¨åŸå§‹æ•°æ®çš„8ä½æ•°æ®å¡«å……EDXå¯„å­˜å™¨çš„ä½8ä½ï¼›<mark>å¦‚æœåŸå§‹æ•°æ®æ˜¯è´Ÿæ•°ï¼Œè¯¥æŒ‡ä»¤å°†ä½¿ç”¨1å¡«å……ç¬¬8åˆ°ç¬¬31ä½ï¼ˆé«˜24ä½ï¼‰ï¼Œå¦åˆ™ä½¿ç”¨0å¡«å……é«˜24ä½</mark>ã€‚</p>
<p>è¿™æ˜¯ä¸ºäº†ä¿è¯æœ‰ç¬¦å·å‹æ•°æ®åœ¨ç±»å‹è½¬æ¢åçš„æ•°å€¼ä¿æŒä¸å˜ã€‚</p>
<p>ä¸¾äº†ä¸ªä¾‹å­</p>
<p>å‡å¦‚charå‹æ•°æ®çš„åŸå§‹å€¼æ˜¯âˆ’2ï¼ˆ0xFEï¼‰ï¼Œç›´æ¥æŠŠæ•´ä¸ªå­—èŠ‚å¤åˆ¶åˆ°intå‹æ•°æ®çš„æœ€ä½8ä½ä¸Šæ—¶ï¼Œintå‹æ•°æ®çš„å€¼å°±å˜æˆ0x000000FEï¼Œä»¥æœ‰ç¬¦å·å‹æ•°æ®çš„è§’åº¦çœ‹å®ƒè¢«è½¬æ¢ä¸º254äº†ï¼Œè€Œæ²¡æœ‰ä¿æŒåŸå§‹å€¼âˆ’2ã€‚âˆ’2å¯¹åº”çš„intå‹æ•°æ®æ˜¯0xFFFFFFFEã€‚æ‰€ä»¥ï¼Œåœ¨æŠŠåŸå§‹æ•°æ®å¤åˆ¶åˆ°ç›®æ ‡å˜é‡ä¹‹åï¼Œè¿˜è¦ä½¿ç”¨ç¬¦å·æ ‡å¿—ä½å¡«å……å‰©ä½™çš„æ•°æ®ï¼Œè€Œè¿™å°±æ˜¯MOVSXçš„åŠŸèƒ½ã€‚</p>
</li>
</ul>
<hr />
<p><code>Non-optimizing GCC</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">				public strlen               <span class="token comment">; å…¬å…±æ ‡å¿—ï¼Œä½¿å¾—å…¶ä»–æ¨¡å—å¯ä»¥è°ƒç”¨è¯¥å‡½æ•°</span>
strlen           proc near                   <span class="token comment">; å£°æ˜ä¸€ä¸ªnearè¿‡ç¨‹ï¼Œå‘½åä¸ºstrlen</span>

eos              <span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">4</span>               <span class="token comment">; å®šä¹‰å±€éƒ¨å˜é‡eosçš„æ ˆåç§»é‡ä¸º-4</span>
arg_0            <span class="token operator">=</span> dword ptr  <span class="token number">8</span>               <span class="token comment">; å®šä¹‰å‚æ•°arg_0ï¼ˆå­—ç¬¦ä¸²æŒ‡é’ˆï¼‰çš„æ ˆåç§»é‡ä¸º8</span>

                 push    <span class="token register variable">ebp</span>                  <span class="token comment">; ä¿å­˜åŸºå€æŒ‡é’ˆ</span>
                 mov     <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>             <span class="token comment">; è®¾ç½®æ–°çš„åŸºå€æŒ‡é’ˆ</span>
                 sub     <span class="token register variable">esp</span>, <span class="token number">10h</span>             <span class="token comment">; ä¸ºå±€éƒ¨å˜é‡åˆ†é…16å­—èŠ‚çš„æ ˆç©ºé—´</span>
                 mov     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>arg_0<span class="token operator">]</span>     <span class="token comment">; å°†ä¼ å…¥çš„å­—ç¬¦ä¸²æŒ‡é’ˆåŠ è½½åˆ°eaxä¸­</span>
                 mov     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>eos<span class="token operator">]</span>, <span class="token register variable">eax</span>       <span class="token comment">; å°†eaxçš„å€¼ï¼ˆå³å­—ç¬¦ä¸²æŒ‡é’ˆï¼‰ä¿å­˜åˆ°å±€éƒ¨å˜é‡eosä¸­</span>
<span class="token label function">loc_80483F0:</span>
                 mov     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>eos<span class="token operator">]</span>       <span class="token comment">; å°†eosçš„å€¼åŠ è½½åˆ°eaxä¸­</span>
                 movzx   <span class="token register variable">eax</span>, byte ptr <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span>  <span class="token comment">; ä»eaxæŒ‡å‘çš„åœ°å€å¤„åŠ è½½ä¸€ä¸ªå­—èŠ‚ï¼Œå¹¶é›¶æ‰©å±•ä¸º32ä½</span>
                 test    <span class="token register variable">al</span>, <span class="token register variable">al</span>               <span class="token comment">; æµ‹è¯•alå¯„å­˜å™¨çš„å€¼ï¼ˆå³å½“å‰å­—ç¬¦æ˜¯å¦ä¸º0ï¼‰</span>
                 setnz   <span class="token register variable">al</span>                   <span class="token comment">; å¦‚æœalä¸ä¸ºé›¶ï¼Œal = 1ï¼›å¦åˆ™ï¼Œal = 0</span>
                 add     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>eos<span class="token operator">]</span>, <span class="token number">1</span>         <span class="token comment">; å°†eosè‡ªå¢1ï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªå­—ç¬¦</span>
                 test    <span class="token register variable">al</span>, <span class="token register variable">al</span>               <span class="token comment">; æµ‹è¯•alå¯„å­˜å™¨çš„å€¼ï¼ˆå³å½“å‰å­—ç¬¦æ˜¯å¦ä¸ºé›¶ï¼‰</span>
                 jnz     short loc_80483F0    <span class="token comment">; å¦‚æœalä¸ä¸ºé›¶ï¼Œè·³è½¬åˆ°loc_80483F0ï¼Œç»§ç»­å¾ªç¯</span>

                 <span class="token comment">; å¾ªç¯ç»“æŸï¼ˆå½“å‰å­—ç¬¦ä¸º0ï¼‰ï¼Œè®¡ç®—å­—ç¬¦ä¸²çš„é•¿åº¦</span>
                 mov     <span class="token register variable">edx</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>eos<span class="token operator">]</span>       <span class="token comment">; å°†eosçš„å€¼åŠ è½½åˆ°edxä¸­</span>
                 mov     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>arg_0<span class="token operator">]</span>     <span class="token comment">; å°†ä¼ å…¥çš„å­—ç¬¦ä¸²æŒ‡é’ˆåŠ è½½åˆ°eaxä¸­</span>
                 mov     <span class="token register variable">ecx</span>, <span class="token register variable">edx</span>             <span class="token comment">; å°†edxçš„å€¼åŠ è½½åˆ°ecxä¸­</span>
                 sub     <span class="token register variable">ecx</span>, <span class="token register variable">eax</span>             <span class="token comment">; ecx = edx - eaxï¼Œè®¡ç®—eosä¸å­—ç¬¦ä¸²èµ·å§‹åœ°å€çš„å·®å€¼</span>
                 mov     <span class="token register variable">eax</span>, <span class="token register variable">ecx</span>             <span class="token comment">; å°†ecxçš„å€¼åŠ è½½åˆ°eaxä¸­</span>
                 sub     <span class="token register variable">eax</span>, <span class="token number">1</span>               <span class="token comment">; eaxå‡å»1ï¼Œå¾—åˆ°å­—ç¬¦ä¸²çš„å®é™…é•¿åº¦ï¼ˆä¸åŒ…æ‹¬ç»“å°¾çš„ç©ºå­—ç¬¦ï¼‰</span>
                 leave                        <span class="token comment">; æ¢å¤æ ˆæŒ‡é’ˆå’ŒåŸºå€æŒ‡é’ˆ</span>
                 retn                         <span class="token comment">; è¿”å›ç»“æœï¼ˆeaxä¸­ä¿å­˜ç€å­—ç¬¦ä¸²é•¿åº¦ï¼‰</span>
strlen           endp                        <span class="token comment">; è¿‡ç¨‹ç»“æŸ</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p>è¿™é‡Œ<code>sub esp,10h</code>,<code>eos</code>åªéœ€è¦4ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯ä¸ºäº†æ»¡è¶³å¯¹é½è¦æ±‚åˆ†é…äº†é¢å¤–çš„12ä¸ªå­—èŠ‚</p>
</li>
<li>
<p><code>MOVZX</code>æ˜¯<code>MOV with Zero-Extent</code>çš„ç¼©å†™,å°†8ä½æˆ–16ä½æ•°æ®è½¬æ¢ä¸º32ä½æ•°æ®çš„æ—¶å€™ï¼Œå®ƒç›´æ¥å¤åˆ¶åŸå§‹æ•°æ®åˆ°ç›®æ ‡å¯„å­˜å™¨çš„ç›¸åº”ä½ä½ï¼Œå¹¶ä¸”ä½¿ç”¨0å¡«å……å‰©ä½™çš„é«˜ä½ã€‚</p>
<p>==ç›¸å½“äºä¸€æ­¥å®Œæˆäº†â€œxor eax, eaxâ€å’Œâ€œmov alï¼Œ[æº8/16ä½æ•°æ®]â€2æ¡æŒ‡ä»¤</p>
</li>
<li>
<p><code>SETNZ</code>æŒ‡ä»¤:å¦‚æœALçš„å€¼ä¸æ˜¯0ï¼Œåˆ™â€œtest al, alâ€æŒ‡ä»¤ä¼šè®¾ç½®æ ‡å¿—å¯„å­˜å™¨ZF=0ï¼›è€ŒSETNZï¼ˆNot Zeroï¼‰æŒ‡ä»¤ä¼šåœ¨ZFï¼0çš„æ—¶å€™ï¼Œè®¾ç½®ALï¼1ã€‚ç”¨ç™½è¯è§£è¯´ï¼Œå°±æ˜¯ï¼š<mark>å¦‚æœALä¸ç­‰äº0ï¼Œåˆ™è·³åˆ°loc_80483F0å¤„</mark>ã€‚ç¼–è¯‘å™¨è½¬è¯‘å‡ºæ¥çš„ä»£ç ä¸­ï¼Œæœ‰äº›ä»£ç ç¡®å®æ²¡æœ‰å®é™…æ„ä¹‰</p>
</li>
</ul>
<hr />
<p><code>Optimizing MSVS</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_str<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>                                     <span class="token comment">; size = 4</span>
_strlen PROC
        mov     <span class="token register variable">edx</span>, DWORD PTR _str<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>   <span class="token comment">;ç”¨EDXä½œå­—ç¬¦ä¸²æŒ‡é’ˆ</span>
        mov     <span class="token register variable">eax</span>, <span class="token register variable">edx</span>                      <span class="token comment">;  å¤åˆ¶åˆ° EAX</span>

<span class="token label function">$LL2@strlen:</span>
        mov     <span class="token register variable">cl</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span>            <span class="token comment">; CL = *EAX</span>
        inc     <span class="token register variable">eax</span>                           <span class="token comment">; EAX++</span>
        test    <span class="token register variable">cl</span>, <span class="token register variable">cl</span>                        <span class="token comment">; CL==0?</span>
        jne     SHORT <span class="token operator">$</span>LL2@strlen             <span class="token comment">; no, continue loop</span>
        sub     <span class="token register variable">eax</span>, <span class="token register variable">edx</span>                      <span class="token comment">; è®¡ç®—æŒ‡é’ˆçš„å˜åŒ–é‡</span>
        dec     <span class="token register variable">eax</span>                           <span class="token comment">; decrement EAX</span>
        ret     <span class="token number">0</span>
_strlen ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr />
<p><code>Optimizing GCC</code> <code>-O3</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">                public strlen
strlen          proc near

arg_0           <span class="token operator">=</span> dword ptr  <span class="token number">8</span>

                push    <span class="token register variable">ebp</span>
                mov     <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
                mov     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>arg_0<span class="token operator">]</span><span class="token comment">;ecx=arg_0;</span>
                mov     <span class="token register variable">eax</span>, <span class="token register variable">ecx</span><span class="token comment">;eax=arg_0</span>

<span class="token label function">loc_8048418:</span>
                movzx   <span class="token register variable">edx</span>, byte ptr <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span><span class="token comment">;edx=*eop</span>
                add     <span class="token register variable">eax</span>, <span class="token number">1</span><span class="token comment">;eop++</span>
                test    <span class="token register variable">dl</span>, <span class="token register variable">dl</span><span class="token comment">;if dl ==0?</span>
                jnz     short loc_8048418<span class="token comment">;dl !=0,loop</span>
                not     <span class="token register variable">ecx</span>
                add     <span class="token register variable">eax</span>, <span class="token register variable">ecx</span>
                pop     <span class="token register variable">ebp</span>
                retn
strlen          endp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p><code>movzx</code>æ›¿æ¢ä¸º<code>mov dl byte ptr[eax]</code>ä¹Ÿå¯ï¼Œä½¿ç”¨<code>movzx</code>æˆ–è®¸æ˜¯ä¸ºäº†ä¿è¯å¯„å­˜å™¨çš„é«˜åœ°å€ä½ä¸å«æœ‰å™ªéŸ³æ•°æ®</p>
</li>
<li>
<p><mark><code>NOT</code>ï¼ŒNOTæŒ‡ä»¤å¯¹æ“ä½œæ•°çš„æ‰€æœ‰bitéƒ½è¿›è¡Œéè¿ç®—ï¼Œç­‰ä»·äº<code>XOR ECX,0xfffffffh</code>,<code>not ecx</code>çš„ç»“æœä¸æŸæ•°ç›¸åŠ ,ç›¸å½“äºæŸæ•°å‡å»<code>ECX</code>ç„¶åå†å‡<code>1</code></mark></p>
<p>ä»è€Œå¾—åˆ°æ­£ç¡®çš„å­—ç¬¦ä¸²é•¿åº¦</p>
<p><code>not ecx</code>ç›¸å½“äº<code>ecx=(-ecx)-1</code>ï¼Œç”±ä½è¿ç®—å¯ä»¥æ¨å¯¼</p>
</li>
</ul>
<hr />
<p>Problems:</p>
<ol>
<li></li>
</ol>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_s<span class="token operator">$</span>   <span class="token operator">=</span>  <span class="token number">8</span>
_f    PROC
           mov  <span class="token register variable">edx</span>, DWORD PTR _s<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span><span class="token comment">;edx=_s</span>
           mov  <span class="token register variable">cl</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">edx</span><span class="token operator">]</span><span class="token comment">;cl=*_s=8</span>
           xor  <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
           test <span class="token register variable">cl</span>, <span class="token register variable">cl</span>
           je   SHORT <span class="token operator">$</span>LN2@f<span class="token comment">;if cl==0,exit</span>
           npad <span class="token number">4</span>    <span class="token comment">; align next label</span>
<span class="token label function">$LL4@f:</span>
           cmp  <span class="token register variable">cl</span>, <span class="token number">32</span><span class="token comment">;</span>
           jne  SHORT <span class="token operator">$</span>LN3@f<span class="token comment">;if cl!=32,jmp LN3</span>
           inc  <span class="token register variable">eax</span><span class="token comment">;eax++</span>
<span class="token label function">$LN3@f:</span>
           mov  <span class="token register variable">cl</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">edx</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">]</span><span class="token comment">;cl=*(_s+1)</span>
           inc  <span class="token register variable">edx</span><span class="token comment">;eax++</span>
           test <span class="token register variable">cl</span>, <span class="token register variable">cl</span>
           jne  SHORT <span class="token operator">$</span>LL4@f<span class="token comment">;if cl!=0;jmp LL4</span>
<span class="token label function">$LN2@f:</span>
           ret  <span class="token number">0</span>
_f         ENDP
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>_s<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">*</span>_s<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>_s<span class="token operator">==</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//' 'ç›¸å½“äºç»Ÿè®¡å­—ç¬¦ä¸²çš„ç©ºæ ¼æ•°</span>
        <span class="token punctuation">&#123;</span>
            count<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="2">
<li></li>
</ol>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token label function">.LFB24:</span>
        push      <span class="token register variable">ebx</span>                    <span class="token comment">; ä¿å­˜ ebx å¯„å­˜å™¨çš„å€¼</span>
        mov       <span class="token register variable">ecx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span> <span class="token comment">; å°†å‚æ•°(å‡è®¾æ˜¯å­—ç¬¦ä¸²æŒ‡é’ˆ)ä¼ é€’ç»™ ecx</span>
        xor       <span class="token register variable">eax</span>, <span class="token register variable">eax</span>               <span class="token comment">; å°† eax å¯„å­˜å™¨æ¸…é›¶ (è®¡æ•°å™¨)</span>
        movzx     <span class="token register variable">edx</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">]</span>    <span class="token comment">; å°†å­—ç¬¦ä¸²çš„ç¬¬ä¸€ä¸ªå­—ç¬¦åŠ è½½åˆ° edx</span>
        test      <span class="token register variable">dl</span>, <span class="token register variable">dl</span>                 <span class="token comment">; æµ‹è¯•è¯¥å­—ç¬¦æ˜¯å¦ä¸º null (å­—ç¬¦ä¸²ç»“å°¾)</span>
        je        .L2                    <span class="token comment">; å¦‚æœæ˜¯ null, è·³è½¬åˆ° .L2 ç»“æŸ</span>
<span class="token label function">.L3:</span>
        cmp       <span class="token register variable">dl</span>, <span class="token number">32</span>                 <span class="token comment">; æ¯”è¾ƒè¯¥å­—ç¬¦ä¸ç©ºæ ¼ (ASCII 32)</span>
        lea       <span class="token register variable">ebx</span>, <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">]</span>           <span class="token comment">; è®¡ç®—å½“å‰è®¡æ•°å™¨å€¼åŠ 1çš„åœ°å€</span>
        cmove     <span class="token register variable">eax</span>, <span class="token register variable">ebx</span>               <span class="token comment">; å¦‚æœå­—ç¬¦æ˜¯ç©ºæ ¼ï¼Œeax = ebx (å³eaxåŠ 1)</span>
        add       <span class="token register variable">ecx</span>, <span class="token number">1</span>                 <span class="token comment">; å°† ecx æŒ‡é’ˆå‰ç§»ä¸€ä¸ªå­—ç¬¦</span>
        movzx     <span class="token register variable">edx</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">]</span>    <span class="token comment">; å°†ä¸‹ä¸€ä¸ªå­—ç¬¦åŠ è½½åˆ° edx</span>
        test      <span class="token register variable">dl</span>, <span class="token register variable">dl</span>                 <span class="token comment">; æµ‹è¯•è¯¥å­—ç¬¦æ˜¯å¦ä¸º null</span>
        jne       .L3                    <span class="token comment">; å¦‚æœä¸æ˜¯ null, è·³è½¬åˆ° .L3 ç»§ç»­å¤„ç†</span>
<span class="token label function">.L2:</span>
        pop       <span class="token register variable">ebx</span>                    <span class="token comment">; æ¢å¤ ebx å¯„å­˜å™¨çš„å€¼</span>
        ret                              <span class="token comment">; è¿”å›</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><code>cmove</code> æŒ‡ä»¤æ˜¯ x86 æ±‡ç¼–ä¸­çš„æ¡ä»¶ç§»åŠ¨æŒ‡ä»¤ä¹‹ä¸€ï¼Œå®ƒçš„å…¨åæ˜¯<code>conditional move if equal</code>ã€‚è¿™æ„å‘³ç€å½“æ»¡è¶³ç»™å®šæ¡ä»¶æ—¶ï¼Œä»æºæ“ä½œæ•°ç§»åŠ¨åˆ°ç›®æ ‡æ“ä½œæ•°ï¼Œè€Œå¦‚æœæ¡ä»¶ä¸æˆç«‹ï¼Œåˆ™ä¸è¿›è¡Œç§»åŠ¨.å¦‚æœæ¯”è¾ƒç»“æœæ˜¯ç›¸ç­‰ï¼ˆå³å½“å‰å­—ç¬¦æ˜¯ç©ºæ ¼ï¼‰<code>eax=ebx=eax+1</code></li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>str<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">*</span>str<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> temp<span class="token operator">=</span>count<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>str<span class="token operator">==</span><span class="token number">32</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            count<span class="token operator">=</span>temp<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿›ä¸€æ­¥ç®€åŒ–ä»£ç å°±æ˜¯è®¡æ•°æ‰€æœ‰ç©ºæ ¼å­—ç¬¦</p>
<h3 id="chap16-æ•°å­¦è®¡ç®—æŒ‡ä»¤çš„æ›¿æ¢"><a class="markdownIt-Anchor" href="#chap16-æ•°å­¦è®¡ç®—æŒ‡ä»¤çš„æ›¿æ¢"></a> Chap16 æ•°å­¦è®¡ç®—æŒ‡ä»¤çš„æ›¿æ¢</h3>
<p><code>å‡ºäºæ€§èƒ½ä¼˜åŒ–çš„è€ƒè™‘ï¼Œç¼–è¯‘å™¨å¯èƒ½ä¼šå°†1æ¡æ•°å­¦è¿ç®—æŒ‡ä»¤æ›¿æ¢ä¸ºå…¶ä»–çš„1æ¡ã€ç”šè‡³æ˜¯ä¸€ç»„ç­‰æ•ˆæŒ‡ä»¤ã€‚</code>ä¾‹å¦‚<code>LEA</code>æŒ‡ä»¤é€šå¸¸æ›¿ä»£å…¶ä»–ç®€å•è®¡ç®—æŒ‡ä»¤ï¼Œ<code>ADD</code>ä¸<code>SUB</code>åŒæ ·å¯ä»¥ç›¸äº’æ›¿æ¢</p>
<h4 id="ä¹˜æ³•"><a class="markdownIt-Anchor" href="#ä¹˜æ³•"></a> ä¹˜æ³•</h4>
<h5 id="æ›¿æ¢ä¸ºåŠ æ³•è¿ç®—"><a class="markdownIt-Anchor" href="#æ›¿æ¢ä¸ºåŠ æ³•è¿ç®—"></a> æ›¿æ¢ä¸ºåŠ æ³•è¿ç®—</h5>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> a<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
         <span class="token keyword">return</span> a<span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä½¿ç”¨MSVC 2010ï¼ˆå¯ç”¨/Oxï¼‰è¿›è¡Œç¼–è¯‘ï¼Œç¼–è¯‘å™¨ä¼šæŠŠâ€œä¹˜ä»¥8â€çš„è¿ç®—æŒ‡ä»¤æ‹†è§£ä¸º3æ¡åŠ æ³•æŒ‡ä»¤ã€‚</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">mov     <span class="token register variable">eax</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
add     <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
add     <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
add     <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
ret     <span class="token number">0</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="æ›¿æ¢ä¸ºç§»ä½è¿ç®—"><a class="markdownIt-Anchor" href="#æ›¿æ¢ä¸ºç§»ä½è¿ç®—"></a> æ›¿æ¢ä¸ºç§»ä½è¿ç®—</h5>
<p>ç¼–è¯‘å™¨é€šå¸¸ä¼šæŠŠâ€œä¹˜ä»¥2â€â€œé™¤ä»¥2â€çš„è¿ç®—æŒ‡ä»¤å¤„ç†ä¸ºä½ç§»è¿ç®—æŒ‡ä»¤</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> a<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> a<span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_a<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>          <span class="token comment">; size = 4</span>
_f       PROC
         push    <span class="token register variable">ebp</span>
         mov     <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
         mov     <span class="token register variable">eax</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
         shl     <span class="token register variable">eax</span>, <span class="token number">2</span><span class="token comment">;shift left</span>
         pop     <span class="token register variable">ebp</span>
         ret     <span class="token number">0</span>
_f       ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="æ›¿æ¢ä¸ºç§»ä½åŠ å‡æ³•çš„æ··åˆè¿ç®—"><a class="markdownIt-Anchor" href="#æ›¿æ¢ä¸ºç§»ä½åŠ å‡æ³•çš„æ··åˆè¿ç®—"></a> æ›¿æ¢ä¸ºç§»ä½,åŠ å‡æ³•çš„æ··åˆè¿ç®—</h5>
<p>å³ä½¿ä¹˜æ•°æ˜¯7æˆ–17ï¼Œä¹˜æ³•è¿ç®—ä»ç„¶å¯ä»¥ç”¨éä¹˜æ³•è¿ç®—æŒ‡ä»¤é…åˆä½ç§»æŒ‡ä»¤å®ç°ã€‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span>

<span class="token keyword">int</span> <span class="token function">f1</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
         <span class="token keyword">return</span> a<span class="token operator">*</span><span class="token number">7</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">f2</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
         <span class="token keyword">return</span> a<span class="token operator">*</span><span class="token number">28</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">f3</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
         <span class="token keyword">return</span> a<span class="token operator">*</span><span class="token number">17</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token comment">; a*7</span>
_a<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>
_f1      PROC
         mov     <span class="token register variable">ecx</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
<span class="token comment">; ECX=a</span>
         lea     <span class="token register variable">eax</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">]</span>
<span class="token comment">; EAX=ECX*8</span>
         sub     <span class="token register variable">eax</span>, <span class="token register variable">ecx</span>
<span class="token comment">; EAX=EAX-ECX=ECX*8-ECX=ECX*7=a*7</span>
         ret     <span class="token number">0</span> 
_f1     ENDP

<span class="token comment">; a*28</span>
_a<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>
_f2     PROC
         mov     <span class="token register variable">ecx</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
<span class="token comment">; ECX=a</span>
         lea     <span class="token register variable">eax</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">]</span>
<span class="token comment">; EAX=ECX*8</span>
         sub     <span class="token register variable">eax</span>, <span class="token register variable">ecx</span>
<span class="token comment">; EAX=EAX-ECX=ECX*8-ECX=ECX*7=a*7</span>
         shl     <span class="token register variable">eax</span>, <span class="token number">2</span>
<span class="token comment">; EAX=EAX&lt;&lt;2=(a*7)*4=a*28</span>
         ret     <span class="token number">0</span> 
_f2     ENDP

<span class="token comment">; a*17</span>
_a<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>
_f3     PROC
         mov     <span class="token register variable">eax</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
<span class="token comment">; EAX=a</span>
         shl     <span class="token register variable">eax</span>, <span class="token number">4</span>
<span class="token comment">; EAX=EAX&lt;&lt;4=EAX*16=a*16</span>
         add     <span class="token register variable">eax</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
<span class="token comment">; EAX=EAX+a=a*16+a=a*17</span>
         ret     <span class="token number">0</span>
_f3     ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="é™¤æ³•è¿ç®—"><a class="markdownIt-Anchor" href="#é™¤æ³•è¿ç®—"></a> é™¤æ³•è¿ç®—</h4>
<h5 id="æ›¿æ¢ä¸ºä½ç§»è¿ç®—"><a class="markdownIt-Anchor" href="#æ›¿æ¢ä¸ºä½ç§»è¿ç®—"></a> æ›¿æ¢ä¸ºä½ç§»è¿ç®—</h5>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> a<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
       <span class="token keyword">return</span> a<span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>shr eax,2</code></p>
<h4 id="problem-3"><a class="markdownIt-Anchor" href="#problem-3"></a> Problem</h4>
<ol>
<li></li>
</ol>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_a<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>
_f      PROC
        mov     <span class="token register variable">ecx</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span><span class="token comment">;ecx=a</span>
        lea     <span class="token register variable">eax</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">]</span><span class="token comment">;eax=a*8</span>
        sub     <span class="token register variable">eax</span>, <span class="token register variable">ecx</span><span class="token comment">;eax=eax-a=7a</span>
        ret     <span class="token number">0</span>
_f      ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="chap17-fpu"><a class="markdownIt-Anchor" href="#chap17-fpu"></a> Chap17 FPU</h3>
<ul>
<li>
<p><code>FPUæ˜¯ä¸“é—¨å¤„ç†æµ®ç‚¹æ•°çš„è¿ç®—å•å…ƒï¼Œæ˜¯CPUçš„ä¸€ä¸ªç»„ä»¶ã€‚</code></p>
</li>
<li>
<p><code>IEEE 754 </code>æ ‡å‡†è§„å®šäº†è®¡ç®—æœºç¨‹åºè®¾è®¡ç¯å¢ƒä¸­çš„äºŒè¿›åˆ¶å’Œåè¿›åˆ¶çš„æµ®ç‚¹æ•°çš„äº¤æ¢ã€ç®—æœ¯æ ¼å¼ä»¥åŠæ–¹æ³•ã€‚ç¬¦åˆè¿™ç§æ ‡å‡†çš„æµ®ç‚¹æ•°ç”±ç¬¦å·ä½ã€å°¾æ•°ï¼ˆåˆç§°ä¸ºæœ‰æ•ˆæ•°å­—ã€å°æ•°ä½ï¼‰å’ŒæŒ‡æ•°ä½æ„æˆã€‚</p>
</li>
<li>
<p>åœ¨80486å¤„ç†å™¨é—®ä¸–ä¹‹å‰ï¼ŒFPUï¼ˆä¸CPUä½äºä¸åŒçš„èŠ¯ç‰‡ï¼‰å«ä½œåä½œï¼ˆè¾…åŠ©ï¼‰å¤„ç†å™¨ã€‚è€Œä¸”é‚£ä¸ªæ—¶å€™çš„FPUè¿˜ä¸å±äºä¸»æ¿çš„æ ‡å‡†é…ç½®ï¼›å¦‚æœæƒ³è¦åœ¨ä¸»æ¿ä¸Šå®‰è£…FPUï¼Œäººä»¬è¿˜å¾—å•ç‹¬è´­ä¹°å®ƒã€‚</p>
<p>80486 DXä¹‹åçš„CPUå¤„ç†å™¨é›†æˆäº†FPUçš„åŠŸèƒ½ã€‚</p>
<p>è‹¥æ²¡æœ‰FWAITæŒ‡ä»¤å’Œopcodeä»¥D8ï½DFå¼€å¤´çš„æ‰€è°“çš„â€œESCâ€å­—ç¬¦æŒ‡ä»¤ï¼ˆopcodeä»¥D8ï½DFå¼€å¤´ï¼‰ï¼Œææ€•å¾ˆå°‘æœ‰äººè¿˜ä¼šæƒ³èµ·FPUå±äºç‹¬ç«‹è¿ç®—å•å…ƒçš„è¿™æ®µå†å²ã€‚FWAITæŒ‡ä»¤çš„ä½œç”¨æ˜¯è®©CPUç­‰å¾…FPUè¿ç®—ç»“æŸï¼Œè€ŒESCå­—ç¬¦æŒ‡ä»¤éƒ½åœ¨FPUä¸Šæ‰§è¡Œã€‚</p>
<p>FPUè‡ªå¸¦ä¸€ä¸ªç”±<code>8ä¸ª80ä½å¯„å­˜å™¨æ„æˆçš„å¾ªç¯æ ˆ</code>ã€‚è¿™äº›80ä½å¯„å­˜å™¨ç”¨ä»¥å­˜å‚¨IEEE 754æ ¼å¼çš„æµ®ç‚¹æ•°æ®ï¼Œé€šå¸¸å«ä½œ<code>ST(0)ï½ST(7)å¯„å­˜å™¨</code>ã€‚IDAå’ŒOllyDbgéƒ½æŠŠST(0)æ˜¾ç¤ºä¸ºSTã€‚ä¹Ÿæœ‰ä¸å°‘æ•™ç§‘ä¹¦æŠŠST(0)å«ä½œâ€œæ ˆé¡¶/Stack Topâ€å¯„å­˜å™¨ã€‚</p>
</li>
</ul>
<hr />
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">double</span> <span class="token function">f</span> <span class="token punctuation">(</span><span class="token keyword">double</span> a<span class="token punctuation">,</span> <span class="token keyword">double</span> b<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
          <span class="token keyword">return</span> a<span class="token operator">/</span><span class="token number">3.14</span> <span class="token operator">+</span> b<span class="token operator">*</span><span class="token number">4.1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span>
          <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"%f\n"</span><span class="token punctuation">,</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">1.2</span><span class="token punctuation">,</span> <span class="token number">3.4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">CONST    SEGMENT
__real@<span class="token number">4010666666666666</span> DQ 04010666666666666r <span class="token comment">; 4.1    ; å®šä¹‰å¸¸é‡4.1ï¼Œå­˜å‚¨åœ¨æ®µ`CONST`ä¸­</span>
CONST    ENDS
CONST    SEGMENT
__real@40091eb851eb851f DQ 040091eb851eb851fr <span class="token comment">; 3.14   ; å®šä¹‰å¸¸é‡3.14ï¼Œå­˜å‚¨åœ¨æ®µ`CONST`ä¸­</span>
CONST    ENDS
_TEXT    SEGMENT
_a<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>             <span class="token comment">; å˜é‡`_a`çš„åç§»é‡ï¼Œç›¸å¯¹äºåŸºæŒ‡é’ˆ(`ebp`)çš„8å­—èŠ‚ä½ç½®</span>
_b<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">16</span>            <span class="token comment">; å˜é‡`_b`çš„åç§»é‡ï¼Œç›¸å¯¹äºåŸºæŒ‡é’ˆ(`ebp`)çš„16å­—èŠ‚ä½ç½®</span>

_f PROC                <span class="token comment">; `_f` æ˜¯ä¸€ä¸ªè¿‡ç¨‹ï¼ˆå‡½æ•°ï¼‰</span>
   push    <span class="token register variable">ebp</span>         <span class="token comment">; ä¿å­˜è°ƒç”¨è€…çš„æ ˆå¸§åŸºæŒ‡é’ˆï¼ŒæŠŠå½“å‰`ebp`å€¼æ¨å…¥æ ˆ</span>
   mov     <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>    <span class="token comment">; å°†æ ˆæŒ‡é’ˆ`esp`çš„å€¼ä¿å­˜åœ¨æ ˆå¸§åŸºæŒ‡é’ˆ`ebp`ä¸­ï¼Œå»ºç«‹å‡½æ•°æ ˆå¸§</span>
   fld     QWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
                        <span class="token comment">; å°†ebpåç§»_açš„å€¼ï¼ˆå³å˜é‡_açš„å€¼ï¼‰åŠ è½½åˆ°FPUï¼ˆæµ®ç‚¹è¿ç®—å•å…ƒï¼‰å †æ ˆä¸­</span>

<span class="token comment">; å½“å‰FPUå †æ ˆçŠ¶æ€: ST(0) = _a</span>

   fdiv   QWORD PTR __real@40091eb851eb851f
                        <span class="token comment">; å°†ST(0)ä¸­çš„å€¼é™¤ä»¥å¸¸é‡3.14ï¼Œå¹¶å°†ç»“æœå­˜å‚¨åœ¨ST(0)ä¸­</span>

<span class="token comment">; å½“å‰FPUå †æ ˆçŠ¶æ€: ST(0) = _a / 3.14</span>

   fld    QWORD PTR _b<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
                        <span class="token comment">; å°†ebpåç§»_bçš„å€¼ï¼ˆå³å˜é‡_bçš„å€¼ï¼‰åŠ è½½åˆ°FPUå †æ ˆä¸­</span>

<span class="token comment">; å½“å‰FPUå †æ ˆçŠ¶æ€: ST(0) = _b; ST(1) = _a / 3.14</span>

   fmul   QWORD PTR __real@<span class="token number">4010666666666666</span>
                        <span class="token comment">; å°†ST(0)ä¸­çš„å€¼ä¹˜ä»¥å¸¸é‡4.1ï¼Œå¹¶å°†ç»“æœå­˜å‚¨åœ¨ST(0)ä¸­</span>

<span class="token comment">; å½“å‰FPUå †æ ˆçŠ¶æ€: ST(0) = _b * 4.1; ST(1) = _a / 3.14</span>

   faddp ST(<span class="token number">1</span>), ST(<span class="token number">0</span>)
                        <span class="token comment">; å°†ST(0)å’ŒST(1)ä¸­çš„å€¼ç›¸åŠ ï¼Œå¹¶å°†ç»“æœå­˜å‚¨åœ¨ST(1)ä¸­ï¼Œ</span>
                        <span class="token comment">; ç„¶åå¼¹å‡ºå †æ ˆé¡¶ï¼ˆå³ST(0)ï¼‰ï¼Œå †æ ˆå¹³è¡¡</span>

<span class="token comment">; å½“å‰FPUå †æ ˆçŠ¶æ€: ST(0) = (_a / 3.14) + (_b * 4.1)</span>

   pop   <span class="token register variable">ebp</span>            <span class="token comment">; æ¢å¤è°ƒç”¨è€…çš„åŸºæŒ‡é’ˆï¼Œå°†æ ˆé¡¶çš„å€¼å¼¹å‡ºåˆ°`ebp`ä¸­</span>
   ret   <span class="token number">0</span>              <span class="token comment">; ä»å‡½æ•°è¿”å›ï¼Œä¼ é€’0ä¸ªå‚æ•°ç»™è°ƒç”¨è€…</span>
_f  ENDP                <span class="token comment">; ç»“æŸè¿‡ç¨‹å®šä¹‰</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ±‡ç¼–è§£è¯»</p>
<ul>
<li><code>FLD</code>æŒ‡ä»¤ä»æ ˆä¸­è¯»å–8ä¸ªå­—èŠ‚ï¼ŒæŠŠè¿™ä¸ªå€¼è½¬æ¢æˆ<code>FPU</code>å¯„å­˜å™¨æ‰€éœ€çš„80ä½æ•°æ®æ ¼å¼ï¼Œå¹¶å­˜å…¥<code>ST(0)</code>å¯„å­˜å™¨</li>
<li><code>FDIV</code>æŒ‡ä»¤æŠŠ<code>ST(0)</code>å¯„å­˜å™¨çš„å€¼ç”¨ä½œè¢«é™¤æ•°,æŠŠå‚æ•°<code>__real@40091eb851eb851f</code>ï¼ˆå³3.14ï¼‰çš„å€¼å½“ä½œé™¤æ•°.å› ä¸ºæ±‡ç¼–è¯­æ³•ä¸æ”¯æŒå«æœ‰å°æ•°ç‚¹çš„æµ®ç‚¹ç«‹å³æ•°ï¼Œæ‰€ä»¥ç¨‹åºä½¿ç”¨64ä½IEEE 754æ ¼å¼çš„16è¿›åˆ¶æ•°</li>
<li>è¿›è¡Œ<code>FDIV</code>è¿ç®—ä¹‹åï¼Œ<code>ST(0)</code>å¯„å­˜å™¨å°†ä¿å­˜å•†</li>
<li>æ­¤å¤–ï¼Œ<code>FDIVP</code>ä¹Ÿæ˜¯FPUçš„é™¤æ³•è¿ç®—æŒ‡ä»¤ã€‚FDIVPåœ¨è¿›è¡ŒST(1)/ST(0)è¿ç®—æ—¶ï¼Œå…ˆæŠŠä¸¤ä¸ªå¯„å­˜å™¨çš„å€¼POPå‡ºæ¥è¿›è¡Œè¿ç®—ï¼Œå†æŠŠå•†æ¨é€å…¥(PUSH)FPUçš„æ ˆï¼ˆå³ST(0)å¯„å­˜å™¨ï¼‰ã€‚</li>
<li>ä¸‹ä¸€æ¡<code>FLD</code>æŒ‡ä»¤æŠŠ<code>b</code>é€å…¥<code>FPU</code>çš„æ ˆä¸­</li>
<li>æ­¤æ—¶<code>ST(1)</code>å¯„å­˜å™¨é‡Œæ˜¯ä¸Šæ¬¡é™¤æ³•è¿ç®—çš„å•†ï¼Œ<code>ST(0)</code>å¯„å­˜å™¨é‡Œæ˜¯å˜é‡<code>b</code>çš„å€¼</li>
<li>æ¥ä¸‹æ¥çš„<code>FMUL</code>æŒ‡ä»¤åšä¹˜æ³•è¿ç®—ï¼Œå®ƒç”¨ST(0)å¯„å­˜å™¨é‡Œçš„å€¼ï¼ˆå³å˜é‡<em>b</em>ï¼‰ï¼Œä¹˜ä»¥å‚æ•°__real @4010666666666666ï¼ˆå³4.1ï¼‰ï¼Œå¹¶å°†è¿ç®—ç»“æœï¼ˆç§¯ï¼‰å­˜å‚¨åˆ°ST(0)å¯„å­˜å™¨ã€‚</li>
<li>æœ€åä¸€æ¡è¿ç®—æŒ‡ä»¤FADDPè®¡ç®—æ ˆå†…é¡¶éƒ¨ä¸¤ä¸ªå€¼çš„å’Œã€‚å®ƒ<code>å…ˆæŠŠè¿ç®—ç»“æœå­˜å‚¨åœ¨ST(1)å¯„å­˜å™¨ï¼Œå†POP ST(0)</code>ã€‚æ‰€ä»¥ï¼Œ<mark>è¿ç®—è¡¨è¾¾å¼çš„è¿ç®—ç»“æœå­˜å‚¨åœ¨æ ˆé¡¶çš„ST(0)å¯„å­˜å™¨é‡Œã€‚</mark></li>
<li>æ ¹æ®æœ‰å…³è§„èŒƒï¼Œ<mark>å‡½æ•°å¿…é¡»ä½¿ç”¨ST(0)å¯„å­˜å™¨å­˜å‚¨æµ®ç‚¹è¿ç®—çš„è¿”å›ç»“æœ</mark>ã€‚æ‰€ä»¥åœ¨FADDPæŒ‡ä»¤ä¹‹åï¼Œé™¤äº†å‡½æ•°å°¾å£°çš„æŒ‡ä»¤ä¹‹å¤–å†æ— å…¶ä»–æŒ‡ä»¤ã€‚</li>
</ul>
<hr />
<p><code>GCC -O3</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token comment">; å®šä¹‰è¿‡ç¨‹ fï¼Œä½œä¸ºä¸€ä¸ªè¿‘è¿‡ç¨‹</span>
public f
f proc near

<span class="token comment">; å®šä¹‰è¿‡ç¨‹çš„å‚æ•°</span>
arg_0 <span class="token operator">=</span> qword ptr <span class="token number">8</span>      <span class="token comment">; ç¬¬ä¸€ä¸ªå‚æ•°çš„åç§»é‡ï¼Œç›¸å¯¹äº`ebp`çš„8å­—èŠ‚ä½ç½®</span>
arg_8 <span class="token operator">=</span> qword ptr <span class="token number">10h</span>    <span class="token comment">; ç¬¬äºŒä¸ªå‚æ•°çš„åç§»é‡ï¼Œç›¸å¯¹äº`ebp`çš„16å­—èŠ‚ä½ç½®</span>

                push    <span class="token register variable">ebp</span>      <span class="token comment">; æŠŠè°ƒç”¨è€…çš„æ ˆå¸§åŸºæŒ‡é’ˆ`ebp`æ¨å…¥æ ˆä¸­ï¼Œä¿ç•™è°ƒç”¨è€…çš„æ ˆå¸§</span>
                fld     <span class="token register variable">ds</span>:dbl_8048608 <span class="token comment">; åŠ è½½å…¨å±€æ•°æ®æ®µä¸­çš„å¸¸é‡3.14åˆ°FPUï¼ˆæµ®ç‚¹è¿ç®—å•å…ƒï¼‰å †æ ˆ</span>

<span class="token comment">; å½“å‰æ ˆçŠ¶æ€: ST(0) = 3.14</span>
                mov     <span class="token register variable">ebp</span>, <span class="token register variable">esp</span> <span class="token comment">; åˆ›å»ºæ–°çš„æ ˆå¸§ï¼ŒebpæŒ‡å‘å½“å‰æ ˆé¡¶</span>
                fdivr   <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>arg_0<span class="token operator">]</span> <span class="token comment">; åé™¤æ³•æŒ‡ä»¤ï¼Œå°†ST(0)ä¸­çš„å¸¸é‡3.14é™¤ä»¥ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆarg_0ï¼‰</span>

<span class="token comment">; å½“å‰æ ˆçŠ¶æ€: ST(0) = é™¤æ³•ç»“æœ (3.14 / arg_0)</span>
                fld     <span class="token register variable">ds</span>:dbl_8048610 <span class="token comment">; åŠ è½½å…¨å±€æ•°æ®æ®µä¸­çš„å¸¸é‡4.1åˆ°FPUå †æ ˆ</span>

<span class="token comment">; å½“å‰æ ˆçŠ¶æ€: ST(0) = 4.1, ST(1) = é™¤æ³•ç»“æœ</span>
                fmul    <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>arg_8<span class="token operator">]</span> <span class="token comment">; å°†ST(0)ä¸­çš„4.1ä¹˜ä»¥ç¬¬äºŒä¸ªå‚æ•°ï¼ˆarg_8ï¼‰</span>

<span class="token comment">; å½“å‰æ ˆçŠ¶æ€: ST(0) = ä¹˜æ³•ç»“æœ (4.1 * arg_8), ST(1) = é™¤æ³•ç»“æœ</span>
                pop     <span class="token register variable">ebp</span>      <span class="token comment">; æ¢å¤è°ƒç”¨è€…çš„æ ˆå¸§ï¼Œå°†æ ˆé¡¶çš„å€¼å¼¹å‡ºåˆ°ebpä¸­</span>
                faddp   st(<span class="token number">1</span>), st <span class="token comment">; å°†ST(0)å’ŒST(1)ç›¸åŠ ï¼Œå¹¶å°†ç»“æœå­˜å‚¨åœ¨ST(1)ä¸­ï¼Œ</span>
                                  <span class="token comment">; ç„¶åå¼¹å‡ºå †æ ˆé¡¶ï¼ˆå³ST(0)ï¼‰ï¼Œæ ˆå¹³è¡¡</span>

<span class="token comment">; å½“å‰æ ˆçŠ¶æ€: ST(0) = åŠ æ³•ç»“æœ ((3.14 / arg_0) + (4.1 * arg_8))</span>
                ret               <span class="token comment">; ä»è¿‡ç¨‹è¿”å›ï¼Œè¿”å›åœ°å€ä»æ ˆé¡¶å¼¹å‡º</span>
f endp           <span class="token comment">; ç»“æŸè¿‡ç¨‹å®šä¹‰</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p><code>gcc</code>æŠŠ3.14é€å…¥FPUçš„æ ˆä¸­(ST(0)å¯„å­˜å™¨),ç”¨ä½œ<code>arg_0</code>çš„é™¤æ•°</p>
</li>
<li>
<p><code>FDIVR</code>æ˜¯<code>Reverse Divide</code>çš„ç¼©å†™ã€‚<code>FDIVR</code>æŒ‡ä»¤çš„é™¤æ•°å’Œè¢«é™¤æ•°ï¼Œå¯¹åº”<code>FDIV</code>æŒ‡ä»¤çš„è¢«é™¤æ•°å’Œé™¤æ•°ï¼Œå³ä½ç½®ç›¸åï¼Œ<code>FDIV</code>æ˜¯<code>ST[0]</code>ä½œä¸ºè¢«é™¤æ•°ï¼Œ<code>FDIVR</code>æ˜¯<code>ST[0]</code>ä½œé™¤æ•°</p>
<p>å…¶ä»–ç›¸åŒ</p>
</li>
</ul>
<h4 id="åˆ©ç”¨å‚æ•°ä¼ é€’æµ®ç‚¹å‹"><a class="markdownIt-Anchor" href="#åˆ©ç”¨å‚æ•°ä¼ é€’æµ®ç‚¹å‹"></a> åˆ©ç”¨å‚æ•°ä¼ é€’æµ®ç‚¹å‹</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;math.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span>
        <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"32.01 ^ 1.54 = %lf\n"</span><span class="token punctuation">,</span> <span class="token function">pow</span> <span class="token punctuation">(</span><span class="token number">32.01</span><span class="token punctuation">,</span><span class="token number">1.54</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>msvs x86</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">CONST    SEGMENT
__real@40400147ae147ae1 DQ 040400147ae147ae1r    <span class="token comment">; 32.01  ; å®šä¹‰å¸¸é‡32.01ï¼Œå­˜å‚¨åœ¨æ®µ`CONST`ä¸­</span>
__real@3ff8a3d70a3d70a4 DQ 03ff8a3d70a3d70a4r    <span class="token comment">; 1.54   ; å®šä¹‰å¸¸é‡1.54ï¼Œå­˜å‚¨åœ¨æ®µ`CONST`ä¸­</span>
CONST    ENDS

_main    PROC                          <span class="token comment">; ä¸»è¿‡ç¨‹ _main çš„å¼€å§‹</span>
    push   <span class="token register variable">ebp</span>                         <span class="token comment">; å°†è°ƒç”¨è€…çš„æ ˆå¸§åŸºæŒ‡é’ˆ`ebp`æ¨å…¥æ ˆï¼Œä¿ç•™è°ƒç”¨è€…çš„æ ˆå¸§</span>
    mov    <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>                    <span class="token comment">; å°†å½“å‰æ ˆé¡¶æŒ‡é’ˆ`esp`çš„å€¼èµ‹ç»™`ebp`ï¼Œå»ºç«‹æ–°çš„æ ˆå¸§</span>
    sub    <span class="token register variable">esp</span>, <span class="token number">8</span>                      <span class="token comment">; ä¸ºç¬¬1ä¸ªå˜é‡åˆ†é…8ä¸ªå­—èŠ‚çš„æ ˆç©ºé—´</span>
    fld    QWORD PTR __real@3ff8a3d70a3d70a4   <span class="token comment">; åŠ è½½å¸¸é‡1.54åˆ°FPUï¼ˆæµ®ç‚¹è¿ç®—å•å…ƒï¼‰å †æ ˆ</span>
    fstp   QWORD PTR <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">]</span>             <span class="token comment">; å°†FPUå †æ ˆé¡¶éƒ¨ï¼ˆST(0)ï¼‰çš„å€¼å­˜å‚¨åˆ°æ ˆé¡¶ï¼ˆå¯¹åº”ç¬¬1ä¸ªå˜é‡çš„ç©ºé—´ï¼‰</span>
    sub    <span class="token register variable">esp</span>, <span class="token number">8</span>                      <span class="token comment">; ä¸ºç¬¬2ä¸ªå˜é‡åˆ†é…8ä¸ªå­—èŠ‚çš„æ ˆç©ºé—´</span>
    fld    QWORD PTR __real@40400147ae147ae1   <span class="token comment">; åŠ è½½å¸¸é‡32.01åˆ°FPUå †æ ˆ</span>
    fstp   QWORD PTR <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">]</span>             <span class="token comment">; å°†FPUå †æ ˆé¡¶éƒ¨çš„å€¼å­˜å‚¨åˆ°æ ˆé¡¶ï¼ˆå¯¹åº”ç¬¬2ä¸ªå˜é‡çš„ç©ºé—´ï¼‰</span>
    call   _pow                        <span class="token comment">; è°ƒç”¨`_pow`å‡½æ•°è®¡ç®—å¹‚ï¼ˆé»˜è®¤åº•æ•°åœ¨ [esp + 8]ï¼ŒæŒ‡æ•°åœ¨ [esp]ï¼‰</span>

    add    <span class="token register variable">esp</span>, <span class="token number">8</span>                      <span class="token comment">; è°ƒæ•´æ ˆæŒ‡é’ˆï¼Œé‡Šæ”¾ç¬¬2ä¸ªå˜é‡çš„ç©ºé—´</span>
                                       
<span class="token comment">; æ ˆåˆ†é…äº†8ä¸ªå­—èŠ‚çš„ç©ºé—´ç”¨äºå­˜å‚¨å‡½æ•° `_pow` çš„ç»“æœ</span>
<span class="token comment">; è¿ç®—ç»“æœå­˜å‚¨äºFPUå †æ ˆçš„ST(0)å¯„å­˜å™¨</span>

    fstp   QWORD PTR <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">]</span>             <span class="token comment">; å°†FPUå †æ ˆé¡¶éƒ¨çš„å€¼ï¼ˆ`_pow`ç»“æœï¼‰å­˜å‚¨åˆ°æ ˆé¡¶ï¼Œä¾›`printf()`ä½¿ç”¨</span>
    push   OFFSET <span class="token operator">$</span>SG2651              <span class="token comment">; æ¨é€æ ¼å¼å­—ç¬¦ä¸²çš„åœ°å€åˆ°æ ˆï¼Œç”¨äº`printf()`è°ƒç”¨</span>
    call   _printf                     <span class="token comment">; è°ƒç”¨`printf()`å‡½æ•°æ‰“å°ç»“æœ</span>
    add    <span class="token register variable">esp</span>, <span class="token number">12</span>                     <span class="token comment">; è°ƒæ•´æ ˆæŒ‡é’ˆï¼Œé‡Šæ”¾ç”¨äº`printf`è°ƒç”¨çš„æ ˆç©ºé—´ï¼ˆ8å­—èŠ‚ç»“æœ + 4å­—èŠ‚åœ°å€ï¼‰</span>
    xor    <span class="token register variable">eax</span>, <span class="token register variable">eax</span>                    <span class="token comment">; å°†`eax`å¯„å­˜å™¨ç½®é›¶ï¼Œè¡¨ç¤ºç¨‹åºè¿”å›å€¼ä¸º0</span>
    pop    <span class="token register variable">ebp</span>                         <span class="token comment">; æ¢å¤è°ƒç”¨è€…çš„æ ˆå¸§ï¼Œå°†æ ˆé¡¶çš„å€¼å¼¹å‡ºåˆ°`ebp`ä¸­</span>
    ret    <span class="token number">0</span>                           <span class="token comment">; ä»è¿‡ç¨‹è¿”å›ï¼Œä¼ é€’0ä¸ªå‚æ•°ç»™è°ƒç”¨è€…</span>
_main    ENDP                          <span class="token comment">; ç»“æŸè¿‡ç¨‹å®šä¹‰</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ±‡ç¼–è§£è¯»</p>
<ul>
<li>FLDå’ŒFSTPæŒ‡ä»¤æ˜¯åœ¨æ•°æ®æ®µï¼ˆSEGMENTï¼‰å’ŒFPUçš„æ ˆé—´äº¤æ¢æ•°æ®çš„æŒ‡ä»¤ã€‚<mark>FLDæŠŠå†…å­˜é‡Œçš„æ•°æ®æ¨é€å…¥FPUçš„æ ˆ</mark>ï¼Œè€Œ<mark>FSTPåˆ™æŠŠFPUæ ˆé¡¶çš„æ•°æ®<code>å¤åˆ¶</code>åˆ°å†…å­˜ä¸­</mark>ã€‚è¿™ä¸¤ä¸ªè¿ç”¨ç›¸å½“äºä½¿æµ®ç‚¹æ•°ç»™å…¥æ ˆäº†,ç»™powä¼ é€’å‚æ•°</li>
<li>pow()å‡½æ•°æ˜¯æŒ‡æ•°è¿ç®—å‡½æ•°ï¼Œå®ƒä»<mark>FPUçš„æ ˆå†…è¯»å–ä¸¤ä¸ªå‚æ•°è¿›è¡Œè®¡ç®—ï¼Œå¹¶æŠŠè¿ç®—ç»“æœï¼ˆ<em>x</em>çš„<em>y</em>æ¬¡å¹‚ï¼‰å­˜å‚¨åœ¨ST(0)å¯„å­˜å™¨é‡Œ</mark>ã€‚ä¹‹åï¼Œprintf()å‡½æ•°å…ˆä»å†…å­˜æ ˆä¸­è¯»å–8ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œå†ä»¥åŒç²¾åº¦æµ®ç‚¹çš„å½¢å¼è¿›è¡Œè¾“å‡ºã€‚</li>
<li>æ­¤å¤–ï¼Œè¿™ä¸ªä¾‹å­é‡Œè¿˜å¯ä»¥<mark>ç›´æ¥æˆå¯¹ä½¿ç”¨MOVæŒ‡ä»¤æŠŠæµ®ç‚¹æ•°æ®ä»å†…å­˜å¤åˆ¶åˆ°FPUçš„æ ˆé‡Œã€‚å†…å­˜æœ¬èº«å°±æŠŠæµ®ç‚¹æ•°æ®å­˜å‚¨ä¸ºIEEE 754çš„æ•°æ®æ ¼å¼ï¼Œè€Œpow()å‡½æ•°æ‰€éœ€çš„å‚æ•°å°±æ˜¯è¿™ä¸ªæ ¼å¼çš„æ•°æ®ï¼Œæ‰€ä»¥æ­¤å¤„æ²¡æœ‰æ ¼å¼è½¬æ¢çš„å¿…è¦</mark>ã€‚</li>
</ul>
<h4 id="æ¯”è¾ƒè¯´æ˜"><a class="markdownIt-Anchor" href="#æ¯”è¾ƒè¯´æ˜"></a> æ¯”è¾ƒè¯´æ˜</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">double</span> <span class="token function">d_max</span> <span class="token punctuation">(</span><span class="token keyword">double</span> a<span class="token punctuation">,</span> <span class="token keyword">double</span> b<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token operator">></span>b<span class="token punctuation">)</span>
                <span class="token keyword">return</span> a<span class="token punctuation">;</span>

        <span class="token keyword">return</span> b<span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span>
        <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"%f\n"</span><span class="token punctuation">,</span> <span class="token function">d_max</span> <span class="token punctuation">(</span><span class="token number">1.2</span><span class="token punctuation">,</span> <span class="token number">3.4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"%f\n"</span><span class="token punctuation">,</span> <span class="token function">d_max</span> <span class="token punctuation">(</span><span class="token number">5.6</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr />
<p><code>Non-Optimizing MSVS</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">PUBLIC    _d_max
_TEXT    SEGMENT
_a<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>              <span class="token comment">; å˜é‡_a$åœ¨æ ˆå¸§ä¸­çš„åç§»ï¼Œå¤§å°ä¸º8å­—èŠ‚</span>
_b<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">16</span>             <span class="token comment">; å˜é‡_b$åœ¨æ ˆå¸§ä¸­çš„åç§»ï¼Œå¤§å°ä¸º8å­—èŠ‚</span>
_d_max     PROC
    push   <span class="token register variable">ebp</span>               <span class="token comment">; ä¿å­˜æ—§çš„åŸºå€æŒ‡é’ˆ</span>
    mov    <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>          <span class="token comment">; å°†å½“å‰æ ˆé¡¶æŒ‡é’ˆèµ‹å€¼ç»™åŸºå€æŒ‡é’ˆ</span>
    fld    QWORD PTR _b<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span><span class="token comment">; åŠ è½½_b$ï¼Œå°†å…¶å‹å…¥FPUå †æ ˆçš„ST(0)å¯„å­˜å™¨</span>

    <span class="token comment">; å½“å‰å †æ ˆçŠ¶æ€ï¼šST(0) = _b</span>
    <span class="token comment">; æ¯”è¾ƒ_bï¼ˆST(0)ï¼‰å’Œ_a$ï¼Œç„¶åå¼¹å‡ºå¯„å­˜å™¨</span>

    fcomp  QWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span><span class="token comment">; æ¯”è¾ƒST(0)å’Œ_a$ï¼Œå¹¶å¼¹å‡ºST(0)</span>

    <span class="token comment">; æ­¤æ—¶FPUå †æ ˆä¸ºç©º</span>

    fnstsw <span class="token register variable">ax</span>                <span class="token comment">; å°†FPUçŠ¶æ€å­—å­˜å‚¨åˆ°AXå¯„å­˜å™¨</span>
    test   <span class="token register variable">ah</span>, <span class="token number">5</span>             <span class="token comment">; æ£€æŸ¥AXå¯„å­˜å™¨çš„é«˜8ä½çš„ç¬¬0å’Œç¬¬2ä½(å¯¹åº”çš„æ˜¯C2,C0æ ‡å¿—ä½)</span>
    jp     SHORT <span class="token operator">$</span>LN1@d_max  <span class="token comment">; å¦‚æœæ ‡å¿—ä½æœ‰æ­£æ•°æ ‡å¿—(a&lt;=b)ï¼Œåˆ™è·³è½¬åˆ°$LN1@d_max</span>

    <span class="token comment">; å¦‚æœ_a > _bï¼Œç»§ç»­æ‰§è¡Œä»¥ä¸‹ä»£ç </span>

    fld    QWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span><span class="token comment">; åŠ è½½_a$ï¼Œå°†å…¶å‹å…¥FPUå †æ ˆçš„ST(0)</span>
    jmp    SHORT <span class="token operator">$</span>LN2@d_max  <span class="token comment">; è·³è½¬åˆ°$LN2@d_max</span>
<span class="token label function">$LN1@d_max:</span>
    fld    QWORD PTR _b<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span><span class="token comment">; åŠ è½½_b$ï¼Œå°†å…¶å‹å…¥FPUå †æ ˆçš„ST(0)</span>
<span class="token label function">$LN2@d_max:</span>
    pop    <span class="token register variable">ebp</span>               <span class="token comment">; æ¢å¤åŸºå€æŒ‡é’ˆ</span>
    ret    <span class="token number">0</span>                 <span class="token comment">; è¿”å›</span>
_d_max    ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p><code>FCOMP</code>é¦–å…ˆæ¯”è¾ƒ<code>ST(0)</code>ä¸<code>_a</code>çš„å€¼ï¼Œç„¶åæ ¹æ®æ¯”è¾ƒçš„ç»“æœè®¾ç½®<code>FPU</code>çŠ¶æ€å­—(å¯„å­˜å™¨)çš„C3/C2/C0ä½ã€‚<mark><code>FPU</code>çš„çŠ¶æ€å­—å¯„å­˜å™¨æ˜¯ä¸€ä¸ª16ä½å¯„å­˜å™¨ï¼Œç”¨äºæè¿°<code>FPU</code>çš„å½“å‰çŠ¶æ€</mark></p>
<ul>
<li>å¦‚æœ<em>b</em>&gt;aï¼Œåˆ™C3ã€C2ã€C0å¯„å­˜å™¨çš„å€¼ä¼šåˆ†åˆ«æ˜¯0ã€0ã€0ã€‚</li>
<li>å¦‚æœ<em>a</em>&gt;<em>b</em>ï¼Œåˆ™å¯„å­˜å™¨çš„å€¼ä¼šåˆ†åˆ«æ˜¯0ã€0ã€1ã€‚</li>
<li>å¦‚æœ<em>a</em>=<em>b</em>ï¼Œåˆ™å¯„å­˜å™¨çš„å€¼ä¼šåˆ†åˆ«æ˜¯1ã€0ã€0ã€‚</li>
<li>å¦‚æœå‡ºç°äº†é”™è¯¯ï¼ˆNaNæˆ–æ•°æ®ä¸å…¼å®¹ï¼‰ï¼Œåˆ™å¯„å­˜å™¨çš„å€¼æ˜¯1ã€1ã€1ã€‚</li>
</ul>
<p>åœ¨è®¾ç½®å¥½ç›¸åº”æ¯”ç‰¹ä½ä¹‹åï¼Œ<code>FCOMPæŒ‡ä»¤è¿˜ä¼šä»æ ˆé‡ŒæŠ›å‡ºï¼ˆPOPï¼‰ä¸€ä¸ªå€¼</code>ã€‚FCOMä¸FCOMPçš„åŠŸèƒ½ååˆ†ç›¸ä¼¼ã€‚<code>FCOMæŒ‡ä»¤åªæ ¹æ®æ•°å€¼æ¯”è¾ƒçš„ç»“æœè®¾ç½®çŠ¶æ€å­—ï¼Œè€Œä¸ä¼šå†æ“ä½œFPUçš„æ ˆ</code>ã€‚</p>
</li>
<li>
<p><code>FNSTSW</code> æŒ‡ä»¤åœ¨ x86 æ±‡ç¼–ä¸­ç”¨äºå°†æµ®ç‚¹çŠ¶æ€å­—ï¼ˆ<code>Floating Point Status Word</code>ï¼‰å­˜å‚¨åˆ°æŒ‡å®šä½ç½®æˆ– AX å¯„å­˜å™¨ä¸­</p>
<p><code>F</code>:æ“ä½œå‰ä¸ç­‰å¾…FPUå¯ç”¨</p>
<p><code>NST</code>:No SToreåˆ°å†…å­˜æ“ä½œ</p>
<p><code>SW</code>:Status Word(çŠ¶æ€å­—)</p>
<p>C3/C2/C0æ ‡å¿—ä½å¯¹åº”AXçš„ç¬¬14/10/8ä½ã€‚<code>å¤åˆ¶æ•°å€¼å¹¶ä¸ä¼šæ”¹å˜æ ‡å¿—ä½ï¼ˆbitï¼‰çš„æ•°æƒï¼ˆä½ç½®ï¼‰</code>ã€‚æ ‡å¿—ä½ä¼šé›†ä¸­åœ¨AXå¯„å­˜å™¨çš„é«˜åœ°å€ä½åŒºåŸŸâ€”â€”å³AHå¯„å­˜å™¨é‡Œã€‚</p>
<p>ä»¥AHæ¥çœ‹:0:C0   1:C1   2:C2   6:C3</p>
<p><code>test ah, 5</code>æŒ‡ä»¤æŠŠahçš„å€¼ï¼ˆFPUæ ‡å¿—ä½çš„åŠ æƒæ±‚å’Œå€¼ï¼‰å’Œ0101ï¼ˆäºŒè¿›åˆ¶çš„5ï¼‰åšä¸ï¼ˆANDï¼‰è¿ç®—ï¼Œå¹¶è®¾ç½®æ ‡å¿—ä½ã€‚å½±å“testç»“æœçš„åªæœ‰ç¬¬0æ¯”ç‰¹ä½çš„C0æ ‡å¿—ä½å’Œç¬¬2æ¯”ç‰¹ä½çš„C2æ ‡å¿—ä½ï¼Œå› ä¸ºå…¶ä»–çš„ä½éƒ½ä¼šè¢«ç½®é›¶ã€‚</p>
</li>
<li>
<p>å¥‡å¶æ ¡éªŒä½PFï¼ˆparity flagï¼‰çš„ä»‹ç»</p>
<p><mark>PFæ ‡å¿—ä½çš„ä½œç”¨æ˜¯åˆ¤å®šè¿ç®—ç»“æœä¸­çš„â€œ1â€çš„ä¸ªæ•°ï¼Œå¦‚æœâ€œ1â€çš„ä¸ªæ•°ä¸ºå¶æ•°ï¼Œåˆ™PFçš„å€¼ä¸º1ï¼Œå¦åˆ™å…¶å€¼ä¸º0ã€‚</mark></p>
<p>æ£€éªŒå¥‡å¶ä½é€šå¸¸ç”¨äºåˆ¤æ–­å¤„ç†è¿‡ç¨‹æ˜¯å¦å‡ºç°æ•…éšœï¼Œå¹¶<mark>ä¸èƒ½åˆ¤æ–­è¿™ä¸ªæ•°å€¼æ˜¯å¥‡æ•°è¿˜æ˜¯å¶æ•°</mark>ã€‚FPUæœ‰å››ä¸ªæ¡ä»¶æ ‡å¿—ä½ï¼ˆC0åˆ°C3ï¼‰ã€‚ä½†æ˜¯ï¼Œå¿…é¡»æŠŠæ ‡å¿—ä½çš„å€¼ç»„ç»‡èµ·æ¥ã€å­˜æ”¾åœ¨æ ‡å¿—ä½å¯„å­˜å™¨ä¸­ï¼Œæ‰èƒ½è¿›è¡Œå¥‡å¶æ ¡éªŒä½çš„æ­£ç¡®æ€§éªŒè¯ã€‚FPUæ ‡å¿—ä½çš„ç”¨é€”å„æœ‰ä¸åŒï¼š<mark>C0ä½æ˜¯è¿›ä½æ ‡å¿—ä½CFï¼ŒC2æ˜¯å¥‡å¶æ ¡éªŒä½PFï¼ŒC3æ˜¯é›¶æ ‡å¿—ä½ZF</mark></p>
<p>åœ¨ä½¿ç”¨FUCOMæŒ‡ä»¤ï¼ˆFPUæ¯”è¾ƒæŒ‡ä»¤çš„é€šç§°ï¼‰æ—¶ï¼Œ<mark>å¦‚æœæ“ä½œæ•°é‡Œå‡ºç°äº†ä¸å¯æ¯”è¾ƒçš„æµ®ç‚¹å€¼ï¼ˆéæ•°å€¼å‹å†…å®¹NaNæˆ–å…¶ä»–æ— æ³•è¢«æŒ‡ä»¤æ”¯æŒçš„æ ¼å¼ï¼‰ï¼Œåˆ™C2ä¼šè¢«è®¾ä¸º1ã€‚</mark></p>
<p><mark>å¦‚æœC0å’ŒC2éƒ½æ˜¯0æˆ–éƒ½æ˜¯1ï¼Œåˆ™è®¾PFæ ‡å¿—ä¸º1å¹¶è§¦å‘JPè·³è½¬ï¼ˆJump on Parity</mark>ï¼‰ã€‚å‰é¢å¯¹C3/C2/C0çš„å–å€¼è¿›è¡Œäº†åˆ†ç±»è®¨è®ºï¼Œ<mark>C2å’ŒC0çš„æ•°å€¼ç›¸åŒçš„æƒ…å†µåˆ†ä¸º<em>b</em>&gt;<em>a</em>å’Œ <em>a</em>=<em>b</em>è¿™ä¸¤ç§æƒ…å†µã€‚å› ä¸ºtestæŒ‡ä»¤æŠŠahçš„å€¼ä¸5è¿›è¡Œâ€œä¸â€è¿ç®—ï¼Œæ‰€ä»¥C3çš„å€¼æ— å…³ç´§è¦</mark>ã€‚</p>
<p>åœ¨æ­¤ä¹‹åçš„æŒ‡ä»¤å°±å¾ˆç®€å•äº†ã€‚å¦‚æœè§¦å‘äº†JPè·³è½¬ï¼Œåˆ™FLDæŒ‡ä»¤æŠŠå˜é‡_bçš„å€¼å¤åˆ¶åˆ°ST(0)å¯„å­˜å™¨ï¼Œå¦åˆ™å˜é‡_açš„å€¼å°†ä¼šä¼ é€’ç»™STï¼ˆ0ï¼‰å¯„å­˜å™¨ã€‚</p>
<p>å¦‚æœéœ€è¦æ£€æµ‹C2çš„çŠ¶æ€</p>
<p>å¦‚æœTESTæŒ‡ä»¤é‡åˆ°é”™è¯¯ï¼ˆNaNç­‰æƒ…å½¢ï¼‰ï¼Œåˆ™C2æ ‡å¿—ä½çš„å€¼ä¼šè¢«è®¾ç½®ä¸º1ã€‚ä¸è¿‡æˆ‘ä»¬çš„ç¨‹åºä¸æ£€æµ‹è¿™ç±»é”™è¯¯ã€‚<code>å¦‚æœç¼–ç¨‹äººå‘˜éœ€è¦å¤„ç†FPUçš„é”™è¯¯ï¼Œä»–å°±ä¸å¾—ä¸æ·»åŠ é¢å¤–çš„é”™è¯¯æ£€æŸ¥æŒ‡ä»¤</code>ã€‚</p>
</li>
</ul>
<hr />
<p><code>Optimizing MSVS 2010</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_a<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>                  <span class="token comment">; size = 8</span>
_b<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">16</span>                 <span class="token comment">; size = 8</span>
_d_max     PROC
    fld     QWORD PTR _b<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
    fld     QWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>

<span class="token comment">; current stack state: ST(0) = _a, ST(1) = _b</span>

    fcom    ST(<span class="token number">1</span>) <span class="token comment">; compare _a and ST(1) = (_b)</span>
    fnstsw  <span class="token register variable">ax</span>
    test    <span class="token register variable">ah</span>, <span class="token number">65</span> <span class="token comment">; 00000041H</span>
    jne     SHORT <span class="token operator">$</span>LN5@d_max
<span class="token comment">; copy ST(0) to ST(1) and pop register,</span>
<span class="token comment">; leave (_a) on top</span>
    fstp    ST(<span class="token number">1</span>)

<span class="token comment">; current stack state: ST(0) = _a</span>

    ret     <span class="token number">0</span>
<span class="token label function">$LN5@d_max:</span>
<span class="token comment">; copy ST(0) to ST(0) and pop register,</span>
<span class="token comment">; leave (_b) on top</span>
    fstp    ST(<span class="token number">0</span>)

<span class="token comment">; current stack state: ST(0) = _b</span>
    ret <span class="token number">0</span>
_d_max ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p>FCOMæŒ‡ä»¤å’Œå‰é¢ç”¨è¿‡çš„FCOMPæŒ‡ä»¤ç•¥æœ‰ä¸åŒï¼Œå®ƒä¸æ“ä½œFPUæ ˆã€‚è€Œä¸”æœ¬ä¾‹çš„æ“ä½œæ•°ä¹Ÿå’Œå‰æ–‡æœ‰åŒºåˆ«ï¼Œè¿™é‡Œå®ƒæ˜¯é€†åºçš„ã€‚æ‰€ä»¥ï¼ŒFCOMç”Ÿæˆçš„æ¡ä»¶æ ‡å¿—ä½çš„æ¶µä¹‰ä¹Ÿä¸å‰ä¾‹ä¸åŒã€‚</p>
<ul>
<li>å¦‚æœ<em>a</em>&gt;<em>b</em>ï¼Œåˆ™C3ã€C2ã€C0ä½çš„å€¼åˆ†åˆ«ä¸º0ã€0ã€0ã€‚</li>
<li>å¦‚æœ<em>b</em>&gt;<em>a</em>ï¼Œåˆ™å¯¹åº”æ•°å€¼ä¸º0ã€0ã€1ã€‚</li>
<li>å¦‚æœ<em>a</em>=<em>b</em>ï¼Œåˆ™å¯¹åº”æ•°å€¼ä¸º1ã€0ã€0ã€‚</li>
</ul>
</li>
<li>
<p>æ˜¯è¯´ï¼Œâ€œtest ah, 65â€è¿™æ¡æŒ‡ä»¤ä»…ä»…æ¯”è¾ƒä¸¤ä¸ªæ ‡å¿—ä½â€”â€”C3ï¼ˆç¬¬6ä½/bitï¼‰å’ŒC0ï¼ˆç¬¬0ä½/bitï¼‰ã€‚åœ¨<em>a</em>&gt;<em>b</em>çš„æƒ…å†µä¸‹ï¼Œä¸¤è€…éƒ½åº”ä¸º0ï¼šè¿™ç§æƒ…å†µä¸‹ï¼Œç¨‹åºä¸ä¼šè¢«è§¦å‘JNEè·³è½¬ï¼Œå¹¶ä¼šæ‰§è¡Œåé¢çš„FSTP ST(1)æŒ‡ä»¤ï¼ŒæŠŠSTï¼ˆ0ï¼‰çš„å€¼å¤åˆ¶åˆ°æ“ä½œæ•°ä¸­ï¼Œç„¶åä»FPUæ ˆé‡ŒæŠ›å‡ºä¸€ä¸ªå€¼ã€‚æ¢å¥è¯è¯´ï¼Œè¿™æ¡æŒ‡ä»¤æŠŠSTï¼ˆ0ï¼‰çš„å€¼ï¼ˆå³å˜é‡_açš„å€¼ï¼‰å¤åˆ¶åˆ°STï¼ˆ1ï¼‰å¯„å­˜å™¨ï¼›æ­¤åæ ˆé¡¶çš„2ä¸ªå€¼éƒ½æ˜¯_aã€‚ç„¶åï¼Œç›¸å½“äºPOPå‡ºä¸€ä¸ªå€¼æ¥ï¼Œä½¿ST(0)å¯„å­˜å™¨çš„å€¼ä¸º_aï¼Œå‡½æ•°éšå³ç»“æŸã€‚</p>
<p>åœ¨<em>b</em>&gt;<em>a</em>æˆ–<em>a</em>==<em>b</em>çš„æƒ…å†µä¸‹ï¼Œç¨‹åºå°†è§¦å‘æ¡ä»¶è½¬ç§»æŒ‡ä»¤JNEã€‚ä»ST(0)å–å€¼ã€å†èµ‹å€¼ç»™ST(0)å¯„å­˜å™¨ï¼Œç›¸å½“äºNOPæ“ä½œæ²¡æœ‰å®é™…æ„ä¹‰ã€‚æ¥ç€å®ƒä»æ ˆé‡ŒPOPå‡ºä¸€ä¸ªå€¼ï¼Œä½¿ST(0)çš„å€¼ä¸ºå…ˆå‰ST(1)çš„å€¼ï¼Œä¹Ÿå°±æ˜¯å˜é‡_bã€‚ç„¶åç»“æŸæœ¬å‡½æ•°ã€‚å¤§æ¦‚æ˜¯å› ä¸ºFPUçš„æŒ‡ä»¤é›†é‡Œæ²¡æœ‰POPå¹¶èˆå¼ƒæ ˆé¡¶å€¼çš„æŒ‡ä»¤ï¼Œæ‰€ä»¥æ‰ä¼šå‡ºç°è¿™æ ·çš„æ±‡æŠ¥æŒ‡ä»¤ã€‚</p>
</li>
</ul>
<h3 id="chap18-æ•°ç»„"><a class="markdownIt-Anchor" href="#chap18-æ•°ç»„"></a> Chap18 æ•°ç»„</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> a<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"a[%d]=%d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç”¨msvs 2008 è¿›è¡Œç¼–è¯‘</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_TEXT     SEGMENT
_i<span class="token operator">$</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">84</span>              <span class="token comment">; size = 4</span>
_a<span class="token operator">$</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">80</span>              <span class="token comment">; size = 80</span>
_main      PROC
    push   <span class="token register variable">ebp</span>
    mov    <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
    sub    <span class="token register variable">esp</span>, <span class="token number">84</span>    <span class="token comment">; 00000054H</span>
    mov    DWORD PTR _i<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token number">0</span><span class="token comment">;i=0</span>
    jmp    SHORT <span class="token operator">$</span>LN6@main
<span class="token label function">$LN5@main:</span><span class="token comment">;i+=1 </span>
    mov    <span class="token register variable">eax</span>, DWORD PTR _i<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
    add    <span class="token register variable">eax</span>,  <span class="token number">1</span>
    mov    DWORD PTR _i<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token register variable">eax</span>
<span class="token label function">$LN6@main:</span>
    cmp    DWORD PTR _i<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token number">20</span><span class="token comment">; 00000014H</span>
    jge    SHORT <span class="token operator">$</span>LN4@main
    mov    <span class="token register variable">ecx</span>, DWORD PTR _i<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span><span class="token comment">;i&lt;20</span>
    shl    <span class="token register variable">ecx</span>, <span class="token number">1</span><span class="token comment">;ecx*2=2i</span>
    mov    <span class="token register variable">edx</span>, DWORD PTR _i<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
    mov    DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token register variable">edx</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">ecx</span><span class="token comment">;a[i]=2i</span>
    jmp    SHORT <span class="token operator">$</span>LN5@main
<span class="token label function">$LN4@main:</span><span class="token comment">;i=0</span>
    mov    DWORD PTR _i<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token number">0</span>
    jmp    SHORT <span class="token operator">$</span>LN3@main
<span class="token label function">$LN2@main:</span>
    mov    <span class="token register variable">eax</span>, DWORD PTR _i<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
    add    <span class="token register variable">eax</span>, <span class="token number">1</span>
    mov    DWORD PTR _i<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token register variable">eax</span>
<span class="token label function">$LN3@main:</span><span class="token comment">;for i in range(20) printf(a[i])</span>
    cmp    DWORD PTR _i<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token number">20</span>    <span class="token comment">; 00000014H</span>
    jge    SHORT <span class="token operator">$</span>LN1@main<span class="token comment">;ret</span>
    mov    <span class="token register variable">ecx</span>, DWORD PTR _i<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
    mov    <span class="token register variable">edx</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token register variable">ecx</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>
    push   <span class="token register variable">edx</span>
    mov    <span class="token register variable">eax</span>, DWORD PTR _i<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
    push   <span class="token register variable">eax</span>
    push   OFFSET <span class="token operator">$</span>SG2463
    call   _printf
    add    <span class="token register variable">esp</span>, <span class="token number">12</span>        <span class="token comment">; 0000000cH</span>
    jmp    SHORT <span class="token operator">$</span>LN2@main
<span class="token label function">$LN1@main:</span>
    xor    <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
    mov    <span class="token register variable">esp</span>, <span class="token register variable">ebp</span>
    pop    <span class="token register variable">ebp</span>
    ret    <span class="token number">0</span>
_main      ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>ç¨‹åºä¸ºæ•°ç»„ç”³è¯·äº†80å­—èŠ‚çš„æ ˆç©ºé—´ï¼Œä»¥å­˜å‚¨20ä¸ª4å­—èŠ‚å…ƒç´ ã€‚</li>
<li>å› ä¸ºå…¨éƒ¨æ•°ç»„éƒ½å­˜å‚¨äºæ ˆä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨å†…å­˜æ•°æ®çª—å£é‡Œçœ‹åˆ°æ•´ä¸ªæ•°ç»„ã€‚</li>
</ul>
<hr />
<p>gcc</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">                public main
main            proc near                   <span class="token comment">; DATA XREF: _start+17</span>

var_70          <span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">70h</span>
var_6C          <span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">6Ch</span>
var_68          <span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">68h</span>
i_2             <span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">54h</span>
i               <span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">4</span>

                push     <span class="token register variable">ebp</span>
                mov      <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
                and      <span class="token register variable">esp</span>, <span class="token number">0FFFFFFF0h</span><span class="token comment">;å¯¹é½</span>
                sub      <span class="token register variable">esp</span>, <span class="token number">70h</span>
                mov      <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">70h</span><span class="token operator">+</span>i<span class="token operator">]</span>, <span class="token number">0</span>     <span class="token comment">; i=0</span>
                jmp      short loc_804840A

<span class="token label function">loc_80483F7:</span>
                mov      <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">70h</span><span class="token operator">+</span>i<span class="token operator">]</span>
                mov      <span class="token register variable">edx</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">70h</span><span class="token operator">+</span>i<span class="token operator">]</span>
                add      <span class="token register variable">edx</span>, <span class="token register variable">edx</span>           <span class="token comment">; edx=i*2</span>
                mov      <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token register variable">eax</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">+</span><span class="token number">70h</span><span class="token operator">+</span>i_2<span class="token operator">]</span>, <span class="token register variable">edx</span>
                add      <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">70h</span><span class="token operator">+</span>i<span class="token operator">]</span>, <span class="token number">1</span>     <span class="token comment">;  i++</span>

<span class="token label function">loc_804840A:</span>
                cmp      <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">70h</span><span class="token operator">+</span>i<span class="token operator">]</span>, <span class="token number">13h</span><span class="token comment">;19</span>
                jle      short loc_80483F7<span class="token comment">;i&lt;=19</span>
                mov      <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">70h</span><span class="token operator">+</span>i<span class="token operator">]</span>, <span class="token number">0</span><span class="token comment">;i=0</span>
                jmp      short loc_8048441

<span class="token label function">loc_804841B:</span>
                mov      <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">70h</span><span class="token operator">+</span>i<span class="token operator">]</span>
                mov      <span class="token register variable">edx</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token register variable">eax</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">+</span><span class="token number">70h</span><span class="token operator">+</span>i_2<span class="token operator">]</span>
                mov      <span class="token register variable">eax</span>, offset aADD <span class="token comment">; "a[%d]=%d\n"</span>
                mov      <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">70h</span><span class="token operator">+</span>var_68<span class="token operator">]</span>, <span class="token register variable">edx</span>
                mov      <span class="token register variable">edx</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">70h</span><span class="token operator">+</span>i<span class="token operator">]</span>
                mov      <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">70h</span><span class="token operator">+</span>var_6C<span class="token operator">]</span>, <span class="token register variable">edx</span>
                mov      <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">70h</span><span class="token operator">+</span>var_70<span class="token operator">]</span>, <span class="token register variable">eax</span>
                call     _printf
                add      <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">70h</span><span class="token operator">+</span>i<span class="token operator">]</span>, <span class="token number">1</span>

<span class="token label function">loc_8048441:</span>
                cmp      <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">70h</span><span class="token operator">+</span>i<span class="token operator">]</span>, <span class="token number">13h</span>
                jle      short loc_804841B<span class="token comment">;i&lt;=19</span>
                mov      <span class="token register variable">eax</span>, <span class="token number">0</span>
                leave
                retn
main            endp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p>å®é™…ä¸Šå˜é‡==<em>a</em>çš„æ•°æ®ç±»å‹æ˜¯æ•´å‹æŒ‡é’ˆã€‚ä¸¥æ ¼åœ°è¯´ï¼Œåœ¨æŠŠæ•°ç»„ä¼ é€’ç»™å‡½æ•°çš„æ—¶å€™ï¼Œä¼ é€’çš„æ•°æ®å°±æ˜¯æŒ‡å‘ç¬¬ä¸€ä¸ªå…ƒç´ çš„æŒ‡é’ˆï¼Œæˆ‘ä»¬å†æ ¹æ®è¿™ä¸ªæŒ‡é’ˆå°±å¯ä»¥è½»æ¾åœ°è®¡ç®—å‡ºæ•°ç»„æ¯ä¸ªå…ƒç´ çš„åœ°å€ï¼ˆå³æŒ‡é’ˆï¼‰ã€‚==å¦‚æœä½¿ç”¨a[idx]çš„å½¢å¼è¡¨ç¤ºæ•°ç»„å…ƒç´ ï¼Œå…¶ä¸­idxæ˜¯æ•°ç»„å…ƒç´ åœ¨æ•°ç»„é‡Œçš„æ’åˆ—åºå·ï¼ˆå³ç´¢å¼•å·ï¼‰ï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡æ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ çš„åœ°å€ã€ç´¢å¼•å·å’Œæ•°æ®å®¹é‡æ±‚å¾—å„ä¸ªå…ƒç´ çš„åœ°å€ã€‚</p>
<p>ä¸¾ä¸ªå…¸å‹çš„ä¾‹å­ï¼šå­—ç¬¦ä¸²å¸¸é‡â€œstringâ€æ˜¯å­—ç¬¦å‹æ•°ç»„ï¼Œå®ƒçš„æ¯ä¸ªå­—ç¬¦å…ƒç´ éƒ½æ˜¯const char*å‹æ•°æ®ã€‚ä½¿ç”¨ç´¢å¼•å·ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨â€œstringâ€[i]çš„å½¢å¼æè¿°å­—ç¬¦ä¸²ä¸­çš„ç¬¬<em>i</em>ä¸ªå­—ç¬¦â€”â€”è¿™æ­£æ˜¯C/Cï¼‹ï¼‹è¡¨è¾¾å¼çš„è¡¨ç¤ºæ–¹æ³•ï¼</p>
</li>
</ul>
<h4 id="ç¼“å†²åŒºæº¢å‡º"><a class="markdownIt-Anchor" href="#ç¼“å†²åŒºæº¢å‡º"></a> ç¼“å†²åŒºæº¢å‡º</h4>
<p>ä»æ±‡ç¼–ä»£ç å¯ä»¥çœ‹å‡º:ç¼–è¯‘å™¨æ²¡æœ‰å¯¹ç´¢å¼•è¿›è¡Œåˆ¤æ–­ï¼Œ</p>
<p>å¯ä»¥è®¿é—®a[20]</p>
<hr />
<p>å‘æ•°ç»„è¾¹ç•Œä¹‹å¤–çš„åœ°å€èµ‹å€¼</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> a<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i<span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">30</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
                 a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>i<span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç¨‹åºå‘ç”Ÿäº†å´©æºƒ</p>
<p>ä½¿ç”¨onlydbgåŠ è½½ï¼Œè·Ÿè¸ªç¨‹åºå´©æºƒåŸå› </p>
<ul>
<li>
<p>å½“30ä¸ªå¾ªç¯ç»“æŸåï¼Œ<code>EIP</code>çš„å€¼æ˜¯0x15ï¼Œæ˜¾ç„¶ä¸åˆæ³•ï¼Œæ­¤æ—¶<code>EBP</code>ä¸º0x14ï¼Œ<code>ECX</code>å’Œ<code>EDX</code>å€¼ä¸º0x1D</p>
<p>Why?</p>
</li>
<li>
<p>é¦–å…ˆå›é¡¾æ ˆçš„ç»“æ„</p>
<p>ï¼Œmain()å‡½æ•°çš„æ ˆç»“æ„å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>ESP</th>
<th><em>i</em>æ‰€å ç”¨çš„4å­—èŠ‚</th>
</tr>
</thead>
<tbody>
<tr>
<td>ESP+4</td>
<td><em>a</em>[20]å ç”¨çš„80å­—èŠ‚</td>
</tr>
<tr>
<td>ESP+84</td>
<td>ä¿å­˜è¿‡çš„EBP</td>
</tr>
<tr>
<td>ESP+88</td>
<td>è¿”å›åœ°å€</td>
</tr>
</tbody>
</table>
<p>èµ‹å€¼ç»™<em>a</em>[19]çš„æ—¶å€™ï¼Œæ•°ç»„<em>a</em>[]å·²ç»è¢«å…¨éƒ¨èµ‹å€¼ã€‚</p>
<p>èµ‹å€¼ç»™a[20]å®é™…ä¸Šä¿®æ”¹çš„æ˜¯æ ˆé‡Œä¿å­˜çš„<code>EBP</code>ï¼Œæœ¬ä¾‹ä¸­å°†20èµ‹å€¼äº†ç»™a[10],å‡½æ•°é€€å‡ºä¹‹å‰ä¼šå°†ebpè®¾ç½®ä¸ºè¿™ä¸ªå€¼ï¼Œå› æ­¤ebpä¸º0x14</p>
<p>æœ€åè¿è¡Œ<code>RET</code>æŒ‡ä»¤ï¼Œç›¸å½“äº<code>POP EIP</code>ï¼Œ<code>RET</code>æŒ‡ä»¤å°†ç¨‹åºçš„æ§åˆ¶æƒä¼ é€’ç»™æ ˆé‡Œçš„è¿”å›åœ°å€ï¼Œä¸è¿‡æ­¤æ—¶è¿™ä¸ªå€¼ä¸º0x15ï¼Œè¿™é‡Œæ²¡æœ‰å¯æ‰§è¡Œä»£ç ï¼Œå› æ­¤å´©æºƒ</p>
</li>
<li>
<p>äº‹å®ä¸Šï¼Œè¿™å°±æ˜¯ç¼“å†²åŒºæº¢å‡ºæ”»å‡»çš„åŸç†ï¼Œæˆ‘ä»¬å¯ä»¥åŠ«æŒè¿”å›åœ°å€æ¥æ§åˆ¶eipæ¥è·³è½¬åˆ°å…¶ä»–ç¨‹åºçš„åœ°å€</p>
<p>ç›®å‰å·²ç»æœ‰äº†å¾ˆå¤šæ‰‹æ®µæ¥é˜²å¾¡è¿™ç§æ”»å‡»ï¼Œå­¦pwnçš„æ—¶å€™å†æ·±å…¥äº†è§£</p>
<ul>
<li>
<p>canaryï¼Œéšæœºå†™å…¥éšæœºæ•°ï¼Œåœ¨å‡½æ•°ç»“æŸä¹‹å‰æ£€æŸ¥è¿™äº›å€¼æ˜¯å¦å‘ç”Ÿå˜åŒ–</p>
</li>
<li>
<p>å¦‚æœå¯ç”¨MSVCçš„RTC1å’ŒRTCsé€‰é¡¹ç¼–è¯‘æœ¬ç« å¼€å¤´çš„é‚£æ®µç¨‹åºï¼Œå°±ä¼šåœ¨æ±‡ç¼–æŒ‡ä»¤é‡Œçœ‹åˆ°å‡½æ•°åœ¨é€€å‡ºä¹‹å‰è°ƒç”¨@_RTC_CheckStackVars@8ï¼Œç”¨ä»¥æ£€æµ‹â€œç™¾çµé¸Ÿâ€æ˜¯å¦ä¼šæŠ¥è­¦ã€‚</p>
</li>
<li>
<p>ç”¨gccç¼–è¯‘</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">		mov     <span class="token register variable">eax</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">]</span>
        xor     <span class="token register variable">eax</span>, DWORD PTR <span class="token register variable">gs</span>:<span class="token number">20</span>ï¼› 
        jne     .L5
        mov     <span class="token register variable">ebx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
<span class="token label function">.L5:</span>
        call    __stack_chk_fail<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ˜¾ç„¶éšæœºå€¼ä½äºgsï¼š20,</p>
</li>
</ul>
</li>
<li>
<p>gså¼€å¤´çš„å¯„å­˜å™¨å°±æ˜¯å¸¸è¯´çš„æ®µå¯„å­˜å™¨ã€‚åœ¨MS-DOSå’ŒåŸºäºDOSçš„ç³»ç»Ÿé‡Œï¼Œæ®µå¯„å­˜å™¨çš„ä½œç”¨å¾ˆå¹¿æ³›ã€‚ä½†æ˜¯ï¼Œä»Šå¤©å®ƒçš„ä½œç”¨å‘ç”Ÿäº†å˜åŒ–ã€‚ç®€å•åœ°è¯´ï¼ŒLinuxä¸‹çš„gs å¯„å­˜å™¨æ€»æ˜¯æŒ‡å‘TLSï¼ˆå‚è§ç¬¬65ç« ï¼‰â€”â€”å­˜å‚¨çº¿ç¨‹çš„å¤šç§ç‰¹å®šä¿¡æ¯ã€‚ï¼ˆWin32ç¯å¢ƒä¸‹çš„fså¯„å­˜å™¨èµ·åˆ°Linuxä¸‹gså¯„å­˜å™¨çš„ä½œç”¨ã€‚Win32çš„fså¯„å­˜å™¨æŒ‡å‘TIBï¼‰</p>
</li>
</ul>
<h4 id="å…¶ä»–"><a class="markdownIt-Anchor" href="#å…¶ä»–"></a> å…¶ä»–</h4>
<p>ç°åœ¨æˆ‘ä»¬åº”è¯¥å¯ä»¥ç†è§£ä¸ºä»€ä¹ˆC/C++ç¼–è¯‘ä¸äº†ä¸‹é¢çš„ç¨‹åºäº†ã€‚</p>
<pre class="line-numbers language-none"><code class="language-none">void f(int size)
&#123;
    int a[size];
...
&#125;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><mark>åœ¨ç¼–è¯‘é˜¶æ®µï¼Œç¼–è¯‘å™¨å¿…é¡»ç¡®åˆ‡åœ°çŸ¥é“éœ€è¦ç»™æ•°ç»„åˆ†é…å¤šå¤§çš„å­˜å‚¨ç©ºé—´ï¼Œå®ƒéœ€è¦äº‹å…ˆæ˜ç¡®åˆ†é…å±€éƒ¨æ ˆæˆ–æ•°æ®æ®µï¼ˆå…¨å±€å˜é‡ï¼‰çš„æ ¼å±€ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨æ— æ³•å¤„ç†ä¸Šè¿°è¿™ç§é•¿åº¦å¯å˜çš„æ•°ç»„ã€‚</mark></p>
<p>å¦‚æœæ— æ³•äº‹å…ˆç¡®å®šæ•°ç»„çš„é•¿åº¦ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±åº”å½“ä½¿ç”¨malloc()å‡½æ•°åˆ†é…å‡ºä¸€å—å†…å­˜ï¼Œç„¶åç›´æ¥æŒ‰ç…§å¸¸è§„å˜é‡æ•°ç»„çš„æ–¹å¼è®¿é—®è¿™å—å†…å­˜ï¼›æˆ–è€…éµå¾ªC99æ ‡å‡†ï¼ˆå‚è§ISO07ï¼Œ6.7.5/2ï¼‰è¿›è¡Œå¤„ç†ï¼Œä½†æ˜¯éµå¾ªC99æ ‡å‡†è€Œè®¾è®¡å‡ºæ¥çš„ç¨‹åºï¼Œå†…éƒ¨å®ç°çš„æ–¹æ³•æ›´æ¥è¿‘alloca()å‡½æ•°ï¼ˆè¯¦æƒ…è¯·å‚é˜…5.2.4èŠ‚ï¼‰ã€‚</p>
<h4 id="å­—ç¬¦ä¸²æŒ‡é’ˆ"><a class="markdownIt-Anchor" href="#å­—ç¬¦ä¸²æŒ‡é’ˆ"></a> å­—ç¬¦ä¸²æŒ‡é’ˆ</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> month1<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span>
<span class="token punctuation">&#123;</span>
        <span class="token string">"January"</span><span class="token punctuation">,</span>
        <span class="token string">"February"</span><span class="token punctuation">,</span>
        <span class="token string">"March"</span><span class="token punctuation">,</span>
        <span class="token string">"April"</span><span class="token punctuation">,</span>
        <span class="token string">"May"</span><span class="token punctuation">,</span>
        <span class="token string">"June"</span><span class="token punctuation">,</span>
        <span class="token string">"July"</span><span class="token punctuation">,</span>
        <span class="token string">"August"</span><span class="token punctuation">,</span>
        <span class="token string">"September"</span><span class="token punctuation">,</span>
        <span class="token string">"October"</span><span class="token punctuation">,</span>
        <span class="token string">"November"</span><span class="token punctuation">,</span>
        <span class="token string">"December"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// in 0..11 range</span>
<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">get_month1</span> <span class="token punctuation">(</span><span class="token keyword">int</span> month<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> month1<span class="token punctuation">[</span>month<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr />
<p>msvs x64</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_DATA   SEGMENT
month1  DQ      FLAT:<span class="token operator">$</span>SG3122
        DQ      FLAT:<span class="token operator">$</span>SG3123
        DQ      FLAT:<span class="token operator">$</span>SG3124
        DQ      FLAT:<span class="token operator">$</span>SG3125
        DQ      FLAT:<span class="token operator">$</span>SG3126
        DQ      FLAT:<span class="token operator">$</span>SG3127
        DQ      FLAT:<span class="token operator">$</span>SG3128
        DQ      FLAT:<span class="token operator">$</span>SG3129
        DQ      FLAT:<span class="token operator">$</span>SG3130
        DQ      FLAT:<span class="token operator">$</span>SG3131
        DQ      FLAT:<span class="token operator">$</span>SG3132
        DQ      FLAT:<span class="token operator">$</span>SG3133
<span class="token operator">$</span>SG3122 DB     <span class="token string">'January'</span>, <span class="token number">00H</span>
<span class="token operator">$</span>SG3123 DB     <span class="token string">'February'</span>, <span class="token number">00H</span>
<span class="token operator">$</span>SG3124 DB     <span class="token string">'March'</span>, <span class="token number">00H</span>
<span class="token operator">$</span>SG3125 DB     <span class="token string">'April'</span>, <span class="token number">00H</span>
<span class="token operator">$</span>SG3126 DB     <span class="token string">'May'</span>, <span class="token number">00H</span>
<span class="token operator">$</span>SG3127 DB     <span class="token string">'June'</span>, <span class="token number">00H</span>
<span class="token operator">$</span>SG3128 DB     <span class="token string">'July'</span>, <span class="token number">00H</span>
<span class="token operator">$</span>SG3129 DB     <span class="token string">'August'</span>, <span class="token number">00H</span>
<span class="token operator">$</span>SG3130 DB     <span class="token string">'September'</span>, <span class="token number">00H</span>
<span class="token operator">$</span>SG3156 DB     <span class="token string">'%s'</span>, <span class="token number">0aH</span>, <span class="token number">00H</span>
<span class="token operator">$</span>SG3131 DB     <span class="token string">'October'</span>, <span class="token number">00H</span>
<span class="token operator">$</span>SG3132 DB     <span class="token string">'November'</span>, <span class="token number">00H</span>
<span class="token operator">$</span>SG3133 DB     <span class="token string">'December'</span>, <span class="token number">00H</span>
_DATA   ENDS

month<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>
get_month1 PROC
         movsxd  <span class="token register variable">rax</span>, <span class="token register variable">ecx</span>
         lea     <span class="token register variable">rcx</span>, OFFSET FLAT:month1
         mov     <span class="token register variable">rax</span>, QWORD PTR <span class="token operator">[</span><span class="token register variable">rcx</span><span class="token operator">+</span><span class="token register variable">rax</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">]</span>
         ret     <span class="token number">0</span>
get_month1 ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><mark>MOVSXD</mark>æŠŠECXçš„32ä½æ•´å‹æ•°å€¼ã€è¿åŒå…¶ç¬¦å·æ‰©å±•ä½(sign-extension)æ‰©å±•ä¸º64ä½æ•´å‹æ•°æ®ï¼Œå†å­˜å‚¨äºRAXå¯„å­˜å™¨ä¸­ã€‚ECXå­˜å‚¨çš„â€œæœˆä»½â€ä¿¡æ¯æ˜¯32ä½æ•´å½¢æ•°æ®ã€‚å› ä¸ºç¨‹åºéšåè¿˜è¦è¿›è¡Œ64ä½è¿ç®—ï¼Œæ‰€ä»¥éœ€è¦æŠŠè¾“å…¥å˜é‡è½¬æ¢ä¸º64ä½å€¼ã€‚</li>
<li>ç„¶åå‡½æ•°æŠŠ<code>æŒ‡é’ˆè¡¨çš„åœ°å€å­˜å‚¨äºRCXå¯„å­˜å™¨ã€‚</code></li>
<li>æœ€åï¼Œå‡½æ•°çš„è¾“<code>å…¥å˜é‡(month)çš„å€¼ä¹˜ä»¥8ã€å†ä¸æŒ‡é’ˆè¡¨çš„åœ°å€ç›¸åŠ </code>ã€‚å› ä¸ºæ˜¯64ä½ç³»ç»Ÿçš„ç¼˜æ•…ï¼Œæ¯ä¸ªåœ°å€ï¼ˆå³æŒ‡é’ˆï¼‰çš„æ•°æ®éœ€è¦å ç”¨64ä½ï¼ˆå³8å­—èŠ‚ï¼‰ã€‚æ‰€ä»¥æŒ‡é’ˆè¡¨ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½å ç”¨8å­—èŠ‚ç©ºé—´ã€‚å› æ­¤ï¼Œæœ€ç»ˆå­—ç¬¦ä¸²çš„åœ°å€è¦åŠ ä¸Šmonth*8ã€‚MOVæŒ‡ä»¤ä¸ä»…å®Œæˆäº†å­—ç¬¦ä¸²åœ°å€çš„è®¡ç®—ï¼Œè€Œä¸”è¿˜å®Œæˆäº†æŒ‡é’ˆè¡¨çš„æŸ¥è¯¢ã€‚åœ¨è¾“å…¥å€¼ä¸º1æ—¶ï¼Œå‡½æ•°å°†è¿”å›å­—ç¬¦ä¸²â€œFebruaryâ€çš„æŒ‡é’ˆåœ°å€ã€‚</li>
</ul>
<hr />
<p><code>Optimizing gcc</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">movsx   <span class="token register variable">rdi</span>, <span class="token register variable">edi</span>
     mov     <span class="token register variable">rax</span>, QWORD PTR month1<span class="token operator">[</span><span class="token number">0</span><span class="token operator">+</span><span class="token register variable">rdi</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">]</span>
     ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<hr />
<p><code>Optimizing MSVS</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_month<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>
_get_month1 PROC
        mov     <span class="token register variable">eax</span>, DWORD PTR _month<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
        mov     <span class="token register variable">eax</span>, DWORD PTR _month1<span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>
        ret     <span class="token number">0</span>
_get_month1 ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>32ä½ç¨‹åºå°±ä¸ç”¨æŠŠè¾“å…¥å€¼è½¬åŒ–ä¸º64ä½æ•°æ®äº†ã€‚æ­¤å¤–ï¼Œ32ä½ç³»ç»Ÿçš„æŒ‡é’ˆå±äº4å­—èŠ‚æ•°æ®ï¼Œæ‰€ä»¥ç›¸å…³çš„è®¡ç®—å› å­å˜ä¸ºäº†4ã€‚</p>
<h4 id="å¤šç»´æ•°ç»„"><a class="markdownIt-Anchor" href="#å¤šç»´æ•°ç»„"></a> å¤šç»´æ•°ç»„</h4>
<p>è®¡ç®—æœºå†…å­˜æ˜¯è¿ç»­çš„çº¿æ€§ç©ºé—´ï¼Œå®ƒå¯ä»¥ä¸ä¸€ç»´æ•°ç»„ç›´æ¥å¯¹åº”ã€‚åœ¨è¢«æ‹†åˆ†æˆå¤šä¸ªä¸€ç»´æ•°ç»„ä¹‹åï¼Œå¤šç»´æ•°ç»„ä¸å†…æ ˆçº¿æ€§ç©ºé—´åŒæ ·å­˜åœ¨ç›´æ¥å¯¹åº”çš„å­˜å‚¨å…³ç³»ã€‚</p>
<table>
<thead>
<tr>
<th>å­˜å‚¨åœ°å€</th>
<th>æ•°ç»„å…ƒç´ </th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>[0] [0]</td>
</tr>
<tr>
<td>1</td>
<td>[0] [1]</td>
</tr>
<tr>
<td>2</td>
<td>[0] [2]</td>
</tr>
<tr>
<td>3</td>
<td>[0] [3]</td>
</tr>
<tr>
<td>4</td>
<td>[1] [0]</td>
</tr>
<tr>
<td>5</td>
<td>[1] [1]</td>
</tr>
<tr>
<td>6</td>
<td>[1] [2]</td>
</tr>
<tr>
<td>7</td>
<td>[1] [3]</td>
</tr>
<tr>
<td>8</td>
<td>[2] [0]</td>
</tr>
<tr>
<td>9</td>
<td>[2] [1]</td>
</tr>
<tr>
<td>10</td>
<td>[2] [2]</td>
</tr>
<tr>
<td>11</td>
<td>[2] [3]</td>
</tr>
</tbody>
</table>
<p>åœ¨å†…å­˜ä¹‹ä¸­ï¼Œ3Ã—4çš„äºŒç»´æ•°ç»„å°†ä¾æ¬¡å­˜å‚¨ä¸ºè¿ç»­çš„12ä¸ªå…ƒç´ ï¼Œå¦‚è¡¨18.2æ‰€ç¤ºã€‚</p>
<p>åœ¨<code>è®¡ç®—ä¸Šè¿°æ•°ç»„ä¸­æŸä¸ªç‰¹å®šå…ƒç´ çš„å†…å­˜å­˜å‚¨ç¼–å·æ—¶ï¼Œå¯ä»¥å…ˆå°†äºŒç»´ç´¢å¼•å·çš„ç¬¬ä¸€ä¸ªç´¢å¼•å·ä¹˜ä»¥4ï¼ˆçŸ©é˜µå®½åº¦ï¼‰ï¼Œè€ŒååŠ ä¸Šç¬¬äºŒä¸ªç´¢å¼•å·ã€‚</code>è¿™ç§æ–¹å¼å°±æ˜¯C/C++ã€Pythonæ‰€ç”¨çš„â€œè¡Œä¼˜å…ˆçš„é¡ºåºâ€ï¼ˆrow-majororderï¼‰ã€‚<mark>æ‰€è°“è¡Œä¼˜å…ˆï¼Œå°±æ˜¯å…ˆç”¨ç¬¬ä¸€è¡Œæ’æ»¡ç¬¬ä¸€ä¸ªç´¢å¼•å·ä¸‹çš„æ‰€æœ‰å…ƒç´ ï¼Œç„¶åå†ä¾æ¬¡ç¼–æ’å…¶ä»–å„è¡Œã€‚</mark></p>
<p><code>ä»æ€§èƒ½åŠç¼“å­˜çš„è§’åº¦æ¥çœ‹ï¼Œä¸æ•°æ®çš„å­˜å‚¨æ–¹æ¡ˆï¼ˆscheme)å’Œç»„ç»‡æ–¹å¼ï¼ˆdata organizationï¼‰åŒ¹é…çš„ä¼˜å…ˆé¡ºåºæœ€ä¼˜</code>ã€‚åªè¦ç›¸äº’åŒ¹é…ï¼Œé‚£ä¹ˆç¨‹åºå°±å¯ä»¥è¿ç»­è®¿é—®æ•°æ®ï¼Œæ•´ä½“æ€§èƒ½å°±ä¼šæé«˜ã€‚æ‰€ä»¥ï¼Œå¦‚æœç¨‹åºä»¥â€œé€è¡Œâ€çš„æ–¹å¼è®¿é—®æ•°æ®ï¼Œé‚£ä¹ˆå°±åº”å½“ä»¥è¡Œä¼˜å…ˆçš„é¡ºåºç»„ç»‡æ•°ç»„ï¼›åä¹‹äº¦ç„¶ã€‚</p>
<hr />
<p>æ˜¾ç„¶æ ¹æ®è¿™ç§è§„åˆ™æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä¸€ç»´æ•°ç»„çš„æ–¹å¼è®¿é—®äºŒç»´æ•°ç»„</p>
<p>ä¾‹å¦‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">char</span> a<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">char</span> <span class="token function">get_by_coordinates1</span> <span class="token punctuation">(</span><span class="token keyword">char</span> array<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> array<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">char</span> <span class="token function">get_by_coordinates2</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>array<span class="token punctuation">,</span> <span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        <span class="token comment">// treat input array as one-dimensional</span>
        <span class="token comment">// 4 is array width here</span>
        <span class="token keyword">return</span> array<span class="token punctuation">[</span>a<span class="token operator">*</span><span class="token number">4</span><span class="token operator">+</span>b<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">char</span> <span class="token function">get_by_coordinates3</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>array<span class="token punctuation">,</span> <span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        <span class="token comment">// treat input array as pointer,</span>
        <span class="token comment">// calculate address, get value at it</span>
        <span class="token comment">// 4 is array width here</span>
        <span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span>array<span class="token operator">+</span>a<span class="token operator">*</span><span class="token number">4</span><span class="token operator">+</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> <span class="token function">get_by_coordinates1</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> <span class="token function">get_by_coordinates2</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> <span class="token function">get_by_coordinates3</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr />
<p><code>Optimizing gcc</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token comment">; RDI=address of array</span>
<span class="token comment">; RSI=a</span>
<span class="token comment">; RDX=b</span>

<span class="token label function">get_by_coordinates1:</span>
<span class="token comment">; sign-extend input 32-bit int values "a" and "b" to 64-bit ones</span>
        movsx   <span class="token register variable">rsi</span>, <span class="token register variable">esi</span>
        movsx   <span class="token register variable">rdx</span>, <span class="token register variable">edx</span>
        lea     <span class="token register variable">rax</span>, <span class="token operator">[</span><span class="token register variable">rdi</span><span class="token operator">+</span><span class="token register variable">rsi</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>
<span class="token comment">; RAX=RDI+RSI*4=address of array+a*4</span>
        movzx   <span class="token register variable">eax</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">rax</span><span class="token operator">+</span><span class="token register variable">rdx</span><span class="token operator">]</span>
<span class="token comment">; AL=load byte at address RAX+RDX=address of array+a*4+b</span>
        ret

<span class="token label function">get_by_coordinates2:</span>
        lea     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">rdx</span><span class="token operator">+</span><span class="token register variable">rsi</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>
<span class="token comment">; RAX=RDX+RSI*4=b+a*4</span>
        cdqe
        movzx   <span class="token register variable">eax</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">rdi</span><span class="token operator">+</span><span class="token register variable">rax</span><span class="token operator">]</span>
<span class="token comment">; AL=load byte at address RDI+RAX=address of array+b+a*4</span>
        ret

<span class="token label function">get_by_coordinates3:</span>
        sal     <span class="token register variable">esi</span>, <span class="token number">2</span>
<span class="token comment">; ESI=a&lt;&lt;2=a*4</span>
<span class="token comment">; sign-extend input 32-bit int values "a*4" and "b" to 64-bit ones</span>
        movsx   <span class="token register variable">rdx</span>, <span class="token register variable">edx</span>
        movsx   <span class="token register variable">rsi</span>, <span class="token register variable">esi</span>
        add     <span class="token register variable">rdi</span>, <span class="token register variable">rsi</span>
<span class="token comment">; RDI=RDI+RSI=address of array+a*4</span>
        movzx   <span class="token register variable">eax</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">rdi</span><span class="token operator">+</span><span class="token register variable">rdx</span><span class="token operator">]</span>
<span class="token comment">; AL=load byte at address RDI+RDX=address of array+a*4+b</span>
        ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸‰è€…æ±‡ç¼–å¾ˆæ¥è¿‘å¹¶ä¸”è®¡ç®—çš„ä¸‹æ ‡æ˜¯ä¸€æ ·çš„</p>
<hr />
<p>å¤šç»´æ•°ç»„çš„æƒ…å†µä¹Ÿå·®ä¸å¤šï¼Œä¾‹å¦‚ä¸‰ç»´</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">int</span> a<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">insert</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> <span class="token keyword">int</span> z<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        a<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>z<span class="token punctuation">]</span><span class="token operator">=</span>value<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>msvs x86</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_DATA      SEGMENT
COMM       _a:DWORD:<span class="token number">01770H</span>
_DATA      ENDS
PUBLIC     _insert
_TEXT      SEGMENT
_x<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>               <span class="token comment">; size = 4</span>
_y<span class="token operator">$</span><span class="token operator">=</span><span class="token number">12</span>                <span class="token comment">; size = 4</span>
_z<span class="token operator">$</span><span class="token operator">=</span><span class="token number">16</span>                <span class="token comment">; size = 4</span>
_value<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">20</span>          <span class="token comment">; size = 4</span>
_insert     PROC
    push    <span class="token register variable">ebp</span>
    mov     <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
    mov     <span class="token register variable">eax</span>, DWORD PTR _x<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
    imul    <span class="token register variable">eax</span>, <span class="token number">2400</span>                <span class="token comment">; eax=600*4*x</span>
    mov     <span class="token register variable">ecx</span>, DWORD PTR _y<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
    imul    <span class="token register variable">ecx</span>, <span class="token number">120</span>                 <span class="token comment">; ecx=30*4*y</span>
    lea     <span class="token register variable">edx</span>, DWORD PTR _a<span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token register variable">ecx</span><span class="token operator">]</span><span class="token comment">; edx=a + 600*4*x + 30*4*y</span>
    mov     <span class="token register variable">eax</span>, DWORD PTR _z<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
    mov     <span class="token register variable">ecx</span>, DWORD PTR _value<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
    mov     DWORD PTR <span class="token operator">[</span><span class="token register variable">edx</span><span class="token operator">+</span><span class="token register variable">eax</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">ecx</span><span class="token comment">; *(edx+z*4)=value</span>
    pop     <span class="token register variable">ebp</span>
    ret     <span class="token number">0</span>
_insert     ENDP
_TEXT       ENDS<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ•°ç»„å…ƒç´ åœ°å€=600Ã—4<em>x</em> + 30Ã—4<em>y</em> + 4<em>z</em>ã€‚32ä½ç³»ç»Ÿé‡Œintç±»å‹æ˜¯32ä½ï¼ˆ4å­—èŠ‚ï¼‰æ•°æ®ï¼Œæ‰€ä»¥è¦æ¯é¡¹éƒ½è¦ä¹˜ä»¥4ã€‚</p>
<hr />
<p><code>gcc</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">           public  insert
insert     proc near

x          <span class="token operator">=</span> dword ptr <span class="token number">8</span>
y          <span class="token operator">=</span> dword ptr  <span class="token number">0Ch</span>
z          <span class="token operator">=</span> dword ptr  <span class="token number">10h</span>
value      <span class="token operator">=</span> dword ptr  <span class="token number">14h</span>

           push    <span class="token register variable">ebp</span>
           mov     <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
           push    <span class="token register variable">ebx</span>
           mov     <span class="token register variable">ebx</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>x<span class="token operator">]</span><span class="token comment">;ebx=x</span>
           mov     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>y<span class="token operator">]</span><span class="token comment">;eax=y</span>
           mov     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>z<span class="token operator">]</span><span class="token comment">;ecx=z</span>
           lea     <span class="token register variable">edx</span>, <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token register variable">eax</span><span class="token operator">]</span>              <span class="token comment">; edx=y*2</span>
           mov     <span class="token register variable">eax</span>, <span class="token register variable">edx</span>                    <span class="token comment">; eax=y*2</span>
           shl     <span class="token register variable">eax</span>, <span class="token number">4</span>                      <span class="token comment">; eax=(y*2)&lt;&lt;4 = y*2*16 = y*32</span>
           sub     <span class="token register variable">eax</span>, <span class="token register variable">edx</span>                    <span class="token comment">; eax=y*32 - y*2=y*30</span>
           imul    <span class="token register variable">edx</span>, <span class="token register variable">ebx</span>, <span class="token number">600</span>               <span class="token comment">; edx=x*600</span>
           add     <span class="token register variable">eax</span>, <span class="token register variable">edx</span>                    <span class="token comment">; eax=eax+edx=y*30 + x*600</span>
           lea     <span class="token register variable">edx</span>, <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token register variable">ecx</span><span class="token operator">]</span>              <span class="token comment">; edx=y*30 + x*600 + z</span>
           mov     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>value<span class="token operator">]</span>
           mov     dword ptr <span class="token register variable">ds</span>:a<span class="token operator">[</span><span class="token register variable">edx</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">eax</span>  <span class="token comment">; *(a+edx*4)=value</span>
           pop     <span class="token register variable">ebx</span>
           pop     <span class="token register variable">ebp</span>
           retn
insert     endp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>gccåœ¨è®¡ç®—30yè¿›è¡Œäº†ä¼˜åŒ–;(<em>y</em> + <em>y</em>) &lt;&lt; 4 âˆ’ (<em>y</em> + <em>y</em>) = (2 <em>y</em>)&lt;&lt; 4 âˆ’ 2 <em>y</em> = 2Ã—16<em>y</em> âˆ’ 2 <em>y</em> = 32 <em>y</em> âˆ’ 2 <em>y</em> = 30 <em>y</em></li>
</ul>
<hr />
<p>è®¡ç®—æœºçš„æ˜¾ç¤ºå±å¹•æ˜¯ä¸€ä¸ª2Dæ˜¾ç¤ºç©ºé—´ï¼Œä½†æ˜¯æ˜¾å­˜å´æ˜¯ä¸€ä¸ªä¸€ç»´çº¿æ€§æ•°ç»„ã€‚</p>
<h4 id="äºŒç»´å­—ç¬¦ä¸²æ•°ç»„çš„å°è£…æ ¼å¼"><a class="markdownIt-Anchor" href="#äºŒç»´å­—ç¬¦ä¸²æ•°ç»„çš„å°è£…æ ¼å¼"></a> äºŒç»´å­—ç¬¦ä¸²æ•°ç»„çš„å°è£…æ ¼å¼</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;assert.h></span></span>

<span class="token keyword">const</span> <span class="token keyword">char</span> month2<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token operator">=</span>
<span class="token punctuation">&#123;</span>
        <span class="token punctuation">&#123;</span> <span class="token char">'J'</span><span class="token punctuation">,</span><span class="token char">'a'</span><span class="token punctuation">,</span><span class="token char">'n'</span><span class="token punctuation">,</span><span class="token char">'u'</span><span class="token punctuation">,</span><span class="token char">'a'</span><span class="token punctuation">,</span><span class="token char">'r'</span><span class="token punctuation">,</span><span class="token char">'y'</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#123;</span> <span class="token char">'F'</span><span class="token punctuation">,</span><span class="token char">'e'</span><span class="token punctuation">,</span><span class="token char">'b'</span><span class="token punctuation">,</span><span class="token char">'r'</span><span class="token punctuation">,</span><span class="token char">'u'</span><span class="token punctuation">,</span><span class="token char">'a'</span><span class="token punctuation">,</span><span class="token char">'r'</span><span class="token punctuation">,</span><span class="token char">'y'</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#123;</span> <span class="token char">'M'</span><span class="token punctuation">,</span><span class="token char">'a'</span><span class="token punctuation">,</span><span class="token char">'r'</span><span class="token punctuation">,</span><span class="token char">'c'</span><span class="token punctuation">,</span><span class="token char">'h'</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#123;</span> <span class="token char">'A'</span><span class="token punctuation">,</span><span class="token char">'p'</span><span class="token punctuation">,</span><span class="token char">'r'</span><span class="token punctuation">,</span><span class="token char">'i'</span><span class="token punctuation">,</span><span class="token char">'l'</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#123;</span> <span class="token char">'M'</span><span class="token punctuation">,</span><span class="token char">'a'</span><span class="token punctuation">,</span><span class="token char">'y'</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#123;</span> <span class="token char">'J'</span><span class="token punctuation">,</span><span class="token char">'u'</span><span class="token punctuation">,</span><span class="token char">'n'</span><span class="token punctuation">,</span><span class="token char">'e'</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#123;</span> <span class="token char">'J'</span><span class="token punctuation">,</span><span class="token char">'u'</span><span class="token punctuation">,</span><span class="token char">'l'</span><span class="token punctuation">,</span><span class="token char">'y'</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#123;</span> <span class="token char">'A'</span><span class="token punctuation">,</span><span class="token char">'u'</span><span class="token punctuation">,</span><span class="token char">'g'</span><span class="token punctuation">,</span><span class="token char">'u'</span><span class="token punctuation">,</span><span class="token char">'s'</span><span class="token punctuation">,</span><span class="token char">'t'</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#123;</span> <span class="token char">'S'</span><span class="token punctuation">,</span><span class="token char">'e'</span><span class="token punctuation">,</span><span class="token char">'p'</span><span class="token punctuation">,</span><span class="token char">'t'</span><span class="token punctuation">,</span><span class="token char">'e'</span><span class="token punctuation">,</span><span class="token char">'m'</span><span class="token punctuation">,</span><span class="token char">'b'</span><span class="token punctuation">,</span><span class="token char">'e'</span><span class="token punctuation">,</span><span class="token char">'r'</span><span class="token punctuation">,</span>  <span class="token number">0</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#123;</span> <span class="token char">'O'</span><span class="token punctuation">,</span><span class="token char">'c'</span><span class="token punctuation">,</span><span class="token char">'t'</span><span class="token punctuation">,</span><span class="token char">'o'</span><span class="token punctuation">,</span><span class="token char">'b'</span><span class="token punctuation">,</span><span class="token char">'e'</span><span class="token punctuation">,</span><span class="token char">'r'</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#123;</span> <span class="token char">'N'</span><span class="token punctuation">,</span><span class="token char">'o'</span><span class="token punctuation">,</span><span class="token char">'v'</span><span class="token punctuation">,</span><span class="token char">'e'</span><span class="token punctuation">,</span><span class="token char">'m'</span><span class="token punctuation">,</span><span class="token char">'b'</span><span class="token punctuation">,</span><span class="token char">'e'</span><span class="token punctuation">,</span><span class="token char">'r'</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#123;</span> <span class="token char">'D'</span><span class="token punctuation">,</span><span class="token char">'e'</span><span class="token punctuation">,</span><span class="token char">'c'</span><span class="token punctuation">,</span><span class="token char">'e'</span><span class="token punctuation">,</span><span class="token char">'m'</span><span class="token punctuation">,</span><span class="token char">'b'</span><span class="token punctuation">,</span><span class="token char">'e'</span><span class="token punctuation">,</span><span class="token char">'r'</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// in 0..11 range</span>
<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">get_month2</span> <span class="token punctuation">(</span><span class="token keyword">int</span> month<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>month2<span class="token punctuation">[</span>month<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>Optimizing msvs</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">month2  DB      <span class="token number">04aH</span>
        DB      <span class="token number">061H</span>
        DB      <span class="token number">06eH</span>
        DB      <span class="token number">075H</span>
        DB      <span class="token number">061H</span>
        DB      <span class="token number">072H</span>
        DB      <span class="token number">079H</span>
        DB      <span class="token number">00H</span>
        DB      <span class="token number">00H</span>
        DB      <span class="token number">00H</span>
...
get_month2 PROC
<span class="token comment">; sign-extend input argument and promote to 64-bit value</span>
        movsxd  <span class="token register variable">rax</span>, <span class="token register variable">ecx</span>
        lea     <span class="token register variable">rcx</span>, QWORD PTR <span class="token operator">[</span><span class="token register variable">rax</span><span class="token operator">+</span><span class="token register variable">rax</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>
<span class="token comment">; RCX=month+month*4=month*5</span>
        lea     <span class="token register variable">rax</span>, OFFSET FLAT:month2
<span class="token comment">; RAX=pointer to table</span>
        lea     <span class="token register variable">rax</span>, QWORD PTR <span class="token operator">[</span><span class="token register variable">rax</span><span class="token operator">+</span><span class="token register variable">rcx</span><span class="token operator">*</span><span class="token number">2</span><span class="token operator">]</span>
<span class="token comment">; RAX=pointer to table + RCX*2=pointer to table + month*5*2=pointer to table + month*10</span>
        ret     <span class="token number">0</span>
get_month2  ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p>ä¸Šè¿°ç¨‹åºå®Œå…¨ä¸è®¿é—®å†…å­˜ã€‚æ•´ä¸ªå‡½æ•°çš„åŠŸèƒ½ï¼Œåªæ˜¯è®¡ç®—æœˆä»½åç§°å­—ç¬¦ä¸²çš„é¦–å­—æ¯æŒ‡é’ˆpointer_to_the_table+month*10ã€‚å®ƒä½¿ç”¨å•æ¡LEAæŒ‡ä»¤ï¼Œæ›¿ä»£äº†å¤šæ¡MULå’ŒMOVæŒ‡ä»¤ã€‚</p>
</li>
<li>
<p>ä¸Šè¿°æ•°ç»„çš„æ¯ä¸ªå­—ç¬¦ä¸²éƒ½å ç”¨10å­—èŠ‚ç©ºé—´ã€‚æœ€é•¿çš„å­—ç¬¦ä¸²ç”±â€œSeptemberâ€å’Œå†…å®¹ä¸ºé›¶çš„å­—èŠ‚æ„æˆï¼Œå…¶ä½™çš„å­—ç¬¦ä¸²ä½¿ç”¨é›¶å­—èŠ‚å¯¹é½ï¼Œæ‰€ä»¥æ¯ä¸ªå­—ç¬¦ä¸²éƒ½å ç”¨10ä¸ªå­—èŠ‚ã€‚å¦‚æ­¤ä¸€æ¥ï¼Œè®¡ç®—å­—ç¬¦ä¸²é¦–åœ°å€çš„æ–¹å¼å˜å¾—ç®€å•ï¼Œæ•´ä¸ªå‡½æ•°çš„æ•ˆç‡ä¹Ÿä¼šæœ‰æ‰€æé«˜ã€‚</p>
</li>
</ul>
<hr />
<p><code>Optimizing gcc</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">movsx   <span class="token register variable">rdi</span>, <span class="token register variable">edi</span>
    lea     <span class="token register variable">rax</span>, <span class="token operator">[</span><span class="token register variable">rdi</span><span class="token operator">+</span><span class="token register variable">rdi</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>
    lea     <span class="token register variable">rax</span>, month2<span class="token operator">[</span><span class="token register variable">rax</span><span class="token operator">+</span><span class="token register variable">rax</span><span class="token operator">]</span>
    ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç›´æ¥ä½¿ç”¨LEAæŒ‡ä»¤è¿›è¡Œä¹˜ä»¥10çš„è®¡ç®—</p>
<hr />
<p><code>Not Optimizing GCC</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token label function">get_month2:</span>
        push    <span class="token register variable">rbp</span>
        mov     <span class="token register variable">rbp</span>, <span class="token register variable">rsp</span>
        mov     DWORD PTR <span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">edi</span>
        mov     <span class="token register variable">eax</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
        movsx   <span class="token register variable">rdx</span>, <span class="token register variable">eax</span>
<span class="token comment">; RDX = sign-extended input value</span>
        mov     <span class="token register variable">rax</span>, <span class="token register variable">rdx</span>
<span class="token comment">; RAX = month</span>
        sal     <span class="token register variable">rax</span>, <span class="token number">2</span>
<span class="token comment">; RAX = month&lt;&lt;2 = month*4</span>
        add     <span class="token register variable">rax</span>, <span class="token register variable">rdx</span>
<span class="token comment">; RAX = RAX+RDX = month*4+month = month*5</span>
        add     <span class="token register variable">rax</span>, <span class="token register variable">rax</span>
<span class="token comment">; RAX = RAX*2 = month*5*2 = month*10</span>
        add     <span class="token register variable">rax</span>, OFFSET FLAT:month2
<span class="token comment">; RAX = month*10 + pointer to the table</span>
        pop     <span class="token register variable">rbp</span>
        ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸å¼€å¯ä¼˜åŒ–ç¼–è¯‘ï¼ŒGCCçš„ä¹˜æ³•è¿ç®—æ–¹å¼ä¸åŒ</p>
<hr />
<p><code>Not Optimizing MSVS</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">month<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>
get_month2 PROC
        mov      DWORD PTR <span class="token operator">[</span><span class="token register variable">rsp</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span>, <span class="token register variable">ecx</span>
        movsxd   <span class="token register variable">rax</span>, DWORD PTR month<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">rsp</span><span class="token operator">]</span>
<span class="token comment">; RAX = sign-extended input value into 64-bit one</span>
        imul     <span class="token register variable">rax</span>, <span class="token register variable">rax</span>, <span class="token number">10</span>
<span class="token comment">; RAX = RAX*10</span>
        lea      <span class="token register variable">rcx</span>, OFFSET FLAT:month2
<span class="token comment">; RCX = pointer to the table</span>
        add      <span class="token register variable">rcx</span>, <span class="token register variable">rax</span>
<span class="token comment">; RCX = RCX+RAX = pointer to the table+month*10</span>
        mov      <span class="token register variable">rax</span>, <span class="token register variable">rcx</span>
<span class="token comment">; RAX = pointer to the table+month*10</span>
        mov      <span class="token register variable">ecx</span>, <span class="token number">1</span>
<span class="token comment">; RCX = 1</span>
        imul     <span class="token register variable">rcx</span>, <span class="token register variable">rcx</span>, <span class="token number">0</span>
<span class="token comment">; RCX = 1*0 = 0</span>
        add      <span class="token register variable">rax</span>, <span class="token register variable">rcx</span>
<span class="token comment">; RAX = pointer to the table+month*10 + 0 = pointer to the table+month*10</span>
        ret      <span class="token number">0</span>
get_month2 ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>msvsä¸å¼€å¯ä¼˜åŒ–ï¼Œä¼šç›´æ¥ä½¿ç”¨imulæŒ‡ä»¤ï¼Œç„¶è€Œä¸ºä»€ä¹ˆRCXè¦ä¹˜ä»¥0ï¼Ÿä½œè€…è¯´è¿™æ˜¯MSVSçš„æ€ªç™–ä»£ç ï¼Œå¸Œæœ›æˆ‘ä»¬ä»ç¼–ç¨‹äººå‘˜çš„è§’åº¦æ¥ç†è§£ç¨‹åºçš„æºä»£ç </li>
</ul>
<h4 id="problem-4"><a class="markdownIt-Anchor" href="#problem-4"></a> Problem</h4>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token comment">; å‡½æ•°å¼€å§‹</span>
?s@@YAXPAN00@Z PROC<span class="token comment">; s, COMDAT</span>

<span class="token comment">; å°†å‚æ•°åŠ è½½åˆ°å¯„å­˜å™¨ä¸­</span>
    mov    <span class="token register variable">eax</span>, DWORD PTR _b<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>  <span class="token comment">; eax = ç»“æŸåœ°å€ - 4 (å®é™…æ˜¯_bçš„åœ°å€)</span>
    mov    <span class="token register variable">ecx</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>  <span class="token comment">; ecx = èµ·å§‹åœ°å€ - 4(açš„åœ°å€)</span>
    mov    <span class="token register variable">edx</span>, DWORD PTR _c<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>  <span class="token comment">; edx = ç»“æœå­˜æ”¾åœ°å€ - 4(cçš„åœ°å€)</span>

<span class="token comment">; ä¿å­˜å¯„å­˜å™¨ediå’Œesiï¼Œç”¨äºå¾ªç¯,å› ä¸ºæ­¤åediå’Œesiä½œä¸ºè®¡æ•°å™¨,</span>
    push   <span class="token register variable">esi</span>  
    push   <span class="token register variable">edi</span>
    
<span class="token comment">; è®¡ç®—æ•°ç»„é•¿åº¦ï¼Œä¸¤æ¬¡å‡æ³•å®è´¨ä¸Šå¾—åˆ°çš„æ˜¯_b - _açš„å€¼ï¼Œå³å…ƒç´ ä¸ªæ•°ï¼Œä½†è¿™é‡Œæ˜¯ç”¨å­—èŠ‚æ•°è¡¨ç¤ºçš„</span>
    sub    <span class="token register variable">ecx</span>, <span class="token register variable">eax</span>                  <span class="token comment">; ecx = èµ·å§‹åœ°å€ä¸ç»“æŸåœ°å€ä¹‹é—´çš„è·ç¦»ï¼ˆå­—èŠ‚æ•°ï¼‰</span>
    sub    <span class="token register variable">edx</span>, <span class="token register variable">eax</span>                  <span class="token comment">; edxåŒæ ·è°ƒæ•´ï¼Œç¡®ä¿ç»“æœå­˜å›åŸåŒºé—´</span>

<span class="token comment">; è®¾ç½®å¤–å±‚å¾ªç¯æ¬¡æ•°ä¸º200æ¬¡ï¼ˆæ¯æ¬¡å¤„ç†ä¸¤ä¸ªæµ®ç‚¹æ•°ï¼Œåˆè®¡å¤„ç†400ä¸ªæµ®ç‚¹æ•°ï¼‰</span>
    mov    <span class="token register variable">edi</span>, <span class="token number">200</span>     <span class="token comment">; 000000c8H;edi=i</span>

<span class="token label function">$LL6@s:</span>                              <span class="token comment">; å¤–å±‚å¾ªç¯å¼€å§‹</span>
    push   <span class="token number">100</span>          <span class="token comment">; 00000064H   ; å†…å±‚å¾ªç¯è®¡æ•°å™¨ï¼Œæ¯æ¬¡å¤„ç†100å¯¹æµ®ç‚¹æ•°</span>
    pop	<span class="token register variable">esi</span><span class="token comment">;esi=100,ä½œä¸ºè®¡æ•°å™¨</span>
<span class="token label function">$LL3@s:</span>                              <span class="token comment">; å†…å±‚å¾ªç¯å¼€å§‹</span>
    fld    QWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token register variable">eax</span><span class="token operator">]</span>      <span class="token comment">; å°†å½“å‰åœ°å€çš„æµ®ç‚¹æ•°æ¨å…¥FPUå †æ ˆ</span>
    fadd   QWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span>          <span class="token comment">; å°†æºåœ°å€çš„æµ®ç‚¹æ•°ä¸æ ˆé¡¶çš„æµ®ç‚¹æ•°ç›¸åŠ </span>
    fstp   QWORD PTR <span class="token operator">[</span><span class="token register variable">edx</span><span class="token operator">+</span><span class="token register variable">eax</span><span class="token operator">]</span>      <span class="token comment">; å°†ç»“æœä»å †æ ˆå¼¹å‡ºå¹¶å­˜å›ç›®çš„åœ°å€</span>
    add    <span class="token register variable">eax</span>, <span class="token number">8</span>                   <span class="token comment">; eaxæŒ‡é’ˆå‘å‰ç§»åŠ¨8å­—èŠ‚ï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªæµ®ç‚¹æ•°</span>
    dec    <span class="token register variable">esi</span>                      <span class="token comment">; å†…å±‚å¾ªç¯è®¡æ•°å™¨é€’å‡</span>
    jne    SHORT <span class="token operator">$</span>LL3@s              <span class="token comment">; å¦‚æœæœªè¾¾åˆ°å†…å±‚å¾ªç¯æ¬¡æ•°ï¼Œåˆ™è·³è½¬ç»§ç»­å†…å±‚å¾ªç¯</span>

    dec    <span class="token register variable">edi</span>                      <span class="token comment">; å¤–å±‚å¾ªç¯è®¡æ•°å™¨é€’å‡</span>
    jne    SHORT <span class="token operator">$</span>LL6@s              <span class="token comment">; å¦‚æœæœªè¾¾åˆ°å¤–å±‚å¾ªç¯æ¬¡æ•°ï¼Œåˆ™è·³è½¬ç»§ç»­å¤–å±‚å¾ªç¯</span>

<span class="token comment">; æ¢å¤ä¿å­˜çš„å¯„å­˜å™¨ï¼Œå¹¶æ¸…ç†æ ˆ</span>
    pop    <span class="token register variable">edi</span>
    pop    <span class="token register variable">esi</span>
    ret    <span class="token number">0</span>                        <span class="token comment">; å‡½æ•°è¿”å›ï¼Œä¸å¸¦è¿”å›å€¼</span>
?s@@YAXPAN00@Z  ENDP   <span class="token comment">; s å‡½æ•°ç»“æŸ</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">M</span>    <span class="token expression"><span class="token number">100</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">N</span>    <span class="token expression"><span class="token number">200</span></span></span>
<span class="token keyword">void</span> <span class="token function">s</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">*</span>a<span class="token punctuation">,</span> <span class="token keyword">double</span> <span class="token operator">*</span>b<span class="token punctuation">,</span> <span class="token keyword">double</span> <span class="token operator">*</span>c<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>N<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span>M<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span>
      <span class="token operator">*</span><span class="token punctuation">(</span>c<span class="token operator">+</span>i<span class="token operator">*</span>M<span class="token operator">+</span>j<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">*</span><span class="token punctuation">(</span>a<span class="token operator">+</span>i<span class="token operator">*</span>M<span class="token operator">+</span>j<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token operator">*</span><span class="token punctuation">(</span>b<span class="token operator">+</span>i<span class="token operator">*</span>M<span class="token operator">+</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr />
<ol start="2">
<li></li>
</ol>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token comment">; å‡½æ•°å¼€å§‹ï¼Œæ ‡å‡†çš„å‡½æ•°æ¡†æ¶å»ºç«‹</span>
?m@@YAXPAN00@Z PROC<span class="token comment">; m, COMDAT</span>
    push   <span class="token register variable">ebp</span>
    mov    <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
    push   <span class="token register variable">ecx</span>                     <span class="token comment">; ä¿å­˜ecx</span>
    push   <span class="token register variable">ecx</span>                     <span class="token comment">; è¿™é‡Œé‡å¤push ecxå¯èƒ½æ˜¯ä¸ºäº†å¯¹é½æ ˆæˆ–è€…ä¿ç•™ç©ºé—´(MSVSçš„æ€ªç™–ä»£ç )</span>
    mov    <span class="token register variable">edx</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span> <span class="token comment">; edx = _a$ (èµ·å§‹åœ°å€)</span>
    push   <span class="token register variable">ebx</span>                     <span class="token comment">; ä¿å­˜ebx</span>
    mov    <span class="token register variable">ebx</span>, DWORD PTR _c<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span> <span class="token comment">; ebx = _c$ (ç›®æ ‡åœ°å€æˆ–å¦ä¸€ä¸ªèµ·å§‹åœ°å€)</span>
    push   <span class="token register variable">esi</span>                     <span class="token comment">; ä¿å­˜esi</span>
    mov    <span class="token register variable">esi</span>, DWORD PTR _b<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span> <span class="token comment">; esi = _b$ (å¯èƒ½çš„ç»“æŸåœ°å€æˆ–åç§»é‡)</span>

<span class="token comment">; è®¡ç®—æ•°ç»„é•¿åº¦æˆ–åç§»</span>
    sub    <span class="token register variable">edx</span>, <span class="token register variable">esi</span>                <span class="token comment">; è®¡ç®—é•¿åº¦æˆ–åç§»1;edx=edx-esi=ptr(a-b)</span>
    push   <span class="token register variable">edi</span>                     <span class="token comment">; ä¿å­˜edi</span>
    sub    <span class="token register variable">esi</span>, <span class="token register variable">ebx</span>                <span class="token comment">; è®¡ç®—é•¿åº¦æˆ–åç§»2ï¼Œæ³¨æ„è¿™é‡Œçš„æ“ä½œä¼¼ä¹ä¸é¢„æœŸé€»è¾‘ä¸ç¬¦ï¼Œéœ€ç»“åˆå…·ä½“ç®—æ³•ç†è§£</span>
<span class="token comment">;esi=esi-ebx=ptr(b-c)</span>
<span class="token comment">; åˆå§‹åŒ–å¾ªç¯è®¡æ•°å™¨</span>
    mov    DWORD PTR tv315<span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token number">100</span>  <span class="token comment">; å¤–å±‚å¾ªç¯è®¡æ•°å™¨è®¾ä¸º100;tv315=100</span>
<span class="token label function">$LL9@m:</span>                              <span class="token comment">; å¤–å±‚å¾ªç¯å¼€å§‹</span>
    mov    <span class="token register variable">eax</span>, <span class="token register variable">ebx</span>                <span class="token comment">; eax = ebx=cï¼Œå¯èƒ½ç”¨äºåœ°å€è®¡ç®—</span>
    mov    DWORD PTR tv291<span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token number">300</span>  <span class="token comment">; å†…å±‚å¾ªç¯è®¡æ•°å™¨è®¾ä¸º300;tv291=300</span>
<span class="token label function">$LL6@m:</span>                              <span class="token comment">; å†…å±‚å¾ªç¯å¼€å§‹</span>
    fldz                           <span class="token comment">; åŠ è½½0.0åˆ°FPUå †æ ˆï¼Œå‡†å¤‡ç´¯åŠ </span>
    lea    <span class="token register variable">ecx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token register variable">eax</span><span class="token operator">]</span> <span class="token comment">; è®¡ç®—å½“å‰å¤„ç†å…ƒç´ çš„åœ°å€;ecx=b</span>
    fstp   QWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span>         <span class="token comment">; å°†0.0å­˜å…¥eaxæŒ‡å‘çš„ä½ç½®ï¼Œæ¸…0,æ­¤æ—¶eaxæŒ‡å‘c;*c=0ä½äºç¬¬äºŒå±‚å¾ªç¯ï¼Œeaxä½œä¸ºå¾ªç¯çš„æŒ‡é’ˆ</span>

    mov    <span class="token register variable">edi</span>, <span class="token number">200</span>                <span class="token comment">; ediä½œä¸ºè®¡æ•°å™¨;edi=200</span>
<span class="token label function">$LL3@m:</span>                              <span class="token comment">; ç¬¬ä¸‰å±‚å¾ªç¯å¼€å§‹</span>
    dec    <span class="token register variable">edi</span>                     <span class="token comment">; å¾ªç¯è®¡æ•°å™¨é€’å‡</span>
    fld    QWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token register variable">edx</span><span class="token operator">]</span>     <span class="token comment">; ä»å½“å‰åœ°å€åŠ ä¸Šä¹‹å‰è®¡ç®—çš„åç§»å¤„å–å…ƒç´ ï¼Œæ¨å…¥FPUæ ˆ;ecx+edx=b+a-b=a</span>
    fmul   QWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">]</span>         <span class="token comment">; å°†æ ˆé¡¶å…ƒç´ ä¸ecxåœ°å€å¤„çš„å…ƒç´ ç›¸ä¹˜ *a=*ax*b+c</span>
    fadd   QWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span>         <span class="token comment">; å°†ä¹˜ç§¯ä¸eaxåœ°å€å¤„çš„å…ƒç´ ç›¸åŠ ï¼Œå¹¶å°†ç»“æœæ”¾å›eaxåœ°å€,c</span>
    fstp   QWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span>         <span class="token comment">; å¼¹å‡ºFPUæ ˆé¡¶å…ƒç´ ï¼ˆå·²æ— ç”¨ï¼‰;è¿™é‡Œçš„è¿ç®—ä¸ediæ— å…³</span>
    jne    SHORT <span class="token operator">$</span>LL3@m             <span class="token comment">; è‹¥ediéé›¶ï¼Œç»§ç»­å†…å±‚å¾ªç¯</span>

    add    <span class="token register variable">eax</span>, <span class="token number">8</span>                  <span class="token comment">; eaxæŒ‡å‘ä¸‹ä¸€ä¸ªå…ƒç´ </span>
    dec    DWORD PTR tv291<span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>     <span class="token comment">; å†…å±‚å¾ªç¯è®¡æ•°å™¨é€’å‡</span>
    jne    SHORT <span class="token operator">$</span>LL6@m             <span class="token comment">; è‹¥å†…å±‚è®¡æ•°å™¨éé›¶ï¼Œç»§ç»­å†…å±‚å¾ªç¯</span>

    add    <span class="token register variable">ebx</span>, <span class="token number">800</span>                <span class="token comment">; ebxå¢åŠ 800ï¼Œå¯èƒ½ç”¨äºå¤„ç†ä¸‹ä¸€æ‰¹æ•°æ®</span>
    dec    DWORD PTR tv315<span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>     <span class="token comment">; å¤–å±‚å¾ªç¯è®¡æ•°å™¨é€’å‡</span>
    jne    SHORT <span class="token operator">$</span>LL9@m             <span class="token comment">; è‹¥å¤–å±‚è®¡æ•°å™¨éé›¶ï¼Œç»§ç»­å¤–å±‚å¾ªç¯</span>

<span class="token comment">; æ¸…ç†å¹¶è¿”å›</span>
    pop    <span class="token register variable">edi</span>
    pop    <span class="token register variable">esi</span>
    pop    <span class="token register variable">ebx</span>
    leave                          <span class="token comment">; æ¢å¤ebpå’Œesp</span>
    ret    <span class="token number">0</span>                       <span class="token comment">; å‡½æ•°è¿”å›</span>
?m@@YAXPAN00@Z ENDP                   <span class="token comment">; må‡½æ•°ç»“æŸ</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">for</span> tv315 <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">for</span> tv291 <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token operator">*</span><span class="token punctuation">(</span>c<span class="token operator">+</span>tv315<span class="token operator">*</span><span class="token number">100</span><span class="token operator">+</span>tv291<span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">0</span>
        <span class="token keyword">for</span> edi <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token operator">*</span><span class="token punctuation">(</span>c<span class="token operator">+</span>tv315<span class="token operator">*</span><span class="token number">100</span><span class="token operator">+</span>tv291<span class="token punctuation">)</span><span class="token operator">+=</span><span class="token operator">*</span><span class="token punctuation">(</span>a<span class="token operator">+</span>tv315<span class="token operator">*</span><span class="token number">100</span><span class="token operator">+</span>tv291<span class="token punctuation">)</span><span class="token operator">*</span> <span class="token operator">*</span><span class="token punctuation">(</span>b<span class="token operator">+</span>tv315<span class="token operator">*</span><span class="token number">100</span><span class="token operator">+</span>tv291<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="3">
<li></li>
</ol>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_array<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>
_x<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">12</span>
_y<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">16</span>
_f      PROC
        mov     <span class="token register variable">eax</span>, DWORD PTR _x<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span><span class="token comment">;eax=x;</span>
        mov     <span class="token register variable">edx</span>, DWORD PTR _y<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span><span class="token comment">;edx=y;</span>
        mov     <span class="token register variable">ecx</span>, <span class="token register variable">eax</span><span class="token comment">;ecx=x;</span>
        shl     <span class="token register variable">ecx</span>, <span class="token number">4</span><span class="token comment">;x*2^4;</span>
        sub     <span class="token register variable">ecx</span>, <span class="token register variable">eax</span><span class="token comment">;ecx=15x</span>
        lea     <span class="token register variable">eax</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">edx</span><span class="token operator">+</span><span class="token register variable">ecx</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">]</span><span class="token comment">;eax=y+120x</span>
        mov     <span class="token register variable">ecx</span>, DWORD PTR _array<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span><span class="token comment">;ecx=_array</span>
        fld     QWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token register variable">eax</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">]</span><span class="token comment">;æ˜¾ç„¶æ˜¯8ä½æµ®ç‚¹æ•°ï¼Œdoubleç±»å‹</span>
        ret     <span class="token number">0</span><span class="token comment">;è¿”å›çš„æ˜¯_array[y+120x]</span>
_f      ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">double</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token keyword">double</span> array<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">120</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
         <span class="token keyword">return</span> array<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">//ç†è®ºä¸Š50æ˜¯çœ‹ä¸å‡ºæ¥çš„ï¼Œåªèƒ½åæ±‡ç¼–æˆä¸€ç»´çš„æ•°ç»„_array[y+120x]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="4">
<li></li>
</ol>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_array<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>
_x<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">12</span>
_y<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">16</span>
_z<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">20</span>
_f      PROC
        mov     <span class="token register variable">eax</span>, DWORD PTR _x<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span><span class="token comment">;eax=x</span>
        mov     <span class="token register variable">edx</span>, DWORD PTR _y<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span><span class="token comment">;edx=y</span>
        mov     <span class="token register variable">ecx</span>, <span class="token register variable">eax</span><span class="token comment">;ecx=x</span>
        shl     <span class="token register variable">ecx</span>, <span class="token number">4</span><span class="token comment">;ecx=x*16</span>
        sub     <span class="token register variable">ecx</span>, <span class="token register variable">eax</span><span class="token comment">;ecx=15x</span>
        lea     <span class="token register variable">eax</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">edx</span><span class="token operator">+</span><span class="token register variable">ecx</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span><span class="token comment">;eax=y+60x</span>
        mov     <span class="token register variable">ecx</span>, DWORD PTR _array<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span><span class="token comment">;ecx=ptr(array)</span>
        lea     <span class="token register variable">eax</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token register variable">eax</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span><span class="token comment">;eax=5*(y+60x)</span>
        shl     <span class="token register variable">eax</span>, <span class="token number">4</span><span class="token comment">;eax=80*(y+60x)</span>
        add     <span class="token register variable">eax</span>, DWORD PTR _z<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span><span class="token comment">;eax=80y+4800x+z</span>
        mov     <span class="token register variable">eax</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token register variable">eax</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span><span class="token comment">;eax=array[80y+4800x+z];arrayä¸ºintç±»å‹</span>
        ret     <span class="token number">0</span>
_f      ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ˜¾ç„¶æ˜¯ä¸‰ç»´æ•°ç»„<code>int array[][60][80];return array[x][y][z];</code></p>
<p>*5.(å¤ªéš¾äº†)</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token comment">; åˆå§‹åŒ–æ®µå®šä¹‰äº†ä¸€ä¸ªåä¸º_tblçš„æ•°æ®æ®µï¼Œå¤§å°ä¸º64å­—èŠ‚ï¼Œç”¨äºå­˜æ”¾DWORDï¼ˆåŒå­—ï¼‰ç±»å‹çš„æ•°æ®</span>
COMM    _tbl:DWORD:<span class="token number">064H</span>

<span class="token comment">; å®šä¹‰æœ¬åœ°å˜é‡tv759ï¼Œåˆå§‹åŒ–å€¼ä¸º-4ï¼Œå ç”¨4å­—èŠ‚</span>
tv759 <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">4</span>      <span class="token comment">;size= 4</span>

_main   PROC
    <span class="token comment">; ä¿å­˜è°ƒç”¨è€…ä¿å­˜çš„å¯„å­˜å™¨</span>
    push    <span class="token register variable">ecx</span>
    push    <span class="token register variable">ebx</span>
    push    <span class="token register variable">ebp</span>
    push    <span class="token register variable">esi</span>
    
    <span class="token comment">; åˆå§‹åŒ–å¯„å­˜å™¨</span>
    xor     <span class="token register variable">edx</span>, <span class="token register variable">edx</span>          <span class="token comment">; EDX = 0</span>
    push    <span class="token register variable">edi</span>               <span class="token comment">; ä¿å­˜EDI</span>
    xor     <span class="token register variable">esi</span>, <span class="token register variable">esi</span>          <span class="token comment">; ESI = 0</span>
    xor     <span class="token register variable">edi</span>, <span class="token register variable">edi</span>          <span class="token comment">; EDI = 0</span>
    xor     <span class="token register variable">ebx</span>, <span class="token register variable">ebx</span>          <span class="token comment">; EBX = 0</span>
    xor     <span class="token register variable">ebp</span>, <span class="token register variable">ebp</span>          <span class="token comment">; EBP = 0</span>
    
    <span class="token comment">; å°†EDXï¼ˆå½“å‰ä¸º0ï¼‰çš„å€¼å­˜å…¥å±€éƒ¨å˜é‡tv759çš„å†…å­˜ä½ç½®ï¼Œåç§»esp+20</span>
    mov     DWORD PTR tv759<span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">20</span><span class="token operator">]</span>, <span class="token register variable">edx</span><span class="token comment">;t=0</span>
    
    <span class="token comment">; è®¾ç½®EAXä¸º_tblçš„åœ°å€åç§»4å­—èŠ‚ï¼Œå³æŒ‡å‘_tblçš„ç¬¬ä¸€ä¸ªæœ‰æ•ˆå…ƒç´ </span>
    mov     <span class="token register variable">eax</span>, OFFSET _tbl<span class="token operator">+</span><span class="token number">4</span><span class="token comment">;eax=tbl[1]</span>
    
    <span class="token comment">; å¯¹é½æŒ‡ä»¤ï¼Œç¡®ä¿ä¸‹ä¸€æ¡æ ‡ç­¾æ­£ç¡®å¯¹é½</span>
    npad    <span class="token number">8</span> 
    
<span class="token label function">$LL6@main:</span>
    <span class="token comment">; è®¡ç®—ECX = EDX * 2ï¼Œç”¨äºåç»­èµ‹å€¼</span>
    lea     <span class="token register variable">ecx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">edx</span><span class="token operator">+</span><span class="token register variable">edx</span><span class="token operator">]</span><span class="token comment">;ecx=2*edx</span>
    
    <span class="token comment">; å°†ECXçš„å€¼æ”¾å…¥å½“å‰_EAXæŒ‡å‘çš„ä½ç½®+4ï¼Œå³åˆå§‹åŒ–tblçš„ç¬¬äºŒä¸ªDWORD</span>
    mov     DWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">ecx</span><span class="token comment">;tbl[i+1]=2*edx</span>
    
    <span class="token comment">; ä»å †æ ˆä¸­è¯»å–tv759çš„å€¼å¹¶å¢åŠ 3ï¼Œç„¶åå­˜å›tv759çš„ä½ç½®</span>
    mov     <span class="token register variable">ecx</span>, DWORD PTR tv759<span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">20</span><span class="token operator">]</span><span class="token comment">;ecx=t;</span>
    add     DWORD PTR tv759<span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">20</span><span class="token operator">]</span>, <span class="token number">3</span><span class="token comment">;t+=3;</span>
    
    <span class="token comment">; å°†æ›´æ–°åçš„tv759å€¼æ”¾å…¥å½“å‰_EAXæŒ‡å‘çš„ä½ç½®+8</span>
    mov     DWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span>, <span class="token register variable">ecx</span><span class="token comment">;ecx[i+2]=t</span>
    
    <span class="token comment">; è®¡ç®—ECX = EDX * 4ï¼Œå¹¶å­˜å…¥å½“å‰_EAXæŒ‡å‘çš„ä½ç½®+12</span>
    lea     <span class="token register variable">ecx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">edx</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>
    mov     DWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">12</span><span class="token operator">]</span>, <span class="token register variable">ecx</span>
    
    <span class="token comment">; è®¡ç®—ECX = EDX * 8ï¼Œå¹¶å­˜å…¥å½“å‰_EAXæŒ‡å‘çš„ä½ç½®</span>
    lea     <span class="token register variable">ecx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">edx</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">]</span>
    mov     DWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span>, <span class="token register variable">edx</span>
    
    <span class="token comment">; åˆå§‹åŒ–è¡¨çš„å…¶ä»–éƒ¨åˆ†ï¼Œä½¿ç”¨å›ºå®šçš„å€¼</span>
    mov     DWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">16</span><span class="token operator">]</span>, <span class="token register variable">ebp</span>  <span class="token comment">; ebpçš„å½“å‰å€¼ï¼ˆ0ï¼‰</span>
    mov     DWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">20</span><span class="token operator">]</span>, <span class="token register variable">ebx</span>  <span class="token comment">; ebxçš„å½“å‰å€¼ï¼ˆ0ï¼‰</span>
    mov     DWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">24</span><span class="token operator">]</span>, <span class="token register variable">edi</span>  <span class="token comment">; ediçš„å½“å‰å€¼ï¼ˆ0ï¼‰</span>
    mov     DWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">32</span><span class="token operator">]</span>, <span class="token register variable">esi</span>  <span class="token comment">; esiçš„å½“å‰å€¼ï¼ˆ0ï¼‰</span>
    
    <span class="token comment">; åœ¨å½“å‰_EAXæŒ‡é’ˆå‰ä¸€ä¸ªDWORDçš„ä½ç½®ç½®0</span>
    mov     DWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token number">0</span>
    
    <span class="token comment">; å°†ECXï¼ˆå³EDX*8ï¼‰å­˜å…¥å½“å‰_EAXæŒ‡å‘çš„ä½ç½®+28</span>
    mov     DWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">28</span><span class="token operator">]</span>, <span class="token register variable">ecx</span>
    
    <span class="token comment">; æ›´æ–°_EAXæŒ‡é’ˆï¼Œå‰è¿›åˆ°ä¸‹ä¸€ä¸ªè¦åˆå§‹åŒ–çš„è¡¨é¡¹</span>
    add     <span class="token register variable">eax</span>, <span class="token number">40</span>
    
    <span class="token comment">; å¢åŠ å¾ªç¯è®¡æ•°å™¨</span>
    inc     <span class="token register variable">edx</span>
    
    <span class="token comment">; å…¶ä»–å¾ªç¯å†…å¢é‡ï¼Œçœ‹ä¼¼ä¸æŸç§æ¨¡å¼æˆ–ç®—æ³•ç›¸å…³</span>
    add     <span class="token register variable">ebp</span>, <span class="token number">5</span>
    add     <span class="token register variable">ebx</span>, <span class="token number">6</span>
    add     <span class="token register variable">edi</span>, <span class="token number">7</span>
    add     <span class="token register variable">esi</span>, <span class="token number">9</span>
    
    <span class="token comment">; æ£€æŸ¥æ˜¯å¦å·²å¤„ç†å®Œæ•´ä¸ªè¡¨</span>
    cmp     <span class="token register variable">eax</span>, OFFSET _tbl<span class="token operator">+</span><span class="token number">404</span><span class="token comment">;400/4=100ä¸ªintå€¼</span>
    jl      SHORT <span class="token operator">$</span>LL6@main      <span class="token comment">; è‹¥æœªå¤„ç†å®Œï¼Œè·³è½¬å›å¾ªç¯å¼€å§‹å¤„ç»§ç»­</span>
    
    <span class="token comment">; å¾ªç¯ç»“æŸï¼Œæ¢å¤ä¹‹å‰ä¿å­˜çš„å¯„å­˜å™¨</span>
    pop     <span class="token register variable">edi</span>
    pop     <span class="token register variable">esi</span>
    pop     <span class="token register variable">ebp</span>
    
    <span class="token comment">; å‡½æ•°è¿”å›å€¼æ¸…é›¶</span>
    xor     <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
    
    <span class="token comment">; æ¢å¤EBXå’ŒECXï¼Œå‡†å¤‡è¿”å›</span>
    pop     <span class="token register variable">ebx</span>
    pop     <span class="token register variable">ecx</span>
    
    <span class="token comment">; å‡½æ•°è¿”å›ï¼Œä¸å¸¦å‚æ•°</span>
    ret     <span class="token number">0</span>
_main   ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™æ®µä»£ç å·²ç»é¢ç›®å…¨éäº†ï¼Œæ„Ÿè§‰çœŸçš„å¾ˆéš¾çœ‹æ‡‚,</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> tbl<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> x<span class="token punctuation">,</span> y<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> x<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span>
             <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> y<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span>
                    tbl<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token operator">=</span>x<span class="token operator">*</span>y<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><em>æŸ¯ä½¬â€˜sTips:é‡åˆ°è¿™ç§å¾ˆéš¾çœ‹æ‡‚çš„æ±‡ç¼–ï¼Œå¦‚æœç»™çš„æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œèƒ½è¿è¡Œçš„ç›´æ¥è¿è¡Œå®Œdumpï¼Œä¸èƒ½è¿è¡Œçš„æŠŠç‰‡æ®µæŠ ä¸‹æ¥ï¼Œæˆ–è€…ç…§ç€æ±‡ç¼–å†™ä¸€éï¼Œç„¶åè·‘ä¸€éè¿›è¡ŒçŒœæµ‹ï¼Œæé€†å‘é¦–å…ˆæœ‰å¤§èƒ†çš„çŒœæµ‹å’Œæƒ³è±¡</em></p>
<h3 id="chap19-ä½è¿ç®—"><a class="markdownIt-Anchor" href="#chap19-ä½è¿ç®—"></a> Chap19 ä½è¿ç®—</h3>
<p><em>æœ‰å¾ˆå¤šç¨‹åºéƒ½æŠŠè¾“å…¥å‚æ•°çš„æŸäº›æ¯”ç‰¹ä½å½“ä½œæ ‡è¯†ä½å¤„ç†ã€‚</em></p>
<h4 id="ç‰¹å®šä½"><a class="markdownIt-Anchor" href="#ç‰¹å®šä½"></a> ç‰¹å®šä½</h4>
<h5 id="x86-3"><a class="markdownIt-Anchor" href="#x86-3"></a> x86</h5>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">HANDLE fh<span class="token punctuation">;</span>
   fh<span class="token operator">=</span><span class="token function">CreateFile</span> <span class="token punctuation">(</span><span class="token string">"file"</span><span class="token punctuation">,</span> GENERIC_WRITE <span class="token operator">|</span> GENERIC_READ<span class="token punctuation">,</span> FILE_SHARE_READ<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> OPEN_ALWAYS <span class="token punctuation">,</span>FILE_ATTRIBUTE_NORMAL<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><code>msvs 2010ç¼–è¯‘å</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">push    <span class="token number">0</span>	<span class="token comment">;NULL</span>
   push    <span class="token number">128</span>                            <span class="token comment">; 00000080H</span>
   push    <span class="token number">4</span>	<span class="token comment">;OPEN_ALWAYS</span>
   push    <span class="token number">0</span>	<span class="token comment">;NULL</span>
   push    <span class="token number">1</span>	<span class="token comment">;FILE_SHARE_READ</span>
   push    <span class="token operator">-</span><span class="token number">1073741824</span>                    <span class="token comment">; c0000000H</span>
   push    OFFSET <span class="token operator">$</span>SG78813	<span class="token comment">;ptr(file)</span>
   call    DWORD PTR __imp__CreateFileA@<span class="token number">28</span>
   mov     DWORD PTR _fh<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token register variable">eax</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åº“æ–‡ä»¶<code>WinNT.h</code>å¯¹ç›¸å…³ä½åŸŸè¿›è¡Œäº†å®šä¹‰</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GENERIC_READ</span>           <span class="token expression"><span class="token punctuation">(</span><span class="token number">0x80000000L</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GENERIC_WRITE</span>          <span class="token expression"><span class="token punctuation">(</span><span class="token number">0x40000000L</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GENERIC_EXECUTE</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token number">0x20000000L</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GENERIC_ALL</span>            <span class="token expression"><span class="token punctuation">(</span><span class="token number">0x10000000L</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨APIå£°æ˜é‡Œï¼Œ<code>CreateFile()</code>å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ä¸º<code>GENERIC_WRITE|GENERIC_READ</code>å³<code>0x0x80000000 | 0x40000000 = 0xC0000000</code>,CreateFile()å‡½æ•°å¦‚ä½•æ£€æµ‹æ ‡å¿—ä½å‘¢</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.text:7C83D429  test       byte ptr [ebp+dwDesiredAccess+3], 40h
.text:7C83D42   Dmov       [ebp+var_8], 1
.text:7C83D434  jz         short loc_7C83D417
.text:7C83D436  jmp        loc_7C810817<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>byte ptr [ebp+dwDesiredAccess+3],å³0xC0000000çš„å¤´ä¸€ä¸ªå­—èŠ‚(è¿™é‡Œæ˜¯å°ç«¯è¡¨ç¤º),å®é™…ä¸Šå°±æ˜¯0xC0è¿›è¡Œä¸è¿ç®—</p>
<p><code>TEST</code>ä¸<code>AND</code>æŒ‡ä»¤çš„å”¯ä¸€åŒºåˆ«æ˜¯å‰è€…ä¸ä¿å­˜è¿ç®—ç»“æœ</p>
<p>å³ï¼Œä¸Šè¿°å¯æ‰§è¡Œçš„ç¨‹åºæºä»£ç é€»è¾‘æ˜¯ï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">if ((dwDesiredAccess&amp;0x40000000) &#x3D;&#x3D; 0) goto loc_7C83D417<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>ä»è€Œè¾¾åˆ°äº†æ£€æµ‹æ ‡å¿—ä½çš„æ•ˆæœ</p>
<hr />
<p>çœ‹çœ‹linuxçš„</p>
<p>ç”¨<code>gcc 4.4.1ç¼–è¯‘</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> handle<span class="token punctuation">;</span>
        handle<span class="token operator">=</span><span class="token function">open</span> <span class="token punctuation">(</span><span class="token string">"file"</span><span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_CREAT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">           public main
main       proc near

var_20     <span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">20h</span>
var_1C     <span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">1Ch</span>
var_4      <span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">4</span>

           push    <span class="token register variable">ebp</span>
           mov     <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
           and     <span class="token register variable">esp</span>, <span class="token number">0FFFFFFF0h</span>
           sub     <span class="token register variable">esp</span>, <span class="token number">20h</span>
           mov     <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">20h</span><span class="token operator">+</span>var_1C<span class="token operator">]</span>, <span class="token number">42h</span>
           mov     <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">20h</span><span class="token operator">+</span>var_20<span class="token operator">]</span>, offset aFile <span class="token comment">; "file"</span>
           call    _open
           mov     <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">20h</span><span class="token operator">+</span>var_4<span class="token operator">]</span>, <span class="token register variable">eax</span>
           leave
           retn
main       endp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨<code>libc.so.6</code>é‡Œ,<code>open()</code>å‡½æ•°è°ƒç”¨çš„æ˜¯<code>syscall_sys_open</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token label function">.text:</span>000BE69B            mov  <span class="token register variable">edx</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">+</span>mode<span class="token operator">]</span> <span class="token comment">; mode</span>
<span class="token label function">.text:</span>000BE69F            mov  <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">+</span>flags<span class="token operator">]</span> <span class="token comment">; flags</span>
<span class="token label function">.text:</span>000BE6A3            mov  <span class="token register variable">ebx</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">+</span>filename<span class="token operator">]</span> <span class="token comment">; filename</span>
<span class="token label function">.text:</span>000BE6A7            mov  <span class="token register variable">eax</span>, <span class="token number">5</span>
<span class="token label function">.text:</span>000BE6AC            int  <span class="token number">80h</span>       <span class="token comment">; LINUX - sys_open</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨æ‰§è¡Œ<code>open()</code>å‡½æ•°æ—¶ï¼Œ<code>linux</code>å†…æ ¸ä¼šæ£€æµ‹æŸäº›æ ‡è¯†ä½</p>
<p>åœ¨Linux 2.6ä¸­ï¼Œå½“ç¨‹åºé€šè¿‡<code>syscall</code>è°ƒç”¨ <code>sys_open</code>çš„æ—¶å€™ï¼Œå®ƒè°ƒç”¨çš„å‡½æ•°å®é™…ä¸Šæ˜¯å†…æ ¸å‡½æ•° <code>do_sys_open()</code>ã€‚åœ¨æ‰§è¡Œå‡½æ•°<code>do_sys_open()</code>çš„æ—¶å€™ï¼Œç³»ç»Ÿåˆä¼šè°ƒç”¨<code>do_filp_open() </code>å‡½æ•°ã€‚<em>å¯ä»¥åœ¨Linuxå†…æ ¸æºä»£ç é‡Œçš„fs/namei.cé‡Œæ‰¾åˆ°è¿™éƒ¨åˆ†å†…å®¹ã€‚</em></p>
<p>LINUXä¸­ç¼–è¯‘å™¨ä¸ä»…ä¼šä½¿ç”¨æ ˆæ¥ä¼ é€’å‚æ•°ï¼Œå®ƒè¿˜ä¼šä½¿ç”¨å¯„å­˜å™¨ä¼ é€’éƒ¨åˆ†å‚æ•°ã€‚ç¼–è¯‘å™¨æœ€å¸¸é‡‡ç”¨çš„å‡½æ•°è°ƒç”¨çº¦å®šæ˜¯<code>fastcall</code>ï¼ˆå‚è§6.4.3èŠ‚ï¼‰ã€‚è¿™ä¸ªè§„èŒƒ<code>ä¼˜å…ˆä½¿ç”¨å¯„å­˜å™¨æ¥ä¼ é€’å‚æ•°</code>ã€‚è¿™ä½¿å¾—<code>CPUä¸å¿…æ¯æ¬¡éƒ½è¦è®¿é—®å†…å­˜é‡Œçš„æ•°æ®æ ˆ</code>ï¼Œå¤§å¤§æå‡äº†ç¨‹åºçš„è¿è¡Œæ•ˆç‡ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡GCCçš„regparmé€‰é¡¹[<a href="#anchor191">1]</a>ï¼Œè®¾ç½®ä¼ é€’å‚æ•°çš„å¯„å­˜å™¨æ•°é‡ã€‚</p>
<p>åœ¨Linux 2.6å†…æ ¸çš„ç¼–è¯‘é€‰é¡¹ä¸­ï¼Œè®¾å®šäº†å¯„å­˜å™¨é€‰é¡¹â€œ-mregparm=3â€</p>
<p>è¿™ä¸ªé€‰é¡¹å†³å®šï¼Œç¼–è¯‘å™¨é¦–å…ˆé€šè¿‡<code>EAX,EDXå’ŒECXå¯„å­˜å™¨</code>ä¼ é€’å‡½æ•°æ‰€éœ€çš„å¤´ä¸‰ä¸ªå‚æ•°,å†é€šè¿‡æ ˆä¼ é€’å…¶ä½™çš„å‚æ•°ï¼Œå¦‚æœå‚æ•°çš„æ€»æ•°ä¸è¶³3ä¸ªï¼Œåªä¼šç”¨åˆ°éƒ¨åˆ†å¯„å­˜å™¨</p>
<p><code>åœ¨Ubuntué‡Œä¸‹è½½Linux Kernel 2.6.31ï¼Œå¹¶ç”¨â€œmake vmlinuxâ€æŒ‡ä»¤ç¼–è¯‘ï¼Œç„¶åä½¿ç”¨IDAæ‰“å¼€ç¨‹åºï¼Œå¯»æ‰¾å‡½æ•°do_filp_open()</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">do_filp_open    proc near
...... 
                push    <span class="token register variable">ebp</span>
                mov     <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
                push    <span class="token register variable">edi</span>
                push    <span class="token register variable">esi</span>
                push    <span class="token register variable">ebx</span>
                mov     <span class="token register variable">ebx</span>, <span class="token register variable">ecx</span>
                add     <span class="token register variable">ebx</span>, <span class="token number">1</span>
                sub     <span class="token register variable">esp</span>, <span class="token number">98h</span>
                mov     <span class="token register variable">esi</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>arg_4<span class="token operator">]</span>  <span class="token comment">; acc_mode (5th arg)</span>
                test    <span class="token register variable">bl</span>, <span class="token number">3</span>
                mov     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_80<span class="token operator">]</span>, <span class="token register variable">eax</span> <span class="token comment">; dfd (1th arg)</span>
                mov     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_7C<span class="token operator">]</span>, <span class="token register variable">edx</span> <span class="token comment">; pathname (2th arg)</span>
                mov     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_78<span class="token operator">]</span>, <span class="token register variable">ecx</span> <span class="token comment">; open_flag (3th arg)</span>
                jnz     short loc_C01EF684
                mov     <span class="token register variable">ebx</span>, <span class="token register variable">ecx</span>          <span class="token comment">; ebx &lt;- open_flag</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token label function">loc_C01EF6B4:</span>                       <span class="token comment">; CODE XREF: do_filp_open+4F</span>
                test    <span class="token register variable">bl</span>, <span class="token number">40h</span>     <span class="token comment">; O_CREAT</span>
                jnz     loc_C01EF810
                mov     <span class="token register variable">edi</span>, <span class="token register variable">ebx</span>
                shr     <span class="token register variable">edi</span>, <span class="token number">11h</span>
                xor     <span class="token register variable">edi</span>, <span class="token number">1</span>
                and     <span class="token register variable">edi</span>, <span class="token number">1</span>
                test    <span class="token register variable">ebx</span>, <span class="token number">10000h</span>
                jz      short loc_C01EF6D3
                or      <span class="token register variable">edi</span>, <span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>40h,å®é™…ä¸Šæ˜¯æ±‡ç¼–å®<code>O_CREAT</code>çš„å€¼.è¿™é‡Œçš„<code>test</code>æŒ‡ä»¤æ£€æŸ¥<code>open_flag</code>é‡Œæ˜¯å¦å­˜åœ¨0x40çš„æ ‡å¿—ä½ï¼Œå¦‚æœè¿™ä¸ªä½æ˜¯1ï¼Œå°±ä¼šè§¦å‘ä¸‹ä¸€æ¡<code>JNZ</code>æŒ‡ä»¤</p>
<h4 id="æ¸…é™¤ä½"><a class="markdownIt-Anchor" href="#æ¸…é™¤ä½"></a> æ¸…é™¤ä½</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">IS_SET</span><span class="token expression"><span class="token punctuation">(</span>flag<span class="token punctuation">,</span> bit<span class="token punctuation">)</span>       <span class="token punctuation">(</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>bit<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SET_BIT</span><span class="token expression"><span class="token punctuation">(</span>var<span class="token punctuation">,</span> bit<span class="token punctuation">)</span>       <span class="token punctuation">(</span><span class="token punctuation">(</span>var<span class="token punctuation">)</span> <span class="token operator">|=</span> <span class="token punctuation">(</span>bit<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">REMOVE_BIT</span><span class="token expression"><span class="token punctuation">(</span>var<span class="token punctuation">,</span> bit<span class="token punctuation">)</span>    <span class="token punctuation">(</span><span class="token punctuation">(</span>var<span class="token punctuation">)</span> <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>bit<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

<span class="token keyword">int</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> rt<span class="token operator">=</span>a<span class="token punctuation">;</span>
    <span class="token function">SET_BIT</span> <span class="token punctuation">(</span>rt<span class="token punctuation">,</span> <span class="token number">0x4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">REMOVE_BIT</span> <span class="token punctuation">(</span>rt<span class="token punctuation">,</span> <span class="token number">0x200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> rt<span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span>
    <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">0x12340678</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr />
<p><code>Non-optimizing MSVS</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_rt<span class="token operator">$</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">4</span>             <span class="token comment">; size = 4</span>
_a<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>               <span class="token comment">; size = 4</span>

_f  PROC
    push   <span class="token register variable">ebp</span>
    mov    <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
    push   <span class="token register variable">ecx</span>
    mov    <span class="token register variable">eax</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
    mov    DWORD PTR _rt<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token register variable">eax</span>
    mov    <span class="token register variable">ecx</span>, DWORD PTR _rt<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
    or     <span class="token register variable">ecx</span>, <span class="token number">16384</span>               <span class="token comment">; 00004000H;set bit</span>
    mov    DWORD PTR _rt<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token register variable">ecx</span>
    mov    <span class="token register variable">edx</span>, DWORD PTR _rt<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
    and    <span class="token register variable">edx</span>, <span class="token operator">-</span><span class="token number">513</span>                <span class="token comment">; fffffdffH;remove bit</span>
    mov    DWORD PTR _rt<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token register variable">edx</span>
    mov    <span class="token register variable">eax</span>, DWORD PTR _rt<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
    mov    <span class="token register variable">esp</span>, <span class="token register variable">ebp</span>
    pop    <span class="token register variable">ebp</span>
    ret    <span class="token number">0</span>
_f  ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>#define IS_SET(flag, bit)       ((flag) &amp; (bit)) #define SET_BIT(var, bit)       ((var) |= (bit)) #define REMOVE_BIT(var, bit)    ((var) &amp;= ~(bit))</code></p>
<p>ä»¥ä¸Šä¸ºæ ¸å¿ƒ</p>
<p>åœ¨æ±‡ç¼–ä¸­ï¼Œ<code>OR</code>æŒ‡ä»¤æ˜¯é€ä½è¿›è¡Œæˆ–è¿ç®—çš„æŒ‡ä»¤ï¼Œç”¨æ¥å°†æŒ‡å®šä½ç½®ç½®1</p>
<p><code>AND</code>æŒ‡ä»¤çš„ä½œç”¨æ˜¯é‡ç½®<code>bit</code>ä½ï¼Œå¦‚æœç«‹å³æ•°çš„æŸä¸ª<code>bit</code>ä½ä¸º1,<code>AND</code>æŒ‡ä»¤å°†ä¼šä¿ç•™å¯„å­˜å™¨çš„è¿™ä¸ªbitä½ï¼Œå¦åˆ™ç½®0</p>
<hr />
<p><code>Optimizing MSVS</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_a<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>                      <span class="token comment">; size = 4</span>
_f     PROC
    mov    <span class="token register variable">eax</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
    and    <span class="token register variable">eax</span>, <span class="token operator">-</span><span class="token number">513</span>         <span class="token comment">; fffffdffH</span>
    or     <span class="token register variable">eax</span>, <span class="token number">16384</span>        <span class="token comment">; 00004000H</span>
    ret    <span class="token number">0</span> 
_f     ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™é‡Œäº’æ¢äº†é¡ºåºï¼Œå…¶å®æ²¡å½±å“ï¼Œå› ä¸ºå¯¹ä½æ“ä½œæ˜¯é’ˆå¯¹ä¸åŒä½çš„</p>
<hr />
<p><code>Optimizing GCC</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">           public f
f          proc near

arg_0      <span class="token operator">=</span> dword ptr  <span class="token number">8</span>

           push     <span class="token register variable">ebp</span>
           mov      <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
           mov      <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>arg_0<span class="token operator">]</span>
           pop      <span class="token register variable">ebp</span>
           or       <span class="token register variable">ah</span>, <span class="token number">40h</span>
           and      <span class="token register variable">ah</span>, <span class="token number">0FDh</span>
           retn
f          endp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™é‡Œçš„ç¬¬ä¸€ä¸ªå‚æ•°åŸæœ¬å°±åœ¨eaxé‡Œé¢ï¼Œå‡½æ•°åºè¨€å’Œå‡½æ•°å°¾å£°å…¶å®å¯ä»¥çœç•¥</p>
<h4 id="ä½ç§»"><a class="markdownIt-Anchor" href="#ä½ç§»"></a> ä½ç§»</h4>
<p><code>&lt;&lt;</code>ä¸<code>&gt;&gt;</code>æ˜¯ä½ç§»è¿ç®—ç¬¦</p>
<p>å¯¹åº”çš„x86æŒ‡ä»¤é›†ä¸º<code>SHL</code>å’Œ<code>SHR</code></p>
<p>ä½ç§»æŒ‡ä»¤å¯ç”¨æ¥å¯¹ç‰¹å®šä½è¿›è¡Œå–å€¼æˆ–éš”ç¦»ï¼Œç”¨é€”ååˆ†å¹¿æ³›ã€‚</p>
<h4 id="åœ¨fpuä¸Šè®¾ç½®ç‰¹å®šä½"><a class="markdownIt-Anchor" href="#åœ¨fpuä¸Šè®¾ç½®ç‰¹å®šä½"></a> åœ¨FPUä¸Šè®¾ç½®ç‰¹å®šä½</h4>
<img src="/2024/05/23/re4b%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image-20240609142026432.png" class="" alt="image-20240609142026432" loading="lazy">
<p>å¯ä»¥åœ¨ä¸ä½¿ç”¨FPUæŒ‡ä»¤çš„å‰æå˜æ›´Sç¬¦å·ä½</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">float</span> <span class="token function">my_abs</span> <span class="token punctuation">(</span><span class="token keyword">float</span> i<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> tmp<span class="token operator">=</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>i<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x7FFFFFFF</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>tmp<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">float</span> <span class="token function">set_sign</span> <span class="token punctuation">(</span><span class="token keyword">float</span> i<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> tmp<span class="token operator">=</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>i<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0x80000000</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>tmp<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> <span class="token function">negate</span> <span class="token punctuation">(</span><span class="token keyword">float</span> i<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> tmp<span class="token operator">=</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>i<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">0x80000000</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>tmp<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span>
        <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"my_abs():\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"%f\n"</span><span class="token punctuation">,</span> <span class="token function">my_abs</span> <span class="token punctuation">(</span><span class="token number">123.456</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"%f\n"</span><span class="token punctuation">,</span> <span class="token function">my_abs</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">456.123</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"set_sign():\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"%f\n"</span><span class="token punctuation">,</span> <span class="token function">set_sign</span> <span class="token punctuation">(</span><span class="token number">123.456</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"%f\n"</span><span class="token punctuation">,</span> <span class="token function">set_sign</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">456.123</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"negate():\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"%f\n"</span><span class="token punctuation">,</span> <span class="token function">negate</span> <span class="token punctuation">(</span><span class="token number">123.456</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"%f\n"</span><span class="token punctuation">,</span> <span class="token function">negate</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">456.123</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç”¨ä½æ“ä½œC/C++æŒ‡ä»¤ä¹‹åï¼Œæˆ‘ä»¬ä¸å¿…åœ¨CPUå’ŒFPUçš„å¯„å­˜å™¨ä¹‹é—´ä¼ é€’æ•°æ®ã€å†è¿›è¡Œæ•°å­¦è¿ç®—äº†ã€‚æœ¬èŠ‚åˆ—ä¸¾äº†ä¸‰ä¸ªä½æ“ä½œå‡½æ•°ï¼š<code>æ¸…é™¤MSBç¬¦å·ä½çš„my_abs()å‡½æ•°ã€è®¾ç½®ç¬¦å·ä½çš„set_sign()å‡½æ•°åŠæ±‚è´Ÿå‡½æ•°negate()ã€‚</code></p>
<hr />
<p>x86</p>
<hr />
<p><code>Optimizing MSVS</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_tmp<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>
_i<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>
_my_abs PROC
        and     DWORD PTR _i<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token number">2147483647</span>    <span class="token comment">; 7fffffffH</span>
        fld     DWORD PTR _tmp<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
        ret     <span class="token number">0</span>
_my_abs ENDP<span class="token comment">;set S=0</span>

_tmp<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>
_i<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>
_set_sign PROC
        or      DWORD PTR _i<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token operator">-</span><span class="token number">2147483648</span>   <span class="token comment">; 80000000H</span>
        fld     DWORD PTR _tmp<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
        ret     <span class="token number">0</span>
_set_sign ENDP<span class="token comment">;set S=1</span>

_tmp<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>
_i<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>
_negate PROC
        xor     DWORD PTR _i<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token operator">-</span><span class="token number">2147483648</span>   <span class="token comment">; 80000000H</span>
        fld     DWORD PTR _tmp<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
        ret     <span class="token number">0</span>
_negate ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å‡½æ•°ä»æ ˆä¸­æå–ä¸€ä¸ªæµ®ç‚¹ç±»å‹çš„æ•°æ®ï¼Œä½†æ˜¯æŠŠå®ƒå½“ä½œæ•´æ•°ç±»å‹æ•°æ®è¿›è¡Œå¤„ç†ã€‚</p>
<p>ANDå’ŒORè®¾ç½®ç›¸åº”çš„æ¯”ç‰¹ä½ï¼Œè€ŒXORç”¨æ¥è®¾ç½®ç›¸åçš„ç¬¦å·ä½ã€‚</p>
<p>å› ä¸ºè¦æŠŠæµ®ç‚¹æ•°è¿˜ç»™FPUï¼Œæ‰€ä»¥æœ€åæŠŠä¿®æ”¹åçš„å¤„ç†ç»“æœä¿å­˜åˆ°ST0å¯„å­˜å™¨ã€‚</p>
<hr />
<p>x64</p>
<hr />
<p><code>optimizing msvs</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">tmp<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>
i<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>
my_abs  PROC
        movss   DWORD PTR <span class="token operator">[</span><span class="token register variable">rsp</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span>, <span class="token register variable">xmm0</span>
        mov     <span class="token register variable">eax</span>, DWORD PTR i<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">rsp</span><span class="token operator">]</span>
        btr     <span class="token register variable">eax</span>, <span class="token number">31</span>
        mov     DWORD PTR tmp<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">rsp</span><span class="token operator">]</span>, <span class="token register variable">eax</span>
        movss   <span class="token register variable">xmm0</span>, DWORD PTR tmp<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">rsp</span><span class="token operator">]</span>
        ret     <span class="token number">0</span>
my_abs  ENDP
_TEXT   ENDS

tmp<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>
i<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>
set_sign PROC
        movss   DWORD PTR <span class="token operator">[</span><span class="token register variable">rsp</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span>, <span class="token register variable">xmm0</span>
        mov     <span class="token register variable">eax</span>, DWORD PTR i<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">rsp</span><span class="token operator">]</span>
        bts     <span class="token register variable">eax</span>, <span class="token number">31</span>
        mov     DWORD PTR tmp<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">rsp</span><span class="token operator">]</span>, <span class="token register variable">eax</span>
        movss   <span class="token register variable">xmm0</span>, DWORD PTR tmp<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">rsp</span><span class="token operator">]</span>
        ret     <span class="token number">0</span>
set_sign ENDP

tmp<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>
i<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>
negate  PROC
        movss   DWORD PTR <span class="token operator">[</span><span class="token register variable">rsp</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span>, <span class="token register variable">xmm0</span>
        mov     <span class="token register variable">eax</span>, DWORD PTR i<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">rsp</span><span class="token operator">]</span>
        btc     <span class="token register variable">eax</span>, <span class="token number">31</span>
        mov     DWORD PTR tmp<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">rsp</span><span class="token operator">]</span>, <span class="token register variable">eax</span>
        movss   <span class="token register variable">xmm0</span>, DWORD PTR tmp<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">rsp</span><span class="token operator">]</span>
        ret     <span class="token number">0</span>
negate  END<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>
<p><strong>BTR (Bit Test and Reset)</strong>ï¼š</p>
<ul>
<li><strong>åŠŸèƒ½</strong>ï¼šæµ‹è¯•å¹¶å¤ä½ï¼ˆæ¸…é›¶ï¼‰æŒ‡å®šä½ç½®çš„ä½ã€‚</li>
<li><strong>è¯­æ³•</strong>ï¼š<code>BTR destination, source</code></li>
<li><strong>æ“ä½œ</strong>ï¼šé¦–å…ˆå°† destination æ“ä½œæ•°çš„ source æŒ‡å®šçš„ä½å€¼å­˜å‚¨åœ¨ CFï¼ˆCarry Flagï¼‰æ ‡å¿—ä¸­ï¼Œç„¶åå°†è¯¥ä½å¤ä½ï¼ˆå³æ¸…é›¶ï¼‰ã€‚</li>
<li><strong>ä¾‹å­</strong>ï¼š<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">BTR EAX, 5 ; æµ‹è¯• EAX å¯„å­˜å™¨ä¸­ç¬¬ 5 ä½çš„å€¼ï¼Œå°†å…¶å­˜å‚¨åœ¨ CF ä¸­ï¼Œç„¶åæ¸…é›¶è¿™ä¸ªä½<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
</li>
<li>
<p><strong>BTS (Bit Test and Set)</strong>ï¼š</p>
<ul>
<li><strong>åŠŸèƒ½</strong>ï¼šæµ‹è¯•å¹¶è®¾ç½®ï¼ˆç½®ä½ï¼‰æŒ‡å®šä½ç½®çš„ä½ã€‚</li>
<li><strong>è¯­æ³•</strong>ï¼š<code>BTS destination, source</code></li>
<li><strong>æ“ä½œ</strong>ï¼šé¦–å…ˆå°† destination æ“ä½œæ•°çš„ source æŒ‡å®šçš„ä½å€¼å­˜å‚¨åœ¨ CF æ ‡å¿—ä¸­ï¼Œç„¶åå°†è¯¥ä½ç½®ä½ï¼ˆå³è®¾ä¸º 1ï¼‰ã€‚</li>
<li><strong>ä¾‹å­</strong>ï¼š<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">BTS EAX, 5 ; æµ‹è¯• EAX å¯„å­˜å™¨ä¸­ç¬¬ 5 ä½çš„å€¼ï¼Œå°†å…¶å­˜å‚¨åœ¨ CF ä¸­ï¼Œç„¶åå°†è¿™ä½è®¾ä¸º 1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
</li>
<li>
<p><strong>BTC (Bit Test and Complement)</strong>ï¼š</p>
<ul>
<li>
<p><strong>åŠŸèƒ½</strong>ï¼šæµ‹è¯•å¹¶å–åï¼ˆç¿»è½¬ï¼‰æŒ‡å®šä½ç½®çš„ä½ã€‚</p>
</li>
<li>
<p><strong>è¯­æ³•</strong>ï¼š<code>BTC destination, source</code></p>
</li>
<li>
<p><strong>æ“ä½œ</strong>ï¼šé¦–å…ˆå°† destination æ“ä½œæ•°çš„ source æŒ‡å®šçš„ä½å€¼å­˜å‚¨åœ¨ CF æ ‡å¿—ä¸­ï¼Œç„¶åå°†è¯¥ä½å–åï¼ˆå¦‚æœæ˜¯ 1 åˆ™å˜ä¸º 0ï¼Œå¦‚æœæ˜¯ 0 åˆ™å˜ä¸º 1ï¼‰ã€‚</p>
</li>
<li>
<p><strong>ä¾‹å­</strong>ï¼š</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">BTC EAX, 5 ; æµ‹è¯• EAX å¯„å­˜å™¨ä¸­ç¬¬ 5 ä½çš„å€¼ï¼Œå°†å…¶å­˜å‚¨åœ¨ CF ä¸­ï¼Œç„¶åå°†è¿™ä½ç½®ä½ç¿»è½¬<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
</li>
</ol>
<ul>
<li>
<p>è¿™äº›æŒ‡ä»¤åœ¨è¿›è¡Œä½æ“ä½œæ—¶ä¼šä¿®æ”¹ CFï¼ˆè¿›ä½æ ‡å¿—ï¼‰ä»¥åæ˜ è¢«æµ‹è¯•çš„ä½å€¼ï¼Œå¯ä»¥ç”¨äºå®ç°å¤æ‚çš„ä½æ“ä½œå’Œé€»è¾‘åˆ¤æ–­ã€‚</p>
</li>
<li>
<p><code>movss</code> ç”¨äºåœ¨ SSEï¼ˆStreaming SIMD Extensionsï¼‰å¯„å­˜å™¨æˆ–å†…å­˜ä¹‹é—´ä¼ è¾“å•ç²¾åº¦æµ®ç‚¹æ•°ã€‚å®ƒçš„å…¨ç§°æ˜¯ â€œMove Scalar Single-Precision Floating-Point Valueâ€ã€‚</p>
</li>
<li>
<p>è¾“å…¥å€¼ä¼š<code>ç»XMM0å¯„å­˜å™¨å­˜å‚¨åˆ°å±€éƒ¨æ•°æ®æ ˆ</code>ï¼Œç„¶åé€šè¿‡BTRã€BTSã€BTCç­‰æŒ‡ä»¤è¿›è¡Œå¤„ç†ã€‚è¿™äº›æŒ‡ä»¤ç”¨äºé‡ç½®ï¼ˆBTRï¼‰ã€ç½®ä½ï¼ˆBTSï¼‰å’Œç¿»è½¬ï¼ˆBTCï¼‰ç‰¹å®šæ¯”ç‰¹ä½ã€‚å¦‚æœä»0å¼€å§‹æ•°çš„è¯ï¼Œæµ®ç‚¹æ•°çš„ç¬¬31ä½æ‰æ˜¯MSBã€‚</p>
</li>
<li>
<p>æœ€ç»ˆï¼Œè¿ç®—ç»“æœè¢«å¤åˆ¶åˆ°XMM0å¯„å­˜å™¨ã€‚åœ¨Win64ç³»ç»Ÿä¸­ï¼Œæµ®ç‚¹å‹è¿”å›å€¼è¦ä¿å­˜åœ¨è¿™ä¸ªå¯„å­˜å™¨é‡Œã€‚</p>
</li>
</ul>
<h5 id="ä½æ ¡éªŒ"><a class="markdownIt-Anchor" href="#ä½æ ¡éªŒ"></a> ä½æ ¡éªŒ</h5>
<p><em>ä»‹ç»ä¸€ä¸ªæµ‹ç®—è¾“å…¥å˜é‡çš„2è¿›åˆ¶æ•°é‡Œæœ‰å¤šå°‘ä¸ª1çš„å‡½æ•°ã€‚è¿™ç§å‡½æ•°å«ä½œâ€œpopulation count/ç‚¹æ•°â€å‡½æ•°ã€‚åœ¨æ”¯æŒSSE4çš„x86 CPUçš„æŒ‡ä»¤é›†é‡Œï¼Œç”šè‡³æœ‰ç›´æ¥å¯¹åº”çš„POPCNTæŒ‡ä»¤ã€‚</em></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">IS_SET</span><span class="token expression"><span class="token punctuation">(</span>flag<span class="token punctuation">,</span> bit<span class="token punctuation">)</span>    <span class="token punctuation">(</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>bit<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

<span class="token keyword">int</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> a<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">int</span> rt<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">32</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_SET</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
        rt<span class="token operator">++</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> rt<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">f</span><span class="token punctuation">(</span><span class="token number">0x12345678</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// test</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>1&lt;&lt;i</code>ä¼šé€ä¸€éå†32ä½æ•°å­—çš„æ¯ä¸€ä½ï¼ŒåŒæ—¶ä½¿å…¶ä»–ä½ç½®é›¶ï¼Œä»è€Œè®¡ç®—äºŒè¿›åˆ¶çš„1</p>
<p>è¿™æ®µç¨‹åºé‡Œï¼Œ1&lt;&lt;<em>i</em>å¯èƒ½äº§ç”Ÿçš„å€¼æœ‰ï¼š</p>
<table>
<thead>
<tr>
<th>C/C++è¡¨è¾¾å¼</th>
<th>2çš„æŒ‡æ•°</th>
<th>åè¿›åˆ¶æ•°</th>
<th>åå…­è¿›åˆ¶æ•°</th>
</tr>
</thead>
<tbody>
<tr>
<td>1&lt;&lt;0</td>
<td>20</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>1&lt;&lt;1</td>
<td>21</td>
<td>2</td>
<td>2</td>
</tr>
<tr>
<td>1&lt;&lt;2</td>
<td>22</td>
<td>4</td>
<td>4</td>
</tr>
<tr>
<td>1&lt;&lt;3</td>
<td>23</td>
<td>8</td>
<td>8</td>
</tr>
<tr>
<td>1&lt;&lt;4</td>
<td>24</td>
<td>16</td>
<td>0x10</td>
</tr>
<tr>
<td>1&lt;&lt;5</td>
<td>25</td>
<td>32</td>
<td>0x20</td>
</tr>
<tr>
<td>1&lt;&lt;6</td>
<td>26</td>
<td>64</td>
<td>0x40</td>
</tr>
<tr>
<td>1&lt;&lt;7</td>
<td>27</td>
<td>128</td>
<td>0x80</td>
</tr>
<tr>
<td>1&lt;&lt;8</td>
<td>28</td>
<td>256</td>
<td>0x100</td>
</tr>
<tr>
<td>1&lt;&lt;9</td>
<td>29</td>
<td>512</td>
<td>0x200</td>
</tr>
<tr>
<td>1&lt;&lt;10</td>
<td>210</td>
<td>1024</td>
<td>0x400</td>
</tr>
<tr>
<td>1&lt;&lt;11</td>
<td>211</td>
<td>2048</td>
<td>0x800</td>
</tr>
<tr>
<td>1&lt;&lt;12</td>
<td>212</td>
<td>4096</td>
<td>0x1000</td>
</tr>
<tr>
<td>1&lt;&lt;13</td>
<td>213</td>
<td>8192</td>
<td>0x2000</td>
</tr>
<tr>
<td>1&lt;&lt;14</td>
<td>214</td>
<td>16384</td>
<td>0x4000</td>
</tr>
<tr>
<td>1&lt;&lt;15</td>
<td>215</td>
<td>32768</td>
<td>0x8000</td>
</tr>
<tr>
<td>1&lt;&lt;16</td>
<td>216</td>
<td>65536</td>
<td>0x10000</td>
</tr>
<tr>
<td>1&lt;&lt;17</td>
<td>217</td>
<td>131072</td>
<td>0x20000</td>
</tr>
<tr>
<td>1&lt;&lt;18</td>
<td>218</td>
<td>262144</td>
<td>0x40000</td>
</tr>
<tr>
<td>1&lt;&lt;19</td>
<td>219</td>
<td>524288</td>
<td>0x80000</td>
</tr>
<tr>
<td>1&lt;&lt;20</td>
<td>220</td>
<td>1048576</td>
<td>0x100000</td>
</tr>
<tr>
<td>1&lt;&lt;21</td>
<td>221</td>
<td>2097152</td>
<td>0x200000</td>
</tr>
<tr>
<td>1&lt;&lt;22</td>
<td>222</td>
<td>4194304</td>
<td>0x400000</td>
</tr>
<tr>
<td>1&lt;&lt;23</td>
<td>223</td>
<td>8388608</td>
<td>0x800000</td>
</tr>
<tr>
<td>1&lt;&lt;24</td>
<td>224</td>
<td>16777216</td>
<td>0x1000000</td>
</tr>
<tr>
<td>1&lt;&lt;25</td>
<td>225</td>
<td>33554432</td>
<td>0x2000000</td>
</tr>
<tr>
<td>1&lt;&lt;26</td>
<td>226</td>
<td>67108864</td>
<td>0x4000000</td>
</tr>
<tr>
<td>1&lt;&lt;27</td>
<td>227</td>
<td>134217728</td>
<td>0x8000000</td>
</tr>
<tr>
<td>1&lt;&lt;28</td>
<td>228</td>
<td>268435456</td>
<td>0x10000000</td>
</tr>
<tr>
<td>1&lt;&lt;29</td>
<td>229</td>
<td>536870912</td>
<td>0x20000000</td>
</tr>
<tr>
<td>1&lt;&lt;30</td>
<td>230</td>
<td>1073741824</td>
<td>0x40000000</td>
</tr>
<tr>
<td>1&lt;&lt;31</td>
<td>231</td>
<td>2147483648</td>
<td>0x80000000</td>
</tr>
</tbody>
</table>
<p>é€†å‘å·¥ç¨‹çš„å®é™…å·¥ä½œä¸­ç»å¸¸å‡ºç°è¿™äº›å¸¸æ•°ï¼ˆbit maskï¼‰ã€‚é€†å‘å·¥ç¨‹äººå‘˜åº”å½“å¸¸å¤‡è¿™ä¸ªè¡¨æ ¼ã€‚èƒŒä¸‹åå…­è¿›åˆ¶æ•°å¹¶ä¸å¤ªå›°éš¾ã€‚</p>
<hr />
<p>x86 msvs nasm</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_rt<span class="token operator">$</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">8</span>             <span class="token comment">;size=4</span>
_i<span class="token operator">$</span> <span class="token operator">=</span><span class="token operator">-</span><span class="token number">4</span>               <span class="token comment">;size=4</span>
_a<span class="token operator">$</span> <span class="token operator">=</span><span class="token number">8</span>                <span class="token comment">;size=4</span>

_f PROC
    push   <span class="token register variable">ebp</span>
    mov    <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
    sub    <span class="token register variable">esp</span>, <span class="token number">8</span>
    mov    WORD PTR _rt<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token number">0</span>
    mov    DWORD PTR _i<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token number">0</span>
    jmp    SHORT <span class="token operator">$</span>LN4@f
<span class="token label function">$LN3@f:</span>
    mov    <span class="token register variable">ax</span>, DWORD PTR _i<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>    <span class="token comment">; é€’å¢</span>
    add    x, <span class="token number">1</span>
    mov    WORD PTR _i<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token register variable">eax</span>
<span class="token label function">$LN4@f:</span>
    cmp    DWORD PTR _i<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token number">32</span>    <span class="token comment">; 00000020H</span>
    jge    SHORT <span class="token operator">$</span>LN2@f              <span class="token comment">; å¾ªç¯ç»“æŸï¼Ÿ</span>
    mov    <span class="token register variable">edx</span>, <span class="token number">1</span>
    mov    <span class="token register variable">ecx</span>, DWORD PTR _i<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
    shl    <span class="token register variable">edx</span>, <span class="token register variable">cl</span>                   <span class="token comment">; EDX=EDX&lt;&lt;CL</span>
    and    <span class="token register variable">edx</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
    je     SHORT <span class="token operator">$</span>LN1@f              <span class="token comment">; result of AND instruction was 0?</span>
                                     <span class="token comment">; then skip next instructions</span>
    mov    <span class="token register variable">eax</span>, DWORD PTR _rt<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>  <span class="token comment">; no, not zero</span>
    add    <span class="token register variable">eax</span>, <span class="token number">1</span>                    <span class="token comment">; increment rt</span>
    mov    DWORD PTR _rt<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token register variable">eax</span><span class="token comment">;rt+=1</span>
<span class="token label function">$LN1@f:</span>
    jmp    SHORT <span class="token operator">$</span>LN3@f
    <span class="token label function">$LN2@f:</span>
    mov    <span class="token register variable">eax</span>, DWORD PTR _rt<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
    mov    <span class="token register variable">esp</span>, <span class="token register variable">ebp</span>
    pop    <span class="token register variable">ebp</span>
    ret    <span class="token number">0</span>
_f    ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ¯”è¾ƒç®€å•ï¼Œä¸éš¾çœ‹æ‡‚ï¼Œï¼Œï¼Œ</p>
<hr />
<p><code>gcc</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">             public f
f            proc near

rt           <span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">0Ch</span>
i            <span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">8</span>
arg_0        <span class="token operator">=</span> dword ptr  <span class="token number">8</span>

             push    <span class="token register variable">ebp</span>
             mov     <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
             push    <span class="token register variable">ebx</span>
             sub     <span class="token register variable">esp</span>, <span class="token number">10h</span>
             mov     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>rt<span class="token operator">]</span>, <span class="token number">0</span><span class="token comment">;rt=0</span>
             mov     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>i<span class="token operator">]</span>, <span class="token number">0</span><span class="token comment">;i=0</span>
             jmp     short loc_80483EF
<span class="token label function">loc_80483D0:</span>
             mov     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>i<span class="token operator">]</span><span class="token comment">;eax=i</span>
             mov     <span class="token register variable">edx</span>, <span class="token number">1</span><span class="token comment">;edx=1</span>
             mov     <span class="token register variable">ebx</span>, <span class="token register variable">edx</span><span class="token comment">;ebx=edx=1</span>
             mov     <span class="token register variable">ecx</span>, <span class="token register variable">eax</span><span class="token comment">;ecx=i</span>
             shl     <span class="token register variable">ebx</span>, <span class="token register variable">cl</span><span class="token comment">;ebx&lt;&lt;=cl;1&lt;&lt;cl</span>
             mov     <span class="token register variable">eax</span>, <span class="token register variable">ebx</span><span class="token comment">;eax=ebx</span>
             and     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>arg_0<span class="token operator">]</span><span class="token comment">;eax&amp;=arg_0</span>
             test    <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
             jz      short loc_80483EB<span class="token comment">;&amp;=0,no ++l&amp;=1,++</span>
             add     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>rt<span class="token operator">]</span>, <span class="token number">1</span><span class="token comment">;rt+=1</span>
<span class="token label function">loc_80483EB:</span>
             add     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>i<span class="token operator">]</span>, <span class="token number">1</span>
<span class="token label function">loc_80483EF:</span><span class="token comment">;main loop</span>
             cmp     <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>i<span class="token operator">]</span>, <span class="token number">1Fh</span><span class="token comment">;i ?=31</span>
             jle     short loc_80483D0<span class="token comment">;y,continue;no,jmp</span>
             mov     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>rt<span class="token operator">]</span><span class="token comment">;eax=rt</span>
             add     <span class="token register variable">esp</span>, <span class="token number">10h</span>
             pop     <span class="token register variable">ebx</span>
             pop     <span class="token register variable">ebp</span>
             retn
f            endp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr />
<p>x64</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">IS_SET</span><span class="token expression"><span class="token punctuation">(</span>flag<span class="token punctuation">,</span> bit<span class="token punctuation">)</span>   <span class="token punctuation">(</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>bit<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

<span class="token keyword">int</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span> a<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token class-name">uint64_t</span> i<span class="token punctuation">;</span>
    <span class="token keyword">int</span> rt<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">64</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_SET</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">1ULL</span><span class="token operator">&lt;&lt;</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
            rt<span class="token operator">++</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> rt<span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>Non-optimizing GCC 4.8.2</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token label function">f:</span>
        push    <span class="token register variable">rbp</span>
        mov     <span class="token register variable">rbp</span>, <span class="token register variable">rsp</span>
        mov     QWORD PTR <span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">-</span><span class="token number">24</span><span class="token operator">]</span>, <span class="token register variable">rdi</span>   <span class="token comment">; a</span>
        mov     DWORD PTR <span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">]</span>, <span class="token number">0</span>     <span class="token comment">; rt=0</span>
        mov     QWORD PTR <span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">-</span><span class="token number">8</span><span class="token operator">]</span>, <span class="token number">0</span>      <span class="token comment">; i=0</span>
        jmp     .L2
<span class="token label function">.L4:</span>
        mov     <span class="token register variable">rax</span>, QWORD PTR <span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">-</span><span class="token number">8</span><span class="token operator">]</span>
        mov     <span class="token register variable">rdx</span>, QWORD PTR <span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">-</span><span class="token number">24</span><span class="token operator">]</span>
<span class="token comment">; RAX = i, RDX = a</span>
        mov     <span class="token register variable">ecx</span>, <span class="token register variable">eax</span>
<span class="token comment">; ECX = i</span>
        shr     <span class="token register variable">rdx</span>, <span class="token register variable">cl</span>
<span class="token comment">; RDX = RDX>>CL = a>>i</span>
        mov     <span class="token register variable">rax</span>, <span class="token register variable">rdx</span>
<span class="token comment">; RAX = RDX = a>>i</span>
        and     <span class="token register variable">eax</span>, <span class="token number">1</span>
<span class="token comment">; EAX = EAX&amp;1 = (a>>i)&amp;1</span>
        test    <span class="token register variable">rax</span>, <span class="token register variable">rax</span>
<span class="token comment">; the last bit is zero?</span>
<span class="token comment">; skip the next ADD instruction, if it was so.</span>
        je      .L3
        add     DWORD PTR <span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">]</span>, <span class="token number">1</span>     <span class="token comment">; rt++</span>
<span class="token label function">.L3:</span>
        add     QWORD PTR <span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">-</span><span class="token number">8</span><span class="token operator">]</span>, <span class="token number">1</span>      <span class="token comment">; i++</span>
<span class="token label function">.L2:</span>
        cmp     QWORD PTR <span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">-</span><span class="token number">8</span><span class="token operator">]</span>, <span class="token number">63</span>     <span class="token comment">; i&lt; 63?</span>
        jbe     .L4                       <span class="token comment">; jump to the loop boday begin, if so</span>
        mov     <span class="token register variable">eax</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">]</span>   <span class="token comment">; return rt</span>
        pop     <span class="token register variable">rbp</span>
        ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸x86å‡ ä¹ä¸€æ ·</p>
<hr />
<p><code>Optimizing GCC</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token number">1</span> f:
 <span class="token number">2</span>      xor     <span class="token register variable">eax</span>, <span class="token register variable">eax</span>             <span class="token comment">; rt variable will be in EAX register</span>
 <span class="token number">3</span>      xor     <span class="token register variable">ecx</span>, <span class="token register variable">ecx</span>             <span class="token comment">; i variable will be in ECX register</span>
 <span class="token number">4</span> .L3:
 <span class="token number">5</span>      mov     <span class="token register variable">rsi</span>, <span class="token register variable">rdi</span>             <span class="token comment">; load input value</span>
 <span class="token number">6</span>      lea     <span class="token register variable">edx</span>, <span class="token operator">[</span><span class="token register variable">rax</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">]</span>         <span class="token comment">; EDX=EAX+1</span>
 <span class="token number">7</span> <span class="token comment">; EDX here is a "new version of rt", which will be written into rt variable, if the last bit is 1</span>
 <span class="token number">8</span>      shr     <span class="token register variable">rsi</span>, <span class="token register variable">cl</span>              <span class="token comment">; RSI=RSI>>CL</span>
 <span class="token number">9</span>      and     <span class="token register variable">esi</span>, <span class="token number">1</span>               <span class="token comment">; ESI=ESI&amp;1</span>
<span class="token number">10</span> <span class="token comment">; the last bit is 1? If so, write "new version of rt" into EAX</span>
<span class="token number">11</span>      cmovne  <span class="token register variable">eax</span>, <span class="token register variable">edx</span>
<span class="token number">12</span>      add     <span class="token register variable">rcx</span>, <span class="token number">1</span>               <span class="token comment">; RCX++</span>
<span class="token number">13</span>      cmp     <span class="token register variable">rcx</span>, <span class="token number">64</span>
<span class="token number">14</span>      jne     .L3
<span class="token number">15</span>      rep ret                      <span class="token comment">; AKA fatret</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p>å…ˆå‰çš„ç¨‹åºéƒ½æ˜¯å…ˆæ¯”è¾ƒç‰¹å®šä½ï¼Œå†<code>rt++</code>ï¼Œè€Œè¿™æ®µç¨‹åºçš„é¡ºåºæœ‰æ‰€ä¸åŒï¼Œæ˜¯å…ˆé€’å¢<code>rt</code>å†å†™å…¥<code>EDX</code>å¯„å­˜å™¨</p>
</li>
<li>
<p><code>line 11</code>å¦‚æœæœ€åçš„æ¯”ç‰¹ä½æ˜¯1ï¼Œé‚£ä¹ˆç¨‹åºå°†ä½¿ç”¨CMOVNEæŒ‡ä»¤ï¼ˆç­‰åŒäºCMOVNZï¼‰æŠŠEDXå¯„å­˜å™¨ï¼ˆrtçš„å€™é€‰å€¼ï¼‰ä¼ é€’ç»™EAXå¯„å­˜å™¨ï¼ˆå½“å‰çš„rtå€¼ï¼Œä¹Ÿæ˜¯å‡½æ•°çš„è¿”å›å€¼ï¼‰ï¼Œä»è€Œå®Œæˆrtçš„æ›´æ–°ã€‚</p>
</li>
<li>
<p>è¿­ä»£64æ¬¡</p>
</li>
<li>
<p>ä¼˜ç‚¹ï¼šå› ä¸ºå®ƒåªå«æœ‰ä¸€ä¸ªæ¡ä»¶è½¬ç§»æŒ‡ä»¤ï¼ˆåœ¨å¾ªç¯çš„å°¾éƒ¨ï¼‰ï¼Œæ‰€ä»¥è¿™ç§ç¼–è¯‘æ–¹æ³•ç‹¬å…·ä¼˜åŠ¿ã€‚å¦‚æœç¼–è¯‘çš„æ–¹å¼è¿‡äºæœºæ¢°åŒ–ï¼Œé‚£ä¹ˆç¨‹åºè¦åœ¨é€’å¢rtå’Œå¾ªç¯å°¾éƒ¨è¿›è¡Œä¸¤æ¬¡æ¡ä»¶è½¬ç§»ã€‚ç°åœ¨çš„CPUéƒ½å…·æœ‰åˆ†æ”¯é¢„æµ‹çš„åŠŸèƒ½ï¼ˆè¯·å‚åŠ æœ¬ä¹¦33.1èŠ‚ï¼‰ã€‚åœ¨æ€§èƒ½æ–¹é¢ï¼Œæœ¬ä¾‹è¿™ç±»ç¨‹åºçš„æ•ˆç‡æ›´é«˜ã€‚</p>
</li>
<li>
<p><code>line 15</code>çš„æŒ‡ä»¤<code>rep ret</code>ç›¸å½“äº<code>MSVS</code>çš„<code>FATRET</code>ï¼Œæ˜¯ç”±retè¡ç”Ÿå‡ºæ¥çš„å‘ä¼˜åŒ–æŒ‡ä»¤</p>
<p><em>AMDå»ºè®®ï¼šå¦‚æœRETæŒ‡ä»¤çš„å‰ä¸€æ¡æŒ‡ä»¤æ˜¯æ¡ä»¶è½¬ç§»æŒ‡ä»¤ï¼Œé‚£ä¹ˆåœ¨å‡½æ•°æœ€åçš„è¿”å›æŒ‡ä»¤æœ€å¥½ä½¿ç”¨REP RETæŒ‡ä»¤ã€‚</em></p>
</li>
</ul>
<hr />
<p><code>optimizing msvs</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">a<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>
f       PROC
<span class="token comment">; RCX = input value</span>
        xor     <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
        mov     <span class="token register variable">edx</span>, <span class="token number">1</span>
        lea     <span class="token register variable">r8d</span>, QWORD PTR <span class="token operator">[</span><span class="token register variable">rax</span><span class="token operator">+</span><span class="token number">64</span><span class="token operator">]</span>
<span class="token comment">; R8D=64</span>
        npad    <span class="token number">5</span><span class="token comment">;align</span>
<span class="token label function">$LL4@f:</span>
        test    <span class="token register variable">rdx</span>, <span class="token register variable">rcx</span>
<span class="token comment">; there are no such bit in input value?</span>
<span class="token comment">; skip the next INC instruction then.</span>
        je      SHORT <span class="token operator">$</span>LN3@f
        inc     <span class="token register variable">eax</span>     <span class="token comment">; rt++</span>
<span class="token label function">$LN3@f:</span>
        rol     <span class="token register variable">rdx</span>, <span class="token number">1</span>  <span class="token comment">; RDX=RDX&lt;&lt;1</span>
        dec     <span class="token register variable">r8</span>      <span class="token comment">; R8--</span>
        jne     SHORT <span class="token operator">$</span>LL4@f
        fatret  <span class="token number">0</span>
f       ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>ROL</code> å’Œ <code>SHL</code> æ˜¯ x86 æ±‡ç¼–è¯­è¨€ä¸­çš„ä¸¤ç§ä¸åŒçš„ç§»ä½æŒ‡ä»¤ï¼Œå®ƒä»¬è™½ç„¶éƒ½æ¶‰åŠä½æ“ä½œï¼Œä½†åŠŸèƒ½å’Œæ•ˆæœä¸åŒã€‚ä»¥ä¸‹æ˜¯å®ƒä»¬çš„è¯¦ç»†è§£é‡Šï¼š</p>
<p>ROLï¼ˆRotate Leftï¼‰</p>
<p><strong>åŠŸèƒ½</strong>ï¼šå¾ªç¯å·¦ç§»ä½</p>
<ul>
<li><strong>è¯­æ³•</strong>ï¼š<code>ROL destination, count</code></li>
<li><strong>æ“ä½œ</strong>ï¼šå°†ç›®çš„æ“ä½œæ•°ä¸­çš„æ‰€æœ‰ä½å‘å·¦ç§»åŠ¨æŒ‡å®šçš„æ¬¡æ•°ï¼ˆ<code>count</code>ï¼‰ï¼Œé«˜ä½å·¦ç§»åé‡æ–°è¿›å…¥æœ€ä½ä½ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯å¾ªç¯çš„ã€‚</li>
<li><strong>æ•ˆæœ</strong>ï¼šä¸ä¼šä¸¢å¤±ä»»ä½•ä½ï¼ŒåŸæœ¬è¢«ç§»å‡ºçš„é«˜ä½å°†ä¼šé‡æ–°è¿›å…¥ä½ä½ã€‚</li>
<li><strong>ä¾‹å­</strong>ï¼š<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">ROL EAX, 1 ; å°† EAX å¯„å­˜å™¨çš„å€¼å¾ªç¯å·¦ç§» 1 ä½ï¼Œä¾‹å¦‚ï¼š0b1011 -&gt; 0b0111<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<p>SHLï¼ˆShift Logical Leftï¼‰</p>
<p><strong>åŠŸèƒ½</strong>ï¼šé€»è¾‘å·¦ç§»ä½</p>
<ul>
<li><strong>è¯­æ³•</strong>ï¼š<code>SHL destination, count</code></li>
<li><strong>æ“ä½œ</strong>ï¼šå°†ç›®çš„æ“ä½œæ•°çš„æ‰€æœ‰ä½å‘å·¦ç§»åŠ¨æŒ‡å®šçš„æ¬¡æ•°ï¼ˆ<code>count</code>ï¼‰ï¼Œé«˜ä½ç§»å‡ºåä¸¢å¼ƒï¼Œä½ä½ç”¨ 0 å¡«è¡¥ã€‚</li>
<li><strong>æ•ˆæœ</strong>ï¼šåœ¨å·¦ç§»è¿‡ç¨‹ä¸­é«˜ä½ä¸¢å¤±ï¼Œä½ä½ç”¨0å¡«å……ã€‚</li>
<li><strong>ä¾‹å­</strong>ï¼š<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">SHL EAX, 1 ; å°† EAX å¯„å­˜å™¨çš„å€¼å·¦ç§» 1 ä½ï¼Œä½ä½ç”¨ 0 å¡«å……ï¼Œä¾‹å¦‚ï¼š0b1011 -&gt; 0b0110ï¼ˆä½ä½ä¸º0ï¼‰<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<p><code>ROL</code>æŒ‡ä»¤æ›¿ä»£äº†<code>SHL</code>ï¼Œ<code>ROL</code>æ˜¯<code>rotate left</code>ï¼Œä¸<code>SHL</code>åœ¨æœ¬ä¾‹ä¸­æ•ˆæœä¸€æ ·</p>
<p><code>R8</code>ä»64é€’å‡ä¸º0,å¾ªç¯64æ¬¡</p>
<h4 id="promblem"><a class="markdownIt-Anchor" href="#promblem"></a> Promblem</h4>
<ol>
<li></li>
</ol>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_a<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>
_f      PROC
        mov     <span class="token register variable">ecx</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span><span class="token comment">;ecx=a</span>
        mov     <span class="token register variable">eax</span>, <span class="token register variable">ecx</span><span class="token comment">;eax=a</span>
        mov     <span class="token register variable">edx</span>, <span class="token register variable">ecx</span><span class="token comment">;edx=a</span>
        shl     <span class="token register variable">edx</span>, <span class="token number">16</span>         <span class="token comment">; 00000010H;edx=a&lt;&lt;16</span>
        and     <span class="token register variable">eax</span>, <span class="token number">65280</span>      <span class="token comment">; 0000ff00H;eax=a&amp;0xff00</span>
        or      <span class="token register variable">eax</span>, <span class="token register variable">edx</span><span class="token comment">;eax|a&lt;&lt;16;eax=a&amp;0xff00|a&lt;&lt;16</span>
        mov     <span class="token register variable">edx</span>, <span class="token register variable">ecx</span><span class="token comment">;edx=ecx=a</span>
        and     <span class="token register variable">edx</span>, <span class="token number">16711680</span>   <span class="token comment">; 00ff0000H;edx=a&amp;0xff0000</span>
        shr     <span class="token register variable">ecx</span>, <span class="token number">16</span>         <span class="token comment">; 00000010H;ecx=a>>16</span>
        or      <span class="token register variable">edx</span>, <span class="token register variable">ecx</span><span class="token comment">;;edx=a&amp;0xff0000|a>>16</span>
        shl     <span class="token register variable">eax</span>, <span class="token number">8</span><span class="token comment">;eax&lt;&lt;8;eax=(a&amp;0xff00|a&lt;&lt;16)&lt;&lt;8</span>
        shr     <span class="token register variable">edx</span>, <span class="token number">8</span><span class="token comment">;;eax>>8;edx=(a&amp;0xff0000|a>>16)>>8</span>
        or      <span class="token register variable">eax</span>, <span class="token register variable">edx</span><span class="token comment">;eax|edx;((a&amp;0xff00|a&lt;&lt;16)&lt;&lt;8)|((a&amp;0xff0000|a>>16)>>8)</span>
        ret     <span class="token number">0</span>
_f      ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>é€†å‘å¾—åˆ°çš„é€»è¾‘æ˜¯<code>return ((a&amp;0xff00|a&lt;&lt;16)&lt;&lt;8)|((a&amp;0xff0000|a&gt;&gt;16)&gt;&gt;8)</code></p>
<p>äº‹å®ä¸ŠåŒ–ç®€ç»“æœä¸æºç æ˜¯ç­‰ä»·çš„,ç¼–è¯‘å™¨å¯¹è¿™ä¸€ç³»åˆ—æ“ä½œè¿›è¡Œäº†ä¼˜åŒ–</p>
<img src="/2024/05/23/re4b%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image-20240609153017613.png" class="" alt="image-20240609153017613" loading="lazy">
<ol start="2">
<li></li>
</ol>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_a<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>                                    <span class="token comment">; size = 4</span>
_f      PROC
        push   <span class="token register variable">esi</span>
        mov    <span class="token register variable">esi</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">]</span><span class="token comment">;esi=a</span>
        xor    <span class="token register variable">ecx</span>, <span class="token register variable">ecx</span><span class="token comment">;ecx=0</span>
        push   <span class="token register variable">edi</span><span class="token comment">;save edi</span>
        lea    <span class="token register variable">edx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">]</span><span class="token comment">;edx=1</span>
        xor    <span class="token register variable">eax</span>, <span class="token register variable">eax</span><span class="token comment">;eax=0</span>
        npad   <span class="token number">3</span> <span class="token comment">; align next label</span>
        <span class="token comment">;loop0:edx=1;ecx=counter=i=0</span>
<span class="token label function">$LL3@f:</span>
        mov    <span class="token register variable">edi</span>, <span class="token register variable">esi</span><span class="token comment">;edi=a</span>
        shr    <span class="token register variable">edi</span>, <span class="token register variable">cl</span><span class="token comment">;edi=(a>>cl)&amp;0xff(ecx,low,içš„ä½8ä½)</span>
        add    <span class="token register variable">ecx</span>, <span class="token number">4</span><span class="token comment">;ecx=i+4</span>
        and    <span class="token register variable">edi</span>, <span class="token number">15</span><span class="token comment">;edi=a>>cl&amp;15</span>
        imul   <span class="token register variable">edi</span>, <span class="token register variable">edx</span><span class="token comment">;edi*edx;edi=(a>>cl)*edx</span>
        lea    <span class="token register variable">edx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">edx</span><span class="token operator">+</span><span class="token register variable">edx</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span><span class="token comment">;edx=edx*5</span>
        add    <span class="token register variable">eax</span>, <span class="token register variable">edi</span><span class="token comment">;eax=eax+(a>>cl)*edx</span>
        add    <span class="token register variable">edx</span>, <span class="token register variable">edx</span><span class="token comment">;edx=edx*2=edx*10</span>
        cmp    <span class="token register variable">ecx</span>, <span class="token number">28</span><span class="token comment">;ecx=28?</span>
        jle    SHORT <span class="token operator">$</span>LL3@f
        pop    <span class="token register variable">edi</span>
        pop    <span class="token register variable">esi</span>
        ret    <span class="token number">0</span>
_f      ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">function <span class="token function">f</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">)</span><span class="token comment">//è¿™é‡Œåº”è¯¥æ˜¯unsigned int</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> eax<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> temp<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span><span class="token number">28</span><span class="token punctuation">;</span>i<span class="token operator">+=</span><span class="token number">4</span><span class="token punctuation">,</span>temp<span class="token operator">*=</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        eax<span class="token operator">+=</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token operator">>></span>i<span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0xf</span><span class="token punctuation">)</span><span class="token operator">*</span>j<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> eax<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>é€†å‘å¾—åˆ°çš„æºç ,<code>è¿™æ˜¯ä¸€ä¸ªæŠŠBCDå°è£…çš„32ä½äºŒè¿›åˆ¶å€¼è½¬æ¢ä¸ºå¸¸è§„æ ¼å¼çš„10è¿›åˆ¶çš„å‡½æ•°</code></p>
<p><em>BCDï¼ˆBinary-Coded Decimalï¼ŒäºŒè¿›åˆ¶ç¼–ç çš„åè¿›åˆ¶ï¼‰è¡¨ç¤ºæ³•æ˜¯ä¸€ç§è¡¨è¾¾åè¿›åˆ¶æ•°å­—çš„æ–¹æ³•ï¼Œæ¯ä¸ªåè¿›åˆ¶æ•°å­—ï¼ˆ0-9ï¼‰éƒ½ç”¨ä¸€ä¸ªå›ºå®šé•¿åº¦çš„äºŒè¿›åˆ¶æ•°è¡¨ç¤ºã€‚</em></p>
<p>æºç å¦‚ä¸‹</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> a<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
       <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
       <span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
       <span class="token keyword">unsigned</span> <span class="token keyword">int</span> rt<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
       <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span><span class="token number">28</span><span class="token punctuation">;</span> i<span class="token operator">+=</span><span class="token number">4</span><span class="token punctuation">,</span> j<span class="token operator">*=</span><span class="token number">10</span><span class="token punctuation">)</span>
          rt<span class="token operator">+=</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token operator">>></span>i<span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0xF</span><span class="token punctuation">)</span> <span class="token operator">*</span> j<span class="token punctuation">;</span>
       <span class="token keyword">return</span> rt<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¾‹å¦‚34ä»£è¡¨0011 0100</p>
<ol start="3">
<li></li>
</ol>
<p>è¯·æŸ¥é˜…MSDNèµ„æ–™ï¼Œæ‰¾åˆ°MessageBox()å‡½æ•°ä½¿ç”¨äº†å“ªäº›æ ‡å¿—ä½ã€‚</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;windows.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
         <span class="token function">MessageBox</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"hello, world!"</span><span class="token punctuation">,</span> <span class="token string">"caption"</span><span class="token punctuation">,</span>
                     MB_TOPMOST <span class="token operator">|</span> MB_ICONINFORMATION <span class="token operator">|</span> MB_HELP <span class="token operator">|</span> MB_YESNOCANCEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="4">
<li></li>
</ol>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_m<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>         <span class="token comment">; size = 4</span>
_n<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">12</span>        <span class="token comment">; size = 4</span>
_f      PROC
        <span class="token comment">; å°† ecx è®¾ç½®ä¸ºå˜é‡ n çš„å€¼ï¼›ecx=12</span>
        mov     <span class="token register variable">ecx</span>, DWORD PTR _n<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
        <span class="token comment">; å°† eax å’Œ edx æ¸…é›¶</span>
        xor     <span class="token register variable">eax</span>, <span class="token register variable">eax</span><span class="token comment">;eax=0</span>
        xor     <span class="token register variable">edx</span>, <span class="token register variable">edx</span><span class="token comment">;edx=0</span>
        <span class="token comment">; æµ‹è¯• ecx æ˜¯å¦ä¸ºé›¶ï¼Œå¦‚æœä¸ºé›¶åˆ™è·³è½¬åˆ° $LN2@f ä½ç½®</span>
        test    <span class="token register variable">ecx</span>, <span class="token register variable">ecx</span>
        je      SHORT <span class="token operator">$</span>LN2@f<span class="token comment">;loop exitï¼Ÿ</span>
        <span class="token comment">; ä¿å­˜ esi å¯„å­˜å™¨åŸå€¼åˆ°æ ˆ</span>
        push    <span class="token register variable">esi</span>
        <span class="token comment">; å°†å˜é‡ m çš„å€¼èµ‹ç»™ esi</span>
        mov     <span class="token register variable">esi</span>, DWORD PTR _m<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">]</span><span class="token comment">;esi=m</span>
<span class="token label function">$LL3@f:</span>
        <span class="token comment">; æµ‹è¯• ecx çš„æœ€ä½ä½ï¼ˆå³ cl çš„æœ€ä½ä½ï¼‰</span>
        test    <span class="token register variable">cl</span>, <span class="token number">1</span>
        <span class="token comment">; å¦‚æœæœ€ä½ä½ä¸º 0 åˆ™è·³è½¬åˆ° $LN1@f ä½ç½®</span>
        je      SHORT <span class="token operator">$</span>LN1@f
        <span class="token comment">; å¦‚æœæœ€ä½ä½ä¸º 1ï¼Œåˆ™å°† esi åŠ åˆ° eax ä¸­ï¼Œå¹¶è€ƒè™‘è¿›ä½åŠ åˆ° edx ä¸­</span>
        add     <span class="token register variable">eax</span>, <span class="token register variable">esi</span><span class="token comment">;eax=eax+m</span>
        adc     <span class="token register variable">edx</span>, <span class="token number">0</span>
<span class="token label function">$LN1@f:</span>
        <span class="token comment">; å°† esi å·¦ç§»ä¸€ä½ï¼ˆå³ä¹˜ 2ï¼‰</span>
        add     <span class="token register variable">esi</span>, <span class="token register variable">esi</span><span class="token comment">;m*2</span>
        <span class="token comment">; å°† ecx å³ç§»ä¸€ä½ï¼ˆå³é™¤ 2ï¼‰</span>
        shr     <span class="token register variable">ecx</span>, <span class="token number">1</span><span class="token comment">;n/=2</span>
        <span class="token comment">; å¦‚æœ ecx ä¸ä¸ºé›¶ï¼Œåˆ™ç»§ç»­å¾ªç¯</span>
        jne     SHORT <span class="token operator">$</span>LL3@f
        <span class="token comment">; æ¢å¤è¢«ä¿å­˜çš„ esi å¯„å­˜å™¨å€¼</span>
        pop     <span class="token register variable">esi</span>
<span class="token label function">$LN2@f:</span>
        <span class="token comment">; è¿”å›åˆ°è°ƒç”¨è€…</span>
        ret     <span class="token number">0</span>
_f      ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">m<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">;</span>
n<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">;</span>
function <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> eax<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span>n<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">;</span>n<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span>m<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>n<span class="token operator">&amp;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ç›¸å½“äºæ˜¯<span class="token punctuation">(</span>m<span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">^</span><span class="token number">3</span><span class="token operator">*</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token punctuation">(</span>m<span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">^</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            eax<span class="token operator">+=</span>m<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> eax<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>é€»è¾‘è¿˜åŸäº†ï¼Œä½†æ˜¯è¿˜æ˜¯æ²¡çœ‹å‡ºæ¥æ˜¯å¹²å˜›çš„</p>
<p>çœ‹æºç çš„åŠŸèƒ½æ˜¯æŠŠ32ä½æ•°ç›¸ä¹˜(è¿™ä¸ªæ˜¯ä¹˜æ³•ä¼˜åŒ–çš„ç®—æ³•)ï¼Œè¿”å›64ä½çš„ç§¯</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span>

<span class="token comment">// source code taken from</span>
<span class="token comment">//http://www4.wittenberg.edu/academics/mathcomp/shelburne/comp255/notes/binarymultiplication.pdf</span>

<span class="token class-name">uint64_t</span> <span class="token function">mult</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span> m<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> n<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token class-name">uint64_t</span> p <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// initialize product p to 0</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>n <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// while multiplier n is not 0</span>
    <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// test LSB of multiplier</span>
            p <span class="token operator">=</span> p <span class="token operator">+</span> m<span class="token punctuation">;</span> <span class="token comment">// if 1 then add multiplicand m</span>
        m <span class="token operator">=</span> m <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// left shift multiplicand</span>
        n <span class="token operator">=</span> n <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// right shift multiplier</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> p<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="chap20-çº¿æ€§åŒä½™æ³•ä¸ä¼ªéšæœºæ•°"><a class="markdownIt-Anchor" href="#chap20-çº¿æ€§åŒä½™æ³•ä¸ä¼ªéšæœºæ•°"></a> Chap20 çº¿æ€§åŒä½™æ³•ä¸ä¼ªéšæœºæ•°</h3>
<p><em>çº¿æ€§åŒä½™æ³•æ˜¯ç”Ÿæˆéšæœºæ•°çš„æœ€ç®€æ–¹æ³•ï¼Œè™½ç„¶ç›®å‰çš„éšæœºå‡½æ•°éƒ½ä¸ç”¨äº†ï¼Œä½†æ˜¯åŸç†ç®€å•ï¼ˆåªæ¶‰åŠä¹˜æ³•ã€åŠ æ³•å’Œä¸è¿ç®—ï¼‰</em></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span>

<span class="token comment">// constants from the Numerical Recipes book</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RNG_a</span> <span class="token expression"><span class="token number">1664525</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RNG_c</span> <span class="token expression"><span class="token number">1013904223</span></span></span>

<span class="token keyword">static</span> <span class="token class-name">uint32_t</span> rand_state<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">my_srand</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span> init<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        rand_state<span class="token operator">=</span>init<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">my_rand</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        rand_state<span class="token operator">=</span>rand_state<span class="token operator">*</span>RNG_a<span class="token punctuation">;</span>
        rand_state<span class="token operator">=</span>rand_state<span class="token operator">+</span>RNG_c<span class="token punctuation">;</span>
        <span class="token keyword">return</span> rand_state <span class="token operator">&amp;</span> <span class="token number">0x7fff</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç¬¬ä¸€ä¸ªå‡½æ•°ç”¨äºåˆå§‹åŒ–å†…éƒ¨çŠ¶æ€ï¼Œç¬¬äºŒä¸ªå‡½æ•°ç”Ÿæˆä¼ªéšæœºæ•°</p>
<p>è¿™é‡Œçš„&amp;å¯ä»¥æ§åˆ¶ä½æ•°</p>
<hr />
<p>x86</p>
<p><code>Optimizing msvs</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_BSS     SEGMENT
_rand_state DD  <span class="token number">01H</span> DUP (?)
_BSS     ENDS

_init<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>
_srand  PROC
        mov     <span class="token register variable">eax</span>, DWORD PTR _init<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
        mov     DWORD PTR _rand_state, <span class="token register variable">eax</span>
        ret     <span class="token number">0</span>
_srand  ENDP

_TEXT   SEGMENT
_rand   PROC
        imul    <span class="token register variable">eax</span>, DWORD PTR _rand_state, <span class="token number">1664525</span>
        add     <span class="token register variable">eax</span>, <span class="token number">1013904223</span>         <span class="token comment">; 3c6ef35fH</span>
        mov     DWORD PTR _rand_state, <span class="token register variable">eax</span>
        and     <span class="token register variable">eax</span>, <span class="token number">32767</span>              <span class="token comment">; 00007fffH</span>
        ret     <span class="token number">0</span>
_rand   ENDP

_TEXT   ENDS<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>x64ä¸­ mysrandç›´æ¥ä½¿ç”¨ecxå¯„å­˜å™¨è·å–äº†æ‰€éœ€å‚æ•°ï¼Œæ²¡æœ‰é€šè¿‡æ ˆè¯»å–å‚æ•°</p>
<hr />
<p>å¤šæ•°éšæœºå‡½æ•°éƒ½é‡‡ç”¨æ¢…æ£®æ—‹è½¬ç®—æ³•ï¼ˆMersenne twisterï¼‰ã€‚</p>
<h3 id="chap21-ç»“æ„ä½“"><a class="markdownIt-Anchor" href="#chap21-ç»“æ„ä½“"></a> Chap21 ç»“æ„ä½“</h3>
<h4 id="systemtime"><a class="markdownIt-Anchor" href="#systemtime"></a> systemtime</h4>
<p>æœ¬èŠ‚æ˜¯ä»¥Win32æè¿°ç³»ç»Ÿæ—¶é—´çš„SYSTEMTIMEç»“æ„ä½“(æ¥æº<code>WinBase.h</code>)ä¸ºä¾‹çš„</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_SYSTEMTIME</span> <span class="token punctuation">&#123;</span>
  WORD wYear<span class="token punctuation">;</span>
  WORD wMonth<span class="token punctuation">;</span>
  WORD wDayOfWeek<span class="token punctuation">;</span>
  WORD wDay<span class="token punctuation">;</span>
  WORD wHour<span class="token punctuation">;</span>
  WORD wMinute<span class="token punctuation">;</span>
  WORD wSecond<span class="token punctuation">;</span>
  WORD wMilliseconds<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> SYSTEMTIME<span class="token punctuation">,</span> <span class="token operator">*</span>PSYSTEMTIME<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;windows.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span>
    SYSTEMTIME t<span class="token punctuation">;</span>
    <span class="token function">GetSystemTime</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"%04d-%02d-%02d %02d:%02d:%02d\n"</span><span class="token punctuation">,</span>
        t<span class="token punctuation">.</span>wYear<span class="token punctuation">,</span> t<span class="token punctuation">.</span>wMonth<span class="token punctuation">,</span> t<span class="token punctuation">.</span>wDay<span class="token punctuation">,</span>
        t<span class="token punctuation">.</span>wHour<span class="token punctuation">,</span> t<span class="token punctuation">.</span>wMinute<span class="token punctuation">,</span> t<span class="token punctuation">.</span>wSecond<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr />
<p><code>MSVS 2010(å¯ç”¨/GSé€‰é¡¹)</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_t<span class="token operator">$</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">16</span> <span class="token comment">; size = 16</span>
_main       PROC
     push   <span class="token register variable">ebp</span>
     mov    <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
     sub    <span class="token register variable">esp</span>, <span class="token number">16</span>
     lea    <span class="token register variable">eax</span>, DWORD PTR _t<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
     push   <span class="token register variable">eax</span>
     call   DWORD PTR __imp__GetSystemTime@<span class="token number">4</span>
     movzx  <span class="token register variable">ecx</span>, WORD PTR _t<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token number">12</span><span class="token operator">]</span> <span class="token comment">; wSecond</span>
     push   <span class="token register variable">ecx</span>
     movzx  <span class="token register variable">edx</span>, WORD PTR _t<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token number">10</span><span class="token operator">]</span> <span class="token comment">; wMinute</span>
     push   <span class="token register variable">edx</span>
     movzx  <span class="token register variable">eax</span>, WORD PTR _t<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span> <span class="token comment">; wHour</span>
     push   <span class="token register variable">eax</span>
     movzx  <span class="token register variable">ecx</span>, WORD PTR _t<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token number">6</span><span class="token operator">]</span> <span class="token comment">; wDay</span>
     push   <span class="token register variable">ecx</span>
     movzx  <span class="token register variable">edx</span>, WORD PTR _t<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token number">2</span><span class="token operator">]</span> <span class="token comment">; wMonth</span>
     push   <span class="token register variable">edx</span>
     movzx  <span class="token register variable">eax</span>, WORD PTR _t<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span> <span class="token comment">; wYear</span>
     push   <span class="token register variable">eax</span>
     push   OFFSET <span class="token operator">$</span>SG78811 <span class="token comment">; â€™%04d-%02d-%02d %02d:%02d:%02dâ€™, 0aH, 00H</span>
     call   _printf
     add    <span class="token register variable">esp</span>, <span class="token number">28</span>
     xor    <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
     mov    <span class="token register variable">esp</span>, <span class="token register variable">ebp</span>
     pop    <span class="token register variable">ebp</span>
     ret    <span class="token number">0</span>
_main     ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p>å‡½æ•°åœ¨è¿™ä¸ªæ ˆä¸­ä¸ºç»“æ„ä½“ç”³è¯·äº†16å­—èŠ‚ç©ºé—´ï¼ˆè¿™ä¸ªç»“æ„ä½“ç”±8ä¸ªWORDå‹æ•°æ®æ„æˆ),æ¯ä¸ª<code>WORD</code>å‹æ•°æ®å ç”¨2å­—èŠ‚</p>
<p>ä¼ é€’ç»™å‡½æ•°çš„æ˜¯SYSTEMTIMEç»“æ„ä½“çš„æŒ‡é’ˆã€‚ä½†æ˜¯æ¢ä¸ªè§’åº¦çœ‹ï¼Œè¿™ä¹Ÿæ˜¯<code>wYearå­—æ®µ</code>çš„æŒ‡é’ˆã€‚<code>GetSystemTime()</code>å‡½æ•°é¦–å…ˆä¼šåœ¨ç»“æ„ä½“çš„é¦–åœ°å€å†™å…¥å¹´ä»½ä¿¡æ¯ï¼Œç„¶åå†æŠŠæŒ‡é’ˆè°ƒæ•´2ä¸ªå­—èŠ‚å¹¶å†™å…¥æœˆä»½ä¿¡æ¯ï¼Œå¦‚æ­¤ç±»æ¨å†™å…¥å…¨éƒ¨ä¿¡æ¯ã€‚</p>
</li>
</ul>
<hr />
<p>ç”¨<code>onlydbg</code>æŸ¥çœ‹è¿™ä¸ªç»“æ„ä½“åœ¨å†…å­˜ä¸­çš„åˆ†å¸ƒ</p>
<p>ä»<code>t</code>æŒ‡é’ˆå¼€å§‹çš„ä½ç½®çš„å†…å®¹ä¾æ¬¡æ˜¯:</p>
<pre class="line-numbers language-none"><code class="language-none">DE 07 0C 00 02 00 09 00 16 00 1D 00 34 00 D4 03<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>è¿™ä¸¤ä¸ªç©ºé—´çš„æ¯ä¸¤ä¸ªå­—èŠ‚ä»£è¡¨ç»“æ„ä½“çš„ä¸€ä¸ªå­—æ®µï¼Œç”±äºé‡‡ç”¨äº†<code>å°ç«¯å­—èŠ‚åº</code>ï¼Œæ‰€ä»¥å°±åŒä¸€ä¸ª<code>WORD</code>å‹æ•°æ®è€Œè¨€ï¼Œä½åœ°å€åœ¨å‰ï¼Œé«˜åœ°å€åœ¨å</p>
<table>
<thead>
<tr>
<th>åå…­è¿›åˆ¶æ•°</th>
<th>åè¿›åˆ¶å«ä¹‰</th>
<th>å­—æ®µå</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x07DE</td>
<td>2014</td>
<td>wYear</td>
</tr>
<tr>
<td>0x000C</td>
<td>12</td>
<td>wMonth</td>
</tr>
<tr>
<td>0x0002</td>
<td>2</td>
<td>wDayOfWeek</td>
</tr>
<tr>
<td>0x0009</td>
<td>9</td>
<td>wDay</td>
</tr>
<tr>
<td>0x0016</td>
<td>22</td>
<td>wHour</td>
</tr>
<tr>
<td>0x001D</td>
<td>29</td>
<td>wMinute</td>
</tr>
<tr>
<td>0x0034</td>
<td>52</td>
<td>wSecond</td>
</tr>
<tr>
<td>0x03D4</td>
<td>980</td>
<td>wMilliSeconds</td>
</tr>
</tbody>
</table>
<hr />
<h5 id="ä»¥æ•°ç»„æ›¿ä»£ç»“æ„ä½“"><a class="markdownIt-Anchor" href="#ä»¥æ•°ç»„æ›¿ä»£ç»“æ„ä½“"></a> ä»¥æ•°ç»„æ›¿ä»£ç»“æ„ä½“</h5>
<p>ç”±äºç»“æ„ä½“ä¸­çš„å„ä¸ªå…ƒç´ ï¼Œåœ¨å†…å­˜ä¸­ä¸€æ¬¡æ’åˆ—ï¼Œæˆ‘ä»¬å¯ä»¥éªŒè¯å…¶åœ¨å†…å­˜ä¸­çš„å­˜å‚¨çŠ¶å†µå’Œæ•°ç»„ç›¸åŒ</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;windows.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span>
    WORD array<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">GetSystemTime</span> <span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"%04d-%02d-%02d %02d:%02d:%02d\n"</span><span class="token punctuation">,</span>
        array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment">/* wYear */</span><span class="token punctuation">,</span> array<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token comment">/* wMonth */</span><span class="token punctuation">,</span> array<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token comment">/* wDay */</span><span class="token punctuation">,</span> 
        array<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token comment">/* wHour */</span><span class="token punctuation">,</span> array<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token comment">/* wMinute */</span><span class="token punctuation">,</span> array<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token comment">/* wSecond */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¼šå¼¹è­¦å‘Šï¼Œä½†æ˜¯ä»ç„¶èƒ½ç¼–è¯‘</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token operator">$</span>SG78573 DB     <span class="token string">'%04d-%02d-%02d %02d:%02d:%02d'</span>, <span class="token number">0aH</span>, <span class="token number">00H</span>
_array<span class="token operator">$</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">16</span><span class="token comment">;size=16</span>
_main   PROC
        Push    <span class="token register variable">ebp</span>
        mov     <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
        sub     <span class="token register variable">esp</span>, <span class="token number">16</span>
        lea     <span class="token register variable">eax</span>, DWORD PTR _array<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
        push    <span class="token register variable">eax</span>
        call    DWORD PTR __imp__GetSystemTime@<span class="token number">4</span>
        movzx   <span class="token register variable">ecx</span>, WORD PTR _array<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token number">12</span><span class="token operator">]</span> <span class="token comment">; wSecond</span>
        push    <span class="token register variable">ecx</span>
        movzx   <span class="token register variable">edx</span>, WORD PTR _array<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token number">10</span><span class="token operator">]</span> <span class="token comment">; wMinute</span>
        push    <span class="token register variable">edx</span>
        movzx   <span class="token register variable">eax</span>, WORD PTR _array<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span> <span class="token comment">; wHoure</span>
        push    <span class="token register variable">eax</span>
        movzx   <span class="token register variable">ecx</span>, WORD PTR _array<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token number">6</span><span class="token operator">]</span> <span class="token comment">; wDay</span>
        push    <span class="token register variable">ecx</span>
        movzx   <span class="token register variable">edx</span>, WORD PTR _array<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token number">2</span><span class="token operator">]</span> <span class="token comment">; wMonth</span>
        push    <span class="token register variable">edx</span>
        movzx   <span class="token register variable">eax</span>, WORD PTR _array<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span> <span class="token comment">; wYear</span>
        push    <span class="token register variable">eax</span>
        push    OFFSET <span class="token operator">$</span>SG78573
        call    _printf
        add     <span class="token register variable">esp</span>, <span class="token number">28</span>
        xor     <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
        mov     <span class="token register variable">esp</span>, <span class="token register variable">ebp</span>
        pop     <span class="token register variable">ebp</span>
        ret     <span class="token number">0</span>
_main   ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å³ä¾¿è°ƒæ•´äº†æ•°æ®ç»“æ„ï¼Œå¯ä»¥å‘ç°æ±‡ç¼–ä»£ç ç›¸å·®æ— å‡ </p>
<p><code>ä»…ä»æ±‡ç¼–æŒ‡ä»¤åˆ†æï¼Œå¾ˆéš¾åˆ¤æ–­å‡ºåˆ°åº•æºç¨‹åºä½¿ç”¨çš„æ˜¯å¤šå˜é‡çš„ç»“æ„ä½“è¿˜æ˜¯æ•°ç»„ã€‚</code></p>
<p>å¥½åœ¨æ­£å¸¸äººä¸ä¼šåšè¿™ç§åˆ«æ‰­çš„æ›¿æ¢ã€‚æ¯•ç«Ÿç»“æ„ä½“çš„å¯è¯»æ€§ã€æ˜“ç”¨æ€§éƒ½æ¯”æ•°ç»„å¼ºï¼Œä¹Ÿæ–¹ä¾¿ç¼–ç¨‹äººå‘˜æ›¿æ¢ç»“æ„ä½“ä¸­çš„å­—æ®µã€‚</p>
<h4 id="malloc"><a class="markdownIt-Anchor" href="#malloc"></a> malloc()</h4>
<p><em>åœ¨å¾ˆå¤šæƒ…å†µï¼Œéƒ½ç”¨heapæ¥å­˜å‚¨ç»“æ„ä½“ï¼Œéœ€è¦å€ŸåŠ©mallocå‡½æ•°</em></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;windows.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span>
    SYSTEMTIME <span class="token operator">*</span>t<span class="token punctuation">;</span>
    t<span class="token operator">=</span><span class="token punctuation">(</span>SYSTEMTIME <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span> <span class="token punctuation">(</span>SYSTEMTIME<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GetSystemTime</span> <span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"%04d-%02d-%02d %02d:%02d:%02d\n"</span><span class="token punctuation">,</span>
        t<span class="token operator">-></span>wYear<span class="token punctuation">,</span> t<span class="token operator">-></span>wMonth<span class="token punctuation">,</span> t<span class="token operator">-></span>wDay<span class="token punctuation">,</span>
        t<span class="token operator">-></span>wHour<span class="token punctuation">,</span> t<span class="token operator">-></span>wMinute<span class="token punctuation">,</span> t<span class="token operator">-></span>wSecond<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span> <span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr />
<p><code>msvs /ox </code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_main      PROC
    push   <span class="token register variable">esi</span>
    push   <span class="token number">16</span>
    call   _malloc<span class="token comment">;eax=ptr(t)</span>
    add    <span class="token register variable">esp</span>, <span class="token number">4</span>
    mov    <span class="token register variable">esi</span>, <span class="token register variable">eax</span>
    push   <span class="token register variable">esi</span>
    call   DWORD PTR __imp__GetSystemTime@<span class="token number">4</span><span class="token comment">;</span>
    movzx  <span class="token register variable">eax</span>, WORD PTR <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">12</span><span class="token operator">]</span> <span class="token comment">; wSecond</span>
    movzx  <span class="token register variable">ecx</span>, WORD PTR <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">10</span><span class="token operator">]</span> <span class="token comment">; wMinute</span>
    movzx  <span class="token register variable">edx</span>, WORD PTR <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span> <span class="token comment">; wHour</span>
    push   <span class="token register variable">eax</span>
    movzx  <span class="token register variable">eax</span>, WORD PTR <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">6</span><span class="token operator">]</span> <span class="token comment">; wDay</span>
    push   <span class="token register variable">ecx</span>
    movzx  <span class="token register variable">ecx</span>, WORD PTR <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">2</span><span class="token operator">]</span> <span class="token comment">; wMonth</span>
    push   <span class="token register variable">edx</span>
    movzx  <span class="token register variable">edx</span>, WORD PTR <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">]</span> <span class="token comment">; wYear</span>
    push   <span class="token register variable">eax</span>
    push   <span class="token register variable">ecx</span>
    push   <span class="token register variable">edx</span>
    push   OFFSET <span class="token operator">$</span>SG78833
    call   _printf
    push   <span class="token register variable">esi</span>
    call   _free
    add    <span class="token register variable">esp</span>, <span class="token number">32</span>
    xor    <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
    pop    <span class="token register variable">esi</span>
    ret    <span class="token number">0</span>
_main      ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>mallocæ¥æ”¶çš„å‚æ•°16å°±æ˜¯<code>sizeof(systemtime)</code>,<code>malloc()</code>å‡½æ•°æ ¹æ®å‚æ•°æŒ‡å®šçš„å¤§å°åˆ†é…ä¸€å—ç©ºé—´ï¼Œå¹¶æŠŠç©ºé—´çš„æŒ‡é’ˆä¼ é€’ç»™<code>EAX</code>å¯„å­˜å™¨</li>
</ul>
<h4 id="unix-struct-tm"><a class="markdownIt-Anchor" href="#unix-struct-tm"></a> UNIX: struct tm</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;time.h></span></span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">tm</span> t<span class="token punctuation">;</span>
    <span class="token class-name">time_t</span> unix_time<span class="token punctuation">;</span>

    unix_time<span class="token operator">=</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">localtime_r</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>unix_time<span class="token punctuation">,</span> <span class="token operator">&amp;</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"Year: %d\n"</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>tm_year<span class="token operator">+</span><span class="token number">1900</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"Month: %d\n"</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>tm_mon<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"Day: %d\n"</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>tm_mday<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"Hour: %d\n"</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>tm_hour<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"Minutes: %d\n"</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>tm_min<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"Seconds: %d\n"</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>tm_sec<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">main proc  near
     push     <span class="token register variable">ebp</span>
     mov      <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
     and      <span class="token register variable">esp</span>, <span class="token number">0FFFFFFF0h</span>
     sub      <span class="token register variable">esp</span>, <span class="token number">40h</span>
     mov      dword ptr <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">]</span>, <span class="token number">0</span> <span class="token comment">; first argument for time()</span>
     call     time
     mov      <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">3Ch</span><span class="token operator">]</span>, <span class="token register variable">eax</span>
     lea      <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">3Ch</span><span class="token operator">]</span>  <span class="token comment">; take pointer to what time() returned</span>
     lea      <span class="token register variable">edx</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">]</span>  <span class="token comment">; at ESP+10h struct tm will begin</span>
     mov      <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">edx</span>    <span class="token comment">; pass pointer to the structure begin</span>
     mov      <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">]</span>, <span class="token register variable">eax</span>      <span class="token comment">; pass pointer to result of time()</span>
     call     localtime_r
     mov      <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">24h</span><span class="token operator">]</span>  <span class="token comment">; tm_year</span>
     lea      <span class="token register variable">edx</span>, <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">76Ch</span><span class="token operator">]</span> <span class="token comment">; edx=eax+1900</span>
     mov      <span class="token register variable">eax</span>, offset format <span class="token comment">; "Year: %d\n"</span>
     mov      <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">edx</span>
     mov      <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">]</span>, <span class="token register variable">eax</span>
     call     printf
     mov      <span class="token register variable">edx</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">20h</span><span class="token operator">]</span>      <span class="token comment">; tm_mon</span>
     mov      <span class="token register variable">eax</span>, offset aMonthD <span class="token comment">; "Month: %d\n"</span>
     mov      <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">edx</span>
     mov      <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">]</span>, <span class="token register variable">eax</span>
     call     printf
     mov      <span class="token register variable">edx</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">1Ch</span><span class="token operator">]</span>     <span class="token comment">; tm_mday</span>
     mov      <span class="token register variable">eax</span>, offset aDayD  <span class="token comment">; "Day: %d\n"</span>
     mov      <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">edx</span>
     mov      <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">]</span>, <span class="token register variable">eax</span>
     call     printf
     mov      <span class="token register variable">edx</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">18h</span><span class="token operator">]</span>     <span class="token comment">; tm_hour</span>
     mov      <span class="token register variable">eax</span>, offset aHourD <span class="token comment">; "Hour: %d\n"</span>
     mov      <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">edx</span>
     mov      <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">]</span>, <span class="token register variable">eax</span>
     call     printf
     mov      <span class="token register variable">edx</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">14h</span><span class="token operator">]</span>        <span class="token comment">; tm_min</span>
     mov      <span class="token register variable">eax</span>, offset aMinutesD <span class="token comment">; "Minutes: %d\n"</span>
     mov      <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">edx</span>
     mov      <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">]</span>, <span class="token register variable">eax</span>
     call     printf
     mov      <span class="token register variable">edx</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">]</span>
     mov      <span class="token register variable">eax</span>, offset aSecondsD <span class="token comment">; "Seconds: %d\n"</span>
     mov      <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">edx</span>          <span class="token comment">; tm_sec</span>
     mov      <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">]</span>, <span class="token register variable">eax</span>
     call     printf
     leave
     retn
main endp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>éœ€è¦æ³¨æ„çš„æ˜¯â€œlea edx, [eax+76Ch]â€æŒ‡ä»¤ã€‚å®ƒç»™EAXå¯„å­˜å™¨é‡Œçš„å€¼åŠ ä¸Š0x76Cï¼ˆ1900ï¼‰ï¼Œè€Œä¸ä¼šä¿®æ”¹ä»»ä½•æ ‡å¿—ä½ã€‚</li>
</ul>
<p>ä¸ä¸Šæ–‡ç±»ä¼¼ï¼Œå¯ä»¥ç”¨WORDæ•°ç»„ä»£æ›¿è¿™ä¸ªç»“æ„ä½“ï¼Œä½†æ˜¯æˆ‘ä»¬ç”šè‡³ä¹Ÿå¯ä»¥ç”¨å­—èŠ‚å‹æ•°ç»„æ¥ä»£æ›¿</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;time.h></span></span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">tm</span> t<span class="token punctuation">;</span>
    <span class="token class-name">time_t</span> unix_time<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>

    unix_time<span class="token operator">=</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">localtime_r</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>unix_time<span class="token punctuation">,</span> <span class="token operator">&amp;</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">9</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"0x%02X "</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>t<span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token number">4</span><span class="token operator">+</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åªè¦æ§åˆ¶å¥½æ¯ä¸ªæ¥å—çš„å‚æ•°çš„æ•°ç»„çš„åˆé€‚ä½ç½®å³å¯</p>
<h4 id="ç»“æ„ä½“çš„å­—æ®µå°è£…"><a class="markdownIt-Anchor" href="#ç»“æ„ä½“çš„å­—æ®µå°è£…"></a> ç»“æ„ä½“çš„å­—æ®µå°è£…</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token keyword">struct</span> <span class="token class-name">s</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">char</span> a<span class="token punctuation">;</span>
    <span class="token keyword">int</span> b<span class="token punctuation">;</span>
    <span class="token keyword">char</span> c<span class="token punctuation">;</span>
    <span class="token keyword">int</span> d<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">s</span> s<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"a=%d; b=%d; c=%d; d=%d\n"</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>a<span class="token punctuation">,</span> s<span class="token punctuation">.</span>b<span class="token punctuation">,</span> s<span class="token punctuation">.</span>c<span class="token punctuation">,</span> s<span class="token punctuation">.</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">s</span> tmp<span class="token punctuation">;</span>
    tmp<span class="token punctuation">.</span>a<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    tmp<span class="token punctuation">.</span>b<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>
    tmp<span class="token punctuation">.</span>c<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>
    tmp<span class="token punctuation">.</span>d<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token function">f</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr />
<p><code>msvs 2012 /GS /Ob0</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"> <span class="token number">1</span> _tmp<span class="token operator">$</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">16</span>
 <span class="token number">2</span> _main    PROC
 <span class="token number">3</span>     push   <span class="token register variable">ebp</span>
 <span class="token number">4</span>     mov    <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
 <span class="token number">5</span>     sub    <span class="token register variable">esp</span>, <span class="token number">16</span>
 <span class="token number">6</span>     mov    BYTE PTR _tmp<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token number">1</span>       <span class="token comment">; set field a</span>
 <span class="token number">7</span>     mov    DWORD PTR _tmp<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token number">2</span>    <span class="token comment">; set field b</span>
 <span class="token number">8</span>     mov    BYTE PTR _tmp<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span>, <span class="token number">3</span>     <span class="token comment">; set field c</span>
 <span class="token number">9</span>     mov    DWORD PTR _tmp<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token number">12</span><span class="token operator">]</span>, <span class="token number">4</span>   <span class="token comment">; set field d</span>
<span class="token number">10</span>     sub    <span class="token register variable">esp</span>, <span class="token number">16</span>                      <span class="token comment">; allocate place for temporary structure</span>
<span class="token number">11</span>     mov    <span class="token register variable">eax</span>, <span class="token register variable">esp</span>
<span class="token number">12</span>     mov    <span class="token register variable">ecx</span>, DWORD PTR _tmp<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>    <span class="token comment">; copy our structure to the temporary one</span>
<span class="token number">13</span>     mov    DWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span>, <span class="token register variable">ecx</span>
<span class="token number">14</span>     mov    <span class="token register variable">edx</span>, DWORD PTR _tmp<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>
<span class="token number">15</span>     mov    DWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">edx</span>
<span class="token number">16</span>     mov    <span class="token register variable">ecx</span>, DWORD PTR _tmp<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span>
<span class="token number">17</span>     mov    DWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span>, <span class="token register variable">ecx</span>
<span class="token number">18</span>     mov    <span class="token register variable">edx</span>, DWORD PTR _tmp<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token number">12</span><span class="token operator">]</span>
<span class="token number">19</span>     mov    DWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">12</span><span class="token operator">]</span>, <span class="token register variable">edx</span>
<span class="token number">20</span>     call    _f
<span class="token number">21</span>     add    <span class="token register variable">esp</span>, <span class="token number">16</span>
<span class="token number">22</span>     xor    <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
<span class="token number">23</span>     mov    <span class="token register variable">esp</span>, <span class="token register variable">ebp</span>
<span class="token number">24</span>     pop    <span class="token register variable">ebp</span>
<span class="token number">25</span>     ret    <span class="token number">0</span>
<span class="token number">26</span> _main   ENDP
<span class="token number">27</span>
<span class="token number">28</span> _s<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>                <span class="token comment">; size = 16</span>
<span class="token number">29</span> ?f@@YAXUs@@@Z PROC     <span class="token comment">; f</span>
<span class="token number">30</span>     push  <span class="token register variable">ebp</span>
<span class="token number">31</span>     mov   <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
<span class="token number">32</span>     mov   <span class="token register variable">eax</span>, DWORD PTR _s<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token number">12</span><span class="token operator">]</span>
<span class="token number">33</span>     push  <span class="token register variable">eax</span>
<span class="token number">34</span>     movsx <span class="token register variable">ecx</span>, BYTE PTR _s<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span>
<span class="token number">35</span>     push  <span class="token register variable">ecx</span>
<span class="token number">36</span>     mov   <span class="token register variable">edx</span>, DWORD PTR _s<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>
<span class="token number">37</span>     push  <span class="token register variable">edx</span>
<span class="token number">38</span>     movsx <span class="token register variable">eax</span>, BYTE PTR _s<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
<span class="token number">39</span>     push  <span class="token register variable">eax</span>
<span class="token number">40</span>     push  OFFSET <span class="token operator">$</span>SG3842
<span class="token number">41</span>     call  _printf
<span class="token number">42</span>     add   <span class="token register variable">esp</span>, <span class="token number">20</span>
<span class="token number">43</span>     pop   <span class="token register variable">ebp</span>
<span class="token number">44</span>     ret   <span class="token number">0</span>
<span class="token number">45</span> ?f@@YAXUs@@@Z ENDP <span class="token comment">; f</span>
<span class="token number">46</span> _TEXT     ENDS<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p>è™½ç„¶æˆ‘ä»¬åœ¨ä»£ç é‡Œä¸€æ¬¡æ€§åˆ†é…äº†ç»“æ„ä½“tmpï¼Œå¹¶ä¾æ¬¡ç»™å®ƒçš„å››ä¸ªå­—æ®µèµ‹å€¼ï¼Œä½†æ˜¯å¯æ‰§è¡Œç¨‹åºçš„æŒ‡ä»¤æœ‰äº›ä¸åŒï¼šå®ƒå°†ç»“æ„ä½“çš„æŒ‡é’ˆå¤åˆ¶åˆ°ä¸´æ—¶åœ°å€ï¼ˆç¬¬10è¡ŒæŒ‡ä»¤åˆ†é…çš„ç©ºé—´é‡Œï¼‰ï¼Œç„¶åé€šè¿‡ä¸´æ—¶çš„ä¸­é—´å˜é‡æŠŠç»“æ„ä½“çš„å››ä¸ªå€¼èµ‹å€¼ç»™ä¸´æ—¶ç»“æ„ä½“ï¼ˆç¬¬12ï½19è¡Œçš„æŒ‡ä»¤ï¼‰ï¼Œè¿˜æŠŠæŒ‡é’ˆä¹Ÿå¤åˆ¶å‡ºæ¥ä¾›f()è°ƒç”¨ã€‚</p>
</li>
<li>
<p><mark>è¿™ä¸»è¦æ˜¯å› ä¸ºç¼–è¯‘å™¨æ— æ³•åˆ¤æ–­f()å‡½æ•°æ˜¯å¦ä¼šä¿®æ”¹ç»“æ„ä½“çš„å†…å®¹ã€‚å€ŸåŠ©ä¸­é—´å˜é‡ï¼Œç¼–è¯‘å™¨å¯ä»¥ä¿è¯main()å‡½æ•°é‡Œtmpç»“æ„ä½“çš„å€¼ä¸å—è¢«è°ƒç”¨æ–¹å‡½æ•°çš„å½±å“ã€‚</mark></p>
</li>
<li>
<p>å¦å¤–ï¼Œ<mark>è¿™ä¸ªç¨‹åºé‡Œç»“æ„ä½“çš„å­—æ®µå‘4å­—èŠ‚è¾¹ç•Œå¯¹é½</mark>ã€‚ä¹Ÿå°±æ˜¯è¯´å®ƒçš„charå‹æ•°æ®ä¹Ÿå’Œintå‹æ•°æ®ä¸€æ ·å 4å­—èŠ‚å­˜å‚¨ç©ºé—´ã€‚è¿™ä¸»è¦æ˜¯ä¸ºäº†æ–¹ä¾¿CPUä»å†…å­˜è¯»å–æ•°æ®ï¼Œæé«˜è¯»å†™å’Œç¼“å­˜çš„æ•ˆç‡ã€‚</p>
<p>è¿™æ ·çš„ç¼ºç‚¹æ˜¯æµªè´¹å­˜å‚¨ç©ºé—´ï¼Œæˆ‘ä»¬å¯ä»¥å¯ç”¨ç¼–è¯‘å™¨çš„/Zp1 (/Zp[n]è¡¨ç¤ºå‘<em>n</em>ä¸ªå­—èŠ‚çš„è¾¹ç•Œå¯¹é½)é€‰é¡¹ã€‚</p>
<ul>
<li>å¦‚æœæŸä¸ªç»“æ„ä½“è¢«å¤šä¸ªæºæ–‡ä»¶ã€ç›®æ ‡æ–‡ä»¶ï¼ˆobject filesï¼‰è°ƒç”¨ï¼Œé‚£ä¹ˆåœ¨ç¼–è¯‘è¿™äº›ç¨‹åºæ—¶ï¼Œç»“æ„å°è£…æ ¼å¼å’Œæ•°æ®å¯¹å…¶è§„èŒƒ(/Zp[n])å¿…é¡»å®Œå…¨åŒ¹é…ã€‚</li>
</ul>
</li>
</ul>
<hr />
<pre class="line-numbers language-c" data-language="c"><code class="language-c">åœ¨å‘è¢«è°ƒç”¨æ–¹å‡½æ•°ä¼ é€’ç»“æ„ä½“æ—¶ï¼ˆä¸æ˜¯ä¼ é€’ç»“æ„ä½“çš„æŒ‡é’ˆï¼‰ï¼Œä¼ é€’å‚æ•°çš„è¿‡ç¨‹ç›¸å½“äºä¾æ¬¡ä¼ é€’ç»“æ„ä½“çš„å„å­—æ®µã€‚å³æ˜¯è¯´ï¼Œå¦‚æœç»“æ„ä½“å„å­—æ®µçš„å®šä¹‰ä¸å˜ï¼Œé‚£ä¹ˆ<span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>å‡½æ•°çš„æºä»£ç å¯æ”¹å†™ä¸ºï¼š

<span class="token keyword">void</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token keyword">char</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">,</span> <span class="token keyword">char</span> c<span class="token punctuation">,</span> <span class="token keyword">int</span> d<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"a=%d; b=%d; c=%d; d=%d\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="ç»“æ„ä½“çš„åµŒå¥—"><a class="markdownIt-Anchor" href="#ç»“æ„ä½“çš„åµŒå¥—"></a> ç»“æ„ä½“çš„åµŒå¥—</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">struct</span> <span class="token class-name">inner_struct</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> a<span class="token punctuation">;</span>
    <span class="token keyword">int</span> b<span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">outer_struct</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">char</span> a<span class="token punctuation">;</span>
    <span class="token keyword">int</span> b<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">inner_struct</span> c<span class="token punctuation">;</span>
    <span class="token keyword">char</span> d<span class="token punctuation">;</span>
    <span class="token keyword">int</span> e<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">outer_struct</span> s<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"a=%d; b=%d; c.a=%d; c.b=%d; d=%d; e=%d\n"</span><span class="token punctuation">,</span>
        s<span class="token punctuation">.</span>a<span class="token punctuation">,</span> s<span class="token punctuation">.</span>b<span class="token punctuation">,</span> s<span class="token punctuation">.</span>c<span class="token punctuation">.</span>a<span class="token punctuation">,</span> s<span class="token punctuation">.</span>c<span class="token punctuation">.</span>b<span class="token punctuation">,</span> s<span class="token punctuation">.</span>d<span class="token punctuation">,</span> s<span class="token punctuation">.</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">outer_struct</span> s<span class="token punctuation">;</span>
    s<span class="token punctuation">.</span>a<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    s<span class="token punctuation">.</span>b<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>
    s<span class="token punctuation">.</span>c<span class="token punctuation">.</span>a<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">;</span>
    s<span class="token punctuation">.</span>c<span class="token punctuation">.</span>b<span class="token operator">=</span><span class="token number">101</span><span class="token punctuation">;</span>
    s<span class="token punctuation">.</span>d<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>
    s<span class="token punctuation">.</span>e<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token function">f</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>MSVC 2010ï¼ˆå¯ç”¨/Ox /Ob0é€‰é¡¹ï¼‰</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token operator">$</span>SG2802 DB    â€™a<span class="token operator">=</span><span class="token operator">%</span>d<span class="token comment">; b=%d; c.a=%d; c.b=%d; d=%d; e=%dâ€™, 0aH, 00H</span>

_TEXT    SEGMENT
_s<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>
_f    PROC
      mov    <span class="token register variable">eax</span>, DWORD PTR _s<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">16</span><span class="token operator">]</span>
      movsx  <span class="token register variable">ecx</span>, BYTE PTR _s<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">12</span><span class="token operator">]</span>
      mov    <span class="token register variable">edx</span>, DWORD PTR _s<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span>
      push   <span class="token register variable">eax</span>
      mov    <span class="token register variable">eax</span>, DWORD PTR _s<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span>
      push   <span class="token register variable">ecx</span>
      mov    <span class="token register variable">ecx</span>, DWORD PTR _s<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span>
      push   <span class="token register variable">edx</span>
      movsx  <span class="token register variable">edx</span>, BYTE PTR _s<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span>
      push   <span class="token register variable">eax</span>
      push   <span class="token register variable">ecx</span>
      push   <span class="token register variable">edx</span>
      push   OFFSET <span class="token operator">$</span>SG2802 <span class="token comment">; â€™a=%d; b=%d; c.a=%d; c.b=%d; d=%d; e=%dâ€™</span>
      call   _printf
      add    <span class="token register variable">esp</span>, <span class="token number">28</span>
      ret    <span class="token number">0</span>
_f       ENDP

_s<span class="token operator">$</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">24</span>
_main    PROC
    sub    <span class="token register variable">esp</span>, <span class="token number">24</span>
    push   <span class="token register variable">ebx</span>
    push   <span class="token register variable">esi</span>
    push   <span class="token register variable">edi</span>
    mov    <span class="token register variable">ecx</span>, <span class="token number">2</span>
    sub    <span class="token register variable">esp</span>, <span class="token number">24</span>
    mov    <span class="token register variable">eax</span>, <span class="token register variable">esp</span>
    mov    BYTE PTR _s<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">60</span><span class="token operator">]</span>, <span class="token number">1</span><span class="token comment">;s.a=1</span>
    mov    <span class="token register variable">ebx</span>, DWORD PTR _s<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">60</span><span class="token operator">]</span>
    mov    DWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span>, <span class="token register variable">ebx</span>
    mov    DWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">ecx</span>
    lea    <span class="token register variable">edx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">98</span><span class="token operator">]</span>
    lea    <span class="token register variable">esi</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">99</span><span class="token operator">]</span>
    lea    <span class="token register variable">edi</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">2</span><span class="token operator">]</span>
    mov    DWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span>, <span class="token register variable">edx</span>
    mov    BYTE PTR _s<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">76</span><span class="token operator">]</span>, <span class="token number">3</span>
    mov    <span class="token register variable">ecx</span>, DWORD PTR _s<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">76</span><span class="token operator">]</span>
    mov    DWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">12</span><span class="token operator">]</span>, <span class="token register variable">esi</span>
    mov    DWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">16</span><span class="token operator">]</span>, <span class="token register variable">ecx</span>
    mov    DWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">20</span><span class="token operator">]</span>, <span class="token register variable">edi</span>
    call   _f
    add    <span class="token register variable">esp</span>, <span class="token number">24</span>
    pop    <span class="token register variable">edi</span>
    pop    <span class="token register variable">esi</span>
    xor    <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
    pop    <span class="token register variable">ebx</span>
    add    <span class="token register variable">esp</span>, <span class="token number">24</span>
    ret    <span class="token number">0</span>
_main    ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>ç”±æ±‡ç¼–ä»£ç å¯ä»¥çœ‹å‡ºï¼Œå†…åµŒç»“æ„ä½“ä¼šè¢«ç¼–è¯‘å™¨å±•å¼€å½¢æˆä¸€ç»´ç»“æ„ä½“</li>
<li>å†…å­˜ä¸­çš„æ„é€ å¦‚ä¸‹ï¼š
<ul>
<li>(outer_struct.a)å€¼ä¸º1çš„å­—èŠ‚ï¼Œå…¶å3å­—èŠ‚æ˜¯éšæœºè„æ•°æ®ã€‚</li>
<li>(outer_struct.b) 32 ä½wordå‹æ•°æ®2ã€‚</li>
<li>(outer_struct.a)32 ä½wordå‹æ•°æ®0x64(100)ã€‚</li>
<li>(outer_struct.b)32 ä½wordå‹æ•°æ®0x65(101)ã€‚</li>
<li>(outer_struct.d)å€¼ä¸º3çš„å­—èŠ‚ï¼Œä»¥åŠå…¶å3å­—èŠ‚çš„è„æ•°æ®ã€‚</li>
<li>(outer_struct.e)32 ä½wordå‹æ•°æ®4ã€‚</li>
</ul>
</li>
</ul>
<h4 id="ç»“æ„ä½“çš„ä½æ“ä½œ"><a class="markdownIt-Anchor" href="#ç»“æ„ä½“çš„ä½æ“ä½œ"></a> ç»“æ„ä½“çš„ä½æ“ä½œ</h4>
<p>ä»¥CPUIDæŒ‡ä»¤ä¸ºä¾‹ã€‚è¯¥æŒ‡ä»¤ç”¨äºè·å–CPUåŠå…¶ç‰¹æ€§ä¿¡æ¯ã€‚</p>
<p>å¦‚æœåœ¨è°ƒç”¨æŒ‡ä»¤ä¹‹å‰è®¾ç½®EAXå¯„å­˜å™¨çš„å€¼ä¸º1ï¼Œé‚£ä¹ˆCPUIDæŒ‡ä»¤å°†ä¼šæŒ‰ç…§ä¸‹åˆ—æ ¼å¼åœ¨EAXå¯„å­˜å™¨é‡Œå­˜å‚¨CPUçš„ç‰¹å¾ä¿¡æ¯ã€‚</p>
<img src="/2024/05/23/re4b%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image-20240609202329684.png" class="" alt="image-20240609202329684" loading="lazy">
<p><em>C/C++è¯­è¨€å¯ä»¥ç²¾ç¡®æ“ä½œç»“æ„ä½“ä¸­çš„ä½åŸŸã€‚è¿™èƒ½å¤Ÿå¸®åŠ©ç¨‹åºå‘˜å¤§å¹…åº¦åœ°èŠ‚çœç¨‹åºçš„å†…å­˜æ¶ˆè€—ã€‚</em></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__GNUC__</span></span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">cpuid</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>a<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>b<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>c<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>d<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">asm</span> <span class="token keyword">volatile</span><span class="token punctuation">(</span><span class="token string">"cpuid"</span><span class="token operator">:</span><span class="token string">"=a"</span><span class="token punctuation">(</span><span class="token operator">*</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"=b"</span><span class="token punctuation">(</span><span class="token operator">*</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"=c"</span><span class="token punctuation">(</span><span class="token operator">*</span>c<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"=d"</span><span class="token punctuation">(</span><span class="token operator">*</span>d<span class="token punctuation">)</span><span class="token operator">:</span><span class="token string">"a"</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_MSC_VER</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;intrin.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token keyword">struct</span> <span class="token class-name">CPUID_1_EAX</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> stepping<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> model<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> family_id<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> processor_type<span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> reserved1<span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> extended_model_id<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> extended_family_id<span class="token operator">:</span><span class="token number">8</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> reserved2<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">CPUID_1_EAX</span> <span class="token operator">*</span>tmp<span class="token punctuation">;</span>
    <span class="token keyword">int</span> b<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_MSC_VER</span></span>
    <span class="token function">__cpuid</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__GNUC__</span></span>
    <span class="token function">cpuid</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>b<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>b<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>b<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    tmp<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">CPUID_1_EAX</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"stepping=%d\n"</span><span class="token punctuation">,</span> tmp<span class="token operator">-></span>stepping<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"model=%d\n"</span><span class="token punctuation">,</span> tmp<span class="token operator">-></span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"family_id=%d\n"</span><span class="token punctuation">,</span> tmp<span class="token operator">-></span>family_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"processor_type=%d\n"</span><span class="token punctuation">,</span> tmp<span class="token operator">-></span>processor_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"extended_model_id=%d\n"</span><span class="token punctuation">,</span> tmp<span class="token operator">-></span>extended_model_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"extended_family_id=%d\n"</span><span class="token punctuation">,</span> tmp<span class="token operator">-></span>extended_family_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨CPUIDå°†è¿”å›å€¼å­˜å‚¨åˆ°EAX/EBX/ECX/EDXä¹‹åï¼Œç¨‹åºä½¿ç”¨æ•°ç»„b[]æ”¶é›†ç›¸å…³ä¿¡æ¯ã€‚ç„¶åï¼Œæˆ‘ä»¬é€šè¿‡æŒ‡å‘ç»“æ„ä½“CPUID_1_EAXçš„æŒ‡é’ˆï¼Œä»æ•°ç»„b[]ä¸­è·å–EAXå¯„å­˜å™¨é‡Œçš„å€¼ã€‚</p>
<hr />
<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨ç»“æ„ä½“æ¨¡æ‹Ÿå‡ºæµ®ç‚¹æ•°ï¼Œå¹¶ä¸”åœ¨ç¨‹åºä¸­æ›¿ä»£floatç±»å‹ï¼Œä½†æ˜¯æ²¡ä»€ä¹ˆæ„ä¹‰ï¼Œç•¥è¿‡</p>
<hr />
<h3 id="chap22-unionå…±ç”¨ä½“"><a class="markdownIt-Anchor" href="#chap22-unionå…±ç”¨ä½“"></a> Chap22 Unionå…±ç”¨ä½“</h3>
<h4 id="ä¼ªéšæœºæ•°ç”Ÿæˆ"><a class="markdownIt-Anchor" href="#ä¼ªéšæœºæ•°ç”Ÿæˆ"></a> ä¼ªéšæœºæ•°ç”Ÿæˆ</h4>
<ul>
<li>
<p>åˆ©ç”¨unionç»“æ„å¯ä»¥ä¸ç”¨é™¤æ³•å°±ç”Ÿæˆä»‹äº0~1ä¹‹é—´çš„éšæœºæ•°</p>
<p>å¯é‡‡ç”¨å…±ç”¨ä½“ç±»å‹ï¼ˆunionï¼‰çš„æ•°æ®è¡¨ç¤ºå•ç²¾åº¦æµ®ç‚¹æ•°ï¼ˆfloatï¼‰ã€‚åˆ›å»ºä¸€ä¸ªunionå‹å˜é‡ï¼Œç„¶åæŠŠå®ƒå½“ä½œfloatå‹æˆ–uint32_tå‹æ•°æ®è¿›è¡Œè¯»å–ã€‚</p>
</li>
<li>
<p>å•ç²¾åº¦æµ®ç‚¹æ•°ï¼ˆfloatï¼‰å‹æ•°æ®ç”±ç¬¦å·ä½ã€æœ‰æ•ˆæ•°å­—å’ŒæŒ‡æ•°ä¸‰éƒ¨åˆ†æ„æˆã€‚è¿™ç§æ•°æ®ç»“æ„å†³å®šï¼Œåªè¦éšæœºå¡«å……æœ‰æ•ˆæ•°å­—ä½å°±å¯ä»¥ç”Ÿæˆéšæœºçš„å•ç²¾åº¦æ•°</p>
</li>
<li>
<p>ä¾æ®æœ‰å…³è§„èŒƒï¼Œéšæœºæµ®ç‚¹æ•°çš„æŒ‡æ•°éƒ¨åˆ†ä¸å¯ä»¥æ˜¯0ã€‚é‚£ä¹ˆæˆ‘ä»¬ä¸å¦¨æŠŠæŒ‡æ•°éƒ¨åˆ†ç›´æ¥è®¾ç½®ä¸º01111111ï¼ˆå³åè¿›åˆ¶çš„1ï¼‰ï¼Œç”¨éšæœºæ•°å­—å¡«å……æœ‰æ•ˆæ•°å­—éƒ¨åˆ†ï¼Œå†æŠŠç¬¦å·ä½è®¾ç½®ä¸ºé›¶ï¼ˆè¡¨ç¤ºæ­£æ•°ï¼‰ã€‚</p>
</li>
<li>
<p>å†æŠŠå®ƒå‡å»1å°±å¯ä»¥å¾—åˆ°ä¸€ä¸ªæ ‡å‡†çš„éšæœºå‡½æ•°ã€‚</p>
</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">nclude</span> <span class="token expression"><span class="token operator">&lt;</span>stdio<span class="token punctuation">.</span>h<span class="token operator">></span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;time.h></span></span>

<span class="token comment">// integer PRNG definitions, data and routines:</span>

<span class="token comment">//constants from the Numerical Recipes book</span>
<span class="token keyword">const</span> <span class="token class-name">uint32_t</span> RNG_a<span class="token operator">=</span><span class="token number">1664525</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token class-name">uint32_t</span> RNG_c<span class="token operator">=</span><span class="token number">1013904223</span><span class="token punctuation">;</span>
<span class="token class-name">uint32_t</span> RNG_state<span class="token punctuation">;</span> <span class="token comment">// global variable</span>

<span class="token keyword">void</span> <span class="token function">my_srand</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> i<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
         RNG_state<span class="token operator">=</span>i<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token class-name">uint32_t</span> <span class="token function">my_rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
         RNG_state<span class="token operator">=</span>RNG_state<span class="token operator">*</span>RNG_a<span class="token operator">+</span>RNG_c<span class="token punctuation">;</span>
         <span class="token keyword">return</span> RNG_state<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// FPU PRNG definitions and routines:</span>

<span class="token keyword">union</span> uint32_t_float
<span class="token punctuation">&#123;</span>
         <span class="token class-name">uint32_t</span> i<span class="token punctuation">;</span>
         <span class="token keyword">float</span> f<span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">float</span> <span class="token function">float_rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
         <span class="token keyword">union</span> uint32_t_float tmp<span class="token punctuation">;</span>
         tmp<span class="token punctuation">.</span>i<span class="token operator">=</span><span class="token function">my_rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x007fffff</span> <span class="token operator">|</span> <span class="token number">0x3F800000</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span> tmp<span class="token punctuation">.</span>f<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// test</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span>
         <span class="token function">my_srand</span><span class="token punctuation">(</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// PRNG initialization</span>

         <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
                  <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"%f\n"</span><span class="token punctuation">,</span> <span class="token function">float_rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token operator">$</span>SG4232  DB     <span class="token string">'%f'</span>, <span class="token number">0aH</span>, <span class="token number">00H</span>

__real@3ff0000000000000 DQ 03ff0000000000000r <span class="token comment">;1</span>

tv140 <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">4</span>                
_tmp<span class="token operator">$</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">4</span>                
?float_rand@@YAMXZ PROC
        push    <span class="token register variable">ecx</span>
        call    ?my_rand@@YAIXZ
<span class="token comment">; EAX=pseudorandom value</span>
        and     <span class="token register variable">eax</span>, <span class="token number">8388607</span>        <span class="token comment">; 007fffffH</span>
        or      <span class="token register variable">eax</span>, <span class="token number">1065353216</span>     <span class="token comment">; 3f800000H</span>
<span class="token comment">; EAX=pseudorandom value &amp; 0x007fffff | 0x3f800000</span>
<span class="token comment">; store it into local stack:</span>
        mov     DWORD PTR _tmp<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">eax</span>
<span class="token comment">; reload it as float point number:</span>
        fld     DWORD PTR _tmp<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>
<span class="token comment">; subtract 1.0:</span>
        fsub    QWORD PTR __real@3ff0000000000000
<span class="token comment">; store value we got into local stack and reload it:</span>
        fstp    DWORD PTR tv130<span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span> <span class="token comment">; \  these instructions are redundant</span>
        fld     DWORD PTR tv130<span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span> <span class="token comment">; /</span>
        pop     <span class="token register variable">ecx</span>
        ret     <span class="token number">0</span>
?float_rand@@YAMXZ ENDP

_main   PROC
        push    <span class="token register variable">esi</span>
        xor     <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
        call    _time
        push    <span class="token register variable">eax</span>
        call    ?my_srand@@YAXI@Z
        add     <span class="token register variable">esp</span>, <span class="token number">4</span>
        mov     <span class="token register variable">esi</span>, <span class="token number">100</span>
<span class="token label function">$LL3@main:</span>
        call    ?float_rand@@YAMXZ
        sub     <span class="token register variable">esp</span>, <span class="token number">8</span>
        fstp    QWORD PTR <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">]</span>
        push    OFFSET <span class="token operator">$</span>SG4238
        call    _printf
        add     <span class="token register variable">esp</span>, <span class="token number">12</span>
        dec     <span class="token register variable">esi</span>
        jne     SHORT <span class="token operator">$</span>LL3@main
        xor     <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
        pop     <span class="token register variable">esi</span>
        ret     <span class="token number">0</span>
_main   ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¦‚æœä½¿ç”¨MSVC 2012ç¼–è¯‘å™¨è¿›è¡Œç¼–è¯‘ï¼Œé‚£ä¹ˆå¯æ‰§è¡Œç¨‹åºåˆ™ä¼šä½¿ç”¨é¢å‘FPUçš„SIMDæŒ‡ä»¤ã€‚</p>
<h4 id="è®¡ç®—æœºå™¨ç²¾åº¦"><a class="markdownIt-Anchor" href="#è®¡ç®—æœºå™¨ç²¾åº¦"></a> è®¡ç®—æœºå™¨ç²¾åº¦</h4>
<p><code>å•ç²¾åº¦æµ®ç‚¹æ•°çš„â€œæœºå™¨ç²¾åº¦/machine epsilonâ€æŒ‡çš„æ˜¯ç›¸å¯¹è¯¯å·®çš„ä¸Šé™ï¼Œå³FPUæ“ä½œçš„æœ€å°å€¼</code>ã€‚å› æ­¤ï¼Œæµ®ç‚¹æ•°çš„æ•°æ®ä½è¶Šå¤šï¼Œè¯¯å·®è¶Šå°ã€ç²¾åº¦è¶Šé«˜ã€‚æ•…è€Œå•ç²¾åº¦floatå‹æ•°æ®çš„æœ€é«˜ç²¾åº¦ä¸º2âˆ’23=1.19eâˆ’7ï¼Œè€ŒåŒç²¾åº¦doubleå‹çš„æœ€é«˜ç²¾åº¦ä¸º2âˆ’52=2.22eâˆ’16ã€‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span>

<span class="token keyword">union</span> uint_float
<span class="token punctuation">&#123;</span>
        <span class="token class-name">uint32_t</span> i<span class="token punctuation">;</span>
        <span class="token keyword">float</span> f<span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">float</span> <span class="token function">calculate_machine_epsilon</span><span class="token punctuation">(</span><span class="token keyword">float</span> start<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        <span class="token keyword">union</span> uint_float v<span class="token punctuation">;</span>
        v<span class="token punctuation">.</span>f<span class="token operator">=</span>start<span class="token punctuation">;</span>
        v<span class="token punctuation">.</span>i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> v<span class="token punctuation">.</span>f<span class="token operator">-</span>start<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span> 
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">&#123;</span>
        <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"%g\n"</span><span class="token punctuation">,</span> <span class="token function">calculate_machine_epsilon</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸Šè¿°ç¨‹åºä»IEEE 754æ ¼å¼çš„æµ®ç‚¹æ•°ä¸­æå–å°æ•°éƒ¨åˆ†ï¼ŒæŠŠè¿™éƒ¨åˆ†å½“ä½œæ•´æ•°å¤„ç†å¹¶ä¸”ç»™å®ƒåŠ ä¸Š1ã€‚<code>è¿ç®—çš„ä¸­é—´å€¼æ˜¯â€œè¾“å…¥å€¼ï¼‹æœºå™¨ç²¾åº¦â€ã€‚é€šè¿‡æµ‹ç®—è¾“å…¥å€¼ï¼ˆå•ç²¾åº¦å‹æ•°å€¼ï¼‰ä¸ä¸­é—´å€¼çš„å·®å€¼</code>æ¥æµ‹ç®—å…·ä½“floatå‹æ•°æ®çš„æœºå™¨ç²¾åº¦ã€‚</p>
<p>ç¨‹åºä½¿ç”¨unionå‹æ•°æ®ç»“æ„è§£æIEEE 754æ ¼å¼çš„floatå‹æµ®ç‚¹æ•°ï¼Œå¹¶åˆ©ç”¨è¿™ç§æ•°æ®ç»“æ„æŠŠfloatæ•°æ®çš„å°æ•°éƒ¨åˆ†æå–ä¸ºæ•´æ•°<code>â€œ1â€å®é™…ä¸ŠåŠ åˆ°æµ®ç‚¹æ•°å°æ•°éƒ¨åˆ†ä¸­å»äº†ã€‚å½“ç„¶ï¼Œè¿™å¯èƒ½é€ æˆæº¢å‡ºï¼Œå¯èƒ½æŠŠæœ€é«˜ä½çš„è¿›ä½åŠ åˆ°æµ®ç‚¹æ•°çš„æŒ‡æ•°éƒ¨åˆ†</code>ã€‚</p>
<p>X86 asm</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">tv130 <span class="token operator">=</span> <span class="token number">8</span>
_v<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>
_start<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>
_calculate_machine_epsilon PROC
        fld      DWORD PTR _start<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span><span class="token comment">;1.0</span>
        fst      DWORD PTR _v<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>      <span class="token comment">;å†—ä½™ä»£ç </span>
        inc      DWORD PTR _v<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
        fsubr    DWORD PTR _v<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span><span class="token comment">;_v-start</span>
        fstp     DWORD PTR tv130<span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>    <span class="token comment">;å†—ä½™ä»£ç </span>
        fld      DWORD PTR tv130<span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>    <span class="token comment">;å†—ä½™ä»£ç </span>
        ret      <span class="token number">0</span>
_calculate_machine_epsilon ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>é¦–å…ˆå­˜å‚¨åœ°å€</li>
<li>æ¥ç€<code>inc</code>æŒ‡ä»¤æŠŠè¾“å…¥å€¼çš„å°æ•°éƒ¨åˆ†å½“åšæ•´æ•°æ•°æ®å¤„ç†,å°æ•°éƒ¨åˆ†+1ï¼Œåˆ©ç”¨<code>FSUBR</code>è®¡ç®—å·®å€¼,ä»è€Œå¾—åˆ°ç›¸å¯¹è¯¯å·®</li>
</ul>
<h4 id="å¿«é€Ÿå¹³æ–¹æ ¹è®¡ç®—"><a class="markdownIt-Anchor" href="#å¿«é€Ÿå¹³æ–¹æ ¹è®¡ç®—"></a> å¿«é€Ÿå¹³æ–¹æ ¹è®¡ç®—</h4>
<p>å¿«é€Ÿå¹³æ–¹æ ¹è®¡ç®—ä¹Ÿæ˜¯åˆ©ç”¨äº†æµ®ç‚¹æ•°è§£é‡Šä¸ºæ•´æ•°çš„æ€æƒ³</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Assumes that float is in the IEEE 754 single precision floating point format
 * and that int is 32 bits. */</span>
<span class="token keyword">float</span> <span class="token function">sqrt_approx</span><span class="token punctuation">(</span><span class="token keyword">float</span> z<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> val_int <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>z<span class="token punctuation">;</span> <span class="token comment">/* Same bits, but as an int */</span>
    <span class="token comment">/*
     * To justify the following code, prove that
     *
     * ((((val_int / 2^m) - b) / 2) + b) * 2^m = ((val_int - 2^m) / 2) + ((b + 1) / 2) * 2^m)
     *
     *where
     *
     *b = exponent bias
     * m = number of mantissa bits
     *
     *
     .
     */</span>

    val_int <span class="token operator">-=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">23</span><span class="token punctuation">;</span> <span class="token comment">/* Subtract 2^m. */</span>
    val_int <span class="token operator">>>=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">/* Divide by 2. */</span>
    val_int <span class="token operator">+=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">29</span><span class="token punctuation">;</span> <span class="token comment">/* Add ((b + 1) / 2) * 2^m. */</span>

    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>val_int<span class="token punctuation">;</span> <span class="token comment">/* Interpret again as float */</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>é€šè¿‡æ•´æ•°è¡¨ç¤ºç›´æ¥å¤„ç†åŸå§‹æµ®ç‚¹å€¼çš„æ¯”ç‰¹ã€‚</li>
<li>åæ ‡è°ƒæ•´æŒ‡æ•°éƒ¨åˆ†æ¥å®ç°å¹³æ–¹æ ¹è¿‘ä¼¼ã€‚</li>
<li>é€šè¿‡å³ç§»æ“ä½œå’Œæ·»åŠ åç§»é‡çš„æ–¹å¼ï¼Œæä¾›äº†ä¸€ä¸ªå¿«é€Ÿä¸”æœ‰æ•ˆçš„è¿‘ä¼¼ç»“æœã€‚<strong>ä¸æ˜¯å¾ˆé‡è¦</strong></li>
</ol>
<h3 id="chap23-å‡½æ•°æŒ‡é’ˆ"><a class="markdownIt-Anchor" href="#chap23-å‡½æ•°æŒ‡é’ˆ"></a> Chap23 å‡½æ•°æŒ‡é’ˆ</h3>
<p><em>å‡½æ•°æŒ‡é’ˆå’Œå…¶ä»–æŒ‡é’ˆæ²¡æœ‰å¤ªå¤§åŒºåˆ«ã€‚å®ƒä»£è¡¨çš„åœ°å€ä¸ºå‡½æ•°ä»£ç æ®µçš„èµ·å§‹åœ°å€ã€‚</em></p>
<p>åœ¨<code>å‡½æ•°æŒ‡é’ˆï¼ˆåœ°å€ï¼‰</code>ä»¥<code>å‡½æ•°å‚æ•°çš„å½¢å¼</code>ä¼ é€’ç»™<code>å¦ä¸€ä¸ªå‡½æ•°</code>ï¼Œç»§è€Œ<code>è¢«ç”¨æ¥è°ƒç”¨è¯¥æŒ‡é’ˆæ‰€æŒ‡å‘çš„å‡½æ•°</code>æ—¶ï¼Œè¿™ç§å‡½æ•°æŒ‡é’ˆçš„æ‰€æŒ‡å‘çš„å‡½æ•°å°±æ˜¯â€œ<code>å›è°ƒå‡½æ•°</code>â€/callback function</p>
<p>æ­¤ç±»æŒ‡é’ˆä¸»è¦åº”ç”¨äºï¼š</p>
<ul>
<li>æ ‡å‡†Cå‡½æ•°åº“é‡Œçš„<code>qsort()</code>å‡½æ•°å’Œ<code>atexit()å‡½æ•°</code>[<a href="#anchor232">2]</a>ã€‚</li>
<li>*NIXç³»ç»Ÿé‡Œçš„ä¿¡å·ï¼ˆSignalsï¼‰[<a href="#anchor233">3]</a>ã€‚</li>
<li>å¯åŠ¨çº¿ç¨‹çš„CreateThread()ï¼ˆwindowså‡½æ•°ï¼‰å’Œpthread_create()ï¼ˆPOSIXå‡½æ•°ï¼‰ã€‚</li>
<li>Win32çš„å¤šç§å‡½æ•°ï¼Œä¾‹å¦‚EnumChildWindows()[<a href="#anchor234">4]</a>ã€‚</li>
<li>Linuxå†…æ ¸ã€‚ä¾‹å¦‚ï¼ŒLinuxä»¥callbackçš„æ–¹å¼è°ƒç”¨æ–‡ä»¶ç³»ç»Ÿçš„é©±åŠ¨å‡½æ•°ï¼š<a target="_blank" rel="noopener" href="http://lxr.free-electrons.com/source/include/linux/fs.h?v=3.14#L1525%E3%80%82">http://lxr.free-electrons.com/source/include/linux/fs.h?v=3.14#L1525ã€‚</a></li>
<li>GCCæ’ä»¶ï¼š<a target="_blank" rel="noopener" href="https://gcc.gnu.org/onlinedocs/gccint/Plugin-API.html#Plugin-API%E3%80%82">https://gcc.gnu.org/onlinedocs/gccint/Plugin-API.html#Plugin-APIã€‚</a></li>
<li>Linuxçª—å£ç®¡ç†ç¨‹åºå®šä¹‰å¿«æ·æ–¹å¼çš„dwmè¡¨ã€‚å½“é”®ç›˜æ¥æ”¶åˆ°å¯åŒ¹é…çš„ç‰¹å®šé”®æ—¶ï¼Œå¯¹åº”çš„å¿«æ·æ–¹å¼å°±é€šè¿‡callbackè°ƒç”¨ç›¸åº”å‡½æ•°ã€‚è¯·å‚è§GitHubï¼ˆ<a target="_blank" rel="noopener" href="https://github.com/cdown/dwm/">https://github.com/cdown/dwm/</a> blob/master/config.def.h#L117ï¼‰ï¼Œcallbackæ–¹æ³•è¦æ¯”å¤§é‡ä½¿ç”¨switch()è¯­å¥çš„æ–¹æ³•æ›´ä¸ºç®€å•ã€‚</li>
</ul>
<p>å…¶ä¸­ï¼Œqsort()å‡½æ•°æ˜¯C/C++ç¼–è¯‘å™¨å‡½æ•°åº“è‡ªå¸¦çš„å¿«é€Ÿæ’åºå‡½æ•°ã€‚æ— è®ºå¾…æ’åºçš„æ•°æ®æ˜¯ä½•ç§æ•°æ®ç±»å‹ï¼Œåªè¦ç¼–å†™å‡ºæ¯”è¾ƒä¸¤ä¸ªå…ƒç´ çš„å‡½æ•°ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç”¨qsort()å‡½æ•°ä»¥callbackçš„æ–¹å¼è°ƒç”¨æ¯”è¾ƒå‡½æ•°ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯å£°æ˜æ¯”è¾ƒå‡½æ•°ä¸ºï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">int (*compare)(const void *, const void *)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"> <span class="token number">1</span>  <span class="token comment">/* ex3 Sorting ints with qsort */</span>
 <span class="token number">2</span>
 <span class="token number">3</span>  #include <span class="token operator">&lt;</span>stdio<span class="token punctuation">.</span>h<span class="token operator">></span>
 <span class="token number">4</span>  #include <span class="token operator">&lt;</span>stdlib<span class="token punctuation">.</span>h<span class="token operator">></span>
 <span class="token number">5</span>
 <span class="token number">6</span>  <span class="token keyword">int</span> <span class="token function">comp</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span> _a<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span> _b<span class="token punctuation">)</span>
 <span class="token number">7</span>  <span class="token punctuation">&#123;</span>
 <span class="token number">8</span>    <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">*</span>a<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span>_a<span class="token punctuation">;</span>
 <span class="token number">9</span>    <span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">*</span>b<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span>_b<span class="token punctuation">;</span>
<span class="token number">10</span>
<span class="token number">11</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>a<span class="token operator">==</span><span class="token operator">*</span>b<span class="token punctuation">)</span>
<span class="token number">12</span>      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">13</span>    <span class="token keyword">else</span>
<span class="token number">14</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>a <span class="token operator">&lt;</span> <span class="token operator">*</span>b<span class="token punctuation">)</span>
<span class="token number">15</span>           <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">16</span>       <span class="token keyword">else</span>
<span class="token number">17</span>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">18</span>  <span class="token punctuation">&#125;</span>
<span class="token number">19</span>
<span class="token number">20</span>  <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token number">21</span>  <span class="token punctuation">&#123;</span>
<span class="token number">22</span>    <span class="token keyword">int</span> numbers<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token number">1892</span><span class="token punctuation">,</span><span class="token number">45</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">98</span><span class="token punctuation">,</span><span class="token number">4087</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">12345</span><span class="token punctuation">,</span><span class="token number">1087</span><span class="token punctuation">,</span><span class="token number">88</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">100000</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token number">23</span>    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
<span class="token number">24</span>
<span class="token number">25</span>   <span class="token comment">/* Sort the array */</span>
<span class="token number">26</span>   <span class="token function">qsort</span><span class="token punctuation">(</span>numbers<span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span>comp<span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token number">27</span>   <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">9</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
<span class="token number">28</span>     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Number = %d\n"</span><span class="token punctuation">,</span>numbers<span class="token punctuation">[</span> i <span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token number">29</span>   <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">30</span>  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr />
<p><code>msvs 2010 asm</code>å¯ç”¨é€‰é¡¹/Ox /GS- /MD</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">__a<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>          <span class="token comment">; size = 4</span>
__b<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">12</span>         <span class="token comment">; size = 4</span>
_comp   PROC
         mov  <span class="token register variable">eax</span>, DWORD PTR __a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
         mov  <span class="token register variable">ecx</span>, DWORD PTR __b<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
         mov  <span class="token register variable">eax</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span>
         mov  <span class="token register variable">eax</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">]</span>
         cmp  <span class="token register variable">eax</span>, <span class="token register variable">ecx</span>
         jne  SHORT <span class="token operator">$</span>LN4@comp
         xor  <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
         ret  <span class="token number">0</span>
<span class="token label function">$LN4@comp:</span>
         xor  <span class="token register variable">edx</span>, <span class="token register variable">edx</span>
         cmp  <span class="token register variable">eax</span>, <span class="token register variable">ecx</span>
         setge <span class="token register variable">dl</span>
         lea  <span class="token register variable">eax</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">edx</span><span class="token operator">+</span><span class="token register variable">edx</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">]</span>
         ret  <span class="token number">0</span>
_comp ENDP


_numbers<span class="token operator">$</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">40</span>       <span class="token comment">; size = 40</span>
_argc<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>        ã€€ã€€ <span class="token comment">; size = 4</span>
_argv<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">12</span>        ã€€ã€€<span class="token comment">; size = 4</span>
_main   PROC
         sub  <span class="token register variable">esp</span>, <span class="token number">40</span>     ã€€ã€€ã€€<span class="token comment">; 00000028H</span>
         push <span class="token register variable">esi</span>
         push OFFSET _comp
         push <span class="token number">4</span>
         lea  <span class="token register variable">eax</span>, DWORD PTR _numbers<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">52</span><span class="token operator">]</span>
         push <span class="token number">10</span>       <span class="token comment">; 0000000aH</span>
         push <span class="token register variable">eax</span>
         mov  DWORD PTR _numbers<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">60</span><span class="token operator">]</span>, <span class="token number">1892</span> ã€€ <span class="token comment">; 00000764H</span>
         mov  DWORD PTR _numbers<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">64</span><span class="token operator">]</span>, <span class="token number">45</span> ã€€ã€€ <span class="token comment">; 0000002dH</span>
         mov  DWORD PTR _numbers<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">68</span><span class="token operator">]</span>, <span class="token number">200</span>ã€€ã€€ <span class="token comment">; 000000c8H</span>
         mov  DWORD PTR _numbers<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">72</span><span class="token operator">]</span>, <span class="token operator">-</span><span class="token number">98</span> ã€€ã€€<span class="token comment">; ffffff9eH</span>
         mov  DWORD PTR _numbers<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">76</span><span class="token operator">]</span>, <span class="token number">4087</span>ã€€ã€€<span class="token comment">; 00000ff7H</span>
         mov  DWORD PTR _numbers<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">80</span><span class="token operator">]</span>, <span class="token number">5</span>
         mov  DWORD PTR _numbers<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">84</span><span class="token operator">]</span>, <span class="token operator">-</span><span class="token number">12345</span>  <span class="token comment">; ffffcfc7H</span>
         mov  DWORD PTR _numbers<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">88</span><span class="token operator">]</span>, <span class="token number">1087</span> ã€€ <span class="token comment">; 0000043fH</span>
         mov  DWORD PTR _numbers<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">92</span><span class="token operator">]</span>, <span class="token number">88</span>ã€€ã€€  <span class="token comment">; 00000058H</span>
         mov  DWORD PTR _numbers<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">96</span><span class="token operator">]</span>, <span class="token operator">-</span><span class="token number">100000</span> <span class="token comment">; fffe7960H</span>
         call  _qsort
         add  <span class="token register variable">esp</span>, <span class="token number">16</span>    ã€€ã€€ã€€    <span class="token comment">; 00000010H</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™ä¸€éƒ¨åˆ†æ¯”è¾ƒæ™®é€šï¼Œå¯ä»¥çœ‹åˆ°åœ¨ä¼ é€’ç¬¬4ä¸ªå‚æ•°çš„æ—¶å€™ä¼ é€’çš„æ˜¯æ ‡ç­¾<code>_comp</code>çš„åœ°å€å…³é”®æ˜¯çœ‹<code>qsort</code>å¦‚ä½•è°ƒç”¨<code>comp()</code></p>
<p><code>qsort</code>ä½äº<code>MSVCR80.dll</code></p>
<hr />
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token label function">.text:</span>7816CBF0 <span class="token comment">; void __cdecl qsort(void *, unsigned int, unsigned int, int (__cdecl *)(const â†™</span>
    â†˜ void <span class="token operator">*</span>, const void <span class="token operator">*</span>))
<span class="token label function">.text:</span>7816CBF0                 public _qsort
<span class="token label function">.text:</span>7816CBF0 _qsort          proc near
<span class="token label function">.text:</span>7816CBF0
<span class="token label function">.text:</span>7816CBF0 lo              <span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">104h</span>
<span class="token label function">.text:</span>7816CBF0 hi              <span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">100h</span>
<span class="token label function">.text:</span>7816CBF0 var_FC          <span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">0FCh</span>
<span class="token label function">.text:</span>7816CBF0 stkptr          <span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">0F8h</span>
<span class="token label function">.text:</span>7816CBF0 lostk           <span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">0F4h</span>
<span class="token label function">.text:</span>7816CBF0 histk           <span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">7Ch</span>
<span class="token label function">.text:</span>7816CBF0 base            <span class="token operator">=</span> dword ptr  <span class="token number">4</span>
<span class="token label function">.text:</span>7816CBF0 num             <span class="token operator">=</span> dword ptr  <span class="token number">8</span>
<span class="token label function">.text:</span>7816CBF0 width           <span class="token operator">=</span> dword ptr  <span class="token number">0Ch</span>
<span class="token label function">.text:</span>7816CBF0 comp            <span class="token operator">=</span> dword ptr  <span class="token number">10h</span>
<span class="token label function">.text:</span>7816CBF0
<span class="token label function">.text:</span>7816CBF0                 sub     <span class="token register variable">esp</span>, <span class="token number">100h</span>
ã€€
 â€¦
ã€€
<span class="token label function">.text:</span>7816CCE0 loc_7816CCE0:                      <span class="token comment">; CODE XREF: _qsort+B1</span>
<span class="token label function">.text:</span>7816CCE0                 shr      <span class="token register variable">eax</span>, <span class="token number">1</span>
<span class="token label function">.text:</span>7816CCE2                 imul     <span class="token register variable">eax</span>, <span class="token register variable">ebp</span>
<span class="token label function">.text:</span>7816CCE5                 add      <span class="token register variable">eax</span>, <span class="token register variable">ebx</span>
<span class="token label function">.text:</span>7816CCE7                 mov      <span class="token register variable">edi</span>, <span class="token register variable">eax</span>
<span class="token label function">.text:</span>7816CCE9                 push     <span class="token register variable">edi</span>
<span class="token label function">.text:</span>7816CCEA                 push     <span class="token register variable">ebx</span>
<span class="token label function">.text:</span>7816CCEB                 call     <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">118h</span><span class="token operator">+</span>comp<span class="token operator">]</span><span class="token comment">;call comp</span>
<span class="token label function">.text:</span>7816CCF2                 add      <span class="token register variable">esp</span>, <span class="token number">8</span>
<span class="token label function">.text:</span>7816CCF5                 test     <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
<span class="token label function">.text:</span>7816CCF7                 jle      short loc_7816CD04<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>åœ¨æ‰§è¡Œqsort()çš„è¿‡ç¨‹ä¸­ï¼Œç³»ç»Ÿä¼šæŠŠæ§åˆ¶æƒä¼ é€’ç»™compå‚æ•°æŒ‡å‘çš„å‡½æ•°æŒ‡é’ˆçš„åœ°å€ã€‚åœ¨è°ƒç”¨å®ƒä¹‹å‰ï¼Œcomp()å‡½æ•°æ‰€éœ€çš„ä¸¤ä¸ªå‚æ•°å·²ç»ä¼ é€’åˆ°ä½ã€‚åœ¨æ‰§è¡Œå®ƒä¹‹åï¼Œæ’åºå·²ç»å®Œæˆã€‚</code></p>
<h3 id="chap24-32ä½ç³»ç»Ÿå¤„ç†64ä½æ•°æ®"><a class="markdownIt-Anchor" href="#chap24-32ä½ç³»ç»Ÿå¤„ç†64ä½æ•°æ®"></a> Chap24 32ä½ç³»ç»Ÿå¤„ç†64ä½æ•°æ®</h3>
<p>32ä½ç³»ç»Ÿçš„é€šç”¨å¯„å­˜å™¨GPRéƒ½åªèƒ½å®¹çº³32ä½æ•°æ®ï¼Œæ‰€ä»¥è¿™ç§å¹³å°å¿…é¡»æŠŠ64ä½æ•°æ®è½¬æ¢ä¸ºä¸€å¯¹32ä½æ•°æ®æ‰èƒ½è¿›è¡Œè¿ç®—ã€‚</p>
<hr />
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span>

<span class="token class-name">uint64_t</span> <span class="token function">f</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
       <span class="token keyword">return</span> <span class="token number">0x1234567890ABCDEF</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr />
<p><code>x86</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_f         PROC
           mov      <span class="token register variable">eax</span>, <span class="token operator">-</span><span class="token number">1867788817</span>       <span class="token comment">; 90abcdefH</span>
           mov      <span class="token register variable">edx</span>, <span class="token number">305419896</span>         <span class="token comment">; 12345678H</span>
           ret      <span class="token number">0</span>
_f         ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><mark>32ä½ç³»ç»Ÿç”¨å¯„å­˜å™¨ç»„åˆEDX:EAXæ¥ä¼ 64ä½æ•°æ®</mark></p>
<h4 id="å‚æ•°ä¼ é€’åŠåŠ å‡è¿ç®—"><a class="markdownIt-Anchor" href="#å‚æ•°ä¼ é€’åŠåŠ å‡è¿ç®—"></a> å‚æ•°ä¼ é€’åŠåŠ å‡è¿ç®—</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span>

<span class="token class-name">uint64_t</span> <span class="token function">f_add</span> <span class="token punctuation">(</span><span class="token class-name">uint64_t</span> a<span class="token punctuation">,</span> <span class="token class-name">uint64_t</span> b<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> a<span class="token operator">+</span>b<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">f_add_test</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__GNUC__</span></span>
        <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"%lld\n"</span><span class="token punctuation">,</span> <span class="token function">f_add</span><span class="token punctuation">(</span><span class="token number">12345678901234</span><span class="token punctuation">,</span> <span class="token number">23456789012345</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
        <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"%I64d\n"</span><span class="token punctuation">,</span> <span class="token function">f_add</span><span class="token punctuation">(</span><span class="token number">12345678901234</span><span class="token punctuation">,</span> <span class="token number">23456789012345</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token class-name">uint64_t</span> <span class="token function">f_sub</span> <span class="token punctuation">(</span><span class="token class-name">uint64_t</span> a<span class="token punctuation">,</span> <span class="token class-name">uint64_t</span> b<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> a<span class="token operator">-</span>b<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_a<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>         <span class="token comment">; size = 8</span>
_b<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">16</span>        <span class="token comment">; size = 8</span>
_f_add   PROC
         mov   <span class="token register variable">eax</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
         add   <span class="token register variable">eax</span>, DWORD PTR _b<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
         mov   <span class="token register variable">edx</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">]</span>
         adc   <span class="token register variable">edx</span>, DWORD PTR _b<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">]</span>
         ret        <span class="token number">0</span>
_f_add ENDP

_f_add_test PROC
        push   <span class="token number">5461</span>            <span class="token comment">; 00001555H</span>
        push   <span class="token number">1972608889</span>      <span class="token comment">; 75939f79H</span>
        push   <span class="token number">2874</span>            <span class="token comment">; 00000b3aH</span>
        push   <span class="token number">1942892530</span>      <span class="token comment">; 73ce2ff_subH</span>
        call   _f_add
        push   <span class="token register variable">edx</span>
        push   <span class="token register variable">eax</span>
        push   OFFSET <span class="token operator">$</span>SG1436  <span class="token comment">; â€™%I64dâ€™, 0aH, 00H</span>
        call   _printf
        add    <span class="token register variable">esp</span>, <span class="token number">28</span>
        ret    <span class="token number">0</span>
_f_add_test ENDP

_f_sub  PROC
        mov    <span class="token register variable">eax</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
        sub    <span class="token register variable">eax</span>, DWORD PTR _b<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
        mov    <span class="token register variable">edx</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">]</span>
        sbb    <span class="token register variable">edx</span>, DWORD PTR _b<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">]</span>
        ret    <span class="token number">0</span>
_f_sub ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p>åœ¨<code>f1_test()</code>å‡½æ•°ï¼Œæ¯ä¸ª64ä½æ•°æ®è¢«æ‹†åˆ†ä¸ºäº†2ä¸ª32ä½æ•°æ®ã€‚åœ¨å†…å­˜ä¸­ï¼Œé«˜32ä½æ•°æ®åœ¨å‰ï¼Œä½32ä½åœ¨åã€‚</p>
<p>åŠ å‡æ³•è¿ç®—çš„å¤„ç†æ–¹æ³•ä¹Ÿå®Œå…¨ç›¸åŒ</p>
<p>åœ¨è¿›è¡ŒåŠ æ³•è¿ç®—æ—¶ï¼Œå…ˆå¯¹ä½32ä½ç›¸åŠ ã€‚å¦‚æœäº§ç”Ÿäº†è¿›ä½ï¼Œå°±è®¾ç½®CFæ ‡è¯†ä½ã€‚ç„¶å<code>ADC</code>æŒ‡ä»¤å¯¹é«˜32ä½è¿›è¡Œè¿ç®—ï¼Œå¦‚æœæ­¤æ—¶<code>CF</code>æ ‡è¯†ä½çš„å€¼ä¸º1ï¼Œåˆ™å†æŠŠ32ä½çš„è¿ç®—ç»“æœåŠ ä¸Š1</p>
</li>
<li>
<p>å‡æ³•è¿ç®—ä¹Ÿæ˜¯åˆ†æ­¥è¿›è¡Œçš„ã€‚ç¬¬ä¸€æ¬¡çš„å‡æ³•è¿ç®—å¯èƒ½å½±å“CFæ ‡è¯†ä½ã€‚ç¬¬äºŒæ¬¡å‡æ³•è¿ç®—ä¼šæ ¹æ®CFæ ‡è¯†ä½æŠŠå€Ÿä½ä»£å…¥è®¡ç®—ç»“æœã€‚</p>
</li>
</ul>
<p><mark>åœ¨32ä½ç³»ç»Ÿä¸­ï¼Œå‡½æ•°åœ¨è¿”å›64ä½æ•°æ®æ—¶éƒ½ä½¿ç”¨EDX:EAXå¯„å­˜å™¨å¯¹ã€‚</mark></p>
<h4 id="ä¹˜æ³•å’Œé™¤æ³•è¿ç®—"><a class="markdownIt-Anchor" href="#ä¹˜æ³•å’Œé™¤æ³•è¿ç®—"></a> ä¹˜æ³•å’Œé™¤æ³•è¿ç®—</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span>

<span class="token class-name">uint64_t</span> <span class="token function">f_mul</span> <span class="token punctuation">(</span><span class="token class-name">uint64_t</span> a<span class="token punctuation">,</span> <span class="token class-name">uint64_t</span> b<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> a<span class="token operator">*</span>b<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token class-name">uint64_t</span> <span class="token function">f_div</span> <span class="token punctuation">(</span><span class="token class-name">uint64_t</span> a<span class="token punctuation">,</span> <span class="token class-name">uint64_t</span> b<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> a<span class="token operator">/</span>b<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token class-name">uint64_t</span> <span class="token function">f_rem</span> <span class="token punctuation">(</span><span class="token class-name">uint64_t</span> a<span class="token punctuation">,</span> <span class="token class-name">uint64_t</span> b<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> a <span class="token operator">%</span> b<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>msvs x86</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_a<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span> <span class="token comment">; size = 8</span>
_b<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">16</span> <span class="token comment">; size = 8</span>
_f_mul  PROC
        push    <span class="token register variable">ebp</span>
        mov     <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
        mov     <span class="token register variable">eax</span>, DWORD PTR _b<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>
        push    <span class="token register variable">eax</span>
        mov     <span class="token register variable">ecx</span>, DWORD PTR _b<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
        push    <span class="token register variable">ecx</span>
        mov     <span class="token register variable">edx</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>
        push    <span class="token register variable">edx</span>
        mov     <span class="token register variable">eax</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
        push    <span class="token register variable">eax</span>
        call    __allmul <span class="token comment">; long long multiplication</span>
        pop     <span class="token register variable">ebp</span>
        ret     <span class="token number">0</span>
_f_mul  ENDP

_a<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span> <span class="token comment">; size = 8</span>
_b<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">16</span> <span class="token comment">; size = 8</span>
_f_div  PROC
        push    <span class="token register variable">ebp</span>
        mov     <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
        mov     <span class="token register variable">eax</span>, DWORD PTR _b<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>
        push    <span class="token register variable">eax</span>
        mov     <span class="token register variable">ecx</span>, DWORD PTR _b<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
        push    <span class="token register variable">ecx</span>
        mov     <span class="token register variable">edx</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>
        push    <span class="token register variable">edx</span>
        mov     <span class="token register variable">eax</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
        push    <span class="token register variable">eax</span>
        call    __aulldiv <span class="token comment">; unsigned long long division</span>
        pop     <span class="token register variable">ebp</span>
        ret     <span class="token number">0</span>
_f_div ENDP

_a<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span> <span class="token comment">; size = 8</span>
_b<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">16</span> <span class="token comment">; size = 8</span>
_f_rem  PROC
        push    <span class="token register variable">ebp</span>
        mov     <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
        mov     <span class="token register variable">eax</span>, DWORD PTR _b<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>
        push    <span class="token register variable">eax</span>
        mov     <span class="token register variable">ecx</span>, DWORD PTR _b<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
        push    <span class="token register variable">ecx</span>
        mov     <span class="token register variable">edx</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>
        push    <span class="token register variable">edx</span>
        mov     <span class="token register variable">eax</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
        push    <span class="token register variable">eax</span>
        call    __aullrem <span class="token comment">; unsigned long long remainder</span>
        pop     <span class="token register variable">ebp</span>
        ret     <span class="token number">0</span>
_f_rem   ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><mark>ä¹˜é™¤è¿ç®—å¤æ‚å¾ˆå¤šã€‚æ‰€ä»¥ç¼–è¯‘å™¨é€šå¸¸å€ŸåŠ©æ ‡å‡†åº“å‡½æ•°æ¥å¤„ç†ä¹˜é™¤è¿ç®—ã€‚</mark></p>
<p>ä½†è¿˜æ˜¯éƒ½ç”¨<code>EDX:EAX</code>ä¼ é€’æ•°æ®ï¼Œæœ¬æ¥ä¹˜é™¤ç”¨æ±‡ç¼–æŒ‡ä»¤è¿›è¡Œï¼Œæ”¹ä¸ºç”¨å‡½æ•°å¤„ç†</p>
<p>è€Œ<code>gcc</code>ä¼šæŠŠä¹˜æ³•è¿ç®—è¿›è¡Œå†…éƒ¨å¤„ç†å±•å¼€</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token label function">_f_mul:</span>
        push    <span class="token register variable">ebx</span>
        mov     <span class="token register variable">edx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span>
        mov     <span class="token register variable">eax</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">16</span><span class="token operator">]</span>
        mov     <span class="token register variable">ebx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">12</span><span class="token operator">]</span>
        mov     <span class="token register variable">ecx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">20</span><span class="token operator">]</span>
        imul    <span class="token register variable">ebx</span>, <span class="token register variable">eax</span>
        imul    <span class="token register variable">ecx</span>, <span class="token register variable">edx</span>
        mul     <span class="token register variable">edx</span>
        add     <span class="token register variable">ecx</span>, <span class="token register variable">ebx</span>
        add     <span class="token register variable">edx</span>, <span class="token register variable">ecx</span>
        pop     <span class="token register variable">ebx</span>
        ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="å³ç§»"><a class="markdownIt-Anchor" href="#å³ç§»"></a> å³ç§»</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span>

<span class="token class-name">uint64_t</span> <span class="token function">f</span> <span class="token punctuation">(</span><span class="token class-name">uint64_t</span> a<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
         <span class="token keyword">return</span> a<span class="token operator">>></span><span class="token number">7</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr />
<p><code>optimizing msvs x86</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_a<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>         <span class="token comment">; size = 8</span>
_f      PROC
        mov     <span class="token register variable">eax</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
        mov     <span class="token register variable">edx</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">]</span>
        shrd    <span class="token register variable">eax</span>, <span class="token register variable">edx</span>, <span class="token number">7</span>
        shr     <span class="token register variable">edx</span>, <span class="token number">7</span>
        ret     <span class="token number">0</span>
_f      ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>optimizing gcc</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token label function">_f:</span>
        mov     <span class="token register variable">edx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span>
        mov     <span class="token register variable">eax</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>
        shrd    <span class="token register variable">eax</span>, <span class="token register variable">edx</span>, <span class="token number">7</span>
        shr     <span class="token register variable">edx</span>, <span class="token number">7</span>
        ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>SHRDæŒ‡ä»¤ã€‚è¿™ä¸ªæŒ‡ä»¤ä¸ä»…å¯ä»¥æŠŠEAXé‡Œçš„ä½32ä½æ•°æ®å³ç§»7ä½è¿ç®—ï¼Œè€Œä¸”è¿˜èƒ½ä»EDXå¯„å­˜å™¨é‡Œè¯»å–é«˜32ä½ä¸­çš„ä½7ä½ã€ç”¨å®ƒå¡«è¡¥åˆ°ä½32ä½æ•°æ®çš„é«˜ä½ã€‚</code><br />
å¯ä»¥å‘ç°ï¼Œ32ä½å¤„ç†64ä½æ•°æ®å³ç§»åŠ¨æ—¶åˆ†ä¸ºä¸¤æ­¥</p>
<ol>
<li>å…ˆå¤„ç†ä½ä½ï¼Œåˆ©ç”¨<code>SHRD</code>æŒ‡ä»¤</li>
<li>å†å¤„ç†é«˜ä½,<code>SHR EDX,7</code>ï¼ŒæŠŠé«˜32ä½æ•°æ®å³ç§»</li>
</ol>
<h4 id="32ä½æ•°æ®è½¬æ¢ä¸º64ä½æ•°æ®"><a class="markdownIt-Anchor" href="#32ä½æ•°æ®è½¬æ¢ä¸º64ä½æ•°æ®"></a> 32ä½æ•°æ®è½¬æ¢ä¸º64ä½æ•°æ®</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span>

<span class="token class-name">int64_t</span> <span class="token function">f</span> <span class="token punctuation">(</span><span class="token class-name">int32_t</span> a<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
         <span class="token keyword">return</span> a<span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr />
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_a<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>
_f        PROC
          mov     <span class="token register variable">eax</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
          cdq
          ret     <span class="token number">0</span>
_f        ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>CDQ</code>ï¼ˆConvert Doubleword to Quadwordï¼‰æ˜¯ x86 æ±‡ç¼–è¯­è¨€ä¸­çš„ä¸€æ¡æŒ‡ä»¤ï¼Œç”¨äºç¬¦å·æ‰©å±•å¯„å­˜å™¨ <code>EAX</code> åˆ°å¯„å­˜å™¨ <code>EDX:EAX</code>ã€‚å®ƒé€šå¸¸ç”¨äºå°†ä¸€ä¸ª32ä½æœ‰ç¬¦å·æ•´æ•°æ‰©å±•ä¸º64ä½æœ‰ç¬¦å·æ•´æ•°ã€‚</p>
<p><code>CDQ</code> æŒ‡ä»¤å°†å¯„å­˜å™¨ <code>EAX</code> çš„æœ€é«˜æœ‰æ•ˆä½ï¼ˆå³ç¬¦å·ä½ï¼‰å¤åˆ¶åˆ° <code>EDX</code> çš„æ‰€æœ‰ä½ï¼š</p>
<ul>
<li>å¦‚æœ <code>EAX</code> çš„æœ€é«˜æœ‰æ•ˆä½æ˜¯0ï¼ˆè¡¨ç¤ºæ­£æ•°ï¼‰ï¼Œé‚£ä¹ˆ <code>EDX</code> çš„æ‰€æœ‰ä½éƒ½è¢«è®¾ç½®ä¸º0ã€‚</li>
<li>å¦‚æœ <code>EAX</code> çš„æœ€é«˜æœ‰æ•ˆä½æ˜¯1ï¼ˆè¡¨ç¤ºè´Ÿæ•°ï¼‰ï¼Œé‚£ä¹ˆ <code>EDX</code> çš„æ‰€æœ‰ä½éƒ½è¢«è®¾ç½®ä¸º1ã€‚</li>
</ul>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">if <span class="token register variable">EAX</span> <span class="token operator">></span><span class="token operator">=</span> <span class="token number">0</span> then
    <span class="token register variable">EDX</span> :<span class="token operator">=</span> <span class="token number">0</span><span class="token comment">;</span>
else
    <span class="token register variable">EDX</span> :<span class="token operator">=</span> <span class="token number">0xFFFFFFFF</span><span class="token comment">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä»è€Œè¾¾åˆ°äº†è®¾ç½®ç¬¦å·ä½çš„æ•ˆæœ</p>
<h3 id="chap25-simd"><a class="markdownIt-Anchor" href="#chap25-simd"></a> *Chap25 SIMD</h3>
<img src="/2024/05/23/re4b%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image-20240610211849193.png" class="" alt="image-20240610211849193" loading="lazy">
<ul>
<li>
<p><code>SIMDæ„ä¸ºâ€œå•æŒ‡ä»¤æµå¤šæ•°æ®æµ</code>â€ï¼Œå…¶å…¨ç§°æ˜¯â€œ<code>Single Instruction, Multiple Data</code>â€ã€‚é¡¾åæ€ä¹‰ï¼Œè¿™ç±»æŒ‡ä»¤å¯ä»¥ä¸€æ¬¡å¤„ç†å¤šä¸ªæ•°æ®ã€‚åœ¨x86çš„CPUé‡Œï¼ŒSIMDå­ç³»ç»Ÿå’ŒFPUéƒ½ç”±ä¸“ç”¨æ¨¡å—å®ç°</p>
</li>
<li>
<p><code>-x86 CPU</code>é€šè¿‡<code>MMXæŒ‡ä»¤</code>ç‡å…ˆæ•´åˆäº†<code>SIMDçš„è¿ç®—åŠŸèƒ½</code>ã€‚æ”¯æŒè¿™ç§æŠ€æœ¯çš„CPUé‡Œéƒ½æœ‰<code>8ä¸ª64ä½å¯„å­˜å™¨</code>ï¼Œå³<code>MM0ï½MM7</code>ã€‚æ¯ä¸ª<code>MMXå¯„å­˜å™¨éƒ½æ˜¯8å­—èŠ‚å¯„å­˜å™¨</code>ï¼Œå¯ä»¥å®¹çº³<code>2ä¸ª32ä½æ•°æ®</code>ï¼Œæˆ–è€…<code>4ä¸ª16ä½æ•°æ®</code>ã€‚ä½¿ç”¨SIMDæŒ‡ä»¤è¿›è¡Œæ“ä½œæ•°çš„è®¡ç®—æ—¶ï¼Œå®ƒå¯ä»¥æŠŠ<code>8ä¸ª8ä½æ•°æ®åˆ†ä¸º4ç»„æ•°æ®</code>åŒæ—¶è¿ç®—ã€‚</p>
</li>
<li>
<p>å¹³é¢å›¾åƒå¯è§†ä¸ºä¸€ç§ç”±äºŒç»´æ•°ç»„æ„æˆçš„æ•°æ®ç»“æ„ã€‚åœ¨ç¾å·¥äººå‘˜è°ƒæ•´å›¾åƒäº®åº¦çš„æ—¶å€™ï¼Œå›¾åƒç¼–è¾‘ç¨‹åºå¾—å¯¹æ¯ä¸ªåƒç´ çš„äº®åº¦ç³»æ•°è¿›è¡ŒåŠ å‡æ³•çš„è¿ç®—ã€‚ç®€å•åœ°è¯´ï¼Œå›¾åƒçš„æ¯ä¸ªåƒç´ éƒ½æœ‰ç°åº¦ç³»æ•°ï¼Œè€Œä¸”ç°åº¦ç³»ç»Ÿæ˜¯8ä½æ•°æ®ï¼ˆ1ä¸ªå­—èŠ‚ï¼‰ã€‚å› è€Œï¼Œæ¯æ‰§è¡Œä¸€ä¸ªSIMDæŒ‡ä»¤å°±èƒ½å¤ŸåŒæ—¶è°ƒæ•´8ä¸ªåƒç´ çš„ç°åº¦ï¼ˆå³äº®åº¦ï¼‰ã€‚ä¸ºäº†æ»¡è¶³è¿™ç§éœ€è¦ï¼Œå¤„ç†å™¨å‚å•†åæ¥ä¸“é—¨æ¨å‡ºäº†åŸºäºSIMDæŠ€æœ¯çš„é¥±å’Œåº¦è°ƒæ•´æŒ‡ä»¤ã€‚è¿™ç§é¥±å’Œåº¦è°ƒæ•´æŒ‡ä»¤ç”šè‡³æœ‰è¶Šç•Œä¿æŠ¤åŠŸèƒ½ï¼Œèƒ½å¤Ÿé¿å…äº®åº¦è°ƒæ•´æ—¶å¯èƒ½ä¼šäº§ç”Ÿçš„å› å­ä¸Šæº¢ï¼ˆoverflowï¼‰å’Œä¸‹æº¢ï¼ˆunderflowï¼‰ç­‰é—®é¢˜ã€‚</p>
</li>
<li>
<p>SSEæŠ€æœ¯æ˜¯SIMDçš„æ‰©å±•æŠ€æœ¯ï¼Œå®ƒæŠŠSIMDå¯„å­˜å™¨æ‰©å±•ä¸º128ä½å¯„å­˜å™¨ã€‚æ”¯æŒSSEæŠ€æœ¯çš„CPUå·²ç»æœ‰äº†å•ç‹¬çš„SIMDé€šç”¨å¯„å­˜å™¨ï¼Œä¸å†å¤ç”¨FPUçš„å¯„å­˜å™¨ã€‚AVXæ˜¯å¦å¤–ä¸€ç§SIMDæŠ€æœ¯ï¼Œå®ƒçš„é€šç”¨å¯„å­˜å™¨éƒ½æ˜¯256ä½å¯„å­˜å™¨ã€‚</p>
</li>
<li>
<p><code>SIMD</code>å…·ä½“åº”ç”¨</p>
<ol>
<li>å†…å­˜å¤åˆ¶å’Œå†…å­˜æ¯”è¾ƒç­‰ç”¨é€”</li>
<li>ç”¨äºDESçš„è¿ç®—ã€‚<code>DES(Data Encryption Standard)</code>æ˜¯åˆ†ç»„å¯¹ç§°å¯†ç ç®—æ³•ï¼Œé‡‡ç”¨äº†64ä½çš„åˆ†ç»„å’Œ56ä½çš„å¯†é’¥ï¼Œå°†64ä½çš„è¾“å…¥ç»è¿‡ä¸€ç³»åˆ—å˜æ¢å¾—åˆ°64ä½çš„è¾“å‡ºã€‚å¦‚æœåœ¨ç”µè·¯çš„ä¸ã€æˆ–ã€éé—¨å’Œå¯¼çº¿å®ç°DESæ¨¡å—ï¼Œç”µè·¯è§„æ¨¡å°†ä¼šæ˜¯éå¸¸åºå¤§ã€‚åŸºäºå¹¶è¡Œåˆ†ç»„å¯†ç ç®—æ³•çš„Bitslice DES[<a href="#anchor251">1]</a>åº”è¿è€Œç”Ÿã€‚è¿™ç§ç®—æ³•å¯ç”±å•æŒ‡ä»¤å¹¶è¡Œå¤„ç†æŠ€æœ¯/SIMDå®ç°ã€‚æˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œx86å¹³å°çš„unsigned intå‹æ•°æ®å ç”¨32ä½ç©ºé—´ã€‚å› æ­¤ï¼Œåœ¨è¿›è¡Œunsigned intå‹æ•°æ®çš„64ä½æ•°æ®å’Œ56ä½å¯†é’¥çš„æ¼”ç®—æ—¶ï¼Œå¯ä»¥ä»¥æŠŠ64ä½ä¸­é—´è¿ç®—ç»“æœå’Œè¿ç®—å¯†é’¥éƒ½åˆ†ä¸º2ä¸ª32ä½æ•°æ®ï¼Œå†è¿›è¡Œåˆ†æ­¥çš„å¹¶è¡Œå¤„ç†ã€‚</li>
</ol>
</li>
</ul>
<h4 id="çŸ¢é‡åŒ–"><a class="markdownIt-Anchor" href="#çŸ¢é‡åŒ–"></a> çŸ¢é‡åŒ–</h4>
<p>çŸ¢é‡åŒ–æ³›æŒ‡å°†å¤šä¸ªæ ‡é‡æ•°ç»„è®¡ç®—ä¸ºï¼ˆè½¬æ¢æˆï¼‰ä¸€ä¸ªçŸ¢é‡æ•°ç»„çš„æŠ€æœ¯ã€‚è¿›è¡Œè¿™ç§è®¡ç®—æ—¶ï¼Œå¾ªç¯ä½“ä»è¾“å…¥æ•°ç»„ä¸­å–å€¼ï¼Œè¿›è¡ŒæŸç§è¿ç®—åç”Ÿæˆæœ€ç»ˆæ•°ç»„ã€‚è¿™ç§ç®—æ³•åªå¯¹æ•°ç»„ä¸­çš„å•ä¸ªå…ƒç´ è¿›è¡Œä¸€æ¬¡è¿ç®—ã€‚â€œï¼ˆå¹¶è¡Œï¼‰çŸ¢é‡åŒ–æŠ€æœ¯â€æ˜¯çŸ¢é‡åŒ–å¤„ç†çš„å¹¶è¡Œè®¡ç®—æŠ€æœ¯ã€‚</p>
<ul>
<li>ç”¨äºåŠ æ³•è¿ç®—</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">f</span> <span class="token punctuation">(</span><span class="token keyword">int</span> sz<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>ar1<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>ar2<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>ar3<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
         <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>sz<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
                  ar3<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>ar1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">+</span>ar2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>icl intel.cpp /QaxSSE2 /Faintel.asm /Ox</code>ä½¿ç”¨win32 intelç¼–è¯‘å™¨</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token comment">; å‡½æ•°å£°æ˜åŠå…¶å‚æ•°</span>
<span class="token comment">; int __cdecl f(int, int *, int *, int *)</span>
public ?f@@YAHHPAH00@Z
?f@@YAHHPAH00@Z proc near

var_10 <span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">10h</span> <span class="token comment">; ä¸´æ—¶å˜é‡ï¼Œç”¨äºå­˜æ”¾ä¸´æ—¶æ•°æ®</span>
sz     <span class="token operator">=</span> dword ptr  <span class="token number">4</span>   <span class="token comment">; å‚æ•°1ï¼Œæ•´æ•° size</span>
ar1    <span class="token operator">=</span> dword ptr  <span class="token number">8</span>   <span class="token comment">; å‚æ•°2ï¼Œæ•´æ•°æŒ‡é’ˆ ar1</span>
ar2    <span class="token operator">=</span> dword ptr  <span class="token number">0Ch</span> <span class="token comment">; å‚æ•°3ï¼Œæ•´æ•°æŒ‡é’ˆ ar2</span>
ar3    <span class="token operator">=</span> dword ptr  <span class="token number">10h</span> <span class="token comment">; å‚æ•°4ï¼Œæ•´æ•°æŒ‡é’ˆ ar3</span>

push    <span class="token register variable">edi</span>             <span class="token comment">; ä¿å­˜å¯„å­˜å™¨ edi çš„çŠ¶æ€</span>
push    <span class="token register variable">esi</span>             <span class="token comment">; ä¿å­˜å¯„å­˜å™¨ esi çš„çŠ¶æ€</span>
push    <span class="token register variable">ebx</span>             <span class="token comment">; ä¿å­˜å¯„å­˜å™¨ ebx çš„çŠ¶æ€</span>
push    <span class="token register variable">esi</span>             <span class="token comment">; å†æ¬¡ä¿å­˜å¯„å­˜å™¨ esi çš„çŠ¶æ€</span>

mov     <span class="token register variable">edx</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>sz<span class="token operator">]</span> <span class="token comment">; å°†å‚æ•° sz èµ‹å€¼ç»™ edx</span>
test    <span class="token register variable">edx</span>, <span class="token register variable">edx</span>           <span class="token comment">; æ£€æŸ¥ sz æ˜¯å¦ä¸ºé›¶æˆ–è´Ÿ</span>
jle     loc_15B            <span class="token comment">; å¦‚æœ sz &lt;= 0ï¼Œè·³è½¬åˆ° loc_15B ç»“æŸå‡½æ•°</span>
mov     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>ar3<span class="token operator">]</span> <span class="token comment">; å°†å‚æ•° ar3 èµ‹å€¼ç»™ eax</span>

cmp     <span class="token register variable">edx</span>, <span class="token number">6</span>             <span class="token comment">; æ£€æŸ¥ sz æ˜¯å¦å°äºç­‰äº 6</span>
jle     loc_143            <span class="token comment">; å¦‚æœæ˜¯ï¼Œè·³è½¬åˆ° loc_143</span>
cmp     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>ar2<span class="token operator">]</span> <span class="token comment">; æ¯”è¾ƒ ar3 å’Œ ar2</span>
jbe     short loc_36       <span class="token comment">; å¦‚æœ ar3 &lt;= ar2ï¼Œè·³è½¬åˆ° loc_36</span>

<span class="token comment">; å¦‚æœ ar3 > ar2 å¹¶ä¸” sz > 6ï¼Œè¿›è¡Œè¿›ä¸€æ­¥çš„è®¡ç®—å’Œæ¡ä»¶åˆ†æ”¯</span>
mov     <span class="token register variable">esi</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>ar2<span class="token operator">]</span> <span class="token comment">; å°† ar2 èµ‹å€¼ç»™ esi</span>
sub     <span class="token register variable">esi</span>, <span class="token register variable">eax</span>           <span class="token comment">; esi = ar2 - ar3</span>
lea     <span class="token register variable">ecx</span>, <span class="token register variable">ds</span>:<span class="token number">0</span><span class="token operator">[</span><span class="token register variable">edx</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>   <span class="token comment">; ecx = sz * 4</span>
neg     <span class="token register variable">esi</span>                <span class="token comment">; esi = -(ar2 - ar3)</span>
cmp     <span class="token register variable">ecx</span>, <span class="token register variable">esi</span>           <span class="token comment">; æ¯”è¾ƒ ecx å’Œ esi</span>
jbe     short loc_55       <span class="token comment">; å¦‚æœ ecx &lt;= esiï¼Œè·³è½¬åˆ° loc_55</span>

<span class="token label function">loc_36:</span>
cmp     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>ar2<span class="token operator">]</span> <span class="token comment">; æ¯”è¾ƒ ar3 å’Œ ar2</span>
jnb     loc_143            <span class="token comment">; å¦‚æœ ar3 >= ar2ï¼Œè·³è½¬åˆ° loc_143</span>
mov     <span class="token register variable">esi</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>ar2<span class="token operator">]</span> <span class="token comment">; å°† ar2 èµ‹å€¼ç»™ esi</span>
sub     <span class="token register variable">esi</span>, <span class="token register variable">eax</span>           <span class="token comment">; esi = ar2 - ar3</span>
lea     <span class="token register variable">ecx</span>, <span class="token register variable">ds</span>:<span class="token number">0</span><span class="token operator">[</span><span class="token register variable">edx</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>   <span class="token comment">; ecx = sz * 4</span>
cmp     <span class="token register variable">esi</span>, <span class="token register variable">ecx</span>           <span class="token comment">; æ¯”è¾ƒ esi å’Œ ecx</span>
jb      loc_143            <span class="token comment">; å¦‚æœ esi &lt; ecxï¼Œè·³è½¬åˆ° loc_143</span>

<span class="token label function">loc_55:</span>
cmp     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>ar1<span class="token operator">]</span> <span class="token comment">; æ¯”è¾ƒ ar3 å’Œ ar1</span>
jbe     short loc_67       <span class="token comment">; å¦‚æœ ar3 &lt;= ar1ï¼Œè·³è½¬åˆ° loc_67</span>
mov     <span class="token register variable">esi</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>ar1<span class="token operator">]</span> <span class="token comment">; å°† ar1 èµ‹å€¼ç»™ esi</span>
sub     <span class="token register variable">esi</span>, <span class="token register variable">eax</span>           <span class="token comment">; esi = ar1 - ar3</span>
neg     <span class="token register variable">esi</span>                <span class="token comment">; esi = -(ar1 - ar3)</span>
cmp     <span class="token register variable">ecx</span>, <span class="token register variable">esi</span>           <span class="token comment">; æ¯”è¾ƒ ecx å’Œ esi</span>
jbe     short loc_7F       <span class="token comment">; å¦‚æœ ecx &lt;= esiï¼Œè·³è½¬åˆ° loc_7F</span>

<span class="token label function">loc_67:</span>
cmp     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>ar1<span class="token operator">]</span> <span class="token comment">; æ¯”è¾ƒ ar3 å’Œ ar1</span>
jnb     loc_143            <span class="token comment">; å¦‚æœ ar3 >= ar1ï¼Œè·³è½¬åˆ° loc_143</span>
mov     <span class="token register variable">esi</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>ar1<span class="token operator">]</span> <span class="token comment">; å°† ar1 èµ‹å€¼ç»™ esi</span>
sub     <span class="token register variable">esi</span>, <span class="token register variable">eax</span>           <span class="token comment">; esi = ar1 - ar3</span>
cmp     <span class="token register variable">esi</span>, <span class="token register variable">ecx</span>           <span class="token comment">; æ¯”è¾ƒ esi å’Œ ecx</span>
jb      loc_143            <span class="token comment">; å¦‚æœ esi &lt; ecxï¼Œè·³è½¬åˆ° loc_143</span>

<span class="token label function">loc_7F:</span>
mov     <span class="token register variable">edi</span>, <span class="token register variable">eax</span>             <span class="token comment">; å°† ar3 èµ‹å€¼ç»™ edi</span>
and     <span class="token register variable">edi</span>, <span class="token number">0Fh</span>             <span class="token comment">; æ£€æŸ¥ ar3 æ˜¯å¦æ˜¯16å­—èŠ‚å¯¹é½</span>
jz      short loc_9A         <span class="token comment">; å¦‚æœå¯¹é½ï¼Œè·³è½¬åˆ° loc_9A</span>
test    <span class="token register variable">edi</span>, <span class="token number">3</span>               <span class="token comment">; æ£€æŸ¥ edi æ˜¯å¦æ˜¯4å­—èŠ‚å¯¹é½</span>
jnz     loc_162              <span class="token comment">; å¦‚æœä¸æ˜¯ï¼Œè·³è½¬åˆ° loc_162</span>
neg     <span class="token register variable">edi</span>                  <span class="token comment">; edi = -edi</span>
add     <span class="token register variable">edi</span>, <span class="token number">10h</span>             <span class="token comment">; edi += 16</span>
shr     <span class="token register variable">edi</span>, <span class="token number">2</span>               <span class="token comment">; edi /= 4</span>

<span class="token label function">loc_9A:</span>
lea     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>         <span class="token comment">; ecx = edi + 4</span>
cmp     <span class="token register variable">edx</span>, <span class="token register variable">ecx</span>             <span class="token comment">; æ¯”è¾ƒ sz å’Œ ecx</span>
jl      loc_162              <span class="token comment">; å¦‚æœ sz &lt; ecxï¼Œè·³è½¬åˆ° loc_162</span>
mov     <span class="token register variable">ecx</span>, <span class="token register variable">edx</span>             <span class="token comment">; ecx = sz</span>
sub     <span class="token register variable">ecx</span>, <span class="token register variable">edi</span>             <span class="token comment">; ecx -= edi</span>
and     <span class="token register variable">ecx</span>, <span class="token number">3</span>               <span class="token comment">; ecx &amp;= 3</span>
neg     <span class="token register variable">ecx</span>                  <span class="token comment">; ecx = -ecx</span>
add     <span class="token register variable">ecx</span>, <span class="token register variable">edx</span>             <span class="token comment">; ecx += sz</span>
test    <span class="token register variable">edi</span>, <span class="token register variable">edi</span>             <span class="token comment">; æ£€æŸ¥ edi æ˜¯å¦ä¸ºé›¶</span>
jbe     short loc_D6         <span class="token comment">; å¦‚æœ edi &lt;= 0ï¼Œè·³è½¬åˆ° loc_D6</span>
mov     <span class="token register variable">ebx</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>ar2<span class="token operator">]</span>   <span class="token comment">; å°† ar2 èµ‹å€¼ç»™ ebx</span>
mov     <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>var_10<span class="token operator">]</span>, <span class="token register variable">ecx</span><span class="token comment">; å°† ecx èµ‹å€¼ç»™ä¸´æ—¶å˜é‡</span>
mov     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>ar1<span class="token operator">]</span>   <span class="token comment">; å°† ar1 èµ‹å€¼ç»™ ecx</span>
xor     <span class="token register variable">esi</span>, <span class="token register variable">esi</span>             <span class="token comment">; æ¸…ç©º esi</span>

<span class="token label function">loc_C1:</span>
mov     <span class="token register variable">edx</span>, <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token register variable">esi</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>     <span class="token comment">; å°† ar1[esi] èµ‹å€¼ç»™ edx</span>
add     <span class="token register variable">edx</span>, <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token register variable">esi</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>     <span class="token comment">; å°† ar2[esi] åŠ åˆ° edx</span>
mov     <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token register variable">esi</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">edx</span>     <span class="token comment">; å°†ç»“æœå­˜åˆ° ar3[esi]</span>
inc     <span class="token register variable">esi</span>                  <span class="token comment">; esi++</span>
cmp     <span class="token register variable">esi</span>, <span class="token register variable">edi</span>             <span class="token comment">; æ¯”è¾ƒ esi å’Œ edi</span>
jb      short loc_C1         <span class="token comment">; å¦‚æœ esi &lt; ediï¼Œè·³è½¬åˆ° loc_C1</span>
mov     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>var_10<span class="token operator">]</span><span class="token comment">; å°†ä¸´æ—¶å˜é‡èµ‹å€¼å› ecx</span>
mov     <span class="token register variable">edx</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>sz<span class="token operator">]</span>    <span class="token comment">; å°† sz èµ‹å€¼ç»™ edx</span>

<span class="token label function">loc_D6:</span>
mov     <span class="token register variable">esi</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>ar2<span class="token operator">]</span>   <span class="token comment">; å°† ar2 èµ‹å€¼ç»™ esi</span>
lea     <span class="token register variable">esi</span>, <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token register variable">edi</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>     <span class="token comment">; esi += edi * 4</span>
test    <span class="token register variable">esi</span>, <span class="token number">0Fh</span>             <span class="token comment">; æ£€æŸ¥ esi æ˜¯å¦16å­—èŠ‚å¯¹é½</span>
jz      short loc_109        <span class="token comment">; å¦‚æœå¯¹é½ï¼Œè·³è½¬åˆ° loc_109</span>
mov     <span class="token register variable">ebx</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>ar1<span class="token operator">]</span>   <span class="token comment">; å°† ar1 èµ‹å€¼ç»™ ebx</span>
mov     <span class="token register variable">esi</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>ar2<span class="token operator">]</span>   <span class="token comment">; å°† ar2 èµ‹å€¼ç»™ esi</span>

<span class="token label function">loc_ED:</span>
movdqu  <span class="token register variable">xmm1</span>, xmmword ptr <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token register variable">edi</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span> <span class="token comment">; å°† ar1[edi] èµ‹å€¼ç»™ xmm1</span>
movdqu  <span class="token register variable">xmm0</span>, xmmword ptr <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token register variable">edi</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span> <span class="token comment">; å°† ar2[edi] èµ‹å€¼ç»™ xmm0</span>
paddd   <span class="token register variable">xmm1</span>, <span class="token register variable">xmm0</span>                   <span class="token comment">; xmm1 += xmm0</span>
movdqa  xmmword ptr <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token register variable">edi</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">xmm1</span> <span class="token comment">; å°†ç»“æœå­˜åˆ° ar3[edi]</span>
add     <span class="token register variable">edi</span>, <span class="token number">4</span>                      <span class="token comment">; edi += 4</span>
cmp     <span class="token register variable">edi</span>, <span class="token register variable">ecx</span>                    <span class="token comment">; æ¯”è¾ƒ edi å’Œ ecx</span>
jb      short loc_ED                <span class="token comment">; å¦‚æœ edi &lt; ecxï¼Œè·³è½¬åˆ° loc_ED</span>
jmp     short loc_127               <span class="token comment">; è·³è½¬åˆ° loc_127</span>

<span class="token label function">loc_109:</span>
mov     <span class="token register variable">ebx</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>ar1<span class="token operator">]</span>          <span class="token comment">; å°† ar1 èµ‹å€¼ç»™ ebx</span>
mov     <span class="token register variable">esi</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>ar2<span class="token operator">]</span>          <span class="token comment">; å°† ar2 èµ‹å€¼ç»™ esi</span>

<span class="token label function">loc_111:</span>
movdqu  <span class="token register variable">xmm0</span>, xmmword ptr <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token register variable">edi</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span> <span class="token comment">; å°† ar1[edi] èµ‹å€¼ç»™ xmm0</span>
paddd   <span class="token register variable">xmm0</span>, xmmword ptr <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token register variable">edi</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span> <span class="token comment">; xmm0 += ar2[edi]</span>
movdqa  xmmword ptr <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token register variable">edi</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">xmm0</span> <span class="token comment">; å°†ç»“æœå­˜åˆ° ar3[edi]</span>
add     <span class="token register variable">edi</span>, <span class="token number">4</span>                      <span class="token comment">; edi += 4</span>
cmp     <span class="token register variable">edi</span>, <span class="token register variable">ecx</span>                    <span class="token comment">; æ¯”è¾ƒ edi å’Œ ecx</span>
jb      short loc_111               <span class="token comment">; å¦‚æœ edi &lt; ecxï¼Œè·³è½¬åˆ° loc_111</span>

<span class="token label function">loc_127:</span>
cmp     <span class="token register variable">ecx</span>, <span class="token register variable">edx</span>                    <span class="token comment">; æ¯”è¾ƒ ecx å’Œ edx</span>
jnb     short loc_15B               <span class="token comment">; å¦‚æœ ecx >= edxï¼Œè·³è½¬åˆ° loc_15B</span>
mov     <span class="token register variable">esi</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>ar1<span class="token operator">]</span>          <span class="token comment">; å°† ar1 èµ‹å€¼ç»™ esi</span>
mov     <span class="token register variable">edi</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>ar2<span class="token operator">]</span>          <span class="token comment">; å°† ar2 èµ‹å€¼ç»™ edi</span>

<span class="token label function">loc_133:</span>
mov     <span class="token register variable">ebx</span>, <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token register variable">ecx</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>            <span class="token comment">; å°† ar1[ecx] èµ‹å€¼ç»™ ebx</span>
add     <span class="token register variable">ebx</span>, <span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">+</span><span class="token register variable">ecx</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>            <span class="token comment">; å°† ar2[ecx] åŠ åˆ° ebx</span>
mov     <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token register variable">ecx</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">ebx</span>            <span class="token comment">; å°†ç»“æœå­˜åˆ° ar3[ecx]</span>
inc     <span class="token register variable">ecx</span>                         <span class="token comment">; ecx++</span>
cmp     <span class="token register variable">ecx</span>, <span class="token register variable">edx</span>                    <span class="token comment">; æ¯”è¾ƒ ecx å’Œ edx</span>
jb      short loc_133               <span class="token comment">; å¦‚æœ ecx &lt; edxï¼Œè·³è½¬åˆ° loc_133</span>
jmp     short loc_15B               <span class="token comment">; è·³è½¬åˆ° loc_15B</span>

<span class="token label function">loc_143:</span>
mov     <span class="token register variable">esi</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>ar1<span class="token operator">]</span>          <span class="token comment">; å°† ar1 èµ‹å€¼ç»™ esi</span>
mov     <span class="token register variable">edi</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">+</span>ar2<span class="token operator">]</span>          <span class="token comment">; å°† ar2 èµ‹å€¼ç»™ edi</span>
xor     <span class="token register variable">ecx</span>, <span class="token register variable">ecx</span>                    <span class="token comment">; æ¸…ç©º ecx</span>

<span class="token label function">loc_14D:</span>
mov     <span class="token register variable">ebx</span>, <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token register variable">ecx</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>            <span class="token comment">; å°† ar1[ecx] èµ‹å€¼ç»™ ebx</span>
add     <span class="token register variable">ebx</span>, <span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">+</span><span class="token register variable">ecx</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>            <span class="token comment">; å°† ar2[ecx] åŠ åˆ° ebx</span>
mov     <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token register variable">ecx</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">ebx</span>            <span class="token comment">; å°†ç»“æœå­˜åˆ° ar3[ecx]</span>
inc     <span class="token register variable">ecx</span>                         <span class="token comment">; ecx++</span>
cmp     <span class="token register variable">ecx</span>, <span class="token register variable">edx</span>                    <span class="token comment">; æ¯”è¾ƒ ecx å’Œ edx</span>
jb      short loc_14D               <span class="token comment">; å¦‚æœ ecx &lt; edxï¼Œè·³è½¬åˆ° loc_14D</span>

<span class="token label function">loc_15B:</span>
xor     <span class="token register variable">eax</span>, <span class="token register variable">eax</span>                    <span class="token comment">; eax = 0ï¼Œè¿”å›0</span>
pop     <span class="token register variable">ecx</span>                         <span class="token comment">; æ¢å¤å¯„å­˜å™¨ ecx</span>
pop     <span class="token register variable">ebx</span>                         <span class="token comment">; æ¢å¤å¯„å­˜å™¨ ebx</span>
pop     <span class="token register variable">esi</span>                         <span class="token comment">; æ¢å¤å¯„å­˜å™¨ esi</span>
pop     <span class="token register variable">edi</span>                         <span class="token comment">; æ¢å¤å¯„å­˜å™¨ edi</span>
retn                                <span class="token comment">; è¿”å›</span>

<span class="token label function">loc_162:</span>
xor     <span class="token register variable">ecx</span>, <span class="token register variable">ecx</span>                    <span class="token comment">; ecx = 0</span>
jmp     short loc_127               <span class="token comment">; è·³è½¬åˆ° loc_127</span>
?f@@YAHHPAH00@Z endp
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><code>MOVDQUï¼ˆMove Unaligned Double Quadwordï¼‰</code>ä»å†…å­˜åŠ è½½16å­—èŠ‚æ•°æ®ï¼Œå¹¶å¤åˆ¶åˆ°XMMå¯„å­˜å™¨çš„æŒ‡ä»¤</li>
<li><code>PADDDï¼ˆAdd Packed Integersï¼‰</code>æ˜¯å¯¹4å¯¹32ä½æ•°è¿›è¡ŒåŠ æ³•è¿ç®—ï¼Œå¹¶æŠŠè¿ç®—ç»“æœå­˜å‚¨åˆ°ç¬¬ä¸€ä¸ªæ“ä½œç¬¦çš„æŒ‡ä»¤ã€‚æ­¤å¤–ï¼Œè¯¥æŒ‡ä»¤ä¸ä¼šè®¾ç½®ä»»ä½•æ ‡å¿—ä½ï¼Œåœ¨æº¢å‡ºæ—¶åªä¿ç•™è¿ç®—ç»“æœçš„ä½32ä½ï¼Œä¹Ÿä¸ä¼šæŠ¥é”™ã€‚å¦‚æœPADDDçš„æŸä¸ªæ“ä½œæ•°æ˜¯å†…å­˜ä¸­çš„æŸä¸ªå€¼ï¼Œé‚£ä¹ˆè¿™ä¸ªå€¼çš„åœ°å€å¿…é¡»ä¸16å­—èŠ‚è¾¹ç•Œå¯¹é½ï¼Œå¦åˆ™å°†æŠ¥é”™</li>
<li><code>MOVDQAï¼ˆMove Aligned Double Quadwordï¼‰</code>çš„åŠŸèƒ½MOVDQUç›¸åŒï¼Œåªæ˜¯è¦æ±‚å­˜å‚¨æ“ä½œæ•°çš„å†…å­˜åœ°å€å¿…é¡»å‘16å­—èŠ‚è¾¹ç•Œå¯¹é½ï¼Œå¦åˆ™æŠ¥é”™ã€‚é™¤äº†è¿™ç‚¹åŒºåˆ«ä¹‹å¤–ï¼Œä¸¤ä¸ªæŒ‡ä»¤å®Œå…¨ç›¸åŒã€‚æ­¤å¤–ï¼ŒMOVDQAçš„è¿è¡Œé€Ÿåº¦è¦æ¯”MOVDQUå¿«ã€‚</li>
</ul>
<hr />
<ul>
<li>
<p>ç”¨äºå†…å­˜å¤åˆ¶</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">void</span> <span class="token function">my_memcpy</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> dst<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> src<span class="token punctuation">,</span> <span class="token class-name">size_t</span> cnt<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
     <span class="token class-name">size_t</span> i<span class="token punctuation">;</span>
     <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>cnt<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
          dst<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>src<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç”Ÿæˆçš„ä»£ç å±å®æ™¦æ¶©éš¾æ‡‚ï¼Œçœ‹ä¸æ‡‚</p>
</li>
</ul>
<h4 id="simdå®ç°strlen"><a class="markdownIt-Anchor" href="#simdå®ç°strlen"></a> SIMDå®ç°strlen()</h4>
<p>åœ¨C/C++æºç¨‹åºä¸­æ’å…¥ç‰¹å®šçš„å®å³å¯è°ƒç”¨SIMDæŒ‡ä»¤ã€‚åœ¨MSVCç¼–è¯‘å™¨çš„åº“æ–‡ä»¶ä¹‹ä¸­ï¼Œintrin.hæ–‡ä»¶å°±ä½¿ç”¨äº†è¿™ç§å®ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥æŠŠå­—ç¬¦ä¸²è¿›è¡Œåˆ†ç»„å¤„ç†ï¼Œä½¿ç”¨SIMDæŒ‡ä»¤å®ç°strlen()å‡½æ•°ã€‚è¿™ç§ç®—æ³•æ¯”å¸¸è§„å®ç°ç®—æ³•å¿«2ï½2.5å€ã€‚å®ƒæ¯æ¬¡æŠŠ16ä¸ªå­—ç¬¦åŠ è½½åˆ°1ä¸ªXMMå¯„å­˜å™¨é‡Œï¼Œç„¶åæ£€æµ‹å­—ç¬¦ä¸²çš„ç»“æŸæ ‡å¿—â€”æ•°å€¼ä¸ºé›¶çš„ç»“æŸç¬¦</p>
<h3 id="chap26-64ä½å¹³å°"><a class="markdownIt-Anchor" href="#chap26-64ä½å¹³å°"></a> Chap26 64ä½å¹³å°</h3>
<p>x86-64æ¡†æ¶æ˜¯ä¸€ç§å…¼å®¹x86æŒ‡ä»¤é›†çš„64ä½å¾®å¤„ç†å™¨æ¶æ„ã€‚</p>
<p>ä»é€†å‘å·¥ç¨‹çš„è§’åº¦æ¥è¯´ï¼Œè¿™ç§æ¡†æ¶çš„ä¸»è¦åŒºåˆ«åœ¨äºï¼š</p>
<ul>
<li>
<p>é™¤äº†ä½äºFPUå’ŒSIMDçš„å¯„å­˜å™¨ä¹‹å¤–ï¼Œå‡ ä¹æ‰€æœ‰çš„å¯„å­˜å™¨éƒ½å˜ä¸º64ä½å¯„å­˜å™¨ã€‚æ‰€æœ‰æŒ‡ä»¤éƒ½å¯ä»¥é€šè¿‡R-å­—å¤´çš„åŠ©è®°ç¬¦ï¼ˆå¯„å­˜å™¨åç§°ï¼‰è°ƒç”¨64ä½å¯„å­˜å™¨ã€‚è€Œä¸”x86-64æ¡†æ¶çš„CPUè¦æ¯”x86æ¡†æ¶çš„CPUå¤šå‡º8ä¸ªé€šç”¨å¯„å­˜å™¨ã€‚è¿™äº›é€šç”¨å¯„å­˜å™¨åˆ†åˆ«æ˜¯ï¼šRAXã€RBXã€RCXã€RDXã€RBPã€RSPã€RSIã€RDIã€R8ã€R9ã€R10ã€R11ã€R12ã€R13ã€R14ã€R15ã€‚</p>
</li>
<li>
<p>å®ƒå‘ä¸‹å…¼å®¹ï¼Œå…è®¸ç¨‹åºä½¿ç”¨GPRçš„32ä½å¯„å­˜å™¨çš„åŠ©è®°ç¬¦ã€æ“ä½œè¯¥å¯„å­˜å™¨çš„ä½32ä½æ•°æ®ã€‚ä¾‹å¦‚è¯´ï¼Œç¨‹åºå¯ä»¥é€šè¿‡åŠ©è®°ç¬¦EAXè®¿é—®RAXå¯„å­˜å™¨çš„ä½32ä½ã€‚</p>
<img src="/2024/05/23/re4b%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image-20240610144056548.png" class="" alt="image-20240610144056548" loading="lazy">
</li>
<li>
<p>64ä½å¯„å­˜å™¨ç‰¹æœ‰çš„R8ï½R15å¯„å­˜å™¨ä¸ä»…æœ‰ç›¸åº”çš„ï¼ˆä½ï¼‰32ä½åŠ©è®°ç¬¦ï¼Œå³R8Dï½R15Dï¼ˆä½32ä½ï¼‰ï¼Œè€Œä¸”è¿˜æœ‰ç›¸åº”çš„ï¼ˆä½ï¼‰16ä½åŠ©è®°ç¬¦R8Wï½R15Wã€‚</p>
<img src="/2024/05/23/re4b%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image-20240610144124263.png" class="" alt="image-20240610144124263" loading="lazy">
</li>
<li>
<p>x86-64æ¡†æ¶çš„CPUæœ‰16ä¸ªSIMDå¯„å­˜å™¨ï¼Œå³XMM0ï½XMM15ã€‚å®ƒçš„SIMDå¯„å­˜å™¨æ¯”x86 CPUå¤šå‡ºä¸€å€ã€‚</p>
</li>
</ul>
<h3 id="chap27-simdä¸æµ®ç‚¹æ•°çš„å¹¶è¡Œè¿ç®—"><a class="markdownIt-Anchor" href="#chap27-simdä¸æµ®ç‚¹æ•°çš„å¹¶è¡Œè¿ç®—"></a> *Chap27 SIMDä¸æµ®ç‚¹æ•°çš„å¹¶è¡Œè¿ç®—</h3>
<h3 id="chap28-armæŒ‡ä»¤è¯¦è§£"><a class="markdownIt-Anchor" href="#chap28-armæŒ‡ä»¤è¯¦è§£"></a> *Chap28 ARMæŒ‡ä»¤è¯¦è§£</h3>
<h3 id="chap29-mipsçš„ç‰¹ç‚¹"><a class="markdownIt-Anchor" href="#chap29-mipsçš„ç‰¹ç‚¹"></a> *Chap29 MIPSçš„ç‰¹ç‚¹</h3>
<h2 id="part3-ç¡¬ä»¶åŸºç¡€"><a class="markdownIt-Anchor" href="#part3-ç¡¬ä»¶åŸºç¡€"></a> Part.3 ç¡¬ä»¶åŸºç¡€</h2>
<h3 id="chap30-æœ‰ç¬¦å·æ•°çš„è¡¨ç¤ºæ–¹æ³•"><a class="markdownIt-Anchor" href="#chap30-æœ‰ç¬¦å·æ•°çš„è¡¨ç¤ºæ–¹æ³•"></a> Chap30 æœ‰ç¬¦å·æ•°çš„è¡¨ç¤ºæ–¹æ³•</h3>
<ul>
<li>
<p>æœ‰ç¬¦å·æ•°é€šå¸¸ä»¥äºŒè¿›åˆ¶è¡¥ç [<a href="#anchor301">1]</a>çš„å½¢å¼å­˜å‚¨äºåº”ç”¨ç¨‹åºé‡Œã€‚</p>
</li>
<li>
<p>ä¸ºäº†æ­£ç¡®æ“ä½œæœ‰ç¬¦å·æ•°å’Œæ— ç¬¦å·æ•°ï¼Œæ¡ä»¶è½¬ç§»æŒ‡ä»¤ï¼ˆå‚è§æœ¬ä¹¦ç¬¬12ç« ï¼‰ç‰¹åœ°åˆ†ä¸ºJG/JLç³»åˆ—ï¼ˆsignedå‹ï¼‰å’ŒJA/JBEç³»åˆ—ï¼ˆunsignedå‹ï¼‰ä¸¤å¥—æŒ‡ä»¤</p>
</li>
<li>
<p>åŒä¸€ä¸ªæ•°å€¼å³å¯ä»¥è¡¨ç¤ºæœ‰ç¬¦å·æ•°ï¼Œä¹Ÿå¯ä»¥è¡¨ç¤ºæ— ç¬¦å·æ•°ã€‚</p>
</li>
<li>
<p>C/C++çš„æœ‰ç¬¦å·å‹æ•°æ®æœ‰ï¼š</p>
<ul>
<li>int64_tï¼ˆä»âˆ’9223372036854775806è‡³9223372036854775807ï¼‰ï¼Œå³ä»0x8000000000000000è‡³0x7FFFFFFFFFFFFFFFï¼‰</li>
<li>intï¼ˆå–å€¼èŒƒå›´ä»âˆ’2147483646è‡³2147483647ï¼Œå³0x80000000è‡³0x7FFFFFFFï¼‰ã€‚</li>
<li>charï¼ˆå–å€¼èŒƒå›´ä»âˆ’127è‡³128ï¼Œå³ä»0x7Fè‡³0x80ï¼‰ã€‚</li>
<li>ssize_tã€‚</li>
</ul>
<p>æ— ç¬¦å·å‹æ•°æ®æœ‰ï¼š</p>
<ul>
<li>uint64_tï¼ˆä»0è‡³18446744073709551615/0xFFFFFFFFFFFFFFFFï¼‰ï¼š</li>
<li>unsigned intï¼ˆå–å€¼èŒƒå›´ä»0è‡³4294967295ï¼Œå³ä»0è‡³0xFFFFFFFFï¼‰ã€‚</li>
<li>unsigned charï¼ˆå–å€¼èŒƒå›´ä»0è‡³255ï¼Œå³ä»0è‡³0xFFï¼‰ã€‚</li>
<li>size_tã€‚</li>
</ul>
</li>
<li>
<p>æœ‰ç¬¦å·æ•°çš„æœ€é«˜æ•°æƒä½æ˜¯ç¬¦å·ä½ï¼š1ä»£è¡¨è´Ÿæ•°ï¼Œ0ä»£è¡¨æ­£æ•°ã€‚</p>
</li>
<li>
<p>ä»æ•°æ®å®½åº¦è¾ƒå°çš„æ•°æ®è½¬æ¢ä¸ºæ•°æ®å®½åº¦è¾ƒå¤§çš„æ•°æ®æ˜¯å¯è¡Œçš„ã€‚</p>
</li>
<li>
<p>è´Ÿæ•°çš„è¡¥ç å’ŒåŸç çš„åŒå‘è½¬æ¢è¿‡ç¨‹æ˜¯ç›¸åŒçš„ï¼Œéƒ½æ˜¯é€ä½æ±‚éå†åŠ 1ã€‚è¿™ç§è¿ç®—è¿‡ç¨‹ç®€å•æ˜“è®°ï¼šåŒä¸€ä¸ªå€¼çš„æ­£è´Ÿæ•°æ˜¯ç›¸åçš„å€¼ï¼Œæ‰€ä»¥è¦æ±‚éï¼›æ±‚éä¹‹åå†åŠ 1åˆ™æ˜¯å› ä¸ºä¸­é—´çš„â€œé›¶â€å äº†ä¸€ä¸ªæ•°çš„ä½ç½®ã€‚</p>
</li>
<li>
<p>åŠ å‡è¿ç®—ä¸åŒºåˆ†æœ‰ç¬¦å·æ•°å’Œæ— ç¬¦å·æ•°ï¼Œå®ƒä»¬çš„åŠ å‡è¿ç®—æŒ‡ä»¤å®Œå…¨ç›¸åŒã€‚ä½†æ˜¯ä¹˜é™¤æ³•è¿ç®—è¿˜æ˜¯æœ‰åŒºåˆ«çš„ï¼šåœ¨x86æŒ‡ä»¤é›†é‡Œï¼Œæœ‰ç¬¦å·æ•°çš„ä¹˜é™¤æŒ‡ä»¤æ˜¯IMUL/IDIVï¼Œè€Œæ— ç¬¦å·æ•°çš„æŒ‡ä»¤æ˜¯MUL/DIVã€‚</p>
</li>
<li>
<p>æ­¤å¤–ï¼Œæœ‰ç¬¦å·æ•°çš„æ“ä½œæŒ‡ä»¤æ›´å¤šä¸€äº›ã€‚ä¾‹å¦‚CBW/CWD/CWDE/CDQ/CDQEï¼ˆé™„å½•A.6.3ï¼‰ã€MOVSXï¼ˆ15.1.1èŠ‚ï¼‰ï¼ŒSARï¼ˆé™„å½•A.6.3ï¼‰ã€‚</p>
</li>
</ul>
<h3 id="chap31-å­—èŠ‚åº"><a class="markdownIt-Anchor" href="#chap31-å­—èŠ‚åº"></a> Chap31 å­—èŠ‚åº</h3>
<ul>
<li>å°ç«¯å­—èŠ‚åº(Little-Endian)æŒ‡ä½æ•°æƒå­—èŠ‚æ•°æ®å­˜æ”¾åœ¨å†…å­˜ä½åœ°å€ï¼Œé«˜æ•°æƒå­—èŠ‚æ•°æ®å­˜æ”¾åœ¨é«˜åœ°å€</li>
<li>å¤§ç«¯å­—èŠ‚åº(Big-Endian)æŒ‡é«˜æ•°æƒå­—èŠ‚æ•°æ®å­˜æ”¾åœ¨ä½åœ°å€ï¼Œä½å­—èŠ‚æ•°æ®å­˜æ”¾åœ¨é«˜åœ°å€å¤„çš„å†…å­˜åˆ†å¸ƒæ–¹å¼</li>
</ul>
<hr />
<h4 id="å¤§ç«¯å­—èŠ‚åº"><a class="markdownIt-Anchor" href="#å¤§ç«¯å­—èŠ‚åº"></a> å¤§ç«¯å­—èŠ‚åº</h4>
<p>åœ¨é‡‡ç”¨å¤§ç«¯å­—èŠ‚åºæ—¶ï¼Œ0x12345678åœ¨å†…å­˜ä¸­çš„å­˜å‚¨æ–¹å¼å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<table>
<thead>
<tr>
<th>å†…å­˜åœ°å€</th>
<th>å­—èŠ‚å€¼</th>
</tr>
</thead>
<tbody>
<tr>
<td>+0</td>
<td>0x12</td>
</tr>
<tr>
<td>+1</td>
<td>0x34</td>
</tr>
<tr>
<td>+2</td>
<td>0x56</td>
</tr>
<tr>
<td>+3</td>
<td>0x78</td>
</tr>
</tbody>
</table>
<p>Motorola 68kã€IBM POWERç³»åˆ—CPUé‡‡ç”¨å¤§ç«¯å­—èŠ‚åºã€‚</p>
<h4 id="å°ç«¯å­—èŠ‚åº"><a class="markdownIt-Anchor" href="#å°ç«¯å­—èŠ‚åº"></a> å°ç«¯å­—èŠ‚åº</h4>
<p>åœ¨é‡‡ç”¨å°ç«¯å­—èŠ‚åºæ—¶ï¼Œ0x12345678åœ¨å†…å­˜ä¸­çš„å­˜å‚¨æ–¹å¼å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<table>
<thead>
<tr>
<th>å†…å­˜åœ°å€</th>
<th>å­—èŠ‚å€¼</th>
</tr>
</thead>
<tbody>
<tr>
<td>+0</td>
<td>0x78</td>
</tr>
<tr>
<td>+1</td>
<td>0x56</td>
</tr>
<tr>
<td>+2</td>
<td>0x34</td>
</tr>
<tr>
<td>+3</td>
<td>0x12</td>
</tr>
</tbody>
</table>
<p>Intel x86ç³»åˆ—CPUé‡‡ç”¨å°ç«¯å­—èŠ‚åºã€‚</p>
<p><em>æ­£æ˜¯å› ä¸ºMIPSçš„ç¡¬ä»¶å¹³å°å¯èƒ½é‡‡ç”¨ä¸¤ç§ä¸åŒçš„å­—èŠ‚åºï¼Œæ‰€ä»¥MIPS Linuxåˆåˆ†ä¸ºé‡‡ç”¨å¤§ç«¯å­—èŠ‚åºçš„MIPS Linuxå’Œé‡‡ç”¨å°ç«¯å­—èŠ‚åºçš„mipsel Linuxã€‚åœ¨é‡‡å–ä¸€ç§å­—èŠ‚åºçš„å¹³å°ä¸Šç¼–è¯‘å‡ºæ¥çš„ç¨‹åºï¼Œä¸å¯èƒ½åœ¨å¦ä¸€ç§å­—èŠ‚åºçš„å¹³å°ä¸Šè¿è¡Œã€‚</em></p>
<hr />
<h4 id="åŒæ¨¡äºŒå…ƒæ•°æ®æ ¼å¼"><a class="markdownIt-Anchor" href="#åŒæ¨¡äºŒå…ƒæ•°æ®æ ¼å¼"></a> åŒæ¨¡äºŒå…ƒæ•°æ®æ ¼å¼</h4>
<p><em>ARMã€PowerPCã€SPARCã€MIPSã€IA64ç­‰CPUé‡‡ç”¨åŒæ¨¡äºŒå…ƒæ•°æ®æ ¼å¼ï¼ˆBi-endianï¼‰ï¼Œå®ƒä»¬å³å¯ä»¥å·¥ä½œäºå°ç«¯å­—èŠ‚åºä¹Ÿå¯ä»¥åˆ‡æ¢åˆ°å¤§ç«¯å­—èŠ‚åºã€‚</em></p>
<h4 id="è½¬æ¢å­—èŠ‚åº"><a class="markdownIt-Anchor" href="#è½¬æ¢å­—èŠ‚åº"></a> è½¬æ¢å­—èŠ‚åº</h4>
<p><em>BSWAPæŒ‡ä»¤å¯åœ¨æ±‡ç¼–å±‚é¢è½¬æ¢æ•°æ®çš„å­—èŠ‚åº</em></p>
<p><code>TCP/IP</code>æ•°æ®åºçš„å°è£…è§„èŒƒé‡‡ç”¨å¤§ç«¯å­—èŠ‚åºï¼Œæ‰€ä»¥é‡‡ç”¨å°ç«¯å­—èŠ‚åºå¹³å°çš„ç³»ç»Ÿå°±éœ€è¦ä½¿ç”¨ä¸“é—¨çš„è½¬æ¢å­—èŠ‚åºçš„å‡½æ•°</p>
<p>å¸¸ç”¨çš„å­—èŠ‚åºè½¬æ¢å‡½æ•°æ˜¯<code>htonl()</code>å’Œ<code>htons()</code>ã€‚<code>htonl()</code>ï¼ˆhost-to-network longï¼‰å’Œ<code>htons()</code>ï¼ˆhost-to-network shortï¼‰(æŠŠä¸»æœºå­—èŠ‚é¡ºåºè½¬ä¸ºç½‘ç»œå­—èŠ‚é¡ºåº)</p>
<p><em>åœ¨TCP/IPçš„æœ¯è¯­é‡Œï¼Œ<code>å¤§ç«¯å­—èŠ‚åº</code>åˆç§°ä¸ºâ€œ<code>ç½‘ç»œå­—èŠ‚é¡ºåºï¼ˆNetwork Byte Orderï¼‰</code>â€ï¼Œç½‘ç»œä¸»æœºé‡‡ç”¨çš„å­—èŠ‚åºå«ä½œâ€œä¸»æœºå­—èŠ‚é¡ºåºâ€ã€‚x86å’Œå…¶ä»–ä¸€äº›å¹³å°çš„ä¸»æœºå­—èŠ‚åºæ˜¯å°ç«¯å­—èŠ‚åºï¼Œä½†æ˜¯IBM POWERç­‰è‘—åæœåŠ¡å™¨ç³»åˆ—å‡é‡‡ç”¨å¤§ç«¯å­—èŠ‚åºã€‚å› æ­¤<code>ï¼Œåœ¨ä¸»æœºå­—èŠ‚é¡ºåºä¸ºå¤§ç«¯å­—èŠ‚åºçš„å¹³å°ä¸Šä½¿ç”¨htonl()æˆ–htons()å‡½æ•°è½¬æ¢å­—èŠ‚åºï¼Œå…¶å®ä¸ä¼šè¿›è¡ŒçœŸæ­£æ„ä¹‰ä¸Šçš„å­—èŠ‚é‡æ’</code>ã€‚</em></p>
<h3 id="chap32-å†…å­˜å¸ƒå±€"><a class="markdownIt-Anchor" href="#chap32-å†…å­˜å¸ƒå±€"></a> Chap32 å†…å­˜å¸ƒå±€</h3>
<p>C/C++æŠŠå†…å­˜åˆ’åˆ†ä¸ºè®¸å¤šåŒºåŸŸï¼Œä¸»è¦çš„å†…å­˜åŒºåŸŸæœ‰:</p>
<ul>
<li>å…¨å±€å†…å­˜ç©ºé—´ï¼Œåˆç§°ä¸ºâ€œ<code>ï¼ˆå…¨å±€ï¼‰é™æ€å­˜å‚¨åŒº</code>static memory allocationâ€ç¼–ç¨‹äººå‘˜ä¸éœ€è¦ä¸ºå…¨å±€å˜é‡å’Œé™æ€å˜é‡æ˜ç¡®åˆ’åˆ†<code>å­˜å‚¨ç©ºé—´å‡¡æ˜¯ç”±æºç¨‹åºå£°æ˜çš„å…¨å±€å˜é‡ã€å…¨å±€æ•°ç»„ï¼Œç¼–è¯‘å™¨éƒ½èƒ½å¤Ÿåœ¨æ•°æ®æ®µæˆ–å¸¸é‡æ®µä¸ºå…¶åˆ†é…é€‚å½“çš„å­˜å‚¨ç©ºé—´</code>ã€‚ç”±äºæ•´ä¸ªç¨‹åºéƒ½å¯ä»¥è®¿é—®è¿™ä¸ªåŒºåŸŸçš„æ•°æ®ï¼Œæ‰€ä»¥äººä»¬è®¤ä¸ºä½¿ç”¨è¿™ç§å­˜å‚¨ç©ºé—´æ•°æ®ä¼šç ´åç¨‹åºçš„ç»“æ„åŒ–ä½“ç³»ã€‚æ­¤å¤–ï¼Œåœ¨å…¨å±€å†…å­˜åŒºå­˜å‚¨æ•°æ®ä¹‹å‰ï¼Œå¿…é¡»äº‹å…ˆå£°æ˜å…¶ç¡®åˆ‡çš„å®¹é‡ã€‚å› è€Œè¿™ä¸ªç©ºé—´ä¸é€‚ç”¨äºå­˜å‚¨ç¼“å­˜æˆ–åŠ¨æ€æ•°ç»„ã€‚åœ¨å…¨å±€å†…å­˜ç©ºé—´å‡ºç°çš„ç¼“å†²åŒºæº¢å‡ºé—®é¢˜ï¼Œå¾€å¾€å°†è¦†ç›–åœ¨å†…å­˜ä¸­ç›¸é‚»ä½ç½®çš„å˜é‡æˆ–ç¼“å­˜ï¼ˆè¯·å‚é˜…æœ¬ä¹¦7.2èŠ‚çš„æ¡ˆä¾‹ï¼‰ã€‚</li>
<li><code>æ ˆç©ºé—´ï¼Œå³åˆ†é…ç»™æ ˆçš„å­˜å‚¨åŒºåŸŸã€‚å®ƒæ˜¯ç”±ç¼–è¯‘å™¨è‡ªåŠ¨åˆ†é…ã€é‡Šæ”¾çš„å­˜å‚¨åŒºåŸŸï¼Œå¸¸ç”¨äºå­˜æ”¾å‡½æ•°çš„å‚æ•°å’Œå±€éƒ¨å˜é‡ã€‚</code>åœ¨ç‰¹å®šæƒ…å†µä¸‹ï¼Œå±€éƒ¨å˜é‡å¯è¢«å…¶ä»–å‡½æ•°è®¿é—®ï¼ˆå±€éƒ¨å˜é‡çš„æŒ‡é’ˆä½œä¸ºå‚æ•°ä¼ é€’ç»™è¢«è°ƒç”¨æ–¹å‡½æ•°ï¼‰ã€‚åœ¨æŒ‡ä»¤å±‚é¢ï¼Œâ€œåˆ†é…å’Œé‡Šæ”¾æ ˆç©ºé—´çš„<code>å®è´¨å°±æ˜¯è°ƒæ•´SPå¯„å­˜å™¨çš„å€¼</code>ï¼Œå› è€Œ<code>åˆ†é…å’Œé‡Šæ”¾æ ˆç©ºé—´çš„æ“ä½œé€Ÿåº¦éå¸¸å¿«</code>ã€‚ç¼–è¯‘å™¨åªèƒ½ä¸ºé‚£äº›åœ¨ç¼–è¯‘é˜¶æ®µç¡®å®šå­˜å‚¨ç©ºé—´çš„å±€éƒ¨å˜é‡åˆ†é…æ ˆç©ºé—´ã€‚å› æ­¤ï¼Œæ— æ³•äº‹å…ˆé¢„åˆ¤å­˜å‚¨ç©ºé—´çš„ç¼“å†²å‹æ•°æ®ç±»å‹ï¼Œå³ç¼“å†²åŒºå’ŒåŠ¨æ€æ•°ç»„(é™¤éä½¿ç”¨<code>alloc()</code>å‡½æ•°)ä¸ä¼šè¢«åˆ†é…åˆ°æ ˆç©ºé—´é‡Œã€‚åœ¨æ ˆç©ºé—´å‘ç”Ÿçš„ç¼“å†²åŒºæº¢å‡ºé—®é¢˜ï¼Œé€šå¸¸ä¼šç¯¡æ”¹æ ˆé‡Œçš„é‡è¦æ•°æ®</li>
<li><code>å †ç©ºé—´ï¼Œå³â€œåŠ¨æ€å†…å­˜åˆ†é…åŒºã€‚Cè¯­è¨€çš„malloc()/free()å‡½æ•°æˆ–C++çš„new/deleteè¯­å¥å³å¯åˆ†é…ã€é‡Šæ”¾å †ç©ºé—´ï¼‰</code>ã€‚â€œä¸å¿…äº‹å…ˆå£°æ˜å †ç©ºé—´çš„å¤§å°â€å³â€œå¯åœ¨ç¨‹åºå¯åŠ¨ä»¥åå†ç¡®å®šæ•°æ®å—çš„å®¹é‡â€è¿™ä¸€ç‰¹å¾æ„æˆäº†å…¶ç‹¬ç‰¹çš„ä¾¿åˆ©æ€§ã€‚å¦å¤–ï¼Œç¨‹åºå‘˜è¿˜å¯ä»¥åŠ¨æ€è°ƒæ•´ï¼ˆrealloc()å‡½æ•°ï¼‰å†…å­˜å—çš„å¤§å°ï¼Œåªæ˜¯è°ƒæ•´å †ç©ºé—´çš„æ“ä½œé€Ÿåº¦ä¸å¾ˆç†æƒ³ã€‚<code>åœ¨å†…å­˜åˆ†é…æ“ä½œä¸­ï¼Œç”³è¯·ã€é‡Šæ”¾å †ç©ºé—´çš„æ“ä½œæ˜¯é€Ÿåº¦æœ€æ…¢çš„æ“ä½œ</code>ï¼š<code>åœ¨åˆ†é…ã€é‡Šæ”¾å †ç©ºé—´æ—¶ï¼Œè¿›è¡Œè¿™ç§æ“ä½œçš„ç¨‹åºå¿…é¡»æ”¯æŒå¹¶ä¸”æ›´æ–°æ‰€æœ‰æ§åˆ¶ç»“æ„</code>ã€‚<code>åœ¨è¿™ä¸ªåŒºåŸŸå‘ç”Ÿçš„ç¼“å†²åŒºæº¢å‡ºç»å¸¸ä¼šè¦†ç›–å †ç©ºé—´çš„æ•°æ®ç»“æ„ä½“ã€‚å †ç©ºé—´ç®¡ç†ä¸å½“è¿˜ä¼šå‘ç”Ÿå†…å­˜æ³„éœ²é—®é¢˜ï¼šæ‰€æœ‰è¢«åˆ†é…çš„å †ç©ºé—´éƒ½åº”å½“è¢«æ˜ç¡®åœ°é‡Šæ”¾ï¼Œå¦åˆ™å°±ä¼šå‡ºç°å†…å­˜æ³„éœ²é—®é¢˜ã€‚ä½†æ˜¯ç¨‹åºå‘˜å¯èƒ½ä¼šå‡ºç°â€œå¿˜è®°é‡Šæ”¾å †ç©ºé—´â€çš„é—®é¢˜ï¼Œè¿˜æœ‰å‘ç”Ÿé‡Šæ”¾ä¸å½»åº•çš„é—®é¢˜</code>ã€‚å¦å¤–ï¼Œâ€œ<code>åœ¨è°ƒç”¨free()å‡½æ•°é‡Šæ”¾ç©ºé—´ä¹‹åå†æ¬¡ç›´æ¥ä½¿ç”¨è¿™å—å†…å­˜åŒºåŸŸâ€çš„æŒ‡ä»¤åŒæ ·ä¼šå¸¦æ¥éå¸¸ä¸¥é‡çš„å®‰å…¨é—®é¢˜</code>ï¼ˆè¯·å‚é˜…æœ¬ä¹¦21.2èŠ‚çš„æ¡ˆä¾‹ï¼‰ã€‚</li>
</ul>
<h3 id="chap33-cpu"><a class="markdownIt-Anchor" href="#chap33-cpu"></a> Chap33 CPU</h3>
<h4 id="åˆ†æ”¯é¢„æµ‹"><a class="markdownIt-Anchor" href="#åˆ†æ”¯é¢„æµ‹"></a> åˆ†æ”¯é¢„æµ‹</h4>
<p><em>ç°åœ¨çš„ä¸»æµç¼–è¯‘å™¨åŸºæœ¬éƒ½ä¸æ€ä¹ˆåˆ†é…æ¡ä»¶è½¬ç§»æŒ‡ä»¤äº†(å› ä¸ºæ•ˆç‡ä½)ã€‚</em></p>
<p>è™½ç„¶ç›®å‰çš„åˆ†æ”¯é¢„æµ‹åŠŸèƒ½å¹¶ä¸å®Œç¾ï¼Œä½†æ˜¯ç¼–è¯‘å™¨è¿˜æ˜¯åœ¨å‘è¿™ä¸€æ–¹å‘å‘å±•ã€‚</p>
<p>ARMå¹³å°å‡ºç°çš„æ¡ä»¶æ‰§è¡ŒæŒ‡ä»¤ï¼ˆä¾‹å¦‚ADRccï¼‰åŠx86å¹³å°å‡ºç°çš„CMOVccæŒ‡ä»¤ï¼Œéƒ½æ˜¯è¿™ä¸€è¶‹åŠ¿çš„æ˜è¯ã€‚</p>
<ul>
<li><code>CMOVcc</code> æŒ‡ä»¤é›†ï¼ˆConditional Move Instructionsï¼‰æ˜¯ x86 æ±‡ç¼–è¯­è¨€ä¸­çš„ä¸€ç±»æ¡ä»¶ä¼ é€æŒ‡ä»¤ã€‚è¿™äº›æŒ‡ä»¤ç”¨äºæ ¹æ®æ¡ä»¶ä»£ç å¯„å­˜å™¨ï¼ˆé€šå¸¸æ˜¯CPUçš„æ ‡å¿—å¯„å­˜å™¨ï¼‰çš„çŠ¶æ€æ¥å†³å®šæ˜¯å¦æ‰§è¡Œå¯„å­˜å™¨ä¹‹é—´çš„æ¡ä»¶æ•°æ®ç§»åŠ¨ã€‚<code>cc</code> è¡¨ç¤ºä¸åŒçš„æ¡ä»¶ä»£ç ï¼Œä¾‹å¦‚<code>E</code>è¡¨ç¤ºç­‰äºï¼Œ<code>NE</code>è¡¨ç¤ºä¸ç­‰äºç­‰ã€‚</li>
</ul>
<h4 id="æ•°æ®ç›¸å…³æ€§"><a class="markdownIt-Anchor" href="#æ•°æ®ç›¸å…³æ€§"></a> æ•°æ®ç›¸å…³æ€§</h4>
<p>å½“ä»£çš„CPUå¤šæ•°éƒ½èƒ½<code>å¹¶è¡Œæ‰§è¡ŒæŒ‡ä»¤ï¼ˆOOE/ä¹±åºæ‰§è¡ŒæŠ€æœ¯</code>ï¼‰ã€‚ä½†æ˜¯ï¼Œ<mark>è¦å……åˆ†åˆ©ç”¨CPVçš„ä¹±åºæ‰§è¡ŒåŠŸèƒ½ã€å°½å¯èƒ½é¢‘ç¹åœ°åŒæœŸæ‰§è¡Œå¤šæ¡æŒ‡ä»¤ï¼Œé¦–å…ˆå°±è¦é™ä½å„æŒ‡ä»¤ä¹‹é—´çš„æ•°æ®ç›¸å…³æ€§</mark>ã€‚æ‰€ä»¥ï¼Œç¼–è¯‘å™¨<code>å°½å¯èƒ½åœ°åˆ†é…é‚£äº›ä¸æ€ä¹ˆå½±å“CPUæ ‡è¯†çš„æŒ‡ä»¤ã€‚</code></p>
<p>å› ä¸º<mark>LEAæŒ‡ä»¤å¹¶ä¸åƒå…¶ä»–æ•°å­¦è¿ç®—æŒ‡ä»¤é‚£æ ·å½±å“æ ‡è¯†ä½ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨è¶Šæ¥è¶Šå¤šåœ°ä½¿ç”¨è¿™ç§æŒ‡ä»¤</mark>ã€‚</p>
<h3 id="chap34-hash"><a class="markdownIt-Anchor" href="#chap34-hash"></a> Chap34 hash</h3>
<ul>
<li>å“ˆå¸Œï¼ˆhashï¼‰å‡½æ•°èƒ½å¤Ÿç”Ÿæˆå¯é ç¨‹åº¦è¾ƒé«˜çš„æ ¡éªŒå’Œï¼ˆChecksumï¼‰ï¼Œå¯å……åˆ†æ»¡è¶³æ•°æ®æ£€éªŒçš„éœ€è¦ã€‚</li>
<li>CRC32ç®—æ³•å°±æ˜¯ä¸€ç§ä¸å¤ªå¤æ‚çš„å“ˆå¸Œç®—æ³•ã€‚</li>
<li>å“ˆå¸Œå€¼æ˜¯ä¸€ç§å›ºå®šé•¿åº¦çš„ä¿¡æ¯æ‘˜è¦ï¼Œä¸å¯èƒ½æ ¹æ®å“ˆå¸Œå€¼é€†å‘â€œæ¨æµ‹â€å‡ºä¿¡æ¯åŸæ–‡ã€‚æ‰€ä»¥ï¼Œæ— è®ºCRC32ç®—æ³•è®¡ç®—çš„ä¿¡æ¯åŸæ–‡æœ‰å¤šé•¿ï¼Œå®ƒåªèƒ½ç”Ÿæˆ32ä½çš„æ ¡éªŒå’Œã€‚</li>
<li>ä½†æ˜¯ä»åŠ å¯†å­¦çš„è§’åº¦çœ‹ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ˜“åœ°ä¼ªé€ å‡ºæ»¡è¶³åŒä¸€CRC32å“ˆå¸Œå€¼çš„å¤šä¸ªä¿¡æ¯åŸæ–‡ã€‚å½“ç„¶ï¼Œé˜²æ­¢ä¼ªé€ å°±æ˜¯åŠ å¯†å“ˆå¸Œå‡½æ•°ï¼ˆCryptographic hash functionï¼‰çš„ä»»åŠ¡äº†ã€‚</li>
<li>æ­¤å¤–ï¼Œäººä»¬æ™®éä½¿ç”¨MD5ã€SHA1ç­‰å“ˆå¸Œç®—æ³•ç”Ÿæˆç”¨æˆ·å¯†ç çš„æ‘˜è¦ï¼ˆå“ˆå¸Œå€¼ï¼‰ï¼Œç„¶åå†æŠŠå¯†ç æ‘˜è¦å­˜å‚¨åœ¨æ•°æ®åº“é‡Œã€‚<code>å®é™…ä¸Šç½‘ä¸Šè®ºå›ç­‰æ¶‰åŠç”¨æˆ·å¯†ç çš„æ•°æ®åº“ï¼Œå­˜å‚¨çš„å¯†ç ä¿¡æ¯å·®ä¸å¤šéƒ½æ˜¯ç”¨æˆ·å¯†ç çš„å“ˆå¸Œå€¼ï¼›å¦åˆ™ä¸€æ—¦å‘ç”Ÿæ•°æ®åº“æ³„éœ²ç­‰é—®é¢˜ï¼Œå…¥ä¾µäººå‘˜å°†èƒ½å¤Ÿè½»æ˜“åœ°è·å–å¯†ç åŸæ–‡</code>ã€‚ä¸ä»…å¦‚æ­¤ï¼Œå½“ç”¨æˆ·ç™»å½•ç½‘ç«™çš„æ—¶å€™ï¼Œç½‘ç»œè®ºå›ç­‰åº”ç”¨ç¨‹åºæ£€éªŒçš„ä¹Ÿä¸æ˜¯å¯†ç åŸæ–‡ï¼Œå®ƒä»¬æ£€éªŒçš„è¿˜æ˜¯å¯†ç å“ˆå¸Œå€¼ï¼šå¦‚æœç”¨æˆ·åå’Œå¯†ç å“ˆå¸Œå€¼ä¸æ•°æ®åº“é‡Œçš„è®°å½•åŒ¹é…ï¼Œå®ƒå°†æˆäºˆç™»å½•ç”¨æˆ·ç›¸åº”çš„è®¿é—®æƒé™ã€‚å¦å¤–ï¼Œ<code>å¸¸è§çš„å¯†ç ç ´è§£å·¥å…·é€šå¸¸éƒ½æ˜¯é€šè¿‡ç©·ä¸¾å¯†ç çš„æ–¹æ³•ï¼ŒæŸ¥æ‰¾ç¬¦åˆå¯†ç å“ˆå¸Œå€¼çš„å¯†ç åŸæ–‡è€Œå·²</code>ã€‚å…¶ä»–ç±»å‹çš„å¯†ç ç ´è§£å·¥å…·å°±è¦å¤æ‚å¾—å¤šã€‚</li>
</ul>
<hr />
<ul>
<li>å•å‘å‡½æ•°ï¼ˆone-way functionï¼‰)æ˜¯ä¸€ç§å…·æœ‰ä¸‹è¿°ç‰¹ç‚¹çš„å•å°„å‡½æ•°ï¼šå¯¹äºæ¯ä¸€ä¸ªè¾“å…¥ï¼Œå‡½æ•°å€¼éƒ½å®¹æ˜“è®¡ç®—ï¼ˆå¤šé¡¹å¼æ—¶é—´ï¼‰ï¼›ä½†æ˜¯æ ¹æ®å‡½æ•°å€¼å¯¹åŸå§‹è¾“å…¥è¿›è¡Œé€†å‘æ¨ç®—å´æ¯”è¾ƒå›°éš¾ï¼ˆæ— æ³•åœ¨å¤šé¡¹å¼æ—¶é—´å†…ä½¿ç”¨ç¡®å®šæ€§å›¾çµæœºè®¡ç®—ï¼‰ã€‚</li>
</ul>
<h2 id="part4-ä¸€äº›é«˜çº§çš„ä¾‹å­"><a class="markdownIt-Anchor" href="#part4-ä¸€äº›é«˜çº§çš„ä¾‹å­"></a> Part.4 ä¸€äº›é«˜çº§çš„ä¾‹å­</h2>
<h3 id="chap35-æ¸©åº¦è½¬æ¢"><a class="markdownIt-Anchor" href="#chap35-æ¸©åº¦è½¬æ¢"></a> Chap35 æ¸©åº¦è½¬æ¢</h3>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>C</mi><mo>=</mo><mfrac><mrow><mn>5</mn><mo>âˆ—</mo><mo stretchy="false">(</mo><mi>F</mi><mo>âˆ’</mo><mn>32</mn><mo stretchy="false">)</mo></mrow><mn>9</mn></mfrac></mrow><annotation encoding="application/x-tex">C=\frac{5*(F-32)}{9}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.113em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">9</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">5</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">3</span><span class="mord">2</span><span class="mclose">)</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>è¿™æ˜¯ä»åæ°åº¦è½¬æ¢æˆæ‘„æ°åº¦çš„è®¡ç®—å…¬å¼ï¼Œå†åŠ ä¸Šä¸€äº›ç®€å•çš„å‡ºé”™å¤„ç†</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
          <span class="token keyword">int</span> celsius<span class="token punctuation">,</span> fahr<span class="token punctuation">;</span>
          <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"Enter temperature in Fahrenheit:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">scanf</span> <span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fahr<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">1</span><span class="token punctuation">)</span>
          <span class="token punctuation">&#123;</span>
                    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"Error while parsing your input\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

          celsius <span class="token operator">=</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token punctuation">(</span>fahr<span class="token operator">-</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">9</span><span class="token punctuation">;</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>celsius<span class="token operator">&lt;</span><span class="token operator">-</span><span class="token number">273</span><span class="token punctuation">)</span>
          <span class="token punctuation">&#123;</span>
                    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"Error: incorrect temperature!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
          <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"Celsius: %d\n"</span><span class="token punctuation">,</span> celsius<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr />
<p><code>x86 æ„æ¶ä¸‹msvs 2012ä¼˜åŒ–</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token operator">$</span>SG4228 DB      <span class="token string">'Enter temperature in Fahrenheit:'</span>, <span class="token number">0aH</span>, <span class="token number">00H</span>
<span class="token operator">$</span>SG4230 DB      <span class="token string">'%d'</span>, <span class="token number">00H</span>
<span class="token operator">$</span>SG4231 DB      <span class="token string">'Error while parsing your input'</span>, <span class="token number">0aH</span>, <span class="token number">00H</span>
<span class="token operator">$</span>SG4233 DB      <span class="token string">'Error: incorrect temperature!'</span>, <span class="token number">0aH</span>, <span class="token number">00H</span>
<span class="token operator">$</span>SG4234 DB      <span class="token string">'Celsius: %d'</span>, <span class="token number">0aH</span>, <span class="token number">00H</span>

_fahr<span class="token operator">$</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">4</span>                                            <span class="token comment">; size = 4</span>
_main   PROC
        push    <span class="token register variable">ecx</span>
        push    <span class="token register variable">esi</span>
        mov     <span class="token register variable">esi</span>, DWORD PTR __imp__printf
        push    OFFSET <span class="token operator">$</span>SG4228            <span class="token comment">; 'Enter temperature in Fahrenheit:'</span>
        call    <span class="token register variable">esi</span>                       <span class="token comment">; call printf()</span>
        lea     <span class="token register variable">eax</span>, DWORD PTR _fahr<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">12</span><span class="token operator">]</span>
        push    <span class="token register variable">eax</span>
        push    OFFSET <span class="token operator">$</span>SG4230            <span class="token comment">; '%d'</span>
        call    DWORD PTR __imp__scanf
        add     <span class="token register variable">esp</span>, <span class="token number">12</span>                                <span class="token comment">; 0000000cH</span>
        cmp     <span class="token register variable">eax</span>, <span class="token number">1</span>
        je      SHORT <span class="token operator">$</span>LN2@main
        push    OFFSET <span class="token operator">$</span>SG4231             <span class="token comment">; 'Error while parsing your input'</span>
        call    <span class="token register variable">esi</span>                        <span class="token comment">; call printf()</span>
        add     <span class="token register variable">esp</span>, <span class="token number">4</span>
        push    <span class="token number">0</span>
        call    DWORD PTR __imp__exit
<span class="token label function">$LN9@main:</span>
<span class="token label function">$LN2@main:</span>
        mov    <span class="token register variable">eax</span>, DWORD PTR _fahr<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span>
        add    <span class="token register variable">eax</span>, <span class="token operator">-</span><span class="token number">32</span>                                 <span class="token comment">; ffffffe0H</span>
        lea    <span class="token register variable">ecx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token register variable">eax</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>
        mov    <span class="token register variable">eax</span>, <span class="token number">954437177</span>                           <span class="token comment">; 38e38e39H</span>
        imul   <span class="token register variable">ecx</span>
        sar    <span class="token register variable">edx</span>, <span class="token number">1</span>
        mov    <span class="token register variable">eax</span>, <span class="token register variable">edx</span>
        shr    <span class="token register variable">eax</span>, <span class="token number">31</span>                                  <span class="token comment">; 0000001fH</span>
        add    <span class="token register variable">eax</span>, <span class="token register variable">edx</span>  			<span class="token comment">;eax/9</span>
        cmp    <span class="token register variable">eax</span>, <span class="token operator">-</span><span class="token number">273</span>                                <span class="token comment">; fffffeefH</span>
        jge    SHORT <span class="token operator">$</span>LN1@main
        push   OFFSET <span class="token operator">$</span>SG4233             <span class="token comment">; 'Error: incorrect temperature!'</span>
        call   <span class="token register variable">esi</span>                        <span class="token comment">; call printf()</span>
        add    <span class="token register variable">esp</span>, <span class="token number">4</span>
        push   <span class="token number">0</span>
        call   DWORD PTR __imp__exit
<span class="token label function">$LN10@main:</span>
<span class="token label function">$LN1@main:</span>
        push   <span class="token register variable">eax</span>
        push   OFFSET <span class="token operator">$</span>SG4234             <span class="token comment">; 'Celsius: %d'</span>
        call   <span class="token register variable">esi</span>                        <span class="token comment">; call printf()</span>
        add    <span class="token register variable">esp</span>, <span class="token number">8</span>
        <span class="token comment">; return 0 - by C99 standard</span>
        xor    <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
        pop    <span class="token register variable">esi</span>
        pop    <span class="token register variable">ecx</span>
        ret    <span class="token number">0</span>
<span class="token label function">$LN8@main:</span>
_main   ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>ç¨‹åºé¦–å…ˆæŠŠ<code>printf()</code>å‡½æ•°çš„å†…å­˜åœ°å€ä¿å­˜åˆ°<code>ESI</code>å¯„å­˜å™¨,æ–¹ä¾¿åç»­è°ƒç”¨</li>
<li>ä½¿ç”¨åŠ æ³•<code>ADD EAX,-32</code>æ¥ä»£æ›¿å‡æ³•</li>
<li>è¿™é‡Œç”¨ä¹˜æ³•æ¥ä»£æ›¿äº†é™¤9ï¼Œå¯ä»¥æé«˜æ•ˆç‡ï¼Œå‚è§chap41</li>
<li>å¦‚æœä¸»å‡½æ•°<code>main()</code>æ²¡æœ‰æ˜ç¡®çš„è¿”å›å€¼ï¼Œåœ¨ç¨‹åºé€€å‡ºæ—¶é»˜è®¤ä¸º0</li>
</ul>
<hr />
<p><code>x64 æ„æ¶ä¸‹çš„msvs2012ä¼˜åŒ–</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">xor      <span class="token register variable">ecx</span>, <span class="token register variable">ecx</span>
call     QWORD PTR __imp_exit
int      <span class="token number">3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>åœ¨x64ä¸­ï¼Œæ¯æ¬¡è°ƒç”¨<code>exit()</code>å‡½æ•°ä¹‹åéƒ½æœ‰ä¸€ä¸ª<code>int 3</code>æŒ‡ä»¤</p>
<p><code>INT 3</code>æ˜¯è°ƒè¯•å™¨debuggerçš„æ–­ç‚¹è®¾ç½®æŒ‡ä»¤ã€‚</p>
<p><em>å½“ç¨‹åºæ‰§è¡Œexit()å‡½æ•°ä¹‹åï¼Œå®ƒå°±ä¸ä¼šå†è¿”å›åˆ°åŸç¨‹åºï¼Œè€Œæ˜¯ç›´æ¥é€€å‡ºäº†ã€‚ç¼–è¯‘å™¨å¤§æ¦‚è®¤ä¸ºï¼Œåœ¨å‘ç”Ÿå¼‚å¸¸é€€å‡ºçš„æƒ…å†µä¸‹ï¼Œé€šå¸¸äººä»¬åº”å½“ä½¿ç”¨è°ƒè¯•å™¨åˆ†æå¼‚å¸¸æƒ…å†µå§ã€‚</em></p>
<hr />
<p><code>æµ®ç‚¹æ•°è¿ç®—</code></p>
<p>å°†ä»¥ä¸Šä»£ç æ”¹ä¸ºæµ®ç‚¹æ•°è®¡ç®—ç‰ˆæœ¬</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
         <span class="token keyword">double</span> celsius<span class="token punctuation">,</span> fahr<span class="token punctuation">;</span>
         <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"Enter temperature in Fahrenheit:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">scanf</span> <span class="token punctuation">(</span><span class="token string">"%lf"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fahr<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">1</span><span class="token punctuation">)</span>
         <span class="token punctuation">&#123;</span>
                  <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"Error while parsing your input\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

         celsius <span class="token operator">=</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token punctuation">(</span>fahr<span class="token operator">-</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">9</span><span class="token punctuation">;</span>

         <span class="token keyword">if</span> <span class="token punctuation">(</span>celsius<span class="token operator">&lt;</span><span class="token operator">-</span><span class="token number">273</span><span class="token punctuation">)</span>
         <span class="token punctuation">&#123;</span>
                  <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"Error: incorrect temperature!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
         <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"Celsius: %lf\n"</span><span class="token punctuation">,</span> celsius<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr />
<p><code>msvs 2010 x86</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token operator">$</span>SG4038 DB     <span class="token string">'Enter temperature in Fahrenheit:'</span>, <span class="token number">0aH</span>, <span class="token number">00H</span>
<span class="token operator">$</span>SG4040 DB     <span class="token string">'%lf'</span>, <span class="token number">00H</span>
<span class="token operator">$</span>SG4041 DB     <span class="token string">'Error while parsing your input'</span>, <span class="token number">0aH</span>, <span class="token number">00H</span>
<span class="token operator">$</span>SG4043 DB     <span class="token string">'Error: incorrect temperature!'</span>, <span class="token number">0aH</span>, <span class="token number">00H</span>
<span class="token operator">$</span>SG4044 DB     <span class="token string">'Celsius: %lf'</span>, <span class="token number">0aH</span>, <span class="token number">00H</span>

__real@c071100000000000 DQ 0c071100000000000r     <span class="token comment">; -273</span>
__real@<span class="token number">4022000000000000</span> DQ 04022000000000000r     <span class="token comment">; 9</span>
__real@<span class="token number">4014000000000000</span> DQ 04014000000000000r     <span class="token comment">; 5</span>
__real@<span class="token number">4040000000000000</span> DQ 04040000000000000r     <span class="token comment">; 32</span>

_fahr<span class="token operator">$</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">8</span>                                       <span class="token comment">; size = 8</span>
_main PROC
      sub     <span class="token register variable">esp</span>, <span class="token number">8</span>
      push    <span class="token register variable">esi</span>
      mov     <span class="token register variable">esi</span>, DWORD PTR __imp__printf
      push    OFFSET <span class="token operator">$</span>SG4038          <span class="token comment">; 'Enter temperature in Fahrenheit:'</span>
      call    <span class="token register variable">esi</span>                     <span class="token comment">; call printf()</span>
      lea     <span class="token register variable">eax</span>, DWORD PTR _fahr<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">16</span><span class="token operator">]</span><span class="token comment">;eax=fahr</span>
      push    <span class="token register variable">eax</span>
      push    OFFSET <span class="token operator">$</span>SG4040          <span class="token comment">; '%lf'</span>
      call    DWORD PTR __imp__scanf
      add     <span class="token register variable">esp</span>, <span class="token number">12</span>                                    <span class="token comment">; 0000000cH</span>
      cmp     <span class="token register variable">eax</span>, <span class="token number">1</span>
      je      SHORT <span class="token operator">$</span>LN2@main
      push    OFFSET <span class="token operator">$</span>SG4041          <span class="token comment">; 'Error while parsing your input'</span>
      call    <span class="token register variable">esi</span>                     <span class="token comment">; call printf()</span>
      add     <span class="token register variable">esp</span>, <span class="token number">4</span>
      push    <span class="token number">0</span>
      call    DWORD PTR __imp__exit
<span class="token label function">$LN2@main:</span>
      fld     QWORD PTR _fahr<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">12</span><span class="token operator">]</span><span class="token comment">;st[0]=fahr</span>
      fsub    QWORD PTR __real@<span class="token number">4040000000000000</span> <span class="token comment">; 32</span>
      fmul    QWORD PTR __real@<span class="token number">4014000000000000</span> <span class="token comment">; 5</span>
      fdiv    QWORD PTR __real@<span class="token number">4022000000000000</span> <span class="token comment">; 9</span>
      fld     QWORD PTR __real@c071100000000000 <span class="token comment">; -273</span>
      fcomp   ST(<span class="token number">1</span>)<span class="token comment">;æ¯”è¾ƒst[0] [1]</span>
      fnstsw  <span class="token register variable">ax</span>
      test    <span class="token register variable">ah</span>, <span class="token number">65</span>                                     <span class="token comment">; 00000041H</span>
      jne     SHORT <span class="token operator">$</span>LN1@main
      push    OFFSET <span class="token operator">$</span>SG4043         <span class="token comment">; 'Error: incorrect temperature!'</span>
      fstp    ST(<span class="token number">0</span>)
      call    <span class="token register variable">esi</span>                    <span class="token comment">; call printf()</span>
      add     <span class="token register variable">esp</span>, <span class="token number">4</span>
      push    <span class="token number">0</span>
      call    DWORD PTR __imp__exit
<span class="token label function">$LN1@main:</span>
      sub     <span class="token register variable">esp</span>, <span class="token number">8</span>
      fstp    QWORD PTR <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">]</span>
      push    OFFSET <span class="token operator">$</span>SG4044         <span class="token comment">; 'Celsius: %lf'</span>
      call    <span class="token register variable">esi</span>
      add     <span class="token register variable">esp</span>, <span class="token number">12</span>                                    <span class="token comment">; 0000000cH</span>
      <span class="token comment">; return 0 - by C99 standard</span>
      xor     <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
      pop     <span class="token register variable">esi</span>
      add     <span class="token register variable">esp</span>, <span class="token number">8</span>
      ret     <span class="token number">0</span>
<span class="token label function">$LN10@main:</span>
_main ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p><code>fcomp ST(1)</code>ä¸<code>cmp</code>ç±»ä¼¼ï¼ŒST(1)å’ŒST(0)æ¯”è¾ƒåä¼šè®¾ç½®<code>status word</code></p>
<p><code>test ah 65ä¸jneç»“åˆ</code>å¯ä»¥è¾¾åˆ°åˆ¤æ–­<code>&gt;=</code>çš„æƒ…å†µ</p>
</li>
</ul>
<hr />
<p>ç„¶è€Œ<code>MSVS 2012</code>åˆ†é…çš„å´æ˜¯<code>SIMD</code>æŒ‡ä»¤</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token operator">$</span>SG4228 DB      <span class="token string">'Enter temperature in Fahrenheit:'</span>, <span class="token number">0aH</span>, <span class="token number">00H</span>
<span class="token operator">$</span>SG4230 DB      <span class="token string">'%lf'</span>, <span class="token number">00H</span>
<span class="token operator">$</span>SG4231 DB      <span class="token string">'Error while parsing your input'</span>, <span class="token number">0aH</span>, <span class="token number">00H</span>
<span class="token operator">$</span>SG4233 DB      <span class="token string">'Error: incorrect temperature!'</span>, <span class="token number">0aH</span>, <span class="token number">00H</span>
<span class="token operator">$</span>SG4234 DB      <span class="token string">'Celsius: %lf'</span>, <span class="token number">0aH</span>, <span class="token number">00H</span>
__real@c071100000000000 DQ 0c071100000000000r   <span class="token comment">; -273</span>
__real@<span class="token number">4040000000000000</span> DQ 04040000000000000r   <span class="token comment">; 32</span>
__real@<span class="token number">4022000000000000</span> DQ 04022000000000000r   <span class="token comment">; 9</span>
__real@<span class="token number">4014000000000000</span> DQ 04014000000000000r   <span class="token comment">; 5</span>

_fahr<span class="token operator">$</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">8</span>                                         <span class="token comment">; size = 8</span>
_main    PROC
         sub     <span class="token register variable">esp</span>, <span class="token number">8</span>
         push    <span class="token register variable">esi</span>
         mov     <span class="token register variable">esi</span>, DWORD PTR __imp__printf
         push    OFFSET <span class="token operator">$</span>SG4228           <span class="token comment">; 'Enter temperature in Fahrenheit:'</span>
         call    <span class="token register variable">esi</span>                      <span class="token comment">; call printf()</span>
         lea     <span class="token register variable">eax</span>, DWORD PTR _fahr<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">16</span><span class="token operator">]</span>
         push    <span class="token register variable">eax</span>
         push    OFFSET <span class="token operator">$</span>SG4230           <span class="token comment">; '%lf'</span>
         call    DWORD PTR __imp__scanf
         add     <span class="token register variable">esp</span>, <span class="token number">12</span>                             <span class="token comment">; 0000000cH</span>
         cmp     <span class="token register variable">eax</span>, <span class="token number">1</span>
         je      SHORT <span class="token operator">$</span>LN2@main
         push    OFFSET <span class="token operator">$</span>SG4231           <span class="token comment">; 'Error while parsing your input'</span>
         call    <span class="token register variable">esi</span>                      <span class="token comment">; call printf()</span>
         add     <span class="token register variable">esp</span>, <span class="token number">4</span>
         push    <span class="token number">0</span>
         call    DWORD PTR __imp__exit
<span class="token label function">$LN9@main:</span>
<span class="token label function">$LN2@main:</span>
         movsd   <span class="token register variable">xmm1</span>, QWORD PTR _fahr<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">12</span><span class="token operator">]</span>
         subsd   <span class="token register variable">xmm1</span>, QWORD PTR __real@<span class="token number">4040000000000000</span> <span class="token comment">; 32</span>
         movsd   <span class="token register variable">xmm0</span>, QWORD PTR __real@c071100000000000 <span class="token comment">; -273</span>
         mulsd   <span class="token register variable">xmm1</span>, QWORD PTR __real@<span class="token number">4014000000000000</span> <span class="token comment">; 5</span>
         divsd   <span class="token register variable">xmm1</span>, QWORD PTR __real@<span class="token number">4022000000000000</span> <span class="token comment">; 9</span>
         comisd  <span class="token register variable">xmm0</span>, <span class="token register variable">xmm1</span>
         jbe     SHORT <span class="token operator">$</span>LN1@main
         push    OFFSET <span class="token operator">$</span>SG4233           <span class="token comment">; 'Error: incorrect temperature!'</span>
         call    <span class="token register variable">esi</span>                      <span class="token comment">; call printf()</span>
         add     <span class="token register variable">esp</span>, <span class="token number">4</span>
         push    <span class="token number">0</span>
         call    DWORD PTR __imp__exit
<span class="token label function">$LN10@main:</span>
<span class="token label function">$LN1@main:</span>
         sub     <span class="token register variable">esp</span>, <span class="token number">8</span>
         movsd   QWORD PTR <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">]</span>, <span class="token register variable">xmm1</span>
         push    OFFSET <span class="token operator">$</span>SG4234           <span class="token comment">; 'Celsius: %lf'</span>
         call    <span class="token register variable">esi</span>                      <span class="token comment">; call printf()</span>
         add     <span class="token register variable">esp</span>, <span class="token number">12</span>                                <span class="token comment">; 0000000cH</span>
         <span class="token comment">; return 0 - by C99 standard</span>
         xor     <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
         pop     <span class="token register variable">esi</span>
         add     <span class="token register variable">esp</span>, <span class="token number">8</span>
         ret     <span class="token number">0</span>
<span class="token label function">$LN8@main:</span>
_main ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p>è¿™é‡Œæ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯æŠŠ<code>xmm1</code>å½“åšä¸€ä¸ªæ™®é€šçš„å¯„å­˜å™¨(å¯ä»¥çœ‹åšæ˜¯å¤šä¸ªfpu)å°±å¯ä»¥äº†</p>
<p>x86çš„æŒ‡ä»¤é›†ç¡®å®æ”¯æŒSIMDæŒ‡ä»¤ï¼Œæµ®ç‚¹æ•°è¿ç®—ä¹Ÿæ¯«æ— é—®é¢˜ã€‚å¤§æ¦‚æ˜¯è¿™ç§æ–¹å¼çš„è®¡ç®—æŒ‡ä»¤æ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥å¾®è½¯çš„ç¼–è¯‘å™¨åˆ†é…äº†SIMDæŒ‡ä»¤ã€‚</p>
</li>
</ul>
<h3 id="chap36-æ–æ³¢é‚£å¥‘æ•°åˆ—"><a class="markdownIt-Anchor" href="#chap36-æ–æ³¢é‚£å¥‘æ•°åˆ—"></a> Chap36 æ–æ³¢é‚£å¥‘æ•°åˆ—</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">void</span> <span class="token function">fib</span> <span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">,</span> <span class="token keyword">int</span> limit<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
          <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> a<span class="token operator">+</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token operator">+</span>b <span class="token operator">></span> limit<span class="token punctuation">)</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
          <span class="token function">fib</span> <span class="token punctuation">(</span>b<span class="token punctuation">,</span> a<span class="token operator">+</span>b<span class="token punctuation">,</span> limit<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
          <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"0\n1\n1\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">fib</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr />
<p><code>msvs 2010 x86 asm</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_TEXT    SEGMENT
_a<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>         <span class="token comment">; size = 4</span>
_b<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">12</span>        <span class="token comment">; size = 4</span>
_limit<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">16</span>    <span class="token comment">; size = 4</span>
_fib    PROC<span class="token comment">;fib(a,b)</span>
        push    <span class="token register variable">ebp</span>
        mov     <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
        mov     <span class="token register variable">eax</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span><span class="token comment">;eax=a</span>
        add     <span class="token register variable">eax</span>, DWORD PTR _b<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span><span class="token comment">;eax=a+b</span>
        push    <span class="token register variable">eax</span><span class="token comment">;a+b,å…¥æ ˆ</span>
        push    OFFSET <span class="token operator">$</span>SG2750 <span class="token comment">; "%d"</span>
        call    DWORD PTR __imp__printf
        add     <span class="token register variable">esp</span>, <span class="token number">8</span>
        mov     <span class="token register variable">ecx</span>, DWORD PTR _limit<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span><span class="token comment">;ecx=limits</span>
        push    <span class="token register variable">ecx</span>
        mov     <span class="token register variable">edx</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
        add     <span class="token register variable">edx</span>, DWORD PTR _b<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
        push    <span class="token register variable">edx</span><span class="token comment">;a+bå…¥æ ˆ</span>
        mov     <span class="token register variable">eax</span>, DWORD PTR _b<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span><span class="token comment">;eax=b</span>
        push    <span class="token register variable">eax</span>
        call    _fib,fib(b,a<span class="token operator">+</span>b)
        add     <span class="token register variable">esp</span>, <span class="token number">12</span>
        pop     <span class="token register variable">ebp</span>
        ret     <span class="token number">0</span>
_fib    ENDP

_main   PROC
        push    <span class="token register variable">ebp</span>
        mov     <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
        push    OFFSET <span class="token operator">$</span>SG2753 <span class="token comment">; "0\n1\n1\n"</span>
        call    DWORD PTR __imp__printf
        add     <span class="token register variable">esp</span>, <span class="token number">4</span>
        push    <span class="token number">20</span>
        push    <span class="token number">1</span>
        push    <span class="token number">1</span>
        call    _fib
        add     <span class="token register variable">esp</span>, <span class="token number">12</span>
        xor     <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
        pop     <span class="token register variable">ebp</span>
        ret     <span class="token number">0</span>
_main   ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr />
<p>åˆ†ææ ˆé‡Œçš„å†…å®¹</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">0035F940     00FD1039   RETURN to fib.00FD1039 from fib.00FD1000
0035F944     <span class="token number">00000008</span>   1st argument: a
0035F948     <span class="token number">0000000D</span>   2nd argument: b
0035F94C     <span class="token number">00000014</span>   3rd argument: limit
0035F950    <span class="token operator">/</span>0035F964   saved <span class="token register variable">EBP</span> register
0035F954    <span class="token operator">|</span>00FD1039   RETURN to fib.00FD1039 from fib.00FD1000
0035F958    <span class="token operator">|</span><span class="token number">00000005</span>   1st argument: a
0035F95C    <span class="token operator">|</span><span class="token number">00000008</span>   2nd argument: b
0035F960    <span class="token operator">|</span><span class="token number">00000014</span>   3rd argument: limit
0035F964    <span class="token operator">]</span>0035F978   saved <span class="token register variable">EBP</span> register
0035F968    <span class="token operator">|</span>00FD1039   RETURN to fib.00FD1039 from fib.00FD1000
0035F96C    <span class="token operator">|</span><span class="token number">00000003</span>   1st argument: a
0035F970    <span class="token operator">|</span><span class="token number">00000005</span>   2nd argument: b
0035F974    <span class="token operator">|</span><span class="token number">00000014</span>   3rd argument: limit
0035F978    <span class="token operator">]</span>0035F98C   saved <span class="token register variable">EBP</span> register
0035F97C    <span class="token operator">|</span>00FD1039   RETURN to fib.00FD1039 from fib.00FD1000
0035F980    <span class="token operator">|</span><span class="token number">00000002</span>   1st argument: a
0035F984    <span class="token operator">|</span><span class="token number">00000003</span>   2nd argument: b
0035F988    <span class="token operator">|</span><span class="token number">00000014</span>   3rd argument: limit
0035F98C    <span class="token operator">]</span>0035F9A0   saved <span class="token register variable">EBP</span> register
0035F990    <span class="token operator">|</span>00FD1039   RETURN to fib.00FD1039 from fib.00FD1000
0035F994    <span class="token operator">|</span><span class="token number">00000001</span>   1st argument: a
0035F998    <span class="token operator">|</span><span class="token number">00000002</span>   2nd argument: b
0035F99C    <span class="token operator">|</span><span class="token number">00000014</span>   3rd argument: limit
0035F9A0    <span class="token operator">]</span>0035F9B4   saved <span class="token register variable">EBP</span> register
0035F9A4    <span class="token operator">|</span>00FD105C   RETURN to fib.00FD105C from fib.00FD1000
0035F9A8    <span class="token operator">|</span><span class="token number">00000001</span>   1st argument: a              \
0035F9AC    <span class="token operator">|</span><span class="token number">00000001</span>   2nd argument: b              <span class="token operator">|</span> prepared in main() for f1()
0035F9B0    <span class="token operator">|</span><span class="token number">00000014</span>   3rd argument: limit         <span class="token operator">/</span>
0035F9B4    <span class="token operator">]</span>0035F9F8   saved <span class="token register variable">EBP</span> register
0035F9B8    <span class="token operator">|</span>00FD11D0   RETURN to fib.00FD11D0 from fib.00FD1040
0035F9BC    <span class="token operator">|</span><span class="token number">00000001</span>   main() 1st argument: argc  \
0035F9C0    <span class="token operator">|</span>006812C8   main() 2nd argument: argv  <span class="token operator">|</span> prepared in CRT for main()
0035F9C4    <span class="token operator">|</span><span class="token number">00682940</span>   main() 3rd argument: envp  <span class="token operator">/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>æœ¬ä¾‹å±äºé€’å½’å‡½æ•°ã€‚é€’å½’å‡½æ•°çš„æ ˆä¸€èˆ¬æ˜¯è¿™æ ·çš„&quot;ä¸‰æ˜æ²»ç»“æ„&quot;</li>
<li>æ ˆçš„æœ€åº•éƒ¨,ä¸€ä¸ªæ˜¯<code>main()</code>ä¸º<code>f1()</code>ä½œå‡†å¤‡ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯<code>CRT</code>ä¸º<code>main()</code>åšå‡†å¤‡</li>
<li>åœ¨ä¸Šè¿°ç¨‹åºä¸­ï¼Œlimitï¼ˆé˜ˆå€¼ï¼‰å‚æ•°æ€»æ˜¯ä¿æŒä¸å˜ï¼ˆåå…­è¿›åˆ¶çš„14ï¼Œä¹Ÿå°±æ˜¯åè¿›åˆ¶çš„20ï¼‰ï¼Œè€Œä¸¤ä¸ªå‚æ•°<em>a</em>å’Œ<em>b</em>åœ¨æ¯æ¬¡è°ƒç”¨å‡½æ•°çš„æ—¶å€™éƒ½æ˜¯ä¸åŒçš„å€¼ã€‚</li>
<li>æ­¤å¤–æ ˆä¹Ÿå­˜å‚¨äº†RAå’Œä¿å­˜EBPï¼ˆæ‰©å±•å †æ ˆæŒ‡é’ˆï¼‰çš„å€¼ã€‚OllyDbgèƒ½åŸºäºEBPçš„å€¼åˆ¤æ–­æ ˆçš„å­˜å‚¨ç»“æ„ï¼Œå› æ­¤å®ƒèƒ½å¤Ÿç”¨æ‹¬å¼§æ ‡æ³¨æ ˆå¸§ã€‚æ¢è€Œè¨€ä¹‹ï¼Œåœ¨æ¯ä¸ªæ‹¬å¼§é‡Œçš„ä¸€ç»„æ•°å€¼éƒ½å½¢æˆäº†ä¸€ä¸ªç›¸å¯¹ç‹¬ç«‹çš„æ ˆç»“æ„ï¼Œå³æ ˆå¸§ï¼ˆstack frameï¼‰ã€‚æ ˆå¸§å°±æ˜¯æ¯æ¬¡å‡½æ•°è°ƒç”¨æœŸé—´çš„æ•°æ®å®ä½“ã€‚</li>
<li>å¦ä¸€æ–¹é¢ï¼Œå³ä½¿ä»æŠ€æœ¯æ–¹é¢çœ‹æ¯ä¸ªè¢«è°ƒç”¨æ–¹å‡½æ•°ç¡®å®å¯ä»¥è®¿é—®æ ˆå¸§ä¹‹å¤–çš„æ ˆå­˜å‚¨ç©ºé—´ï¼Œä½†æ˜¯æ­£å¸¸æƒ…å†µä¸‹ä¸åº”å½“è®¿é—®æ ˆå¸§ä¹‹å¤–çš„æ•°æ®ï¼ˆå½“ç„¶é™¤äº†è·å–å‡½æ•°å‚æ•°çš„æ“ä½œä»¥å¤–ï¼‰ã€‚å¯¹äºæ²¡æœ‰bugï¼ˆç¼ºé™·ï¼‰çš„å‡½æ•°æ¥è¯´ï¼Œä¸Šè¿°å‘½é¢˜çš„ç¡®æˆç«‹ã€‚æ¯ä¸€ä¸ª EBPå€¼éƒ½æ˜¯å‰ä¸€ä¸ªæ ˆå¸§çš„åœ°å€ã€‚å› æ­¤è°ƒè¯•ç¨‹åºèƒ½å¤ŸæŠŠæ•°æ®æ ˆè¯†åˆ«ä¸ºæ ˆå¸§ï¼Œå¹¶èƒ½è¯†åˆ«å‡ºæ¯æ¬¡è°ƒç”¨å‡½æ•°æ—¶ä¼ é€’çš„å‚æ•°å€¼ã€‚</li>
<li><code>ç¨‹åºçš„æœ€åéƒ¨åˆ†ï¼Œmain()æœ‰3ä¸ªå‚æ•°ã€‚å…¶ä¸­argcï¼ˆå‚æ•°æ€»æ•°ï¼‰ä¸º1</code></li>
</ul>
<h3 id="chap37-crc32"><a class="markdownIt-Anchor" href="#chap37-crc32"></a> Chap37 CRC32</h3>
<p>è¿™æ˜¯ä¸€ä¸ªåŸºäºè¡¨æŸ¥è¯¢æŠ€æœ¯å®ç°çš„<code>CRC32</code>æ ¡éªŒå€¼çš„è®¡ç®—ç¨‹åº:</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* By Bob Jenkins, (c) 2006, Public Domain */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stddef.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>

<span class="token keyword">typedef</span>  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> ub4<span class="token punctuation">;</span>
<span class="token keyword">typedef</span>  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> ub1<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> ub4 crctab<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token number">0x00000000</span><span class="token punctuation">,</span> <span class="token number">0x77073096</span><span class="token punctuation">,</span> <span class="token number">0xee0e612c</span><span class="token punctuation">,</span> <span class="token number">0x990951ba</span><span class="token punctuation">,</span> <span class="token number">0x076dc419</span><span class="token punctuation">,</span> <span class="token number">0x706af48f</span><span class="token punctuation">,</span>
  <span class="token number">0xe963a535</span><span class="token punctuation">,</span> <span class="token number">0x9e6495a3</span><span class="token punctuation">,</span> <span class="token number">0x0edb8832</span><span class="token punctuation">,</span> <span class="token number">0x79dcb8a4</span><span class="token punctuation">,</span> <span class="token number">0xe0d5e91e</span><span class="token punctuation">,</span> <span class="token number">0x97d2d988</span><span class="token punctuation">,</span>
  <span class="token number">0x09b64c2b</span><span class="token punctuation">,</span> <span class="token number">0x7eb17cbd</span><span class="token punctuation">,</span> <span class="token number">0xe7b82d07</span><span class="token punctuation">,</span> <span class="token number">0x90bf1d91</span><span class="token punctuation">,</span> <span class="token number">0x1db71064</span><span class="token punctuation">,</span> <span class="token number">0x6ab020f2</span><span class="token punctuation">,</span>
  <span class="token number">0xf3b97148</span><span class="token punctuation">,</span> <span class="token number">0x84be41de</span><span class="token punctuation">,</span> <span class="token number">0x1adad47d</span><span class="token punctuation">,</span> <span class="token number">0x6ddde4eb</span><span class="token punctuation">,</span> <span class="token number">0xf4d4b551</span><span class="token punctuation">,</span> <span class="token number">0x83d385c7</span><span class="token punctuation">,</span>
  <span class="token number">0x136c9856</span><span class="token punctuation">,</span> <span class="token number">0x646ba8c0</span><span class="token punctuation">,</span> <span class="token number">0xfd62f97a</span><span class="token punctuation">,</span> <span class="token number">0x8a65c9ec</span><span class="token punctuation">,</span> <span class="token number">0x14015c4f</span><span class="token punctuation">,</span> <span class="token number">0x63066cd9</span><span class="token punctuation">,</span>
  <span class="token number">0xfa0f3d63</span><span class="token punctuation">,</span> <span class="token number">0x8d080df5</span><span class="token punctuation">,</span> <span class="token number">0x3b6e20c8</span><span class="token punctuation">,</span> <span class="token number">0x4c69105e</span><span class="token punctuation">,</span> <span class="token number">0xd56041e4</span><span class="token punctuation">,</span> <span class="token number">0xa2677172</span><span class="token punctuation">,</span>
  <span class="token number">0x3c03e4d1</span><span class="token punctuation">,</span> <span class="token number">0x4b04d447</span><span class="token punctuation">,</span> <span class="token number">0xd20d85fd</span><span class="token punctuation">,</span> <span class="token number">0xa50ab56b</span><span class="token punctuation">,</span> <span class="token number">0x35b5a8fa</span><span class="token punctuation">,</span> <span class="token number">0x42b2986c</span><span class="token punctuation">,</span>
  <span class="token number">0xdbbbc9d6</span><span class="token punctuation">,</span> <span class="token number">0xacbcf940</span><span class="token punctuation">,</span> <span class="token number">0x32d86ce3</span><span class="token punctuation">,</span> <span class="token number">0x45df5c75</span><span class="token punctuation">,</span> <span class="token number">0xdcd60dcf</span><span class="token punctuation">,</span> <span class="token number">0xabd13d59</span><span class="token punctuation">,</span>
  <span class="token number">0x26d930ac</span><span class="token punctuation">,</span> <span class="token number">0x51de003a</span><span class="token punctuation">,</span> <span class="token number">0xc8d75180</span><span class="token punctuation">,</span> <span class="token number">0xbfd06116</span><span class="token punctuation">,</span> <span class="token number">0x21b4f4b5</span><span class="token punctuation">,</span> <span class="token number">0x56b3c423</span><span class="token punctuation">,</span>
  <span class="token number">0xcfba9599</span><span class="token punctuation">,</span> <span class="token number">0xb8bda50f</span><span class="token punctuation">,</span> <span class="token number">0x2802b89e</span><span class="token punctuation">,</span> <span class="token number">0x5f058808</span><span class="token punctuation">,</span> <span class="token number">0xc60cd9b2</span><span class="token punctuation">,</span> <span class="token number">0xb10be924</span><span class="token punctuation">,</span>
  <span class="token number">0x2f6f7c87</span><span class="token punctuation">,</span> <span class="token number">0x58684c11</span><span class="token punctuation">,</span> <span class="token number">0xc1611dab</span><span class="token punctuation">,</span> <span class="token number">0xb6662d3d</span><span class="token punctuation">,</span> <span class="token number">0x76dc4190</span><span class="token punctuation">,</span> <span class="token number">0x01db7106</span><span class="token punctuation">,</span>
  <span class="token number">0x98d220bc</span><span class="token punctuation">,</span> <span class="token number">0xefd5102a</span><span class="token punctuation">,</span> <span class="token number">0x71b18589</span><span class="token punctuation">,</span> <span class="token number">0x06b6b51f</span><span class="token punctuation">,</span> <span class="token number">0x9fbfe4a5</span><span class="token punctuation">,</span> <span class="token number">0xe8b8d433</span><span class="token punctuation">,</span>
  <span class="token number">0x7807c9a2</span><span class="token punctuation">,</span> <span class="token number">0x0f00f934</span><span class="token punctuation">,</span> <span class="token number">0x9609a88e</span><span class="token punctuation">,</span> <span class="token number">0xe10e9818</span><span class="token punctuation">,</span> <span class="token number">0x7f6a0dbb</span><span class="token punctuation">,</span> <span class="token number">0x086d3d2d</span><span class="token punctuation">,</span>
  <span class="token number">0x91646c97</span><span class="token punctuation">,</span> <span class="token number">0xe6635c01</span><span class="token punctuation">,</span> <span class="token number">0x6b6b51f4</span><span class="token punctuation">,</span> <span class="token number">0x1c6c6162</span><span class="token punctuation">,</span> <span class="token number">0x856530d8</span><span class="token punctuation">,</span> <span class="token number">0xf262004e</span><span class="token punctuation">,</span>
  <span class="token number">0x6c0695ed</span><span class="token punctuation">,</span> <span class="token number">0x1b01a57b</span><span class="token punctuation">,</span> <span class="token number">0x8208f4c1</span><span class="token punctuation">,</span> <span class="token number">0xf50fc457</span><span class="token punctuation">,</span> <span class="token number">0x65b0d9c6</span><span class="token punctuation">,</span> <span class="token number">0x12b7e950</span><span class="token punctuation">,</span>
  <span class="token number">0x8bbeb8ea</span><span class="token punctuation">,</span> <span class="token number">0xfcb9887c</span><span class="token punctuation">,</span> <span class="token number">0x62dd1ddf</span><span class="token punctuation">,</span> <span class="token number">0x15da2d49</span><span class="token punctuation">,</span> <span class="token number">0x8cd37cf3</span><span class="token punctuation">,</span> <span class="token number">0xfbd44c65</span><span class="token punctuation">,</span>
  <span class="token number">0x4db26158</span><span class="token punctuation">,</span> <span class="token number">0x3ab551ce</span><span class="token punctuation">,</span> <span class="token number">0xa3bc0074</span><span class="token punctuation">,</span> <span class="token number">0xd4bb30e2</span><span class="token punctuation">,</span> <span class="token number">0x4adfa541</span><span class="token punctuation">,</span> <span class="token number">0x3dd895d7</span><span class="token punctuation">,</span>
  <span class="token number">0xa4d1c46d</span><span class="token punctuation">,</span> <span class="token number">0xd3d6f4fb</span><span class="token punctuation">,</span> <span class="token number">0x4369e96a</span><span class="token punctuation">,</span> <span class="token number">0x346ed9fc</span><span class="token punctuation">,</span> <span class="token number">0xad678846</span><span class="token punctuation">,</span> <span class="token number">0xda60b8d0</span><span class="token punctuation">,</span>
  <span class="token number">0x44042d73</span><span class="token punctuation">,</span> <span class="token number">0x33031de5</span><span class="token punctuation">,</span> <span class="token number">0xaa0a4c5f</span><span class="token punctuation">,</span> <span class="token number">0xdd0d7cc9</span><span class="token punctuation">,</span> <span class="token number">0x5005713c</span><span class="token punctuation">,</span> <span class="token number">0x270241aa</span><span class="token punctuation">,</span>
  <span class="token number">0xbe0b1010</span><span class="token punctuation">,</span> <span class="token number">0xc90c2086</span><span class="token punctuation">,</span> <span class="token number">0x5768b525</span><span class="token punctuation">,</span> <span class="token number">0x206f85b3</span><span class="token punctuation">,</span> <span class="token number">0xb966d409</span><span class="token punctuation">,</span> <span class="token number">0xce61e49f</span><span class="token punctuation">,</span>
  <span class="token number">0x5edef90e</span><span class="token punctuation">,</span> <span class="token number">0x29d9c998</span><span class="token punctuation">,</span> <span class="token number">0xb0d09822</span><span class="token punctuation">,</span> <span class="token number">0xc7d7a8b4</span><span class="token punctuation">,</span> <span class="token number">0x59b33d17</span><span class="token punctuation">,</span> <span class="token number">0x2eb40d81</span><span class="token punctuation">,</span>
  <span class="token number">0xb7bd5c3b</span><span class="token punctuation">,</span> <span class="token number">0xc0ba6cad</span><span class="token punctuation">,</span> <span class="token number">0xedb88320</span><span class="token punctuation">,</span> <span class="token number">0x9abfb3b6</span><span class="token punctuation">,</span> <span class="token number">0x03b6e20c</span><span class="token punctuation">,</span> <span class="token number">0x74b1d29a</span><span class="token punctuation">,</span>
  <span class="token number">0xead54739</span><span class="token punctuation">,</span> <span class="token number">0x9dd277af</span><span class="token punctuation">,</span> <span class="token number">0x04db2615</span><span class="token punctuation">,</span> <span class="token number">0x73dc1683</span><span class="token punctuation">,</span> <span class="token number">0xe3630b12</span><span class="token punctuation">,</span> <span class="token number">0x94643b84</span><span class="token punctuation">,</span>
  <span class="token number">0x0d6d6a3e</span><span class="token punctuation">,</span> <span class="token number">0x7a6a5aa8</span><span class="token punctuation">,</span> <span class="token number">0xe40ecf0b</span><span class="token punctuation">,</span> <span class="token number">0x9309ff9d</span><span class="token punctuation">,</span> <span class="token number">0x0a00ae27</span><span class="token punctuation">,</span> <span class="token number">0x7d079eb1</span><span class="token punctuation">,</span>
  <span class="token number">0xf00f9344</span><span class="token punctuation">,</span> <span class="token number">0x8708a3d2</span><span class="token punctuation">,</span> <span class="token number">0x1e01f268</span><span class="token punctuation">,</span> <span class="token number">0x6906c2fe</span><span class="token punctuation">,</span> <span class="token number">0xf762575d</span><span class="token punctuation">,</span> <span class="token number">0x806567cb</span><span class="token punctuation">,</span>
  <span class="token number">0x196c3671</span><span class="token punctuation">,</span> <span class="token number">0x6e6b06e7</span><span class="token punctuation">,</span> <span class="token number">0xfed41b76</span><span class="token punctuation">,</span> <span class="token number">0x89d32be0</span><span class="token punctuation">,</span> <span class="token number">0x10da7a5a</span><span class="token punctuation">,</span> <span class="token number">0x67dd4acc</span><span class="token punctuation">,</span>
  <span class="token number">0xf9b9df6f</span><span class="token punctuation">,</span> <span class="token number">0x8ebeeff9</span><span class="token punctuation">,</span> <span class="token number">0x17b7be43</span><span class="token punctuation">,</span> <span class="token number">0x60b08ed5</span><span class="token punctuation">,</span> <span class="token number">0xd6d6a3e8</span><span class="token punctuation">,</span> <span class="token number">0xa1d1937e</span><span class="token punctuation">,</span>
  <span class="token number">0x38d8c2c4</span><span class="token punctuation">,</span> <span class="token number">0x4fdff252</span><span class="token punctuation">,</span> <span class="token number">0xd1bb67f1</span><span class="token punctuation">,</span> <span class="token number">0xa6bc5767</span><span class="token punctuation">,</span> <span class="token number">0x3fb506dd</span><span class="token punctuation">,</span> <span class="token number">0x48b2364b</span><span class="token punctuation">,</span>
  <span class="token number">0xd80d2bda</span><span class="token punctuation">,</span> <span class="token number">0xaf0a1b4c</span><span class="token punctuation">,</span> <span class="token number">0x36034af6</span><span class="token punctuation">,</span> <span class="token number">0x41047a60</span><span class="token punctuation">,</span> <span class="token number">0xdf60efc3</span><span class="token punctuation">,</span> <span class="token number">0xa867df55</span><span class="token punctuation">,</span>
  <span class="token number">0x316e8eef</span><span class="token punctuation">,</span> <span class="token number">0x4669be79</span><span class="token punctuation">,</span> <span class="token number">0xcb61b38c</span><span class="token punctuation">,</span> <span class="token number">0xbc66831a</span><span class="token punctuation">,</span> <span class="token number">0x256fd2a0</span><span class="token punctuation">,</span> <span class="token number">0x5268e236</span><span class="token punctuation">,</span>
  <span class="token number">0xcc0c7795</span><span class="token punctuation">,</span> <span class="token number">0xbb0b4703</span><span class="token punctuation">,</span> <span class="token number">0x220216b9</span><span class="token punctuation">,</span> <span class="token number">0x5505262f</span><span class="token punctuation">,</span> <span class="token number">0xc5ba3bbe</span><span class="token punctuation">,</span> <span class="token number">0xb2bd0b28</span><span class="token punctuation">,</span>
  <span class="token number">0x2bb45a92</span><span class="token punctuation">,</span> <span class="token number">0x5cb36a04</span><span class="token punctuation">,</span> <span class="token number">0xc2d7ffa7</span><span class="token punctuation">,</span> <span class="token number">0xb5d0cf31</span><span class="token punctuation">,</span> <span class="token number">0x2cd99e8b</span><span class="token punctuation">,</span> <span class="token number">0x5bdeae1d</span><span class="token punctuation">,</span>
  <span class="token number">0x9b64c2b0</span><span class="token punctuation">,</span> <span class="token number">0xec63f226</span><span class="token punctuation">,</span> <span class="token number">0x756aa39c</span><span class="token punctuation">,</span> <span class="token number">0x026d930a</span><span class="token punctuation">,</span> <span class="token number">0x9c0906a9</span><span class="token punctuation">,</span> <span class="token number">0xeb0e363f</span><span class="token punctuation">,</span>
  <span class="token number">0x72076785</span><span class="token punctuation">,</span> <span class="token number">0x05005713</span><span class="token punctuation">,</span> <span class="token number">0x95bf4a82</span><span class="token punctuation">,</span> <span class="token number">0xe2b87a14</span><span class="token punctuation">,</span> <span class="token number">0x7bb12bae</span><span class="token punctuation">,</span> <span class="token number">0x0cb61b38</span><span class="token punctuation">,</span>
  <span class="token number">0x92d28e9b</span><span class="token punctuation">,</span> <span class="token number">0xe5d5be0d</span><span class="token punctuation">,</span> <span class="token number">0x7cdcefb7</span><span class="token punctuation">,</span> <span class="token number">0x0bdbdf21</span><span class="token punctuation">,</span> <span class="token number">0x86d3d2d4</span><span class="token punctuation">,</span> <span class="token number">0xf1d4e242</span><span class="token punctuation">,</span>
  <span class="token number">0x68ddb3f8</span><span class="token punctuation">,</span> <span class="token number">0x1fda836e</span><span class="token punctuation">,</span> <span class="token number">0x81be16cd</span><span class="token punctuation">,</span> <span class="token number">0xf6b9265b</span><span class="token punctuation">,</span> <span class="token number">0x6fb077e1</span><span class="token punctuation">,</span> <span class="token number">0x18b74777</span><span class="token punctuation">,</span>
  <span class="token number">0x88085ae6</span><span class="token punctuation">,</span> <span class="token number">0xff0f6a70</span><span class="token punctuation">,</span> <span class="token number">0x66063bca</span><span class="token punctuation">,</span> <span class="token number">0x11010b5c</span><span class="token punctuation">,</span> <span class="token number">0x8f659eff</span><span class="token punctuation">,</span> <span class="token number">0xf862ae69</span><span class="token punctuation">,</span>
  <span class="token number">0x616bffd3</span><span class="token punctuation">,</span> <span class="token number">0x166ccf45</span><span class="token punctuation">,</span> <span class="token number">0xa00ae278</span><span class="token punctuation">,</span> <span class="token number">0xd70dd2ee</span><span class="token punctuation">,</span> <span class="token number">0x4e048354</span><span class="token punctuation">,</span> <span class="token number">0x3903b3c2</span><span class="token punctuation">,</span>
  <span class="token number">0xa7672661</span><span class="token punctuation">,</span> <span class="token number">0xd06016f7</span><span class="token punctuation">,</span> <span class="token number">0x4969474d</span><span class="token punctuation">,</span> <span class="token number">0x3e6e77db</span><span class="token punctuation">,</span> <span class="token number">0xaed16a4a</span><span class="token punctuation">,</span> <span class="token number">0xd9d65adc</span><span class="token punctuation">,</span>
  <span class="token number">0x40df0b66</span><span class="token punctuation">,</span> <span class="token number">0x37d83bf0</span><span class="token punctuation">,</span> <span class="token number">0xa9bcae53</span><span class="token punctuation">,</span> <span class="token number">0xdebb9ec5</span><span class="token punctuation">,</span> <span class="token number">0x47b2cf7f</span><span class="token punctuation">,</span> <span class="token number">0x30b5ffe9</span><span class="token punctuation">,</span>
  <span class="token number">0xbdbdf21c</span><span class="token punctuation">,</span> <span class="token number">0xcabac28a</span><span class="token punctuation">,</span> <span class="token number">0x53b39330</span><span class="token punctuation">,</span> <span class="token number">0x24b4a3a6</span><span class="token punctuation">,</span> <span class="token number">0xbad03605</span><span class="token punctuation">,</span> <span class="token number">0xcdd70693</span><span class="token punctuation">,</span>
  <span class="token number">0x54de5729</span><span class="token punctuation">,</span> <span class="token number">0x23d967bf</span><span class="token punctuation">,</span> <span class="token number">0xb3667a2e</span><span class="token punctuation">,</span> <span class="token number">0xc4614ab8</span><span class="token punctuation">,</span> <span class="token number">0x5d681b02</span><span class="token punctuation">,</span> <span class="token number">0x2a6f2b94</span><span class="token punctuation">,</span>
  <span class="token number">0xb40bbe37</span><span class="token punctuation">,</span> <span class="token number">0xc30c8ea1</span><span class="token punctuation">,</span> <span class="token number">0x5a05df1b</span><span class="token punctuation">,</span> <span class="token number">0x2d02ef8d</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">/* how to derive the values in crctab[] from polynomial 0xedb88320 */</span>
<span class="token keyword">void</span> <span class="token function">build_table</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  ub4 i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">256</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    j <span class="token operator">=</span> i<span class="token punctuation">;</span>
    j <span class="token operator">=</span> <span class="token punctuation">(</span>j<span class="token operator">>></span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>j<span class="token operator">&amp;</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0xedb88320</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    j <span class="token operator">=</span> <span class="token punctuation">(</span>j<span class="token operator">>></span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>j<span class="token operator">&amp;</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0xedb88320</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    j <span class="token operator">=</span> <span class="token punctuation">(</span>j<span class="token operator">>></span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>j<span class="token operator">&amp;</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0xedb88320</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    j <span class="token operator">=</span> <span class="token punctuation">(</span>j<span class="token operator">>></span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>j<span class="token operator">&amp;</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0xedb88320</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    j <span class="token operator">=</span> <span class="token punctuation">(</span>j<span class="token operator">>></span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>j<span class="token operator">&amp;</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0xedb88320</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    j <span class="token operator">=</span> <span class="token punctuation">(</span>j<span class="token operator">>></span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>j<span class="token operator">&amp;</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0xedb88320</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    j <span class="token operator">=</span> <span class="token punctuation">(</span>j<span class="token operator">>></span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>j<span class="token operator">&amp;</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0xedb88320</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    j <span class="token operator">=</span> <span class="token punctuation">(</span>j<span class="token operator">>></span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>j<span class="token operator">&amp;</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0xedb88320</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"0x%.8lx, "</span><span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token operator">%</span><span class="token number">6</span> <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/* the hash function */</span>
ub4 <span class="token function">crc</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">,</span> ub4 len<span class="token punctuation">,</span> ub4 hash<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  ub4 i<span class="token punctuation">;</span>
  <span class="token keyword">const</span> ub1 <span class="token operator">*</span>k <span class="token operator">=</span> key<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>hash<span class="token operator">=</span>len<span class="token punctuation">,</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>len<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    hash <span class="token operator">=</span> <span class="token punctuation">(</span>hash <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">^</span> crctab<span class="token punctuation">[</span><span class="token punctuation">(</span>hash <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span> <span class="token operator">^</span> k<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> hash<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/* To use, try "gcc -O crc.c -o crc; crc &lt; crc.c" */</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">1000</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">gets</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%.8lx\n"</span><span class="token punctuation">,</span> <span class="token function">crc</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>å¯¹äºåŠ å¯†ç®—æ³•çš„å®ç°ï¼Œæˆ‘ä»¬å¾€å¾€åªå…³æ³¨å…³é”®å‡½æ•°çš„è¯¦ç»†ç»†èŠ‚ã€‚å¯¹äºCRC32æ•ˆéªŒç®—æ³•ï¼Œæˆ‘ä»¬å°±è¦ç‰¹åˆ«å…³æ³¨<code>crc()</code>çš„å®ç°ã€‚æ³¨æ„<code>for()</code>è¯­å¥çš„ä¸¤ä¸ªåˆå§‹æŒ‡ä»¤<code>hash=len</code>å’Œ<code>i=0</code>ã€‚å½“ç„¶ï¼Œåœ¨<code>C/C++</code>è¯­è¨€é‡Œï¼Œæˆ‘ä»¬å¯ä»¥ä¸€æ¬¡æŒ‡å®šä¸¤æ¡å¾ªç¯åˆå§‹æŒ‡ä»¤ï¼Œè€Œåœ¨æœ€ç»ˆçš„æ±‡ç¼–æŒ‡ä»¤å±‚é¢ï¼Œå°±ä¼šå‡ºç°ä¸¤æ¡åˆå§‹åŒ–æŒ‡ä»¤</li>
</ul>
<hr />
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_key<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>             <span class="token comment">; size = 4</span>
_len<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">12</span>            <span class="token comment">; size = 4</span>
_hash<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">16</span>           <span class="token comment">; size = 4</span>
_crc    PROC
    mov    <span class="token register variable">edx</span>, DWORD PTR _len<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
    xor    <span class="token register variable">ecx</span>, <span class="token register variable">ecx</span> <span class="token comment">; ecx=0,,,i will be stored in ECX</span>
    mov    <span class="token register variable">eax</span>, <span class="token register variable">edx</span><span class="token comment">;eax=len</span>
    test   <span class="token register variable">edx</span>, <span class="token register variable">edx</span>
    jbe    SHORT <span class="token operator">$</span>LN1@crc<span class="token comment">;edx&lt;=len?</span>
    push   <span class="token register variable">ebx</span>
    push   <span class="token register variable">esi</span>
    mov    <span class="token register variable">esi</span>, DWORD PTR _key<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span> <span class="token comment">; ESI = key</span>
    push   <span class="token register variable">edi</span>
<span class="token label function">$LL3@crc:</span>

<span class="token comment">; work with bytes using only 32-bit registers. byte from address key+i we store into EDI</span>

    movzx  <span class="token register variable">edi</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token register variable">esi</span><span class="token operator">]</span><span class="token comment">;;edi=key[i]</span>
    mov    <span class="token register variable">ebx</span>, <span class="token register variable">eax</span> <span class="token comment">; EBX = (hash = len)</span>
    and    <span class="token register variable">ebx</span>, <span class="token number">255</span> <span class="token comment">; EBX = hash &amp; 0xff</span>

<span class="token comment">; XOR EDI, EBX (EDI=EDI^EBX) - this operation uses all 32 bits of each register</span>
<span class="token comment">; but other bits (8-31) are cleared all time, so its OK'</span>
<span class="token comment">; these are cleared because, as for EDI, it was done by MOVZX instruction above</span>
<span class="token comment">; high bits of EBX was cleared by AND EBX, 255 instruction above (255 = 0xff)</span>

    xor    <span class="token register variable">edi</span>, <span class="token register variable">ebx</span><span class="token comment">;edi=key[i]^(hash&amp;0xff)</span>

<span class="token comment">; EAX=EAX>>8; bits 24-31 taken "from nowhere" will be cleared</span>
    shr    <span class="token register variable">eax</span>, <span class="token number">8</span><span class="token comment">;eax=len=hash>>8</span>

<span class="token comment">; EAX=EAX^crctab[EDI*4] - choose EDI-th element from crctab[] table</span>
    xor    <span class="token register variable">eax</span>, DWORD PTR _crctab<span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span><span class="token comment">;eax=(hash>>8)^crctab[(hash&amp;0xff)^key[i]]</span>
    inc    <span class="token register variable">ecx</span>            <span class="token comment">; i++</span>
    cmp    <span class="token register variable">ecx</span>, <span class="token register variable">edx</span>       <span class="token comment">; i&lt;len ?</span>
    jb     SHORT <span class="token operator">$</span>LL3@crc <span class="token comment">; yes</span>
    pop    <span class="token register variable">edi</span>
    pop    <span class="token register variable">esi</span>
    pop    <span class="token register variable">ebx</span>
<span class="token label function">$LN1@crc:</span>
    ret    <span class="token number">0</span>
_crc    ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>é‡‡ç”¨ä¼˜åŒ–çš„æ–¹å¼(/Ox)æ¥ç¼–è¯‘</code>ï¼Œè¿™é‡Œåªåˆ—å‡º<code>crc()</code>å‡½æ•°</p>
<hr />
<p><code>gcc 4.4.1 -O3</code>ç¼–è¯‘</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">                 public crc
crc              proc near

key              <span class="token operator">=</span> dword ptr <span class="token number">8</span>
hash             <span class="token operator">=</span> dword ptr <span class="token number">0Ch</span>

                 push    <span class="token register variable">ebp</span>
                 xor     <span class="token register variable">edx</span>, <span class="token register variable">edx</span><span class="token comment">;edx=i;i=0</span>
                 mov     <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
                 push    <span class="token register variable">esi</span>
                 mov     <span class="token register variable">esi</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>key<span class="token operator">]</span><span class="token comment">;esi=key</span>
                 push    <span class="token register variable">ebx</span>
                 mov     <span class="token register variable">ebx</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>hash<span class="token operator">]</span><span class="token comment">;ebx=hash</span>
                 test    <span class="token register variable">ebx</span>, <span class="token register variable">ebx</span>
                 mov     <span class="token register variable">eax</span>, <span class="token register variable">ebx</span><span class="token comment">;eax=ebx=hash</span>
                 jz      short loc_80484D3<span class="token comment">;ebx=0?</span>
                 nop                       <span class="token comment">; padding</span>
                 lea     <span class="token register variable">esi</span>, <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">0</span><span class="token operator">]</span>      <span class="token comment">; padding; works as NOP (ESI does not changing here)</span>

<span class="token label function">loc_80484B8:</span>
                 mov     <span class="token register variable">ecx</span>, <span class="token register variable">eax</span> <span class="token comment">;ecx=hash         ; save previous state of hash to ECX</span>
                 xor     <span class="token register variable">al</span>, <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token register variable">edx</span><span class="token operator">]</span>     <span class="token comment">; AL=(hash&amp;0xff)^key[i]</span>
                 add     <span class="token register variable">edx</span>, <span class="token number">1</span>            <span class="token comment">; i++</span>
                 shr     <span class="token register variable">ecx</span>, <span class="token number">8</span>            <span class="token comment">; ECX=hash>>8</span>
                 movzx   <span class="token register variable">eax</span>, <span class="token register variable">al</span>           <span class="token comment">; EAX=*(key+i)&amp;0xff</span>
                 mov     <span class="token register variable">eax</span>, dword ptr <span class="token register variable">ds</span>:crctab<span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span> <span class="token comment">; EAX=crctab[EAX]</span>
                 xor     <span class="token register variable">eax</span>, <span class="token register variable">ecx</span>          <span class="token comment">; hash=EAX^ECX</span>
                 cmp     <span class="token register variable">ebx</span>, <span class="token register variable">edx</span><span class="token comment">;len>=i?</span>
                 ja      short loc_80484B8<span class="token comment">;</span>
<span class="token label function">loc_80484D3:</span>
                 pop     <span class="token register variable">ebx</span>
                 pop     <span class="token register variable">esi</span>
                 pop     <span class="token register variable">ebp</span>
                 retn
crc              endp
\<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>é‡åˆ°è¿™ç§ï¼Œæ±‡ç¼–ä¸ç®—å¤æ‚ï¼Œè€å¿ƒåˆ†æå³å¯</p>
<hr />
<h3 id="chap38-ç½‘ç»œåœ°å€è®¡ç®—"><a class="markdownIt-Anchor" href="#chap38-ç½‘ç»œåœ°å€è®¡ç®—"></a> Chap38 ç½‘ç»œåœ°å€è®¡ç®—</h3>
<ul>
<li>
<p>IPv4ä¸‹çš„TCP/IPåœ°å€ç”±4ä¸ªæ•°å­—ç»„æˆï¼Œæ¯ä¸ªæ•°å­—éƒ½åœ¨0ï½255ï¼ˆåè¿›åˆ¶ï¼‰ä¹‹é—´ã€‚æ‰€ä»¥IPv4çš„åœ°å€å¯ä»¥è¡¨ç¤ºä¸º4å­—èŠ‚æ•°æ®ã€‚å› æ­¤IPv4çš„ä¸»æœºåœ°å€ã€å­ç½‘æ©ç å’Œç½‘ç»œåœ°å€éƒ½å¯ä»¥è¡¨ç¤ºä¸ºä¸€ä¸ª32ä½çš„æ•´æ•°ã€‚</p>
</li>
<li>
<p><code>ä½¿ç”¨è€…çš„è§’åº¦æ¥çœ‹ï¼Œå­ç½‘æ©ç ç”±4ä½æ•°å­—ç»„æˆï¼Œå†™å‡ºæ¥å¤§è‡´å°±æ˜¯255.255.255.0è¿™ç±»å½¢å¼çš„æ•°å­—</code>ã€‚ä½†<code>æ˜¯ç½‘ç»œå·¥ç¨‹å¸ˆæˆ–è€…ç³»ç»Ÿç®¡ç†å‘˜æ›´å–œæ¬¢ä½¿ç”¨æ›´ä¸ºç´§å‡‘çš„è¡¨ç¤ºæ–¹æ³•</code>ï¼Œä¹Ÿå°±æ˜¯CIDR[<a href="#anchor381">1]</a>è§„èŒƒçš„â€œ/8â€â€œ/16â€ä¸€ç±»çš„è¡¨ç¤ºæ–¹æ³•ã€‚<code>CIDRæ ¼å¼çš„å­ç½‘æ©ç ä»å­ç½‘æ©ç çš„MSBï¼ˆæœ€é«˜æ•°æƒä½ï¼‰å¼€å§‹è®¡æ•°ï¼Œç»Ÿè®¡å­ç½‘æ©ç é‡Œé¢æœ‰å¤šå°‘ä¸ª1å¹¶å°†ç»Ÿè®¡æ•°å­—è½¬æ¢ä¸º10è¿›åˆ¶æ•°</code>ã€‚</p>
<table>
<thead>
<tr>
<th>CIDKè§„èŒƒçš„æ©ç </th>
<th>æ•°å­—ç©ºé—´</th>
<th>å¯ç”¨åœ°å€ï¼ˆä¸ªï¼‰</th>
<th>åè¿›åˆ¶å­ç½‘æ©ç </th>
<th>åå…­è¿›åˆ¶å­ç½‘æ©ç </th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>/30</td>
<td>4</td>
<td>2</td>
<td>255.255.255.252</td>
<td>fffffffc</td>
<td></td>
</tr>
<tr>
<td>/29</td>
<td>8</td>
<td>6</td>
<td>255.255.255.248</td>
<td>fffffff8</td>
<td></td>
</tr>
<tr>
<td>/28</td>
<td>16</td>
<td>14</td>
<td>255.255.255.240</td>
<td>fffffff0</td>
<td></td>
</tr>
<tr>
<td>/27</td>
<td>32</td>
<td>30</td>
<td>255.255.255.224</td>
<td>ffffffe0</td>
<td></td>
</tr>
<tr>
<td>/26</td>
<td>64</td>
<td>62</td>
<td>255.255.255.192</td>
<td>ffffffc0</td>
<td></td>
</tr>
<tr>
<td>/24</td>
<td>256</td>
<td>254</td>
<td>255.255.255.0</td>
<td>ffffff00</td>
<td>Cç±»ç½‘æ®µ</td>
</tr>
<tr>
<td>/23</td>
<td>512</td>
<td>510</td>
<td>255.255.254.0</td>
<td>fffffe00</td>
<td></td>
</tr>
<tr>
<td>/22</td>
<td>1024</td>
<td>1022</td>
<td>255.255.252.0</td>
<td>fffffc00</td>
<td></td>
</tr>
<tr>
<td>/21</td>
<td>2048</td>
<td>2046</td>
<td>255.255.248.0</td>
<td>fffff800</td>
<td></td>
</tr>
<tr>
<td>/20</td>
<td>4096</td>
<td>4094</td>
<td>255.255.240.0</td>
<td>fffff000</td>
<td></td>
</tr>
<tr>
<td>/19</td>
<td>8192</td>
<td>8190</td>
<td>255.255.224.0</td>
<td>ffffe000</td>
<td></td>
</tr>
<tr>
<td>/18</td>
<td>16384</td>
<td>16382</td>
<td>255.255.192.0</td>
<td>ffffc000</td>
<td></td>
</tr>
<tr>
<td>/17</td>
<td>32768</td>
<td>32766</td>
<td>255.255.128.0</td>
<td>ffff8000</td>
<td></td>
</tr>
<tr>
<td>/16</td>
<td>65536</td>
<td>65534</td>
<td>255.255.0.0</td>
<td>ffff0000</td>
<td>Bç±»ç½‘æ®µ</td>
</tr>
<tr>
<td>/8</td>
<td>16777216</td>
<td>16777214</td>
<td>255.0.0.0</td>
<td>ff000000</td>
<td>Aç±»ç½‘æ®µ</td>
</tr>
</tbody>
</table>
</li>
</ul>
<hr />
<p>è¿™æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œå°†å­ç½‘æ©ç åº”ç”¨åˆ°ä¸»æœºåœ°å€</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span>

<span class="token class-name">uint32_t</span> <span class="token function">form_IP</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> ip1<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> ip2<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> ip3<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> ip4<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
          <span class="token keyword">return</span> <span class="token punctuation">(</span>ip1<span class="token operator">&lt;&lt;</span><span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>ip2<span class="token operator">&lt;&lt;</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>ip3<span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> ip4<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">print_as_IP</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span> a<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
          <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"%d.%d.%d.%d\n"</span><span class="token punctuation">,</span>
                   <span class="token punctuation">(</span>a<span class="token operator">>></span><span class="token number">24</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0xFF</span><span class="token punctuation">,</span>
                   <span class="token punctuation">(</span>a<span class="token operator">>></span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0xFF</span><span class="token punctuation">,</span>
                   <span class="token punctuation">(</span>a<span class="token operator">>></span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0xFF</span><span class="token punctuation">,</span>
                   <span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// bit=31..0</span>
<span class="token class-name">uint32_t</span> <span class="token function">set_bit</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span> input<span class="token punctuation">,</span> <span class="token keyword">int</span> bit<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
          <span class="token keyword">return</span> input<span class="token operator">=</span>input<span class="token operator">|</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span>bit<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token class-name">uint32_t</span> <span class="token function">form_netmask</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> netmask_bits<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
          <span class="token class-name">uint32_t</span> netmask<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
          <span class="token class-name">uint8_t</span> i<span class="token punctuation">;</span>

          <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>netmask_bits<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
                    netmask<span class="token operator">=</span><span class="token function">set_bit</span><span class="token punctuation">(</span>netmask<span class="token punctuation">,</span> <span class="token number">31</span><span class="token operator">-</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">return</span> netmask<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">calc_network_address</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> ip1<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> ip2<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> ip3<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span>  ip4<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> netmask_bits<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
          <span class="token class-name">uint32_t</span> netmask<span class="token operator">=</span><span class="token function">form_netmask</span><span class="token punctuation">(</span>netmask_bits<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token class-name">uint32_t</span> ip<span class="token operator">=</span><span class="token function">form_IP</span><span class="token punctuation">(</span>ip1<span class="token punctuation">,</span> ip2<span class="token punctuation">,</span> ip3<span class="token punctuation">,</span> ip4<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token class-name">uint32_t</span> netw_adr<span class="token punctuation">;</span>

          <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"netmask="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">print_as_IP</span> <span class="token punctuation">(</span>netmask<span class="token punctuation">)</span><span class="token punctuation">;</span>

          netw_adr<span class="token operator">=</span>ip<span class="token operator">&amp;</span>netmask<span class="token punctuation">;</span>

          <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"network address="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">print_as_IP</span> <span class="token punctuation">(</span>netw_adr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
          <span class="token function">calc_network_address</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 10.1.2.4, /24</span>
          <span class="token function">calc_network_address</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 10.1.2.4, /8</span>
          <span class="token function">calc_network_address</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 10.1.2.4, /25</span>
          <span class="token function">calc_network_address</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 10.1.2.4, /26</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr />
<p><code>msvs 2012 /Ob0ä¼˜åŒ–</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"> <span class="token number">1</span>  _ip1<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>              <span class="token comment">; size = 1</span>
 <span class="token number">2</span>  _ip2<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">12</span>             <span class="token comment">; size = 1</span>
 <span class="token number">3</span>  _ip3<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">16</span>             <span class="token comment">; size = 1</span>
 <span class="token number">4</span>  _ip4<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">20</span>             <span class="token comment">; size = 1</span>
 <span class="token number">5</span>  _netmask_bits<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">24</span>    <span class="token comment">; size = 1</span>
 <span class="token number">6</span>  _calc_network_address PROC
 <span class="token number">7</span>         push     <span class="token register variable">edi</span>
 <span class="token number">8</span>         push     DWORD PTR _netmask_bits<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">]</span>
 <span class="token number">9</span>         call     _form_netmask
<span class="token number">10</span>         push     OFFSET <span class="token operator">$</span>SG3045   <span class="token comment">; 'netmask='</span>
<span class="token number">11</span>         mov      <span class="token register variable">edi</span>, <span class="token register variable">eax</span>
<span class="token number">12</span>         call     DWORD PTR __imp__printf
<span class="token number">13</span>         push     <span class="token register variable">edi</span>
<span class="token number">14</span>         call     _print_as_IP
<span class="token number">15</span>         push     OFFSET <span class="token operator">$</span>SG3046   <span class="token comment">; 'network address='</span>
<span class="token number">16</span>         call     DWORD PTR __imp__printf
<span class="token number">17</span>         push     DWORD PTR _ip4<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">16</span><span class="token operator">]</span>
<span class="token number">18</span>         push     DWORD PTR _ip3<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">20</span><span class="token operator">]</span>
<span class="token number">19</span>         push     DWORD PTR _ip2<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">24</span><span class="token operator">]</span>
<span class="token number">20</span>         push     DWORD PTR _ip1<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">28</span><span class="token operator">]</span>
<span class="token number">21</span>         call     _form_IP
<span class="token number">22</span>         and      <span class="token register variable">eax</span>, <span class="token register variable">edi</span>         <span class="token comment">; network address = host address &amp; netmask</span>
<span class="token number">23</span>         push     <span class="token register variable">eax</span>
<span class="token number">24</span>         call     _print_as_IP
<span class="token number">25</span>         add      <span class="token register variable">esp</span>, <span class="token number">36</span>
<span class="token number">26</span>         pop      <span class="token register variable">edi</span>
<span class="token number">27</span>         ret      <span class="token number">0</span>
<span class="token number">28</span>  _calc_network_address ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>ç¬¬22è¡Œï¼Œ<code>and eaxï¼Œedi</code>æ˜¯å…³é”®è¿ç®—ï¼Œå³<code> network address = host address &amp; netmask</code></li>
</ul>
<hr />
<p>``form_IP()`å°†IPçš„å››ä¸ªå­—èŠ‚è½¬æ¢æˆä¸€ä¸ª32ä½æ•°å€¼</p>
<ol>
<li>ç»™è¿”å›å€¼åˆ†é…ä¸€ä¸ªå˜é‡å¹¶èµ‹å€¼ä¸º0</li>
<li>å–æ•°æƒæœ€ä½çš„ç¬¬4ä¸ªå­—èŠ‚ï¼Œä¸è¿”å›å€¼0è¿›è¡Œ<code>or</code>æ“ä½œå³å¯å¾—åˆ°å«ç¬¬4å­—èŠ‚ä¿¡æ¯çš„32ä½ç½®</li>
<li>å–ç¬¬3ä¸ªå­—èŠ‚ï¼Œå·¦ç§»8ä½ï¼Œä»¥ç”Ÿæˆ0x0000bb00ï¼ˆå…¶ä¸­bbå°±æ˜¯è¿™æ­¥è¯»å–çš„ç¬¬ä¸‰å­—èŠ‚ï¼‰è¿™ç§å½¢å¼çš„æ•°å€¼ã€‚æ­¤åä¸è¿”å›å€¼è¿›è¡ŒOR/æˆ–è¿ç®—ã€‚å¦‚æœä¸Šä¸€æ­¥çš„å€¼å¦‚æœæ˜¯0x000000aaçš„è¯ï¼Œåœ¨æ‰§è¡ŒORæˆ–æ“ä½œåï¼Œå°±ä¼šå¾—åˆ°0x0000bbaaè¿™æ ·çš„è¿”å›å€¼ã€‚</li>
<li>ä¾æ­¤ç±»æ¨ã€‚å–ç¬¬2ä¸ªå­—èŠ‚ï¼Œå·¦ç§»16ä½ï¼Œç”Ÿæˆ0x00cc0000è¿™æ ·ä¸€ä¸ªå«æœ‰ç¬¬2å­—èŠ‚çš„32ä½å€¼ï¼Œå†è¿›è¡ŒOR/æˆ–è¿ç®—ã€‚ç”±äºä»¥ä¸Šä¸€æ­¥çš„è¿”å›å€¼åº”å½“æ˜¯0x0000bbaaï¼Œå› æ­¤æœ¬æ¬¡è¿ç®—çš„ç»“æœä¼šæ˜¯0x00ccbbaaã€‚</li>
<li>åŒç†ã€‚å–æœ€é«˜ä½ï¼Œå·¦ç§»24ä½ï¼Œä»¥ç”Ÿæˆ0xdd000000è¿™æ ·ä¸€ä¸ªå«æœ‰ç¬¬ä¸€å­—èŠ‚ä¿¡æ¯çš„32ä½å€¼ï¼Œå†è¿›è¡ŒOR/æˆ–è¿ç®—ã€‚ç”±äºä¸Šä¸€æ­¥çš„è¿”å›å€¼æ˜¯0x00ccbbaaï¼Œå› æ­¤æœ€ç»ˆçš„ç»“æœçš„å€¼å°±æ˜¯0xddccbbaaè¿™æ ·çš„32ä½å€¼äº†ã€‚</li>
</ol>
<hr />
<p><code>msvs 2012 /Ox</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token comment">; denote ip1 as "dd", ip2 as "cc", ip3 as "bb", ip4 as "aa".</span>
_ip1<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>        <span class="token comment">; size = 1</span>
_ip2<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">12</span>       <span class="token comment">; size = 1</span>
_ip3<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">16</span>       <span class="token comment">; size = 1</span>
_ip4<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">20</span>       <span class="token comment">; size = 1</span>
_form_IP PROC
        movzx   <span class="token register variable">eax</span>, BYTE PTR _ip1<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
        <span class="token comment">; EAX=000000dd</span>
        movzx   <span class="token register variable">ecx</span>, BYTE PTR _ip2<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
        <span class="token comment">; ECX=000000cc</span>
        shl     <span class="token register variable">eax</span>, <span class="token number">8</span>
        <span class="token comment">; EAX=0000dd00</span>
        or      <span class="token register variable">eax</span>, <span class="token register variable">ecx</span>
        <span class="token comment">; EAX=0000ddcc</span>
        movzx   <span class="token register variable">ecx</span>, BYTE PTR _ip3<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
        <span class="token comment">; ECX=000000bb</span>
        shl     <span class="token register variable">eax</span>, <span class="token number">8</span>
        <span class="token comment">; EAX=00ddcc00</span>
        or      <span class="token register variable">eax</span>, <span class="token register variable">ecx</span>
        <span class="token comment">; EAX=00ddccbb</span>
        movzx   <span class="token register variable">ecx</span>, BYTE PTR _ip4<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
        <span class="token comment">; ECX=000000aa</span>
        shl     <span class="token register variable">eax</span>, <span class="token number">8</span>
        <span class="token comment">; EAX=ddccbb00</span>
        or      <span class="token register variable">eax</span>, <span class="token register variable">ecx</span>
        <span class="token comment">; EAX=ddccbbaa</span>
        ret     <span class="token number">0</span>
_form_IP ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>è¿™é‡Œè¿›è¡Œäº†ä¼˜åŒ–ï¼Œä¸å¸¸è§„è¿‡ç¨‹ç•¥æœ‰ä¸€ç‚¹ä¸åŒ</li>
<li>è¿™ä¸ªå®ç°è¿‡ç¨‹å¯ä»¥æè¿°ä¸º:æ¯ä¸ªå­—èŠ‚éƒ½å†™å…¥åˆ°å…¶è¿”å›å€¼çš„æœ€ä½8ä¸ªæ¯”ç‰¹ä½ï¼Œå¹¶ä¸”EAXæ¯æ¬¡å·¦ç§»ä¸€ä¸ªå­—èŠ‚ï¼Œå¹¶ä¸å…¶åšå¼‚æˆ–æ“ä½œï¼Œé‡å¤4æ¬¡</li>
</ul>
<hr />
<p><code>print_as_IP()</code></p>
<p><code>MSVS 2010 /Ob0</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_a<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>          <span class="token comment">; size = 4</span>
_print_as_IP PROC
         mov     <span class="token register variable">ecx</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
         <span class="token comment">; ECX=ddccbbaa</span>
         movzx   <span class="token register variable">eax</span>, <span class="token register variable">cl</span>
         <span class="token comment">; EAX=000000aa</span>
         push    <span class="token register variable">eax</span>
         mov     <span class="token register variable">eax</span>, <span class="token register variable">ecx</span>
         <span class="token comment">; EAX=ddccbbaa</span>
         shr     <span class="token register variable">eax</span>, <span class="token number">8</span>
         <span class="token comment">; EAX=00ddccbb</span>
         and     <span class="token register variable">eax</span>, <span class="token number">255</span>
         <span class="token comment">; EAX=000000bb</span>
         push    <span class="token register variable">eax</span>
         mov     <span class="token register variable">eax</span>, <span class="token register variable">ecx</span>
         <span class="token comment">; EAX=ddccbbaa</span>
         shr     <span class="token register variable">eax</span>, <span class="token number">16</span>
         <span class="token comment">; EAX=0000ddcc</span>
         and     <span class="token register variable">eax</span>, <span class="token number">255</span>
         <span class="token comment">; EAX=000000cc</span>
         push    <span class="token register variable">eax</span>
         <span class="token comment">; ECX=ddccbbaa</span>
         shr     <span class="token register variable">ecx</span>, <span class="token number">24</span>
         <span class="token comment">; ECX=000000dd</span>
         push    <span class="token register variable">ecx</span>
         push    OFFSET <span class="token operator">$</span>SG3020 <span class="token comment">; '%d.%d.%d.%d'</span>
         call    DWORD PTR __imp__printf
         add     <span class="token register variable">esp</span>, <span class="token number">20</span>
         ret     <span class="token number">0</span>
_print_as_IP ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>ä¸ä¸Šæ–‡ç›¸åï¼Œå°†ä¸€ä¸ª32ä½çš„æ•°å€¼åˆ‡åˆ†ç§°4ä¸ªå­—èŠ‚ï¼Œåªéœ€è¦å°†è¾“å…¥çš„æ•°å€¼åˆ†åˆ«ä½ç§»24ä½ï¼Œ16ä½ï¼Œ8ä½ï¼Œ0ä½</li>
<li>è¿™é‡Œä¸éä¼˜åŒ–è¿‡ç¨‹çš„åŒºåˆ«åœ¨äº<mark>ä¸ä¼šé‡æ–°åŠ è½½è¾“å…¥å€¼</mark></li>
</ul>
<hr />
<p><code>form_netmask()å‡½æ•°å’Œset_bit()å‡½æ•°</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_input<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>          <span class="token comment">; size = 4</span>
_bit<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">12</span>           <span class="token comment">; size = 4</span>
_set_bit PROC
        mov     <span class="token register variable">ecx</span>, DWORD PTR _bit<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
        mov     <span class="token register variable">eax</span>, <span class="token number">1</span>
        shl     <span class="token register variable">eax</span>, <span class="token register variable">cl</span>
        or      <span class="token register variable">eax</span>, DWORD PTR _input<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
        ret     <span class="token number">0</span>
_set_bit ENDP

_netmask_bits<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>                <span class="token comment">; size = 1</span>
_form_netmask PROC
        push    <span class="token register variable">ebx</span>
        push    <span class="token register variable">esi</span>
        movzx   <span class="token register variable">esi</span>, BYTE PTR _netmask_bits<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>
        xor     <span class="token register variable">ecx</span>, <span class="token register variable">ecx</span>
        xor     <span class="token register variable">bl</span>, <span class="token register variable">bl</span>
        test    <span class="token register variable">esi</span>, <span class="token register variable">esi</span>
        jle     SHORT <span class="token operator">$</span>LN9@form_netma
        xor     <span class="token register variable">edx</span>, <span class="token register variable">edx</span>
<span class="token label function">$LL3@form_netma:</span>
        mov     <span class="token register variable">eax</span>, <span class="token number">31</span>
        sub     <span class="token register variable">eax</span>, <span class="token register variable">edx</span>
        push    <span class="token register variable">eax</span>
        push    <span class="token register variable">ecx</span>
        call    _set_bit
        inc     <span class="token register variable">bl</span>
        movzx   <span class="token register variable">edx</span>, <span class="token register variable">bl</span>
        add     <span class="token register variable">esp</span>, <span class="token number">8</span>
        mov     <span class="token register variable">ecx</span>, <span class="token register variable">eax</span>
        cmp     <span class="token register variable">edx</span>, <span class="token register variable">esi</span>
        jl      SHORT <span class="token operator">$</span>LL3@form_netma
<span class="token label function">$LN9@form_netma:</span>
        pop     <span class="token register variable">esi</span>
        mov     <span class="token register variable">eax</span>, <span class="token register variable">ecx</span>
        pop     <span class="token register variable">ebx</span>
        ret     <span class="token number">0</span>
_form_netmask ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>set_bit()å‡½æ•°çš„åŠŸèƒ½ååˆ†å•ä¸€ã€‚å®ƒå°†è¾“å…¥å€¼å·¦ç§»æ—¢å®šçš„æ¯”ç‰¹ä½ï¼Œæ¥ç€å°†ä½ç§»è¿ç®—çš„ç»“æœä¸è¾“å…¥å€¼è¿›è¡Œæˆ–ORè¿ç®—ã€‚è€Œåform_mask()å‡½æ•°é€šè¿‡å¾ªç¯è¯­å¥é‡å¤è°ƒç”¨set_bit()å‡½æ•°ï¼Œå€ŸåŠ©å¾ªç¯æ§åˆ¶å˜é‡netmask_bitsè®¾ç½®å­ç½‘æ©ç é‡Œæ•°å€¼ä¸º1çš„å„ä¸ªæ¯”ç‰¹ä½ã€‚</p>
<h3 id="chap39-å¾ªç¯å‡ ä¸ªè¿­ä»£"><a class="markdownIt-Anchor" href="#chap39-å¾ªç¯å‡ ä¸ªè¿­ä»£"></a> Chap39 å¾ªç¯ï¼šå‡ ä¸ªè¿­ä»£ï¼Ÿ</h3>
<p><em>å¤šæ•°å¾ªç¯è¯­å¥åªæœ‰ä¸€ä¸ªè¿­ä»£å™¨ï¼Œä½†æ˜¯åœ¨æ±‡ç¼–å±‚é¢ï¼Œä¸€ä¸ªè¿­ä»£å™¨ä¹Ÿå¯èƒ½å¯¹åº”å¤šä¸ªæ•°æ®å®ä½“</em></p>
<p>ä¾‹å¦‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">void</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>a1<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>a2<span class="token punctuation">,</span> <span class="token class-name">size_t</span> cnt<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
       <span class="token class-name">size_t</span> i<span class="token punctuation">;</span>

       <span class="token comment">// copy from one array to another in some weird scheme</span>
       <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>cnt<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
              a1<span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span>a2<span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ¯æ¬¡è¿­ä»£éƒ½æœ‰ä¸¤æ¬¡ä¹˜æ³•ï¼Œè¿™æ˜¯å¾ˆè€—æ—¶çš„è®¡ç®—ï¼Œå¦‚æœç»†çœ‹ç¨‹åºä»£ç ï¼Œå¯ä»¥å‘ç°ç¨‹åºä¸­çš„çŸ©é˜µçš„å‚æ•°æ˜¯è·³è·ƒçš„ï¼Œæˆ‘ä»¬èƒ½æ¯”è¾ƒå®¹æ˜“åœ°ä¸ç”¨ä¹˜æ³•å°†å®ƒè®¡ç®—å‡ºæ¥</p>
<hr />
<p><code>msvs 2013 x64</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">f        PROC
<span class="token comment">; RDX=a1</span>
<span class="token comment">; RCX=a2</span>
<span class="token comment">; R8=cnt</span>
         test      <span class="token register variable">r8</span>, <span class="token register variable">r8</span>         <span class="token comment">; cnt==0? exit then</span>
         je        SHORT <span class="token operator">$</span>LN1@f
         npad      <span class="token number">11</span>
<span class="token label function">$LL3@f:</span>
         mov       <span class="token register variable">eax</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">rdx</span><span class="token operator">]</span><span class="token comment">;eax=a1</span>
         lea       <span class="token register variable">rcx</span>, QWORD PTR <span class="token operator">[</span><span class="token register variable">rcx</span><span class="token operator">+</span><span class="token number">12</span><span class="token operator">]</span><span class="token comment">;a2=a2[i+3]</span>
         lea       <span class="token register variable">rdx</span>, QWORD PTR <span class="token operator">[</span><span class="token register variable">rdx</span><span class="token operator">+</span><span class="token number">28</span><span class="token operator">]</span><span class="token comment">;a1=a1[i+7]</span>
         mov       DWORD PTR <span class="token operator">[</span><span class="token register variable">rcx</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">]</span>, <span class="token register variable">eax</span><span class="token comment">;a2=a1</span>
         dec       <span class="token register variable">r8</span><span class="token comment">;r8--</span>
         jne       SHORT <span class="token operator">$</span>LL3@f
<span class="token label function">$LN1@f:</span>
         ret       <span class="token number">0</span>
f        ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™é‡Œæœ‰ä¸‰ä¸ªè¿­ä»£å˜é‡ï¼Œåˆ†åˆ«æ˜¯<code>cnt</code>å˜é‡ï¼Œä»¥åŠä¸¤ä¸ªæ•°åˆ—å‚æ•°ï¼Œæ•°åˆ—å‚æ•°æ¯æ¬¡è¿­ä»£éƒ½å¢åŠ <code>12</code>æˆ–è€…<code>28</code></p>
<p>å¯ä»¥ç”¨Cè¯­è¨€é‡å†™ä»£ç </p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>a1<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>a2<span class="token punctuation">,</span> <span class="token class-name">size_t</span> cnt<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        <span class="token class-name">size_t</span> i<span class="token punctuation">;</span>
        <span class="token class-name">size_t</span> idx1<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> idx2<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment">// copy from one array to another in some weird scheme</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>cnt<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
               a1<span class="token punctuation">[</span>idx1<span class="token punctuation">]</span><span class="token operator">=</span>a2<span class="token punctuation">[</span>idx2<span class="token punctuation">]</span><span class="token punctuation">;</span>
               idx1<span class="token operator">+=</span><span class="token number">3</span><span class="token punctuation">;</span>
               idx2<span class="token operator">+=</span><span class="token number">7</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>è¿™ä¸ªç¨‹åºå¯åœ¨æ¯æ¬¡è¿­ä»£æ›´æ–°3ä¸ªè¿­ä»£å‚æ•°ï¼Œè€Œä¸æ˜¯1ä¸ªã€‚å¦å¤–ï¼Œç¼–è¯‘å™¨å˜ç›¸å®ç°äº†ä¸¤ä¸ªä¹˜æ³•æ“ä½œã€‚</code></p>
<hr />
<p><code>GCC 4.9</code>åšçš„æ›´å¥½ï¼Œåªæœ‰ä¸¤ä¸ªè¿­ä»£</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token comment">; RDI=a1</span>
<span class="token comment">; RSI=a2</span>
<span class="token comment">; RDX=cnt</span>
<span class="token label function">f:</span>
        test     <span class="token register variable">rdx</span>, <span class="token register variable">rdx</span> <span class="token comment">; cnt==0? exit then</span>
        je       .L1
<span class="token comment">; calculate last element address in "a2" and leave it in RDX</span>
        lea      <span class="token register variable">rax</span>, <span class="token operator">[</span><span class="token number">0</span><span class="token operator">+</span><span class="token register variable">rdx</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>
<span class="token comment">; RAX=RDX*4=cnt*4</span>
        sal      <span class="token register variable">rdx</span>, <span class="token number">5</span>
<span class="token comment">; RDX=RDX&lt;&lt;5=cnt*32</span>
        sub      <span class="token register variable">rdx</span>, <span class="token register variable">rax</span>
<span class="token comment">; RDX=RDX-RAX=cnt*32-cnt*4=cnt*28</span>
        add      <span class="token register variable">rdx</span>, <span class="token register variable">rsi</span>
<span class="token comment">; RDX=RDX+RSI=a2+cnt*28</span>
<span class="token label function">.L3:</span>
        mov      <span class="token register variable">eax</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">rsi</span><span class="token operator">]</span>
        add      <span class="token register variable">rsi</span>, <span class="token number">28</span>
        add      <span class="token register variable">rdi</span>, <span class="token number">12</span>
        mov      DWORD PTR <span class="token operator">[</span><span class="token register variable">rdi</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">]</span>, <span class="token register variable">eax</span>
        cmp      <span class="token register variable">rsi</span>, <span class="token register variable">rdx</span>
        jne      .L3
<span class="token label function">.L1:</span>
        rep ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>è¿™é‡Œ<code>counter</code>ç›´æ¥æ²¡äº†</li>
<li>æ•°ç»„<code>a2</code>çš„æœ€åä¸€ä¸ªå‚æ•°åœ¨å¾ªç¯å¼€å§‹å‰å°±å·²ç»è®¡ç®—å¥½äº†(cnt*7)</li>
<li>å¾ªç¯ç»“æŸçš„æ¡ä»¶ç›´æ¥æ˜¯å¯é¢„å…ˆè®¡ç®—çš„ä¸´ç•Œç´¢å¼•</li>
</ul>
<p>é‡å†™åçš„Cä»£ç å¦‚ä¸‹</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">void</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>a1<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>a2<span class="token punctuation">,</span> <span class="token class-name">size_t</span> cnt<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        <span class="token class-name">size_t</span> i<span class="token punctuation">;</span>
        <span class="token class-name">size_t</span> idx1<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> idx2<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token class-name">size_t</span> last_idx2<span class="token operator">=</span>cnt<span class="token operator">*</span><span class="token number">7</span><span class="token punctuation">;</span>

        <span class="token comment">// copy from one array to another in some weird scheme</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
                a1<span class="token punctuation">[</span>idx1<span class="token punctuation">]</span><span class="token operator">=</span>a2<span class="token punctuation">[</span>idx2<span class="token punctuation">]</span><span class="token punctuation">;</span>
                idx1<span class="token operator">+=</span><span class="token number">3</span><span class="token punctuation">;</span>
                idx2<span class="token operator">+=</span><span class="token number">7</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>idx2<span class="token operator">==</span>last_idx2<span class="token punctuation">)</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr />
<p><code>INTEL C++ 2011å®ä¾‹</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">f        PROC
<span class="token comment">; parameter 1: rcx = a1</span>
<span class="token comment">; parameter 2: rdx = a2</span>
<span class="token comment">; parameter 3: r8 = cnt</span>
<span class="token label function">.B1.1:</span>:                               <span class="token comment">; Preds .B1.0</span>
         test        <span class="token register variable">r8</span>, <span class="token register variable">r8</span>                                       <span class="token comment">;8.14</span>
         jbe         exit             <span class="token comment">; Prob 50%                  ;8.14</span>
                                      <span class="token comment">; LOE rdx rcx rbx rbp rsi rdi r8 r12 r13 r14 r15 xmm6 xmm7 xmm8 â†™</span>
    â†˜ <span class="token register variable">xmm9</span> <span class="token register variable">xmm10</span> <span class="token register variable">xmm11</span> <span class="token register variable">xmm12</span> <span class="token register variable">xmm13</span> <span class="token register variable">xmm14</span> <span class="token register variable">xmm15</span>
<span class="token label function">.B1.2:</span>:                               <span class="token comment">; Preds .B1.1</span>
         cmp         <span class="token register variable">r8</span>, <span class="token number">6</span>                                        <span class="token comment">;8.2</span>
         jbe         just_copy        <span class="token comment">; Prob 50%                  ;8.2</span>
                                      <span class="token comment">; LOE rdx rcx rbx rbp rsi rdi r8 r12 r13 r14 r15 xmm6 xmm7 xmm8 â†™</span>
    â†˜ <span class="token register variable">xmm9</span> <span class="token register variable">xmm10</span> <span class="token register variable">xmm11</span> <span class="token register variable">xmm12</span> <span class="token register variable">xmm13</span> <span class="token register variable">xmm14</span> <span class="token register variable">xmm15</span>
<span class="token label function">.B1.3:</span>:                              <span class="token comment">; Preds .B1.2</span>
         cmp         <span class="token register variable">rcx</span>, <span class="token register variable">rdx</span>                                     <span class="token comment">;9.11</span>
         jbe         .B1<span class="token number">.5</span>ã€€         <span class="token comment">; Prob 50%                   ;9.11</span>
                                     <span class="token comment">; LOE rdx rcx rbx rbp rsi rdi r8 r12 r13 r14 r15 xmm6 xmm7 xmm8 â†™</span>
    â†˜ <span class="token register variable">xmm9</span> <span class="token register variable">xmm10</span> <span class="token register variable">xmm11</span> <span class="token register variable">xmm12</span> <span class="token register variable">xmm13</span> <span class="token register variable">xmm14</span> <span class="token register variable">xmm15</span>
<span class="token label function">.B1.4:</span>:                              <span class="token comment">; Preds .B1.3</span>
         mov         <span class="token register variable">r10</span>, <span class="token register variable">r8</span>                                      <span class="token comment">;9.11</span>
         mov         <span class="token register variable">r9</span>, <span class="token register variable">rcx</span>                                      <span class="token comment">;9.11</span>
         shl         <span class="token register variable">r10</span>, <span class="token number">5</span>                                       <span class="token comment">;9.11</span>
         lea         <span class="token register variable">rax</span>, QWORD PTR <span class="token operator">[</span><span class="token register variable">r8</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>                        <span class="token comment">;9.11</span>
         sub         <span class="token register variable">r9</span>, <span class="token register variable">rdx</span>                                      <span class="token comment">;9.11</span>
         sub         <span class="token register variable">r10</span>, <span class="token register variable">rax</span>                                     <span class="token comment">;9.11</span>
         cmp         <span class="token register variable">r9</span>, <span class="token register variable">r10</span>                                      <span class="token comment">;9.11</span>
         jge         just_copy2      <span class="token comment">; Prob 50%                   ;9.11</span>
                                     <span class="token comment">; LOE rdx rcx rbx rbp rsi rdi r8 r12 r13 r14 r15 xmm6 xmm7 xmm8 â†™</span>
    â†˜ <span class="token register variable">xmm9</span> <span class="token register variable">xmm10</span> <span class="token register variable">xmm11</span> <span class="token register variable">xmm12</span> <span class="token register variable">xmm13</span> <span class="token register variable">xmm14</span> <span class="token register variable">xmm15</span>
<span class="token label function">.B1.5:</span>:                              <span class="token comment">; Preds .B1.3 .B1.4</span>
         cmp         <span class="token register variable">rdx</span>, <span class="token register variable">rcx</span>                                     <span class="token comment">;9.11</span>
         jbe         just_copy       <span class="token comment">; Prob 50%                   ;9.11</span>
                                     <span class="token comment">; LOE rdx rcx rbx rbp rsi rdi r8 r12 r13 r14 r15 xmm6 xmm7 xmm8 â†™</span>
    â†˜ <span class="token register variable">xmm9</span> <span class="token register variable">xmm10</span> <span class="token register variable">xmm11</span> <span class="token register variable">xmm12</span> <span class="token register variable">xmm13</span> <span class="token register variable">xmm14</span> <span class="token register variable">xmm15</span>
<span class="token label function">.B1.6:</span>:                              <span class="token comment">; Preds .B1.5</span>
         mov         <span class="token register variable">r9</span>, <span class="token register variable">rdx</span>                                      <span class="token comment">;9.11</span>
         lea         <span class="token register variable">rax</span>, QWORD PTR <span class="token operator">[</span><span class="token register variable">r8</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">]</span>                        <span class="token comment">;9.11</span>
         sub         <span class="token register variable">r9</span>, <span class="token register variable">rcx</span>                                      <span class="token comment">;9.11</span>
         lea         <span class="token register variable">r10</span>, QWORD PTR <span class="token operator">[</span><span class="token register variable">rax</span><span class="token operator">+</span><span class="token register variable">r8</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>                    <span class="token comment">;9.11</span>
         cmp         <span class="token register variable">r9</span>, <span class="token register variable">r10</span>                                      <span class="token comment">;9.11</span>
         jl          just_copy       <span class="token comment">; Prob 50%                   ;9.11</span>
                                     <span class="token comment">; LOE rdx rcx rbx rbp rsi rdi r8 r12 r13 r14 r15 xmm6 xmm7 xmm8 â†™</span>
    â†˜ <span class="token register variable">xmm9</span> <span class="token register variable">xmm10</span> <span class="token register variable">xmm11</span> <span class="token register variable">xmm12</span> <span class="token register variable">xmm13</span> <span class="token register variable">xmm14</span> <span class="token register variable">xmm15</span>
<span class="token label function">just_copy2:</span>:                         <span class="token comment">; Preds .B1.4 .B1.6</span>
<span class="token comment">; R8 = cnt</span>
<span class="token comment">; RDX = a2</span>
<span class="token comment">; RCX = a1</span>
         xor        <span class="token register variable">r10d</span>, <span class="token register variable">r10d</span>                                    <span class="token comment">;8.2</span>
         xor        <span class="token register variable">r9d</span>, <span class="token register variable">r9d</span>                                      <span class="token comment">;</span>
         xor        <span class="token register variable">eax</span>, <span class="token register variable">eax</span>                                      <span class="token comment">;</span>
                                     <span class="token comment">; LOE rax rdx rcx rbx rbp rsi rdi r8 r9 r10 r12 r13 r14 r15 xmm6 xmm7 â†™</span>
    â†˜ <span class="token register variable">xmm8</span> <span class="token register variable">xmm9</span> <span class="token register variable">xmm10</span> <span class="token register variable">xmm11</span> <span class="token register variable">xmm12</span> <span class="token register variable">xmm13</span> <span class="token register variable">xmm14</span> <span class="token register variable">xmm15</span>
<span class="token label function">.B1.8:</span>:                              <span class="token comment">; Preds .B1.8 just_copy2</span>
         mov        <span class="token register variable">r11d</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">rax</span><span class="token operator">+</span><span class="token register variable">rdx</span><span class="token operator">]</span>                     <span class="token comment">;3.6</span>
         inc        <span class="token register variable">r10</span>                                           <span class="token comment">;8.2</span>
         mov        DWORD PTR <span class="token operator">[</span><span class="token register variable">r9</span><span class="token operator">+</span><span class="token register variable">rcx</span><span class="token operator">]</span>, <span class="token register variable">r11d</span>                      <span class="token comment">;3.6</span>
         add        <span class="token register variable">r9</span>, <span class="token number">12</span>                                        <span class="token comment">;8.2</span>
         add        <span class="token register variable">rax</span>, <span class="token number">28</span>                                       <span class="token comment">;8.2</span>
         cmp        <span class="token register variable">r10</span>, <span class="token register variable">r8</span>                                       <span class="token comment">;8.2</span>
         jb         .B1<span class="token number">.8</span>             <span class="token comment">; Prob 82%                  ;8.2</span>
         jmp        exit              <span class="token comment">; Prob 100%                 ;8.2</span>
                                      <span class="token comment">; LOE rax rdx rcx rbx rbp rsi rdi r8 r9 r10 r12 r13 r14 r15 xmm6 xmm7 â†™</span>
    â†˜ <span class="token register variable">xmm8</span> <span class="token register variable">xmm9</span> <span class="token register variable">xmm10</span> <span class="token register variable">xmm11</span> <span class="token register variable">xmm12</span> <span class="token register variable">xmm13</span> <span class="token register variable">xmm14</span> <span class="token register variable">xmm15</span>
<span class="token label function">just_copy:</span>:                           <span class="token comment">; Preds .B1.2 .B1.5 .B1.6</span>
<span class="token comment">; R8 = cnt</span>
<span class="token comment">; RDX = a2</span>
<span class="token comment">; RCX = a1</span>
         xor        <span class="token register variable">r10d</span>, <span class="token register variable">r10d</span>                                    <span class="token comment">;8.2</span>
         xor        <span class="token register variable">r9d</span>, <span class="token register variable">r9d</span>                                      <span class="token comment">;</span>
         xor        <span class="token register variable">eax</span>, <span class="token register variable">eax</span>                                      <span class="token comment">;</span>
                                      <span class="token comment">; LOE rax rdx rcx rbx rbp rsi rdi r8 r9 r10 r12 r13 r14 r15 xmm6 â†™</span>
    â†˜ <span class="token register variable">xmm7</span> <span class="token register variable">xmm8</span> <span class="token register variable">xmm9</span> <span class="token register variable">xmm10</span> <span class="token register variable">xmm11</span> <span class="token register variable">xmm12</span> <span class="token register variable">xmm13</span> <span class="token register variable">xmm14</span> <span class="token register variable">xmm15</span>
<span class="token label function">.B1.11:</span>:                              <span class="token comment">; Preds .B1.11 just_copy</span>
         mov        <span class="token register variable">r11d</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">rax</span><span class="token operator">+</span><span class="token register variable">rdx</span><span class="token operator">]</span>                     <span class="token comment">;3.6</span>
         inc        <span class="token register variable">r10</span>                                           <span class="token comment">;8.2</span>
         mov        DWORD PTR <span class="token operator">[</span><span class="token register variable">r9</span><span class="token operator">+</span><span class="token register variable">rcx</span><span class="token operator">]</span>, <span class="token register variable">r11d</span>                      <span class="token comment">;3.6</span>
         add        <span class="token register variable">r9</span>, <span class="token number">12</span>                                        <span class="token comment">;8.2</span>
         add        <span class="token register variable">rax</span>, <span class="token number">28</span>                                       <span class="token comment">;8.2</span>
         cmp        <span class="token register variable">r10</span>, <span class="token register variable">r8</span>                                       <span class="token comment">;8.2</span>
         jb         .B1<span class="token number">.11</span>             <span class="token comment">; Prob 82%                 ;8.2</span>
                                       <span class="token comment">; LOE rax rdx rcx rbx rbp rsi rdi r8 r9 r10 r12 r13 r14 r15 xmm6 â†™</span>
    â†˜ <span class="token register variable">xmm7</span> <span class="token register variable">xmm8</span> <span class="token register variable">xmm9</span> <span class="token register variable">xmm10</span> <span class="token register variable">xmm11</span> <span class="token register variable">xmm12</span> <span class="token register variable">xmm13</span> <span class="token register variable">xmm14</span> <span class="token register variable">xmm15</span>
<span class="token label function">exit:</span>:                                 <span class="token comment">; Preds .B1.11 .B1.8 .B1.1</span>
         ret                                                      <span class="token comment">;10.1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>ä¸Šè¿°ç¨‹åºé¦–å…ˆæ ¹æ®è¾“å…¥å‚æ•°ç¡®å®šåˆ†æ”¯ï¼Œæ¥ç€æ‰§è¡Œç›¸åº”çš„ä¾‹ç¨‹ã€‚è™½ç„¶å®ƒçœ‹èµ·æ¥å°±åƒæ˜¯æ£€æŸ¥æ•°ç»„äº¤å‰åˆ†å‰ï¼Œä½†æ˜¯ç¼–è¯‘å™¨é‡‡ç”¨çš„æ˜¯ä¸€ç§éå¸¸è‘—åçš„å†…å­˜å—å¤åˆ¶ä¾‹ç¨‹(å…¶å®æ¯å—å®ç°çš„åŠŸèƒ½è²Œä¼¼æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯å®ç°æ–¹æ³•ä¸å¤ªä¸€æ ·ï¼Œè¿™é‡Œè®¡ç®—äº†æ¦‚ç‡)çš„ä¼˜åŒ–æ–¹æ³•ã€‚ä»”ç»†åˆ†æå°±ä¼šå‘ç°ï¼Œå®ƒæ‰€å¤åˆ¶çš„ä¾‹ç¨‹å±…ç„¶å®Œå…¨ç›¸åŒã€‚è¿™æˆ–è®¸æ˜¯Intel C++ç¼–è¯‘å™¨çš„æŸç§ä¸è¶³å§ã€‚ç„¶è€Œæ— è®ºæ€æ ·ï¼Œæœ€åç”Ÿæˆçš„ç¨‹åºåŠŸèƒ½æ­£å¸¸ã€‚</li>
<li>è™½ç„¶å¾ˆå¤æ‚ï¼Œä½†æ˜¯è¿˜æ˜¯èƒ½å®ç°åŠŸèƒ½(åŸºæœ¬ä¸Šåªç”¨åˆ†æä¸€ä¸ªå—å°±èƒ½å¤§æ¦‚çŸ¥é“åŠŸèƒ½äº†)</li>
</ul>
<h3 id="chap40-è¾¾å¤«è£…ç½®"><a class="markdownIt-Anchor" href="#chap40-è¾¾å¤«è£…ç½®"></a> Chap40 è¾¾å¤«è£…ç½®</h3>
<p>è¾¾å¤«è£…ç½®æ˜¯ä¸€ç§ç»¼åˆäº†å¤šç§æ§åˆ¶è¯­å¥çš„å¾ªç¯å±•å¼€æŠ€æœ¯ï¼Œå¯å¤§å¹…åº¦åœ°å‡å°‘ä»£ç çš„åˆ†æ”¯æ€»æ•°ã€‚</p>
<p>è¿™ç§å¾ªç¯å±•å¼€æŠ€æœ¯å·§å¦™åœ°åˆ©ç”¨äº†swtichè¯­å¥çš„æ»‘æ¢¯ï¼ˆfallthroughï¼‰æ•ˆåº”ã€‚</p>
<p>æœ¬ç« å¯¹Tom Duffçš„åŸå§‹ç¨‹åºè¿›è¡Œäº†è½»åº¦ç®€åŒ–ã€‚</p>
<p><em>ç°åœ¨å‡è®¾æˆ‘ä»¬è¦ç¼–å†™ä¸€ä¸ªæ¸…é™¤ä¸€å—è¿ç»­å†…å­˜çš„å‡½æ•°ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¾ªç¯è¯­å¥ã€é€ä¸ªå­—èŠ‚çš„å¤å†™æ•°æ®ã€‚ä½†æ˜¯ç°ä»£çš„è®¡ç®—æœºå†…å­˜æ€»çº¿éƒ½å¾ˆå®½ï¼Œä»¥å­—èŠ‚ä¸ºå•ä½åœ°æ¸…é™¤æ•ˆç‡ä¼šéå¸¸ä½ã€‚è‹¥ä»¥4å­—èŠ‚æˆ–8å­—èŠ‚ä¸ºæ“ä½œå•ä½è¿›è¡Œioæ“ä½œï¼Œé‚£ä¹ˆæ“ä½œæ•ˆç‡ä¼šé«˜ä¸€äº›ã€‚ç”±äºæœ¬ä¾‹æ¼”ç¤ºçš„æ˜¯64ä½åº”ç”¨ç¨‹åºï¼Œæ‰€ä»¥æˆ‘ä»¬å°±ä»¥8å­—èŠ‚ä¸ºå•ä½è¿›è¡Œæ“ä½œï¼Œä¸è¿‡ï¼Œæˆ‘ä»¬åˆå½“å¦‚ä½•åº”å¯¹é‚£äº›ä¸è¶³8å­—èŠ‚çš„å†…å­˜ç©ºé—´ï¼Ÿæ¯•ç«Ÿæˆ‘ä»¬çš„å‡½æ•°ä¹Ÿå¯èƒ½æ¸…é™¤å®¹é‡ä¸è¶³8å­—èŠ‚çš„å†…å­˜ç©ºé—´</em></p>
<p>åˆç†çš„ç®—æ³•</p>
<ul>
<li>é¦–å…ˆç»Ÿè®¡ç›®æ ‡ç©ºé—´å«æœ‰å¤šå°‘ä¸ªè¿ç»­çš„8å­—èŠ‚ç©ºé—´ï¼Œç»§è€Œä»¥8å­—èŠ‚ä¸ºæ“ä½œå•ä½å°†å…¶æ¸…é™¤</li>
<li>ç„¶åç»Ÿè®¡é‚£äº›å¤§å°ä¸è¶³8å­—èŠ‚çš„å°¾æ•°ï¼Œå³ä¸Šä¸€æ­¥é™¤æ³•è®¡ç®—çš„ä½™æ•°ï¼Œç„¶åé€å­—èŠ‚åœ°å°†ä¹‹æ¸…é›¶</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">void</span> <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span> dst<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
         <span class="token keyword">int</span> i<span class="token punctuation">;</span>

         <span class="token keyword">if</span> <span class="token punctuation">(</span>count<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">~</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                  <span class="token comment">// work out 8-byte blocks</span>
                  <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>count<span class="token operator">>></span><span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
                  <span class="token punctuation">&#123;</span>
                           <span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span><span class="token operator">*</span><span class="token punctuation">)</span>dst<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
                           dst<span class="token operator">=</span>dst<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">;</span>
                  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

         <span class="token comment">// work out the tail</span>
         <span class="token keyword">switch</span><span class="token punctuation">(</span>count <span class="token operator">&amp;</span> <span class="token number">7</span><span class="token punctuation">)</span>
         <span class="token punctuation">&#123;</span>
         <span class="token keyword">case</span> <span class="token number">7</span><span class="token operator">:</span> <span class="token operator">*</span>dst<span class="token operator">++</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
         <span class="token keyword">case</span> <span class="token number">6</span><span class="token operator">:</span> <span class="token operator">*</span>dst<span class="token operator">++</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
         <span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span> <span class="token operator">*</span>dst<span class="token operator">++</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
         <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span> <span class="token operator">*</span>dst<span class="token operator">++</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
         <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span> <span class="token operator">*</span>dst<span class="token operator">++</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
         <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> <span class="token operator">*</span>dst<span class="token operator">++</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
         <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token operator">*</span>dst<span class="token operator">++</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
         <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span> <span class="token comment">// do nothing</span>
                  <span class="token keyword">break</span><span class="token punctuation">;</span>
         <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>ç¬¬ä¸€éƒ¨åˆ†æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯ç”¨64ä½çš„é›¶å¡«å……æ‰€æœ‰8å­—èŠ‚çš„å†…å­˜å—</li>
<li>ç¬¬äºŒéƒ¨åˆ†çš„éš¾ç‚¹åœ¨äºå…¶å¾ªç¯å±•å¼€æŠ€æœ¯ï¼Œåˆ©ç”¨äº†<code>Switch</code>å‡½æ•°çš„æ»‘æ¢¯æ•ˆåº”ï¼ŒåŠŸèƒ½å°±æ˜¯å°†å˜é‡<code>count</code>ä¸æ•°å­—7è¿›è¡Œé€»è¾‘ä¸è¿ç®—ï¼Œå¾—åˆ°å°¾æ•°ï¼Œç„¶åæŠŠä»–ä»¬é€ä¸ªæ¸…é›¶ã€‚å¦‚æœå°¾æ•°ä¸º0ï¼Œé‚£ä¹ˆç›´æ¥è·³è½¬è‡³å‡½æ•°å°¾å£°</li>
<li>è¾¾å¤«è£…ç½®å°±æ˜¯å¾ªç¯å±•å¼€æŠ€æœ¯çš„ä¸€ç§ç‰¹ä¾‹ã€‚åœ¨è€å¼è®¾å¤‡ä¸Šï¼Œå®ƒæ˜¾ç„¶æ¯”æ™®é€šå¾ªç¯çš„è¿è¡Œé€Ÿåº¦æ›´é«˜ã€‚ç„¶è€Œï¼Œå¯¹äºç°ä»£çš„å¤§å¤šæ•°CPUæ¥è¯´ï¼Œä¸€äº›ä½“ç§¯çŸ­å°çš„å¾ªç¯è¯­å¥åè€Œä¼šæ¯”å¾ªç¯å±•å¼€ä½“çš„æ‰§è¡Œé€Ÿåº¦æ›´å¿«ã€‚ä¹Ÿè®¸å¯¹äºç›®å‰ä½æˆæœ¬çš„åµŒå…¥å¼MCUï¼ˆå¾®æ§å•å…ƒï¼Œä¾‹å¦‚å•ç‰‡æœºï¼‰å¤„ç†å™¨è€Œè¨€ï¼Œè¾¾å¤«è®¾å¤‡æ›´æœ‰æ„ä¹‰ä¸€äº›ã€‚</li>
</ul>
<hr />
<p><code>Optimizing msvs 2012</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">dst<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>
count<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">16</span>
bzero    PROC
         test    <span class="token register variable">rdx</span>, <span class="token operator">-</span><span class="token number">8</span><span class="token comment">;rdx=count;&amp;(~7)åè®¾ç½®æ ‡å¿—ä½</span>
         je      SHORT <span class="token operator">$</span>LN11@bzero
<span class="token comment">; work out 8-byte blocks</span>
         xor     <span class="token register variable">r10d</span>, r10dlï¼›<span class="token register variable">r10</span><span class="token operator">=</span><span class="token number">0</span>
         mov     <span class="token register variable">r9</span>, <span class="token register variable">rdx</span><span class="token comment">;r9==count</span>
         shr     <span class="token register variable">r9</span>, <span class="token number">3</span><span class="token comment">;r9=count>>3</span>
         mov     <span class="token register variable">r8d</span>, <span class="token register variable">r10d</span><span class="token comment">;r8d:i=0</span>
         test    <span class="token register variable">r9</span>, <span class="token register variable">r9</span><span class="token comment">;if count ==0 ?</span>
         je      SHORT <span class="token operator">$</span>LN11@bzero
         npad    <span class="token number">5</span>
<span class="token label function">$LL19@bzero:</span>
         inc     <span class="token register variable">r8d</span><span class="token comment">;i++</span>
         mov     QWORD PTR <span class="token operator">[</span><span class="token register variable">rcx</span><span class="token operator">]</span>, <span class="token register variable">r10</span>
         add     <span class="token register variable">rcx</span>, <span class="token number">8</span><span class="token comment">;rcx:dst+8</span>
         movsxd  <span class="token register variable">rax</span>, <span class="token register variable">r8d</span><span class="token comment">;rax</span>
         cmp     <span class="token register variable">rax</span>, <span class="token register variable">r9</span><span class="token comment">;if i == count ?</span>
         jb      SHORT <span class="token operator">$</span>LL19@bzero n? jmp
<span class="token label function">$LN11@bzero:</span>
<span class="token comment">; work out the tail</span>
         and     <span class="token register variable">edx</span>, <span class="token number">7</span>
         dec     <span class="token register variable">rdx</span>
         cmp     <span class="token register variable">rdx</span>, <span class="token number">6</span>
         ja      SHORT <span class="token operator">$</span>LN9@bzero
         lea     <span class="token register variable">r8</span>, OFFSET FLAT:__ImageBase
         mov     <span class="token register variable">eax</span>, DWORD PTR <span class="token operator">$</span>LN22@bzero<span class="token operator">[</span><span class="token register variable">r8</span><span class="token operator">+</span><span class="token register variable">rdx</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>
         add     <span class="token register variable">rax</span>, <span class="token register variable">r8</span>
         jmp     <span class="token register variable">rax</span>
<span class="token label function">$LN8@bzero:</span>
         mov     BYTE PTR <span class="token operator">[</span><span class="token register variable">rcx</span><span class="token operator">]</span>, <span class="token number">0</span>
         inc     <span class="token register variable">rcx</span>
<span class="token label function">$LN7@bzero:</span>
         mov     BYTE PTR <span class="token operator">[</span><span class="token register variable">rcx</span><span class="token operator">]</span>, <span class="token number">0</span>
         inc     <span class="token register variable">rcx</span>
<span class="token label function">$LN6@bzero:</span>
         mov     BYTE PTR <span class="token operator">[</span><span class="token register variable">rcx</span><span class="token operator">]</span>, <span class="token number">0</span>
         inc     <span class="token register variable">rcx</span>
<span class="token label function">$LN5@bzero:</span>
         mov     BYTE PTR <span class="token operator">[</span><span class="token register variable">rcx</span><span class="token operator">]</span>, <span class="token number">0</span>
         inc     <span class="token register variable">rcx</span>
<span class="token label function">$LN4@bzero:</span>
         mov     BYTE PTR <span class="token operator">[</span><span class="token register variable">rcx</span><span class="token operator">]</span>, <span class="token number">0</span>
         inc     <span class="token register variable">rcx</span>
<span class="token label function">$LN3@bzero:</span>
         mov     BYTE PTR <span class="token operator">[</span><span class="token register variable">rcx</span><span class="token operator">]</span>, <span class="token number">0</span>
         inc     <span class="token register variable">rcx</span>
<span class="token label function">$LN2@bzero:</span>
         mov     BYTE PTR <span class="token operator">[</span><span class="token register variable">rcx</span><span class="token operator">]</span>, <span class="token number">0</span>
<span class="token label function">$LN9@bzero:</span>
         fatret  <span class="token number">0</span>
         npad    <span class="token number">1</span>
<span class="token label function">$LN22@bzero:</span>
         DD      <span class="token operator">$</span>LN2@bzero
         DD      <span class="token operator">$</span>LN3@bzero
         DD      <span class="token operator">$</span>LN4@bzero
         DD      <span class="token operator">$</span>LN5@bzero
         DD      <span class="token operator">$</span>LN6@bzero
         DD      <span class="token operator">$</span>LN7@bzero
         DD      <span class="token operator">$</span>LN8@bzero
bzero    ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p>ç¬¬ä¸€éƒ¨åˆ†ä¸æºç¨‹åºå¯¹åº”</p>
</li>
<li>
<p>ç¬¬äºŒéƒ¨åˆ†çš„å¾ªç¯å±•å¼€ä½“:<code>switch</code>è¯­å¥é€šè¿‡è½¬ç§»æŒ‡ä»¤ç›´æ¥è·³åˆ°åˆé€‚çš„ä½ç½®ï¼Œç”±äº<code>mov/inc</code>æŒ‡ä»¤å¯¹ä¹‹é—´æ²¡æœ‰å…¶ä»–ä»£ç ï¼Œæ‰€ä»¥<code>switch</code>è¯­å¥åœ¨è½¬ç§»åˆ°æŒ‡å®šæ ‡ç­¾åä¸ä¼šè¶Šè¿‡åç»­çš„è½¬ç§»æ ‡ç­¾ï¼Œä¼šæ‰§è¡Œå®Œåç»­çš„è½¬ç§»æ ‡ç­¾</p>
</li>
<li>
<p>å¦å¤–ï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­ä¼˜åŒ–è¿™ä¸ªç¨‹åºï¼Œ<code>MOV/INC</code>æŒ‡ä»¤å¯¹æ˜¯å ç”¨å›ºå®šçš„å­—èŠ‚æ•°(3+3=6å­—èŠ‚),å› æ­¤æˆ‘ä»¬å¯ä»¥èˆå»<code>switch</code>è¯­å¥çš„è½¬ç§»è¡¨ç»“æ„ï¼Œç›´æ¥è·³è½¬åˆ°å¦‚ä¸‹åœ°å€<code>ç›®å‰çš„RIPåœ°å€+è¾“å…¥å€¼*6</code>ï¼Œè¿™æ ·å°±çœæ‰äº†ä»è½¬ç§»è¡¨çš„æŸ¥è¯¢æ“ä½œï¼Œæ‰§è¡Œé€Ÿåº¦æ›´å¿«</p>
<p>ä½†æ˜¯å¯¹äºä¹˜æ³•æ¥è¯´ï¼Œ<code>6</code>ä¸æ˜¯ä¸€ä¸ªè®¡ç®—æ•ˆç‡é«˜çš„å› å­ï¼Œå¯èƒ½æ¯”è¡¨æŸ¥è¯¢çš„è½¬ç§»æŒ‡ä»¤æ›´æ…¢</p>
</li>
</ul>
<h3 id="chap41-é™¤ä»¥9"><a class="markdownIt-Anchor" href="#chap41-é™¤ä»¥9"></a> Chap41 é™¤ä»¥9</h3>
<h4 id="å®ä¾‹"><a class="markdownIt-Anchor" href="#å®ä¾‹"></a> å®ä¾‹</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> a<span class="token operator">/</span><span class="token number">9</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<hr />
<p><code>msvs x86</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_a<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>               <span class="token comment">; size = 4</span>
_f     PROC
     push   <span class="token register variable">ebp</span>
     mov    <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
     mov    <span class="token register variable">eax</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
     cdq              <span class="token comment">; sign extend EAX to EDX:EAX</span>
     mov    <span class="token register variable">ecx</span>, <span class="token number">9</span>
     idiv   <span class="token register variable">ecx</span>
     pop    <span class="token register variable">ebp</span>
     ret    <span class="token number">0</span>
_f   ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p>CDQï¼ˆConvert Double-word to Quad-wordï¼‰æ˜¯ä¸€ä¸ªåœ¨x86æ±‡ç¼–è¯­è¨€ä¸­ä½¿ç”¨çš„æŒ‡ä»¤ï¼Œé€‚ç”¨äºIntel 80386åŠåç»­çš„å¤„ç†å™¨ã€‚å®ƒçš„ä¸»è¦åŠŸèƒ½æ˜¯å°†<code>ä¸€ä¸ª32ä½çš„å¸¦ç¬¦å·åŒå­—ï¼ˆDouble-wordï¼Œé€šå¸¸æŒ‡çš„æ˜¯EAXå¯„å­˜å™¨çš„å†…å®¹ï¼‰æ‰©å±•ä¸ºä¸€ä¸ª64ä½çš„å¸¦ç¬¦å·Quad-wordï¼Œç”¨äºå­˜å‚¨åœ¨EDX:EAXå¯„å­˜å™¨å¯¹ä¸­ï¼Œ</code>ä»¥æ”¯æŒæŸäº›éœ€è¦64ä½æ“ä½œçš„æ“ä½œï¼Œæ¯”å¦‚é™¤æ³•å’Œä¸€äº›ä¹˜æ³•è¿ç®—ã€‚</p>
<ul>
<li>
<p>å®ƒæ£€æŸ¥EAXå¯„å­˜å™¨çš„æœ€é«˜ä½ï¼ˆç¬¬31ä½ï¼‰ï¼Œè¿™æ˜¯ä¸€ä½æ ‡å¿—æ•°å­—çš„æ­£è´Ÿï¼ˆæ­£æ•°ä¸º0ï¼Œè´Ÿæ•°ä¸º1ï¼‰ã€‚</p>
</li>
<li>
<p>æ ¹æ®EAXçš„æœ€é«˜ä½ï¼ŒCDQä¼šæŠŠè¯¥ä½çš„å€¼å¤åˆ¶åˆ°EDXå¯„å­˜å™¨çš„æ‰€æœ‰ä½ä¸Šã€‚å¦‚æœEAXçš„æœ€é«˜ä½æ˜¯0ï¼Œé‚£ä¹ˆEDXä¼šè¢«æ¸…é›¶ï¼ˆ00000000ï¼‰ã€‚å¦‚æœEAXçš„æœ€é«˜ä½æ˜¯1ï¼ˆè¡¨ç¤ºä¸€ä¸ªè´Ÿæ•°ï¼‰ï¼Œé‚£ä¹ˆEDXä¼šè¢«å¡«å……ä¸ºFFFFFFFFï¼ˆæ‰€æœ‰ä½éƒ½æ˜¯1ï¼‰ï¼Œè¿™ç›¸å½“äºåœ¨æ•°å­¦ä¸­å¯¹è´Ÿæ•°è¿›è¡Œç¬¦å·æ‰©å±•ï¼Œä¿æŒäº†æ•°å€¼çš„æ­£ç¡®æ€§ã€‚</p>
<p>eg.   8----&gt; 0000 1000  -8-----&gt; 1111 1000</p>
</li>
</ul>
</li>
<li>
<p><code>iDIV</code>æŒ‡ä»¤æ˜¯(å¸¦ç¬¦å·çš„ï¼‰é™¤æ³•æŒ‡ä»¤ã€‚å®ƒä¼šä»å¯„å­˜å™¨å¯¹<code>EDX:EAX</code>ä¸­æå–è¢«é™¤æ•°ï¼Œä»<code>ECX</code>å¯„å­˜å™¨ä¸­æå–é™¤æ•°ã€‚è®¡ç®—ç»“æŸä»¥åï¼Œå®ƒæŠŠè®¡ç®—ç»“æœ/å•†å­˜å‚¨åœ¨<code>EAX</code>å¯„å­˜å™¨é‡Œï¼ŒæŠŠä½™æ•°å­˜å‚¨åœ¨<code>EDX</code>å¯„å­˜å™¨ã€‚é™¤æ³•è®¡ç®—ä¹‹åï¼Œå•†å°±ä½äº<code>EAX</code>å¯„å­˜å™¨é‡Œï¼Œç›´æ¥æˆä¸º<code>f()</code>å‡½æ•°çš„è¿”å›å€¼ï¼›å› æ­¤æ²¡æœ‰å…¶ä»–å€¼ä¼ é€’çš„æ“ä½œã€‚ä¸ºäº†é€šçŸ¥<code>IDIV</code>æŒ‡ä»¤ä»<code>EDX:EAX</code>å¯„å­˜å™¨å¯¹ä¸­æå–<code>64ä½è¢«é™¤æ•°Â·</code>,ä¸ºäº†é€šçŸ¥<code>IDIV</code>ä»<code>EDX:EAX</code>å¯„å­˜å™¨å¯¹ä¸­æå–64ä½è¢«é™¤æ•°ï¼Œç¼–è¯‘å™¨åœ¨<code>IDIV</code>æŒ‡ä»¤ä¹‹å‰åˆ†é…äº†<code>CDQ</code>æŒ‡ä»¤ã€‚<code>IDIV</code>æŒ‡ä»¤å°±ä¼šè¿›è¡Œ<code>MOVSX</code>é‚£æ ·çš„ç¬¦å·ä½å¤„ç†å’Œæ•°æ®æ‹“å±•å¤„ç†</p>
</li>
</ul>
<hr />
<p><code>å¼€å¯ä¼˜åŒ–å</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_a<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>                       <span class="token comment">; size = 4</span>
_f     PROC
     mov     <span class="token register variable">ecx</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
     mov     <span class="token register variable">eax</span>, <span class="token number">954437177</span>   <span class="token comment">; 38e38e39H</span>
     imul    <span class="token register variable">ecx</span>
     sar     <span class="token register variable">edx</span>, <span class="token number">1</span>
     mov     <span class="token register variable">eax</span>, <span class="token register variable">edx</span>
     shr     <span class="token register variable">eax</span>, <span class="token number">31</span>          <span class="token comment">; 0000001fH</span>
     add     <span class="token register variable">eax</span>, <span class="token register variable">edx</span>
     ret     <span class="token number">0</span>
_f     ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><code>sar </code>æŒ‡ä»¤ä»£è¡¨ â€œShift Arithmetic Rightâ€ï¼Œå³ç®—æœ¯å³ç§»ã€‚è¿™æ˜¯ä¸€ä¸ªç”¨äºå¤„ç†å¸¦ç¬¦å·æ•´æ•°çš„æ•°æ®ç§»åŠ¨æ“ä½œã€‚å½“æ‰§è¡Œ <code>sar</code> æŒ‡ä»¤æ—¶</li>
<li>ç¼–è¯‘å™¨ç”¨ä¹˜æ³•æŒ‡ä»¤æ¥å˜ç›¸å®ç°é™¤æ³•è¿ç®—(ä¹˜æ³•çš„æ•ˆç‡é«˜äºé™¤æ³•)(è¿™ä¸ªæ˜¯æœ‰ç›¸åº”çš„è½¬æ¢å…¬å¼çš„)</li>
</ul>
<p>åœ¨ç¼–è¯‘ä¼˜åŒ–ä¸­ï¼Œæˆ‘ä»¬å¸¸å¸¸å°†å…¶ç§°ä¸º&quot;å¼ºåº¦å‡è½»&quot;çš„åŠæ³•</p>
<hr />
<h4 id="åŸç†"><a class="markdownIt-Anchor" href="#åŸç†"></a> åŸç†</h4>
<p>å¼•å…¥<code>2çš„næ¬¡æ–¹ä¹‹å</code>ï¼Œé™¤æ³•è¿ç®—å¯è½¬æ¢ä¸ºä¹˜æ³•è¿ç®—:</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>r</mi><mi>e</mi><mi>s</mi><mi>u</mi><mi>l</mi><mi>t</mi><mo>=</mo><mfrac><mrow><mi>i</mi><mi>n</mi><mi>p</mi><mi>u</mi><mi>t</mi></mrow><mrow><mi>d</mi><mi>i</mi><mi>v</mi><mi>i</mi><mi>s</mi><mi>o</mi><mi>r</mi></mrow></mfrac><mo>=</mo><mfrac><mrow><mi>i</mi><mi>n</mi><mi>p</mi><mi>u</mi><mi>t</mi><mo>âˆ—</mo><mfrac><msup><mn>2</mn><mi>n</mi></msup><mrow><mi>d</mi><mi>i</mi><mi>v</mi><mi>i</mi><mi>s</mi><mi>o</mi><mi>r</mi></mrow></mfrac></mrow><msup><mn>2</mn><mi>n</mi></msup></mfrac><mo>=</mo><mfrac><mrow><mi>i</mi><mi>n</mi><mi>p</mi><mi>u</mi><mi>t</mi><mo>âˆ—</mo><mi>M</mi></mrow><msup><mn>2</mn><mi>n</mi></msup></mfrac></mrow><annotation encoding="application/x-tex">result=\frac{input}{divisor}=\frac{input*\frac{2^n}{divisor}}{2^n}=\frac{input*M}{2^n}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.02252em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3365200000000002em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal">p</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.33198em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6459800000000002em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.590392em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.7350000000000003em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal">p</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.91098em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7385428571428572em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.0463299999999998em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603299999999998em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.590392em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal">p</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<ul>
<li>
<p>è¿™é‡Œçš„<code>M</code>æ˜¯é­”æœ¯å› å­(Magic coefficient)</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mo>=</mo><mfrac><msup><mn>2</mn><mi>n</mi></msup><mrow><mi>d</mi><mi>i</mi><mi>v</mi><mi>i</mi><mi>s</mi><mi>o</mi><mi>r</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">M=\frac{2^n}{divisor}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.25598em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.91098em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7385428571428572em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></p>
</li>
<li>
<p>é™¤ä»¥2<sup>n</sup>çš„è¿ç®—å¯ä»¥ç›´æ¥é€šè¿‡å³ç§»æ“ä½œå®ç°ã€‚å¦‚æœnå°äº32ï¼Œé‚£ä¹ˆä¸­é—´è¿ç®—çš„ç§¯çš„ä½nä½,é€šå¸¸ä½äºEAXæˆ–RAXå¯„å­˜å™¨å°±ä¼šè¢«ä½ç§»è¿ç®—ç›´æ¥æŠ¹å»ï¼›å¦‚æœ<em>n</em>å¤§äºæˆ–ç­‰äº32ï¼Œé‚£ä¹ˆç§¯çš„é«˜åŠéƒ¨åˆ†ï¼ˆé€šå¸¸ä½äºEDXæˆ–è€…RDXå¯„å­˜å™¨ï¼‰çš„æ•°å€¼éƒ½ä¼šå—åˆ°å½±å“ã€‚</p>
</li>
<li>
<p>å¯è§ï¼Œå‚æ•°<em>n</em>çš„å–å€¼ç›´æ¥å†³å®šäº†è½¬æ¢è¿ç®—çš„è®¡ç®—ç²¾åº¦ã€‚</p>
</li>
<li>
<p>åœ¨è¿›è¡Œæœ‰ç¬¦å·æ•°çš„é™¤æ³•è¿ç®—æ—¶ï¼Œç¬¦å·ä½ä¹Ÿå¯¹è®¡ç®—ç²¾åº¦åŠ<em>n</em>çš„å–å€¼äº§ç”Ÿäº†æ˜¾è‘—å½±å“ã€‚</p>
</li>
</ul>
<p>ä¾‹å¦‚:</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">f3_32_signed</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
         <span class="token keyword">return</span> a<span class="token operator">/</span><span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">f3_32_unsigned</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> a<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
         <span class="token keyword">return</span> a<span class="token operator">/</span><span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p>åœ¨æ— ç¬¦å·æ•°çš„è®¡ç®—è¿‡ç¨‹ä¸­ï¼Œé­”æœ¯å› å­æ˜¯<code>0xaaaaaaab</code>ï¼Œä¹˜æ³•çš„ä¸­é—´ç»“æœè¦<code>é™¤ä»¥2çš„33æ¬¡æ–¹ã€‚</code></p>
</li>
<li>
<p>è€Œåœ¨æœ‰ç¬¦å·æ•°çš„è®¡ç®—è¿‡ç¨‹ä¸­ï¼Œé­”æœ¯å› å­åˆ™æ˜¯<code>0x55555556</code>ï¼Œä¹˜æ³•çš„ä¸­é—´ç»“æœè¦é™¤ä»¥2çš„<code>32æ¬¡æ–¹</code>ã€‚è™½ç„¶è¿™é‡Œæ²¡æœ‰è¿›è¡Œé™¤æ³•è¿ç®—ï¼Œä½†æ˜¯æ ¹æ®å‰é¢çš„è®¨è®ºå¯çŸ¥ï¼šå•†çš„æœ‰æ•ˆä½å–è‡ªäºEDXå¯„å­˜å™¨ã€‚</p>
</li>
<li>
<p>ä¸­é—´ä¸€æ­¥çš„ä¹˜æ³•è®¡ç®—åŒæ ·å­˜åœ¨ç¬¦å·ä½çš„é—®é¢˜ï¼šç§¯çš„é«˜32ä½å³ç§»31ä½ï¼Œå°†åœ¨EAXå¯„å­˜å™¨çš„æœ€ä½æ•°æƒä½ä¿ç•™æœ‰ç¬¦å·æ•°çš„ç¬¦å·ä½ï¼ˆæ­£æ•°ä¸º0ï¼Œè´Ÿæ•°ä¸º1ï¼‰ã€‚å°†ç¬¦å·ä½åŠ å…¥ç§¯çš„é«˜32ä½å€¼ï¼Œå¯å®ç°è´Ÿæ•°è¡¥ç çš„â€œï¼‹1â€ä¿®æ­£</p>
</li>
</ul>
<hr />
<p><code>optimizing msvs 2012</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_f3_32_unsigned PROC
         mov      <span class="token register variable">eax</span>, <span class="token operator">-</span><span class="token number">1431655765</span>     <span class="token comment">; aaaaaaabH</span>
         mul      DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span> <span class="token comment">; unsigned multiply</span>
<span class="token comment">; EDX=(input*0xaaaaaaab)/2^32</span>
         shr      <span class="token register variable">edx</span>, <span class="token number">1</span>
<span class="token comment">; EDX=(input*0xaaaaaaab)/2^33</span>
         mov      <span class="token register variable">eax</span>, <span class="token register variable">edx</span>
         ret      <span class="token number">0</span>
_f3_32_unsigned ENDP

_f3_32_signed PROC
         mov      <span class="token register variable">eax</span>, <span class="token number">1431655766</span>              <span class="token comment">; 55555556H</span>
         imul     DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span> <span class="token comment">; signed multiply</span>
<span class="token comment">; take high part of product</span>
<span class="token comment">; it is just the same as if to shift product by 32 bits right or to divide it by 2^32</span>
         mov      <span class="token register variable">eax</span>, <span class="token register variable">edx</span>       <span class="token comment">; EAX=EDX=(input*0x55555556)/2^32</span>
         shr      <span class="token register variable">eax</span>, <span class="token number">31</span>        <span class="token comment">; 0000001fH</span>
         add      <span class="token register variable">eax</span>, <span class="token register variable">edx</span>       <span class="token comment">; add 1 if sign is negative</span>
         ret      <span class="token number">0</span>
_f3_32_signed ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>EAXä¹˜ç«‹å³æ•°åï¼Œé«˜ä½å­˜å‚¨åœ¨<code>EDX</code>ï¼Œä½ä½å­˜å‚¨åœ¨<code>EAX</code>ä¸­</li>
<li>EDX<code>ä¸­çš„å€¼è¿‘ä¼¼ç­‰äº</code>(input * 0xAAAAAAAB) &gt;&gt; 32 Why?</li>
<li>å¸¸æ•° <code>0xAAAAAAAB</code> ï¼ˆå³ <code>-1431655765</code>ï¼‰æ˜¯ä¸€ä¸ªç‰¹åˆ«è®¾è®¡çš„æ•°ï¼Œå®ƒåœ¨äºŒè¿›åˆ¶è¡¨ç¤ºä¸Šå…·æœ‰ç‰¹å®šçš„æ€§è´¨ï¼Œä½¿å¾—å½“å®ƒä¸ä¸€ä¸ª32ä½æ— ç¬¦å·æ•´æ•°ç›¸ä¹˜æ—¶ï¼Œå…¶ä¹˜ç§¯çš„é«˜32ä½èƒ½å¤Ÿæä¾›è¯¥æ•´æ•°å€’æ•°çš„ä¸€ä¸ªè¿‘ä¼¼å€¼ã€‚å…·ä½“æ¥è¯´ï¼Œè¿™ä¸ªæ•°è¢«è®¾è®¡ç”¨æ¥é…åˆ32ä½æ•´æ•°çš„ä¹˜æ³•è¿ç®—ï¼Œäº§ç”Ÿä¸€ä¸ªé«˜ä½åŒ…å«ç›®æ ‡å€’æ•°ä¿¡æ¯çš„ç»“æœã€‚</li>
<li>ä¹Ÿå°±æ˜¯è¯´<code>EAX</code>çš„å€¼ä¸<code> aaaaaaabH</code>ç›¸ä¹˜ï¼Œäº§ç”Ÿçš„é«˜ä½ä¿¡æ¯å­˜å‚¨åœ¨<code>EDX</code>å¯„å­˜å™¨ä¸­ï¼Œè€Œè¿™ä¸ªé«˜ä½ä¿¡æ¯åŒ…å«äº†é™¤æ•°å€’æ•°çš„ä¿¡æ¯</li>
</ul>
<h4 id="more"><a class="markdownIt-Anchor" href="#more"></a> More</h4>
<p>å…¶å®ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ï¼Œä¹˜æ³•å’Œé™¤æ³•äº’ä¸ºé€†è¿ç®—ã€‚å› æ­¤ä¸‹é¢çš„é™¤æ³•å¯ä»¥ç”¨ä¹˜æ³•æ¥ä»£æ›¿ã€‚æˆ‘ä»¬å¯ä»¥è¡¨è¿°ä¸º</p>
<p>x/c=x*(1/c)</p>
<p>1/<em>c</em>å¯ä»¥ç§°ä¸ºä¹˜æ³•çš„é€†è¿ç®—ï¼Œæ˜¯<em>c</em>çš„å€’æ•°ã€‚å¯ä»¥ç”¨ç¼–è¯‘å™¨æ¥åšæå‰è¿ç®—ã€‚</p>
<hr />
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">mov        <span class="token register variable">eax</span>, MAGICAL CONSTANT
      imul       input value
      sar        <span class="token register variable">edx</span>, SHIFTING COEFFICIENT <span class="token comment">; signed division by 2xusing arithmetic shift right ;å·²ç»ä½ç§»äº†32ä½åï¼Œåˆç§»åŠ¨äº†å¤šå°‘ä½ç§°ä¸ºå˜ä½ç³»æ•°</span>
      mov        <span class="token register variable">eax</span>, <span class="token register variable">edx</span>
      shr        <span class="token register variable">eax</span>, <span class="token number">31</span>
      add        <span class="token register variable">eax</span>, <span class="token register variable">edx</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬å¦‚æœæ ¹æ®è¿™ä¸ªå˜ä½ç³»æ•°æ±‚è§£<code>é™¤æ•°</code>å‘¢ï¼Ÿ</p>
<ul>
<li>
<p>è®°å˜ä½ç³»æ•°ä¸º<code>C</code>ï¼Œé™¤æ•°è®°ä¸º<code>D</code></p>
<p>é™¤æ•°å¯ä»¥è¡¨ç¤ºä¸º</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>D</mi><mo>=</mo><mfrac><msup><mn>2</mn><mrow><mn>32</mn><mo>+</mo><mi>c</mi></mrow></msup><mi>M</mi></mfrac></mrow><annotation encoding="application/x-tex">D=\frac{2^{32+c}}{M}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.177108em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.491108em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mord mtight">2</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight">c</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
</li>
<li>
<p>ä¾‹å¦‚</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">mov        <span class="token register variable">eax</span>, <span class="token number">2021161081</span>                      <span class="token comment">; 78787879H</span>
     imul       DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
     sar        <span class="token register variable">edx</span>, <span class="token number">3</span>
     mov        <span class="token register variable">eax</span>, <span class="token register variable">edx</span>
     shr        <span class="token register variable">eax</span>, <span class="token number">31</span>                              <span class="token comment">; 0000001fH</span>
     add        <span class="token register variable">eax</span>, <span class="token register variable">edx</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åˆ©ç”¨å…¬å¼å¯ä»¥è®¡ç®—é™¤æ•°å¾—:</p>
<img src="/2024/05/23/re4b%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image-20240612161235490.png" class="" alt="image-20240612161235490" loading="lazy">
</li>
</ul>
<p>â€‹	å–æ•´ä¸º<code>17</code>ï¼Œé™¤æ•°å°±æ˜¯<code>17</code></p>
<ul>
<li>
<p>ç±»ä¼¼çš„ï¼Œåœ¨<mark>64ä½æ•°æ®çš„é™¤æ³•è¿ç®—ä¸­</mark>ï¼Œåªæ˜¯ä¸å†é‡‡ç”¨2çš„32æ¬¡æ–¹ï¼Œè€Œé‡‡ç”¨äº†2çš„64æ¬¡æ–¹</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">uint64_t</span> <span class="token function">f1234</span><span class="token punctuation">(</span><span class="token class-name">uint64_t</span> a<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
         <span class="token keyword">return</span> a<span class="token operator">/</span><span class="token number">1234</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-masm" data-language="masm"><code class="language-masm">f1234    PROC
         mov     rax, 7653754429286296943              ; 6a37991a23aead6fH
         mul     rcx
         shr     rdx, 9
         mov     rax, rdx
         ret     0
f1234    ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<img src="/2024/05/23/re4b%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/image-20240612161445800.png" class="" alt="image-20240612161445800" loading="lazy">
</li>
</ul>
<h3 id="chap42-str2numatoiå‡½æ•°"><a class="markdownIt-Anchor" href="#chap42-str2numatoiå‡½æ•°"></a> Chap42 str2numï¼Œatoi()å‡½æ•°</h3>
<p>æœ¬ç« é‡æ–°å®ç°äº†æ ‡å‡†çš„Cå‡½æ•°<code>atoi()</code>ï¼Œå°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•´æ•°</p>
<h4 id="exmaple1"><a class="markdownIt-Anchor" href="#exmaple1"></a> exmaple1</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">int</span> <span class="token function">my_atoi</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>s<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
         <span class="token keyword">int</span> rt<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

         <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>s<span class="token punctuation">)</span>
         <span class="token punctuation">&#123;</span>
                  rt<span class="token operator">=</span>rt<span class="token operator">*</span><span class="token number">10</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token operator">*</span>s<span class="token operator">-</span><span class="token char">'0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  s<span class="token operator">++</span><span class="token punctuation">;</span>
         <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

         <span class="token keyword">return</span> rt<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

         <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
         <span class="token punctuation">&#123;</span>
                  <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> <span class="token function">my_atoi</span> <span class="token punctuation">(</span><span class="token string">"1234"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> <span class="token function">my_atoi</span> <span class="token punctuation">(</span><span class="token string">"1234567890"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>è¿™ä¸ªç®—æ³•å®ç°çš„æ˜¯ä»å·¦åˆ°å³è¯»å–æ•°å­—ï¼Œå¹¶å°†æ¯ä¸ªè¯»å–çš„å­—ç¬¦å‡å»æ•°å­—0çš„ASCIIå€¼ï¼Œå†ä¹˜ä»¥æƒå€¼</li>
</ul>
<hr />
<p><code>optimizing msvs x64</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">my_atoi PROC
<span class="token comment">; åŠ è½½ç¬¬ä¸€ä¸ªå­—ç¬¦åˆ° R8D å¯„å­˜å™¨ä¸­</span>
    movzx   <span class="token register variable">r8d</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">rcx</span><span class="token operator">]</span>   <span class="token comment">; æŠŠrcxæŒ‡å‘çš„å­—èŠ‚æ‰©å±•ä¸ºåŒå­—æ”¾å…¥r8d</span>

<span class="token comment">; EAX ç”¨äºå­˜æ”¾ç»“æœï¼ˆåˆå§‹ä¸º0ï¼‰</span>
    xor     <span class="token register variable">eax</span>, <span class="token register variable">eax</span>              <span class="token comment">; å°†eaxæ¸…é›¶ï¼Œä½œä¸ºç´¯åŠ ç»“æœçš„èµ·å§‹å€¼</span>

<span class="token comment">; æ£€æŸ¥ç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯å¦ä¸ºå­—ç¬¦ä¸²ç»“æŸç¬¦ï¼ˆç©ºå­—ç¬¦ï¼‰</span>
    test    <span class="token register variable">r8b</span>, <span class="token register variable">r8b</span>              <span class="token comment">; æµ‹è¯•r8bæ˜¯å¦ä¸º0</span>
    je      SHORT <span class="token operator">$</span>LN9@my_atoi     <span class="token comment">; å¦‚æœæ˜¯ï¼Œè·³è½¬åˆ°ç»“æŸæ ‡ç­¾ï¼Œå› ä¸ºæ²¡æœ‰æœ‰æ•ˆæ•°å­—</span>

<span class="token label function">$LL2@my_atoi:</span>                         <span class="token comment">; å¾ªç¯å¼€å§‹æ ‡ç­¾</span>
<span class="token comment">; è®¡ç®—å½“å‰ç»“æœçš„äº”å€ï¼ˆä¸ºåç»­ä¸æ–°æ•°å­—ç›¸åŠ åšå‡†å¤‡ï¼‰</span>
    lea     <span class="token register variable">edx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">rax</span><span class="token operator">+</span><span class="token register variable">rax</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>   <span class="token comment">; edx = eax * 5</span>

<span class="token comment">; æŠŠä¸‹ä¸€ä¸ªå­—ç¬¦åŠ è½½åˆ° R8D ä¸­</span>
    movzx   <span class="token register variable">r8d</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">rcx</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">]</span>        <span class="token comment">; å–ä¸‹ä¸€ä¸ªå­—èŠ‚å¹¶æ‰©å±•ä¸ºåŒå­—æ”¾å…¥r8d</span>

<span class="token comment">; æŒ‡é’ˆ RCX ç§»åŠ¨åˆ°å­—ç¬¦ä¸²çš„ä¸‹ä¸€ä¸ªå­—ç¬¦</span>
    lea     <span class="token register variable">rcx</span>, QWORD PTR <span class="token operator">[</span><span class="token register variable">rcx</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">]</span>       <span class="token comment">; rcx æŒ‡å‘ä¸‹ä¸€ä¸ªå­—ç¬¦</span>

<span class="token comment">; ç»“æœï¼ˆeaxï¼‰åŠ ä¸Šæ–°è¯»å–å­—ç¬¦çš„å€¼ï¼ˆè½¬æ¢ä¸ºæ•°å­—ï¼Œå‡å»'0'çš„ASCIIç 48ï¼‰</span>
    lea     <span class="token register variable">eax</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">rax</span><span class="token operator">+</span><span class="token register variable">rdx</span><span class="token operator">*</span><span class="token number">2</span><span class="token operator">]</span>   <span class="token comment">; eax = eax + edx * 2ï¼Œè¿™é‡Œå®é™…æ˜¯eax = rt * 10 + input_char</span>
    add     <span class="token register variable">eax</span>, <span class="token operator">-</span><span class="token number">48</span>                      <span class="token comment">; æŠŠå­—ç¬¦è½¬æ¢ä¸ºæ•°å­—ï¼ˆå‡å»'0'çš„ASCIIå€¼ï¼‰</span>

<span class="token comment">; æ£€æŸ¥æ˜¯å¦åˆ°è¾¾å­—ç¬¦ä¸²æœ«å°¾</span>
    test    <span class="token register variable">r8b</span>, <span class="token register variable">r8b</span>                      <span class="token comment">; å†æ¬¡æµ‹è¯•r8bï¼Œçœ‹æ˜¯å¦ä¸º0</span>
    jne     SHORT <span class="token operator">$</span>LL2@my_atoi             <span class="token comment">; ä¸æ˜¯åˆ™è·³å›å¾ªç¯å¼€å§‹ç»§ç»­å¤„ç†</span>

<span class="token label function">$LN9@my_atoi:</span>                         <span class="token comment">; å¾ªç¯ç»“æŸæ ‡ç­¾</span>
<span class="token comment">; å‡½æ•°è¿”å›ï¼Œç»“æœåœ¨EAXä¸­</span>
    ret     <span class="token number">0</span>                            <span class="token comment">; è¿”å›ï¼Œä¸å¸¦å‚æ•°</span>
my_atoi ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>æŸäº›æƒ…å†µä¸‹ï¼ŒMSVCç¼–è¯‘å™¨ä¼šåˆ»æ„é¿å¼€å‡æ³•è¿ç®—çš„SUBæŒ‡ä»¤ã€è½¬è€Œåˆ†é…â€œADDæŸä¸ªè´Ÿæ•°â€çš„æŒ‡ä»¤æ¥å®ç°å‡æ³•è¿ç®—ã€‚</code></p>
<hr />
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token label function">my_atoi:</span>
<span class="token comment">; load input character into EDX</span>
          movsx   <span class="token register variable">edx</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">rdi</span><span class="token operator">]</span>
<span class="token comment">; EAX is allocated for "rt" variable</span>
          xor     <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
<span class="token comment">; exit, if loaded character is null byte</span>
          test    <span class="token register variable">dl</span>, <span class="token register variable">dl</span>
          je      .L4
<span class="token label function">.L3:</span>
          lea     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">rax</span><span class="token operator">+</span><span class="token register variable">rax</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>
<span class="token comment">; EAX=RAX*5=rt*5</span>
<span class="token comment">; shift pointer to the next character:</span>
          add     <span class="token register variable">rdi</span>, <span class="token number">1</span>
          lea     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">rdx</span><span class="token operator">-</span><span class="token number">48</span><span class="token operator">+</span><span class="token register variable">rax</span><span class="token operator">*</span><span class="token number">2</span><span class="token operator">]</span>
<span class="token comment">; EAX=input character - 48 + RAX*2 = input character - '0' + rt*10</span>
<span class="token comment">; load next character:</span>
          movsx   <span class="token register variable">edx</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">rdi</span><span class="token operator">]</span>
<span class="token comment">; goto loop begin, if loaded character is not null byte</span>
          test    <span class="token register variable">dl</span>, <span class="token register variable">dl</span>
          jne     .L3
          rep ret
<span class="token label function">.L4:</span>
          rep ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="example2"><a class="markdownIt-Anchor" href="#example2"></a> example2</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">int</span> <span class="token function">my_atoi</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>s<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
          <span class="token keyword">int</span> negative<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
          <span class="token keyword">int</span> rt<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>s<span class="token operator">==</span><span class="token char">'-'</span><span class="token punctuation">)</span>
          <span class="token punctuation">&#123;</span>
                    negative<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
                    s<span class="token operator">++</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

          <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>s<span class="token punctuation">)</span>
          <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>s<span class="token operator">&lt;</span><span class="token char">'0'</span> <span class="token operator">||</span> <span class="token operator">*</span>s<span class="token operator">></span><span class="token char">'9'</span><span class="token punctuation">)</span>
                    <span class="token punctuation">&#123;</span>
                              <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"Error! Unexpected char: '%c'\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
                              <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
                    rt<span class="token operator">=</span>rt<span class="token operator">*</span><span class="token number">10</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token operator">*</span>s<span class="token operator">-</span><span class="token char">'0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    s<span class="token operator">++</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>negative<span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token operator">-</span>rt<span class="token punctuation">;</span>
          <span class="token keyword">return</span> rt<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
          <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> <span class="token function">my_atoi</span> <span class="token punctuation">(</span><span class="token string">"1234"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> <span class="token function">my_atoi</span> <span class="token punctuation">(</span><span class="token string">"1234567890"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> <span class="token function">my_atoi</span> <span class="token punctuation">(</span><span class="token string">"-1234"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> <span class="token function">my_atoi</span> <span class="token punctuation">(</span><span class="token string">"-1234567890"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> <span class="token function">my_atoi</span> <span class="token punctuation">(</span><span class="token string">"-a1234567890"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// error</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>æ·»åŠ äº†è½¬æ¢è´Ÿæ•°çš„åŠŸèƒ½</li>
</ul>
<hr />
<p><code>optimizing gcc x64</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token label function">.LC0:</span>
          .string <span class="token string">"Error! Unexpected char: '%c'\n"</span>

<span class="token label function">my_atoi:</span>
          sub     <span class="token register variable">rsp</span>, <span class="token number">8</span>
          movsx   <span class="token register variable">edx</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">rdi</span><span class="token operator">]</span>
<span class="token comment">; check for minus sign</span>
          cmp     <span class="token register variable">dl</span>, <span class="token number">45</span> <span class="token comment">; '-'</span>
          je      .L22
          xor     <span class="token register variable">esi</span>, <span class="token register variable">esi</span>
          test    <span class="token register variable">dl</span>, <span class="token register variable">dl</span>
          je      .L20
<span class="token label function">.L10:</span>
<span class="token comment">; ESI=0 here if there was no minus sign and 1 if it was</span>
          lea     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">rdx</span><span class="token operator">-</span><span class="token number">48</span><span class="token operator">]</span>
<span class="token comment">; any character other than digit will result unsigned number greater than 9 after subtraction</span>
<span class="token comment">; so if it is not digit, jump to L4, where error will be reported:</span>
          cmp     <span class="token register variable">al</span>, <span class="token number">9</span>
          ja      .L4
          xor     <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
          jmp     .L6
<span class="token label function">.L7:</span>
          lea     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">rdx</span><span class="token operator">-</span><span class="token number">48</span><span class="token operator">]</span>
          cmp     <span class="token register variable">cl</span>, <span class="token number">9</span>
          ja      .L4
<span class="token label function">.L6:</span>
          lea     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">rax</span><span class="token operator">+</span><span class="token register variable">rax</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>
          add     <span class="token register variable">rdi</span>, <span class="token number">1</span>
          lea     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">rdx</span><span class="token operator">-</span><span class="token number">48</span><span class="token operator">+</span><span class="token register variable">rax</span><span class="token operator">*</span><span class="token number">2</span><span class="token operator">]</span>
          movsx   <span class="token register variable">edx</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">rdi</span><span class="token operator">]</span>
          test    <span class="token register variable">dl</span>, <span class="token register variable">dl</span>
          jne     .L7
<span class="token comment">; if there was no minus sign, skip NEG instruction</span>
<span class="token comment">; if it was, execute it.</span>
          test    <span class="token register variable">esi</span>, <span class="token register variable">esi</span>
          je      .L18
          neg     <span class="token register variable">eax</span>
<span class="token label function">.L18:</span>
          add     <span class="token register variable">rsp</span>, <span class="token number">8</span>
          ret
<span class="token label function">.L22:</span>
          movsx   <span class="token register variable">edx</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">rdi</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">]</span>
          lea     <span class="token register variable">rax</span>, <span class="token operator">[</span><span class="token register variable">rdi</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">]</span><span class="token comment">;è·³è¿‡'-'</span>
          test    <span class="token register variable">dl</span>, <span class="token register variable">dl</span><span class="token comment">;'æ£€æµ‹æ˜¯å¦æ˜¯''</span>
          je      .L20
          mov     <span class="token register variable">rdi</span>, <span class="token register variable">rax</span>
          mov     <span class="token register variable">esi</span>, <span class="token number">1</span>
          jmp     .L10
<span class="token label function">.L20:</span>
          xor     <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
          jmp     .L18
<span class="token label function">.L4:</span>
<span class="token comment">; report error. character is in EDX</span>
          mov     <span class="token register variable">edi</span>, <span class="token number">1</span>
          mov     <span class="token register variable">esi</span>, OFFSET FLAT:.LC0 <span class="token comment">; "Error! Unexpected char: '%c'\n"</span>
          xor     <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
          call    __printf_chk
          xor     <span class="token register variable">edi</span>, <span class="token register variable">edi</span>
          call    exit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>å¦‚æœå­—ç¬¦ä¸²çš„ç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯è´Ÿå·ï¼Œé‚£ä¹ˆå°±è¦åœ¨è½¬æ¢çš„æœ€åé˜¶æ®µæ‰§è¡Œ<code>neg</code>æŒ‡ä»¤ï¼ŒæŠŠç»“æœè½¬æ¢ä¸ºè´Ÿæ•°</li>
<li>ç¼–è¯‘å™¨å¯¹äº<code>if(\*s&lt;'0'||\*s&gt;'9')</code>çš„å¤„ç†æ¯”è¾ƒå·§å¦™ï¼Œè¿™æ˜¯ä¸¤ä¸ªæ¯”è¾ƒæ“ä½œï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥åªç”¨ä¸€ä¸ªæ¯”è¾ƒæŒ‡ä»¤å°±èƒ½å®Œæˆè¿™ä¸¤æ­¥æ¯”è¾ƒæ“ä½œï¼Œå°†è¾“å…¥å­—ç¬¦çš„å€¼å‡å»â€™0â€™å­—ç¬¦çš„å€¼ï¼Œå°†ç»“æœè§†ä¸ºæ— ç¬¦å·æ•°ï¼Œä¸9è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœå¤§äºå°±ä¸ç¬¦åˆ</li>
</ul>
<hr />
<p><code>è¿™é‡Œé¡ºä¾¿æä¸€ä¸‹ï¼Œå®‰å…¨ç ”ç©¶äººå‘˜ç»å¸¸ç ”ç©¶å„ç§å¼‚å¸¸æƒ…å†µã€‚ä»–ä»¬é‡ç‚¹å…³æ³¨ä¸åˆä¹é¢„æœŸçš„è¾“å…¥å€¼ï¼Œé€šè¿‡è¿™ç§æ•°æ®è¯±ä½¿ç¨‹åºè¿›è¡ŒæŸç§ä¸è®¾è®¡æ€è·¯ç›¸å·¦çš„è¡Œä¸ºã€‚å› æ­¤ï¼Œä»–ä»¬ä¹Ÿä¼šå…³æ³¨æ¨¡ç³Šæµ‹è¯•æ–¹æ³•ã€‚</code></p>
<h3 id="chap43-å†…è”å‡½æ•°"><a class="markdownIt-Anchor" href="#chap43-å†…è”å‡½æ•°"></a> Chap43 å†…è”å‡½æ•°</h3>
<p><em>åœ¨ç¼–è¯‘é˜¶æ®µï¼Œå°†ä¼šè¢«ç¼–è¯‘å™¨æŠŠå‡½æ•°ä½“å±•å¼€å¹¶åµŒå…¥åˆ°æ¯ä¸€ä¸ªè°ƒç”¨ç‚¹çš„å‡½æ•°ï¼Œå°±æ˜¯å†…è”å‡½æ•°ã€‚</em></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">int</span> <span class="token function">celsius_to_fahrenheit</span> <span class="token punctuation">(</span><span class="token keyword">int</span> celsius<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> celsius <span class="token operator">*</span> <span class="token number">9</span> <span class="token operator">/</span> <span class="token number">5</span> <span class="token operator">+</span> <span class="token number">32</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> celsius<span class="token operator">=</span><span class="token function">atol</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> <span class="token function">celsius_to_fahrenheit</span> <span class="token punctuation">(</span>celsius<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr />
<p><code>optimizing gcc 4.8.1</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token label function">_main:</span>
          push    <span class="token register variable">ebp</span>
          mov     <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
          and     <span class="token register variable">esp</span>, <span class="token operator">-</span><span class="token number">16</span>
          sub     <span class="token register variable">esp</span>, <span class="token number">16</span>
          call    ___main
          mov     <span class="token register variable">eax</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token number">12</span><span class="token operator">]</span>
          mov     <span class="token register variable">eax</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>
          mov     DWORD PTR <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">]</span>, <span class="token register variable">eax</span>
          call    _atol
          mov     <span class="token register variable">edx</span>, <span class="token number">1717986919</span>
          mov     DWORD PTR <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">]</span>, OFFSET FLAT:LC2 <span class="token comment">; "%d\12\0"</span>
          lea     <span class="token register variable">ecx</span>, <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token register variable">eax</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">]</span>
          mov     <span class="token register variable">eax</span>, <span class="token register variable">ecx</span>
          imul    <span class="token register variable">edx</span>
          sar     <span class="token register variable">ecx</span>, <span class="token number">31</span>
          sar     <span class="token register variable">edx</span>
          sub     <span class="token register variable">edx</span>, <span class="token register variable">ecx</span>
          add     <span class="token register variable">edx</span>, <span class="token number">32</span>
          mov     DWORD PTR <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">edx</span>
          call    _printf
          leave
          ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>è¿™é‡Œåˆ©ç”¨äº†41ç« æåˆ°çš„åˆ©ç”¨ä¹˜æ³•æŒ‡ä»¤å®ç°äº†é™¤æ³•è¿ç®—ï¼Œè¿™ä¸ªæ˜¯æœ‰ç¬¦å·æ•°</li>
<li><mark>è¿™é‡Œå€¼å¾—æ³¨æ„çš„æ˜¯æ¸©åº¦è½¬æ¢å‡½æ•°çš„å‡½æ•°ä½“è¢«ç›´æ¥å±•å¼€äº†ï¼Œæ”¾åœ¨äº†å‡½æ•°printf()çš„å‰é¢</mark></li>
<li>è¿™æ ·ä¸éœ€è¦å¤„ç†å¤šä½™çš„å‡½æ•°è°ƒç”¨å’Œè¿”å›æŒ‡ä»¤ã€‚æ›´å¿«</li>
<li><mark>ç°åœ¨å…·æœ‰ä¼˜åŒ–åŠŸèƒ½çš„ç¼–è¯‘å™¨ä¸€èˆ¬éƒ½èƒ½è‡ªåŠ¨çš„æŠŠå°å‹å‡½æ•°çš„å‡½æ•°ä½“ç›´æ¥â€œåµŒå…¥â€åˆ°è°ƒç”¨æ–¹å‡½æ•°çš„ä»£ç é‡Œã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥å€ŸåŠ©å…³é”®å­—â€œinlineâ€å¼ºåˆ¶ç¼–è¯‘å™¨è¿›è¡Œè¿™ç§â€œåµŒå…¥â€å¤„ç†ã€‚</mark></li>
</ul>
<h4 id="strcmp"><a class="markdownIt-Anchor" href="#strcmp"></a> strcmp</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">bool <span class="token function">is_bool</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>s<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
                   <span class="token keyword">return</span> true<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"false"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
                   <span class="token keyword">return</span> false<span class="token punctuation">;</span>
          <span class="token function">assert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token comment">; å®šä¹‰ä¸¤ä¸ªå­—ç¬¦ä¸²å¸¸é‡</span>
<span class="token label function">.LC0:</span>          .string <span class="token string">"true"</span>     <span class="token comment">; å­—ç¬¦ä¸² "true"</span>
<span class="token label function">.LC1:</span>          .string <span class="token string">"false"</span>    <span class="token comment">; å­—ç¬¦ä¸² "false"</span>

<span class="token label function">is_bool:</span>       <span class="token comment">; å‡½æ•°å…¥å£</span>
<span class="token label function">.LFB0:</span>
          push    <span class="token register variable">edi</span>           <span class="token comment">; ä¿å­˜ediå¯„å­˜å™¨</span>
          mov     <span class="token register variable">ecx</span>, <span class="token number">5</span>         <span class="token comment">; è®¾ç½®æ¯”è¾ƒé•¿åº¦ä¸º5ï¼ˆ"true"çš„é•¿åº¦ï¼‰</span>
          push    <span class="token register variable">esi</span>           <span class="token comment">; ä¿å­˜esiå¯„å­˜å™¨</span>
          mov     <span class="token register variable">edi</span>, OFFSET FLAT:.LC0  <span class="token comment">; ediæŒ‡å‘å­—ç¬¦ä¸²"true"</span>

          sub     <span class="token register variable">esp</span>, <span class="token number">20</span>        <span class="token comment">; ä¸ºå±€éƒ¨å˜é‡åˆ†é…ç©ºé—´</span>
          mov     <span class="token register variable">esi</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">32</span><span class="token operator">]</span>  <span class="token comment">; esiæŒ‡å‘å¾…æ£€æŸ¥çš„è¾“å…¥å­—ç¬¦ä¸²</span>

          <span class="token comment">; æ¯”è¾ƒè¾“å…¥å­—ç¬¦ä¸²ä¸"true"</span>
          repz cmpsb             <span class="token comment">; æ¯”è¾ƒecxä¸ªå­—èŠ‚ï¼Œç›´åˆ°å‘ç°å·®å¼‚æˆ–ecxå‡åˆ°0</span>
          je      .L3            <span class="token comment">; å¦‚æœå­—ç¬¦ä¸²åŒ¹é…ï¼ˆå³è¾“å…¥ä¸º"true"ï¼‰ï¼Œè·³è½¬åˆ°.L3</span>

          <span class="token comment">; å¦‚æœæ²¡åŒ¹é…"true"ï¼Œåˆ™å°è¯•åŒ¹é…"false"</span>
          mov     <span class="token register variable">esi</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">32</span><span class="token operator">]</span>  <span class="token comment">; é‡ç½®esiæŒ‡å‘è¾“å…¥å­—ç¬¦ä¸²</span>
          mov     <span class="token register variable">ecx</span>, <span class="token number">6</span>         <span class="token comment">; è®¾ç½®æ¯”è¾ƒé•¿åº¦ä¸º6ï¼ˆ"false"çš„é•¿åº¦ï¼‰</span>
          mov     <span class="token register variable">edi</span>, OFFSET FLAT:.LC1  <span class="token comment">; ediæŒ‡å‘å­—ç¬¦ä¸²"false"</span>
          repz cmpsb             <span class="token comment">; å†æ¬¡æ¯”è¾ƒ</span>
          <span class="token comment">; ä½¿ç”¨setaå’Œsetbè®¾ç½®clå’Œdlï¼Œç”¨äºåç»­é€»è¾‘åˆ¤æ–­</span>
          seta    <span class="token register variable">cl</span>             <span class="token comment">; å¦‚æœediï¼ˆ"false"ï¼‰åœ¨å‰é¢ï¼Œcl=1ï¼›å¦åˆ™cl=0</span>
          setb    <span class="token register variable">dl</span>             <span class="token comment">; dlæ€»æ˜¯è®¾ä¸º1ï¼Œå› ä¸ºsetbæ€»æ˜¯è®¾ç½®ä½ä¸º1</span>
          xor     <span class="token register variable">eax</span>, <span class="token register variable">eax</span>       <span class="token comment">; eaxæ¸…é›¶</span>
          cmp     <span class="token register variable">cl</span>, <span class="token register variable">dl</span>         <span class="token comment">; æ¯”è¾ƒclå’Œdl</span>
          jne     .L8            <span class="token comment">; å¦‚æœclä¸ç­‰äºdlï¼ˆæ„å‘³ç€è¾“å…¥æ—¢ä¸æ˜¯"true"ä¹Ÿä¸æ˜¯"false"ï¼‰ï¼Œè·³è½¬åˆ°.L8</span>

<span class="token label function">.L8:</span>          <span class="token comment">; è¾“å…¥ä¸ç¬¦åˆé¢„æœŸï¼Œè°ƒç”¨assertæ–­è¨€å¤±è´¥</span>
          mov     DWORD PTR <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">]</span>, <span class="token number">0</span>   <span class="token comment">; å‡†å¤‡assertçš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆé€šå¸¸ä¸º0ï¼‰</span>
          call    assert           <span class="token comment">; è°ƒç”¨assertå‡½æ•°</span>
          add     <span class="token register variable">esp</span>, <span class="token number">20</span>          <span class="token comment">; é‡Šæ”¾å±€éƒ¨å˜é‡ç©ºé—´</span>
          pop     <span class="token register variable">esi</span>             <span class="token comment">; æ¢å¤esi</span>
          pop     <span class="token register variable">edi</span>             <span class="token comment">; æ¢å¤edi</span>
          ret                     <span class="token comment">; è¿”å›ï¼Œè¡¨ç¤ºé”™è¯¯</span>

<span class="token label function">.L3:</span>          <span class="token comment">; è¾“å…¥å­—ç¬¦ä¸²ä¸º"true"</span>
          add     <span class="token register variable">esp</span>, <span class="token number">20</span>          <span class="token comment">; é‡Šæ”¾å±€éƒ¨å˜é‡ç©ºé—´</span>
          mov     <span class="token register variable">eax</span>, <span class="token number">1</span>           <span class="token comment">; è®¾ç½®eaxä¸º1ï¼Œè¡¨ç¤ºtrue</span>
          pop     <span class="token register variable">esi</span>             <span class="token comment">; æ¢å¤esi</span>
          pop     <span class="token register variable">edi</span>             <span class="token comment">; æ¢å¤edi</span>
          ret                     <span class="token comment">; è¿”å›ï¼Œè¡¨ç¤ºæˆåŠŸ</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><code>seta</code>å³set above.æ ¹æ®ä¹‹å‰æŒ‡ä»¤æ‰§è¡Œçš„ç»“æœè®¾ç½®å¯„å­˜å™¨çš„å€¼ã€‚ä¾‹å¦‚ï¼Œåœ¨æŸäº›å¤„ç†å™¨çš„æ±‡ç¼–è¯­è¨€ä¸­ï¼Œ<code>seta</code> å¯èƒ½æ„å‘³ç€å¦‚æœå…ˆå‰çš„æ¯”è¾ƒæŒ‡ä»¤ç»“æœæ˜¯å¤§äºï¼ˆAboveï¼‰ï¼Œåˆ™è®¾ç½®æŸä¸ªå¯„å­˜å™¨çš„æœ€ä½ä½ä¸º1ï¼ˆçœŸï¼‰ï¼Œå¦åˆ™ä¸º0ï¼ˆå‡ï¼‰ã€‚ä½†è¿™å¹¶ä¸æ˜¯æ ‡å‡†çš„ x86 æ±‡ç¼–æŒ‡ä»¤é›†çš„ä¸€éƒ¨åˆ†ã€‚</li>
<li><code>SETB</code> æ˜¯æ±‡ç¼–è¯­è¨€ä¸­çš„æŒ‡ä»¤ï¼Œç”¨äºè®¾ç½®ï¼ˆSetï¼‰ä¸€ä¸ªæ¯”ç‰¹ä½ï¼ˆBitï¼‰ä¸º1ã€‚è¿™ä¸ªæŒ‡ä»¤é€šå¸¸ä¾æ®æŸäº›æ¡ä»¶æ‰§è¡Œï¼Œæ¯”å¦‚åœ¨æ¡ä»¶è½¬ç§»æŒ‡ä»¤ä¹‹åï¼Œæ ¹æ®å¤„ç†å™¨çš„çŠ¶æ€æ ‡å¿—ï¼ˆå¦‚Zero Flag, Carry Flagç­‰ï¼‰æ¥å†³å®šæ˜¯å¦è®¾ç½®ç›®æ ‡ä½ç½®çš„æ¯”ç‰¹ä½ã€‚</li>
<li><code>REPZ</code> æ˜¯ x86 æ±‡ç¼–è¯­è¨€ä¸­çš„ä¸€ä¸ªå‰ç¼€æŒ‡ä»¤ï¼Œå®ƒæ˜¯ <code>REPE</code>ï¼ˆRepeat While Equalï¼Œå½“ ZF æ ‡å¿—ä½ä¸º1æ—¶é‡å¤ï¼‰çš„åŒä¹‰è¯ã€‚åœ¨é…åˆæŸäº›æŒ‡ä»¤ï¼ˆå¦‚ <code>CMPSB</code>ã€<code>CMPSW</code>ã€<code>CMPSD</code>ã€<code>CMPSQ</code> ç­‰ï¼‰ä½¿ç”¨æ—¶ï¼Œå®ƒä¼šæ ¹æ® Zero Flag (ZF) çš„çŠ¶æ€æ¥æ§åˆ¶å¾ªç¯çš„æ‰§è¡Œã€‚
<ul>
<li><code>CMPSB</code> æŒ‡ä»¤ä¼šæ¯”è¾ƒ<code>EDI</code>å’Œ<code>ESI</code>æ‰€æŒ‡å‘çš„å­—èŠ‚æ˜¯å¦ç›¸ç­‰ï¼Œå¹¶æ›´æ–°ç›¸å…³æ ‡å¿—ä½ï¼ˆåŒ…æ‹¬ZFï¼Œå³é›¶æ ‡å¿—ä½ï¼Œå¦‚æœä¸¤ä¸ªå­—èŠ‚ç›¸ç­‰åˆ™ZFè¢«ç½®ä¸º1ï¼Œå¦åˆ™ä¸º0ï¼‰ã€‚</li>
<li><code>REPZ</code> ä¼šæ£€æŸ¥ZFæ ‡å¿—ä½ï¼Œå¦‚æœZFä¸º1ï¼ˆå³å‰ä¸€æ¬¡æ¯”è¾ƒç»“æœä¸ºç›¸ç­‰ï¼‰ï¼Œåˆ™ç»§ç»­æ‰§è¡Œä¸‹ä¸€æ¬¡æ¯”è¾ƒï¼ŒåŒæ—¶è‡ªåŠ¨é€’å‡ECXå¯„å­˜å™¨ï¼ˆä½œä¸ºå¾ªç¯è®¡æ•°å™¨ï¼‰ã€‚</li>
<li>å¾ªç¯ä¼šä¸€ç›´æ‰§è¡Œï¼Œç›´åˆ°ECXå‡åˆ°0æˆ–è€…ZFå˜ä¸º0ï¼ˆå³é‡åˆ°ä¸ç›¸ç­‰çš„å­—èŠ‚ï¼‰ä¸ºæ­¢ã€‚</li>
</ul>
</li>
<li><code>è¿™é‡Œçš„strcmpè¢«å±•å¼€äº†</code></li>
</ul>
<hr />
<p><code>msvs 2010 optimizing</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token operator">$</span>SG3454 DB       <span class="token string">'true'</span>, <span class="token number">00H</span>
<span class="token operator">$</span>SG3456 DB       <span class="token string">'false'</span>, <span class="token number">00H</span>

_s<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>          <span class="token comment">; size = 4</span>
?is_bool@@YA_NPAD@Z PROC <span class="token comment">; is_bool</span>
          push   <span class="token register variable">esi</span>
          mov    <span class="token register variable">esi</span>, DWORD PTR _s<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">]</span><span class="token comment">;esi: address of s</span>
          mov    <span class="token register variable">ecx</span>, OFFSET <span class="token operator">$</span>SG3454 <span class="token comment">; 'true';ecx:address of true</span>
          mov    <span class="token register variable">eax</span>, <span class="token register variable">esi</span><span class="token comment">;eax=esi  eax:s</span>
          npad   <span class="token number">4</span> <span class="token comment">; align next label</span>
<span class="token label function">$LL6@is_bool:</span>
          mov    <span class="token register variable">dl</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span><span class="token comment">;dl:s[i];æ¯”è¾ƒç¬¬ä¸€ä¸ªå­—ç¬¦</span>
          cmp    <span class="token register variable">dl</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">]</span><span class="token comment">;s[i]==true[i]?</span>
          jne    SHORT <span class="token operator">$</span>LN7@is_bool
          test   <span class="token register variable">dl</span>, <span class="token register variable">dl</span>
          je     SHORT <span class="token operator">$</span>LN8@is_bool<span class="token comment">;åŒ¹é…æˆåŠŸ</span>
          mov    <span class="token register variable">dl</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">]</span><span class="token comment">;æ¯”è¾ƒç¬¬äºŒä¸ªå­—ç¬¦</span>
          cmp    <span class="token register variable">dl</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">]</span>
          jne    SHORT <span class="token operator">$</span>LN7@is_bool
          add    <span class="token register variable">eax</span>, <span class="token number">2</span><span class="token comment">;è·³åˆ°ä¸¤ä¸ªä»¥å </span>
          add    <span class="token register variable">ecx</span>, <span class="token number">2</span>
          test   <span class="token register variable">dl</span>, <span class="token register variable">dl</span><span class="token comment">;å†æ¬¡å¤„ç†ç©ºå­—ç¬¦</span>
          jne    SHORT <span class="token operator">$</span>LL6@is_bool<span class="token comment">;è¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯</span>
<span class="token label function">$LN8@is_bool:</span><span class="token comment">;åŒ¹é…æˆåŠŸ</span>
          xor    <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
          jmp    SHORT <span class="token operator">$</span>LN9@is_bool
<span class="token label function">$LN7@is_bool:</span><span class="token comment">;ç»“æŸï¼Œè·³è½¬åˆ°åŒ¹é…falseï¼Œè®¾ç½®eax=1</span>
          sbb    <span class="token register variable">eax</span>, <span class="token register variable">eax</span><span class="token comment">;eax=0</span>
          sbb    <span class="token register variable">eax</span>, <span class="token operator">-</span><span class="token number">1</span><span class="token comment">;eax=1</span>
<span class="token label function">$LN9@is_bool:</span>
          test   <span class="token register variable">eax</span>, <span class="token register variable">eax</span><span class="token comment">;eax=0?</span>
          jne    SHORT <span class="token operator">$</span>LN2@is_bool

          mov    <span class="token register variable">al</span>, <span class="token number">1</span>
          pop    <span class="token register variable">esi</span>

          ret    <span class="token number">0</span>
<span class="token label function">$LN2@is_bool:</span><span class="token comment">;å¤„ç†falseçš„éƒ¨åˆ†</span>

          mov    <span class="token register variable">ecx</span>, OFFSET <span class="token operator">$</span>SG3456 <span class="token comment">; 'false'</span>
          mov    <span class="token register variable">eax</span>, <span class="token register variable">esi</span>
<span class="token label function">$LL10@is_bool:</span>
          mov    <span class="token register variable">dl</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span>
          cmp    <span class="token register variable">dl</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">]</span>
          jne    SHORT <span class="token operator">$</span>LN11@is_bool<span class="token comment">;å¦‚æœåŒ¹é…å¤±è´¥</span>
          test   <span class="token register variable">dl</span>, <span class="token register variable">dl</span>
          je     SHORT <span class="token operator">$</span>LN12@is_bool
          mov    <span class="token register variable">dl</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">]</span>
          cmp    <span class="token register variable">dl</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">]</span>
          jne    SHORT <span class="token operator">$</span>LN11@is_bool
          add    <span class="token register variable">eax</span>, <span class="token number">2</span>
          add    <span class="token register variable">ecx</span>, <span class="token number">2</span>
          test   <span class="token register variable">dl</span>, <span class="token register variable">dl</span>
          jne    SHORT <span class="token operator">$</span>LL10@is_bool
<span class="token label function">$LN12@is_bool:</span>
          xor    <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
          jmp    SHORT <span class="token operator">$</span>LN13@is_bool
<span class="token label function">$LN11@is_bool:</span><span class="token comment">;</span>
          sbb    <span class="token register variable">eax</span>, <span class="token register variable">eax</span><span class="token comment">;eax=0</span>
          sbb    <span class="token register variable">eax</span>, <span class="token operator">-</span><span class="token number">1</span><span class="token comment">;eax=1</span>
<span class="token label function">$LN13@is_bool:</span>
          test   <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
          jne    SHORT <span class="token operator">$</span>LN1@is_bool<span class="token comment">;å¦‚æœeax!=0</span>

          xor    <span class="token register variable">al</span>, <span class="token register variable">al</span>
          pop    <span class="token register variable">esi</span>

          ret    <span class="token number">0</span>
<span class="token label function">$LN1@is_bool:</span><span class="token comment">;assert(0)</span>

          push   <span class="token number">11</span>
          push   OFFSET <span class="token operator">$</span>SG3458
          push   OFFSET <span class="token operator">$</span>SG3459
          call   DWORD PTR __imp___wassert
          add    <span class="token register variable">esp</span>, <span class="token number">12</span>
          pop    <span class="token register variable">esi</span>

          ret    <span class="token number">0</span>
?is_bool@@YA_NPAD@Z ENDP <span class="token comment">; is_bool</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p><code>sbb</code> æŒ‡ä»¤ä»£è¡¨ â€œSubtract with Borrowâ€ï¼ˆå¸¦å€Ÿä½å‡æ³•ï¼‰ï¼Œæ˜¯ä¸€ä¸ªç®—æœ¯è¿ç®—æŒ‡ä»¤ã€‚è¯¥æŒ‡ä»¤æ‰§è¡Œæ—¶ä¼šä»ä¸¤ä¸ªæ“ä½œæ•°çš„å·®å€¼ä¸­å†å‡å»å€Ÿä½æ ‡å¿—ï¼ˆCarry Flagï¼Œç®€ç§° CFï¼‰çš„å€¼ã€‚å€Ÿä½æ ‡å¿—é€šå¸¸ç”¨äºè¡¨ç¤ºå‰ä¸€ä¸ªæ“ä½œæ˜¯å¦äº§ç”Ÿäº†å€Ÿä½ï¼ˆåœ¨æ— ç¬¦å·æ•°è¿ç®—ä¸­ï¼‰æˆ–è¿›ä½ï¼ˆåœ¨æœ‰ç¬¦å·æ•°è¿ç®—ä¸­è¡¨ç¤ºè´Ÿæ•°æº¢å‡ºï¼‰ã€‚CFä½ä¸º1è¡¨ç¤ºæœ‰å€Ÿä½æˆ–è¿›ä½ï¼Œä¸º0è¡¨ç¤ºæ²¡æœ‰ã€‚</p>
<p><code>sbb 1,2</code>å…¶ä¸­1æ˜¯å­˜æ”¾ç»“æœçš„ç›®æ ‡ä½ç½®ï¼Œå€¼ä¼šåœ¨æ‰§è¡Œåè¢«æ›´æ–°;2æ˜¯è¢«å‡æ•°ï¼Œå€¼ä¸CFçš„å€¼ä¸€èµ·ä»1ä¸­å‡å»å³<code>æ“ä½œå¯¹è±¡1 = æ“ä½œå¯¹è±¡1 - æ“ä½œå¯¹è±¡2 - CF</code></p>
</li>
<li>
<p>åœ¨æœ¬ä¾‹ä¸­:é€šè¿‡è¿™ä¸¤æ¡æŒ‡ä»¤ï¼Œå¯¹äºä¸åŒçš„CFå€¼ï¼Œå°†EAXå¯„å­˜å™¨è®¾ç½®æˆä¸åŒçš„å€¼ï¼š</p>
<ul>
<li>CF ä¸º 0ï¼š <code>EAX = 0 - 0 = 0</code> å’Œ <code>EAX -(-1) = 0+1 = 1</code>ï¼›</li>
<li>CF ä¸º 1ï¼š <code>EAX = 0 - 1 = -1</code> å’Œ <code>EAX -(-1) = -1 -(-1)= -1+1 = 0</code>ã€‚</li>
</ul>
</li>
<li>
<p>å¯ä»¥å‘ç°è¿™æ®µä»£ç çš„<code>strcmp</code>æ˜¯æ¯ä¸¤ä¸ªå­—ç¬¦ä¸ºä¸€ç»„è¿›è¡Œå¤„ç†çš„</p>
</li>
</ul>
<hr />
<h4 id="strlen-2"><a class="markdownIt-Anchor" href="#strlen-2"></a> strlen</h4>
<hr />
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">strlen_test</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>s1<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
          <span class="token keyword">return</span> <span class="token function">strlen</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_s1<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span> <span class="token comment">; size = 4</span>
_strlen_test PROC
          mov    <span class="token register variable">eax</span>, DWORD PTR _s1<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span><span class="token comment">;eax=s[i]</span>
          lea    <span class="token register variable">edx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">]</span><span class="token comment">;edx=s[i+1]</span>
<span class="token label function">$LL3@strlen_tes:</span>
          mov    <span class="token register variable">cl</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span><span class="token comment">;cl:s[i]</span>
          inc    <span class="token register variable">eax</span><span class="token comment">;eax++</span>
          test   <span class="token register variable">cl</span>, <span class="token register variable">cl</span><span class="token comment">;ç»“æŸï¼Ÿ</span>
          jne    SHORT <span class="token operator">$</span>LL3@strlen_tes
          sub    <span class="token register variable">eax</span>, <span class="token register variable">edx</span><span class="token comment">;eax-edx</span>
          ret    <span class="token number">0</span>
_strlen_test ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><code>strlen</code>å¹¶æ²¡æœ‰ä¸“é—¨è®¾ç½®ä¸€ä¸ªå˜é‡æ¥è®¡ç®—é•¿åº¦ï¼Œè€Œæ˜¯åˆ©ç”¨äº†åœ°å€è®¡ç®—</li>
<li>å¦‚æœè¯»å–åˆ°äº†ç©ºå­—ç¬¦ï¼Œ<code>eax</code>æ˜¯<code>s[len+1]çš„åœ°å€</code>,è€Œ<code>edxæ˜¯s[1]çš„åœ°å€</code>,ç›¸å‡æ°å¥½æ˜¯é•¿åº¦</li>
</ul>
<h4 id="strcpy"><a class="markdownIt-Anchor" href="#strcpy"></a> strcpy</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">strcpy_test</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>s1<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>outbuf<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
          <span class="token function">strcpy</span><span class="token punctuation">(</span>outbuf<span class="token punctuation">,</span> s1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_s1<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>         <span class="token comment">; size = 4</span>
_outbuf<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">12</span>    <span class="token comment">; size = 4</span>
_strcpy_test PROC
          mov    <span class="token register variable">eax</span>, DWORD PTR _s1<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span><span class="token comment">;eax:s1</span>
          mov    <span class="token register variable">edx</span>, DWORD PTR _outbuf<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span><span class="token comment">;edx:outbuf</span>
          sub    <span class="token register variable">edx</span>, <span class="token register variable">eax</span><span class="token comment">;edx=outbuf-s1</span>
          npad   <span class="token number">6</span> <span class="token comment">; align next label</span>
<span class="token label function">$LL3@strcpy_tes:</span>
          mov    <span class="token register variable">cl</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span>
          mov    BYTE PTR <span class="token operator">[</span><span class="token register variable">edx</span><span class="token operator">+</span><span class="token register variable">eax</span><span class="token operator">]</span>, <span class="token register variable">cl</span>
          inc    <span class="token register variable">eax</span>
          test   <span class="token register variable">cl</span>, <span class="token register variable">cl</span>
          jne    SHORT <span class="token operator">$</span>LL3@strcpy_tes
          ret    <span class="token number">0</span>
_strcpy_test ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>è¿™é‡Œåªç”¨äº†ä¸€ä¸ªæŒ‡é’ˆå°±å®ç°äº†<code>strcpy</code></li>
<li>é¦–å…ˆè®¡ç®—ä¸¤ä¸ªå­—ç¬¦ä¸²ä½ç½®çš„åç§»,ç„¶åä»¤<code>s1[ptr+offset]=s1[ptr]</code>ä»è€Œå®ç°äº†å­—ç¬¦ä¸²çš„å¤åˆ¶</li>
</ul>
<h4 id="memset"><a class="markdownIt-Anchor" href="#memset"></a> memset</h4>
<ul>
<li>
<p>64å­—èŠ‚çš„æ“ä½œ</p>
<p>åœ¨ç¼–è¯‘é‚£äº›æ“ä½œå°ä½“ç§¯å†…å­˜å—çš„memset()å‡½æ•°æ—¶ï¼Œå¤šæ•°ç¼–è¯‘å™¨ä¸ä¼šåˆ†é…æ ‡å‡†çš„å‡½æ•°è°ƒç”¨æŒ‡ä»¤ï¼ˆcallï¼‰ï¼Œåè€Œä¼šåˆ†é…ä¸€å †çš„MOVæŒ‡ä»¤ï¼Œç›´æ¥èµ‹å€¼ã€‚</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token label function">f:</span>
          mov    QWORD PTR <span class="token operator">[</span><span class="token register variable">rdi</span><span class="token operator">]</span>, <span class="token number">0</span>
          mov    QWORD PTR <span class="token operator">[</span><span class="token register variable">rdi</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span>, <span class="token number">0</span>
          mov    QWORD PTR <span class="token operator">[</span><span class="token register variable">rdi</span><span class="token operator">+</span><span class="token number">16</span><span class="token operator">]</span>, <span class="token number">0</span>
          mov    QWORD PTR <span class="token operator">[</span><span class="token register variable">rdi</span><span class="token operator">+</span><span class="token number">24</span><span class="token operator">]</span>, <span class="token number">0</span>
          ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å³ä¸€æ¬¡æ¸…ç©º8ä¸ªå­—èŠ‚<code>QWORD</code>quad word  4ä¸ªword,8ä¸ªå­—èŠ‚</p>
</li>
<li>
<p>67å­—èŠ‚çš„æ“ä½œ</p>
<p>å³ä¸Šæ–‡ä»‹ç»çš„å¾ªç¯å±•å¼€æŠ€æœ¯</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">void</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>out<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
         <span class="token function">memset</span><span class="token punctuation">(</span>out<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">67</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">out<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>
f         PROC
          xor    <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
          mov    QWORD PTR <span class="token operator">[</span><span class="token register variable">rcx</span><span class="token operator">]</span>, <span class="token register variable">rax</span>
          mov    QWORD PTR <span class="token operator">[</span><span class="token register variable">rcx</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span>, <span class="token register variable">rax</span>
          mov    QWORD PTR <span class="token operator">[</span><span class="token register variable">rcx</span><span class="token operator">+</span><span class="token number">16</span><span class="token operator">]</span>, <span class="token register variable">rax</span>
          mov    QWORD PTR <span class="token operator">[</span><span class="token register variable">rcx</span><span class="token operator">+</span><span class="token number">24</span><span class="token operator">]</span>, <span class="token register variable">rax</span>
          mov    QWORD PTR <span class="token operator">[</span><span class="token register variable">rcx</span><span class="token operator">+</span><span class="token number">32</span><span class="token operator">]</span>, <span class="token register variable">rax</span>
          mov    QWORD PTR <span class="token operator">[</span><span class="token register variable">rcx</span><span class="token operator">+</span><span class="token number">40</span><span class="token operator">]</span>, <span class="token register variable">rax</span>
          mov    QWORD PTR <span class="token operator">[</span><span class="token register variable">rcx</span><span class="token operator">+</span><span class="token number">48</span><span class="token operator">]</span>, <span class="token register variable">rax</span>
          mov    QWORD PTR <span class="token operator">[</span><span class="token register variable">rcx</span><span class="token operator">+</span><span class="token number">56</span><span class="token operator">]</span>, <span class="token register variable">rax</span>
          mov    WORD PTR <span class="token operator">[</span><span class="token register variable">rcx</span><span class="token operator">+</span><span class="token number">64</span><span class="token operator">]</span>, <span class="token register variable">ax</span>
          mov    BYTE PTR <span class="token operator">[</span><span class="token register variable">rcx</span><span class="token operator">+</span><span class="token number">66</span><span class="token operator">]</span>, <span class="token register variable">al</span>
          ret    <span class="token number">0</span>
f         ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p>æœ€åçš„3ä¸ªå­—èŠ‚è¢«åˆ†æˆäº†ä¸€ä¸ªwordå’Œä¸€ä¸ªbyte</p>
</li>
<li>
<p>GCCè¿˜ä¼šåˆ†é…REP STOSQæŒ‡ä»¤ã€‚è¿™å¯èƒ½æ¯”ä¸€å †çš„MOVèµ‹å€¼æŒ‡ä»¤æ›´çŸ­ï¼Œæ•ˆç‡æ›´é«˜ã€‚</p>
</li>
</ul>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token comment">; å‡½æ•°å¼€å§‹</span>
<span class="token label function">f:</span>
          <span class="token comment">; å°† rdi æŒ‡å‘çš„å†…å­˜åŒºåŸŸçš„å‰ 8 å­—èŠ‚ï¼ˆ64 ä½ï¼‰ç½®ä¸º 0;å‰8å­—èŠ‚æ¸…0</span>
          mov    QWORD PTR <span class="token operator">[</span><span class="token register variable">rdi</span><span class="token operator">]</span>, <span class="token number">0</span>      
          <span class="token comment">; å°† rdi+59 å¤„çš„ 8 å­—èŠ‚ï¼ˆ64 ä½ï¼‰ç½®ä¸º 0</span>
          mov    QWORD PTR <span class="token operator">[</span><span class="token register variable">rdi</span><span class="token operator">+</span><span class="token number">59</span><span class="token operator">]</span>, <span class="token number">0</span>        <span class="token comment">;å8å­—èŠ‚æ¸…é›¶</span>
          <span class="token comment">; å°† rdi çš„å€¼å¤åˆ¶åˆ° rcx</span>
          mov    <span class="token register variable">rcx</span>, <span class="token register variable">rdi</span>      <span class="token comment">;rcx=rdi  rdi:ç¬¬ä¸€ä¸ªå­—èŠ‚çš„åœ°å€</span>
        <span class="token comment">; rdi = rdi + 8ï¼Œrdi åœ°å€å‘åç§»åŠ¨ 8 å­—èŠ‚</span>
          lea    <span class="token register variable">rdi</span>, <span class="token operator">[</span><span class="token register variable">rdi</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span>    <span class="token comment">;rdiæŒ‡å‘ç¬¬9ä¸ªå­—èŠ‚</span>
          <span class="token comment">; å°† eax æ¸…é›¶ï¼ˆeax = 0ï¼‰</span>
          xor    <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
          <span class="token comment">; rdi å¯¹é½åˆ° 8 å­—èŠ‚è¾¹ç•Œ,ç›®çš„æ˜¯ä¸ºäº†å¤„ç†å†…å­˜çš„æ—¶å€™æ•ˆç‡æ›´é«˜</span>
          and    <span class="token register variable">rdi</span>, <span class="token operator">-</span><span class="token number">8</span><span class="token comment">;rdiåªå¯èƒ½å‡å°‘,æŒ‡å‘ç¬¬1~9ä¸ªå­—èŠ‚çš„æŸä¸ªå­—èŠ‚ï¼Œä¸8å­—èŠ‚å¯¹é½</span>
          <span class="token comment">; è®¡ç®—å¹¶ä¸”å°† rcx å‡å» rdi çš„å€¼</span>
          sub    <span class="token register variable">rcx</span>, <span class="token register variable">rdi</span>
          <span class="token comment">; å°† ecx çš„å€¼åŠ ä¸Š 67</span>
          add    <span class="token register variable">ecx</span>, <span class="token number">67</span>
          
          <span class="token comment">; å°† ecx å³ç§» 3 ä½ï¼Œç›¸å½“äºé™¤ä»¥ 8</span>
          shr    <span class="token register variable">ecx</span>, <span class="token number">3</span><span class="token comment">;è®¡ç®—è¿˜è¦æ¸…ç©ºå¤šå°‘ä¸ª8å­—èŠ‚</span>
          
          <span class="token comment">; ä½¿ç”¨ rep stosq æŒ‡ä»¤ï¼Œå°† raxï¼ˆå€¼ä¸º 0ï¼‰å¡«å……åˆ° rdi æŒ‡å‘çš„å†…å­˜ï¼Œé‡å¤ ecx æ¬¡</span>
          rep stosq<span class="token comment">;æ¸…ç©ºï¼Œå³ç§»...</span>
          
          <span class="token comment">; è¿”å›è°ƒç”¨å‡½æ•°</span>
          ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><code>REP STOSQ</code> æŒ‡ä»¤æ˜¯ä¸€æ¡ x86 æ±‡ç¼–æŒ‡ä»¤ï¼Œç”¨äºåœ¨å†…å­˜ä¸­å¡«å……ä¸€ä¸ªæŒ‡å®šçš„åŒºåŸŸã€‚<code>REP</code> å‰ç¼€ä¸ <code>STOSQ</code> æŒ‡ä»¤ç»“åˆä½¿ç”¨ï¼Œç”¨æ¥å¿«é€Ÿåœ°å°† RAX å¯„å­˜å™¨ä¸­çš„å€¼å¡«å……åˆ°ä¸€ä¸ªå†…å­˜åŒºåŸŸã€‚</li>
<li><strong>STOSQ</strong>ï¼šè¯¥æŒ‡ä»¤å°† RAX å¯„å­˜å™¨çš„å€¼å­˜å‚¨åˆ°ç”± RDI å¯„å­˜å™¨æŒ‡å‘çš„å†…å­˜ä½ç½®ï¼Œå¹¶æ ¹æ® DFï¼ˆæ–¹å‘æ ‡å¿—ï¼ŒDirection Flagï¼‰å†³å®šæŒ‡é’ˆçš„é€’å¢æˆ–é€’å‡ã€‚æ¯æ¬¡å°† 64 ä½çš„ RAX å€¼å­˜å‚¨åˆ°å†…å­˜ä¸­ã€‚</li>
<li><strong>REP</strong>: <code>REP</code> å‰ç¼€ç”¨æ¥æŒ‡ç¤º <code>STOSQ</code> æŒ‡ä»¤åº”é‡å¤æ‰§è¡Œï¼Œç›´åˆ° RCX å¯„å­˜å™¨çš„å€¼å˜ä¸ºé›¶ã€‚å…·ä½“æ¥è¯´ï¼Œ<code>REP</code> å‰ç¼€ä¼šå¯¹ <code>STOSQ</code> æŒ‡ä»¤è¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š
<ul>
<li>å…ˆæ£€æŸ¥ RCX æ˜¯å¦ä¸ºé›¶ã€‚å¦‚æœ RCX ä¸ºé›¶ï¼ŒæŒ‡ä»¤ç»“æŸã€‚</li>
<li>å°† RAX çš„å€¼å­˜å‚¨åˆ° RDI æ‰€æŒ‡å‘çš„ä½ç½®ã€‚</li>
<li>æ ¹æ® DF æ ‡å¿—ï¼ŒRDI é€’å¢æˆ–é€’å‡ 8 ä½ã€‚</li>
<li>å‡å°‘ RCX çš„å€¼ã€‚</li>
<li>å¾ªç¯ç›´åˆ° RCX å‡åˆ°é›¶ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="memcpy"><a class="markdownIt-Anchor" href="#memcpy"></a> memcpy</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">memcpy_7</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>inbuf<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>outbuf<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
          <span class="token function">memcpy</span><span class="token punctuation">(</span>outbuf<span class="token operator">+</span><span class="token number">10</span><span class="token punctuation">,</span> inbuf<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>åœ¨ç¼–è¯‘é‚£äº›å¤åˆ¶å°å°ºå¯¸å†…å­˜å—çš„<code>memcpy()</code>å‡½æ•°æ—¶ï¼Œå¤šæ•°ç¼–è¯‘å™¨ä¼šåˆ†é…ä¸€ç³»åˆ—çš„<code>MOV</code>æŒ‡ä»¤ã€‚</li>
</ul>
<p><code>msvs optimize</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_inbuf<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>      <span class="token comment">; size = 4</span>
_outbuf<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">12</span>    <span class="token comment">; size = 4</span>
_memcpy_7 PROC
         mov     <span class="token register variable">ecx</span>, DWORD PTR _inbuf<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span><span class="token comment">;ecx:inbuf</span>
         mov     <span class="token register variable">edx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">]</span><span class="token comment">;edx:inbuf</span>
         mov     <span class="token register variable">eax</span>, DWORD PTR _outbuf<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span><span class="token comment">;eax:outbuf</span>
         mov     DWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">10</span><span class="token operator">]</span>, <span class="token register variable">edx</span><span class="token comment">;outbuf+10=inbuf;å¤„ç†4å­—èŠ‚</span>
         mov     <span class="token register variable">dx</span>, WORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span><span class="token comment">;dx:inbuf->inbuf+4</span>
         mov     WORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">14</span><span class="token operator">]</span>, <span class="token register variable">dx</span><span class="token comment">;oubuf+14=inbuf+4;å¤„ç†å‰©ä¸‹çš„2ä¸ªå­—èŠ‚ </span>
         mov     <span class="token register variable">cl</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">6</span><span class="token operator">]</span>  <span class="token comment">;</span>
         mov     BYTE PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">16</span><span class="token operator">]</span>, <span class="token register variable">cl</span><span class="token comment">;å¤„ç†å‰©ä¸‹çš„ä¸€ä¸ªå­—èŠ‚</span>
         ret     <span class="token number">0</span>
_memcpy_7 ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>gcc optimize</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token label function">memcpy_7:</span>
          push   <span class="token register variable">ebx</span>
          mov    <span class="token register variable">eax</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span><span class="token comment">;eax:arg2,inbuf</span>
          mov    <span class="token register variable">ecx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">12</span><span class="token operator">]</span><span class="token comment">;ecx:arg3,outbuf</span>
          mov    <span class="token register variable">ebx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span><span class="token comment">;ebx=eax:arg2</span>
          lea    <span class="token register variable">edx</span>, <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">10</span><span class="token operator">]</span>
          mov    DWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">10</span><span class="token operator">]</span>, <span class="token register variable">ebx</span>
          movzx  <span class="token register variable">ecx</span>, WORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>
          mov    WORD PTR <span class="token operator">[</span><span class="token register variable">edx</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">cx</span>
          movzx  <span class="token register variable">eax</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">6</span><span class="token operator">]</span>
          mov    BYTE PTR <span class="token operator">[</span><span class="token register variable">edx</span><span class="token operator">+</span><span class="token number">6</span><span class="token operator">]</span>, <span class="token register variable">al</span>
          pop    <span class="token register variable">ebx</span>
          ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>é¦–å…ˆå¤åˆ¶4ä¸ªå­—èŠ‚</li>
<li>å†å¤åˆ¶2ä¸ªå­—èŠ‚</li>
<li>æœ€åå¤åˆ¶1ä¸ªå­—èŠ‚</li>
</ul>
<hr />
<ul>
<li>ç¼–è¯‘å™¨è¿˜ä¼šé€šè¿‡èµ‹å€¼æŒ‡ä»¤MOVå¤åˆ¶ç»“æ„ä½“ï¼ˆstructureï¼‰å‹æ•°æ®ã€‚</li>
<li>å¤§å°ºå¯¸å†…å­˜å—çš„æ“ä½œï¼šä¸åŒçš„ç¼–è¯‘å™¨ä¼šæœ‰ä¸åŒçš„æŒ‡ä»¤åˆ†é…æ–¹æ¡ˆã€‚</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">memcpy_128</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>inbuf<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>outbuf<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
          <span class="token function">memcpy</span><span class="token punctuation">(</span>outbuf<span class="token operator">+</span><span class="token number">10</span><span class="token punctuation">,</span> inbuf<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">memcpy_123</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>inbuf<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>outbuf<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
          <span class="token function">memcpy</span><span class="token punctuation">(</span>outbuf<span class="token operator">+</span><span class="token number">10</span><span class="token punctuation">,</span> inbuf<span class="token punctuation">,</span> <span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>optimize msvs</code></p>
<p><em>MSVCåˆ†é…äº†å•æ¡MOVSDæŒ‡ä»¤ã€‚åœ¨å¾ªç¯æ§åˆ¶å˜é‡ECXçš„é…åˆä¸‹ï¼ŒMOVSDå¯ä¸€æ­¥å®Œæˆ128ä¸ªå­—èŠ‚çš„æ•°æ®å¤åˆ¶ã€‚å…¶åŸå› æ˜¾ç„¶æ˜¯128èƒ½è¢«4æ•´é™¤ã€‚</em></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_inbuf<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>            <span class="token comment">; size = 4</span>
_outbuf<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">12</span>          <span class="token comment">; size = 4</span>
_memcpy_128 PROC
          push   <span class="token register variable">esi</span>
          mov    <span class="token register variable">esi</span>, DWORD PTR _inbuf<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">]</span>
          push   <span class="token register variable">edi</span>
          mov    <span class="token register variable">edi</span>, DWORD PTR _outbuf<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>
          add    <span class="token register variable">edi</span>, <span class="token number">10</span>
          mov    <span class="token register variable">ecx</span>, <span class="token number">32</span>
          rep movsd
          pop    <span class="token register variable">edi</span>
          pop    <span class="token register variable">esi</span>
          ret    <span class="token number">0</span>
_memcpy_128 ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>è¿™é‡Œrep movsdè”ç”¨</code></p>
<ul>
<li>
<p><strong>rep</strong> æ˜¯ä¸€ä¸ªå‰ç¼€æŒ‡ä»¤ï¼ŒæŒ‡ç¤ºCPUé‡å¤æ‰§è¡Œç´§è·Ÿå…¶åçš„æŒ‡ä»¤ï¼Œç›´åˆ°CXï¼ˆ16ä½å’Œ32ä½æ¨¡å¼ï¼‰æˆ–RCXï¼ˆ64ä½æ¨¡å¼ï¼‰å¯„å­˜å™¨çš„å€¼å‡åˆ°é›¶ã€‚åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼ŒCX/RCXçš„å€¼ä¼šåœ¨æ¯æ¬¡è¿­ä»£åè‡ªåŠ¨å‡1ã€‚</p>
</li>
<li>
<p><strong>movsd</strong> æ˜¯â€œmove double wordâ€çš„ç¼©å†™ï¼Œå®ƒå°†DSæ®µå¯„å­˜å™¨æŒ‡å‘çš„æºåœ°å€ï¼ˆESI/RSIï¼‰ä¸­çš„ä¸€ä¸ªåŒå­—ï¼ˆ4å­—èŠ‚ï¼‰æ•°æ®å¤åˆ¶åˆ°ESæ®µå¯„å­˜å™¨æŒ‡å‘çš„ç›®æ ‡åœ°å€ï¼ˆEDI/RDIï¼‰ã€‚åœ¨å¤åˆ¶ä¹‹åï¼Œæ ¹æ®æ–¹å‘æ ‡å¿—ï¼ˆDFï¼‰çš„çŠ¶æ€ï¼ŒESI/RSIå’ŒEDI/RDIä¼šè‡ªåŠ¨é€’å¢ï¼ˆå¦‚æœDFä¸º0ï¼‰æˆ–é€’å‡ï¼ˆå¦‚æœDFä¸º1ï¼‰ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå¤§å¤šæ•°å­—ç¬¦ä¸²æ“ä½œå‰ä¼šå…ˆæ‰§è¡Œ<code>cld</code>æŒ‡ä»¤æ¥æ¸…é›¶DFï¼Œç¡®ä¿åœ°å€å‘å‰é€’å¢ã€‚</p>
</li>
<li>
<p>åœ¨å¤åˆ¶123ä¸ªå­—èŠ‚çš„ç¨‹åºé‡Œï¼Œç¼–è¯‘å™¨é¦–å…ˆé€šè¿‡MOVSDæŒ‡ä»¤å¤åˆ¶30ä¸ª32å­—èŠ‚ï¼ˆä¹Ÿå°±æ˜¯120å­—èŠ‚ï¼‰ï¼Œç„¶åä¾æ¬¡é€šè¿‡MOVSWæŒ‡ä»¤å’ŒMOVSBæŒ‡ä»¤å¤åˆ¶2ä¸ªå­—èŠ‚å’Œ1ä¸ªå­—èŠ‚ã€‚</p>
</li>
</ul>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_inbuf<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>            <span class="token comment">; size = 4</span>
_outbuf<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">12</span>          <span class="token comment">; size = 4</span>
_memcpy_123 PROC
          push   <span class="token register variable">esi</span>
          mov    <span class="token register variable">esi</span>, DWORD PTR _inbuf<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">]</span>
          push   <span class="token register variable">edi</span>
          mov    <span class="token register variable">edi</span>, DWORD PTR _outbuf<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>
          add    <span class="token register variable">edi</span>, <span class="token number">10</span>
          mov    <span class="token register variable">ecx</span>, <span class="token number">30</span>
          rep movsd
          movsw
          movsb
          pop    <span class="token register variable">edi</span>
          pop    <span class="token register variable">esi</span>
          ret    <span class="token number">0</span>
_memcpy_123 ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr />
<p><code>GCC</code></p>
<p>GCCåˆ™åˆ†é…äº†ä¸€ä¸ªå¤§å‹çš„é€šç”¨çš„å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°é€‚ç”¨äºä»»æ„å¤§å°çš„å†…å­˜å—å¤åˆ¶æ“ä½œã€‚</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token comment">; memcpy_123 å‡½æ•°å¼€å§‹</span>
<span class="token label function">.LFB3:</span>
    <span class="token comment">; ä¿å­˜ediå’Œesiå¯„å­˜å™¨ï¼Œå› ä¸ºå®ƒä»¬å°†è¢«ç”¨äºæ•°æ®å¤åˆ¶</span>
    push   <span class="token register variable">edi</span>
    push   <span class="token register variable">esi</span>

    <span class="token comment">; è®¾ç½®ä¸€ä¸ªè®¡æ•°å™¨eax = 123ï¼Œç”¨äºæ§åˆ¶å¤åˆ¶æˆ–å…¶ä»–æ“ä½œçš„å¾ªç¯</span>
    mov    <span class="token register variable">eax</span>, <span class="token number">123</span>

    <span class="token comment">; è·å–ç›®æ ‡åœ°å€ï¼ˆedxï¼‰å’Œæºåœ°å€ï¼ˆesiï¼‰ä»æ ˆä¸­</span>
    mov    <span class="token register variable">edx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">16</span><span class="token operator">]</span>  <span class="token comment">; ç›®æ ‡åœ°å€</span>
    mov    <span class="token register variable">esi</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">12</span><span class="token operator">]</span>  <span class="token comment">; æºåœ°å€</span>

    <span class="token comment">; è°ƒæ•´ç›®æ ‡åœ°å€ediï¼Œé¢„å…ˆå¢åŠ 10å­—èŠ‚åç§»</span>
    lea    <span class="token register variable">edi</span>, <span class="token operator">[</span><span class="token register variable">edx</span><span class="token operator">+</span><span class="token number">10</span><span class="token operator">]</span>

    <span class="token comment">; æ£€æŸ¥ç›®æ ‡åœ°å€ediæ˜¯å¦ä¸ºå¥‡æ•°æˆ–å¶æ•°å¯¹é½ï¼Œä»¥ä¾¿è¿›è¡Œç›¸åº”çš„å¯¹é½å¤„ç†</span>
    test   <span class="token register variable">edi</span>, <span class="token number">1</span>  <span class="token comment">; æ£€æŸ¥å¥‡æ•°å¯¹é½</span>
    jne    .L24    <span class="token comment">; ä¸æ˜¯å¶æ•°å¯¹é½åˆ™è·³è½¬å¤„ç†</span>
    test   <span class="token register variable">edi</span>, <span class="token number">2</span>  <span class="token comment">; æ£€æŸ¥4å­—èŠ‚å¯¹é½</span>
    jne    .L25    <span class="token comment">; ä¸æ˜¯4å­—èŠ‚å¯¹é½åˆ™è·³è½¬å¤„ç†</span>

<span class="token label function">.L7:</span> <span class="token comment">; ä¸»å¤åˆ¶å¾ªç¯å¼€å§‹</span>
    <span class="token comment">; è®¡ç®—éœ€è¦å¤åˆ¶çš„åŒå­—ï¼ˆ4å­—èŠ‚ï¼‰æ•°é‡ï¼Œå¹¶æ¸…é™¤edxå‡†å¤‡ä½œä¸ºè®¡æ•°å™¨</span>
    mov    <span class="token register variable">ecx</span>, <span class="token register variable">eax</span>
    xor    <span class="token register variable">edx</span>, <span class="token register variable">edx</span>
    shr    <span class="token register variable">ecx</span>, <span class="token number">2</span>  <span class="token comment">; å°†eaxé™¤ä»¥4ï¼Œå¾—åˆ°åŒå­—æ•°é‡</span>

    <span class="token comment">; å¤åˆ¶åŒå­—æ•°æ®ï¼Œå¦‚æœæœ‰å‰©ä½™å­—èŠ‚åˆ™å•ç‹¬å¤„ç†</span>
    test   <span class="token register variable">al</span>, <span class="token number">2</span>  <span class="token comment">; æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦å¤„ç†çš„å‰©ä½™2å­—èŠ‚</span>
    rep movsd   <span class="token comment">; æ‰¹é‡å¤åˆ¶åŒå­—</span>
    je     .L8    <span class="token comment">; å¦‚æœæ²¡æœ‰å‰©ä½™å­—èŠ‚ï¼Œè·³è½¬åˆ°ç»“å°¾</span>

    <span class="token comment">; å¤„ç†å‰©ä½™çš„2å­—èŠ‚æ•°æ®</span>
    movzx  <span class="token register variable">edx</span>, WORD PTR <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">]</span>
    mov    WORD PTR <span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">]</span>, <span class="token register variable">dx</span>
    mov    <span class="token register variable">edx</span>, <span class="token number">2</span>

<span class="token label function">.L8:</span> <span class="token comment">; æ£€æŸ¥å¹¶å¤„ç†å•å­—èŠ‚å¯¹é½æƒ…å†µ</span>
    test   <span class="token register variable">al</span>, <span class="token number">1</span>  <span class="token comment">; æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦å¤„ç†çš„å‰©ä½™1å­—èŠ‚</span>
    je     .L5    <span class="token comment">; å¦‚æœæ²¡æœ‰å‰©ä½™å­—èŠ‚ï¼Œè·³è½¬åˆ°æ¢å¤å¯„å­˜å™¨å¹¶è¿”å›</span>

    <span class="token comment">; å¤„ç†æœ€åä¸€ä¸ªå­—èŠ‚</span>
    movzx  <span class="token register variable">eax</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token register variable">edx</span><span class="token operator">]</span>
    mov    BYTE PTR <span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">+</span><span class="token register variable">edx</span><span class="token operator">]</span>, <span class="token register variable">al</span>

<span class="token label function">.L5:</span> <span class="token comment">; æ¢å¤esiå’Œediå¯„å­˜å™¨</span>
    pop    <span class="token register variable">esi</span>
    pop    <span class="token register variable">edi</span>

    <span class="token comment">; å‡½æ•°è¿”å›</span>
    ret

<span class="token comment">; ä»¥ä¸‹ä¸ºå¯¹é½å¤„ç†åˆ†æ”¯</span>
<span class="token label function">.L24:</span> 
    <span class="token comment">; å¯¹ç›®æ ‡åœ°å€ediä¸ºå¥‡æ•°æ—¶çš„ç‰¹æ®Šå¤„ç†</span>
    ...
<span class="token label function">.L25:</span>
    <span class="token comment">; å¯¹ç›®æ ‡åœ°å€ediä¸ºé4å­—èŠ‚å¯¹é½æ—¶çš„ç‰¹æ®Šå¤„ç†</span>
    ...

<span class="token label function">.LFE3:</span> <span class="token comment">; å‡½æ•°ç»“æŸæ ‡ç­¾</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>é€šç”¨å†…å­˜å¤åˆ¶å‡½æ•°é€šå¸¸çš„å·¥ä½œåŸç†å¦‚ä¸‹ï¼šé¦–å…ˆè®¡ç®—å—æœ‰å¤šå°‘ä¸ªå­—ï¼ˆ32ä½ï¼‰ï¼Œç„¶åç”¨MOVSDæŒ‡ä»¤å¤åˆ¶è¿™äº›å†…å­˜å—ï¼Œç„¶åé€ä¸€å¤åˆ¶å‰©ä½™çš„å­—èŠ‚ã€‚</p>
<p>æ›´ä¸ºå¤æ‚çš„å†…å­˜å¤åˆ¶å‡½æ•°åˆ™ä¼šåˆ©ç”¨<code>SIMDæŒ‡ä»¤é›†è¿›è¡Œå¤åˆ¶</code>ï¼Œè¿™ç§å¤åˆ¶è¿˜ä¼š<code>æ¶‰åŠå†…å­˜åœ°å€å¯¹é½</code>çš„é—®é¢˜ã€‚</p>
<h4 id="memcmp"><a class="markdownIt-Anchor" href="#memcmp"></a> memcmp</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">memcpy_1235</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>inbuf<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>outbuf<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
          <span class="token function">memcmp</span><span class="token punctuation">(</span>outbuf<span class="token operator">+</span><span class="token number">10</span><span class="token punctuation">,</span> inbuf<span class="token punctuation">,</span> <span class="token number">1235</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ— è®ºå†…å­˜å—çš„å°ºå¯¸æ˜¯å¤šå¤§ï¼ŒMSVC 2010éƒ½ä¼šæ’å…¥ç›¸åŒçš„é€šç”¨æ¯”è¾ƒå‡½æ•°ã€‚</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token comment">; å®šä¹‰è¾“å…¥å‚æ•°ä½ç½®</span>
_buf1<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>       <span class="token comment">; _buf1$ä½äºæ ˆä¸Šçš„ä½ç½®ï¼Œå¤§å°ä¸º4å­—èŠ‚</span>
_buf2<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">12</span>      <span class="token comment">; _buf2$ä½äºæ ˆä¸Šçš„ä½ç½®ï¼Œå¤§å°ä¸º4å­—èŠ‚</span>

_memcmp_1235 PROC
    <span class="token comment">; åŠ è½½ç¼“å†²åŒº2çš„åœ°å€åˆ°edx</span>
    mov    <span class="token register variable">edx</span>, DWORD PTR _buf2<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
    <span class="token comment">; åŠ è½½ç¼“å†²åŒº1çš„åœ°å€åˆ°ecx</span>
    mov    <span class="token register variable">ecx</span>, DWORD PTR _buf1<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>

    <span class="token comment">; ä¿å­˜ediå’Œesiï¼Œä¸ºåç»­ä½¿ç”¨å‡†å¤‡</span>
    push   <span class="token register variable">esi</span>
    push   <span class="token register variable">edi</span>

    <span class="token comment">; åˆå§‹åŒ–è®¡æ•°å™¨esiä¸º1235</span>
    mov    <span class="token register variable">esi</span>, <span class="token number">1235</span>

    <span class="token comment">; ç›®æ ‡ç¼“å†²åŒºåœ°å€é¢„åç§»10å­—èŠ‚</span>
    add    <span class="token register variable">edx</span>, <span class="token number">10</span>

<span class="token label function">$LL4@memcmp_123:</span> <span class="token comment">; ä¸»å¾ªç¯å¼€å§‹</span>
    <span class="token comment">; æ¯”è¾ƒå½“å‰ä½ç½®çš„åŒå­—ï¼ˆ4å­—èŠ‚ï¼‰</span>
    mov    <span class="token register variable">eax</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">edx</span><span class="token operator">]</span>   <span class="token comment">; eax = *buf2 + 10</span>
    cmp    <span class="token register variable">eax</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">]</span>   <span class="token comment">; æ¯”è¾ƒeaxå’Œ*buf1</span>
    jne    SHORT <span class="token operator">$</span>LN10@memcmp_123 <span class="token comment">; è‹¥ä¸åŒï¼Œè·³è½¬åˆ°å·®å¼‚å¤„ç†</span>

    <span class="token comment">; å¦‚æœç›¸ç­‰ï¼Œè®¡æ•°å™¨é€’å‡ï¼ŒæŒ‡é’ˆå‰è¿›</span>
    sub    <span class="token register variable">esi</span>, <span class="token number">4</span>
    add    <span class="token register variable">ecx</span>, <span class="token number">4</span>
    add    <span class="token register variable">edx</span>, <span class="token number">4</span>

    <span class="token comment">; æ£€æŸ¥è®¡æ•°å™¨æ˜¯å¦å¤§äºç­‰äº4ï¼Œè‹¥å°äºåˆ™ç»“æŸå¾ªç¯</span>
    cmp    <span class="token register variable">esi</span>, <span class="token number">4</span>
    jae    SHORT <span class="token operator">$</span>LL4@memcmp_123

<span class="token label function">$LN10@memcmp_123:</span> <span class="token comment">; å‘ç°å·®å¼‚åçš„å¤„ç†</span>
    <span class="token comment">; æ¯”è¾ƒå‰©ä½™å­—èŠ‚ï¼Œé€å­—èŠ‚æ¯”è¾ƒç›´åˆ°æ‰¾åˆ°å·®å¼‚æˆ–ç»“æŸ</span>
    movzx  <span class="token register variable">edi</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">]</span>   <span class="token comment">; æ¯”è¾ƒç¬¬ä¸€ä¸ªå­—èŠ‚</span>
    movzx  <span class="token register variable">eax</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">edx</span><span class="token operator">]</span>
    sub    <span class="token register variable">eax</span>, <span class="token register variable">edi</span>
    jne    SHORT <span class="token operator">$</span>LN7@memcmp_123

    movzx  <span class="token register variable">eax</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">edx</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">]</span>   <span class="token comment">; æ¯”è¾ƒç¬¬äºŒä¸ªå­—èŠ‚</span>
    movzx  <span class="token register variable">edi</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">]</span>
    sub    <span class="token register variable">eax</span>, <span class="token register variable">edi</span>
    jne    SHORT <span class="token operator">$</span>LN7@memcmp_123

    movzx  <span class="token register variable">eax</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">edx</span><span class="token operator">+</span><span class="token number">2</span><span class="token operator">]</span>   <span class="token comment">; æ¯”è¾ƒç¬¬ä¸‰ä¸ªå­—èŠ‚</span>
    movzx  <span class="token register variable">edi</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">2</span><span class="token operator">]</span>
    sub    <span class="token register variable">eax</span>, <span class="token register variable">edi</span>
    jne    SHORT <span class="token operator">$</span>LN7@memcmp_123

    <span class="token comment">; å¦‚æœesiä¸å°äº3ï¼Œè¯´æ˜è‡³å°‘æ¯”è¾ƒäº†4å­—èŠ‚ï¼Œæ¯”è¾ƒç¬¬å››ä¸ªå­—èŠ‚</span>
    cmp    <span class="token register variable">esi</span>, <span class="token number">3</span>
    jbe    SHORT <span class="token operator">$</span>LN6@memcmp_123
    movzx  <span class="token register variable">eax</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">edx</span><span class="token operator">+</span><span class="token number">3</span><span class="token operator">]</span>
    movzx  <span class="token register variable">ecx</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">3</span><span class="token operator">]</span>
    sub    <span class="token register variable">eax</span>, <span class="token register variable">ecx</span>

<span class="token label function">$LN7@memcmp_123:</span> <span class="token comment">; ç»“æœå¤„ç†</span>
    sar    <span class="token register variable">eax</span>, <span class="token number">31</span>                 <span class="token comment">; è®¾ç½®ç»“æœæ­£è´Ÿï¼ˆé€šè¿‡ç§»ä½å®ç°ï¼‰</span>
    pop    <span class="token register variable">edi</span>
    or     <span class="token register variable">eax</span>, <span class="token number">1</span>                  <span class="token comment">; ç¡®ä¿ç»“æœéé›¶</span>
    pop    <span class="token register variable">esi</span>
    ret    <span class="token number">0</span>                      <span class="token comment">; è¿”å›ç»“æœ</span>

<span class="token label function">$LN6@memcmp_123:</span> <span class="token comment">; æœªå‘ç°å·®å¼‚ï¼Œæ‰€æœ‰å·²æ£€æŸ¥å­—èŠ‚å‡ç›¸åŒ</span>
    pop    <span class="token register variable">edi</span>
    xor    <span class="token register variable">eax</span>, <span class="token register variable">eax</span>               <span class="token comment">; eax = 0ï¼Œè¡¨ç¤ºæ— å·®å¼‚</span>
    pop    <span class="token register variable">esi</span>
    ret    <span class="token number">0</span>                      <span class="token comment">; è¿”å›0ï¼Œè¡¨ç¤ºä¸¤ä¸ªç¼“å†²åŒºå†…å®¹ç›¸åŒ</span>
_memcmp_1235 ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="chap44-c99æ ‡å‡†çš„å—é™æŒ‡é’ˆ"><a class="markdownIt-Anchor" href="#chap44-c99æ ‡å‡†çš„å—é™æŒ‡é’ˆ"></a> Chap44 C99æ ‡å‡†çš„å—é™æŒ‡é’ˆ</h3>
<ul>
<li>
<p>ä»€ä¹ˆæ˜¯<em>å—é™æŒ‡é’ˆ?</em></p>
<p><code>restrict</code> æ˜¯ C99 æ ‡å‡†å¼•å…¥çš„ä¸€ç§ç±»å‹é™å®šç¬¦ï¼Œç”¨äºæŒ‡é’ˆå£°æ˜ä¸­ã€‚å®ƒå‘Šè¯‰ç¼–è¯‘å™¨ï¼Œä¸€ä¸ªæŒ‡é’ˆæ˜¯å”¯ä¸€è®¿é—®æŸä¸€å¯¹è±¡çš„æ–¹å¼ã€‚è¿™ä¸€é™å®šç¬¦æä¾›äº†æ›´å¤šçš„ä¼˜åŒ–æœºä¼šï¼Œå°¤å…¶æ˜¯å¯¹ç¼–è¯‘å™¨è€Œè¨€ï¼Œå› ä¸ºå®ƒæ¶ˆé™¤äº†æŒ‡é’ˆåˆ«åï¼ˆpointer aliasingï¼‰çš„å¯èƒ½æ€§ã€‚</p>
<p>ç¤ºä¾‹ä¸è§£é‡Š</p>
<p>è€ƒè™‘ä¸€ç§æƒ…å†µï¼Œæˆ‘ä»¬å¸Œæœ›å¯¹ä¸¤ä¸ªæ•°ç»„è¿›è¡Œå…ƒç´ ç›¸åŠ ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">add_arrays</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>a<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>b<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>c<span class="token punctuation">,</span> <span class="token class-name">size_t</span> n<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        c<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å‡è®¾å‡½æ•°è°ƒç”¨æ—¶ <code>a</code>ã€<code>b</code> å’Œ <code>c</code> å¯èƒ½æŒ‡å‘åŒä¸€å†…å­˜åŒºåŸŸçš„ä¸€éƒ¨åˆ†ã€‚ç¼–è¯‘å™¨åœ¨è¿™ç§æƒ…å†µä¸‹å¿…é¡»å¾ˆè°¨æ…åœ°ç”Ÿæˆä»£ç ï¼Œå› ä¸ºå®ƒæ— æ³•ç¡®å®šå†…å­˜åŒºåŸŸæ˜¯å¦é‡å ã€‚</p>
<p>ä½¿ç”¨ <code>restrict</code></p>
<p>é€šè¿‡ä½¿ç”¨ <code>restrict</code>ï¼Œæˆ‘ä»¬å‘Šè¯‰ç¼–è¯‘å™¨ï¼Œæ¯ä¸€ä¸ªæŒ‡é’ˆéƒ½åˆ†åˆ«æŒ‡å‘ä¸åŒçš„å†…å­˜åŒºåŸŸã€‚è¿™å°†å…è®¸ç¼–è¯‘å™¨è¿›è¡Œæ›´ç§¯æçš„ä¼˜åŒ–ï¼Œä»è€Œæé«˜æ€§èƒ½ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">add_arrays</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>restrict a<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>restrict b<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>restrict c<span class="token punctuation">,</span> <span class="token class-name">size_t</span> n<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        c<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸Šè¿°ä»£ç è¡¨ç¤ºï¼š<code>a</code> æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜ã€ä¸è¢« <code>b</code> å’Œ <code>c</code> æŒ‡å‘ï¼Œ<code>b</code> æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜ã€ä¸è¢« <code>a</code> å’Œ <code>c</code> æŒ‡å‘ï¼Œ<code>c</code> æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜ä¹Ÿä¸è¢« <code>a</code> å’Œ <code>b</code> æŒ‡å‘ã€‚</p>
<p>ä½œç”¨</p>
<ol>
<li><strong>æ¶ˆé™¤æŒ‡é’ˆåˆ«åé—®é¢˜</strong>ï¼šé€šè¿‡ <code>restrict</code>ï¼Œç¼–è¯‘å™¨èƒ½å¤Ÿç¡®å®šè¿™äº›æŒ‡é’ˆä¸ä¼šæŒ‡å‘é‡å çš„å†…å­˜åŒºåŸŸã€‚è¿™å‡å°‘äº†å†…å­˜è®¿é—®çš„å¤æ‚æ€§ã€‚</li>
<li><strong>æå‡ä¼˜åŒ–æœºä¼š</strong>ï¼šåœ¨æ²¡æœ‰ <code>restrict</code> çš„æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨å¿…é¡»å‡è®¾è¿™äº›æŒ‡é’ˆå¯èƒ½æŒ‡å‘åŒä¸€ä¸ªå†…å­˜åŒºåŸŸï¼Œè¿™ä¼šé™ä½ä¼˜åŒ–çš„æœºä¼šã€‚è€Œä½¿ç”¨ <code>restrict</code> ä¹‹åï¼Œç¼–è¯‘å™¨å¯ä»¥æ›´å¥½åœ°è¿›è¡Œä¼˜åŒ–ï¼Œæ¯”å¦‚åœ¨å¯„å­˜å™¨ä¸­ç¼“å­˜å€¼ç­‰ã€‚</li>
</ol>
<p>éœ€è¦æ³¨æ„çš„åœ°æ–¹</p>
<ol>
<li><strong>åˆæ³•æ€§çº¦æŸ</strong>ï¼šä½œä¸ºç¨‹åºå‘˜ï¼Œåœ¨ä½¿ç”¨ <code>restrict</code> æ—¶ï¼Œå¿…é¡»ä¿è¯è¿™äº›æŒ‡é’ˆç¡®å®æŒ‡å‘ä¸åŒçš„å†…å­˜åŒºåŸŸï¼Œå¦åˆ™ä¼šå¯¼è‡´æœªå®šä¹‰è¡Œä¸ºã€‚</li>
<li><strong>åº”ç”¨åœºæ™¯</strong>ï¼šé€‚ç”¨äºé‚£äº›æ€§èƒ½æ•æ„Ÿä¸”ç¡®å®šæŒ‡é’ˆä¸ä¼šé‡å çš„åœºæ™¯ã€‚</li>
</ol>
<p>æ€»ç»“</p>
<p><code>restrict</code> å…³é”®å­—æä¾›äº†ä¸€ç§æ–¹æ³•ï¼Œè®©ç¨‹åºå‘˜èƒ½å¤Ÿæ˜ç¡®åœ°å‘Šè¯‰ç¼–è¯‘å™¨æŒ‡é’ˆçš„ä½¿ç”¨çº¦æŸï¼Œè¿™æ ·ç¼–è¯‘å™¨å¯ä»¥è¿›è¡Œæ›´æ¿€è¿›çš„ä¼˜åŒ–ï¼Œä»è€Œæé«˜ç¨‹åºçš„æ€§èƒ½ã€‚ä½†è¿™ä¹Ÿéœ€è¦ç¨‹åºå‘˜éµå¾ªå…¶çº¦å®šï¼Œå¦åˆ™å¯èƒ½å¸¦æ¥ä¸å¯é¢„è§çš„é—®é¢˜ã€‚</p>
</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">f1</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> y<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> sum<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> product<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> sum_product<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> update_me<span class="token punctuation">,</span> <span class="token class-name">size_t</span> s<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>s<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
          <span class="token punctuation">&#123;</span>
                   sum<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">+</span>y<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                   product<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">*</span>y<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                   update_me<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>i<span class="token operator">*</span><span class="token number">123</span><span class="token punctuation">;</span> <span class="token comment">// some dummy value</span>
                   sum_product<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>sum<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">+</span>product<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><em>è¿™ä¸ªç¨‹åºçš„åŠŸèƒ½ååˆ†ç®€å•ï¼Œä½†æ˜¯é‡Œé¢çš„æŒ‡é’ˆé—®é¢˜å´å‘äººæ·±æ€ï¼šåŒä¸€å—å†…å­˜å¯ä»¥ç”±å¤šä¸ªæŒ‡é’ˆæ¥è®¿é—®ï¼Œå› æ­¤åŒä¸€ä¸ªåœ°å€çš„æ•°æ®å¯èƒ½ä¼šè¢«å¤šä¸ªæŒ‡é’ˆè½®ç•ªå¤å†™ã€‚</em></p>
<p>Cè¯­è¨€ç¼–è¯‘å™¨å®Œå…¨å…è®¸ä¸Šè¿°æƒ…å†µã€‚å› æ­¤ï¼Œå®ƒåˆ†å››ä¸ªé˜¶æ®µå¤„ç†æ¯æ¬¡è¿­ä»£çš„å„ç±»æ•°ç»„ï¼š</p>
<ul>
<li>åˆ¶å¤‡sum[i];</li>
<li>åˆ¶å¤‡product[i];</li>
<li>åˆ¶å¤‡update_me[i];</li>
<li>åˆ¶å¤‡sum_product[i]ã€‚åœ¨è¿™ä¸ªé˜¶æ®µï¼Œè®¡ç®—æœºå°†ä»å†…å­˜é‡Œé‡æ–°åŠ è½½sum[i]å’Œproduct[i]ã€‚</li>
</ul>
<p><em>ç¬¬å››ä¸ªé˜¶æ®µæ˜¯å¦å­˜åœ¨è¿›ä¸€æ­¥ä¼˜åŒ–çš„ç©ºé—´å‘¢ï¼Ÿæ—¢ç„¶å‰é¢å·²ç»è®¡ç®—å¥½äº†sum[i]å’Œproduct[i]ï¼Œé‚£ä¹ˆåé¢æˆ‘ä»¬åº”è¯¥å°±ä¸å¿…å†ä»å†…å­˜ä¸­è¯»å–å®ƒä»¬çš„å€¼äº†ã€‚</em></p>
<p>åªæ˜¯ç¼–è¯‘å™¨æœ¬èº«å¹¶ä¸èƒ½åœ¨ç¬¬ä¸‰ä¸ªé˜¶æ®µç¡®å®šå‰ä¸¤ä¸ªé˜¶æ®µçš„èµ‹å€¼æ²¡æœ‰è¢«å…¶ä»–æŒ‡ä»¤è¦†ç›–ã€‚æ¢è€Œè¨€ä¹‹ï¼Œå› ä¸ºç¼–è¯‘å™¨ä¸èƒ½åˆ¤æ–­è¯¥ç¨‹åºé‡Œæ˜¯å¦å­˜åœ¨æŒ‡å‘ç›¸åŒå†…å­˜åŒºåŸŸçš„æŒ‡é’ˆâ€”â€”å³â€œæŒ‡é’ˆåˆ«åï¼ˆpointer aliasingï¼‰â€ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨ä¸èƒ½ç¡®ä¿è¯¥æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜æ²¡è¢«æ”¹å†™ã€‚</p>
<p>C99æ ‡å‡†ä¸­çš„å—é™æŒ‡é’ˆï¼»ISO07ï¼Œ6.7.3èŠ‚ï¼½ï¼ˆéƒ¨åˆ†æ–‡çŒ®åˆç§°â€œä¸¥æ ¼åˆ«åâ€ï¼‰çš„åº”è¿è€Œç”Ÿã€‚ç¼–ç¨‹äººå‘˜å¯é€šè¿‡å—é™æŒ‡é’ˆçš„strictä¿®é¥°ç¬¦å‘ç¼–è¯‘å™¨æ‰¿è¯ºï¼š<mark>è¢«è¯¥å…³é”®å­—æ ‡è®°çš„æŒ‡é’ˆæ˜¯æ“ä½œç›¸å…³å†…å­˜åŒºåŸŸçš„å”¯ä¸€æŒ‡é’ˆï¼Œæ²¡æœ‰å…¶ä»–æŒ‡é’ˆé‡å¤æŒ‡å‘è¿™ä¸ªæŒ‡é’ˆæ‰€æ“ä½œçš„å†…å­˜åŒºåŸŸã€‚</mark></p>
<p>ç”¨æ›´ä¸ºç¡®åˆ‡ã€æ›´ä¸ºæ­£å¼çš„è¯­è¨€æ¥è¯´ï¼Œå…³é”®å­—â€œrestrictâ€è¡¨ç¤ºè¯¥æŒ‡é’ˆæ˜¯è®¿é—®æ—¢å®šå¯¹è±¡çš„å”¯ä¸€æŒ‡é’ˆï¼Œå…¶ä»–æŒ‡é’ˆéƒ½ä¸ä¼šé‡å¤æ“ä½œæ—¢å®šå¯¹è±¡ã€‚ä»å¦ä¸€ä¸ªè§’åº¦æ¥çœ‹ï¼Œä¸€æ—¦æŸä¸ªæŒ‡é’ˆè¢«æ ‡è®°ä¸ºå—é™æŒ‡é’ˆï¼Œé‚£ä¹ˆç¼–è¯‘å™¨å°±è®¤å®šæ—¢å®šå¯¹è±¡åªä¼šè¢«æŒ‡å®šçš„å—é™æŒ‡é’ˆæ“ä½œã€‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">f2</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span> restrict x<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> restrict y<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> restrict sum<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> restrict product<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> â†™
    â†˜ restrict sum_product<span class="token punctuation">,</span>
          <span class="token keyword">int</span><span class="token operator">*</span> restrict update_me<span class="token punctuation">,</span> <span class="token class-name">size_t</span> s<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>s<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
          <span class="token punctuation">&#123;</span>
                   sum<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">+</span>y<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                   product<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">*</span>y<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                   update_me<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>i<span class="token operator">*</span><span class="token number">123</span><span class="token punctuation">;</span> <span class="token comment">// some dummy value</span>
                   sum_product<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>sum<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">+</span>product<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr />
<p><code>GCC X64 f1</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token label function">f1:</span>
         push   <span class="token register variable">r15</span> <span class="token register variable">r14</span> <span class="token register variable">r13</span> <span class="token register variable">r12</span> <span class="token register variable">rbp</span> <span class="token register variable">rdi</span> <span class="token register variable">rsi</span> <span class="token register variable">rbx</span>
         mov    <span class="token register variable">r13</span>, QWORD PTR <span class="token number">120</span><span class="token operator">[</span><span class="token register variable">rsp</span><span class="token operator">]</span>
         mov    <span class="token register variable">rbp</span>, QWORD PTR <span class="token number">104</span><span class="token operator">[</span><span class="token register variable">rsp</span><span class="token operator">]</span>
         mov    <span class="token register variable">r12</span>, QWORD PTR <span class="token number">112</span><span class="token operator">[</span><span class="token register variable">rsp</span><span class="token operator">]</span>
         test   <span class="token register variable">r13</span>, <span class="token register variable">r13</span>
         je     .L1
         add    <span class="token register variable">r13</span>, <span class="token number">1</span>
         xor    <span class="token register variable">ebx</span>, <span class="token register variable">ebx</span>
         mov    <span class="token register variable">edi</span>, <span class="token number">1</span>
         xor    <span class="token register variable">r11d</span>, <span class="token register variable">r11d</span>
         jmp    .L4
<span class="token label function">.L6:</span>
          mov   <span class="token register variable">r11</span>, <span class="token register variable">rdi</span>
          mov   <span class="token register variable">rdi</span>, <span class="token register variable">rax</span>
<span class="token label function">.L4:</span>
         lea    <span class="token register variable">rax</span>, <span class="token number">0</span><span class="token operator">[</span><span class="token number">0</span><span class="token operator">+</span><span class="token register variable">r11</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>
         lea    <span class="token register variable">r10</span>, <span class="token operator">[</span><span class="token register variable">rcx</span><span class="token operator">+</span><span class="token register variable">rax</span><span class="token operator">]</span>
         lea    <span class="token register variable">r14</span>, <span class="token operator">[</span><span class="token register variable">rdx</span><span class="token operator">+</span><span class="token register variable">rax</span><span class="token operator">]</span>
         lea    <span class="token register variable">rsi</span>, <span class="token operator">[</span><span class="token register variable">r8</span><span class="token operator">+</span><span class="token register variable">rax</span><span class="token operator">]</span>
         add    <span class="token register variable">rax</span>, <span class="token register variable">r9</span>
         mov    <span class="token register variable">r15d</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">r10</span><span class="token operator">]</span>
         add    <span class="token register variable">r15d</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">r14</span><span class="token operator">]</span>
         mov    DWORD PTR <span class="token operator">[</span><span class="token register variable">rsi</span><span class="token operator">]</span>, <span class="token register variable">r15d</span>         <span class="token comment">; store to sum[]</span>
         mov    <span class="token register variable">r10d</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">r10</span><span class="token operator">]</span>
         imul   <span class="token register variable">r10d</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">r14</span><span class="token operator">]</span>
         mov    DWORD PTR <span class="token operator">[</span><span class="token register variable">rax</span><span class="token operator">]</span>, <span class="token register variable">r10d</span>         <span class="token comment">; store to product[]</span>
         mov    DWORD PTR <span class="token operator">[</span><span class="token register variable">r12</span><span class="token operator">+</span><span class="token register variable">r11</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">ebx</span>    <span class="token comment">; store to update_me[]</span>
         add    <span class="token register variable">ebx</span>, <span class="token number">123</span>
         mov    <span class="token register variable">r10d</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">rsi</span><span class="token operator">]</span>         <span class="token comment">; reload sum[i]</span>
         add    <span class="token register variable">r10d</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">rax</span><span class="token operator">]</span>         <span class="token comment">; reload product[i]</span>
         lea    <span class="token register variable">rax</span>, <span class="token number">1</span><span class="token operator">[</span><span class="token register variable">rdi</span><span class="token operator">]</span>
         cmp    <span class="token register variable">rax</span>, <span class="token register variable">r13</span>
         mov    DWORD PTR <span class="token number">0</span><span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">+</span><span class="token register variable">r11</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">r10d</span>  <span class="token comment">; store to sum_product[]</span>
         jne    .L6
<span class="token label function">.L1:</span>
         pop    <span class="token register variable">rbx</span> <span class="token register variable">rsi</span> <span class="token register variable">rdi</span> <span class="token register variable">rbp</span> <span class="token register variable">r12</span> <span class="token register variable">r13</span> <span class="token register variable">r14</span> <span class="token register variable">r15</span>
         ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>GCC X64 f2</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token label function">f2:</span>
         push   <span class="token register variable">r13</span> <span class="token register variable">r12</span> <span class="token register variable">rbp</span> <span class="token register variable">rdi</span> <span class="token register variable">rsi</span> <span class="token register variable">rbx</span>
         mov    <span class="token register variable">r13</span>, QWORD PTR <span class="token number">104</span><span class="token operator">[</span><span class="token register variable">rsp</span><span class="token operator">]</span>
         mov    <span class="token register variable">rbp</span>, QWORD PTR <span class="token number">88</span><span class="token operator">[</span><span class="token register variable">rsp</span><span class="token operator">]</span>
         mov    <span class="token register variable">r12</span>, QWORD PTR <span class="token number">96</span><span class="token operator">[</span><span class="token register variable">rsp</span><span class="token operator">]</span>
         test   <span class="token register variable">r13</span>, <span class="token register variable">r13</span>
         je     .L7
         add    <span class="token register variable">r13</span>, <span class="token number">1</span>
         xor    <span class="token register variable">r10d</span>, <span class="token register variable">r10d</span>
         mov    <span class="token register variable">edi</span>, <span class="token number">1</span>
         xor    <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
         jmp    .L10
<span class="token label function">.L11:</span>
         mov    <span class="token register variable">rax</span>, <span class="token register variable">rdi</span>
         mov    <span class="token register variable">rdi</span>, <span class="token register variable">r11</span>
<span class="token label function">.L10:</span>
         mov    <span class="token register variable">esi</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">rcx</span><span class="token operator">+</span><span class="token register variable">rax</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>
         mov    <span class="token register variable">r11d</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">rdx</span><span class="token operator">+</span><span class="token register variable">rax</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>
         mov    DWORD PTR <span class="token operator">[</span><span class="token register variable">r12</span><span class="token operator">+</span><span class="token register variable">rax</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">r10d</span> <span class="token comment">; store to update_me[]</span>
         add    <span class="token register variable">r10d</span>, <span class="token number">123</span>
         lea    <span class="token register variable">ebx</span>, <span class="token operator">[</span><span class="token register variable">rsi</span><span class="token operator">+</span><span class="token register variable">r11</span><span class="token operator">]</span>
         imul   <span class="token register variable">r11d</span>, <span class="token register variable">esi</span>
         mov    DWORD PTR <span class="token operator">[</span><span class="token register variable">r8</span><span class="token operator">+</span><span class="token register variable">rax</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">ebx</span> <span class="token comment">; store to sum[]</span>
         mov    DWORD PTR <span class="token operator">[</span><span class="token register variable">r9</span><span class="token operator">+</span><span class="token register variable">rax</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">r11d</span> <span class="token comment">; store to product[]</span>
         add    <span class="token register variable">r11d</span>, <span class="token register variable">ebx</span>
         mov    DWORD PTR <span class="token number">0</span><span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">+</span><span class="token register variable">rax</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">r11d</span> <span class="token comment">; store to sum_product[]</span>
         lea    <span class="token register variable">r11</span>, <span class="token number">1</span><span class="token operator">[</span><span class="token register variable">rdi</span><span class="token operator">]</span>
         cmp    <span class="token register variable">r11</span>, <span class="token register variable">r13</span>
         jne    .L11
<span class="token label function">.L7:</span>
         pop    <span class="token register variable">rbx</span> <span class="token register variable">rsi</span> <span class="token register variable">rdi</span> <span class="token register variable">rbp</span> <span class="token register variable">r12</span> <span class="token register variable">r13</span>
         ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><mark>f1()å‡½æ•°å’Œf2()å‡½æ•°çš„ä¸åŒä¹‹å¤„åœ¨äºï¼šåœ¨f1()å‡½æ•°ä¸­ï¼Œsum[i]å’Œproduct[i]æ•°ç»„åœ¨å¾ªç¯ä¸­ä¼šå†æ¬¡åŠ è½½ï¼›è€Œå‡½æ•°f2()åˆ™æ²¡æœ‰è¿™ç§é‡æ–°åŠ è½½å†…å­˜æ•°å€¼çš„æ“ä½œã€‚åœ¨æ”¹åŠ¨åçš„ç¨‹åºé‡Œï¼Œå› ä¸ºæˆ‘ä»¬å‘ç¼–è¯‘å™¨â€œæ‰¿è¯ºâ€sum[i]å’Œproduct[i]çš„å€¼ä¸ä¼šè¢«å…¶ä»–æŒ‡é’ˆå¤å†™ï¼Œæ‰€ä»¥è®¡ç®—æœºä¼šé‡å¤åˆ©ç”¨å‰å‡ ä¸ªé˜¶æ®µåˆ¶å¤‡å¥½çš„å„é¡¹æ•°æ®ï¼Œä¸å†ä»å†…å­˜åŠ è½½å®ƒä»¬çš„å€¼äº†ã€‚å¾ˆæ˜æ˜¾ï¼Œæ”¹è¿›åçš„ç¨‹åºè¿è¡Œé€Ÿåº¦æ›´å¿«ä¸€äº›ã€‚</mark></p>
<p>å¦‚æœæˆ‘ä»¬å£°æ˜äº†æŸä¸ªæŒ‡é’ˆæ˜¯å—é™æŒ‡é’ˆï¼Œè€Œå®é™…çš„ç¨‹åºåˆæœ‰å…¶ä»–æŒ‡é’ˆæ“ä½œè¿™ä¸ªå—é™æŒ‡é’ˆæ“ä½œçš„å†…å­˜åŒºåŸŸï¼Œå°†ä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µï¼Ÿè¿™çœŸçš„å°±æ˜¯ç¨‹åºå‘˜çš„äº‹äº†ï¼Œä¸è¿‡ç¨‹åºè¿è¡Œçš„ç»“æœè‚¯å®šæ˜¯é”™è¯¯çš„ã€‚</p>
<p>FORTRANè¯­è¨€çš„ç¼–è¯‘å™¨æŠŠæ‰€æœ‰æŒ‡é’ˆéƒ½è§†ä¸ºå—é™æŒ‡é’ˆã€‚å› æ­¤ï¼Œåœ¨Cè¯­è¨€ä¸æ”¯æŒC99æ ‡å‡†çš„restrictä¿®é¥°ç¬¦è€Œå®é™…æŒ‡é’ˆå±äºå—é™æŒ‡é’ˆçš„æ—¶å€™ï¼Œç”¨FORTRANè¯­è¨€ç¼–è¯‘å‡ºæ¥çš„åº”ç”¨ç¨‹åºä¼šæ¯”ç”¨Cè¯­è¨€ç¼–è¯‘å‡ºæ¥çš„ç¨‹åºè¿è¡Œå¾—æ›´å¿«ã€‚</p>
<p>å—é™æŒ‡é’ˆä¸»è¦ç”¨äºå“ªäº›é¢†åŸŸï¼Ÿå®ƒä¸»è¦ç”¨äºæ“ä½œå¤šä¸ªå¤§å°ºå¯¸å†…å­˜å—çš„åº”ç”¨æ–¹é¢ã€‚ä¾‹å¦‚ï¼Œåœ¨è¶…çº§è®¡ç®—æœº/HPCå¹³å°ä¸Šç»å¸¸è¿›è¡Œçš„çº¿æ€§æ–¹ç¨‹ç»„æ±‚è§£å°±å±äºè¿™ç§ç±»å‹çš„åº”ç”¨ã€‚æˆ–è®¸ï¼Œè¿™æ­£æ˜¯è¿™ç§å¹³å°æ™®éé‡‡ç”¨FORTRANè¯­è¨€çš„åŸå› ä¹‹ä¸€å§ã€‚</p>
<p>å¦ä¸€æ–¹é¢ï¼Œåœ¨å¾ªç¯è¯­å¥çš„è¿­ä»£æ¬¡æ•°ä¸æ˜¯éå¸¸é«˜çš„æƒ…å†µä¸‹ï¼Œå—é™æŒ‡é’ˆå¸¦æ¥çš„æ€§èƒ½æå‡å°±ä¸ä¼šååˆ†æ˜æ˜¾ã€‚</p>
<h3 id="chap45-æ‰“é€ æ— åˆ†æ”¯çš„abså‡½æ•°"><a class="markdownIt-Anchor" href="#chap45-æ‰“é€ æ— åˆ†æ”¯çš„abså‡½æ•°"></a> Chap45 æ‰“é€ æ— åˆ†æ”¯çš„abs()å‡½æ•°</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">my_abs</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
                   <span class="token keyword">return</span> <span class="token operator">-</span>i<span class="token punctuation">;</span>
          <span class="token keyword">else</span>
                   <span class="token keyword">return</span> i<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å›é¡¾ç¬¬12ç« ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨x86æ±‡ç¼–æŒ‡ä»¤æ‰“é€ ä¸€ä¸ªæ— åˆ†æ”¯çš„ç‰ˆæœ¬</p>
<hr />
<p><code>x64 gcc optimizing</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token label function">my_abs:</span>
         mov    <span class="token register variable">edx</span>, <span class="token register variable">edi</span><span class="token comment">;edx=edi:i</span>
         mov    <span class="token register variable">eax</span>, <span class="token register variable">edi</span><span class="token comment">;eax=edi:i</span>
         sar    <span class="token register variable">edx</span>, <span class="token number">31</span>
<span class="token comment">; EDX is 0xFFFFFFFF here if sign of input value is minus</span>
<span class="token comment">; EDX is 0 if sign of input value is plus (including 0)</span>
<span class="token comment">; the following two instructions have effect only if EDX is 0xFFFFFFFF</span>
<span class="token comment">; or idle if EDX is 0</span>
         xor    <span class="token register variable">eax</span>, <span class="token register variable">edx</span>
         sub    <span class="token register variable">eax</span>, <span class="token register variable">edx</span>
         ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><code>sar</code>ç®—æœ¯å³ç§»:ç®—æœ¯å³ç§»31ä½ï¼Œç®—æœ¯å³ç§»æ˜¯å¸¦ç¬¦å·çš„æ“ä½œï¼Œæœ‰ç¬¦å·æ•°çš„æœ€é«˜æœ‰æ•ˆä½<code>MSB</code>å°±æ˜¯å…¶ç¬¦å·ä½ã€‚ä¹Ÿå°±æ˜¯è¯´å¦‚æœæºæ“ä½œæ•°æ˜¯è´Ÿæ•°ï¼Œé‚£ä¹ˆå³ç§»31ä½åå¾—åˆ°çš„ç»“æœéƒ½ä¼šæ˜¯<code>0xffffffff</code></li>
<li>å½“è¾“å…¥å€¼æ˜¯è´Ÿæ•°çš„æ—¶å€™,ç›¸å½“äº<code>xorï¼Œ0xffffffff</code>ï¼Œç›¸å½“äºé€ä½æ±‚éçš„éè¿ç®—ï¼Œè€Œåé¢çš„<code>sub</code>æŒ‡ä»¤å®Œæˆäº†è¡¥ç è¿ç®—(å› ä¸ºæ­¤æ—¶edxçš„å€¼æ˜¯-1)</li>
</ul>
<h3 id="chap46-å˜é•¿å‚æ•°å‡½æ•°"><a class="markdownIt-Anchor" href="#chap46-å˜é•¿å‚æ•°å‡½æ•°"></a> Chap46 å˜é•¿å‚æ•°å‡½æ•°</h3>
<p>æœ¬ç« æ¢ç©¶åƒ<code>printf</code>å’Œ<code>scanf</code>ä¸€ç±»çš„å‡½æ•°å¯ä»¥å¤„ç†å¤šä¸ªå‚æ•°ï¼Œè¿™ç±»å‡½æ•°æ˜¯å¦‚ä½•è®¿é—®å‚æ•°çš„</p>
<h4 id="è®¡ç®—ç®—æœ¯å¹³å‡å€¼"><a class="markdownIt-Anchor" href="#è®¡ç®—ç®—æœ¯å¹³å‡å€¼"></a> è®¡ç®—ç®—æœ¯å¹³å‡å€¼</h4>
<p>å¦‚æœè¦ç¼–å†™ä¸€ä¸ªè®¡ç®—ç®—æœ¯å¹³å‡å€¼çš„å‡½æ•°ï¼Œé‚£ä¹ˆå°±éœ€è¦åœ¨å‡½æ•°çš„å‚æ•°å£°æ˜éƒ¨åˆ†æŒ‡å®šæ‰€æœ‰çš„å¤–æ¥å‚æ•°ã€‚ä½†æ˜¯C/C++çš„å˜é•¿å‚æ•°å‡½æ•°å´æ— æ³•äº‹å…ˆçŸ¥é“å¤–æ¥å‚æ•°çš„æ•°é‡ã€‚ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œæˆ‘ä»¬ç”¨â€œ-1â€ä½œä¸ºæœ€åä¸€ä¸ªå‚æ•°å…¼å…¶ä»–å‚æ•°çš„ç»ˆæ­¢ç¬¦ã€‚</p>
<p>Cè¯­è¨€æ ‡å‡†å‡½æ•°åº“çš„å¤´æ–‡ä»¶<code>stdarg.h</code>å®šä¹‰äº†å˜é•¿å‚æ•°çš„å¤„ç†æ–¹æ³•ï¼ˆå®ï¼‰ã€‚åˆšæ‰æåˆ°çš„<code>printf()</code>å‡½æ•°å’Œ<code>scanf()</code>å‡½æ•°éƒ½ä½¿ç”¨äº†è¿™ä¸ªæ–‡ä»¶æä¾›çš„å®ã€‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdarg.h></span></span>

<span class="token keyword">int</span> <span class="token function">arith_mean</span><span class="token punctuation">(</span><span class="token keyword">int</span> v<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
         va_list args<span class="token punctuation">;</span>
         <span class="token keyword">int</span> sum<span class="token operator">=</span>v<span class="token punctuation">,</span> count<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> i<span class="token punctuation">;</span>
         <span class="token function">va_start</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
         <span class="token punctuation">&#123;</span>
                  i<span class="token operator">=</span><span class="token function">va_arg</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// terminator</span>
                           <span class="token keyword">break</span><span class="token punctuation">;</span>
                  sum<span class="token operator">=</span>sum<span class="token operator">+</span>i<span class="token punctuation">;</span>
                  count<span class="token operator">++</span><span class="token punctuation">;</span>
         <span class="token punctuation">&#125;</span>

         <span class="token function">va_end</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span> sum<span class="token operator">/</span>count<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
         <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> <span class="token function">arith_mean</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token comment">/* terminator */</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_v<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>
_arith_mean PROC NEAR
        mov     <span class="token register variable">eax</span>, DWORD PTR _v<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span> <span class="token comment">; load 1st argument into sum</span>
        push    <span class="token register variable">esi</span>
        mov     <span class="token register variable">esi</span>, <span class="token number">1</span>                    <span class="token comment">; count=1</span>
        lea     <span class="token register variable">edx</span>, DWORD PTR _v<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">]</span>   <span class="token comment">; address of the 1st argument</span>
<span class="token label function">$L838:</span>
        mov     <span class="token register variable">ecx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">edx</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>    <span class="token comment">; load next argument</span>
        add     <span class="token register variable">edx</span>, <span class="token number">4</span>                    <span class="token comment">; shift pointer to the next argument</span>
        cmp     <span class="token register variable">ecx</span>, <span class="token operator">-</span><span class="token number">1</span>                   <span class="token comment">; is it -1?</span>
        je      SHORT <span class="token operator">$</span>L856               <span class="token comment">; exit if so</span>
        add     <span class="token register variable">eax</span>, <span class="token register variable">ecx</span>                  <span class="token comment">; sum = sum + loaded argument</span>
        inc     <span class="token register variable">esi</span>                       <span class="token comment">; count++</span>
        jmp     SHORT <span class="token operator">$</span>L838
<span class="token label function">$L856:</span>
<span class="token comment">; calculate quotient</span>

        cdq
        idiv    <span class="token register variable">esi</span><span class="token comment">;count</span>
        pop     <span class="token register variable">esi</span>
        ret     <span class="token number">0</span>
_arith_mean ENDP

<span class="token operator">$</span>SG851  DB      <span class="token string">'%d'</span>, <span class="token number">0aH</span>, <span class="token number">00H</span>

_main   PROC NEAR
        push    <span class="token operator">-</span><span class="token number">1</span>
        push    <span class="token number">15</span>
        push    <span class="token number">10</span>
        push    <span class="token number">7</span>
        push    <span class="token number">2</span>
        push    <span class="token number">1</span>
        call    _arith_mean
        push    <span class="token register variable">eax</span>
        push    OFFSET FLAT:<span class="token operator">$</span>SG851 <span class="token comment">; '%d'</span>
        call    _printf
        add     <span class="token register variable">esp</span>, <span class="token number">32</span>
        ret     <span class="token number">0</span>
_main   ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p><code>CDQ</code>ï¼ˆConvert Doubleword to Quadwordï¼‰æŒ‡ä»¤,å°†32ä½çš„<code>EAX</code>å¯„å­˜å™¨ä¸­çš„æœ‰ç¬¦å·æ•´æ•°çš„ç¬¦å·ä½æ‰©å±•åˆ°64ä½çš„<code>EDX:EAX</code>å¯„å­˜å™¨å¯¹ä¸­ã€‚</p>
</li>
<li>
<p><code>main()</code>å‡½æ•°é‡Œï¼Œå„é¡¹å‚æ•°ä»å³åˆ°å·¦ä¾æ¬¡é€†åºä¼ é€’å…¥æ ˆã€‚ç¬¬ä¸€ä¸ªå…¥æ ˆçš„æ˜¯æœ€åä¸€é¡¹å‚æ•°â€œ-1â€ï¼Œè€Œæœ€åå…¥æ ˆçš„æ˜¯ç¬¬ä¸€é¡¹å‚æ•°â€”â€”æ ¼å¼åŒ–å­—ç¬¦ä¸²ã€‚</p>
</li>
<li>
<p>å‡½æ•°<code>arith_mean()</code>å–å‡ºç¬¬ä¸€ä¸ªå‚æ•°çš„å€¼ï¼Œå¹¶å°†å…¶ä¿å­˜åœ¨å˜é‡sumä¸­ã€‚æ¥ç€ï¼Œå°†ç¬¬äºŒä¸ªå‚æ•°çš„åœ°å€ä¿å­˜åœ¨å¯„å­˜å™¨EDXä¸­ï¼Œå¹¶å–å‡ºå…¶å€¼ï¼Œä¸å‰é¢çš„sumç›¸åŠ ã€‚å¦‚æ­¤å¾ªç¯å¾€å¤ï¼Œç›´åˆ°å‚æ•°çš„ç»ˆæ­¢ç¬¦<code>âˆ’1ã€‚</code></p>
</li>
<li>
<p>å½“æ‰¾åˆ°äº†å‚æ•°ä¸²çš„ç»“å°¾åï¼Œç¨‹åºå†å°†æ‰€æœ‰æ•°çš„ç®—æœ¯å’Œsumé™¤ä»¥å‚æ•°çš„ä¸ªæ•°ï¼ˆå½“ç„¶ä¸åŒ…æ‹¬ç»ˆæ­¢ç¬¦âˆ’1ï¼‰ã€‚æŒ‰ç…§è¿™ç§ç®—æ³•è®¡ç®—å‡ºæ¥çš„å•†å°±æ˜¯å„å‚æ•°çš„ç®—æœ¯å¹³å‡å€¼ã€‚</p>
</li>
<li>
<p>==æ¢å¥è¯è¯´ï¼Œåœ¨è°ƒç”¨å˜é•¿å‚æ•°å‡½æ•°æ—¶ï¼Œè°ƒç”¨æ–¹å‡½æ•°å…ˆæŠŠä¸ç¡®å®šé•¿åº¦çš„å‚æ•°å †ç§¯ä¸ºæ•°ç»„ï¼Œå†é€šè¿‡æ ˆæŠŠè¿™ä¸ªæ•°ç»„ä¼ é€’ç»™å˜é•¿å‡½æ•°å‚æ•°ã€‚è¿™å°±è§£é‡Šäº†ä¸ºä»€ä¹ˆcdeclè°ƒç”¨è§„èŒƒä¼šè¦æ±‚å°†ç¬¬ä¸€ä¸ªå‚æ•°æœ€åä¸€ä¸ªæ¨é€å…¥æ ˆäº†ã€‚==å› ä¸ºå¦‚æœä¸è¿™æ ·çš„è¯ï¼Œè¢«è°ƒç”¨æ–¹å‡½æ•°ä¼šæ‰¾ä¸åˆ°ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œè¿™ä¼šå¯¼è‡´printf()è¿™æ ·çš„å‡½æ•°å› ä¸ºæ‰¾ä¸åˆ°æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„åœ°å€è€Œæ— æ³•è¿è¡Œã€‚</p>
</li>
</ul>
<hr />
<p><code>åŸºäºå¯„å­˜å™¨çš„è°ƒç”¨è§„èŒƒ</code></p>
<p><code>msvs x64</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token operator">$</span>SG3013 DB      <span class="token string">'%d'</span>, <span class="token number">0aH</span>, <span class="token number">00H</span>

v<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>
arith_mean PROC
         mov    DWORD PTR <span class="token operator">[</span><span class="token register variable">rsp</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span>, <span class="token register variable">ecx</span>     <span class="token comment">; 1st argument</span>
         mov    QWORD PTR <span class="token operator">[</span><span class="token register variable">rsp</span><span class="token operator">+</span><span class="token number">16</span><span class="token operator">]</span>, <span class="token register variable">rdx</span>    <span class="token comment">; 2nd argument</span>
         mov    QWORD PTR <span class="token operator">[</span><span class="token register variable">rsp</span><span class="token operator">+</span><span class="token number">24</span><span class="token operator">]</span>, <span class="token register variable">r8</span>     <span class="token comment">; 3rd argument</span>
         mov    <span class="token register variable">eax</span>, <span class="token register variable">ecx</span>                   <span class="token comment">; sum = 1st argument</span>
         lea    <span class="token register variable">rcx</span>, QWORD PTR v<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">rsp</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span>   <span class="token comment">; pointer to the 2nd argument</span>
         mov    QWORD PTR <span class="token operator">[</span><span class="token register variable">rsp</span><span class="token operator">+</span><span class="token number">32</span><span class="token operator">]</span>, <span class="token register variable">r9</span>     <span class="token comment">; 4th argument</span>
         mov    <span class="token register variable">edx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">rcx</span><span class="token operator">]</span>       <span class="token comment">; load 2nd argument</span>
         mov    <span class="token register variable">r8d</span>, <span class="token number">1</span>                     <span class="token comment">; count=1</span>
         cmp    <span class="token register variable">edx</span>, <span class="token operator">-</span><span class="token number">1</span>                    <span class="token comment">; 2nd argument is -1?</span>
         je     SHORT <span class="token operator">$</span>LN8@arith_mean      <span class="token comment">; exit if so</span>
<span class="token label function">$LL3@arith_mean:</span>
         add    <span class="token register variable">eax</span>, <span class="token register variable">edx</span>                   <span class="token comment">; sum = sum + loaded argument</span>
         mov    <span class="token register variable">edx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">rcx</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span>     <span class="token comment">; load next argument</span>
         lea    <span class="token register variable">rcx</span>, QWORD PTR <span class="token operator">[</span><span class="token register variable">rcx</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span>     <span class="token comment">; shift pointer to point to the argument after next</span>
         inc    <span class="token register variable">r8d</span>                        <span class="token comment">; count++</span>
         cmp    <span class="token register variable">edx</span>, <span class="token operator">-</span><span class="token number">1</span>                    <span class="token comment">; is loaded argument -1?</span>
         jne    SHORT <span class="token operator">$</span>LL3@arith_mean      <span class="token comment">; go to loop begin if its not'</span>
<span class="token label function">$LN8@arith_mean:</span>
<span class="token comment">; calculate quotient</span>
         cdq
         idiv   <span class="token register variable">r8d</span>
         ret    <span class="token number">0</span>
arith_mean ENDP

main     PROC
         sub    <span class="token register variable">rsp</span>, <span class="token number">56</span>
         mov    <span class="token register variable">edx</span>, <span class="token number">2</span>
         mov    DWORD PTR <span class="token operator">[</span><span class="token register variable">rsp</span><span class="token operator">+</span><span class="token number">40</span><span class="token operator">]</span>, <span class="token operator">-</span><span class="token number">1</span>
         mov    DWORD PTR <span class="token operator">[</span><span class="token register variable">rsp</span><span class="token operator">+</span><span class="token number">32</span><span class="token operator">]</span>, <span class="token number">15</span>
         lea    <span class="token register variable">r9d</span>, QWORD PTR <span class="token operator">[</span><span class="token register variable">rdx</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span>
         lea    <span class="token register variable">r8d</span>, QWORD PTR <span class="token operator">[</span><span class="token register variable">rdx</span><span class="token operator">+</span><span class="token number">5</span><span class="token operator">]</span>
         lea    <span class="token register variable">ecx</span>, QWORD PTR <span class="token operator">[</span><span class="token register variable">rdx</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">]</span>
         call   arith_mean
         lea    <span class="token register variable">rcx</span>, OFFSET FLAT:<span class="token operator">$</span>SG3013
         mov    <span class="token register variable">edx</span>, <span class="token register variable">eax</span>
         call   printf
         xor    <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
         add    <span class="token register variable">rsp</span>, <span class="token number">56</span>
         ret    <span class="token number">0</span>
main     ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>åœ¨è¿™ä¸ªç¨‹åºä¸­ï¼Œå¯„å­˜å™¨è´Ÿè´£ä¼ é€’å‡½æ•°çš„å‰4ä¸ªå‚æ•°ï¼Œæ ˆç”¨æ¥ä¼ é€’å…¶ä½™çš„2ä¸ªå‚æ•°ã€‚å‡½æ•°<code>arith_mean()</code>é¦–å…ˆå°†å¯„å­˜å™¨ä¼ é€’çš„4ä¸ªå‚æ•°å­˜æ”¾åœ¨é˜´å½±ç©ºé—´é‡Œï¼ŒæŠŠé˜´å½±ç©ºé—´å’Œä¼ é€’å‚æ•°çš„æ ˆ<code>åˆå¹¶æˆäº†ç»Ÿä¸€è€Œè¿ç»­çš„å‚æ•°æ•°ç»„</code></li>
</ul>
<h4 id="vprintf"><a class="markdownIt-Anchor" href="#vprintf"></a> vprintf()</h4>
<p>åœ¨ç¼–å†™æ—¥å¿—(logging)å‡½æ•°çš„æ—¶å€™ï¼Œå¤šæ•°äººéƒ½ä¼šè‡ªå·±æ„é€ ä¸€ç§<code>ä¸printfç±»ä¼¼çš„ã€å¤„ç†â€œæ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼‹ä¸€ç³»åˆ—ï¼ˆä½†æ˜¯æ•°é‡å¯å˜ï¼‰çš„å†…å®¹å‚æ•°â€çš„å˜é•¿å‚æ•°å‡½æ•°ã€‚</code></p>
<p>å¦å¤–ä¸€ç§å¸¸è§çš„å˜é•¿å‚æ•°å‡½æ•°å°±æ˜¯ä¸‹æ–‡çš„è¿™ç§die()å‡½æ•°ã€‚è¿™æ˜¯ä¸€ç§åœ¨æ˜¾ç¤ºæç¤ºä¿¡æ¯ä¹‹åéšå³é€€å‡ºæ•´ä¸ªç¨‹åºçš„å¼‚å¸¸å¤„ç†å‡½æ•°ã€‚å®ƒéœ€è¦æŠŠä¸ç¡®å®šæ•°é‡çš„è¾“å…¥å‚æ•°æ‰“åŒ…ã€å°è£…å¹¶ä¼ é€’ç»™printf()å‡½æ•°ã€‚å¦‚ä½•å®ç°å‘¢ï¼Ÿ<code>è¿™äº›å‡½æ•°åç§°å‰é¢æœ‰ä¸€ä¸ªå­—æ¯vçš„ï¼Œè¿™æ˜¯å› ä¸ºå®ƒåº”å½“èƒ½å¤Ÿå¤„ç†ä¸ç¡®å®šæ•°é‡ï¼ˆvariable.å¯å˜çš„ï¼‰çš„å‚æ•°ã€‚</code>ä»¥die()å‡½æ•°è°ƒç”¨çš„vprintf()å‡½æ•°ä¸ºä¾‹ï¼Œå®ƒçš„è¾“å…¥å˜é‡å°±å¯åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šä¸€éƒ¨åˆ†æ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œå¦ä¸€éƒ¨åˆ†æ˜¯å¸¦æœ‰å¤šç§ç±»å‹æ•°æ®å˜é‡åˆ—è¡¨<code>va_list</code>çš„æŒ‡é’ˆã€‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdarg.h></span></span>

<span class="token keyword">void</span> <span class="token function">die</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
         va_list va<span class="token punctuation">;</span>
         <span class="token function">va_start</span> <span class="token punctuation">(</span>va<span class="token punctuation">,</span> fmt<span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token function">vprintf</span> <span class="token punctuation">(</span>fmt<span class="token punctuation">,</span> va<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>va_list</code>æ˜¯ä¸€ä¸ªæŒ‡å‘æ•°ç»„çš„æŒ‡é’ˆã€‚</p>
<p><code>x64 msvs</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_fmt<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>
_die     PROC
         <span class="token comment">; load 1st argument (format-string)</span>
         mov    <span class="token register variable">ecx</span>, DWORD PTR _fmt<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
         <span class="token comment">; get pointer to the 2nd argument</span>
         lea    <span class="token register variable">eax</span>, DWORD PTR _fmt<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">]</span>
         push   <span class="token register variable">eax</span>          <span class="token comment">; pass pointer</span>
         push   <span class="token register variable">ecx</span>
         call   _vprintf
         add    <span class="token register variable">esp</span>, <span class="token number">8</span>
         push   <span class="token number">0</span>
         call   _exit
<span class="token label function">$LN3@die:</span>
         int    <span class="token number">3</span>
_die     ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>die()</code>å‡½æ•°å®ç°çš„åŠŸèƒ½å°±æ˜¯ï¼š<mark>å–ä¸€ä¸ªæŒ‡å‘å‚æ•°çš„æŒ‡é’ˆï¼Œå†å°†å…¶ä¼ é€ç»™vprintf()å‡½æ•°ã€‚å˜é•¿å‚æ•°ï¼ˆåºåˆ—ï¼‰åƒæ•°ç»„é‚£æ ·è¢«æ¥å›ä¼ é€’ã€‚</mark></p>
<hr />
<p><code>x64 gcc</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">fmt<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">48</span>
die      PROC
         <span class="token comment">; save first 4 arguments in Shadow Space</span>
         mov    QWORD PTR <span class="token operator">[</span><span class="token register variable">rsp</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span>, <span class="token register variable">rcx</span>
         mov    QWORD PTR <span class="token operator">[</span><span class="token register variable">rsp</span><span class="token operator">+</span><span class="token number">16</span><span class="token operator">]</span>, <span class="token register variable">rdx</span>
         mov    QWORD PTR <span class="token operator">[</span><span class="token register variable">rsp</span><span class="token operator">+</span><span class="token number">24</span><span class="token operator">]</span>, <span class="token register variable">r8</span>
         mov    QWORD PTR <span class="token operator">[</span><span class="token register variable">rsp</span><span class="token operator">+</span><span class="token number">32</span><span class="token operator">]</span>, <span class="token register variable">r9</span>
         sub    <span class="token register variable">rsp</span>, <span class="token number">40</span>
         lea    <span class="token register variable">rdx</span>, QWORD PTR fmt<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">rsp</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span> <span class="token comment">; pass pointer to the 1st argument</span>
         <span class="token comment">; RCX here is still points to the 1st argument (format-string) of die()</span>
         <span class="token comment">; so vprintf() will take it right from RCX</span>
         call   vprintf
         xor    <span class="token register variable">ecx</span>, <span class="token register variable">ecx</span>
         call   exit
         int    <span class="token number">3</span>
die      ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸å‰ä¾‹ç±»ä¼¼ï¼Œ<code>rcx</code>æŒ‡å‘é˜´å½±ç©ºé—´ï¼Œåˆšå¥½æ˜¯<code>va_list</code>çš„æŒ‡é’ˆ</p>
<h3 id="chap47-å­—ç¬¦ä¸²å‰ªåˆ‡"><a class="markdownIt-Anchor" href="#chap47-å­—ç¬¦ä¸²å‰ªåˆ‡"></a> Chap47 å­—ç¬¦ä¸²å‰ªåˆ‡</h3>
<p><em>å½“æˆ‘ä»¬éœ€è¦å»é™¤å­—ç¬¦ä¸²çš„å¼€å§‹ç¬¦å·æˆ–è€…ç»“æŸç¬¦å·</em></p>
<p>æœ¬ç« ä»‹ç»çš„ç¨‹åºï¼Œä¸“é—¨ç”¨äºå»é™¤å­—ç¬¦ä¸²çš„ç»“å°¾éƒ¨åˆ†çš„å›è½¦å’Œæ¢è¡Œå­—ç¬¦<code>CR/LF</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>

<span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">str_trim</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>s<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
         <span class="token keyword">char</span> c<span class="token punctuation">;</span>
         <span class="token class-name">size_t</span> str_len<span class="token punctuation">;</span>

         <span class="token comment">// work as long as \r or \n is at the end of string</span>
         <span class="token comment">// stop if some other character there or its an empty string'</span>
         <span class="token comment">// (at start or due to our operation)</span>
         <span class="token keyword">for</span> <span class="token punctuation">(</span>str_len<span class="token operator">=</span><span class="token function">strlen</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> str_len<span class="token operator">></span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>c<span class="token operator">=</span>s<span class="token punctuation">[</span>str_len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> str_len<span class="token operator">--</span><span class="token punctuation">)</span>
         <span class="token punctuation">&#123;</span>
                   <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token operator">==</span><span class="token char">'\r'</span> <span class="token operator">||</span> c<span class="token operator">==</span><span class="token char">'\n'</span><span class="token punctuation">)</span>
                             s<span class="token punctuation">[</span>str_len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
                   <span class="token keyword">else</span>
                             <span class="token keyword">break</span><span class="token punctuation">;</span>
         <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
         <span class="token comment">// test</span>

         <span class="token comment">// strdup() is used to copy text string into data segment,</span>
         <span class="token comment">// because it will crash on Linux otherwise,</span>
         <span class="token comment">// where text strings are allocated in constant data segment,</span>
         <span class="token comment">// and not modifiable.</span>

         <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"[%s]\n"</span><span class="token punctuation">,</span> <span class="token function">str_trim</span> <span class="token punctuation">(</span><span class="token function">strdup</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"[%s]\n"</span><span class="token punctuation">,</span> <span class="token function">str_trim</span> <span class="token punctuation">(</span><span class="token function">strdup</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"[%s]\n"</span><span class="token punctuation">,</span> <span class="token function">str_trim</span> <span class="token punctuation">(</span><span class="token function">strdup</span><span class="token punctuation">(</span><span class="token string">"\r"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"[%s]\n"</span><span class="token punctuation">,</span> <span class="token function">str_trim</span> <span class="token punctuation">(</span><span class="token function">strdup</span><span class="token punctuation">(</span><span class="token string">"\n\r"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"[%s]\n"</span><span class="token punctuation">,</span> <span class="token function">str_trim</span> <span class="token punctuation">(</span><span class="token function">strdup</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"[%s]\n"</span><span class="token punctuation">,</span> <span class="token function">str_trim</span> <span class="token punctuation">(</span><span class="token function">strdup</span><span class="token punctuation">(</span><span class="token string">"test1\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"[%s]\n"</span><span class="token punctuation">,</span> <span class="token function">str_trim</span> <span class="token punctuation">(</span><span class="token function">strdup</span><span class="token punctuation">(</span><span class="token string">"test2\n\r"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"[%s]\n"</span><span class="token punctuation">,</span> <span class="token function">str_trim</span> <span class="token punctuation">(</span><span class="token function">strdup</span><span class="token punctuation">(</span><span class="token string">"test3\n\r\n\r"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"[%s]\n"</span><span class="token punctuation">,</span> <span class="token function">str_trim</span> <span class="token punctuation">(</span><span class="token function">strdup</span><span class="token punctuation">(</span><span class="token string">"test4\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"[%s]\n"</span><span class="token punctuation">,</span> <span class="token function">str_trim</span> <span class="token punctuation">(</span><span class="token function">strdup</span><span class="token punctuation">(</span><span class="token string">"test5\r"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"[%s]\n"</span><span class="token punctuation">,</span> <span class="token function">str_trim</span> <span class="token punctuation">(</span><span class="token function">strdup</span><span class="token punctuation">(</span><span class="token string">"test6\r\r\r"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr />
<p><code>msvs x64 optimizing</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">s<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>
str_trim PROC

<span class="token comment">; RCX is the first function argument and it always holds pointer to the string</span>

<span class="token comment">; this is strlen() function inlined right here:</span>
<span class="token comment">; set RAX to 0xFFFFFFFFFFFFFFFF (-1)</span>
         or     <span class="token register variable">rax</span>, <span class="token operator">-</span><span class="token number">1</span>
<span class="token label function">$LL14@str_trim:</span>
         inc    <span class="token register variable">rax</span><span class="token comment">;rax++,rax:0</span>
         cmp    BYTE PTR <span class="token operator">[</span><span class="token register variable">rcx</span><span class="token operator">+</span><span class="token register variable">rax</span><span class="token operator">]</span>, <span class="token number">0</span><span class="token comment">;rcx:s</span>
         jne    SHORT <span class="token operator">$</span>LL14@str_trim<span class="token comment">;æ£€æµ‹å½“å‰å­—ç¬¦æ˜¯å¦ä¸ºç©ºå­—ç¬¦ä¸²</span>
<span class="token comment">; is string length zero? exit then</span>
         test   <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
<span class="token label function">$LN18@str_trim:</span>
         je     SHORT <span class="token operator">$</span>LN15@str_trim<span class="token comment">;eax=0åˆ™exit</span>
<span class="token comment">; RAX holds string length</span>
<span class="token comment">; here is probably disassembler (or assembler printing routine) error,</span>
<span class="token comment">; LEA RDX... should be here instead of LEA EDX...</span>
         lea    <span class="token register variable">edx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">rax</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">]</span>
<span class="token comment">; idle instruction: EAX will be reset at the next instructions execution'</span>
         mov    <span class="token register variable">eax</span>, <span class="token register variable">edx</span>
<span class="token comment">; load character at address s[str_len-1]</span>
         movzx  <span class="token register variable">eax</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">rdx</span><span class="token operator">+</span><span class="token register variable">rcx</span><span class="token operator">]</span>
<span class="token comment">; save also pointer to the last character to R8</span>
         lea    <span class="token register variable">r8</span>, QWORD PTR <span class="token operator">[</span><span class="token register variable">rdx</span><span class="token operator">+</span><span class="token register variable">rcx</span><span class="token operator">]</span>
         cmp    <span class="token register variable">al</span>, <span class="token number">13</span> <span class="token comment">; is it '\r'?</span>
         je     SHORT <span class="token operator">$</span>LN2@str_trim
         cmp    <span class="token register variable">al</span>, <span class="token number">10</span> <span class="token comment">; is it '\n'?</span>
         jne    SHORT <span class="token operator">$</span>LN15@str_trim
<span class="token label function">$LN2@str_trim:</span><span class="token comment">;å°†æ¢è¡Œç­‰å­—ç¬¦æ›¿æ¢ä¸º0</span>
<span class="token comment">; store 0 to that place</span>
         mov    BYTE PTR <span class="token operator">[</span><span class="token register variable">r8</span><span class="token operator">]</span>, <span class="token number">0</span>
         mov    <span class="token register variable">eax</span>, <span class="token register variable">edx</span>
<span class="token comment">; check character for 0, but conditional jump is above...</span>
         test   <span class="token register variable">edx</span>, <span class="token register variable">edx</span>
         jmp    SHORT <span class="token operator">$</span>LN18@str_trim
<span class="token label function">$LN15@str_trim:</span>
<span class="token comment">; return "s"</span>
         mov    <span class="token register variable">rax</span>, <span class="token register variable">rcx</span>
         ret    <span class="token number">0</span>
str_trim ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>é¦–å…ˆè¿™æ®µæ±‡ç¼–çš„ç¬¬ä¸€ä¸ªç‰¹å¾å°±æ˜¯<code>MSVSç¼–è¯‘å™¨</code>å¯¹å­—ç¬¦ä¸²é•¿åº¦å‡½æ•°<code>strlen()</code>è¿›è¡Œäº†å†…è”çš„å±•å¼€å’ŒåµŒå…¥å¤„ç†ã€‚ç¼–è¯‘å™¨è®¤ä¸ºï¼Œå†…è”å¤„ç†åçš„æ‰§è¡Œæ•ˆç‡ä¼šæ¯”å¸¸è§„çš„å‡½æ•°è°ƒç”¨æ›´å¥½</li>
<li>å†…åµŒå¤„ç†ä¹‹åï¼Œ<code>strlen()</code>å‡½æ•°çš„ç¬¬ä¸€ä¸ªæŒ‡ä»¤æ˜¯ï¼š<code>OR RAX,0xffffffffffffffff</code>ã€‚æˆ‘ä»¬ä¸æ¸…æ¥šä¸ºä½•MSVCé‡‡ç”¨ORï¼ˆæˆ–ï¼‰æŒ‡ä»¤ï¼Œè€Œæ²¡æœ‰é‡‡ç”¨<code>MOV RAX, 0xffffffffffffffff</code>æŒ‡ä»¤ç›´æ¥èµ‹å€¼ã€‚å½“ç„¶ï¼Œè¿™ä¸¤æ¡æŒ‡ä»¤æ‰§è¡Œçš„æ˜¯ç›¸åŒæ“ä½œï¼šå°†æ‰€æœ‰ä½è®¾ç½®ä¸º1ã€‚å› æ­¤è¿™ä¸ªæ•°å€¼å°±æ˜¯èµ‹å€¼ä¸ºâˆ’1ã€‚(åŸå› æ˜¯å› ä¸ºåˆå§‹å€¼ä¸º-1ï¼Œç”Ÿæˆçš„æ±‡ç¼–ä»£ç ä¼šæ›´çŸ­)</li>
</ul>
<hr />
<p><code>GCC X64 Non-Optimizing </code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token label function">str_trim:</span>
         push   <span class="token register variable">rbp</span>
         mov    <span class="token register variable">rbp</span>, <span class="token register variable">rsp</span>
         sub    <span class="token register variable">rsp</span>, <span class="token number">32</span>
         mov    QWORD PTR <span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">-</span><span class="token number">24</span><span class="token operator">]</span>, <span class="token register variable">rdi</span>
<span class="token comment">; for() first part begins here</span>
         mov    <span class="token register variable">rax</span>, QWORD PTR <span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">-</span><span class="token number">24</span><span class="token operator">]</span><span class="token comment">;rax=rdi:s</span>
         mov    <span class="token register variable">rdi</span>, <span class="token register variable">rax</span><span class="token comment">;rdi=s</span>
         call   strlen<span class="token comment">;rax:s->len(s)</span>
         mov    QWORD PTR <span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">-</span><span class="token number">8</span><span class="token operator">]</span>, <span class="token register variable">rax</span>      <span class="token comment">; str_len</span>
<span class="token comment">; for() first part ends here;[rbp-8]=len</span>
         jmp    .L2
<span class="token comment">; for() body begins here</span>
<span class="token label function">.L5:</span>
         cmp    BYTE PTR <span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">-</span><span class="token number">9</span><span class="token operator">]</span>, <span class="token number">13</span>        <span class="token comment">; c=='\r'?</span>
         je     .L3
         cmp    BYTE PTR <span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">-</span><span class="token number">9</span><span class="token operator">]</span>, <span class="token number">10</span>        <span class="token comment">; c=='\n'?</span>
         jne    .L4
<span class="token label function">.L3:</span><span class="token comment">;å¤„ç†æ¢è¡Œ</span>
         mov    <span class="token register variable">rax</span>, QWORD PTR <span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">-</span><span class="token number">8</span><span class="token operator">]</span>      <span class="token comment">; str_len</span>
         lea    <span class="token register variable">rdx</span>, <span class="token operator">[</span><span class="token register variable">rax</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">]</span>                <span class="token comment">; EDX=str_len-1</span>
         mov    <span class="token register variable">rax</span>, QWORD PTR <span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">-</span><span class="token number">24</span><span class="token operator">]</span>     <span class="token comment">; s</span>
         add    <span class="token register variable">rax</span>, <span class="token register variable">rdx</span>                    <span class="token comment">; RAX=s+str_len-1</span>
         mov    BYTE PTR <span class="token operator">[</span><span class="token register variable">rax</span><span class="token operator">]</span>, <span class="token number">0</span>           <span class="token comment">; s[str_len-1]=0</span>
<span class="token comment">; for() body ends here</span>
<span class="token comment">; for() third part begins here</span>
         sub    QWORD PTR <span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">-</span><span class="token number">8</span><span class="token operator">]</span>, <span class="token number">1</span>        <span class="token comment">; str_len--</span>
<span class="token comment">; for() third part ends here</span>
<span class="token label function">.L2:</span>
<span class="token comment">; for() second part begins here</span>
         cmp    QWORD PTR <span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">-</span><span class="token number">8</span><span class="token operator">]</span>, <span class="token number">0</span>        <span class="token comment">; str_len==0?</span>
         je     .L4                         <span class="token comment">; exit then</span>
<span class="token comment">; check second clause, and load "c"</span>
         mov    <span class="token register variable">rax</span>, QWORD PTR <span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">-</span><span class="token number">8</span><span class="token operator">]</span>      <span class="token comment">; RAX=str_len</span>
         lea    <span class="token register variable">rdx</span>, <span class="token operator">[</span><span class="token register variable">rax</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">]</span>                <span class="token comment">; RDX=str_len-1</span>
         mov    <span class="token register variable">rax</span>, QWORD PTR <span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">-</span><span class="token number">24</span><span class="token operator">]</span>     <span class="token comment">; RAX=s</span>
         add    <span class="token register variable">rax</span>, <span class="token register variable">rdx</span>                    <span class="token comment">; RAX=s+str_len-1</span>
         movzx  <span class="token register variable">eax</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">rax</span><span class="token operator">]</span>         <span class="token comment">; AL=s[str_len-1]</span>
         mov    BYTE PTR <span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">-</span><span class="token number">9</span><span class="token operator">]</span>, <span class="token register variable">al</span>        <span class="token comment">; store loaded char into "c"</span>
         cmp    BYTE PTR <span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">-</span><span class="token number">9</span><span class="token operator">]</span>, <span class="token number">0</span>         <span class="token comment">; is it zero?</span>
         jne    .L5                         <span class="token comment">; yes? exit then</span>
<span class="token comment">; for() second part ends here</span>
<span class="token label function">.L4:</span>
<span class="token comment">; return "s"</span>
         mov    <span class="token register variable">rax</span>, QWORD PTR <span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">-</span><span class="token number">24</span><span class="token operator">]</span>
         leave
         ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ‰§è¡Œå®Œé•¿åº¦è®¡ç®—å‡½æ•°strlen()åï¼Œæ§åˆ¶æƒå°†ä¼ é€’ç»™æ ‡å·ä¸ºL2çš„è¯­å¥ã€‚æ¥ç€æ³¨æ„æ£€æŸ¥ä¸¤ä¸ªæ¡ä»¶è¡¨è¾¾å¼ã€‚å¦‚æœç¬¬ä¸€åˆ¤æ–­æ¡ä»¶è¡¨è¾¾å¼ä¸ºçœŸï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœé•¿åº¦ä¸º0ï¼ˆstr_lençš„å€¼ä¸º0ï¼‰ï¼Œé‚£ä¹ˆè®¡ç®—æœºå°†ä¸å†æ£€æµ‹ç¬¬äºŒä¸ªæ¡ä»¶åˆ¤æ–­è¡¨è¾¾å¼ã€‚è¿™ç§ç‰¹æ€§åˆç§°ä¸ºâ€œé€»è¾‘çŸ­è·¯â€<br />
æ¦‚æ‹¬åœ°è¯´ï¼Œè¿™ä¸ªå‡½æ•°çš„æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>è¿è¡Œfor()è¯­å¥çš„ç¬¬ä¸€éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨strlen()å‡½æ•°çš„å¾ªç¯åˆå§‹åŒ–æŒ‡ä»¤ã€‚</li>
<li>è·³è½¬åˆ°æ ‡å·L2ï¼›æ£€æµ‹å¾ªç¯æ¡ä»¶æ˜¯å¦æˆç«‹ã€‚</li>
<li>è·³è½¬åˆ°æ ‡å·L5ï¼Œè¿›å…¥å¾ªç¯ä½“ï¼›</li>
<li>å†æ‰§è¡Œfor()è¯­å¥ï¼Œå¦‚æœæ¡ä»¶ä¸æˆç«‹ï¼Œåˆ™ç›´æ¥é€€å‡ºã€‚</li>
<li>æ‰§è¡Œfor()è¯­å¥çš„ç¬¬ä¸‰éƒ¨åˆ†ï¼Œå°†å˜é‡str_lené€’å‡ã€‚</li>
<li>å†æ¬¡è·³è½¬åˆ°æ ‡å·L2ï¼Œæ£€æµ‹å¾ªç¯æ¡ä»¶æ˜¯å¦æˆç«‹ã€è¿›å…¥å¾ªç¯â€¦â€¦å‘¨è€Œå¤å§‹ï¼Œç›´åˆ°å¾ªç¯æ¡ä»¶ä¸æˆç«‹ã€‚</li>
<li>è·³è½¬åˆ°L4æ ‡å·ï¼Œå‡†å¤‡é€€å‡ºã€‚</li>
<li>åˆ¶å¤‡è¿”å›å€¼ï¼Œå³å˜é‡sã€‚</li>
</ul>
<p><code>x64 gcc optimizing</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token label function">str_trim:</span>
         push   <span class="token register variable">rbx</span>
         mov    <span class="token register variable">rbx</span>, <span class="token register variable">rdi</span>
<span class="token comment">; RBX will always be "s"</span>
         call   strlen
<span class="token comment">; check for str_len==0 and exit if its so'</span>
         test   <span class="token register variable">rax</span>, <span class="token register variable">rax</span>
         je     .L9
         lea    <span class="token register variable">rdx</span>, <span class="token operator">[</span><span class="token register variable">rax</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">]</span>
<span class="token comment">; RDX will always contain str_len-1 value, not str_len</span>
<span class="token comment">; so RDX is more like buffer index variable</span>
         lea    <span class="token register variable">rsi</span>, <span class="token operator">[</span><span class="token register variable">rbx</span><span class="token operator">+</span><span class="token register variable">rdx</span><span class="token operator">]</span>       <span class="token comment">; RSI=s+str_len-1</span>
         movzx  <span class="token register variable">ecx</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">rsi</span><span class="token operator">]</span>  <span class="token comment">; load character</span>
         test   <span class="token register variable">cl</span>, <span class="token register variable">cl</span>
         je     .L9                  <span class="token comment">; exit if its zero'</span>
         cmp    <span class="token register variable">cl</span>, <span class="token number">10</span>
         je     .L4
         cmp    <span class="token register variable">cl</span>, <span class="token number">13</span>               <span class="token comment">; exit if its not' '\n' and not '\r'</span>
         jne    .L9
<span class="token label function">.L4:</span>
<span class="token comment">; this is weird instruction. we need RSI=s-1 here.</span>
<span class="token comment">; its possible to get it by' MOV RSI, EBX / DEC RSI</span>
<span class="token comment">; but this is two instructions instead of one</span>
         sub    <span class="token register variable">rsi</span>, <span class="token register variable">rax</span>
<span class="token comment">; RSI = s+str_len-1-str_len = s-1</span>
<span class="token comment">; main loop begin</span>
<span class="token label function">.L12:</span>
         test   <span class="token register variable">rdx</span>, <span class="token register variable">rdx</span>
<span class="token comment">; store zero at address s-1+str_len-1+1 = s-1+str_len = s+str_len-1</span>
         mov    BYTE PTR <span class="token operator">[</span><span class="token register variable">rsi</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">+</span><span class="token register variable">rdx</span><span class="token operator">]</span>, <span class="token number">0</span>
<span class="token comment">; check for str_len-1==0. exit if so.</span>
         je     .L9
         sub    <span class="token register variable">rdx</span>, <span class="token number">1</span>               <span class="token comment">; equivalent to str_len--</span>
<span class="token comment">; load next character at address s+str_len-1</span>
         movzx  <span class="token register variable">ecx</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">rbx</span><span class="token operator">+</span><span class="token register variable">rdx</span><span class="token operator">]</span>
         test   <span class="token register variable">cl</span>, <span class="token register variable">cl</span>               <span class="token comment">; is it zero? exit then</span>
         je     .L9
         cmp    <span class="token register variable">cl</span>, <span class="token number">10</span>               <span class="token comment">; is it '\n'?</span>
         je     .L12
         cmp    <span class="token register variable">cl</span>, <span class="token number">13</span>               <span class="token comment">; is it '\r'?</span>
         je     .L12
<span class="token label function">.L9:</span>
<span class="token comment">; return "s"</span>
         mov    <span class="token register variable">rax</span>, <span class="token register variable">rbx</span>
         pop    <span class="token register variable">rbx</span>
         ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>GCCçš„å®ç°æ–¹å¼æ›´ä¸ºå¤æ‚ã€‚åœ¨å¾ªç¯ä½“æ‰§è¡Œå‰çš„ä»£ç åªæ‰§è¡Œä¸€æ¬¡ï¼Œè€Œä¸”å®ƒè¿˜ä¼šæ£€æŸ¥ç»“æŸç¬¦æ˜¯ä¸æ˜¯å›è½¦å’Œæ¢è¡ŒCR/LFã€‚è¿™éš¾é“ä¸æ˜¯å¤šæ­¤ä¸€ä¸¾å—ï¼Ÿ</p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œå®ç°ä¸»å¾ªç¯ä½“çš„æµç¨‹æ˜¯è¿™æ ·çš„ï¼š</p>
<p>â‘  å¾ªç¯å¼€å§‹ï¼Œæ£€æŸ¥CR/LFç»“æŸç¬¦ï¼Œè¿›è¡Œåˆ¤æ–­ã€‚</p>
<p>â‘¡ ä¿å­˜é›¶å­—ç¬¦ã€‚</p>
<p>ä½†æ˜¯ï¼Œ<code>GCCç¼–è¯‘å™¨ä¼šå°†è¿™ä¸¤æ­¥é€†åºæ‰§è¡Œ</code>ã€‚å› æ­¤ï¼Œç¬¬ä¸€æ­¥è‚¯å®šä¸ä¼šæ˜¯ä¿å­˜é›¶å­—ç¬¦ï¼Œè€Œæ˜¯è¿›è¡Œä¸‹è¿°åˆ¤æ–­ï¼š</p>
<p>â‘  çœ‹çœ‹ç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯ä¸æ˜¯CR/LF,å¦‚æœä¸æ˜¯çš„è¯ï¼Œå°±ä¼šé€€å‡ºã€‚</p>
<p>â‘¡ å¾ªç¯å¼€å§‹ï¼Œä¿å­˜é›¶å­—ç¬¦ã€‚</p>
<p>â‘¢ æ ¹æ®æ£€æŸ¥å­—ç¬¦æ˜¯ä¸æ˜¯CR/LFæ¥å†³å®šç¨‹åºçš„æ‰§è¡Œã€‚</p>
<p>è¿™æ ·å¤„ç†ä¹‹åï¼Œä¸»å¾ªç¯ä½“å°±å°äº†å¾ˆå¤šï¼Œæ›´é€‚ç”¨äºç›®å‰çš„CPUäº†ã€‚è¿™ç§ä»£ç çš„ä¸­é—´å˜é‡ä¸æ˜¯str_lenï¼Œè€Œæ˜¯str_len-1ã€‚æˆ–è®¸æ˜¯å› ä¸ºåè€…æ›´é€‚ç”¨äºç”¨ä½œç¼“å†²åŒºå‹æ•°æ®çš„ç´¢å¼•æ ‡å·ï¼ˆæ•°ç»„ä¸‹æ ‡ï¼‰ã€‚å¾ˆæ˜æ˜¾ï¼ŒGCCæ³¨æ„åˆ°äº†ï¼Œstr_len-1ä½¿ç”¨äº†ä¸¤æ¬¡ã€‚å› æ­¤æœ€å¥½çš„åŠæ³•æ˜¯åˆ†é…ä¸€ä¸ªå˜é‡ï¼Œå…¶å€¼æ€»æ˜¯æ¯”ç›®å‰çš„å­—ç¬¦ä¸²çš„é•¿åº¦å°1ï¼Œç„¶åå†å°†å…¶é€’å‡ï¼ˆæŒ‰ç…§å˜é‡str_lençš„é€’å‡æ–¹å¼é€’å‡ï¼‰ã€‚</p>
<h3 id="chap48-toupper"><a class="markdownIt-Anchor" href="#chap48-toupper"></a> Chap48 toupper()</h3>
<p>æœ¬ç« ä»‹ç»å°†å°å†™å­—æ¯è½¬ä¸ºå¤§å†™å­—æ¯çš„å‡½æ•°</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">char</span> <span class="token function">toupper</span> <span class="token punctuation">(</span><span class="token keyword">char</span> c<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>c<span class="token operator">>=</span><span class="token char">'a'</span> <span class="token operator">&amp;&amp;</span> c<span class="token operator">&lt;=</span><span class="token char">'z'</span><span class="token punctuation">)</span>
                  <span class="token keyword">return</span> c<span class="token operator">-</span><span class="token char">'a'</span><span class="token operator">+</span><span class="token char">'A'</span><span class="token punctuation">;</span>
         <span class="token keyword">else</span>
                  <span class="token keyword">return</span> c<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr />
<p><code>x64 msvs non-optimizing</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"> <span class="token number">1</span>  c<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>
 <span class="token number">2</span>  toupper PROC
 <span class="token number">3</span>          mov     BYTE PTR <span class="token operator">[</span><span class="token register variable">rsp</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span>, <span class="token register variable">cl</span><span class="token comment">;rsp+8:c</span>
 <span class="token number">4</span>          movsx   <span class="token register variable">eax</span>, BYTE PTR c<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">rsp</span><span class="token operator">]</span><span class="token comment">;eax:c</span>
 <span class="token number">5</span>          cmp     <span class="token register variable">eax</span>, <span class="token number">97</span><span class="token comment">;c=97?</span>
 <span class="token number">6</span>          jl      SHORT <span class="token operator">$</span>LN2@toupper <span class="token operator">&lt;</span>åˆ™exit
 <span class="token number">7</span>          movsx   <span class="token register variable">eax</span>, BYTE PTR c<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">rsp</span><span class="token operator">]</span><span class="token comment">;å¤šä½™çš„</span>
 <span class="token number">8</span>          cmp     <span class="token register variable">eax</span>, <span class="token number">122</span><span class="token comment">;c=122?</span>
 <span class="token number">9</span>          jg      SHORT <span class="token operator">$</span>LN2@toupper,<span class="token operator">></span>åˆ™exit
<span class="token number">10</span>          movsx   <span class="token register variable">eax</span>, BYTE PTR c<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">rsp</span><span class="token operator">]</span>
<span class="token number">11</span>          sub     <span class="token register variable">eax</span>, <span class="token number">32</span><span class="token comment">;å°†c-32</span>
<span class="token number">12</span>          jmp     SHORT <span class="token operator">$</span>LN3@toupper
<span class="token number">13</span>          jmp     SHORT <span class="token operator">$</span>LN1@toupper <span class="token comment">; compiler artefact</span>
<span class="token number">14</span>  <span class="token operator">$</span>LN2@toupper:
<span class="token number">15</span>          movzx   <span class="token register variable">eax</span>, BYTE PTR c<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">rsp</span><span class="token operator">]</span> <span class="token comment">; unnecessary casting</span>
<span class="token number">16</span>  <span class="token operator">$</span>LN1@toupper:
<span class="token number">17</span>  <span class="token operator">$</span>LN3@toupper: <span class="token comment">; compiler artefact</span>
<span class="token number">18</span>          ret     <span class="token number">0</span>
<span class="token number">19</span>  toupper ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼šç¨‹åºç¬¬3è¡ŒæŠŠè¾“å…¥çš„å­—èŠ‚è£…è½½åˆ°64ä½æ ˆçš„é‚£æ¡æŒ‡ä»¤ã€‚è¾“å…¥å€¼æ˜¾ç„¶æ˜¯å æ®äº†64ä½çš„ä½8ä½ï¼Œè€Œå…¶é«˜ä½ï¼ˆä»ç¬¬8ä½åˆ°ç¬¬63ä½ï¼‰åˆ™ä¿æŒä¸å˜ã€‚æˆ‘ä»¬å¯ä»¥åœ¨è°ƒè¯•å™¨debuggeré‡Œçœ‹åˆ°è¿™é«˜56ä½æ˜¯éšæœºçš„å™ªéŸ³æ•°æ®ï¼ˆä¹Ÿå°±æ˜¯éšæœºæ•°ï¼‰ã€‚å› ä¸ºæ‰€æœ‰æŒ‡ä»¤éƒ½æ˜¯ä»¥å­—èŠ‚ä¸ºæ“ä½œå¯¹è±¡ï¼Œå› æ­¤è¿™ç§å­˜å‚¨æ–¹æ¡ˆä¸ä¼šå¼•å‘é—®é¢˜ã€‚ç¬¬15è¡Œçš„æœ€åä¸€ä¸ªMOVZXæŒ‡ä»¤ä»æœ¬åœ°æ ˆé‡Œå–å‡ºä¸€ä¸ªå­—èŠ‚ï¼ŒæŠŠå®ƒæ— ç¬¦å·æ‰©å±•ä¸º32ä½æ•°æ®ä¸­ï¼Œå› æ­¤è¿™é«˜56ä½çš„å™ªéŸ³æ•°æ®éƒ½ä¼šè¢«å¡«å……ä¸ºé›¶</p>
<p><code>non optimizing gcc</code>è²Œä¼¼æ›´å¥½ï¼Œæ²¡æœ‰äº†å¤šä½™çš„æŒ‡ä»¤</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token label function">toupper:</span>
         push    <span class="token register variable">rbp</span>
         mov     <span class="token register variable">rbp</span>, <span class="token register variable">rsp</span>
         mov     <span class="token register variable">eax</span>, <span class="token register variable">edi</span>
         mov     BYTE PTR <span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">al</span>
         cmp     BYTE PTR <span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token number">96</span>
         jle     .L2
         cmp     BYTE PTR <span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token number">122</span>
         jg      .L2
         movzx   <span class="token register variable">eax</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
         sub     <span class="token register variable">eax</span>, <span class="token number">32</span>
         jmp     .L3
<span class="token label function">.L2:</span>
         movzx   <span class="token register variable">eax</span>, BYTE PTR <span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
<span class="token label function">.L3:</span>
         pop     <span class="token register variable">rbp</span>
         ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr />
<p><code>optimizing msvs</code></p>
<p>è¿™é‡Œä¼˜åŒ–å°†ä¸¤ä¸ªæ¯”è¾ƒåˆ†é…ä¸ºä¸€ä¸ªæ¯”è¾ƒ</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">toupper PROC
        lea     <span class="token register variable">eax</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">rcx</span><span class="token operator">-</span><span class="token number">97</span><span class="token operator">]</span>
        cmp     <span class="token register variable">al</span>, <span class="token number">25</span>
        ja      SHORT <span class="token operator">$</span>LN2@toupper
        movsx   <span class="token register variable">eax</span>, <span class="token register variable">cl</span>
        sub     <span class="token register variable">eax</span>, <span class="token number">32</span>
        ret     <span class="token number">0</span>
<span class="token label function">$LN2@toupper:</span>
        movzx   <span class="token register variable">eax</span>, <span class="token register variable">cl</span>
        ret     <span class="token number">0</span>
toupper ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr />
<p><code>optimizing gcc</code></p>
<p>ä¸ç”¨è·³è½¬æŒ‡ä»¤<code>JUMP</code>è€Œæ˜¯é‡‡ç”¨äº†<code>CMOVcc</code>æŒ‡ä»¤</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token number">1</span>  toupper:
<span class="token number">2</span>          lea      <span class="token register variable">edx</span>, <span class="token operator">[</span><span class="token register variable">rdi</span><span class="token operator">-</span><span class="token number">97</span><span class="token operator">]</span> <span class="token comment">; 0x61</span>
<span class="token number">3</span>          lea      <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">rdi</span><span class="token operator">-</span><span class="token number">32</span><span class="token operator">]</span> <span class="token comment">; 0x20</span>
<span class="token number">4</span>          cmp      <span class="token register variable">dl</span>, <span class="token number">25</span>
<span class="token number">5</span>          cmova    <span class="token register variable">eax</span>, <span class="token register variable">edi</span>
<span class="token number">6</span>          ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p><strong>æŒ‡ä»¤æ ¼å¼</strong>ï¼š<code>cmova src, dst</code></p>
<p><strong>åŠŸèƒ½</strong>ï¼šå¦‚æœå½“å‰çš„è¿ç®—ç»“æœè¡¨æ˜æ— ç¬¦å·æ•°çš„æ¯”è¾ƒä¸­ï¼Œæºæ“ä½œæ•°ï¼ˆ<code>src</code>ï¼‰å¤§äºæˆ–ç­‰äºç›®æ ‡æ“ä½œæ•°ï¼ˆä½äº<code>dst</code>ï¼‰ï¼Œé‚£ä¹ˆè¿™æ¡æŒ‡ä»¤ä¼šå°†<code>src</code>çš„å†…å®¹æ— æ¡ä»¶åœ°ç§»åŠ¨åˆ°<code>dst</code>ä¸­ã€‚è¿™é‡Œçš„â€œå¤§äºæˆ–ç­‰äºâ€æ¡ä»¶æ˜¯åŸºäºEFLAGSå¯„å­˜å™¨ä¸­çš„é›¶æ ‡å¿—ï¼ˆZFï¼‰å’Œç¬¦å·æ ‡å¿—ï¼ˆSFï¼‰ä»¥åŠæº¢å‡ºæ ‡å¿—ï¼ˆOFï¼‰çš„çŠ¶æ€æ¥å†³å®šçš„ï¼Œç¡®ä¿äº†æ˜¯é’ˆå¯¹æ— ç¬¦å·æ•´æ•°çš„æ¯”è¾ƒã€‚</p>
</li>
<li>
<p>ä¹Ÿå°±æ˜¯å¦‚æœ<code>dl</code>çš„å€¼å¤§äº25ï¼Œå³ä¸ºè´Ÿæ•°çš„æƒ…å†µï¼Œè¿”å›åŸå€¼</p>
</li>
<li>
<p>å¦åˆ™è½¬ä¸ºå¤§å†™</p>
</li>
</ul>
<h3 id="chap49-ä¸æ­£ç¡®çš„åæ±‡ç¼–ä»£ç "><a class="markdownIt-Anchor" href="#chap49-ä¸æ­£ç¡®çš„åæ±‡ç¼–ä»£ç "></a> Chap49 ä¸æ­£ç¡®çš„åæ±‡ç¼–ä»£ç </h3>
<h4 id="x86ç¯å¢ƒä¸‹çš„ä»ä¸€å¼€å§‹å°±é”™è¯¯çš„åæ±‡ç¼–"><a class="markdownIt-Anchor" href="#x86ç¯å¢ƒä¸‹çš„ä»ä¸€å¼€å§‹å°±é”™è¯¯çš„åæ±‡ç¼–"></a> x86ç¯å¢ƒä¸‹çš„ä»ä¸€å¼€å§‹å°±é”™è¯¯çš„åæ±‡ç¼–</h4>
<p>å› ä¸ºä¸<code>opcode</code>ç­‰é•¿çš„æœ‰<code>ARM</code>ä»¥åŠ<code>MIPS</code>æŒ‡ä»¤é›†(æ¯ä¸ªæŒ‡ä»¤çš„<code>opcode</code>è¦ä¹ˆæ˜¯2å­—èŠ‚è¦ä¹ˆæ˜¯4å­—èŠ‚)ï¼Œè€Œ<code>x86</code>æ¶æ„ä¸‹çš„<code>opcode</code>é•¿åº¦ä¸åŒï¼Œå¦‚æœ<code>x86</code>ç¨‹åºä»ä¸­é—´å°±å¼€å§‹è§£ææŒ‡ä»¤ï¼Œæ— è®ºä»€ä¹ˆå·¥å…·éƒ½ä¼šåˆ†æå‡ºé”™è¯¯çš„ç»“æœ</p>
<p>ä¾‹å¦‚</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">add      <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">-</span><span class="token number">31F7Bh</span><span class="token operator">]</span>, <span class="token register variable">cl</span>
dec      dword ptr <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">-</span><span class="token number">3277Bh</span><span class="token operator">]</span>
dec      dword ptr <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">-</span><span class="token number">2CF7Bh</span><span class="token operator">]</span>
inc      dword ptr <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">-</span><span class="token number">7A76F33Ch</span><span class="token operator">]</span>
fdiv     st(<span class="token number">4</span>), st
db <span class="token number">0FFh</span>
dec      dword ptr <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">-</span><span class="token number">21F7Bh</span><span class="token operator">]</span>
dec      dword ptr <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">-</span><span class="token number">22373h</span><span class="token operator">]</span>
dec      dword ptr <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">-</span><span class="token number">2276Bh</span><span class="token operator">]</span>
dec      dword ptr <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">-</span><span class="token number">22B63h</span><span class="token operator">]</span>
dec      dword ptr <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">-</span><span class="token number">22F4Bh</span><span class="token operator">]</span>
dec      dword ptr <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">-</span><span class="token number">23343h</span><span class="token operator">]</span>
jmp      dword ptr <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">-</span><span class="token number">74h</span><span class="token operator">]</span>
xchg     <span class="token register variable">eax</span>, <span class="token register variable">ebp</span>
clc
std
db <span class="token number">0FFh</span>
db <span class="token number">0FFh</span><span class="token comment">;åœ¨æ­¤ä¹‹å‰çš„åæ±‡ç¼–ç»“æœéƒ½æ˜¯é”™è¯¯çš„</span>
mov      word ptr <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">-</span><span class="token number">214h</span><span class="token operator">]</span>, <span class="token register variable">cs</span> <span class="token comment">; &lt;- disassembler finally found right track here</span>
mov      word ptr <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">-</span><span class="token number">238h</span><span class="token operator">]</span>, <span class="token register variable">ds</span>
mov      word ptr <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">-</span><span class="token number">23Ch</span><span class="token operator">]</span>, <span class="token register variable">es</span>
mov      word ptr <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">-</span><span class="token number">240h</span><span class="token operator">]</span>, <span class="token register variable">fs</span>
mov      word ptr <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">-</span><span class="token number">244h</span><span class="token operator">]</span>, <span class="token register variable">gs</span>
pushf
pop      dword ptr <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">-</span><span class="token number">210h</span><span class="token operator">]</span>
mov      <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>
mov      <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">-</span><span class="token number">218h</span><span class="token operator">]</span>, <span class="token register variable">eax</span>
lea      <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>
mov      <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">-</span><span class="token number">20Ch</span><span class="token operator">]</span>, <span class="token register variable">eax</span>
mov      dword ptr <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">-</span><span class="token number">2D0h</span><span class="token operator">]</span>, <span class="token number">10001h</span>
mov      <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
mov      <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">-</span><span class="token number">21Ch</span><span class="token operator">]</span>, <span class="token register variable">eax</span>
mov      <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token number">0Ch</span><span class="token operator">]</span>
mov      <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">-</span><span class="token number">320h</span><span class="token operator">]</span>, <span class="token register variable">eax</span>
mov      <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token number">10h</span><span class="token operator">]</span>
mov      <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">-</span><span class="token number">31Ch</span><span class="token operator">]</span>, <span class="token register variable">eax</span>
mov      <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>
mov      <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">-</span><span class="token number">314h</span><span class="token operator">]</span>, <span class="token register variable">eax</span>
call     <span class="token register variable">ds</span>:IsDebuggerPresent
mov      <span class="token register variable">edi</span>, <span class="token register variable">eax</span>
lea      <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">-</span><span class="token number">328h</span><span class="token operator">]</span>
push     <span class="token register variable">eax</span>
call     sub_407663
pop      <span class="token register variable">ecx</span>
test     <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
jnz      short loc_402D7B<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><mark>æˆ‘ä»¬è¯¥å¦‚æœåˆ†è¾¨å‡ºå“ªäº›æ˜¯ä¸æ­£ç¡®çš„åæ±‡ç¼–ä»£ç å‘¢?</mark></p>
<ul>
<li>ä¸å¯»å¸¸çš„æŒ‡ä»¤é›†åˆï¼Œx86å¸¸è§çš„æŒ‡ä»¤æ˜¯<code>PUSH,MOV,CALL</code>ï¼Œå¦‚æœé‡åˆ°äº†å¤§æ‚çƒ©çš„ç¨€æœ‰æŒ‡ä»¤æ‹¼ç›˜å¹¶ä¸”ä¸çŸ¥æ‰€äº‘çš„å°±è‚¯å®šæ˜¯é”™çš„(FPUæŒ‡ä»¤ï¼Œè¾“å…¥è¾“å‡ºIN/OUTç­‰ç­‰)</li>
<li>åˆå¤§åˆåƒæ˜¯éšæœºæ•°çš„æ•°å€¼ã€åç§»é‡ä»¥åŠç«‹å³æ•°ã€‚</li>
<li>è½¬ç§»æŒ‡ä»¤çš„åç§»é‡ä¸åˆé€»è¾‘ï¼Œç»å¸¸è·³è½¬åˆ°å…¶ä»–æŒ‡ä»¤å—çš„ä¸­é—´ã€‚</li>
</ul>
<p>ä¸€äº›ä¾‹å­</p>
<p><code>x86</code>çš„éšæœºæ•°å™ªå£°</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">  	 mov    <span class="token register variable">bl</span>, <span class="token number">0Ch</span>
     mov    <span class="token register variable">ecx</span>, <span class="token number">0D38558Dh</span>
     mov    <span class="token register variable">eax</span>, <span class="token register variable">ds</span>:<span class="token number">2C869A86h</span>
     db     <span class="token number">67h</span>
     mov    <span class="token register variable">dl</span>, <span class="token number">0CCh</span>
     insb
     movsb
     push   <span class="token register variable">eax</span>
     xor    <span class="token operator">[</span><span class="token register variable">edx</span><span class="token operator">-</span><span class="token number">53h</span><span class="token operator">]</span>, <span class="token register variable">ah</span>
     fcom   qword ptr <span class="token operator">[</span><span class="token register variable">edi</span><span class="token operator">-</span><span class="token number">45A0EF72h</span><span class="token operator">]</span>
     pop    <span class="token register variable">esp</span>
     pop    <span class="token register variable">ss</span>
     in     <span class="token register variable">eax</span>, <span class="token register variable">dx</span>
     dec    <span class="token register variable">ebx</span>
     push   <span class="token register variable">esp</span>
     lds    <span class="token register variable">esp</span>, <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">-</span><span class="token number">41h</span><span class="token operator">]</span>
     retf
     rcl    dword ptr <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span>, <span class="token register variable">cl</span>
     mov    <span class="token register variable">cl</span>, <span class="token number">9Ch</span>
     mov    <span class="token register variable">ch</span>, <span class="token number">0DFh</span>
     push   <span class="token register variable">cs</span>
     insb
     mov    <span class="token register variable">esi</span>, <span class="token number">0D9C65E4Dh</span>
     imul   <span class="token register variable">ebp</span>, <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">]</span>, <span class="token number">66h</span>
     pushf
     sal    dword ptr <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">-</span><span class="token number">64h</span><span class="token operator">]</span>, <span class="token register variable">cl</span>
     sub    <span class="token register variable">eax</span>, <span class="token number">0AC433D64h</span>
     out    <span class="token number">8Ch</span>, <span class="token register variable">eax</span>
     pop    <span class="token register variable">ss</span>
     sbb    <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span>, <span class="token register variable">ebx</span>
     aas
     xchg   <span class="token register variable">cl</span>, <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token register variable">ebx</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">+</span><span class="token number">14B31Eh</span><span class="token operator">]</span>
     jecxz  short near ptr loc_58<span class="token operator">+</span><span class="token number">1</span>
     xor    <span class="token register variable">al</span>, <span class="token number">0C6h</span>
     inc    <span class="token register variable">edx</span>
     db     <span class="token number">36h</span>
     pusha
     stosb
     test   <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">]</span>, <span class="token register variable">ebx</span>
     sub    <span class="token register variable">al</span>, <span class="token number">0D3h</span> <span class="token comment">; 'L'</span>
     pop    <span class="token register variable">eax</span>
     stosb

<span class="token label function">loc_58:</span> <span class="token comment">; CODE XREF: seg000:0000004A</span>
     test   <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">]</span>, <span class="token register variable">eax</span>
     inc    <span class="token register variable">ebp</span>
     das
     db     <span class="token number">64h</span>
     pop    <span class="token register variable">ecx</span>
     das
     hlt

     pop    <span class="token register variable">edx</span>
     out    <span class="token number">0B0h</span>, <span class="token register variable">al</span>
     lodsb
     push   <span class="token register variable">ebx</span>
     cdq
     out    <span class="token register variable">dx</span>, <span class="token register variable">al</span>
     sub    <span class="token register variable">al</span>, <span class="token number">0Ah</span>
     sti
     outsd
     add    dword ptr <span class="token operator">[</span><span class="token register variable">edx</span><span class="token operator">]</span>, <span class="token number">96FCBE4Bh</span>
     and    <span class="token register variable">eax</span>, <span class="token number">0E537EE4Fh</span>
     inc    <span class="token register variable">esp</span>
     stosd
     cdq
     push   <span class="token register variable">ecx</span>
     in     <span class="token register variable">al</span>, <span class="token number">0CBh</span>
     mov    <span class="token register variable">ds</span>:<span class="token number">0D114C45Ch</span>, <span class="token register variable">al</span>
     mov    <span class="token register variable">esi</span>, <span class="token number">659D1985h</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>x86-64</code>çš„éšæœºæ•°å™ªå£°</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">     lea    <span class="token register variable">esi</span>, <span class="token operator">[</span><span class="token register variable">rax</span><span class="token operator">+</span><span class="token register variable">rdx</span><span class="token operator">*</span><span class="token number">4</span><span class="token operator">+</span><span class="token number">43558D29h</span><span class="token operator">]</span>

<span class="token label function">loc_AF3:</span> <span class="token comment">; CODE XREF: seg000:0000000000000B46</span>
     rcl    byte ptr <span class="token operator">[</span><span class="token register variable">rsi</span><span class="token operator">+</span><span class="token register variable">rax</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">+</span><span class="token number">29BB423Ah</span><span class="token operator">]</span>, <span class="token number">1</span>
     lea    <span class="token register variable">ecx</span>, <span class="token register variable">cs</span>:<span class="token number">0FFFFFFFFB2A6780Fh</span>
     mov    <span class="token register variable">al</span>, <span class="token number">96h</span>
     mov    <span class="token register variable">ah</span>, <span class="token number">0CEh</span>
     push   <span class="token register variable">rsp</span>
     lods   byte ptr <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">]</span>

     db <span class="token number">2Fh</span> <span class="token comment">; /</span>

     pop    <span class="token register variable">rsp</span>
     db     <span class="token number">64h</span>
     retf   <span class="token number">0E993h</span>

     cmp    <span class="token register variable">ah</span>, <span class="token operator">[</span><span class="token register variable">rax</span><span class="token operator">+</span><span class="token number">4Ah</span><span class="token operator">]</span>
     movzx  <span class="token register variable">rsi</span>, dword ptr <span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">-</span><span class="token number">25h</span><span class="token operator">]</span>
     push   <span class="token number">4Ah</span>
     movzx  <span class="token register variable">rdi</span>, dword ptr <span class="token operator">[</span><span class="token register variable">rdi</span><span class="token operator">+</span><span class="token register variable">rdx</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">]</span>

     db <span class="token number">9Ah</span>

     rcr    byte ptr <span class="token operator">[</span><span class="token register variable">rax</span><span class="token operator">+</span><span class="token number">1Dh</span><span class="token operator">]</span>, <span class="token register variable">cl</span>
     lodsd
     xor    <span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">+</span><span class="token number">6CF20173h</span><span class="token operator">]</span>, <span class="token register variable">edx</span>
     xor    <span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">+</span><span class="token number">66F8B593h</span><span class="token operator">]</span>, <span class="token register variable">edx</span>
     push   <span class="token register variable">rbx</span>
     sbb    <span class="token register variable">ch</span>, <span class="token operator">[</span><span class="token register variable">rbx</span><span class="token operator">-</span><span class="token number">0Fh</span><span class="token operator">]</span>
     stosd
     int    <span class="token number">87h</span>
     db     <span class="token number">46h</span>, <span class="token number">4Ch</span>
     out    <span class="token number">33h</span>, <span class="token register variable">rax</span>
     xchg   <span class="token register variable">eax</span>, <span class="token register variable">ebp</span>
     test   <span class="token register variable">ecx</span>, <span class="token register variable">ebp</span>
     movsd
     leave
     push   <span class="token register variable">rsp</span>

     db <span class="token number">16h</span>

     xchg   <span class="token register variable">eax</span>, <span class="token register variable">esi</span>
     pop    <span class="token register variable">rdi</span>

<span class="token label function">loc_B3D:</span> <span class="token comment">; CODE XREF: seg000:0000000000000B5F</span>
     mov    <span class="token register variable">ds</span>:<span class="token number">93CA685DF98A90F9h</span>, <span class="token register variable">eax</span>
     jnz    short near ptr loc_AF3<span class="token operator">+</span><span class="token number">6</span>
     out    <span class="token register variable">dx</span>, <span class="token register variable">eax</span>
     cwde
     mov    <span class="token register variable">bh</span>, <span class="token number">5Dh</span> <span class="token comment">; ']'</span>
     movsb
     pop    <span class="token register variable">rbp</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="chap50-æ··æ·†æŠ€æœ¯"><a class="markdownIt-Anchor" href="#chap50-æ··æ·†æŠ€æœ¯"></a> Chap50 æ··æ·†æŠ€æœ¯</h3>
<p><em>ä»£ç æ··æ·†æŠ€æœ¯æ˜¯ä¸€ç§ç”¨äºé˜»ç¢é€†å‘å·¥ç¨‹åˆ†æäººå‘˜è§£æç¨‹åºä»£ç ï¼ˆæˆ–åŠŸèƒ½ï¼‰çš„æŒ‡ä»¤å¤„ç†æŠ€æœ¯ã€‚</em></p>
<h4 id="å­—ç¬¦ä¸²å˜æ¢"><a class="markdownIt-Anchor" href="#å­—ç¬¦ä¸²å˜æ¢"></a> å­—ç¬¦ä¸²å˜æ¢</h4>
<p><em>åœ¨é€†å‘å·¥ç¨‹çš„è¿‡ç¨‹ä¸­å­—ç¬¦ä¸²ç»å¸¸èµ·åˆ°è·¯æ ‡çš„ä½œç”¨ã€‚æ³¨æ„åˆ°è¿™ä¸ªé—®é¢˜çš„ç¼–ç¨‹äººå‘˜å°±ä¼šç€æ‰‹è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ä»–ä»¬ä¼šé‡‡ç”¨ä¸€äº›å˜æ¢çš„æ‰‹æ³•ï¼Œè®©ä»–äººä¸èƒ½ç›´æ¥é€šè¿‡IDAæˆ–è€…16è¿›åˆ¶ç¼–è¾‘å™¨ç›´æ¥æœç´¢åˆ°å­—ç¬¦ä¸²åŸæ–‡ã€‚</em></p>
<ul>
<li>
<p>å¯ä»¥æ„é€ ä¸€ä¸ªå­—ç¬¦ä¸²</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">Mov     byte ptr <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">]</span>, <span class="token string">'h'</span>
mov     byte ptr <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">]</span>, <span class="token string">'e'</span>
mov     byte ptr <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">2</span><span class="token operator">]</span>, <span class="token string">'l'</span>
mov     byte ptr <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">3</span><span class="token operator">]</span>, <span class="token string">'l'</span>
mov     byte ptr <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token string">'o'</span>
mov     byte ptr <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">5</span><span class="token operator">]</span>, <span class="token string">' '</span>
mov     byte ptr <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">6</span><span class="token operator">]</span>, <span class="token string">'w'</span>
mov     byte ptr <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">7</span><span class="token operator">]</span>, <span class="token string">'o'</span>
mov     byte ptr <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span>, <span class="token string">'r'</span>
mov     byte ptr <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">9</span><span class="token operator">]</span>, <span class="token string">'l'</span>
mov     byte ptr <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">10</span><span class="token operator">]</span>, <span class="token string">'d'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ›´å¤æ‚çš„æ„é€ æ–¹æ³•</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">mov     <span class="token register variable">ebx</span>, offset username
cmp     byte ptr <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">]</span>, <span class="token string">'j'</span>
jnz     fail
cmp     byte ptr <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">]</span>, <span class="token string">'o'</span>
jnz     fail
cmp     byte ptr <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">2</span><span class="token operator">]</span>, <span class="token string">'h'</span>
jnz     fail
cmp     byte ptr <span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">+</span><span class="token number">3</span><span class="token operator">]</span>, <span class="token string">'n'</span>
jnz     fail
jz      it_is_john<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æˆ‘ä»¬ç”¨åå…­è¿›åˆ¶çš„æ–‡æœ¬ç¼–è¯‘å™¨éƒ½ä¸èƒ½ç›´æ¥æœç´¢åˆ°å­—ç¬¦ä¸²åŸæ–‡ã€‚</p>
<p>å®é™…ä¸Šè¿™ä¸¤ç§æ–¹æ³•é€‚ç”¨äºé‚£äº›æ— æ³•åˆ©ç”¨æ•°æ®æ®µæ„é€ æ•°æ®çš„æƒ…æ™¯ã€‚å› ä¸ºå®ƒä»¬å¯ä»¥åœ¨æ–‡æœ¬æ®µç›´æ¥æ„é€ æ•°æ®ï¼Œæ‰€ä»¥ä¹Ÿå¸¸è§äºå„ç§PICå’Œshellcodeã€‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">sprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"%s%c%s%c%s"</span><span class="token punctuation">,</span> <span class="token string">"hel"</span><span class="token punctuation">,</span><span class="token char">'l'</span><span class="token punctuation">,</span><span class="token string">"o w"</span><span class="token punctuation">,</span><span class="token char">'o'</span><span class="token punctuation">,</span><span class="token string">"rld"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><mark>åŠ å¯†å­˜å‚¨å­—ç¬¦ä¸²æ˜¯å¦ä¸€ç§å¸¸è§çš„å¤„ç†æ–¹æ³•ã€‚åªæ˜¯è¿™æ ·ä¸€æ¥ï¼Œå°±è¦åœ¨æ¯æ¬¡ä½¿ç”¨å‰å¯¹å­—ç¬¦ä¸²è§£å¯†ã€‚è¿™ä¸ªå…¶å®æ˜¯ä¸»æµçš„å¤„ç†æ–¹æ³•</mark></p>
</li>
</ul>
<h4 id="å¯æ‰§è¡Œä»£ç "><a class="markdownIt-Anchor" href="#å¯æ‰§è¡Œä»£ç "></a> å¯æ‰§è¡Œä»£ç </h4>
<h5 id="æ’å…¥åƒåœ¾ä»£ç "><a class="markdownIt-Anchor" href="#æ’å…¥åƒåœ¾ä»£ç "></a> æ’å…¥åƒåœ¾ä»£ç </h5>
<p>åœ¨æ­£å¸¸æ‰§è¡ŒæŒ‡ä»¤åºåˆ—ä¸­æ’å…¥ä¸€äº›è™½ç„¶å¯è¢«æ‰§è¡Œä½†æ˜¯æ²¡æœ‰ä»»ä½•ä½œç”¨çš„æŒ‡ä»¤ï¼Œæœ¬èº«å°±æ˜¯ä¸€ç§ä»£ç æ··æ·†æŠ€æœ¯ã€‚</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">add     <span class="token register variable">eax</span>, <span class="token register variable">ebx</span>
mul     <span class="token register variable">ecx</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>é‡‡ç”¨æ··æ·†æŠ€æœ¯åçš„ä»£ç </p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">xor     <span class="token register variable">esi</span>, <span class="token number">011223344h</span> <span class="token comment">; garbage/?</span>
add     <span class="token register variable">esi</span>, <span class="token register variable">eax</span>        <span class="token comment">; garbage/?</span>
add     <span class="token register variable">eax</span>, <span class="token register variable">ebx</span>
mov     <span class="token register variable">edx</span>, <span class="token register variable">eax</span>        <span class="token comment">; garbage</span>
shl     <span class="token register variable">edx</span>, <span class="token number">4</span>          <span class="token comment">; garbage</span>
mul     <span class="token register variable">ecx</span>
xor     <span class="token register variable">esi</span>, <span class="token register variable">ecx</span>        <span class="token comment">; garbage</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨ç¨‹åºä»£ç ä¸­æ’å…¥çš„æ··æ·†æŒ‡ä»¤ï¼Œè°ƒç”¨äº†æºç¨‹åºä¸ä¼šä½¿ç”¨çš„ESIå’ŒEDXå¯„å­˜å™¨ã€‚æ··æ·†ä»£ç åˆ©ç”¨äº†æºç¨‹åºçš„ä¸­é—´ä¹‹åï¼Œå¤§å¹…åº¦åœ°å¢åŠ äº†åç¼–è¯‘çš„éš¾åº¦ï¼Œä½•ä¹ä¸ä¸ºå‘¢ï¼Ÿ(ä¼šå¯¼è‡´ç¨‹åºè¿è¡Œæ•ˆç‡ä¸‹é™ï¼Œä¹Ÿæ˜¯æœ‰ä»£ä»·çš„ )</p>
<h5 id="ç”¨å¤šä¸ªæŒ‡ä»¤ç»„åˆä»£æ›¿åŸæ¥çš„ä¸€ä¸ªæŒ‡ä»¤"><a class="markdownIt-Anchor" href="#ç”¨å¤šä¸ªæŒ‡ä»¤ç»„åˆä»£æ›¿åŸæ¥çš„ä¸€ä¸ªæŒ‡ä»¤"></a> ç”¨å¤šä¸ªæŒ‡ä»¤ç»„åˆä»£æ›¿åŸæ¥çš„ä¸€ä¸ªæŒ‡ä»¤</h5>
<ul>
<li>
<p><code>MOV op1,op2</code>è¿™ä¸ªæŒ‡ä»¤ï¼Œå¯ä»¥ä½¿ç”¨ç»„åˆæŒ‡ä»¤ä»£æ›¿<code>PUSH op2,POP op1</code></p>
</li>
<li>
<p><code>JMP label</code>æŒ‡ä»¤å¯ä»¥ç”¨<code>PUSH LABEL,RET</code>ä»£æ›¿</p>
</li>
<li>
<p><code>CALL label</code>å¯ä»¥ç”¨ä¸‰ä¸ªæŒ‡ä»¤ä»£æ›¿:<code>PUSH (call æŒ‡ä»¤åé¢çš„é‚£ä¸ªlabel),PUSH labelå’ŒRETæŒ‡ä»¤</code></p>
</li>
<li>
<p><code>PUSH op</code>å¯ä»¥ç”¨ä¸€ä¸‹çš„æŒ‡ä»¤ä»£æ›¿ã€‚<code>SUB ESP,4æˆ–8;MOV [ESP],æ“ä½œç¬¦</code></p>
</li>
</ul>
<h5 id="å§‹ç»ˆæ‰§è¡Œæˆ–ä»æ¥ä¸ä¼šæ‰§è¡Œçš„ä»£ç "><a class="markdownIt-Anchor" href="#å§‹ç»ˆæ‰§è¡Œæˆ–ä»æ¥ä¸ä¼šæ‰§è¡Œçš„ä»£ç "></a> å§‹ç»ˆæ‰§è¡Œæˆ–ä»æ¥ä¸ä¼šæ‰§è¡Œçš„ä»£ç </h5>
<p>åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œå‡å®šæ­¤å¤„ESIçš„å€¼è‚¯å®šæ˜¯0ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åœ¨fake luggageå¤„æ’å…¥ä»»æ„é•¿åº¦å’Œå¤æ‚åº¦çš„æŒ‡ä»¤ï¼Œä»¥è¾¾åˆ°æ··æ·†çš„ç›®çš„ã€‚è¿™ç§æ··æ·†æŠ€æœ¯ç§°ä¸ºä¸é€æ˜è°“è¯ï¼ˆopaque predicateï¼‰ã€‚</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">mov     <span class="token register variable">esi</span>, <span class="token number">1</span>
...     <span class="token comment">; some code not touching ESI</span>
dec     <span class="token register variable">esi</span>
...     <span class="token comment">; some code not touching ESI</span>
cmp     <span class="token register variable">esi</span>, <span class="token number">0</span>
jz      real_code
<span class="token comment">; fake luggage</span>
<span class="token label function">real_code:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>æˆ‘ä»¬è¿˜å¯ä»¥çœ‹çœ‹å…¶ä»–çš„ä¾‹å­,(æˆ‘ä»¬å‡å®šESIå§‹ç»ˆä¼šæ˜¯0)</li>
</ul>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">dd     <span class="token register variable">eax</span>, <span class="token register variable">ebx</span>     <span class="token comment">; real code</span>
mul     <span class="token register variable">ecx</span>          <span class="token comment">; real code</span>
add     <span class="token register variable">eax</span>, <span class="token register variable">esi</span>     <span class="token comment">; opaque predicate. XOR, AND or SHL, etc, can be here instead of ADD.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h5 id="æ‰“ä¹±æŒ‡ä»¤åºåˆ—"><a class="markdownIt-Anchor" href="#æ‰“ä¹±æŒ‡ä»¤åºåˆ—"></a> æ‰“ä¹±æŒ‡ä»¤åºåˆ—</h5>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">instruction <span class="token number">1</span>
instruction <span class="token number">2</span>
instruction <span class="token number">3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>ä¸Šè¿°ä¸‰è¡Œæ­£å¸¸æ‰§è¡Œçš„æŒ‡ä»¤åºåˆ—å¯ä»¥ç”¨å¦‚ä¸‹æ‰€ç¤ºçš„å¤æ‚ç»“æ„ä»£æ›¿:</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token label function">begin:</span>          jmp      ins1_label

<span class="token label function">ins2_label:</span>     instruction <span class="token number">2</span>
                jmp      ins3_label

<span class="token label function">ins3_label:</span>     instruction <span class="token number">3</span>
                jmp      exit:

<span class="token label function">ins1_label:</span>     instruction <span class="token number">1</span>
                jmp      ins2_label
<span class="token label function">exit:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="ä½¿ç”¨é—´æ¥æŒ‡é’ˆ"><a class="markdownIt-Anchor" href="#ä½¿ç”¨é—´æ¥æŒ‡é’ˆ"></a> ä½¿ç”¨é—´æ¥æŒ‡é’ˆ</h5>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">dummy_data1     db       <span class="token number">100h</span> dup (<span class="token number">0</span>)
message1        db       <span class="token string">'hello world'</span>,<span class="token number">0</span>

dummy_data2     db       <span class="token number">200h</span> dup (<span class="token number">0</span>)
message2        db       <span class="token string">'another message'</span>,<span class="token number">0</span>

func            proc
                ...
                mov      <span class="token register variable">eax</span>, offset dummy_data1 <span class="token comment">; PE or ELF reloc here</span>
                add      <span class="token register variable">eax</span>, <span class="token number">100h</span>
                push     <span class="token register variable">eax</span>
                call     dump_string
                ...
                mov      <span class="token register variable">eax</span>, offset dummy_data2 <span class="token comment">; PE or ELF reloc here</span>
                add      <span class="token register variable">eax</span>, <span class="token number">200h</span>
                push     <span class="token register variable">eax</span>
                call     dump_string
                ...
func            endp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™æ ·æˆ‘ä»¬åªèƒ½åœ¨<code>IDA</code>ç¼–è¯‘å·¥å…·ä¸­çœ‹åˆ°<code>dummy_data1</code>å’Œ<code>dummy_data2</code>çš„<code>reference(è°ƒç”¨ä¿¡æ¯)</code>ã€‚å®ƒä¸èƒ½æ­£å¸¸æ˜¾ç¤ºè°ƒç”¨çš„çœŸå®å­—ç¬¦ä¸²</p>
<p>å…¨å±€å˜é‡æˆ–è€…å‡½æ•°ä¹Ÿå¯ä»¥è¿™æ ·æ··æ·†ã€‚</p>
<h4 id="è™šæ‹Ÿæœºä»¥åŠä¼ªä»£ç "><a class="markdownIt-Anchor" href="#è™šæ‹Ÿæœºä»¥åŠä¼ªä»£ç "></a> è™šæ‹Ÿæœºä»¥åŠä¼ªä»£ç </h4>
<p>ç¼–ç¨‹äººå‘˜å¯ä»¥æ„å»ºå…¶è‡ªèº«çš„PLæˆ–è€…ISAè§£é‡Šå™¨ï¼ˆç±»ä¼¼VB.NETæˆ–è€…Javaï¼‰ã€‚è¿™æ ·çš„è¯ï¼Œåç¼–è¯‘è€…å°±å¾—èŠ±å¾ˆå¤šæ—¶é—´æ¥ç†è§£è¿™äº›è§£é‡Šå™¨æŒ‡ä»¤çš„æ„ä¹‰ä»¥åŠç»†èŠ‚ã€‚å½“ç„¶ï¼Œä»–ä»¬åŸºæœ¬ä¸Šå¿…é¡»å¼€å‘ä¸€ç§ä¸“ç”¨çš„åæ±‡ç¼–æˆ–è€…åç¼–è¯‘å·¥å…·äº†ã€‚</p>
<h3 id="chap51-c"><a class="markdownIt-Anchor" href="#chap51-c"></a> Chap51* C++</h3>
<h4 id="ç±»"><a class="markdownIt-Anchor" href="#ç±»"></a> ç±»</h4>
<h5 id="ä¸€ä¸ªç®€å•çš„ä¾‹å­"><a class="markdownIt-Anchor" href="#ä¸€ä¸ªç®€å•çš„ä¾‹å­"></a> ä¸€ä¸ªç®€å•çš„ä¾‹å­</h5>
<p><mark>ä»æ±‡ç¼–å±‚é¢çœ‹ï¼ŒC++ç±»ï¼ˆclassï¼‰çš„ç»„ç»‡æ–¹å¼å’Œç»“æ„ä½“æ•°æ®å®Œå…¨ä¸€è‡´ã€‚</mark></p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">class</span> <span class="token class-name">c</span>
<span class="token punctuation">&#123;</span>
<span class="token keyword">private</span><span class="token operator">:</span>
     <span class="token keyword">int</span> v1<span class="token punctuation">;</span>
     <span class="token keyword">int</span> v2<span class="token punctuation">;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
     <span class="token function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// default ctor</span>
     <span class="token punctuation">&#123;</span>
          v1<span class="token operator">=</span><span class="token number">667</span><span class="token punctuation">;</span>
          v2<span class="token operator">=</span><span class="token number">999</span><span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

     <span class="token function">c</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token comment">// ctor</span>
     <span class="token punctuation">&#123;</span>
          v1<span class="token operator">=</span>a<span class="token punctuation">;</span>
          v2<span class="token operator">=</span>b<span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

     <span class="token keyword">void</span> <span class="token function">dump</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
     <span class="token punctuation">&#123;</span>
          <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"%d; %d\n"</span><span class="token punctuation">,</span> v1<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
     <span class="token keyword">class</span> <span class="token class-name">c</span> c1<span class="token punctuation">;</span>
     <span class="token keyword">class</span> <span class="token class-name">c</span> <span class="token function">c2</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

     c1<span class="token punctuation">.</span><span class="token function">dump</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     c2<span class="token punctuation">.</span><span class="token function">dump</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr />
<p><code>msvs x86</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_c2<span class="token operator">$</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">16</span> <span class="token comment">; size = 8</span>
_c1<span class="token operator">$</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">8</span> <span class="token comment">; size = 8</span>
_main PROC
     push  <span class="token register variable">ebp</span>
     mov   <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
     sub   <span class="token register variable">esp</span>, <span class="token number">16</span>
     lea   <span class="token register variable">ecx</span>, DWORD PTR _c1<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
     call  ??0c@@QAE@XZ <span class="token comment">; c::c</span>
     push  <span class="token number">6</span>
     push  <span class="token number">5</span>
     lea   <span class="token register variable">ecx</span>, DWORD PTR _c2<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
     call  ??0c@@QAE@HH@Z <span class="token comment">; c::c</span>
     lea   <span class="token register variable">ecx</span>, DWORD PTR _c1<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
     call  ?dump@c@@QAEXXZ <span class="token comment">; c::dump</span>
     lea   <span class="token register variable">ecx</span>, DWORD PTR _c2<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
     call  ?dump@c@@QAEXXZ <span class="token comment">; c::dump</span>
     xor   <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
     mov   <span class="token register variable">esp</span>, <span class="token register variable">ebp</span>
     pop   <span class="token register variable">ebp</span>
     ret   <span class="token number">0</span>
_main ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>é¦–å…ˆï¼Œç¨‹åºä¸ºæ¯ä¸ªå¯¹è±¡åˆ†é…äº†8ä¸ªå­—èŠ‚å†…å­˜ï¼Œæ­£å¥½èƒ½å­˜å‚¨2ä¸ªå˜é‡</li>
<li>åœ¨åˆå§‹åŒ–c1æ—¶ï¼Œç¼–è¯‘å™¨è°ƒç”¨äº†æ— å‚æ„é€ å‡½æ•°<code>??0c@@QAE@XZ</code></li>
<li>åœ¨åˆå§‹åŒ–c2æ—¶ï¼Œç¼–è¯‘å™¨è°ƒç”¨äº†æ— å‚æ„é€ å‡½æ•°<code>??0c@@QAE@HH@Z</code>,å¹¶ä¸”ä¼ é€’äº†2ä¸ªå‚æ•°</li>
<li>åœ¨ä¼ é€’æ•´ä¸ªç±»å¯¹è±¡çš„æŒ‡é’ˆæ—¶ï¼Œ<code>this</code>æŒ‡é’ˆé€šè¿‡<code>ecx</code>å¯„å­˜å™¨ä¼ é€’ç»™è¢«è°ƒç”¨æ–¹å‡½æ•°ã€‚è¿™ç§è°ƒç”¨è§„èŒƒåº”å½“ç¬¦åˆ<code>thiscall</code>è§„èŒƒ</li>
<li><code>MSVS</code>é€šè¿‡<code>ECX</code>å¯„å­˜å™¨ä¼ é€’<code>this</code>æŒ‡é’ˆã€‚ä¸è¿‡ï¼Œè¿™ç§è°ƒç”¨çº¦å®šå¹¶æ²¡æœ‰ç»Ÿä¸€çš„æŠ€æœ¯è§„èŒƒã€‚GCCç¼–è¯‘å™¨ä»¥ä¼ é€’ç¬¬ä¸€ä¸ªå‡½æ•°çš„å‚æ•°çš„æ–¹å¼ä¼ é€’thisæŒ‡é’ˆï¼Œå…¶ä»–çš„ç¼–è¯‘å™¨å¤šæ•°éƒ½éµå¾ªäº†GCCçš„<code>thiscall</code>è§„èŒƒã€‚</li>
<li>è¿™äº›å‡½æ•°ä¸ºä»€ä¹ˆæœ‰å¾ˆå¥‡æ€ªçš„åå­—ï¼Œè¿™å®é™…ä¸Šæ˜¯ç¼–è¯‘å™¨å¯¹å‡½æ•°åç§°è¿›è¡Œçš„åç§°æ”¹å˜</li>
<li>C++çš„ç±»å¯èƒ½åŒ…å«åŒåçš„ä½†æ˜¯å‚æ•°ä¸åŒçš„æ–¹æ³•(ç±»æˆå‘˜å‡½æ•°)ã€‚è¿™å°±æ˜¯æ‰€è°“çš„å¤šæ€æ€§ã€‚å½“ç„¶ä¸åŒçš„ç±»å¯ä»¥æœ‰é‡åå´ä¸åŒçš„æ–¹æ³•</li>
<li>åç§°æ”¹ç¼–æ˜¯ä¸€ç§åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œç”¨<code>ASCII</code>å­—ç¬¦ä¸²å°†å‡½æ•°ï¼Œå˜é‡çš„åç§°é‡æ–°æ”¹ç¼–çš„æœºåˆ¶ã€‚æ”¹ç¼–åçš„æ–¹æ³•ï¼ˆç±»æˆå‘˜å‡½æ•°ï¼‰åç§°å°±è¢«ç”¨ä½œè¯¥ç¨‹åºå†…éƒ¨çš„å‡½æ•°åã€‚è¿™å®Œå…¨æ˜¯å› ä¸ºç¼–è¯‘å™¨çš„Linkerå’ŒåŠ è½½DLLçš„OSè£…è½½å™¨å‡ä¸èƒ½è¯†åˆ«C++æˆ–OOPï¼ˆé¢å‘å¯¹è±¡çš„ç¼–ç¨‹è¯­è¨€ï¼‰çš„æ•°æ®ç»“æ„ã€‚</li>
<li>å‡½æ•°dump()è°ƒç”¨äº†ä¸¤æ¬¡ã€‚æˆ‘ä»¬å†æ¥çœ‹çœ‹æ„é€ å‡½æ•°çš„æŒ‡ä»¤ä»£ç ã€‚</li>
</ul>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_this<span class="token operator">$</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">4</span>       <span class="token comment">; size = 4</span>
??0c@@QAE@XZ PROC <span class="token comment">; c::c, COMDAT</span>
<span class="token comment">; _this$ = ecx</span>
     push <span class="token register variable">ebp</span>
     mov  <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
     push <span class="token register variable">ecx</span>
     mov  DWORD PTR _this<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token register variable">ecx</span>
     mov  <span class="token register variable">eax</span>, DWORD PTR _this<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
     mov  DWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span>, <span class="token number">667</span>
     mov  <span class="token register variable">ecx</span>, DWORD PTR _this<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
     mov  DWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token number">999</span>
     mov  <span class="token register variable">eax</span>, DWORD PTR _this<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
     mov  <span class="token register variable">esp</span>, <span class="token register variable">ebp</span>
     pop  <span class="token register variable">ebp</span>
     ret  <span class="token number">0</span>
??0c@@QAE@XZ ENDP <span class="token comment">; c::c</span>

_this<span class="token operator">$</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">4</span> <span class="token comment">; size = 4</span>
_a<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>     <span class="token comment">; size = 4</span>
_b<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">12</span>    <span class="token comment">; size = 4</span>
??0c@@QAE@HH@Z PROC <span class="token comment">; c::c, COMDAT</span>
<span class="token comment">; _this$ = ecx</span>
     push <span class="token register variable">ebp</span>
     mov  <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
     push <span class="token register variable">ecx</span>
     mov  DWORD PTR _this<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token register variable">ecx</span>
     mov  <span class="token register variable">eax</span>, DWORD PTR _this<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
     mov  <span class="token register variable">ecx</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
     mov  DWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span>, <span class="token register variable">ecx</span>
     mov  <span class="token register variable">edx</span>, DWORD PTR _this<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
     mov  <span class="token register variable">eax</span>, DWORD PTR _b<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
     mov  DWORD PTR <span class="token operator">[</span><span class="token register variable">edx</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">eax</span>
     mov  <span class="token register variable">eax</span>, DWORD PTR _this<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
     mov  <span class="token register variable">esp</span>, <span class="token register variable">ebp</span>
     pop  <span class="token register variable">ebp</span>
     ret  <span class="token number">8</span>
??0c@@QAE@HH@Z ENDP <span class="token comment">; c::c</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>æ„é€ å‡½æ•°æœ¬èº«å°±æ˜¯ä¸€ç§å‡½æ•°ï¼Œä»–ä»¬ä½¿ç”¨<code>ECX</code>å­˜å‚¨ç»“æ„ä½“æŒ‡é’ˆ,ç„¶åå°†æŒ‡é’ˆèµ‹å€¼åˆ°å…¶è‡ªå·±çš„å±€éƒ¨å˜é‡é‡Œï¼Œç¬¬äºŒæ­¥å¹¶ä¸æ˜¯å¿…é¡»çš„</li>
<li>æ„é€ å‡½æ•°ä¸å¿…è¿”å›è¿”å›å€¼ã€‚äº‹å®ä¸Šï¼Œä»æŒ‡ä»¤å±‚é¢æ¥æ¥çœ‹ï¼Œæ„é€ å‡½æ•°çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªæ–°å»ºç«‹çš„å¯¹è±¡çš„æŒ‡é’ˆï¼Œå³thisæŒ‡é’ˆã€‚</li>
</ul>
<hr />
<p>å†çœ‹çœ‹<code>dump()</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_this<span class="token operator">$</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">4</span>           <span class="token comment">; size = 4</span>
?dump@c@@QAEXXZ PROC  <span class="token comment">; c::dump, COMDAT</span>
<span class="token comment">; _this$ = ecx</span>
     push <span class="token register variable">ebp</span>
     mov  <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
     push <span class="token register variable">ecx</span>
     mov  DWORD PTR _this<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>, <span class="token register variable">ecx</span>
     mov  <span class="token register variable">eax</span>, DWORD PTR _this<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
     mov  <span class="token register variable">ecx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>
     push <span class="token register variable">ecx</span>
     mov  <span class="token register variable">edx</span>, DWORD PTR _this<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">]</span>
     mov  <span class="token register variable">eax</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">edx</span><span class="token operator">]</span>
     push <span class="token register variable">eax</span>
     push OFFSET ??_C@_07NJBDCIEC@?<span class="token operator">$</span>CFd?<span class="token operator">$</span><span class="token register variable">DL</span>?<span class="token number">5</span>?<span class="token operator">$</span>CFd?<span class="token number">6</span>?<span class="token operator">$</span>AA@
     call _printf
     add  <span class="token register variable">esp</span>, <span class="token number">12</span>
     mov  <span class="token register variable">esp</span>, <span class="token register variable">ebp</span>
     pop  <span class="token register variable">ebp</span>
     ret  <span class="token number">0</span>
?dump@c@@QAEXXZ ENDP <span class="token comment">; c::dump</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>dump()</code>å‡½æ•°ä»<code>ECX</code>å¯„å­˜å™¨è¯»å–ä¸€ä¸ªæŒ‡å‘æ•°æ®ç»“æ„(è¿™ä¸ªç»“æ„ä½“å«æœ‰2ä¸ªintå‹æ•°æ®)çš„æŒ‡é’ˆï¼Œç„¶åå†æŠŠè¿™ä¸¤ä¸ªæ•´å‹æ•°æ®ä¼ é€’ç»™printf()å‡½æ•°ã€‚</p>
<hr />
<p><code>MSVS optimizing</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">??0c@@QAE@XZ PROC <span class="token comment">; c::c, COMDAT</span>
<span class="token comment">; _this$ = ecx</span>
     mov  <span class="token register variable">eax</span>, <span class="token register variable">ecx</span>
     mov  DWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span>, <span class="token number">667</span>
     mov  DWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token number">999</span>
     ret  <span class="token number">0</span>
??0c@@QAE@XZ ENDP <span class="token comment">; c::c</span>

_a<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>  <span class="token comment">; size = 4</span>
_b<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">12</span> <span class="token comment">; size = 4</span>
??0c@@QAE@HH@Z PROC <span class="token comment">; c::c, COMDAT</span>
<span class="token comment">; _this$ = ecx</span>
     mov  <span class="token register variable">edx</span>, DWORD PTR _b<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
     mov  <span class="token register variable">eax</span>, <span class="token register variable">ecx</span>
     mov  <span class="token register variable">ecx</span>, DWORD PTR _a<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
     mov  DWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span>, <span class="token register variable">ecx</span>
     mov  DWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">edx</span>
     ret  <span class="token number">8</span>
??0c@@QAE@HH@Z ENDP <span class="token comment">; c::c</span>

?dump@c@@QAEXXZ PROC <span class="token comment">; c::dump, COMDAT</span>
<span class="token comment">; _this$ = ecx</span>
     mov  <span class="token register variable">eax</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>
     mov  <span class="token register variable">ecx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">]</span>
     push <span class="token register variable">eax</span>
     push <span class="token register variable">ecx</span>
     push OFFSET ??_C@_07NJBDCIEC@?<span class="token operator">$</span>CFd?<span class="token operator">$</span><span class="token register variable">DL</span>?<span class="token number">5</span>?<span class="token operator">$</span>CFd?<span class="token number">6</span>?<span class="token operator">$</span>AA@
     call _printf
     add  <span class="token register variable">esp</span>, <span class="token number">12</span>
     ret  <span class="token number">0</span>
?dump@c@@QAEXXZ ENDP <span class="token comment">; c::dump</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p>åœ¨ä½¿ç”¨æ„é€ å‡½æ•°ä¹‹åï¼Œæ ˆæŒ‡é’ˆä¸æ˜¯é€šè¿‡<code>add espï¼Œx</code>æŒ‡ä»¤åˆ°æ¢å¤å…¶åˆå§‹çŠ¶æ€çš„ã€‚å¦ä¸€æ–¹é¢ï¼Œæ„é€ å‡½æ•°çš„æœ€åä¸€æ¡æŒ‡ä»¤æ˜¯æŒ‡ä»¤<code>ret 8</code>è€Œä¸æ˜¯<code>ret</code>,</p>
<p><code>ret 8</code>ç›¸å½“äº<code>add espï¼Œ8ä¸ret</code>ç»„åˆ</p>
</li>
<li>
<p>æ­¤å¤„ä¸ä»…éµå¾ªäº†thiscallè°ƒç”¨è§„èŒƒï¼ˆå‚è§51.1.1èŠ‚ï¼‰ï¼Œè€Œä¸”è¿˜åŒæ—¶éµå¾ªstdcallè°ƒç”¨è§„èŒƒï¼ˆ64.2èŠ‚ï¼‰ã€‚Stdcallè§„èŒƒçº¦å®šï¼šåº”å½“ç”±è¢«è°ƒç”¨æ–¹å‡½æ•°ï¼ˆè€Œä¸æ˜¯ç”±è°ƒç”¨æ–¹å‡½æ•°ï¼‰æ¢å¤å‚æ•°æ ˆçš„åˆå§‹çŠ¶æ€ã€‚æ„é€ å‡½æ•°ï¼ˆä¹Ÿæ˜¯æœ¬ä¾‹ä¸­çš„è¢«è°ƒç”¨æ–¹å‡½æ•°ï¼‰ä½¿ç”¨â€œadd ESPï¼Œxâ€çš„æŒ‡ä»¤æŠŠæœ¬åœ°æ ˆé‡Šæ”¾xå­—èŠ‚ï¼Œç„¶åæŠŠç¨‹åºæ§åˆ¶æƒä¼ é€’ç»™è°ƒç”¨æ–¹å‡½æ•°ã€‚</p>
</li>
</ul>
<hr />
<p><code>x86-64</code></p>
<p>åœ¨<code>x86-64</code>ç¯å¢ƒé‡Œçš„64ä½åº”ç”¨ç¨‹åºä½¿ç”¨<code>RCX</code>ï¼Œ<code>RDX</code>,<code>R8</code>ä»¥åŠ<code>R9</code>è¿™4ä¸ªå¯„å­˜å™¨ä¼ é€’å‡½æ•°çš„å‰4æƒ³å‚æ•°ï¼Œå…¶ä»–å‚æ•°ç”¨æ ˆå¤„ç†ã€‚</p>
<p>è°ƒç”¨é‚£äº›æ¶‰åŠç±»æˆå‘˜å‡½æ•°çš„æ—¶å€™ï¼Œ==ç¼–è¯‘å™¨ä¼šé€šè¿‡RCXå¯„å­˜å™¨ä¼ é€’ç±»å¯¹è±¡çš„thisæŒ‡é’ˆï¼Œç”¨RDXå¯„å­˜å™¨ä¼ é€’å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œä¾æ­¤ç±»æ¨ã€‚==æˆ‘ä»¬å¯ä»¥åœ¨ç±»æˆå‘˜å‡½æ•°c(int a,int b)ä¸­çœ‹åˆ°è¿™ä¸€ç‚¹ã€‚</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token comment">; void dump()</span>

?dump@c@@QEAAXXZ PROC <span class="token comment">; c::dump</span>
     mov   <span class="token register variable">r8d</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">rcx</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>
     mov   <span class="token register variable">edx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">rcx</span><span class="token operator">]</span>
     lea   <span class="token register variable">rcx</span>, OFFSET FLAT:??_C@_07NJBDCIEC@?<span class="token operator">$</span>CFd?<span class="token operator">$</span><span class="token register variable">DL</span>?<span class="token number">5</span>?<span class="token operator">$</span>CFd?<span class="token number">6</span>?<span class="token operator">$</span>AA@ <span class="token comment">; '%d; %d'</span>
     jmp   printf
?dump@c@@QEAAXXZ ENDP <span class="token comment">; c::dump</span>

<span class="token comment">; c(int a, int b)</span>

??0c@@QEAA@HH@Z PROC <span class="token comment">; c::c</span>
     mov   DWORD PTR <span class="token operator">[</span><span class="token register variable">rcx</span><span class="token operator">]</span>, <span class="token register variable">edx</span> <span class="token comment">; 1st argument: a</span>
     mov   DWORD PTR <span class="token operator">[</span><span class="token register variable">rcx</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">r8d</span> <span class="token comment">; 2nd argument: b</span>
     mov   <span class="token register variable">rax</span>, <span class="token register variable">rcx</span>
     ret   <span class="token number">0</span>
??0c@@QEAA@HH@Z ENDP <span class="token comment">; c::c</span>

<span class="token comment">; default ctor</span>

??0c@@QEAA@XZ PROC <span class="token comment">; c::c</span>
     mov   DWORD PTR <span class="token operator">[</span><span class="token register variable">rcx</span><span class="token operator">]</span>, <span class="token number">667</span>
     mov   DWORD PTR <span class="token operator">[</span><span class="token register variable">rcx</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token number">999</span>
     mov   <span class="token register variable">rax</span>, <span class="token register variable">rcx</span>
     ret   <span class="token number">0</span>
??0c@@QEAA@XZ ENDP <span class="token comment">; c::c</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>åœ¨x86-64ç¯å¢ƒä¸‹çš„<code>int</code>æ•°æ®ä»ç„¶æ˜¯32ä½æ•°æ®ã€‚å› æ­¤ï¼Œä¸Šè¿°ç¨‹åºä»ç„¶ä½¿ç”¨<code>32ä½å¯„å­˜å™¨</code>ä¼ é€’æ•´å‹æ•°æ®</li>
<li>ç±»æˆå‘˜å‡½æ•°dump()è¿˜ä½¿ç”¨äº†JMP printfæŒ‡ä»¤å–ä»£äº†CALLå’ŒRETæŒ‡ä»¤ã€‚</li>
</ul>
<hr />
<p><code>gcc x86</code></p>
<p>gcc4.4.1çš„ç¼–è¯‘æ–¹å¼å’ŒMSVS2012çš„ç¼–è¯‘æ‰‹æ®µå·®ä¸å¤š</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">     public main
main proc near

var_20 <span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">20h</span>
var_1C <span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">1Ch</span>
var_18 <span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">18h</span>
var_10 <span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">10h</span>
var_8  <span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">8</span>

    push <span class="token register variable">ebp</span>
    mov  <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
    and  <span class="token register variable">esp</span>, <span class="token number">0FFFFFFF0h</span>
    sub  <span class="token register variable">esp</span>, <span class="token number">20h</span>
    lea  <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">20h</span><span class="token operator">+</span>var_8<span class="token operator">]</span>
    mov  <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">20h</span><span class="token operator">+</span>var_20<span class="token operator">]</span>, <span class="token register variable">eax</span>
    call _ZN1cC1Ev
    mov  <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">20h</span><span class="token operator">+</span>var_18<span class="token operator">]</span>, <span class="token number">6</span>
    mov  <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">20h</span><span class="token operator">+</span>var_1C<span class="token operator">]</span>, <span class="token number">5</span>
    lea  <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">20h</span><span class="token operator">+</span>var_10<span class="token operator">]</span>
    mov  <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">20h</span><span class="token operator">+</span>var_20<span class="token operator">]</span>, <span class="token register variable">eax</span>
    call _ZN1cC1Eii
    lea  <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">20h</span><span class="token operator">+</span>var_8<span class="token operator">]</span>
    mov  <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">20h</span><span class="token operator">+</span>var_20<span class="token operator">]</span>, <span class="token register variable">eax</span>
    call _ZN1c4dumpEv
    lea  <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">20h</span><span class="token operator">+</span>var_10<span class="token operator">]</span>
    mov  <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">20h</span><span class="token operator">+</span>var_20<span class="token operator">]</span>, <span class="token register variable">eax</span>
    call _ZN1c4dumpEv
    mov  <span class="token register variable">eax</span>, <span class="token number">0</span>
    leave
    retn
main endp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>å¯ä»¥çœ‹åˆ°ï¼Œç±»æˆå‘˜å‡½æ•°çš„åç§°æ˜¯å¦ä¸€ç§é£æ ¼çš„æ”¹å˜,è¢«ç§°ä¸º<code>GNU</code>ä¸“ç”¨é£æ ¼</li>
<li><code>ç±»å¯¹è±¡çš„thisæŒ‡é’ˆ</code>æ˜¯ä»¥å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°çš„æ–¹å¼ä¼ é€’çš„</li>
</ul>
<hr />
<p>é¦–å…ˆæŸ¥çœ‹ç¬¬ä¸€ä¸ªæ„é€ å‡½æ•°</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">                public _ZN1cC1Ev <span class="token comment">; weak</span>
_ZN1cC1Ev       proc near                   <span class="token comment">; CODE XREF: main+10</span>

arg_0           <span class="token operator">=</span> dword ptr <span class="token number">8</span>

                push    <span class="token register variable">ebp</span>
                mov     <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
                mov     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>arg_0<span class="token operator">]</span>
                mov     dword ptr <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span>, <span class="token number">667</span>
                mov     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>arg_0<span class="token operator">]</span>
                mov     dword ptr <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token number">999</span>
                pop     <span class="token register variable">ebp</span>
                retn
_ZN1cC1Ev       endp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡å¤–éƒ¨ä¼ æ¥çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå³<code>eax</code>çš„å€¼è·å¾—äº†ç»“æ„æŒ‡é’ˆï¼Œç„¶ååœ¨ç›¸åº”åœ°å€ä¿®æ”¹äº†2ä¸ªæ•°å€¼</p>
<hr />
<p>ç¬¬äºŒä¸ªæ„é€ å‡½æ•°</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">               public _ZN1cC1Eii
_ZN1cC1Eii      proc near

arg_0           <span class="token operator">=</span> dword ptr <span class="token number">8</span>
arg_4           <span class="token operator">=</span> dword ptr <span class="token number">0Ch</span>
arg_8           <span class="token operator">=</span> dword ptr <span class="token number">10h</span>

                push    <span class="token register variable">ebp</span>
                mov     <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
                mov     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>arg_0<span class="token operator">]</span>
                mov     <span class="token register variable">edx</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>arg_4<span class="token operator">]</span>
                mov     <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span>, <span class="token register variable">edx</span>
                mov     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>arg_0<span class="token operator">]</span>
                mov     <span class="token register variable">edx</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>arg_8<span class="token operator">]</span>
                mov     <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">edx</span>
                pop     <span class="token register variable">ebp</span>
                retn
_ZN1cC1Eii      endp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸ç¬¬ä¸€ä¸ªæ„é€ å‡½æ•°ç±»ä¼¼ï¼ŒåŒºåˆ«åœ¨äºï¼Œèµ‹å€¼æ˜¯ä¼ é€’ç»™è¿™ä¸ªå‡½æ•°çš„å‚æ•°</p>
<hr />
<p>å†æ¥çœ‹çœ‹<code>dump()</code>å‡½æ•°</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">                public _ZN1c4dumpEv
_ZN1c4dumpEv    proc near

var_18          <span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">18h</span>
var_14          <span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">14h</span>
var_10          <span class="token operator">=</span> dword ptr <span class="token operator">-</span><span class="token number">10h</span>
arg_0           <span class="token operator">=</span> dword ptr <span class="token number">8</span>

                push    <span class="token register variable">ebp</span>
                mov     <span class="token register variable">ebp</span>, <span class="token register variable">esp</span>
                sub     <span class="token register variable">esp</span>, <span class="token number">18h</span>
                mov     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>arg_0<span class="token operator">]</span><span class="token comment">;eax=this</span>
                mov     <span class="token register variable">edx</span>, <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span><span class="token comment">;edx=this+1</span>
                mov     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>arg_0<span class="token operator">]</span>
                mov     <span class="token register variable">eax</span>, <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span>
                mov     <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">18h</span><span class="token operator">+</span>var_10<span class="token operator">]</span>, <span class="token register variable">edx</span>
                mov     <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">18h</span><span class="token operator">+</span>var_14<span class="token operator">]</span>, <span class="token register variable">eax</span>
                mov     <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">18h</span><span class="token operator">+</span>var_18<span class="token operator">]</span>, offset aDD <span class="token comment">; "%d; %d\n"</span>
                call    _printf
                leave
                retn
_ZN1c4dumpEv    endp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>æ²¡æœ‰ä½¿ç”¨æ ˆå°±å°†å‚æ•°ç›´æ¥ä¼ é€’ç»™äº†<code>printf</code>å‡½æ•°</li>
</ul>
<p><mark>ç»¼åˆæœ¬èŠ‚çš„å„ä¾‹å¯çŸ¥ï¼ŒMSVCå’ŒGCCçš„åŒºåˆ«åœ¨äºå‡½æ•°åçš„åç§°ç¼–ç é£æ ¼ä»¥åŠä¼ é€’thisæŒ‡é’ˆçš„å…·ä½“æ–¹å¼ ï¼ˆMSVCé€šè¿‡ECXä¼ é€’ï¼Œè€ŒGCCä»¥å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°çš„æ–¹å¼ä¼ é€’ï¼‰ã€‚</mark></p>
<hr />
<p><code>gcc-x86-64</code></p>
<p><mark>åœ¨ç¼–è¯‘64ä½åº”ç”¨ç¨‹åºçš„æ—¶å€™ï¼ŒGCCé€šè¿‡RDIã€RSIã€RDXã€RCXã€R8ä»¥åŠR9è¿™å‡ ä¸ªå¯„å­˜å™¨ä¼ é€’å‡½æ•°çš„å‰6ä¸ªå‚æ•°ã€‚å®ƒé€šè¿‡RDIå¯„å­˜å™¨ï¼Œä»¥ç¬¬ä¸€ä¸ªå‡½æ•°å‚æ•°çš„å½¢å¼ä¼ é€’thisæŒ‡é’ˆã€‚å¦å¤–ï¼Œæ•´æ•°å‹intæ•°æ®ä¾ç„¶æ˜¯32ä½æ•°æ®ã€‚å®ƒè¿˜ä¼šä¸æ—¶ä½¿ç”¨è½¬ç§»æŒ‡ä»¤JMPæ›¿ä»£RETæŒ‡ä»¤ã€‚</mark></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token comment">; default ctor</span>

<span class="token label function">_ZN1cC2Ev:</span>
    mov  DWORD PTR <span class="token operator">[</span><span class="token register variable">rdi</span><span class="token operator">]</span>, <span class="token number">667</span>
    mov  DWORD PTR <span class="token operator">[</span><span class="token register variable">rdi</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token number">999</span>
    ret

<span class="token comment">; c(int a, int b)</span>

<span class="token label function">_ZN1cC2Eii:</span>
    mov  DWORD PTR <span class="token operator">[</span><span class="token register variable">rdi</span><span class="token operator">]</span>, <span class="token register variable">esi</span>
    mov  DWORD PTR <span class="token operator">[</span><span class="token register variable">rdi</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">edx</span>
    ret

<span class="token comment">; dump()</span>

<span class="token label function">_ZN1c4dumpEv:</span>
    mov  <span class="token register variable">edx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">rdi</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>
    mov  <span class="token register variable">esi</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">rdi</span><span class="token operator">]</span>
    xor  <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
    mov  <span class="token register variable">edi</span>, OFFSET FLAT:.LC0 <span class="token comment">; "%d; %d\n"</span>
    jmp  printf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="ç±»ç»§æ‰¿"><a class="markdownIt-Anchor" href="#ç±»ç»§æ‰¿"></a> ç±»ç»§æ‰¿</h5>
<p>ç»§æ‰¿è€Œæ¥çš„ç±»ä¸å‰æ–‡çš„ç®€å•ç»“æ„ä½“ç±»ä¼¼ï¼Œä½†æ˜¯å¯ä»¥å¯¹çˆ¶ç±»è¿›è¡Œæ‹“å±•</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">class</span> <span class="token class-name">object</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token keyword">int</span> color<span class="token punctuation">;</span>
        <span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token function">object</span> <span class="token punctuation">(</span><span class="token keyword">int</span> color<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">this</span><span class="token operator">-></span>color<span class="token operator">=</span>color<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">print_color</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"color=%d\n"</span><span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">box</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">object</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token keyword">int</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> depth<span class="token punctuation">;</span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">box</span><span class="token punctuation">(</span><span class="token keyword">int</span> color<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> <span class="token keyword">int</span> depth<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token operator">-></span>color<span class="token operator">=</span>color<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token operator">-></span>width<span class="token operator">=</span>width<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token operator">-></span>height<span class="token operator">=</span>height<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token operator">-></span>depth<span class="token operator">=</span>depth<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">dump</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"this is box. color=%d, width=%d, height=%d, depth=%d\n"</span><span class="token punctuation">,</span> color<span class="token punctuation">,</span> width<span class="token punctuation">,</span> â†™
    â†˜ height<span class="token punctuation">,</span> depth<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">sphere</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">object</span></span>
<span class="token punctuation">&#123;</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">int</span> radius<span class="token punctuation">;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">sphere</span><span class="token punctuation">(</span><span class="token keyword">int</span> color<span class="token punctuation">,</span> <span class="token keyword">int</span> radius<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token operator">-></span>color<span class="token operator">=</span>color<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token operator">-></span>radius<span class="token operator">=</span>radius<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">dump</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"this is sphere. color=%d, radius=%d\n"</span><span class="token punctuation">,</span> color<span class="token punctuation">,</span> radius<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    box <span class="token function">b</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sphere <span class="token function">s</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    b<span class="token punctuation">.</span><span class="token function">print_color</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    s<span class="token punctuation">.</span><span class="token function">print_color</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    b<span class="token punctuation">.</span><span class="token function">dump</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    s<span class="token punctuation">.</span><span class="token function">dump</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>æˆ‘ä»¬å…±åŒå…³æ³¨<code>dump()</code>å‡½æ•°ä»¥åŠ<code>object::print_color()</code>çš„æŒ‡ä»¤ä»£ç ï¼Œé‡ç‚¹åˆ†æ32ä½ç¯å¢ƒä¸‹æœ‰å…³æ•°æ®ç±»å‹çš„å†…å­˜å­˜å‚¨æ ¼å±€</li>
</ul>
<hr />
<p><code>msvs 2008 /Ob0</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">??_C@_09GCEDOLPA@color?<span class="token operator">$</span>DN?<span class="token operator">$</span>CFd?<span class="token number">6</span>?<span class="token operator">$</span>AA@ DB <span class="token string">'color=%d'</span>, <span class="token number">0aH</span>, <span class="token number">00H</span> <span class="token comment">; `string'</span>
?print_color@object@@QAEXXZ PROC <span class="token comment">; object::print_color, COMDAT</span>
<span class="token comment">; _this$ = ecx</span>
    mov   <span class="token register variable">eax</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">]</span>
    push  <span class="token register variable">eax</span>

<span class="token comment">; 'color=%d', 0aH, 00H</span>
    push OFFSET ??_C@_09GCEDOLPA@color?<span class="token operator">$</span>DN?<span class="token operator">$</span>CFd?<span class="token number">6</span>?<span class="token operator">$</span>AA@
    call _printf
    add  <span class="token register variable">esp</span>, <span class="token number">8</span>
    ret  <span class="token number">0</span>
?print_color@object@@QAEXXZ ENDP <span class="token comment">; object::print_color</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">?dump@box@@QAEXXZ PROC <span class="token comment">; box::dump, COMDAT</span>
<span class="token comment">; _this$ = ecx</span>
    mov   <span class="token register variable">eax</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">12</span><span class="token operator">]</span>
    mov   <span class="token register variable">edx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span>
    push  <span class="token register variable">eax</span>
    mov   <span class="token register variable">eax</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>
    mov   <span class="token register variable">ecx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">]</span>
    push  <span class="token register variable">edx</span>
    push  <span class="token register variable">eax</span>
    push  <span class="token register variable">ecx</span>

<span class="token comment">; 'this is box. color=%d, width=%d, height=%d, depth=%d', 0aH, 00H ; `string'</span>
    push OFFSET ??_C@_0DG@NCNGAADL@this?5is?5box?<span class="token number">4</span>?5color?<span class="token operator">$</span>DN?<span class="token operator">$</span>CFd?<span class="token number">0</span>?5width?<span class="token operator">$</span>DN?<span class="token operator">$</span>CFd?<span class="token number">0</span>@
    call _printf
    add  <span class="token register variable">esp</span>, <span class="token number">20</span>
    ret  <span class="token number">0</span>
?dump@box@@QAEXXZ ENDP <span class="token comment">; box::dump</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">?dump@sphere@@QAEXXZ PROC <span class="token comment">; sphere::dump, COMDAT</span>
<span class="token comment">; _this$ = ecx</span>
    mov   <span class="token register variable">eax</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>
    mov   <span class="token register variable">ecx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">]</span>
    push  <span class="token register variable">eax</span>
    push  <span class="token register variable">ecx</span>

<span class="token comment">; 'this is sphere. color=%d, radius=%d', 0aH, 00H</span>
    push OFFSET ??_C@_0CF@EFEDJLDC@this?5is?5sphere?<span class="token number">4</span>?5color?<span class="token operator">$</span>DN?<span class="token operator">$</span>CFd?<span class="token number">0</span>?5radius@
    call _printf
    add  <span class="token register variable">esp</span>, <span class="token number">12</span>
    ret  <span class="token number">0</span>
?dump@sphere@@QAEXXZ ENDP <span class="token comment">; sphere::dump</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>æˆ‘ä»¬ä»ä¸Šè¿°æ±‡ç¼–å¯ä»¥çœ‹å‡ºå†…å­˜çš„åŸºæœ¬æ’åˆ—</li>
</ul>
<p>â‘  çˆ¶ç±»objectå¯¹è±¡çš„å­˜å‚¨æ ¼å±€å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<table>
<thead>
<tr>
<th>offset</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>+0x0</td>
<td>int color</td>
</tr>
</tbody>
</table>
<p>â‘¡ ç»§æ‰¿ç±»å¯¹è±¡ï¼šboxå’Œsphereï¼ˆåˆ†åˆ«ä¸ºç›’å­å’Œçƒä½“ï¼‰çš„å­˜å‚¨æ ¼å±€åˆ†åˆ«å¦‚ä¸‹é¢ä¸¤å¼ è¡¨æ‰€ç¤ºã€‚</p>
<p>box</p>
<table>
<thead>
<tr>
<th>offset</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>+0x0</td>
<td>int color</td>
</tr>
<tr>
<td>+0x4</td>
<td>int width</td>
</tr>
<tr>
<td>+0x8</td>
<td>int height</td>
</tr>
<tr>
<td>+0xC</td>
<td>int depth</td>
</tr>
</tbody>
</table>
<p>sphere</p>
<table>
<thead>
<tr>
<th>offset</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>+0x0</td>
<td>int color</td>
</tr>
<tr>
<td>+0x4</td>
<td>int radius</td>
</tr>
</tbody>
</table>
<hr />
<p>å†æ¥çœ‹çœ‹<code>main</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">PUBLIC _main
_TEXT SEGMENT
_s<span class="token operator">$</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">24</span> <span class="token comment">; size = 8</span>
_b<span class="token operator">$</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">16</span> <span class="token comment">; size = 16</span>
_main PROC
    sub   <span class="token register variable">esp</span>, <span class="token number">24</span>
    <span class="token comment">;box b(1,10,20,30)</span>
    push  <span class="token number">30</span>
    push  <span class="token number">20</span>
    push  <span class="token number">10</span>
    push  <span class="token number">1</span>
    lea   <span class="token register variable">ecx</span>, DWORD PTR _b<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">40</span><span class="token operator">]</span>
    call  ??0box@@QAE@HHHH@Z <span class="token comment">; box::box</span>
    <span class="token comment">;sphere s(2,40)</span>
    push  <span class="token number">40</span>
    push  <span class="token number">2</span>
    lea   <span class="token register variable">ecx</span>, DWORD PTR _s<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">32</span><span class="token operator">]</span>
    call  ??0sphere@@QAE@HH@Z <span class="token comment">; sphere::sphere;æ„é€ å‡½æ•°</span>
    lea   <span class="token register variable">ecx</span>, DWORD PTR _b<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">24</span><span class="token operator">]</span>
    call  ?print_color@object@@QAEXXZ <span class="token comment">; object::print_color</span>
    lea   <span class="token register variable">ecx</span>, DWORD PTR _s<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">24</span><span class="token operator">]</span>
    call  ?print_color@object@@QAEXXZ <span class="token comment">; object::print_color</span>
    lea   <span class="token register variable">ecx</span>, DWORD PTR _b<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">24</span><span class="token operator">]</span>
    call  ?dump@box@@QAEXXZ <span class="token comment">; box::dump</span>
    lea   <span class="token register variable">ecx</span>, DWORD PTR _s<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">24</span><span class="token operator">]</span>
    call  ?dump@sphere@@QAEXXZ <span class="token comment">; sphere::dump</span>
    xor   <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
    add   <span class="token register variable">esp</span>, <span class="token number">24</span>
    ret   <span class="token number">0</span>
_main ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><mark>ç»§æ‰¿ç±»å¿…é¡»åœ¨å…¶åŸºï¼ˆçˆ¶ï¼‰ç±»å­—æ®µçš„åé¢åŠ å…¥è‡ªå·±çš„å­—æ®µï¼Œå› æ­¤åŸºç±»å’Œç»§æ‰¿ç±»çš„ç±»æˆå‘˜å‡½æ•°å¯ä»¥å…±å­˜ã€‚</mark></li>
<li>å½“ç¨‹åºè°ƒç”¨ç±»æˆå‘˜å¯¹è±¡<code>object::print_color()</code>æ—¶ï¼ŒæŒ‡å‘å¯¹è±¡<code>box</code>å’Œ<code>sphere</code>çš„æŒ‡é’ˆæ˜¯é€šè¿‡<code>this</code>æŒ‡é’ˆä¼ é€’çš„ã€‚ç”±äºåœ¨æ‰€æœ‰ç»§æ‰¿ç±»å’ŒåŸºç±»ä¸­colorå­—æ®µçš„åç§»é‡å›ºå®šä¸º0(offset+0x0)ï¼Œæ‰€æœ‰ç±»å¯¹è±¡çš„ç±»æˆå‘˜å‡½æ•°<code>object::print_color</code>éƒ½å¯ä»¥æ­£å¸¸è¿è¡Œ</li>
<li>å› æ­¤ï¼Œæ— è®ºæ˜¯åŸºç±»è¿˜æ˜¯ç»§æ‰¿ç±»è°ƒç”¨object::print_color()ï¼Œåªè¦è¯¥æ–¹æ³•æ‰€å¼•ç”¨çš„å­—æ®µçš„ç›¸å¯¹åœ°å€å›ºå®šä¸å˜ï¼Œé‚£ä¹ˆè¯¥æ–¹æ³•å°±å¯ä»¥æ­£å¸¸è¿è¡Œã€‚</li>
<li>å‡å¦‚åŸºäºboxç±»åˆ›å»ºä¸€ä¸ªç»§æ‰¿ç±»ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨å°±ä¼šåœ¨<code>å˜é‡depthçš„åé¢è¿½åŠ æ‚¨æ‰€æ·»åŠ æ–°çš„å˜é‡</code>ï¼Œä»¥ç¡®ä¿åŸºç±»boxçš„å„å­—æ®µçš„ç›¸å¯¹åœ°å€åœ¨å…¶ç»§æ‰¿ç±»ä¸­å›ºå®šä¸å˜ã€‚</li>
<li>å½“çˆ¶ç±»ä¸ºboxç±»çš„å„ç»§æ‰¿ç±»åœ¨è°ƒç”¨å„è‡ªçš„æ–¹æ³•box::dump()æ—¶ï¼Œå®ƒä»¬éƒ½èƒ½æ£€ç´¢åˆ°colorã€widthã€heightä»¥åŠdepthså­—æ®µçš„æ­£ç¡®åœ°å€ã€‚å› ä¸ºå„å­—æ®µçš„ç›¸å¯¹åœ°å€ä¸ä¼šå‘ç”Ÿå˜åŒ–ã€‚</li>
</ul>
<hr />
<p>gccç”Ÿæˆçš„ä»£ç ä¸msvsç±»ä¼¼ï¼ŒåŒºåˆ«ä»ç„¶æ˜¯<code>gcc</code>ä¸ä¼šä½¿ç”¨<code>ecx</code>å¯„å­˜å™¨ä¼ é€’<code>this</code>æŒ‡é’ˆï¼Œè€Œæ˜¯ç”¨å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°çš„ä¼ é€’æ–¹å¼ä¼ é€’<code>this</code>æŒ‡é’ˆ</p>
<h5 id="å°è£…"><a class="markdownIt-Anchor" href="#å°è£…"></a> å°è£…</h5>
<p><mark>å°è£…ï¼ˆencapsulationï¼‰çš„ä½œç”¨æ˜¯ï¼šæŠŠæ—¢å®šçš„æ•°æ®å’Œæ–¹æ³•é™å®šä¸ºç±»çš„ç§æœ‰ä¿¡æ¯ï¼Œä½¿å¾—å…¶ä»–è°ƒç”¨æ–¹åªèƒ½è®¿é—®ç±»æ‰€å®šä¹‰çš„å…¬å…±æ–¹æ³•å’Œå…¬å…±æ•°æ®ã€ä¸èƒ½ç›´æ¥è®¿é—®è¢«å°è£…èµ·æ¥çš„ç§æœ‰å¯¹è±¡ã€‚</mark></p>
<p>ç„¶è€Œåœ¨æŒ‡ä»¤å±‚é¢ï¼Œåˆ°åº•æœ‰æ²¡æœ‰åˆ’åˆ†ç§æœ‰å¯¹è±¡å’Œå…¬å¼€å¯¹è±¡çš„ç•Œé™å‘¢ï¼Ÿ</p>
<p>å…¶å®å®Œå…¨æ²¡æœ‰ã€‚</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">class</span> <span class="token class-name">box</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token keyword">int</span> color<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> depth<span class="token punctuation">;</span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">box</span><span class="token punctuation">(</span><span class="token keyword">int</span> color<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> <span class="token keyword">int</span> depth<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token operator">-></span>color<span class="token operator">=</span>color<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token operator">-></span>width<span class="token operator">=</span>width<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token operator">-></span>height<span class="token operator">=</span>height<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token operator">-></span>depth<span class="token operator">=</span>depth<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">dump</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"this is box. color=%d, width=%d, height=%d, depth=%d\n"</span><span class="token punctuation">,</span> color<span class="token punctuation">,</span> width<span class="token punctuation">,</span>height<span class="token punctuation">,</span> depth<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>å¯ç”¨MSVC 2008çš„ä¼˜åŒ–é€‰é¡¹/Oxå’Œ/Ob0ç¼–è¯‘ä¸Šè¿°ç¨‹åºï¼Œå†æŸ¥çœ‹ç±»å‡½æ•°box::dump()çš„ä»£ç ã€‚</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">?dump@box@@QAEXXZ PROC <span class="token comment">; box::dump, COMDAT</span>
<span class="token comment">; _this$ = ecx</span>
    mov   <span class="token register variable">eax</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">12</span><span class="token operator">]</span>
    mov   <span class="token register variable">edx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span>
    push  <span class="token register variable">eax</span>
    mov   <span class="token register variable">eax</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>
    mov   <span class="token register variable">ecx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">]</span>
    push  <span class="token register variable">edx</span>
    push  <span class="token register variable">eax</span>
    push  <span class="token register variable">ecx</span>
<span class="token comment">; 'this is box. color=%d, width=%d, height=%d, depth=%d', 0aH, 00H</span>
    push OFFSET ??_C@_0DG@NCNGAADL@this?5is?5box?<span class="token number">4</span>?5color?<span class="token operator">$</span>DN?<span class="token operator">$</span>CFd?<span class="token number">0</span>?5width?<span class="token operator">$</span>DN?<span class="token operator">$</span>CFd?<span class="token number">0</span>@
    call _printf
    add  <span class="token register variable">esp</span>, <span class="token number">20</span>
    ret  <span class="token number">0</span>
?dump@box@@QAEXXZ ENDP <span class="token comment">; box::dump</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p>æ˜¾ç„¶å†…å­˜åˆ†å¸ƒä¸å…ˆå‰æ˜¯ç›¸åŒçš„</p>
<table>
<thead>
<tr>
<th>offset</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>+0x0</td>
<td>int color</td>
</tr>
<tr>
<td>+0x4</td>
<td>int width</td>
</tr>
<tr>
<td>+0x8</td>
<td>int height</td>
</tr>
<tr>
<td>+0xC</td>
<td>int depth</td>
</tr>
</tbody>
</table>
</li>
<li>
<p>æ‰€æœ‰å­—æ®µéƒ½æ˜¯æ— æ³•è¢«å…¶ä»–å‡½æ•°ç›´æ¥è®¿é—®çš„ç§æœ‰å˜é‡ï¼Œä½†æ˜¯æ—¢ç„¶æˆ‘ä»¬çŸ¥é“äº†è¿™ä¸ªå¯¹è±¡çš„å†…å­˜å­˜å‚¨æ ¼å±€ï¼Œæˆ‘ä»¬å…¶å®å¯ä»¥å†™ä¸€ä¸ªä¿®æ”¹è¿™äº›å˜é‡çš„ç¨‹åº</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">hack_oop_encapsulation</span><span class="token punctuation">(</span><span class="token keyword">class</span> <span class="token class-name">box</span> <span class="token operator">*</span> o<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    o<span class="token operator">-></span>width<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// that code cant be compiled':</span>
                <span class="token comment">// "error C2248: 'box::width' : cannot access private member declared in class 'box'"</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™æ ·å†™æ— æ³•è¢«æˆåŠŸç¼–è¯‘ï¼Œä½†äº‹å®ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥å°†<code>Box</code>æ•°æ®ç±»å‹è½¬æ¢ä¸ºæ•´å‹æ•°ç»„ï¼Œè¿›è€Œç¼–è¯‘å¹¶ä¸”ç›´æ¥ä¿®æ”¹ç›¸åº”å­—æ®µ</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">hack_oop_encapsulation</span><span class="token punctuation">(</span>class box <span class="token operator">*</span> o<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>ptr_to_object<span class="token operator">=</span>reinterpret_cast<span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ptr_to_object<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">123</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æœ€ç»ˆ</p>
<pre class="line-numbers language-none"><code class="language-none">this is box. color&#x3D;1, width&#x3D;10, height&#x3D;20, depth&#x3D;30
this is box. color&#x3D;1, width&#x3D;123, height&#x3D;20, depth&#x3D;30<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li>
<p><mark>å°è£…åªèƒ½å¤Ÿåœ¨ç¼–è¯‘é˜¶æ®µä¿æŠ¤ç±»çš„ç§æœ‰å¯¹è±¡ã€‚è™½ç„¶C++ç¼–è¯‘å™¨ç¦æ­¢å¤–éƒ¨ä»£ç ç›´æ¥è®¿é—®é‚£äº›è¢«æ˜ç¡®å±è”½çš„å†…éƒ¨å¯¹è±¡ï¼Œä½†æ˜¯é€šè¿‡é€‚å½“çš„hackæŠ€æœ¯ï¼Œæˆ‘ä»¬ç¡®å®èƒ½å¤Ÿçªç ´ç¼–è¯‘å™¨çš„é™åˆ¶ç­–ç•¥ã€‚</mark></p>
</li>
</ul>
<h5 id="å¤šé‡ç»§æ‰¿"><a class="markdownIt-Anchor" href="#å¤šé‡ç»§æ‰¿"></a> å¤šé‡ç»§æ‰¿</h5>
<p><mark>å¤šç±»ç»§æ‰¿-æŒ‡çš„æ˜¯ä¸€ä¸ªç±»å¯ä»¥åŒæ—¶ç»§æ‰¿å¤šä¸ªçˆ¶ç±»çš„å­—æ®µå’Œæ–¹æ³•</mark></p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">class</span> <span class="token class-name">box</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token keyword">int</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> depth<span class="token punctuation">;</span>
        <span class="token function">box</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token function">box</span><span class="token punctuation">(</span><span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> <span class="token keyword">int</span> depth<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token operator">-></span>width<span class="token operator">=</span>width<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token operator">-></span>height<span class="token operator">=</span>height<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token operator">-></span>depth<span class="token operator">=</span>depth<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">dump</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"this is box. width=%d, height=%d, depth=%d\n"</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> depth<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> <span class="token function">get_volume</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> width <span class="token operator">*</span> height <span class="token operator">*</span> depth<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">solid_object</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token keyword">int</span> density<span class="token punctuation">;</span>
        <span class="token function">solid_object</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token function">solid_object</span><span class="token punctuation">(</span><span class="token keyword">int</span> density<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token operator">-></span>density<span class="token operator">=</span>density<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> <span class="token function">get_density</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> density<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">dump</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"this is solid_object. density=%d\n"</span><span class="token punctuation">,</span> density<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">solid_box</span><span class="token operator">:</span> <span class="token base-clause"><span class="token class-name">box</span><span class="token punctuation">,</span> <span class="token class-name">solid_object</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">solid_box</span> <span class="token punctuation">(</span><span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> <span class="token keyword">int</span> depth<span class="token punctuation">,</span> <span class="token keyword">int</span> density<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token operator">-></span>width<span class="token operator">=</span>width<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token operator">-></span>height<span class="token operator">=</span>height<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token operator">-></span>depth<span class="token operator">=</span>depth<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token operator">-></span>density<span class="token operator">=</span>density<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">dump</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"this is solid_box. width=%d, height=%d, depth=%d, density=%d\n"</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span>â†™
â†˜ height<span class="token punctuation">,</span> depth<span class="token punctuation">,</span> density<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> <span class="token function">get_weight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token function">get_volume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">get_density</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    box <span class="token function">b</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    solid_object <span class="token function">so</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    solid_box <span class="token function">sb</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    b<span class="token punctuation">.</span><span class="token function">dump</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    so<span class="token punctuation">.</span><span class="token function">dump</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sb<span class="token punctuation">.</span><span class="token function">dump</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> sb<span class="token punctuation">.</span><span class="token function">get_weight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>box::dump(),solid_object::dump()ä»¥åŠsolid_box::dump()è¿™3ä¸ªç±»æˆå‘˜å‡½æ•°ã€‚</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">?dump@box@@QAEXXZ PROC <span class="token comment">; box::dump, COMDAT</span>
<span class="token comment">; _this$ = ecx</span>
    mov   <span class="token register variable">eax</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span>
    mov   <span class="token register variable">edx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>
    push  <span class="token register variable">eax</span>
    mov   <span class="token register variable">eax</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">]</span>
    push  <span class="token register variable">edx</span>
    push  <span class="token register variable">eax</span>
<span class="token comment">; 'this is box. width=%d, height=%d, depth=%d', 0aH, 00H</span>
    push  OFFSET ??_C@_0CM@DIKPHDFI@this?5is?5box?<span class="token number">4</span>?5width?<span class="token operator">$</span>DN?<span class="token operator">$</span>CFd?<span class="token number">0</span>?5height?<span class="token operator">$</span>DN?<span class="token operator">$</span>CFd@
    call  _printf
    add   <span class="token register variable">esp</span>, <span class="token number">16</span>
    ret   <span class="token number">0</span>
?dump@box@@QAEXXZ ENDP <span class="token comment">; box::dump</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">?dump@solid_object@@QAEXXZ PROC <span class="token comment">; solid_object::dump, COMDAT</span>
<span class="token comment">; _this$ = ecx</span>
    mov   <span class="token register variable">eax</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">]</span>
    push  <span class="token register variable">eax</span>
<span class="token comment">; 'this is solid_object. density=%d', 0aH</span>
    push  OFFSET ??_C@_0CC@KICFJINL@this?5is?5solid_object?<span class="token number">4</span>?5density?<span class="token operator">$</span>DN?<span class="token operator">$</span>CFd@
    call  _printf
    add   <span class="token register variable">esp</span>, <span class="token number">8</span>
    ret   <span class="token number">0</span>
?dump@solid_object@@QAEXXZ ENDP <span class="token comment">; solid_object::dump</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">?dump@solid_box@@QAEXXZ PROC <span class="token comment">; solid_box::dump, COMDAT</span>
<span class="token comment">; _this$ = ecx</span>
    mov   <span class="token register variable">eax</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">12</span><span class="token operator">]</span>
    mov   <span class="token register variable">edx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span>
    push  <span class="token register variable">eax</span>
    mov   <span class="token register variable">eax</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>
    mov   <span class="token register variable">ecx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">]</span>
    push  <span class="token register variable">edx</span>
    push  <span class="token register variable">eax</span>
    push  <span class="token register variable">ecx</span>
<span class="token comment">; 'this is solid_box. width=%d, height=%d, depth=%d, density=%d', 0aH</span>
    push  OFFSET ??_C@_0DO@HNCNIHNN@this?5is?5solid_box?<span class="token number">4</span>?5width?<span class="token operator">$</span>DN?<span class="token operator">$</span>CFd?<span class="token number">0</span>?5hei@
    call  _printf
    add   <span class="token register variable">esp</span>, <span class="token number">20</span>
    ret   <span class="token number">0</span>
?dump@solid_box@@QAEXXZ ENDP <span class="token comment">; solid_box::dump</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>â‘  ç±»boxã€‚å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p>
<table>
<thead>
<tr>
<th>offset</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>+0x0</td>
<td>width</td>
</tr>
<tr>
<td>+0x4</td>
<td>height</td>
</tr>
<tr>
<td>+0x8</td>
<td>depth</td>
</tr>
</tbody>
</table>
<p>â‘¡ ç±»solid_objectã€‚å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p>
<table>
<thead>
<tr>
<th>offset</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>+0x0</td>
<td>density</td>
</tr>
</tbody>
</table>
<p>â‘¢ ç±»solid_boxï¼Œå¯ä»¥çœ‹æˆæ˜¯ä»¥ä¸Šä¸¤ä¸ªç±»çš„è”åˆä½“ã€‚å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p>
<table>
<thead>
<tr>
<th>offset</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>+0x0</td>
<td>width</td>
</tr>
<tr>
<td>+0x4</td>
<td>height</td>
</tr>
<tr>
<td>+0x8</td>
<td>depth</td>
</tr>
<tr>
<td>+0xC</td>
<td>density</td>
</tr>
</tbody>
</table>
<p>ä»¥ä¸Šå›¾è¡¨é‡‡ç”¨äº†åç§»é‡ä¸å¯¹åº”å˜é‡çš„æ–¹å¼å±•ç°3ä¸ªç±»å¯¹è±¡çš„å†…å­˜å­˜å‚¨ç»“æ„ã€‚å›¾ä¸­ä¸€å…±å‡ºç°äº†4ä¸ªå˜é‡ï¼Œå³é•¿widthã€é«˜heightã€å®½depthä»¥åŠå¯†åº¦densityã€‚</p>
<p><code>ä½“ç§¯å‡½æ•°</code>å’Œ<code>å¯†åº¦å‡½æ•°</code>ä¸éœ€è¦åˆ†æï¼Œä¸å‰ä¾‹æ˜¯ä¸€æ ·çš„</p>
<p>å…³é”®å¤šé‡ç»§æ‰¿çš„<code>solod_box</code>çš„<code>get_weight</code>å‡½æ•°</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">?get_weight@solid_box@@QAEHXZ PROC <span class="token comment">; solid_box::get_weight, COMDAT</span>
<span class="token comment">; _this$ = ecx</span>
    push  <span class="token register variable">esi</span>
    mov   <span class="token register variable">esi</span>, <span class="token register variable">ecx</span>
    push  <span class="token register variable">edi</span>
    lea   <span class="token register variable">ecx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">12</span><span class="token operator">]</span>
    call  ?get_density@solid_object@@QAEHXZ <span class="token comment">; solid_object::get_density</span>
    mov   <span class="token register variable">ecx</span>, <span class="token register variable">esi</span>
    mov   <span class="token register variable">edi</span>, <span class="token register variable">eax</span>
    call  ?get_volume@box@@QAEHXZ <span class="token comment">; box::get_volume</span>
    imul  <span class="token register variable">eax</span>, <span class="token register variable">edi</span>
    pop   <span class="token register variable">edi</span>
    pop   <span class="token register variable">esi</span>
    ret   <span class="token number">0</span>
?get_weight@solid_box@@QAEHXZ ENDP <span class="token comment">; solid_box::get_weight</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><code>get_weight</code>è°ƒç”¨äº†çˆ¶ç±»çš„ä¸¤ä¸ªæ–¹æ³•</li>
<li>åœ¨è°ƒç”¨<code>get_volume</code>è®¡ç®—ä½“ç§¯çš„æ—¶å€™ä¼ é€’çš„æ˜¯<code>this</code>æŒ‡é’ˆ</li>
<li>è€Œåœ¨è°ƒç”¨<code>get_density</code>è®¡ç®—å¯†åº¦å‡½æ•°ï¼Œä¼ é€’çš„å‚æ•°åœ°å€æ˜¯<code>this+12</code>ï¼Œ(<em>è¿™ä¸ªå°±ç›¸å½“äºæ˜¯solid_objectç±»çš„thisæŒ‡é’ˆ</em>)è¿™ä¸ªåœ°å€å¯¹åº”çš„æ˜¯<code>solid_box</code>ç±»çš„<code>solid_object</code>å­—æ®µ</li>
<li><code>solid_object::get_density()</code>è®¤ä¸ºï¼Œå®ƒå¤„ç†çš„æ˜¯å¸¸è§„çš„solid_objectç±»ï¼Œè€Œbox::get_volume()åˆ™å¯ä»¥æ­£å¸¸è®¿é—®åŸæœ‰æ•°æ®ç±»å‹çš„3ä¸ªå˜é‡ï¼Œå¦‚åŒç›´æ¥æ“ä½œboxç±»ä¸€æ ·ã€‚</li>
<li><mark>ç»§æ‰¿äº†å…¶ä»–çš„ã€å¤šä¸ªç±»è€Œç”Ÿæˆçš„ç±»å¯¹è±¡ï¼Œåœ¨å†…å­˜ä¹‹ä¸­å°±æ˜¯ä¸€ç§è”åˆä½“å‹çš„æ•°æ®ç»“æ„ã€‚å®ƒç»§æ‰¿äº†åŸæœ‰çˆ¶ç±»çš„å…¨éƒ¨å­—æ®µå’Œæ–¹æ³•ã€‚åœ¨è¿™ç§ç»§æ‰¿ç±»å¯¹è±¡è°ƒç”¨æŸä¸ªå…·ä½“æ–¹æ³•æ—¶ï¼Œå®ƒä¼ é€’çš„æ˜¯ä¸è¯¥æ–¹æ³•åŸæœ‰åŸºç±»ç›¸å¯¹åœ°å€ç›¸åº”çš„thisæŒ‡é’ˆã€‚</mark></li>
</ul>
<h5 id="è™šæ‹Ÿæ–¹æ³•"><a class="markdownIt-Anchor" href="#è™šæ‹Ÿæ–¹æ³•"></a> è™šæ‹Ÿæ–¹æ³•</h5>
<p>å®ƒå…è®¸åœ¨æ´¾ç”Ÿç±»ä¸­é‡å†™åŸºç±»çš„æ–¹æ³•ã€‚ä½¿ç”¨è™šæ‹Ÿå‡½æ•°ï¼Œå¯ä»¥ä½¿å¾—<code>åŸºç±»çš„æŒ‡é’ˆæˆ–å¼•ç”¨åœ¨æŒ‡å‘æ´¾ç”Ÿç±»å¯¹è±¡æ—¶ï¼Œè°ƒç”¨æ´¾ç”Ÿç±»ä¸­é‡å†™çš„å‡½æ•°ç‰ˆæœ¬ï¼Œè€Œä¸æ˜¯åŸºç±»ä¸­çš„å‡½æ•°ç‰ˆæœ¬ã€‚</code>è¿™æ ·å°±å¢å¼ºäº†ä»£ç çš„çµæ´»æ€§å’Œå¯æ‰©å±•æ€§ã€‚</p>
<ul>
<li>å£°æ˜:åœ¨åŸºç±»ä¸­ï¼Œé€šè¿‡åœ¨å‡½æ•°å£°æ˜å‰åŠ ä¸Š<code>virtual</code>å…³é”®å­—æ¥å£°æ˜ä¸€ä¸ªå‡½æ•°ä¸ºè™šæ‹Ÿå‡½æ•°</li>
<li>é‡å†™:åœ¨æ´¾ç”Ÿç±»,é€šè¿‡ä½¿ç”¨ç›¸åŒå‡½æ•°åï¼Œè¿”å›ç±»å‹å’Œå‚æ•°åˆ—è¡¨æ¥é‡å†™(Override)åŸºç±»çš„è™šæ‹Ÿå‡½æ•°ã€‚æ´¾ç”Ÿç±»<code>ä¸éœ€è¦å†æ¬¡ä½¿ç”¨virtualå…³é”®å­—</code>ï¼Œä½†å¯ä»¥ä½¿ç”¨<code>override</code>æ¥æ˜ç¡®è¡¨ç¤ºè¯¥å‡½æ•°æ˜¯é‡å†™åŸºç±»çš„è™šæ‹Ÿå‡½æ•°,æœ‰åŠ©äºç¼–è¯‘å™¨æ£€æŸ¥</li>
<li>è™šå‡½æ•°è¡¨:ç¼–è¯‘å™¨ä¼š<code>ä¸ºåŒ…å«è‡³å°‘ä¸€ä¸ªè™šæ‹Ÿå‡½æ•°çš„ç±»ç”Ÿæˆä¸€ä¸ªè™šå‡½æ•°è¡¨ï¼ˆvtableï¼‰</code>ï¼Œå…¶ä¸­å­˜å‚¨äº†è¯¥ç±»æ‰€æœ‰è™šæ‹Ÿå‡½æ•°çš„åœ°å€ã€‚æ¯ä¸ªå…·æœ‰è™šæ‹Ÿå‡½æ•°çš„ç±»å®ä¾‹éƒ½ä¼šæœ‰ä¸€ä¸ªæŒ‡å‘ç›¸åº”è™šå‡½æ•°è¡¨çš„æŒ‡é’ˆï¼ˆé€šå¸¸ä½œä¸ºå¯¹è±¡çš„ç¬¬ä¸€ä¸ªæˆå‘˜ï¼‰ã€‚</li>
<li>åŠ¨æ€ç»‘å®šï¼šå½“é€šè¿‡åŸºç±»æŒ‡é’ˆæˆ–å¼•ç”¨æ¥è°ƒç”¨ä¸€ä¸ªè™šæ‹Ÿå‡½æ•°æ—¶ï¼Œå®é™…è°ƒç”¨å“ªä¸ªç‰ˆæœ¬çš„å‡½æ•°æ˜¯åœ¨è¿è¡Œæ—¶å†³å®šçš„ï¼Œä¾æ®æ˜¯æŒ‡é’ˆæˆ–å¼•ç”¨æ‰€æŒ‡å‘çš„å¯¹è±¡çš„å®é™…ç±»å‹ã€‚</li>
</ul>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">class</span> <span class="token class-name">object</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token keyword">int</span> color<span class="token punctuation">;</span>
        <span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token function">object</span> <span class="token punctuation">(</span><span class="token keyword">int</span> color<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">this</span><span class="token operator">-></span>color<span class="token operator">=</span>color<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">dump</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"color=%d\n"</span><span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">box</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">object</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token keyword">int</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> depth<span class="token punctuation">;</span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">box</span><span class="token punctuation">(</span><span class="token keyword">int</span> color<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> <span class="token keyword">int</span> depth<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token operator">-></span>color<span class="token operator">=</span>color<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token operator">-></span>width<span class="token operator">=</span>width<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token operator">-></span>height<span class="token operator">=</span>height<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token operator">-></span>depth<span class="token operator">=</span>depth<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">dump</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"this is box. color=%d, width=%d, height=%d, depth=%d\n"</span><span class="token punctuation">,</span> color<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> depth<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">sphere</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">object</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token keyword">int</span> radius<span class="token punctuation">;</span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">sphere</span><span class="token punctuation">(</span><span class="token keyword">int</span> color<span class="token punctuation">,</span> <span class="token keyword">int</span> radius<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token operator">-></span>color<span class="token operator">=</span>color<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token operator">-></span>radius<span class="token operator">=</span>radius<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">dump</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"this is sphere. color=%d, radius=%d\n"</span><span class="token punctuation">,</span> color<span class="token punctuation">,</span> radius<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    box <span class="token function">b</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sphere <span class="token function">s</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    object <span class="token operator">*</span>o1<span class="token operator">=</span><span class="token operator">&amp;</span>b<span class="token punctuation">;</span>
    object <span class="token operator">*</span>o2<span class="token operator">=</span><span class="token operator">&amp;</span>s<span class="token punctuation">;</span>

    o1<span class="token operator">-></span><span class="token function">dump</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    o2<span class="token operator">-></span><span class="token function">dump</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>åœ¨è¿™ä¸ªä¾‹å­ä¸­,ç±»<code>object</code>å®šä¹‰äº†ä¸€ä¸ªè™šæ‹Ÿå‡½æ•°<code>dump()</code>ï¼Œå®ƒè¢«ç»§æ‰¿ç±»boxå’Œsphereä¸­çš„åŒåå‡½æ•°è¦†ç›–äº†</li>
<li>åœ¨è°ƒç”¨è™šæ‹Ÿå‡½æ•°æ—¶ï¼Œ<code>ç¼–è¯‘å™¨é˜¶æ®µå¯èƒ½æ— æ³•ç¡®å®šå¯¹è±¡çš„ç±»å‹æƒ…å†µ</code>ã€‚å½“ç±»ä¸­å«æœ‰è™šå‡½æ•°æ—¶ï¼Œå…¶åŸºç±»çš„æŒ‡é’ˆå°±å¯ä»¥æŒ‡å‘ä»»ä½•æ´¾ç”Ÿç±»çš„å¯¹è±¡ï¼Œè¿™æ—¶å°±æœ‰å¯èƒ½ä¸çŸ¥é“åŸºç±»æŒ‡é’ˆåˆ°åº•æŒ‡å‘çš„æ˜¯å“ªä¸ªå¯¹è±¡çš„æƒ…å†µã€‚è¿™æ—¶å°±è¦æ ¹æ®å®æ—¶ç±»å‹ä¿¡æ¯ï¼Œç¡®å®šåº”å½“è°ƒç”¨çš„ç›¸åº”å‡½æ•°ã€‚</li>
</ul>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_s<span class="token operator">$</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">32</span> <span class="token comment">; size = 12</span>
_b<span class="token operator">$</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">20</span> <span class="token comment">; size = 20</span>
_main PROC
    sub   <span class="token register variable">esp</span>, <span class="token number">32</span>
    push  <span class="token number">30</span>
    push  <span class="token number">20</span>
    push  <span class="token number">10</span>
    push  <span class="token number">1</span>
    lea   <span class="token register variable">ecx</span>, DWORD PTR _b<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">48</span><span class="token operator">]</span>
    call  ??0box@@QAE@HHHH@Z <span class="token comment">; box::box</span>
    push  <span class="token number">40</span>
    push  <span class="token number">2</span>
    lea   <span class="token register variable">ecx</span>, DWORD PTR _s<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">40</span><span class="token operator">]</span>
    call  ??0sphere@@QAE@HH@Z <span class="token comment">; sphere::sphere</span>
    mov   <span class="token register variable">eax</span>, DWORD PTR _b<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">32</span><span class="token operator">]</span>
    mov   <span class="token register variable">edx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span>
    lea   <span class="token register variable">ecx</span>, DWORD PTR _b<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">32</span><span class="token operator">]</span>
    call  <span class="token register variable">edx</span><span class="token comment">;o1->dump</span>
    mov   <span class="token register variable">eax</span>, DWORD PTR _s<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">32</span><span class="token operator">]</span>
    mov   <span class="token register variable">edx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">]</span>
    lea   <span class="token register variable">ecx</span>, DWORD PTR _s<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">32</span><span class="token operator">]</span>
    call  <span class="token register variable">edx</span><span class="token comment">;o2->dump</span>
    xor   <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
    add   <span class="token register variable">esp</span>, <span class="token number">32</span>
    ret   <span class="token number">0</span>
_main ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>æŒ‡å‘<code>dump</code>å‡½æ•°çš„å‡½æ•°æŒ‡é’ˆåº”å½“ä½äºç±»å¯¹è±¡<code>object</code>ä¸­çš„æŸä¸ªåœ°æ–¹ã€‚æˆ‘ä»¬åœ¨å“ªé‡Œå»æ‰¾æ–°æ–¹æ³•çš„å‡½æ•°åœ°å€å‘¢ï¼Ÿå®ƒå¿…å®šç”±æ„é€ å‡½æ•°å®šä¹‰ï¼š main()å‡½æ•°æ²¡è°ƒç”¨å…¶ä»–å‡½æ•°ï¼Œå› æ­¤è¿™ä¸ªæŒ‡é’ˆè‚¯å®šç”±<code>æ„é€ å‡½æ•°</code>å®šä¹‰ã€‚å› æ­¤æˆ‘ä»¬å…·ä½“çœ‹çœ‹å„ä¸ªç±»çš„æ„é€ å‡½æ•°æ˜¯å¦‚ä½•å®ç°çš„</li>
</ul>
<p><code>boxç±»çš„æ„é€ å‡½æ•°</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">??_R0?AVbox@@@<span class="token number">8</span> DD FLAT:??_7type_info@@6B@ <span class="token comment">; box 'RTTI Type Descriptor'</span>
    DD     <span class="token number">00H</span>
    DB     <span class="token string">'.?AVbox@@'</span>, <span class="token number">00H</span>

??_R1A@?0A@EA@box@@<span class="token number">8</span> DD FLAT:??_R0?AVbox@@@<span class="token number">8</span> <span class="token comment">; box::'RTTI Base Class Descriptor at (0,-1,0,64)'</span>
    DD     <span class="token number">01H</span>
    DD     <span class="token number">00H</span>
    DD     <span class="token number">0ffffffffH</span>
    DD     <span class="token number">00H</span>
    DD     <span class="token number">040H</span>
    DD     FLAT:??_R3box@@<span class="token number">8</span>

??_R2box@@<span class="token number">8</span> DD     FLAT:??_R1A@?0A@EA@box@@<span class="token number">8</span> <span class="token comment">; box::'RTTI Base Class Array'</span>
    DD     FLAT:??_R1A@?0A@EA@object@@<span class="token number">8</span>

??_R3box@@<span class="token number">8</span> DD     <span class="token number">00H</span> <span class="token comment">; box::'RTTI Class Hierarchy Descriptor'</span>
    DD     <span class="token number">00H</span>
    DD     <span class="token number">02H</span>
    DD     FLAT:??_R2box@@<span class="token number">8</span>

??_R4box@@6B@ DD <span class="token number">00H</span> <span class="token comment">; box::'RTTI Complete Object Locator'</span>
    DD     <span class="token number">00H</span>
    DD     <span class="token number">00H</span>
    DD     FLAT:??_R0?AVbox@@@<span class="token number">8</span>
    DD     FLAT:??_R3box@@<span class="token number">8</span>

??_7box@@6B@ DD     FLAT:??_R4box@@6B@ <span class="token comment">; box::`vftable'</span>
    DD     FLAT:?dump@box@@UAEXXZ

_color<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>    <span class="token comment">; size = 4</span>
_width<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">12</span>   <span class="token comment">; size = 4</span>
_height<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">16</span>  <span class="token comment">; size = 4</span>
_depth<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">20</span>   <span class="token comment">; size = 4</span>
??0box@@QAE@HHHH@Z PROC <span class="token comment">; box::box, COMDAT</span>
<span class="token comment">; _this$ = ecx</span>
    push  <span class="token register variable">esi</span>
    mov   <span class="token register variable">esi</span>, <span class="token register variable">ecx</span>
    call  ??0object@@QAE@XZ <span class="token comment">; object::object</span>
    mov   <span class="token register variable">eax</span>, DWORD PTR _color<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">]</span>
    mov   <span class="token register variable">ecx</span>, DWORD PTR _width<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">]</span>
    mov   <span class="token register variable">edx</span>, DWORD PTR _height<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">]</span>
    mov   DWORD PTR <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">]</span>, <span class="token register variable">eax</span>
    mov   <span class="token register variable">eax</span>, DWORD PTR _depth<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">]</span>
    mov   DWORD PTR <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">16</span><span class="token operator">]</span>, <span class="token register variable">eax</span>
    mov   DWORD PTR <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">]</span>, OFFSET ??_7box@@6B@
    mov   DWORD PTR <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">]</span>, <span class="token register variable">ecx</span>
    mov   DWORD PTR <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">+</span><span class="token number">12</span><span class="token operator">]</span>, <span class="token register variable">edx</span>
    mov   <span class="token register variable">eax</span>, <span class="token register variable">esi</span>
    pop   <span class="token register variable">esi</span>
    ret   <span class="token number">16</span>
??0box@@QAE@HHHH@Z ENDP <span class="token comment">; box::box</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><code>??_R0?AVbox@@@8 DD FLAT:??_7type_info@@6B@</code>: è¿™ä¸€è¡Œå®šä¹‰äº†ç±»<code>box</code>çš„RTTI Type Descriptorï¼Œæ˜¯è¿è¡Œæ—¶è¯†åˆ«å¯¹è±¡ç±»å‹çš„å…ƒæ•°æ®çš„ä¸€éƒ¨åˆ†ã€‚å®ƒæŒ‡å‘ä¸€ä¸ªé€šç”¨çš„<code>type_info</code>ç»“æ„ã€‚</li>
<li><code>??_R1A@?0A@EA@box@@8 DD ...</code>: è¿™ä¸€éƒ¨åˆ†å®šä¹‰äº†RTTI Base Class Descriptorï¼Œæè¿°äº†ç±»<code>box</code>çš„åŸºç±»å…³ç³»ã€‚è¿™é‡Œæ˜¾ç¤º<code>box</code>æœ‰ä¸€ä¸ªåŸºç±»ï¼Œå¹¶æä¾›äº†å…³äºè¿™ä¸ªåŸºç±»çš„åç§»é‡ã€è™šå‡½æ•°è¡¨æŒ‡é’ˆç­‰ä¿¡æ¯ã€‚</li>
<li><code>??_R2box@@8 DD ...</code>: RTTI Base Class Arrayï¼Œåˆ—å‡ºäº†<code>box</code>ç±»çš„æ‰€æœ‰åŸºç±»çš„RTTI Base Class Descriptorçš„åœ°å€ã€‚</li>
<li><code>??_R3box@@8 DD ...</code>: RTTI Class Hierarchy Descriptorï¼Œæè¿°äº†ç±»å±‚æ¬¡ç»“æ„çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç±»çš„è™šå‡½æ•°è¡¨æ•°é‡å’ŒåŸºç±»æ•°ç»„çš„åœ°å€ã€‚</li>
<li><code>??_R4box@@6B@ DD ...</code>: RTTI Complete Object Locatorï¼Œæä¾›äº†å®šä½å®Œæ•´å¯¹è±¡æ‰€éœ€çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç±»å‹æè¿°ç¬¦ã€è™šå‡½æ•°è¡¨ç­‰çš„åœ°å€ã€‚</li>
<li><code>??_7box@@6B@ DD FLAT:??_R4box@@6B@</code>: è¿™æ˜¯ç±»<code>box</code>çš„è™šå‡½æ•°è¡¨(vtable)çš„å¼€å§‹ï¼Œå®ƒæŒ‡å‘äº†RTTI Complete Object Locatorã€‚</li>
<li><code>DD FLAT:?dump@box@@UAEXXZ</code>: è¿™ä¸€è¡Œåœ¨è™šå‡½æ•°è¡¨ä¸­æ·»åŠ äº†ä¸€ä¸ªæ¡ç›®ï¼ŒæŒ‡å‘<code>box</code>ç±»çš„ä¸€ä¸ªè™šå‡½æ•°ï¼ˆåœ¨è¿™ä¸ªä¾‹å­ä¸­ä¼¼ä¹æ˜¯<code>dump</code>å‡½æ•°ï¼‰ã€‚</li>
</ul>
<p>åˆ†æè¿™ä¸ªæ„é€ å‡½æ•°çš„å†…å­˜åˆ†å¸ƒ</p>
<ul>
<li>
<p>ç¬¬ä¸€ä¸ªå­—æ®µæ˜¯æŸä¸ª<code>box::vftable</code>çš„æŒ‡é’ˆ</p>
</li>
<li>
<p>åœ¨è¿™ä¸ªè¡¨ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°<code>ä¸€ä¸ªæŒ‡å‘æ•°æ®è¡¨box::RTTI Complete Object Locatorçš„é“¾æ¥</code>å’Œ<code>ä¸€ä¸ªæŒ‡å‘ç±»æˆå‘˜å‡½æ•°box::dump()çš„é“¾æ¥</code>ã€‚å®ƒä»¬çš„æ­£è§„åç§°åˆ†åˆ«æ˜¯è™šæ‹Ÿæ–¹æ³•è¡¨å’ŒRTTIã€‚<code>è™šæ‹Ÿæ–¹æ³•è¡¨å­˜å‚¨ç€å„æ–¹æ³•çš„åœ°å€</code>ï¼Œ<code>RTTIè¡¨å­˜å‚¨ç€ç±»å‹çš„ä¿¡æ¯</code>ã€‚å¦å¤–ï¼Œ<code>RTTIè¡¨ä¸ºC++ç¨‹åºæä¾›äº†â€œå¼ºåˆ¶è½¬æ¢è¿ç®—ç¬¦â€dynamic_cast ï¼ˆå°†åŸºç±»ç±»å‹çš„æŒ‡é’ˆæˆ–å¼•ç”¨å®‰å…¨åœ°è½¬æ¢ä¸ºæ´¾ç”Ÿç±»å‹çš„æŒ‡é’ˆæˆ–å¼•ç”¨ï¼‰å’Œâ€œç±»å‹æŸ¥è¯¢æ“ä½œç¬¦â€typeid</code>ã€‚åœ¨ä¸Šè¿°æŒ‡ä»¤è°ƒç”¨ç±»æˆå‘˜å‡½æ•°æ—¶ï¼Œå®ƒæ‰€ä½¿ç”¨çš„<code>ç±»åç§°ä»ç„¶æ˜¯æ–‡æœ¬å‹å­—ç¬¦ä¸²</code>ã€‚åŸºäºä»£ç ä¸­dump()å‡½æ•°çš„å®ä¾‹æƒ…å†µå¯çŸ¥ï¼Œåœ¨é€šè¿‡è°ƒç”¨æŒ‡å‘åŸºç±»çš„æŒ‡é’ˆï¼ˆæˆ–å¼•ç”¨ï¼‰è°ƒç”¨å…¶è™šæ‹Ÿå‡½æ•°ï¼ˆç±»å®ä¾‹ï¼šï¼šè™šæ–¹æ³•ï¼‰æ—¶ï¼ŒæŒ‡é’ˆæœ€ç»ˆä¼šæŒ‡å‘æ´¾ç”Ÿç±»å®ä¾‹çš„åŒåè™šæ‹Ÿæ–¹æ³•â€”â€”æ„é€ å‡½æ•°ä¼šæŠŠæŒ‡é’ˆå®é™…æŒ‡å‘çš„å¯¹è±¡å®ä¾‹çš„ç±»å‹ä¿¡æ¯å­˜å‚¨åœ¨æ•°æ®ç»“æ„ä¹‹ä¸­ã€‚</p>
</li>
<li>
<p>åœ¨å†…å­˜æ•°æ®è¡¨é‡Œæ£€ç´¢è™šæ‹Ÿæ–¹æ³•çš„å†…å­˜åœ°å€å¿…å®šè¦æ¶ˆè€—é¢å¤–çš„CPUæ—¶é—´ã€‚å› æ­¤è™šæ‹Ÿæ–¹æ³•çš„è¿è¡Œé€Ÿåº¦æ¯”ä¸€èˆ¬çš„æ–¹æ³•è¦æ…¢ä¸€äº›ã€‚</p>
</li>
</ul>
<p><strong>æ€»ç»“</strong></p>
<ol>
<li><strong>ç¼–è¯‘é˜¶æ®µ</strong>ï¼š
<ul>
<li><strong>ç”Ÿæˆè™šå‡½æ•°è¡¨ï¼ˆVTableï¼‰</strong>ï¼šå½“ç¼–è¯‘å™¨é‡åˆ°å«æœ‰è™šå‡½æ•°çš„ç±»æ—¶ï¼Œå®ƒä¼šä¸ºè¯¥ç±»ç”Ÿæˆä¸€ä¸ªè™šå‡½æ•°è¡¨ï¼ˆVTableï¼‰ã€‚è¿™ä¸ªè¡¨æ˜¯ä¸€ä¸ªå†…å­˜åŒºåŸŸï¼Œå…¶ä¸­å­˜å‚¨äº†ç±»ä¸­æ‰€æœ‰è™šå‡½æ•°çš„åœ°å€ã€‚</li>
<li><strong>æ’å…¥è™šå‡½æ•°è¡¨æŒ‡é’ˆï¼ˆVPtrï¼‰</strong>ï¼šå¯¹äºæ¯ä¸ªä»å«æœ‰è™šå‡½æ•°çš„ç±»æ´¾ç”Ÿå‡ºæ¥çš„å¯¹è±¡ï¼Œç¼–è¯‘å™¨ä¼šåœ¨å¯¹è±¡å†…å­˜å¸ƒå±€çš„å¼€å§‹ä½ç½®ï¼ˆé€šå¸¸æ˜¯ç¬¬ä¸€ä¸ªæˆå‘˜ï¼Œä½†è¿™ä¹Ÿå–å†³äºç¼–è¯‘å™¨å’Œå¹³å°ï¼ˆå¦‚æœæœ‰æ„é€ å‡½æ•°å°±æ˜¯åœ¨æ„é€ å‡½æ•°é‡Œï¼‰æ’å…¥ä¸€ä¸ªæŒ‡å‘è¯¥ç±»è™šå‡½æ•°è¡¨çš„æŒ‡é’ˆï¼ˆVPtrï¼‰ã€‚</li>
</ul>
</li>
<li><strong>é“¾æ¥é˜¶æ®µ</strong>ï¼š
<ul>
<li><strong>åœ°å€åˆ†é…</strong>ï¼šé“¾æ¥å™¨ä¼šä¸ºæ¯ä¸ªå‡½æ•°åˆ†é…æœ€ç»ˆçš„å†…å­˜åœ°å€ï¼ŒåŒ…æ‹¬è™šå‡½æ•°ã€‚è¿™ä¸€æ­¥éª¤ç¡®ä¿äº†è™šå‡½æ•°è¡¨ä¸­å­˜å‚¨çš„åœ°å€æ˜¯æ­£ç¡®çš„ã€‚</li>
</ul>
</li>
<li><strong>è¿è¡Œæ—¶</strong>ï¼š
<ul>
<li>è™šå‡½æ•°è°ƒç”¨ï¼šå½“é€šè¿‡åŸºç±»æŒ‡é’ˆæˆ–å¼•ç”¨æ¥è°ƒç”¨è™šå‡½æ•°æ—¶ï¼Œå®é™…æ‰§è¡Œçš„ä»£ç å¦‚ä¸‹ï¼š
<ul>
<li>é¦–å…ˆï¼Œç¨‹åºé€šè¿‡å¯¹è±¡çš„VPtræ‰¾åˆ°å…¶å¯¹åº”çš„è™šå‡½æ•°è¡¨ã€‚</li>
<li>ç„¶åï¼Œæ ¹æ®å‡½æ•°è°ƒç”¨åœ¨ä»£ç ä¸­çš„åç§»é‡ï¼ˆå³è™šå‡½æ•°åœ¨VTableä¸­çš„ä½ç½®ï¼‰ï¼Œä»è™šå‡½æ•°è¡¨ä¸­å–å‡ºå®é™…è¦è°ƒç”¨çš„å‡½æ•°åœ°å€ã€‚</li>
<li>æœ€åï¼Œé€šè¿‡è¿™ä¸ªåœ°å€è·³è½¬åˆ°å¹¶æ‰§è¡Œå®é™…çš„è™šå‡½æ•°ä»£ç ã€‚</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>æ€»ç»“æ¥è¯´ï¼Œè™šå‡½æ•°çš„åœ°å€æ˜¯åœ¨ç¼–è¯‘æ—¶ç”±ç¼–è¯‘å™¨ç¡®å®šå¹¶å¡«å……åˆ°è™šå‡½æ•°è¡¨ä¸­ï¼Œè€Œå…·ä½“è°ƒç”¨å“ªä¸ªè™šå‡½æ•°åˆ™æ˜¯åœ¨è¿è¡Œæ—¶é€šè¿‡å¯¹è±¡çš„VPtrå’Œè™šå‡½æ•°è¡¨æ¥åŠ¨æ€å†³å®šçš„ã€‚è¿™ç§æœºåˆ¶å®ç°äº†C++ä¸­çš„å¤šæ€æ€§ï¼Œå³å…è®¸æ´¾ç”Ÿç±»å¯¹è±¡é€šè¿‡åŸºç±»æŒ‡é’ˆæˆ–å¼•ç”¨æ¥è¡¨ç°å‡ºä¸åŒçš„è¡Œä¸ºã€‚</p>
<h4 id="ostreamè¾“å‡ºæµ"><a class="markdownIt-Anchor" href="#ostreamè¾“å‡ºæµ"></a> ostreamè¾“å‡ºæµ</h4>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    std<span class="token double-colon punctuation">::</span>cout<span class="token operator">&lt;&lt;</span><span class="token string">"Hello,world!\n"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><mark>è¿ç®—é‡è½½ç¬¦â€œ&lt;&lt;â€çš„ä½œç”¨æ˜¯â€œé‡è½½â€å…¶ä»–ç±»å‹çš„æ•°æ®ï¼Œä¸»è¦ç”¨äºå¯¹è±¡ä¹‹é—´çš„è¿ç®—ã€‚</mark></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token operator">$</span>SG37112 DB <span class="token string">'Hello, world!'</span>, <span class="token number">0aH</span>, <span class="token number">00H</span>

_main PROC
    push OFFSET <span class="token operator">$</span>SG37112
    push OFFSET ?cout@std@@3V?<span class="token operator">$</span>basic_ostream@DU?<span class="token operator">$</span>char_traits@D@std@@@<span class="token number">1</span>@A <span class="token comment">; std::cout</span>
    call ??<span class="token operator">$</span>?6U?<span class="token operator">$</span>char_traits@D@std@@@std@@YAAAV?<span class="token operator">$</span>basic_ostream@DU? â†™
    â†˜ <span class="token operator">$</span>char_traits@D@std@@@<span class="token number">0</span>@AAV10@PBD@Z <span class="token comment">; std::operator&lt;&lt;&lt;std::char_traits&lt;char> ></span>
    add   <span class="token register variable">esp</span>, <span class="token number">8</span>
    xor   <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
    ret   <span class="token number">0</span>
_main ENDP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>std::cout &lt;&lt; &quot;Hello, &quot; &lt;&lt; &quot;world!\n&quot;;</code></p>
<p>ç›¸å½“äº<code>f(f(std::cout, &quot;Hello, &quot;), &quot;world!&quot;);</code></p>
<h4 id="å¼•ç”¨"><a class="markdownIt-Anchor" href="#å¼•ç”¨"></a> å¼•ç”¨</h4>
<p><a target="_blank" rel="noopener" href="https://csguide.cn/cpp/memory/difference_of_pointers_and_ref.html#%E6%B1%87%E7%BC%96%E6%8F%AD%E5%BC%80%E5%BC%95%E7%94%A8%E9%9D%A2%E7%BA%B1">C++ ä¸­æŒ‡é’ˆå’Œå¼•ç”¨çš„åŒºåˆ« | ç¼–ç¨‹æŒ‡åŒ— (csguide.cn)</a></p>
<p><em>å¼•ç”¨å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªå¸¸é‡æŒ‡é’ˆ</em></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">f2</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span> sum<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span> product<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        sum<span class="token operator">=</span>x<span class="token operator">+</span>y<span class="token punctuation">;</span>
        product<span class="token operator">=</span>x<span class="token operator">*</span>y<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">_x<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">8</span>                                              <span class="token comment">; size = 4</span>
_y<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">12</span>                                             <span class="token comment">; size = 4</span>
_sum<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">16</span>                                           <span class="token comment">; size = 4</span>
_product<span class="token operator">$</span> <span class="token operator">=</span> <span class="token number">20</span>                                       <span class="token comment">; size = 4</span>
?f2@@YAXHHAAH0@Z PROC                                <span class="token comment">; f2</span>
        mov     <span class="token register variable">ecx</span>, DWORD PTR _y<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
        mov     <span class="token register variable">eax</span>, DWORD PTR _x<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
        lea     <span class="token register variable">edx</span>, DWORD PTR <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token register variable">ecx</span><span class="token operator">]</span><span class="token comment">;edx:sum=x+y</span>
        imul <span class="token register variable">eax</span>, <span class="token register variable">ecx</span><span class="token comment">;eax:x*y</span>
        mov <span class="token register variable">ecx</span>, DWORD PTR _product<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span><span class="token comment">;ecx=ptr(product)</span>
        push <span class="token register variable">esi</span>
        mov     <span class="token register variable">esi</span>, DWORD PTR _sum<span class="token operator">$</span><span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">]</span><span class="token comment">;esi=ptr(sum)</span>
        mov     DWORD PTR <span class="token operator">[</span><span class="token register variable">esi</span><span class="token operator">]</span>, <span class="token register variable">edx</span><span class="token comment">;sum=x+y</span>
        mov     DWORD PTR <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">]</span>, <span class="token register variable">eax</span><span class="token comment">;product=x*y</span>
        pop     <span class="token register variable">esi</span>
        ret     <span class="token number">0</span>
?f2@@YAXHHAAH0@Z ENDP                                <span class="token comment">; f2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="stlstandard-template-library"><a class="markdownIt-Anchor" href="#stlstandard-template-library"></a> *stl(standard template library)</h4>
<h5 id="stdstringå­—ç¬¦ä¸²"><a class="markdownIt-Anchor" href="#stdstringå­—ç¬¦ä¸²"></a> std::string(å­—ç¬¦ä¸²)</h5>
<p>std::stringå®šä¹‰ä¸ºä»¥ä¸‹å‡ ä¸ªç»„ä»¶ï¼šç¼“å†²åŒºæŒ‡é’ˆã€å­—ç¬¦ä¸²ç¼“å†²åŒºã€å½“å‰å­—ç¬¦ä¸²çš„é•¿åº¦ï¼ˆä¾¿äºå‡½æ•°æ“ä½œï¼›è¯·å‚é˜…ï¼»Yur13ï¼½çš„2.2.1èŠ‚ï¼‰ä»¥åŠå½“å‰ç¼“å†²åŒºçš„å®¹é‡ã€‚åœ¨ç¼“å†²åŒºé‡Œï¼Œå­—ç¬¦ä¸²é€šå¸¸ç”¨0ä½œå­—ç¬¦ä¸²ç»“æŸç¬¦ï¼Œä»¥å…¼å®¹å¸¸è§„çš„Cè¯­è¨€ASCIIZå­—ç¬¦ä¸²æ ¼å¼ã€‚</p>
<p>åœ¨<code>C++</code>çš„æ ‡å‡†æ•°æ®ç»“æ„ä¸­ï¼Œ<mark>å­—ç¬¦ä¸²ä¸æ˜¯ç±»å¯¹è±¡</mark>ã€‚å®ƒæŠŠå­—ç¬¦ä¸²å®šä¹‰ä¸ºæ¨¡ç‰ˆå‹æ•°æ®ã€‚è¿™æ˜¯ä¸ºäº†å…¼å®¹å„ä¸ªç±»å‹çš„å­—ç¬¦å…ƒç´ ã€‚ç°åœ¨ï¼Œå®ƒè‡³å°‘æ”¯æŒ<code>char(æ ‡å‡†å­—ç¬¦ä¸²)</code>ä»¥åŠ<code>wchar_t</code></p>
<p><code>std::stringæ˜¯ä»¥8ä½å­—ç¬¦charä¸ºåŸºæœ¬ç±»å‹çš„ç±»ï¼Œè€Œstd::wstringåˆ™æ˜¯ä»¥16/32ä½å®½å­—ç¬¦wchar_tä¸ºåŸºæœ¬ç±»å‹çš„</code></p>
<hr />
<p><code>msvs</code></p>
<ul>
<li>å½“å­—ç¬¦ä¸²é•¿åº¦åœ¨16å­—ç¬¦ä»¥å†…æ—¶ï¼Œmsvså°†å­—ç¬¦ä¸²æ•°æ®ç›´æ¥å­˜å‚¨åœ¨ç¼“å†²åŒºï¼Œä¸å†ä½¿ç”¨<code>æŒ‡é’ˆ+ç¼“å†²åŒº</code>çš„å¤æ‚ç»“æ„</li>
<li>åœ¨<code>32</code>ä½ç³»ç»Ÿé‡Œï¼Œå­—ç¬¦ä¸²æœ€å°‘ä¼šå ç”¨24ä¸ªå­—èŠ‚</li>
<li>åœ¨<code>64</code>è‡³å°‘å ç”¨(16+8+8)32ä¸ªå­—èŠ‚</li>
</ul>
<p>åé¢çš„çœ‹ä¸å¤ªæ‡‚</p>
<p>ç­‰çœ‹å®Œäº†<code>C++Primer</code>å­¦å®Œå†çœ‹</p>
<h3 id="chap52-æ•°ç»„ä¸è´Ÿæ•°ç´¢å¼•"><a class="markdownIt-Anchor" href="#chap52-æ•°ç»„ä¸è´Ÿæ•°ç´¢å¼•"></a> Chap52 æ•°ç»„ä¸è´Ÿæ•°ç´¢å¼•</h3>
<ul>
<li>
<p><code>array[-1]</code>å®é™…ä¸Šè¡¨ç¤ºæ•°ç»„arrayèµ·å§‹åœ°å€ä¹‹å‰çš„å­˜å‚¨ç©ºé—´</p>
</li>
<li>
<p>x86å¹³å°çš„å°ç«¯å­—èŠ‚åºã€‚</p>
</li>
</ul>
<h3 id="chap53-16ä½windowsç¨‹åº"><a class="markdownIt-Anchor" href="#chap53-16ä½windowsç¨‹åº"></a> Chap53 16ä½windowsç¨‹åº</h3>
<p><em>è™½ç„¶16ä½çš„Windowsç¨‹åºå·²ç»è¿‘ä¹ç»è¿¹ï¼Œä½†æ˜¯æœ‰å…³å¤å¤ç¨‹åºä»¥åŠç ”ç©¶åŠ å¯†ç‹—çš„ç ”ç©¶ï¼Œå¾€å¾€ä¼šæ¶‰åŠè¿™éƒ¨åˆ†çŸ¥è¯†ã€‚</em></p>
<ul>
<li>
<p>16ä½åº”ç”¨ç¨‹åºçš„ä»£ç ç»“æ„ä¸<code>MSDOS</code>çš„ç¨‹åºååˆ†ç±»ä¼¼â€™,<code>è¿™ç§ç±»å‹çš„å¯æ‰§è¡Œæ–‡ä»¶é‡‡ç”¨äº†ä¸€ç§åä¸ºâ€œNew Executable (NE)â€çš„å¯æ‰§è¡Œç¨‹åºæ ¼å¼ã€‚</code>â€™</p>
</li>
<li>
<p>åŸºäºPascalè¯­è¨€çš„è°ƒç”¨çº¦å®šè¦æ±‚ï¼šå‚æ•°ä»å·¦è‡³å³å…¥æ ˆï¼ˆä¸cdeclç›¸åï¼‰ã€‚</p>
</li>
<li>
<p>16ä½åº”ç”¨ç¨‹åºçš„æŒ‡é’ˆæ˜¯ä¸€å¯¹æ•°æ®ï¼šå‡½æ•°é¦–å…ˆä¼ é€’çš„æ˜¯æ•°æ®æ®µçš„åœ°å€ï¼Œç„¶åå†ä¼ é€’æ®µå†…çš„æŒ‡é’ˆåœ°å€ã€‚</p>
</li>
<li>
<p>å½“16ä½ç³»ç»Ÿï¼ˆMSDOSå’ŒWin16ï¼‰ä¼ é€’longå‹32ä½â€œé•¿â€æ•°æ®æ—¶ï¼ˆè¿™ç§å¹³å°ä¸Šçš„intå‹æ•°æ®æ˜¯16ä½æ•°æ®ï¼‰ï¼Œå®ƒä¼šå°†32ä½æ•°æ®æ‹†æˆ2ä¸ª16ä½æ•°æ®ã€æˆå¯¹ä¼ é€’ã€‚</p>
</li>
<li>
<p>åœ¨è¿”å›å‡½æ•°å€¼çš„æ—¶å€™ï¼Œ32ä½çš„è¿”å›å€¼é€šè¿‡DXï¼šAXå¯„å­˜å™¨å¯¹å›ä¼ ã€‚</p>
</li>
<li>
<p>â€œnearâ€æŒ‡é’ˆçš„å¯»å€ç©ºé—´æ˜¯å½“å‰æ•°æ®æ®µï¼ˆDSï¼‰å†…çš„æ‰€æœ‰åœ°å€ã€‚</p>
</li>
<li>
<p>â€œfarâ€æŒ‡é’ˆçš„å¯»å€ç©ºé—´ä¸é™äºå½“å‰æ•°æ®æ®µï¼Œå®ƒå¯ä»¥æ˜¯å…¶ä»–DSæ®µçš„å†…å­˜åœ°å€ã€‚ç”±äºéœ€è¦æŒ‡å®šåŸºï¼ˆæ®µï¼‰åœ°å€ï¼Œæ‰€ä»¥2ä¸ª16ä½æ•°æ®æ‰èƒ½è¡¨ç¤º1ä¸ªfarå‹æŒ‡é’ˆã€‚</p>
</li>
</ul>
<h3 id="chap54-java"><a class="markdownIt-Anchor" href="#chap54-java"></a> Chap54* Java</h3>
<p>å…ˆç•¥</p>
<h2 id="part5-åœ¨ä»£ç ä¸­å‘ç°æœ‰è¶£çš„å†…å®¹"><a class="markdownIt-Anchor" href="#part5-åœ¨ä»£ç ä¸­å‘ç°æœ‰è¶£çš„å†…å®¹"></a> Part.5 åœ¨ä»£ç ä¸­å‘ç°æœ‰è¶£çš„å†…å®¹</h2>
<h3 id="chap55ç¼–è¯‘å™¨äº§ç”Ÿçš„æ–‡ä»¶ç‰¹å¾"><a class="markdownIt-Anchor" href="#chap55ç¼–è¯‘å™¨äº§ç”Ÿçš„æ–‡ä»¶ç‰¹å¾"></a> Chap55ç¼–è¯‘å™¨äº§ç”Ÿçš„æ–‡ä»¶ç‰¹å¾</h3>
<h4 id="microsoft-visual-c"><a class="markdownIt-Anchor" href="#microsoft-visual-c"></a> Microsoft Visual C++</h4>
<p>msvcp*.dllå«æœ‰C<ins>ç›¸å…³å‡½æ•°ï¼Œå› æ­¤å¯¼å…¥è¿™äº›DLLæ–‡ä»¶çš„å¯æ‰§è¡Œç¨‹åºå¾ˆå¯èƒ½æ˜¯C</ins>ç¨‹åºã€‚</p>
<p>å‘½åè§„åˆ™</p>
<p>msvsåå­—é€šå¸¸éƒ½æ˜¯ä»¥â€œ?â€å¼€å§‹çš„ã€‚</p>
<h4 id="gcc-2"><a class="markdownIt-Anchor" href="#gcc-2"></a> gcc</h4>
<p>gccå‘½åé€šå¸¸ä»¥ç¬¦å·â€œ_Zâ€å¼€å§‹ã€‚</p>
<p>GCCåœ¨Cygwinç¯å¢ƒä¸‹ç¼–è¯‘çš„åº”ç”¨ç¨‹åºï¼Œé€šå¸¸ä¼šå¯¼å…¥cygwin1.dllæ–‡ä»¶ã€‚</p>
<p>GCCåœ¨mingwç¯å¢ƒä¸‹ç¼–è¯‘çš„åº”ç”¨ç¨‹åºï¼Œå¯èƒ½ä¼šå¯¼å…¥msvcrt.dllæ–‡ä»¶ã€‚</p>
<h4 id="intel-fortran"><a class="markdownIt-Anchor" href="#intel-fortran"></a> intel fortran</h4>
<p>ç”±Intel Fortranç¼–è¯‘çš„åº”ç”¨ç¨‹åºï¼Œå¯èƒ½ä¼šå¯¼å…¥ä»¥ä¸‹3ä¸ªæ–‡ä»¶ï¼š</p>
<p>â‘  Libifcoremd.dllã€‚</p>
<p>â‘¡ Libifportmd.dllã€‚</p>
<p>â‘¢ Libiomp5.dllï¼ˆæ”¯æŒOpenMPï¼‰ã€‚</p>
<p>åº“æ–‡ä»¶libifcoremd.dllå®šä¹‰äº†å¾ˆå¤šä»¥å­—ç¬¦ä¸²â€œfor_â€å¼€å¤´çš„å‡½æ•°ã€‚å®ƒå°±æ˜¯FORTRANçš„ä»£è¡¨æ€§å‰ç¼€ã€‚</p>
<h4 id="watcomå’Œopenwatcom"><a class="markdownIt-Anchor" href="#watcomå’Œopenwatcom"></a> watcomå’Œopenwatcom</h4>
<p>ç”±Watcomç¼–è¯‘å‡ºæ¥çš„ç¨‹åºï¼Œå…¶ç¬¦å·åç§°é€šå¸¸ä»¥â€œWâ€å­—æ¯å¼€å¤´ã€‚</p>
<p>ä»¥W?method<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow></mrow><mi>c</mi></msub><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">_class</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span></span></span></span>n__vä¸ºä¾‹ï¼šå¤§å†™å­—æ¯Wå¼€å¤´ä»£è¡¨å®ƒæ˜¯Watcomç¼–è¯‘å‡ºæ¥çš„ç¨‹åºï¼Œæ–¹æ³•çš„åç§°ä¸ºmethodï¼Œç±»çš„åç§°ä¸ºclassï¼Œæ²¡æœ‰å‚æ•°ä¸”æ— è¿”å›å€¼çš„voidæ–¹æ³•ä¼šå‘½åä¸ºï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">W<span class="token operator">?</span>method$_class$n__v<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="borland"><a class="markdownIt-Anchor" href="#borland"></a> borland</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">@TApplication@IdleAction$qv
@TApplication@ProcessMDIAccels$qp6tagMSG
@TModule@$bctr$qpcpvt1
@TModule@$bdtr$qv
@TModule@ValidWindow$qp14TWindowsObject
@TrueColorTo8BitN$qpviiiiiit1iiiiii
@TrueColorTo16BitN$qpviiiiiit1iiiiii
@DIB24BitTo8BitBitmap$qpviiiiiit1iiiii
@TrueBitmap@$bctr$qpcl
@TrueBitmap@$bctr$qpvl
@TrueBitmap@$bctr$qiilll<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>ç¬¦å·åç§°å¿…å®šä»¥å­—ç¬¦â€œ@â€å¼€å¤´</li>
<li>åé¢å‡ ä¸ªå­—æ¯åˆ†åˆ«ä»£è¡¨ï¼šç±»åç§°ã€æ–¹æ³•åç§°ä»¥åŠæ–¹æ³•çš„å‚æ•°ç±»å‹ã€‚</li>
<li>VCLçš„å…¨ç§°æ˜¯Borland Visual Component Librariesï¼Œæ„æ€æ˜¯Borlandçš„å¯è§†åŒ–ç»„ä»¶åº“ã€‚å®ƒä»¬ä¿å­˜åœ¨bplæ–‡ä»¶ä¸­ï¼Œè€Œä¸æ˜¯ä¿å­˜åœ¨dllæ–‡ä»¶ä¸­ã€‚æ¯”å¦‚è¯´æ–‡ä»¶vcl50.dllå’Œrtl60.dllã€‚</li>
</ul>
<h4 id="delphi"><a class="markdownIt-Anchor" href="#delphi"></a> delphi</h4>
<p>æ•°æ®æ®µï¼ˆDATAï¼‰çš„å¤´å››ä¸ªå­—èŠ‚é€šå¸¸æ˜¯ä»¥ä¸‹ä¸‰ä¸ªç»„åˆä¸­çš„ä¸€ä¸ªä»»æ„ä¸€ä¸ªï¼š00 00 00 00ã€32 13 8B C0æˆ–è€…FF FF FF FFã€‚åœ¨å¤„ç†è¢«å‹ç¼©æˆ–è€…è¢«åŠ å¯†çš„Dephiå¯æ‰§è¡Œæ–‡ä»¶æ—¶ï¼Œè¿™ç»„å¸¸æ•°å°±ä¼šå…·æœ‰æŒ‡æ ‡æ€§æ„ä¹‰ã€‚</p>
<h4 id="å…¶ä»–çš„dll"><a class="markdownIt-Anchor" href="#å…¶ä»–çš„dll"></a> å…¶ä»–çš„dll</h4>
<ul>
<li>Vcomp*.dllã€‚å¾®è½¯ç”¨æ¥å®ç°OpenMPçš„æ–‡ä»¶ã€‚</li>
</ul>
<h3 id="chap56win32ç¯å¢ƒä¸å¤–éƒ¨é€šä¿¡"><a class="markdownIt-Anchor" href="#chap56win32ç¯å¢ƒä¸å¤–éƒ¨é€šä¿¡"></a> Chap56Win32ç¯å¢ƒä¸å¤–éƒ¨é€šä¿¡</h3>
<ul>
<li>
<p>åœ¨äº†è§£å‡½æ•°çš„è¾“å…¥è¾“å‡ºçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥æ¨ç†å‡ºå‡½æ•°çš„å…·ä½“åŠŸèƒ½ï¼Œè¿™æ˜¯ä¸€ç§æœ‰æ•ˆçš„åˆ†ææ–¹æ³•</p>
</li>
<li>
<p>å…³æ³¨æ–‡ä»¶å’Œæ³¨å†Œè¡¨å±‚é¢çš„è¡Œä¸ºï¼Œå¯ä»¥ä½¿ç”¨<code>Process Monitor</code></p>
</li>
<li>
<p>æŸ¥çœ‹ç½‘ç»œå±‚é¢çš„é€šä¿¡æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨<code>WireShark</code></p>
</li>
<li>
<p>è¿›ä¸€æ­¥åˆ†æè¡Œä¸ºçº§æ•°æ®ï¼Œå°±è¦æ·±å…¥ç¨‹åºå†…éƒ¨æŒ–æ˜æŒ‡ä»¤å±‚é¢çš„ä¿¡æ¯</p>
<ol>
<li>
<p>é¦–å…ˆè°ƒæŸ¥è¯¥ç¨‹åºè°ƒç”¨çš„æ“ä½œç³»ç»ŸAPIå’Œæ ‡å‡†åº“å‡½æ•°</p>
</li>
<li>
<p>å¦‚æœç›®æ ‡ç¨‹åºç”±å¯æ‰§è¡Œæ–‡ä»¶å’Œå¤šä¸ªDLLæ–‡ä»¶æ„æˆ</p>
<p>é‚£ä¹ˆç”±è¿™äº›DLLæ–‡ä»¶æ‰€æä¾›çš„ï¼Œå¯è°ƒç”¨çš„å‡½æ•°åç§°å°±å¯ä»¥æä¾›å¾ˆå¤§å¸®åŠ©</p>
</li>
<li>
<p>å¦‚æœåªå…³å¿ƒè°ƒç”¨<code>MessageBox()</code>æ˜¾ç¤ºç‰¹å®šæ–‡å­—çš„æŒ‡ä»¤</p>
</li>
<li>
<p>å¯ä»¥åœ¨ç¨‹åºçš„æ•°æ®æ®µæ£€ç´¢æ–‡å­—å­—ç¬¦ï¼Œç„¶åäº¤å‰å¼•ç”¨ï¼Œåˆ°è¾¾å…³é”®ä»£ç æ®µ</p>
</li>
</ol>
</li>
<li>
<p>åˆ†æç”µè„‘æ¸¸æˆæ—¶ï¼Œå¦‚æœå¯ä»¥ç¡®å®šç‰¹å®šå…³å¡é‡Œå‡ºç°çš„ä½äººæ€»æ•°æ˜¯éšæœºæ•°ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥æ‰¾<code>rand()</code>ä»¥åŠç±»ä¼¼çš„éšæœºæ•°ç”Ÿæˆå‡½æ•°ï¼Œç„¶åäº¤å‰å¼•ç”¨æ‰¾åˆ°ä½¿ç”¨éšæœºæ•°çš„æŒ‡ä»¤</p>
</li>
<li>
<p>ç”µè„‘æ¸¸æˆä»¥å¤–ï¼Œå¦‚æœä½¿ç”¨äº†<code>rand()</code>å¯èƒ½æ˜¯ åŠ å¯†ç®—æ³•</p>
</li>
</ul>
<h4 id="å¸¸ç”¨windowsapi"><a class="markdownIt-Anchor" href="#å¸¸ç”¨windowsapi"></a> å¸¸ç”¨WindowsAPI</h4>
<ul>
<li>
<p>æ³¨å†Œè¡¨çš„æ“ä½œå¯ä»¥é€šè¿‡åº“æ–‡ä»¶advspi32.dllçš„å¦‚ä¸‹åŠŸèƒ½å®ç°ï¼šRegEnumKeyExã€RegEnumValueã€RegGetValueã€RegOpenKeyExå’ŒRegQueryValueExã€‚</p>
</li>
<li>
<p>å¯¹ç±»ä¼¼iniçš„æ–‡æœ¬æ–‡ä»¶å¯ä»¥é€šè¿‡åº“æ–‡ä»¶user32.dllçš„å¦‚ä¸‹å‡½æ•°å®ç°ï¼šGetPrivateProfileStringã€‚</p>
</li>
<li>
<p>å¯¹è¯çª—çš„æ“ä½œé€šè¿‡åº“æ–‡ä»¶user32.dllçš„å¦‚ä¸‹å‡½æ•°å®ç°ï¼šMessageBoxExã€SetDlgItemTextåŠGetDlgItemTextã€‚</p>
</li>
<li>
<p>å¯¹èµ„æºçš„æ“ä½œï¼ˆå¯ä»¥å‚è€ƒæœ¬ä¹¦çš„68.2.8èŠ‚ï¼‰é€šè¿‡åº“æ–‡ä»¶user32.dllçš„å‡½æ•°LoadMenuå®ç°ã€‚</p>
</li>
<li>
<p>å¯¹TCP/IPç½‘ç»œçš„æ“ä½œæ˜¯é€šè¿‡åº“æ–‡ä»¶ws2_32.dllçš„å¦‚ä¸‹å‡½æ•°å®ç°ï¼šWSARecvå’ŒWSASendã€‚</p>
</li>
<li>
<p>å¯¹æ–‡ä»¶çš„æ“ä½œæ˜¯é€šè¿‡åº“æ–‡ä»¶kernel32.dllçš„å¦‚ä¸‹å‡½æ•°å®ç°ç›¸åº”çš„æ“ä½œï¼šCreateFileã€ReadFileã€ReadFileExã€WriteFileåŠWriteFileExç­‰ã€‚</p>
</li>
<li>
<p>è®¿é—®Internetæ˜¯é€šè¿‡åº“æ–‡ä»¶wininet.dllçš„WinHttpOpenç­‰å‡½æ•°æ¥å®ç°ç›¸å…³åŠŸèƒ½çš„ã€‚</p>
</li>
<li>
<p>æ£€æŸ¥ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶æ˜¯å¦å«æœ‰æ•°å­—ç­¾ååˆ™æ˜¯é€šè¿‡åº“æ–‡ä»¶wintrust.dllçš„å‡½æ•°WinVerifyTrustç­‰æ¥å®ç°çš„ã€‚</p>
</li>
<li>
<p>å¦‚æœæ˜¯åŠ¨æ€é“¾æ¥çš„è¯ï¼Œæ ‡å‡†çš„MSVCåº“æ–‡ä»¶msvcr*.dllæ˜¯é€šè¿‡ä»¥ä¸‹å‡½æ•°å®ç°ç›¸å…³æ“ä½œçš„ï¼šassertã€itoaã€ltoaã€openã€printfã€readã€strcmpã€atolã€atoiã€fopenã€freadã€fwriteã€memcmpã€randã€strlenã€strsträ»¥åŠstrchrã€‚</p>
</li>
</ul>
<h3 id="chap57å­—ç¬¦ä¸²"><a class="markdownIt-Anchor" href="#chap57å­—ç¬¦ä¸²"></a> Chap57å­—ç¬¦ä¸²</h3>
<p>UTF-16LE</p>
<p>å¾ˆå¤šWindowsç³»ç»Ÿä¸‹çš„win32å‡½æ•°æœ‰-Aå’Œ-Wåç¼€ã€‚å‰é¢è¿™ç§å‡½æ•°ç”¨äºå¤„ç†å¸¸è§„å­—ç¬¦ä¸²ï¼Œè€Œåé¢è¿™ç§å¸¦æœ‰-wçš„å‡½æ•°åˆ™æ˜¯UTF-16LEå­—ç¬¦ä¸²çš„ä¸“ç”¨å‡½æ•°ï¼ˆwä»£è¡¨wideï¼‰ã€‚</p>
<h3 id="chap58-assert"><a class="markdownIt-Anchor" href="#chap58-assert"></a> Chap58 assert()</h3>
<p>ä¸€èˆ¬æ¥è®²ï¼Œassert()å®åœ¨å¯æ‰§è¡Œæ–‡ä»¶ä¸­ä¿ç•™äº†æºä»£ç çš„æ–‡ä»¶åã€è¡Œæ•°ä»¥åŠæ‰§è¡Œæ¡ä»¶ã€‚</p>
<p>æœ€æœ‰ä»·å€¼çš„ä¿¡æ¯æ˜¯assert()å®çš„æ‰§è¡Œæ¡ä»¶ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å®ƒä»¬æ¥æ¨æ–­å‡ºå˜é‡åæˆ–è€…ç»“æ„ä½“çš„å­—æ®µåç§°ã€‚å¦å¤–ä¸€ä¸ªæœ‰ç”¨çš„ä¿¡æ¯æ˜¯æ–‡ä»¶åï¼Œé€šè¿‡å®ƒæˆ‘ä»¬å¯ä»¥æ¨æ–­å‡ºæºä»£ç æ˜¯é‡‡ç”¨ä»€ä¹ˆè¯­è¨€ç¼–å†™çš„ã€‚åŒæ—¶æˆ‘ä»¬è¿˜å¯èƒ½é€šè¿‡æ–‡ä»¶åæ¥è¯†åˆ«å‡ºå…¶æ˜¯å¦é‡‡ç”¨äº†çŸ¥åçš„å¼€æ”¾æºä»£ç åº“ã€‚</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token label function">.text:</span>107D4B29   mov    <span class="token register variable">dx</span>, <span class="token operator">[</span><span class="token register variable">ecx</span><span class="token operator">+</span><span class="token number">42h</span><span class="token operator">]</span>
<span class="token label function">.text:</span>107D4B2D   cmp    <span class="token register variable">edx</span>, <span class="token number">1</span>
<span class="token label function">.text:</span>107D4B30   jz     short loc_107D4B4A
<span class="token label function">.text:</span>107D4B32   push   <span class="token number">1ECh</span>
<span class="token label function">.text:</span>107D4B37   push   offset aWrite_c <span class="token comment">; "write.c"</span>
<span class="token label function">.text:</span>107D4B3C   push   offset aTdTd_planarcon <span class="token comment">; "td->td_planarconfig == PLANARCONFIG_CON"...</span>
<span class="token label function">.text:</span>107D4B41   call   <span class="token register variable">ds</span>:_assert

...

<span class="token label function">.text:</span>107D52CA   mov    <span class="token register variable">edx</span>, <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">]</span>
<span class="token label function">.text:</span>107D52CD   and    <span class="token register variable">edx</span>, <span class="token number">3</span>
<span class="token label function">.text:</span>107D52D0   test   <span class="token register variable">edx</span>, <span class="token register variable">edx</span>
<span class="token label function">.text:</span>107D52D2   jz     short loc_107D52E9
<span class="token label function">.text:</span>107D52D4   push   <span class="token number">58h</span>
<span class="token label function">.text:</span>107D52D6   push   offset aDumpmode_c <span class="token comment">; "dumpmode.c"</span>
<span class="token label function">.text:</span>107D52DB   push   offset aN30    <span class="token comment">; "(n &amp; 3) == 0"</span>
<span class="token label function">.text:</span>107D52E0   call   <span class="token register variable">ds</span>:_assert

...

<span class="token label function">.text:</span>107D6759   mov    <span class="token register variable">cx</span>, <span class="token operator">[</span><span class="token register variable">eax</span><span class="token operator">+</span><span class="token number">6</span><span class="token operator">]</span>
<span class="token label function">.text:</span>107D675D   cmp    <span class="token register variable">ecx</span>, <span class="token number">0Ch</span>
<span class="token label function">.text:</span>107D6760   jle    short loc_107D677A
<span class="token label function">.text:</span>107D6762   push   <span class="token number">2D8h</span>
<span class="token label function">.text:</span>107D6767   push   offset aLzw_c    <span class="token comment">; "lzw.c"</span>
<span class="token label function">.text:</span>107D676C   push   offset aSpLzw_nbitsBit <span class="token comment">; "sp->lzw_nbits &lt;= BITS_MAX"</span>
<span class="token label function">.text:</span>107D6771   call   <span class="token register variable">ds</span>:_assert<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æœ€ç®€å•çš„åˆ†ææ–¹æ³•å°±æ˜¯ç”¨googleæ¥æœç´¢æ¡ä»¶å’Œæ–‡ä»¶åã€‚æœç´¢ç»“æœæ˜¾ç¤ºè¿™ä¸å¼€æºçš„åº“æ–‡ä»¶æœ‰å…³ã€‚æ¯”å¦‚è¯´ï¼Œæœç´¢å­—ç¬¦ä¸²â€œsp-&gt;lzw_nbits &lt;= BITS_MAXâ€ï¼Œæˆ‘ä»¬å°±å®ƒä¸å‹ç¼©ç®—æ³•LZWçš„å¼€æºä»£ç ç›¸å…³ã€‚</p>
<h3 id="chap59-å¸¸æ•°"><a class="markdownIt-Anchor" href="#chap59-å¸¸æ•°"></a> Chap59 å¸¸æ•°</h3>
<p>ä»äºŒè¿›åˆ¶å±‚é¢æ¥çœ‹ï¼Œæ›´ä¸ºå¸¸ç”¨çš„æ•´æ•°åˆ™æ˜¯0xAAAAAAAAï¼ˆ1010101010101010ï¼‰å’Œ0x55555555 ï¼ˆ0101010101010101ï¼‰è¿™ç±»ç‰¹å¾æ˜æ˜¾çš„å¸¸é‡ã€‚ä»¥å¸¸æ•°0x55AAä¸ºä¾‹ï¼šå¼•å¯¼æ‰‡åŒºã€ä¸»å¼•å¯¼æ‰‡åŒºMBRä»¥åŠIBMå…¼å®¹æ‰©å±•å¡çš„ROMï¼ˆåªè¯»å­˜å‚¨å•å…ƒï¼‰ç­‰å…³é”®æ•°æ®éƒ½ä¼šä½¿ç”¨è¿™ä¸ªå¸¸é‡ã€‚</p>
<p>ä¸€äº›ç®—æ³•ï¼Œç‰¹åˆ«æ˜¯æŸäº›åŠ å¯†ç®—æ³•ï¼Œå¸¸å¸¸ä½¿ç”¨æŸäº›ç‰¹æ®Šçš„å¸¸æ•°ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨è°ƒè¯•å·¥å…·IDAå°±èƒ½å¾ˆå®¹æ˜“å‘ç°è¿™ä¸€ç‚¹ã€‚</p>
<p>ä»¥MD5ç®—æ³•ä¸ºä¾‹ï¼Œå…¶å†…éƒ¨å˜é‡åˆå§‹å€¼åˆ†åˆ«æ˜¯ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">var <span class="token keyword">int</span> h0 <span class="token operator">:</span><span class="token operator">=</span> <span class="token number">0x67452301</span>
var <span class="token keyword">int</span> h1 <span class="token operator">:</span><span class="token operator">=</span> <span class="token number">0xEFCDAB89</span>
var <span class="token keyword">int</span> h2 <span class="token operator">:</span><span class="token operator">=</span> <span class="token number">0x98BADCFE</span>
var <span class="token keyword">int</span> h3 <span class="token operator">:</span><span class="token operator">=</span> <span class="token number">0x10325476</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¦å¤–çš„ä¾‹å­åˆ™æ˜¯CRC16/32çš„ç®—æ³•ï¼Œå…¶é¢„ç½®çš„å¸¸æ•°è¡¨ç»å¸¸å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/** CRC table for the CRC-16. The poly is 0x8005 (x^16 + x^15 + x^2 + 1) */</span>
u16 <span class="token keyword">const</span> crc16_table<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token number">0x0000</span><span class="token punctuation">,</span> <span class="token number">0xC0C1</span><span class="token punctuation">,</span> <span class="token number">0xC181</span><span class="token punctuation">,</span> <span class="token number">0x0140</span><span class="token punctuation">,</span> <span class="token number">0xC301</span><span class="token punctuation">,</span> <span class="token number">0x03C0</span><span class="token punctuation">,</span> <span class="token number">0x0280</span><span class="token punctuation">,</span> <span class="token number">0xC241</span><span class="token punctuation">,</span>
        <span class="token number">0xC601</span><span class="token punctuation">,</span> <span class="token number">0x06C0</span><span class="token punctuation">,</span> <span class="token number">0x0780</span><span class="token punctuation">,</span> <span class="token number">0xC741</span><span class="token punctuation">,</span> <span class="token number">0x0500</span><span class="token punctuation">,</span> <span class="token number">0xC5C1</span><span class="token punctuation">,</span> <span class="token number">0xC481</span><span class="token punctuation">,</span> <span class="token number">0x0440</span><span class="token punctuation">,</span>
        <span class="token number">0xCC01</span><span class="token punctuation">,</span> <span class="token number">0x0CC0</span><span class="token punctuation">,</span> <span class="token number">0x0D80</span><span class="token punctuation">,</span> <span class="token number">0xCD41</span><span class="token punctuation">,</span> <span class="token number">0x0F00</span><span class="token punctuation">,</span> <span class="token number">0xCFC1</span><span class="token punctuation">,</span> <span class="token number">0xCE81</span><span class="token punctuation">,</span> <span class="token number">0x0E40</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p>å¾ˆå¤šæ–‡ä»¶åœ¨æ–‡ä»¶å¤´ä½¿ç”¨ç‰¹å®šçš„é­”æ•°æ¥è¡¨ç¤ºå…¶æ–‡ä»¶æ ¼å¼ï¼Œè¿™äº›<code>magicNumber</code>å¯ä»¥æ˜¯ä¸€ä¸ªæˆ–è€…å¤šä¸ªå­—èŠ‚çš„ç»„åˆ</p>
</li>
<li>
<p>æ ‡å‡†çš„MIDIæ–‡ä»¶åˆ™å¿…é¡»ä»¥â€œMThdâ€è¿™4ä¸ªå­—ç¬¦å¼€å¤´ã€‚</p>
</li>
<li>
<p>å½“ç„¶ï¼Œæ•°æ®æ¯”è¾ƒå‡½æ•°åŒæ ·å¯ä»¥ç”¨æ¥éªŒè¯æ–‡ä»¶å¤´ä¸­çš„é­”æ•°ã€‚å¸¸ç”¨çš„å‡½æ•°æœ‰ï¼šæ¯”è¾ƒå†…å­˜å—çš„memcmp()å‡½æ•°ï¼Œæˆ–è€…CMPSBä¸€ç±»çš„æ¯”è¾ƒæŒ‡ä»¤ï¼ˆå¯ä»¥å‚è€ƒæœ¬ä¹¦é™„å½•A.6.3ï¼‰</p>
<p><code>ä¸€æ—¦å‘ç°æŸä¸ªç¨‹åºå¼€å§‹æ£€æµ‹å…¶ä»–æ–‡ä»¶çš„é­”æ•°æ ‡è¯†ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç¡®ä¿¡å®ƒå·²ç»åŠ è½½äº†æŸç§ç±»å‹çš„ç›®æ ‡æ–‡ä»¶ã€‚</code>ä¸æ­¢å¦‚æ­¤ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è§£è¯»å‡ºæ–‡ä»¶æ“ä½œçš„ç¼“å†²åŒºä»¥åŠå®ƒä½¿ç”¨ç¼“å†²åŒºçš„æ–¹å¼æ–¹æ³•ç­‰ä¿¡æ¯ã€‚</p>
</li>
<li>
<p>ç½‘ç»œåè®®åŒæ ·ä½¿ç”¨äº†é­”æœ¯ã€‚æ¯”å¦‚ï¼ŒDHCPåè®®çš„ç½‘ç»œæ•°æ®å°±ä¼šç”¨åˆ°é­”æ•°0x63538263â€”è¿™ä¸ªé­”æ•°å«åšmagic cookieã€‚æ‰€æœ‰ç¬¦åˆDHCPåè®®çš„æ•°æ®åŒ…éƒ½å¿…é¡»ä½¿ç”¨è¿™ä¸ªé­”æ•°ã€‚</p>
<p>æˆ‘ä»¬ä»¥Windows 7æ“ä½œç³»ç»Ÿï¼ˆ64ä½æ“ä½œç³»ç»Ÿï¼‰ä¸­çš„æ–‡ä»¶dhcpcore.dllæ–‡ä»¶ä¸ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­æœç´¢è¿™ä¸ªé­”æ•°ã€‚ç»“æœå‘ç°äº†2æ¬¡ï¼Œå‡ºç°åœ¨ä¸¤ä¸ªå‡½æ•°ä¸­ï¼Œå…¶åç§°åˆ†åˆ«æ˜¯DhcpExtractOptionsForValidation()å’Œand DhcpExtractFullOptions()ã€‚</p>
</li>
</ul>
<p>åœ¨å•ä¸ªæ–‡ä»¶é‡Œæœç´¢å¸¸æ•°æ—¶ï¼Œå¯ä»¥ä½¿ç”¨IDAçš„æœç´¢åŠŸèƒ½ã€‚å…¶å¿«æ·é”®æ˜¯ALT-Bæˆ–ALT-Iã€‚</p>
<h3 id="chap60æ£€ç´¢å…³é”®æŒ‡ä»¤"><a class="markdownIt-Anchor" href="#chap60æ£€ç´¢å…³é”®æŒ‡ä»¤"></a> Chap60æ£€ç´¢å…³é”®æŒ‡ä»¤</h3>
<p>å¦‚æœä¸€ä¸ªç¨‹åºä½¿ç”¨äº†ä¸ºæ•°ä¸å¤šçš„FPUï¼ˆFloat Point Unitï¼Œæµ®ç‚¹è¿ç®—å•å…ƒï¼‰æŒ‡ä»¤ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é‡‡ç”¨äººå·¥æ’æŸ¥çš„æ–¹å¼æŠŠå®ƒä»¬é€ä¸€ç­›é€‰å‡ºæ¥ã€‚</p>
<p>é¦–å…ˆè¦ç”¨IDAåŠ è½½Office 2010é‡Œçš„excel.exeï¼ˆæœ¬ç« ä»¥ç‰ˆæœ¬å·ä¸º14.0.4756.1000çš„excelä¸ºä¾‹ï¼‰ï¼Œç„¶åç”Ÿæˆå®Œæ•´çš„æŒ‡ä»¤æ¸…å•å¹¶å°†å…¶ä¿å­˜ä¸ºåç¼€åä¸º.lstçš„æ–‡æœ¬æ–‡ä»¶ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨ç»ˆç«¯æŒ‡ä»¤æ£€ç´¢æŒ‡ä»¤æ¸…å•ä¸­çš„å…¨éƒ¨FDIVæŒ‡ä»¤ï¼ˆFloationg Point Divideï¼Œæµ®ç‚¹æ•°é™¤æ³•ï¼‰ã€‚ä¸¥æ ¼è¯´æ¥ï¼Œä½¿ç”¨grepä¸èƒ½æ£€ç´¢å‡ºå…¨éƒ¨çš„æµ®ç‚¹æ•°é™¤æ³•è¿ç®—æŒ‡ä»¤ã€‚å¦‚æœé™¤æ•°æ˜¯å¸¸é‡ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨å°±ä¸å¤ªå¯èƒ½åˆ†é…FDIVæŒ‡ä»¤ã€‚å½“ç„¶è¿™ç§ç‰¹ä¾‹ä¸åœ¨æˆ‘ä»¬çš„ç ”ç©¶èŒƒå›´ä¹‹å†…ã€‚</p>
<pre class="line-numbers language-none"><code class="language-none">cat EXCEL.lst | grep fdiv | grep -v dbl_ &gt; EXCEL.fdiv<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>ç„¶åï¼Œæˆ‘ä»¬åœ¨Excelé‡Œè¾“å…¥è®¡ç®—å…¬å¼â€œ=(1/3)â€ï¼Œå¹¶æ£€æŸ¥æ¯ä¸ªæŒ‡ä»¤çš„è¿è¡Œç»“æœã€‚</p>
<p>åœ¨è°ƒè¯•å™¨ï¼ˆæˆ–tracerï¼‰é‡Œé€ä¸€æ’æŸ¥é™¤æ³•è¿ç®—æŒ‡ä»¤ä»¥åï¼Œæˆ‘ä»¬å¹¸è¿åœ°å‘ç°åœ¨ç¬¬14ä¸ªFDIVæŒ‡ä»¤å°±æ˜¯æˆ‘ä»¬è¦æ‰¾çš„æŒ‡ä»¤ï¼š</p>
<h3 id="chap61å¯ç–‘ä»£ç æ¨¡å‹"><a class="markdownIt-Anchor" href="#chap61å¯ç–‘ä»£ç æ¨¡å‹"></a> Chap61å¯ç–‘ä»£ç æ¨¡å‹</h3>
<ul>
<li>
<p>XOR op,opæˆ–XOR EAX,EAX é€šå¸¸ç”¨æ¥å°†æŸä¸ªå¯„å­˜å™¨æ¸…é›¶</p>
<p>å½“ä¸¤ä¸ªæ“ä½œæ•°ä¸åŒæ‰å½“åšå¼‚æˆ–ã€‚å¾€å¾€åœ¨åŠ å¯†ç®—æ³•ä¸­æ¯”è¾ƒå¸¸è§</p>
</li>
<li>
<p>æ‰‹å†™æ±‡ç¼–</p>
<p>å½“å‰çš„ç¼–è¯‘å™¨éƒ½ä¸ä¼šåˆ†é…å¾ªç¯æŒ‡ä»¤LOOPå’Œä½ç§»å¾ªç¯æŒ‡ä»¤RCLã€‚</p>
<p>æ‰‹å†™çš„æ±‡ç¼–ç¨‹åºå¾ˆå°‘ä¼šå…·å¤‡å®Œæ•´çš„å‡½æ•°å¼€å¤´å’Œå‡½æ•°ç»“å°¾ã€‚</p>
<p>é€šå¸¸æ¥è¯´ï¼Œäººå·¥æ‰‹å†™çš„ç¨‹åºæ²¡æœ‰å›ºå®šçš„å‚æ•°ä¼ é€’æ–¹æ³•ã€‚</p>
</li>
</ul>
<h3 id="chap62-é­”æ•°å­—ä¸ç¨‹åºè°ƒè¯•"><a class="markdownIt-Anchor" href="#chap62-é­”æ•°å­—ä¸ç¨‹åºè°ƒè¯•"></a> Chap62 é­”æ•°å­—ä¸ç¨‹åºè°ƒè¯•</h3>
<p><mark>å‘å·¥ç¨‹çš„ä¸»è¦ç›®æ ‡ç†è§£ç¨‹åºå¤„ç†æ•°æ®çš„å…·ä½“æ–¹æ³•</mark></p>
<p>æ‰‹å·¥è·Ÿè¸ªä¸€ä¸ªå€¼å¾€å¾€æ˜¯ä¸€é¡¹éå¸¸åŠ³ç¥è´¹åŠ›çš„äº‹æƒ…ã€‚ä¸ºäº†å®Œæˆè¿™ä¸ªä»»åŠ¡ï¼Œä¸€ä¸ªæœ€ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨è‡ªå·±çš„ç‰¹æœ‰é­”æ•°ï¼Œè™½ç„¶è¿™ä¸ªåŠæ³•ä¸æ˜¯ç™¾åˆ†ä¹‹ç™¾å¯é ã€‚</p>
<p>é­”æ•°è¦å°½é‡â€œæ‰“çœ¼â€(å®¹æ˜“è§‚å¯Ÿåˆ°)ã€‚åœ¨è§‚æµ‹32ä½æ•°æ®æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å°†é­”æ•°è®¾ç½®ä¸º0x0BADF00Dï¼ˆBADFOODï¼‰</p>
<p>æ¥ç€ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨tracerçš„ä»£ç è¦†ç›–ç‡æ¨¡å¼ï¼ˆcode coverage/ccæ¨¡å¼ï¼‰è·Ÿè¸ªç¨‹åºï¼Œå†åˆ©ç”¨grepæˆ–è€…ç›´æ¥æœç´¢æ–‡æœ¬æ–‡ä»¶ï¼ˆè·Ÿè¸ªç»“æœçš„æ–‡æœ¬æ–‡ä»¶ï¼‰ï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿå¾ˆå®¹æ˜“åœ°å‘ç°è¿™äº›å€¼çš„è°ƒç”¨ç‚¹åŠå¤„ç†æ–¹æ³•ã€‚</p>
<p>ä¹Ÿè®¸0xdeadbeef  ä¸é”™</p>
<h3 id="chap63-otherthing"><a class="markdownIt-Anchor" href="#chap63-otherthing"></a> Chap63 Otherthing</h3>
<ul>
<li>
<p>é€†å‘å·¥ç¨‹äººå‘˜åº”å½“å°½å¯èƒ½åœ°ä»¥ç¼–ç¨‹äººå‘˜çš„è§’åº¦æ¥åˆ†æé—®é¢˜ã€‚è¦ç†è§£ä»–ä»¬çš„è§‚ç‚¹ã€å¹¶ä¸”æ—¶å¸¸æ‰ªå¿ƒè‡ªé—®ï¼šå¦‚æœè‡ªå·±æ˜¯ç¼–ç¨‹äººå‘˜çš„è¯ï¼Œè‡ªå·±ä¼šå¦‚ä½•è®¾è®¡ç¨‹åºã€‚</p>
</li>
<li>
<p>åœ¨åˆ†æC++çš„classæ—¶ï¼Œæœ¬ä¹¦51.1.5èŠ‚ä¸­è®²åˆ°çš„RTTIæ•°æ®å¯èƒ½å°±æ˜¯åˆ†æçš„é‡ç‚¹ã€‚</p>
</li>
<li>
<p>åœ¨åå…­è¿›åˆ¶çš„ç¼–è¾‘å™¨é‡Œï¼Œ16ä½/32ä½/64ä½æ•°æ®æ•°ç»„çš„ç‰¹å¾ååˆ†æ˜æ˜¾ã€‚æœ¬èŠ‚ä»¥ä¸€ä¸ªå¾ˆç®€å•çš„MIPSç¨‹åºä¸ºä¾‹ã€‚å‰æ–‡ä»‹ç»è¿‡ï¼šæ¯ä¸ªMIPSæŒ‡ä»¤éƒ½æ˜¯æ•´é½çš„32ä½ï¼ˆå³4å­—èŠ‚ï¼‰æŒ‡ä»¤ã€‚å½“ç„¶ARMæ¨¡å¼æˆ–è€…ARM64æ¨¡å¼çš„ç¨‹åºä¹Ÿæœ‰è¿™ä¸ªç‰¹ç‚¹ã€‚å› æ­¤ï¼Œåœ¨å½¢å¼ä¸Šè¿™äº›ç¨‹åºçš„æŒ‡ä»¤éƒ½æ„æˆäº†æŸç§32ä½æ•°ç»„ã€‚</p>
</li>
<li>
<p>å†…å­˜â€œå¿«ç…§â€çš„å¯¹æ¯”æŠ€æœ¯å¯ä»¥å‡¸æ˜¾å‡ºå†…å­˜ä¸­å˜åŒ–çš„æ•°æ®</p>
<p>å¯ä»¥ç›´æ¥ä½¿ç”¨<code>CheatEngine</code></p>
</li>
<li>
<p>åœ¨å®‰è£…ä¸€ä¸ªç¨‹åºä»¥åï¼Œæˆ‘ä»¬å°±èƒ½æ¯”å¯¹å®‰è£…å‰åWindowsçš„æ³¨å†Œè¡¨ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸æµè¡Œçš„æ–¹æ³•ï¼Œå¯ä»¥ç”¨æ¥ç¡®è®¤ç‰¹å®šç¨‹åºä½¿ç”¨äº†å“ªäº›æ³¨å†Œè¡¨é”®å€¼ã€‚è¿™ä¹Ÿè®¸å°±æ˜¯â€œWindowsæ³¨å†Œè¡¨æ¸…ç†â€ç¨‹åºé¢‡ä¸ºæµè¡Œçš„åŸå› ã€‚</p>
</li>
</ul>
<h2 id="part6-æ“ä½œç³»ç»Ÿç›¸å…³"><a class="markdownIt-Anchor" href="#part6-æ“ä½œç³»ç»Ÿç›¸å…³"></a> Part.6 æ“ä½œç³»ç»Ÿç›¸å…³</h2>
<h3 id="chap64å‚æ•°çš„ä¼ é€’æ–¹æ³•"><a class="markdownIt-Anchor" href="#chap64å‚æ•°çš„ä¼ é€’æ–¹æ³•"></a> Chap64.å‚æ•°çš„ä¼ é€’æ–¹æ³•</h3>
<h4 id="cdecl"><a class="markdownIt-Anchor" href="#cdecl"></a> cdecl</h4>
<ul>
<li>
<p>C/C++æœ€å¸¸ä½¿ç”¨çš„å‚æ•°ä¼ é€’æ–¹æ³•</p>
</li>
<li>
<p>å‚æ•°ä»å³å¾€å·¦ä¼ é€’</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">push arg3
push arg2
push arg1
call function
add <span class="token register variable">esp</span>.<span class="token number">12</span><span class="token comment">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<h4 id="stdcall"><a class="markdownIt-Anchor" href="#stdcall"></a> stdcall</h4>
<p>ä¸<code>cdecl</code>è§„èŒƒç±»ä¼¼</p>
<p>ä¸è¿‡è¢«è°ƒç”¨æ–¹å‡½æ•°åœ¨è¿”å›ä¹‹å‰ä¼šæŒ‡å‘<code>ret x</code>æ¥è¿˜åŸå‚æ•°æ ˆ</p>
<p>ä¸éœ€è¦åœ¨ä½¿ç”¨å‡½æ•°å<code>add esp,x</code></p>
<p>è¿™é‡Œçš„<code>x=å‚æ•°ä¸ªæ•°*æŒ‡é’ˆå¤§å°</code></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">push arg3
push arg2
push arg1
call function
<span class="token label function">function:</span>
...do something...
ret <span class="token number">12</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ­¤ç±»çº¦å®šåœ¨Win32çš„æ ‡å‡†åº“æ–‡ä»¶ä¸­ååˆ†å¸¸è§ã€‚ç„¶è€Œå› ä¸ºWin64ç³»ç»Ÿéµå¾ªè°ƒç”¨çº¦å®šçš„æ˜¯Win64è§„èŒƒï¼Œæ‰€ä»¥Win64çš„åº“æ–‡ä»¶é‡Œä¸ä¼šå‡ºç°stdcallçš„æ ‡å¿—æ€§æ“ä½œæŒ‡ä»¤ã€‚</p>
<hr />
<p>å¦‚æœprintf()å‡½æ•°å½“çœŸé‡‡å–äº†stdcallè§„èŒƒã€æ ¹æ®æ ¼å¼åŒ–å­—ç¬¦ä¸²ç»Ÿè®¡å˜å‚çš„æ•°é‡å¹¶ä¸”åœ¨å‡½æ•°å°¾å£°æ¢å¤æ ˆæŒ‡é’ˆï¼Œé‚£ä¹ˆè¿™ç§å±€é¢å°±ååˆ†å±é™©äº†ï¼šä¸‡ä¸€ç¨‹åºå‘˜æ‰“é”™äº†å‡ ä¸ªå­—æ¯ï¼Œç¨‹åºå°±ä¼šå´©æºƒã€‚ç”±æ­¤å¯çŸ¥ï¼Œå¯¹äºé‚£äº›å¸¦æœ‰å¯å˜å‚æ•°çš„å‡½æ•°è€Œè¨€ï¼Œcdeclè§„èŒƒè¦æ¯”stdcallè§„èŒƒæ›´å¥½ä¸€äº›ã€‚</p>
<h4 id="fastcall"><a class="markdownIt-Anchor" href="#fastcall"></a> fastcall</h4>
<p>è¿™ä¸ªè°ƒç”¨çº¦å®šä¼˜å…ˆä½¿ç”¨å¯„å­˜å™¨ä¼ é€’å‚æ•°ï¼Œæ— æ³•é€šè¿‡å¯„å­˜å™¨ä¼ é€’çš„å‚æ•°åˆ™é€šè¿‡æ ˆä¼ é€’ç»™è¢«è°ƒç”¨æ–¹å‡½æ•°ã€‚å› ä¸ºfastcallçº¦å®šåœ¨å†…å­˜æ ˆæ–¹é¢çš„è®¿é—®å‹åŠ›æ¯”è¾ƒå°ï¼Œæ‰€ä»¥åœ¨æ—©æœŸçš„CPUå¹³å°ä¸Šéµå¾ªfastcallè§„èŒƒçš„ç¨‹åºä¼šæ¯”éµå¾ªstdcallå’Œcdeclè§„èŒƒçš„ç¨‹åºæ€§èƒ½æ›´é«˜ã€‚ä½†æ˜¯åœ¨ç°åœ¨çš„ã€æ›´ä¸ºå¤æ‚çš„CPUå¹³å°ä¸Šï¼Œfastcallè§„èŒƒçš„æ€§èƒ½ä¼˜åŠ¿å°±ä¸é‚£ä¹ˆæ˜æ˜¾äº†ã€‚</p>
<p>ä¸ç®¡æ˜¯MSVCè¿˜æ˜¯GCCéƒ½ä½¿ç”¨ECXå’ŒEDXä¼ é€’ç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ªå‚æ•°ï¼Œç”¨æ ˆä¼ é€’å…¶ä½™çš„å‚æ•°ã€‚æ­¤å¤–ï¼Œåº”ç”±è¢«è°ƒç”¨æ–¹å‡½æ•°è°ƒæ•´æ ˆæŒ‡é’ˆã€æŠŠå‚æ•°æ ˆæ¢å¤åˆ°è°ƒç”¨ä¹‹å‰çš„åˆå§‹çŠ¶æ€ï¼ˆè¿™ä¸€ç‚¹ä¸stdcallç±»ä¼¼ï¼‰ã€‚</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">push arg3
mov <span class="token register variable">edx</span>, arg2
mov <span class="token register variable">ecx</span>, arg1
call function

<span class="token label function">function:</span>
.. do something ..
ret <span class="token number">4</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="thiscall"><a class="markdownIt-Anchor" href="#thiscall"></a> thiscall</h4>
<p>è¿™æ˜¯ä¸€ç§æ–¹ä¾¿C++ç±»æˆå‘˜è°ƒç”¨thisæŒ‡é’ˆè€Œç‰¹åˆ«è®¾å®šçš„è°ƒç”¨è§„èŒƒã€‚</p>
<p>MSVCä½¿ç”¨ECXå¯„å­˜å™¨ä¼ é€’thisæŒ‡é’ˆã€‚</p>
<p>è€ŒGCCåˆ™æŠŠthisæŒ‡é’ˆä½œä¸ºè¢«è°ƒç”¨æ–¹å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’ã€‚åœ¨æ±‡ç¼–å±‚é¢ï¼Œè¿™ä¸ªæŒ‡é’ˆæ˜¾è€Œæ˜“è§ï¼šæ‰€æœ‰çš„ç±»å‡½æ•°éƒ½æ¯”æºä»£ç å¤šå‡ºæ¥ä¸€ä¸ªå‚æ•°ã€‚</p>
<h4 id="64ä½ä¸‹çš„x86"><a class="markdownIt-Anchor" href="#64ä½ä¸‹çš„x86"></a> 64ä½ä¸‹çš„x86</h4>
<p>64ä½ç¯å¢ƒä¸‹çš„å‚æ•°ä¼ é€’æ–¹æ³•åœ¨æŸç§ç¨‹åº¦ä¸Šä¸fastcallå‡½æ•°æ¯”è¾ƒç±»ä¼¼ï¼šå¤´å››ä¸ªå‚æ•°ç”±å¯„å­˜å™¨<strong>RCXã€RDXã€R8å’ŒR9</strong>ä¼ é€’ï¼Œè€Œ<strong>å…¶ä½™çš„å‚æ•°éƒ½é€šè¿‡æ ˆæ¥ä¼ é€’</strong>ã€‚è°ƒç”¨æ–¹å‡½æ•°å¿…é¡»é¢„ç•™32ä¸ªå­—èŠ‚æˆ–è€…4ä¸ª64ä½çš„å­˜å‚¨ç©ºé—´ï¼Œä»¥ä¾¿è¢«è°ƒç”¨æ–¹å‡½æ•°ä¿å­˜å¤´å››ä¸ªå‚æ•°ã€‚å°å‹å‡½æ•°å¯ä»¥ä»…å‡­å¯„å­˜å™¨å°±è·å–æ‰€æœ‰å‚æ•°ï¼Œè€Œå¤§å‹å‡½æ•°å°±å¯èƒ½éœ€è¦ä¿å­˜è¿™äº›ä¼ é€’å‚æ•°çš„å¯„å­˜å™¨ï¼ŒæŠŠå®ƒä»¬è…¾æŒªå‡ºæ¥ä¾›åç»­æŒ‡ä»¤è°ƒç”¨ã€‚</p>
<p>è°ƒç”¨æ–¹å‡½æ•°è´Ÿè´£è°ƒæ•´æ ˆæŒ‡é’ˆåˆ°å…¶åˆå§‹çŠ¶æ€ã€‚</p>
<p>æ­¤å¤–ï¼ŒWindows x86-64ç³»ç»Ÿçš„DLLæ–‡ä»¶ä¹Ÿé‡‡ç”¨äº†è¿™ç§è°ƒç”¨è§„èŒƒã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè™½ç„¶Win32ç³»ç»ŸAPIéµå¾ªçš„æ˜¯stdcallè§„èŒƒï¼Œä½†æ˜¯Win64ç³»ç»Ÿéµå¾ªçš„æ˜¯Win64è§„èŒƒã€ä¸å†ä½¿ç”¨stdcallè§„èŒƒã€‚</p>
<h4 id="64ä½ä¸‹linux"><a class="markdownIt-Anchor" href="#64ä½ä¸‹linux"></a> 64ä½ä¸‹Linux</h4>
<p>64ä½Linuxç¨‹åºä¼ é€’å‚æ•°çš„æ–¹æ³•å’Œ64ä½Windowsç¨‹åºçš„ä¼ é€’æ–¹æ³•å‡ ä¹ç›¸åŒã€‚åŒºåˆ«åœ¨äºï¼Œ<strong>64ä½Linuxç¨‹åºä½¿ç”¨6ä¸ªå¯„å­˜å™¨ï¼ˆRDIã€RSIã€RDXã€RCXã€R8ã€R9ï¼‰ä¼ é€’å‰å‡ é¡¹å‚æ•°ï¼Œè€Œ64ä½Windowsåˆ™åªåˆ©ç”¨4ä¸ªå¯„å­˜å™¨ä¼ é€’å‚æ•°</strong>ã€‚å¦å¤–ï¼Œ64ä½Linuxç¨‹åºæ²¡æœ‰ä¸Šé¢æåˆ°çš„â€œé›¶æ•£ç©ºé—´â€è¿™ç§æ¦‚å¿µã€‚å¦‚æœè¢«è°ƒç”¨æ–¹å‡½æ•°çš„å¯„å­˜å™¨æ•°é‡ç´§å¼ ï¼Œå®ƒå°±å¯ä»¥ç”¨<strong>æ ˆå­˜å‚¨å¤–æ¥å‚</strong>æ•°ï¼ŒæŠŠç›¸å…³å¯„å­˜å™¨è…¾å‡ºæ¥ä½¿ç”¨ã€‚</p>
<p>æ“ä½œEAXå¯„å­˜å™¨çš„æ—¶å€™ï¼Œå®ƒåªæŠŠæ•°æ®å†™åˆ°äº†RAXå¯„å­˜å™¨çš„ä½32ä½ï¼ˆå³EAXï¼‰è€Œæ²¡æœ‰ç›´æ¥æ“ä½œæ•´ä¸ª64ä½RAXå¯„å­˜å™¨ã€‚è¿™æ˜¯å› ä¸ºï¼šåœ¨æ“ä½œå¯„å­˜å™¨çš„ä½32ä½çš„æ—¶å€™ï¼Œè¯¥å¯„å­˜å™¨çš„é«˜32ä½ä¼šè¢«è‡ªåŠ¨æ¸…é›¶ã€‚</p>
<h4 id="å•åŒç²¾åº¦å‹è¿”å›å€¼"><a class="markdownIt-Anchor" href="#å•åŒç²¾åº¦å‹è¿”å›å€¼"></a> å•åŒç²¾åº¦å‹è¿”å›å€¼</h4>
<p>é™¤äº†Win64è§„èŒƒä»¥å¤–çš„æ‰€æœ‰çš„è°ƒç”¨è§„èŒƒéƒ½è§„å®šï¼šå½“è¿”å›å€¼ä¸ºå•/åŒç²¾åº¦æµ®ç‚¹å‹æ•°æ®æ—¶ï¼Œè¢«è°ƒç”¨æ–¹å‡½æ•°åº”å½“é€šè¿‡<strong>FPUå¯„å­˜å™¨ST(0)ä¼ é€’è¿”å›å€¼</strong>ã€‚è€ŒWin64è§„èŒƒè§„å®šï¼šè¢«è°ƒç”¨æ–¹å‡½æ•°åº”å½“**é€šè¿‡XMM0å¯„å­˜å™¨çš„ä½32ä½ï¼ˆfloatï¼‰æˆ–ä½64ä½å¯„å­˜å™¨ï¼ˆdoubleï¼‰**è¿”å›å•/åŒç²¾åº¦æµ®ç‚¹å‹æ•°æ®ã€‚</p>
<h4 id="ä¿®æ”¹å‚æ•°"><a class="markdownIt-Anchor" href="#ä¿®æ”¹å‚æ•°"></a> ä¿®æ”¹å‚æ•°</h4>
<p>å¦‚æœè¢«è°ƒç”¨æ–¹å‡½æ•°ä¿®æ”¹äº†å¤–æ¥å‚æ•°çš„å€¼ï¼Œå°†ä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µï¼Ÿç­”æ¡ˆååˆ†ç®€å•ï¼š<strong>å¤–æ¥å‚æ•°éƒ½æ˜¯é€šè¿‡æ ˆä¼ é€’çš„</strong>ï¼Œå› æ­¤<strong>è¢«è°ƒç”¨æ–¹å‡½æ•°ä¿®æ”¹çš„æ˜¯æ ˆé‡Œçš„æ•°æ®</strong>ã€‚åœ¨è¢«è°ƒç”¨æ–¹å‡½æ•°é€€å‡ºä»¥åï¼Œè°ƒç”¨æ–¹å‡½æ•°ä¸ä¼šå†è®¿é—®è‡ªå·±ä¼ é€’ç»™åˆ«äººçš„å‚æ•°ã€‚</p>
<h4 id="æŒ‡é’ˆå‹å‡½æ•°å‚æ•°"><a class="markdownIt-Anchor" href="#æŒ‡é’ˆå‹å‡½æ•°å‚æ•°"></a> æŒ‡é’ˆå‹å‡½æ•°å‚æ•°</h4>
<p>å˜é‡açš„åœ°å€é€šè¿‡æ ˆä¼ é€’ç»™äº†ä¸€ä¸ªå‡½æ•°ï¼Œç„¶åè¿™ä¸ªåœ°å€åˆè¢«ä¼ é€’ç»™äº†å¦å¤–ä¸€ä¸ªå‡½æ•°ã€‚ç¬¬ä¸€ä¸ªå‡½æ•°ä¿®æ”¹äº†å˜é‡açš„å€¼ï¼Œè€Œåprintf()å‡½æ•°è·å–åˆ°äº†è¿™ä¸ªä¿®æ”¹åçš„å˜é‡å€¼ã€‚</p>
<h3 id="chap65-çº¿ç¨‹æœ¬åœ°å­˜å‚¨tls"><a class="markdownIt-Anchor" href="#chap65-çº¿ç¨‹æœ¬åœ°å­˜å‚¨tls"></a> Chap65 çº¿ç¨‹æœ¬åœ°å­˜å‚¨TLS</h3>
<p><strong>çº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼ˆThread Local Storageï¼ŒTLSï¼‰æ˜¯ä¸€ç§åœ¨çº¿ç¨‹å†…éƒ¨å…±äº«æ•°æ®çš„æ•°æ®äº¤æ¢åŒºåŸŸ</strong>ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½å¯ä»¥åœ¨è¿™ä¸ªåŒºåŸŸä¿å­˜å®ƒä»¬è¦åœ¨å†…éƒ¨å…±äº«çš„æ•°æ®ã€‚ä¸€ä¸ªæ¯”è¾ƒçŸ¥åçš„ä¾‹å­æ˜¯Cè¯­è¨€çš„å…¨å±€å˜é‡errnoã€‚å¯¹äºerrnoè¿™ç±»çš„å…¨å±€å˜é‡æ¥è¯´ï¼Œå¦‚æœå¤šçº¿ç¨‹è¿›ç¨‹çš„æŸä¸€ä¸ªçº¿ç¨‹å¯¹å…¶è¿›è¡Œäº†ä¿®æ”¹ï¼Œé‚£ä¹ˆè¿™ä¸ªå˜é‡å°±ä¼šå½±å“åˆ°å…¶ä»–æ‰€æœ‰çš„çº¿ç¨‹ã€‚è¿™æ˜¾ç„¶å’Œå®é™…éœ€æ±‚ç›¸æ‚–ï¼Œå› æ­¤å…¨å±€å˜é‡errnoå¿…é¡»ä¿å­˜åœ¨TLSä¸­ã€‚</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;thread></span></span>

<span class="token keyword">thread_local</span> <span class="token keyword">int</span> tmp<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> tmp <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨åˆ†æå¯æ‰§è¡Œæ–‡ä»¶çš„PEå¤´ä¹‹åå°±ä¼šå‘ç°ï¼Œå˜é‡tmpè¢«åˆ†é…åˆ°TLSä¸“ç”¨çš„æ•°æ®ä¿å­˜åŒºåŸŸäº†</p>
<h4 id="tlså›è°ƒ"><a class="markdownIt-Anchor" href="#tlså›è°ƒ"></a> TLSå›è°ƒ</h4>
<p>éšæœºæ•°å‘ç”Ÿå™¨åªæœ‰åœ¨æ­£ç¡®åˆå§‹åŒ–ä¹‹åæ‰ä¼šç”ŸæˆçœŸå®æ„ä¹‰ä¸Šçš„éšæœºæ•°ï¼Œè€Œä¸æ˜¯1234è¿™æ ·çš„å›ºå®šå€¼ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥é‡‡ç”¨TLSå›è°ƒã€‚</p>
<p>å®ƒåªæ˜¯æ„é€ ä¸€ä¸ªåœ¨<strong>è¿›ç¨‹/çº¿ç¨‹å¯åŠ¨å‰å°±è¢«ç³»ç»Ÿè°ƒç”¨</strong>çš„å›è°ƒå‡½æ•°ï¼ˆtls_callback()ï¼‰</p>
<h3 id="chap66ç³»ç»Ÿè°ƒç”¨"><a class="markdownIt-Anchor" href="#chap66ç³»ç»Ÿè°ƒç”¨"></a> Chap66ç³»ç»Ÿè°ƒç”¨</h3>
<p>æ‰€æœ‰åœ¨æ“ä½œç³»ç»Ÿä¸­è¿è¡Œçš„è¿›ç¨‹å¯ä»¥åˆ†æˆä¸¤ç±»ï¼šä¸€ç±»è¿›ç¨‹å¯¹å…·æœ‰ç¡¬ä»¶çš„å…¨éƒ¨è®¿é—®æƒé™ï¼Œè¿è¡Œäºå†…æ ¸ç©ºé—´ï¼ˆkernel spaceï¼‰ï¼›å¦ä¸€ç±»è¿›ç¨‹ä¸èƒ½ç›´æ¥è®¿é—®ç¡¬ä»¶åœ°å€ï¼Œè¿è¡Œäºç”¨æˆ·ç©ºé—´ï¼ˆuser spaceï¼‰ã€‚</p>
<p>ç”±æ“ä½œç³»ç»Ÿæä¾›çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆsyscallï¼‰æ„æˆäº†ring0å’Œring 3ä¹‹é—´çš„è®¿é—®æœºåˆ¶ã€‚å¯ä»¥è¯´ï¼Œç³»ç»Ÿè°ƒç”¨å°±æ˜¯æ“ä½œç³»ç»Ÿä¸ºåº”ç”¨ç¨‹åºæä¾›çš„åº”ç”¨ç¼–ç¨‹æ¥å£APIã€‚</p>
<p><strong>è®¡ç®—æœºç—…æ¯’ä»¥åŠshellcodeå¤§å¤šéƒ½ä¼šåˆ©ç”¨ç³»ç»Ÿè°ƒç”¨ã€‚è¿™æ˜¯å› ä¸ºç³»ç»Ÿåº“å‡½æ•°çš„å¯»å€è¿‡ç¨‹ååˆ†éº»çƒ¦ï¼Œè€Œç›´æ¥è°ƒç”¨ç³»ç»Ÿè°ƒç”¨å´ç›¸å¯¹ç®€å•</strong>ã€‚è™½ç„¶ç³»ç»Ÿè°ƒç”¨çš„è®¿é—®è¿‡ç¨‹å¹¶ä¸éº»çƒ¦ï¼Œä½†æ˜¯ç”±äº<strong>ç³»ç»Ÿè°ƒç”¨æœ¬èº«å±äºåº•å±‚API</strong>ï¼Œå› æ­¤ç›´æ¥ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨çš„ç¨‹åºä¹Ÿä¸å¥½å†™ã€‚å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼šç³»ç»Ÿè°ƒç”¨çš„æ€»æ•°ç”±æ“ä½œç³»ç»Ÿå’Œç³»ç»Ÿç‰ˆæœ¬ä¸¤ä¸ªå› ç´ å…±åŒå†³å®šçš„ã€‚</p>
<h4 id="linux"><a class="markdownIt-Anchor" href="#linux"></a> linux</h4>
<p>Linuxç¨‹åºé€šå¸¸é€šè¿‡<strong>80å·ä¸­æ–­/INT 80è°ƒç”¨ç³»ç»Ÿè°ƒç”¨</strong>ã€‚åœ¨è°ƒç”¨ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œç¨‹åºåº”å½“é€šè¿‡<strong>EAXå¯„å­˜å™¨æŒ‡å®šè¢«è°ƒç”¨å‡½æ•°çš„ç¼–å·</strong>ï¼Œå†ä½¿<strong>ç”¨å…¶ä»–å¯„å­˜å™¨å£°æ˜ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°ã€‚</strong></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token keyword">section .text</span>
<span class="token keyword">global _start</span>

<span class="token label function">_start:</span>
        mov     <span class="token register variable">edx</span>,len <span class="token comment">; buffer len</span>
        mov     <span class="token register variable">ecx</span>,msg <span class="token comment">; buffer</span>
        mov     <span class="token register variable">ebx</span>,<span class="token number">1</span>   <span class="token comment">; file descriptor. 1 is for stdout</span>
        mov     <span class="token register variable">eax</span>,<span class="token number">4</span>   <span class="token comment">; syscall number. 4 is for sys_write</span>
        int     <span class="token number">0x80</span>

        mov     <span class="token register variable">eax</span>,<span class="token number">1</span>   <span class="token comment">; syscall number. 4 is for sys_exit</span>
        int     <span class="token number">0x80</span>

<span class="token keyword">section .data</span>

msg     db  <span class="token string">'Hello, world!'</span>,<span class="token number">0xa</span>
len     equ <span class="token operator">$</span> <span class="token operator">-</span> msg<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/tcctw/p/11450449.html">Linuxç³»ç»Ÿè°ƒç”¨è¡¨ï¼ˆx86_64ï¼‰ - ä¸€å·official - åšå®¢å›­ (cnblogs.com)</a></p>
<h4 id="windows"><a class="markdownIt-Anchor" href="#windows"></a> windows</h4>
<p>Windowsç¨‹åºå¯é€šè¿‡0x2eå·ä¸­æ–­/int 0x2eã€æˆ–x86ä¸“ç”¨æŒ‡ä»¤SYSENTERè®¿é—®ç³»ç»Ÿè°ƒç”¨ã€‚</p>
<p>è¿™é‡Œä½¿ç”¨çš„ä¸­æ–­æ•°æ˜¯0x2eï¼Œæˆ–è€…é‡‡ç”¨x86ä¸‹çš„ç‰¹æ®ŠæŒ‡ä»¤SYSENTERã€‚</p>
<p><a target="_blank" rel="noopener" href="https://www.bytezonex.com/archives/wg1rxeFZ.html">æ·±å…¥æµ…å‡ºï¼š64 ä½ Windows ä¸­æ±‡ç¼–ç³»ç»Ÿè°ƒç”¨çš„å¥¥ç§˜ - ByteZoneXç¤¾åŒº</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/j00ru/windows-syscalls">j00ru/windows-syscalls: Windows System Call Tables (NT/2000/XP/2003/Vista/7/8/10/11) (github.com)</a></p>
<h3 id="chap67-linux"><a class="markdownIt-Anchor" href="#chap67-linux"></a> Chap67 Linux</h3>
<h4 id="ä½ç½®æ— å…³çš„ä»£ç "><a class="markdownIt-Anchor" href="#ä½ç½®æ— å…³çš„ä»£ç "></a> ä½ç½®æ— å…³çš„ä»£ç </h4>
<p>åœ¨åˆ†æLinuxå…±äº«åº“æ–‡ä»¶ï¼ˆæ‰©å±•åæ˜¯soï¼‰æ—¶ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°å…·æœ‰ä¸‹è¿°ç‰¹å¾çš„æŒ‡ä»¤ä»£ç ï¼š</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token label function">.text:</span>0012D5E3 __x86_get_pc_thunk_bx proc near            <span class="token comment">; CODE XREF: sub_17350+3</span>
<span class="token label function">.text:</span>0012D5E3                                            <span class="token comment">; sub_173CC+4 ...</span>
<span class="token label function">.text:</span>0012D5E3                 mov    <span class="token register variable">ebx</span>, <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">0</span><span class="token operator">]</span>
<span class="token label function">.text:</span>0012D5E6                 retn
<span class="token label function">.text:</span>0012D5E6 __x86_get_pc_thunk_bx endp

...

<span class="token label function">.text:</span>000576C0 sub_576C0       proc near                  <span class="token comment">; CODE XREF: tmpfile+73</span>

...

<span class="token label function">.text:</span>000576C0                 push    <span class="token register variable">ebp</span>
<span class="token label function">.text:</span>000576C1                 mov     <span class="token register variable">ecx</span>, large <span class="token register variable">gs</span>:<span class="token number">0</span>
<span class="token label function">.text:</span>000576C8                 push    <span class="token register variable">edi</span>
<span class="token label function">.text:</span>000576C9                 push    <span class="token register variable">esi</span>
<span class="token label function">.text:</span>000576CA                 push    <span class="token register variable">ebx</span>
<span class="token label function">.text:</span>000576CB                 call    __x86_get_pc_thunk_bx
<span class="token label function">.text:</span>000576D0                 add     <span class="token register variable">ebx</span>, <span class="token number">157930h</span>
<span class="token label function">.text:</span>000576D6                 sub     <span class="token register variable">esp</span>, <span class="token number">9Ch</span>

...

<span class="token label function">.text:</span>000579F0                 lea     <span class="token register variable">eax</span>, (a__gen_tempname <span class="token operator">-</span> <span class="token number">1AF000h</span>)<span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">]</span> <span class="token comment">; "__gen_tempname"</span>
<span class="token label function">.text:</span>000579F6                 mov     <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">0ACh</span><span class="token operator">+</span>var_A0<span class="token operator">]</span>, <span class="token register variable">eax</span>
<span class="token label function">.text:</span>000579FA                 lea     <span class="token register variable">eax</span>, (a__SysdepsPosix <span class="token operator">-</span> <span class="token number">1AF000h</span>)<span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">]</span> <span class="token comment">; "../sysdeps/posix/tempname.c"</span>
<span class="token label function">.text:</span>00057A00                 mov     <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">0ACh</span><span class="token operator">+</span>var_A8<span class="token operator">]</span>, <span class="token register variable">eax</span>
<span class="token label function">.text:</span>00057A04                 lea     <span class="token register variable">eax</span>, (aInvalidKindIn_ <span class="token operator">-</span> <span class="token number">1AF000h</span>)<span class="token operator">[</span><span class="token register variable">ebx</span><span class="token operator">]</span> <span class="token comment">; "! \"invalid â†™</span>
    â†˜ KIND in __gen_tempname\<span class="token string">""</span>
<span class="token label function">.text:</span>00057A0A                 mov     <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">0ACh</span><span class="token operator">+</span>var_A4<span class="token operator">]</span>, <span class="token number">14Ah</span>
<span class="token label function">.text:</span>00057A12                 mov     <span class="token operator">[</span><span class="token register variable">esp</span><span class="token operator">+</span><span class="token number">0ACh</span><span class="token operator">+</span>var_AC<span class="token operator">]</span>, <span class="token register variable">eax</span>
<span class="token label function">.text:</span>00057A15                 call    __assert_fail<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ‰€æœ‰å­—ç¬¦ä¸²æŒ‡é’ˆéƒ½è¢«ä¸€äº›å¸¸æ•°ä¿®æ­£è¿‡ï¼Œå¹¶ä¸”ç›¸å…³å‡½æ•°éƒ½åœ¨å¼€å§‹çš„å‡ æ¡æŒ‡ä»¤é‡Œé‡æ–°è°ƒæ•´EBXä¸­çš„å€¼ã€‚</p>
<p>è¿™ç±»æŒ‡ä»¤ç§°ä½œâ€œä½ç½®æ— å…³çš„ä»£ç PICï¼ˆPosition Independent Codeï¼‰â€</p>
<p>å› ä¸ºè¿›ç¨‹æˆ–å¯¹è±¡ä¼šè¢«æ“ä½œç³»ç»Ÿçš„é“¾æ¥å™¨åŠ è½½åˆ°ä»»æ„å†…å­˜åœ°å€ï¼Œæ‰€ä»¥ä»£ç é‡Œçš„æŒ‡ä»¤æ— æ³•ç›´æ¥ç¡®å®šï¼ˆhardcodedï¼‰ç»å¯¹å†…å­˜åœ°å€ã€‚</p>
<p><strong>Windowsçš„DLLåŠ è½½æœºåˆ¶ä¸æ˜¯PICæœºåˆ¶ã€‚å¦‚æœWindowsåŠ è½½å™¨è¦æŠŠDLLåŠ è½½åˆ°å¦å¤–ä¸€ä¸ªåŸºåœ°å€ï¼Œå®ƒå°±ä¼šå†…å­˜ä¸­å¯¹DLLè¿›è¡Œâ€œä¿®è¡¥â€å¤„ç†ï¼ˆé‡å®šä½æŠ€æœ¯ï¼‰ï¼Œä»è€Œå¯ä»¥æ­£ç¡®åœ°å¤„ç†æ‰€æœ‰ç¬¦å·åœ°å€ã€‚è¿™å°±æ„å‘³ç€å¤šä¸ªWindowsè¿›ç¨‹æ— æ³•åœ¨ä¸åŒè¿›ç¨‹å†…å­˜å—çš„ä¸åŒåœ°å€å…±äº«ä¸€ä»½DLLï¼Œå› ä¸ºæ¯ä¸ªè¢«åŠ è½½åœ¨å†…å­˜é‡Œçš„å®ä¾‹åªèƒ½è®¿é—®è‡ªå·±çš„åœ°å€ç©ºé—´ã€‚</strong></p>
<h4 id="ld_preload"><a class="markdownIt-Anchor" href="#ld_preload"></a> LD_PRELOAD</h4>
<p>Linuxç¨‹åºå¯ä»¥åŠ è½½å…¶ä»–åŠ¨æ€åº“ä¹‹å‰ã€ç”šè‡³åœ¨åŠ è½½ç³»ç»Ÿåº“ï¼ˆä¾‹å¦‚libc.so.6ï¼‰ä¹‹å‰åŠ è½½è‡ªå·±çš„åŠ¨æ€åº“ã€‚</p>
<p>å€ŸåŠ©è¿™é¡¹åŠŸèƒ½ï¼Œæˆ‘ä»¬èƒ½å¤Ÿç¼–å†™è‡ªå®šä¹‰çš„å‡½æ•°â€œæ›¿æ¢â€ç³»ç»Ÿåº“ä¸­çš„åŒåå‡½æ•°ã€‚è¿›ä¸€æ­¥è¯´ï¼ŒåŠ«æŒtime()ã€read()ã€write()ç­‰ç³»ç»Ÿå‡½æ•°å¹¶ééš¾äº‹ã€‚</p>
<h3 id="chap68-windowsnt"><a class="markdownIt-Anchor" href="#chap68-windowsnt"></a> chap68 WindowsNT</h3>
<h4 id="crt"><a class="markdownIt-Anchor" href="#crt"></a> CRT</h4>
<p>åˆ°åŸå§‹å…¥å£OEPï¼ˆOriginal Entry Pointï¼‰æ€»æ˜¯æŒ‡å‘å…¶ä»–çš„ä¸€æ®µä»£ç ã€‚è¿™äº›ä»£ç ä¼šåœ¨å¯åŠ¨ç¨‹åºä¹‹å‰è¿›è¡Œä¸€äº›ç»´æŠ¤å’Œå‡†å¤‡å·¥ä½œã€‚è¿™å°±æ˜¯æ‰€è°“çš„å¯åŠ¨ä»£ç /startup-codeå³CRTä»£ç ï¼ˆC RunTimeï¼‰ã€‚</p>
<p>main()å‡½æ•°é€šè¿‡å¤–æ¥æ•°ç»„è·å–å¯åŠ¨å‚æ•°åŠç³»ç»Ÿçš„ç¯å¢ƒå˜é‡ã€‚ç„¶è€Œï¼Œå®é™…ä¼ é€’ç»™ç¨‹åºçš„ä¸æ˜¯æ•°ç»„è€Œæ˜¯å‚æ•°å­—ç¬¦ä¸²ã€‚CRTä»£ç ä¼šæ ¹æ®ç©ºæ ¼å¯¹å­—ç¬¦ä¸²è¿›è¡Œåˆ‡å‰²ã€‚å¦å¤–ï¼ŒCRTä»£ç è¿˜ä¼šé€šè¿‡envpæ•°ç»„å‘main()å‡½æ•°ä¼ é€’ç³»ç»Ÿçš„ç¯å¢ƒå˜é‡ã€‚åœ¨Win32çš„GUIç¨‹åºé‡Œï¼Œä¸»å‡½æ•°å˜ä¸ºäº†WinMain()ï¼Œå¹¶ä¸”æ‹¥æœ‰è‡ªå·±çš„å‚æ•°ä¼ é€’è§„æ ¼</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> CALLBACK <span class="token function">WinMain</span><span class="token punctuation">(</span>
 _In_ HINSTANCE hInstance<span class="token punctuation">,</span>
 _In_ HINSTANCE hPrevInstance<span class="token punctuation">,</span>
 _In_ LPSTR lpCmdLine<span class="token punctuation">,</span>
 _In_ <span class="token keyword">int</span> nCmdShow
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å †çš„åˆå§‹åŒ–æ“ä½œæ˜¯ç”±CRTä»£ç å®Œæˆçš„ã€‚è‹¥åœ¨æ²¡æœ‰CRTä»£ç çš„æƒ…å†µä¸‹è°ƒç”¨å†…å­˜åˆ†é…å‡½æ•°malloc()ï¼Œå°±ä¼šå¼•å‘å¼‚å¸¸é€€å‡ºï¼Œå¹¶å°†çœ‹åˆ°ä¸‹è¿°é”™è¯¯ä»£ç ï¼š</p>
<p>åœ¨C++ç¨‹åºä¸­ï¼ŒCRTä»£ç è¿˜è¦åœ¨å¯åŠ¨ä¸»å‡½æ•°main()ä¹‹å‰åˆå§‹åŒ–å…¨éƒ¨å…¨å±€å¯¹è±¡ã€‚</p>
<h4 id="pe"><a class="markdownIt-Anchor" href="#pe"></a> PE</h4>
<p>PEï¼ˆPortable Executableï¼‰æ ¼å¼ï¼Œæ˜¯å¾®è½¯Windowsç¯å¢ƒå¯ç§»æ¤å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆå¦‚exeã€dllã€vxdã€syså’Œvdmç­‰ï¼‰çš„æ ‡å‡†æ–‡ä»¶æ ¼å¼ã€‚</p>
<p>ä¸å…¶ä»–æ ¼å¼çš„PEæ–‡ä»¶ä¸åŒçš„æ˜¯ï¼Œexeå’Œsysæ–‡ä»¶é€šå¸¸åªæœ‰å¯¼å…¥è¡¨è€Œæ²¡æœ‰å¯¼å‡ºè¡¨ã€‚</p>
<p>å’Œå…¶ä»–çš„PEæ–‡ä»¶ä¸€æ ·ï¼ŒDLLæ–‡ä»¶ä¹Ÿæœ‰ä¸€ä¸ªåŸå§‹ä»£ç å…¥å£ç‚¹OEPï¼ˆå°±æ˜¯DllMain()å‡½æ•°çš„åœ°å€ï¼‰ã€‚ä½†æ˜¯DLLçš„è¿™ä¸ªå‡½æ•°é€šå¸¸æ¥è®²ä»€ä¹ˆä¹Ÿä¸ä¼šåšã€‚</p>
<p>sysæ–‡ä»¶é€šå¸¸æ¥è¯´æ˜¯ä¸€ä¸ªç³»ç»Ÿé©±åŠ¨ç¨‹åºã€‚è¯´åˆ°é©±åŠ¨ç¨‹åºï¼ŒWindowsæ“ä½œç³»ç»Ÿéœ€è¦åœ¨PEæ–‡ä»¶é‡Œä¿å­˜å…¶æ ¡éªŒå’Œï¼Œä»¥éªŒè¯è¯¥æ–‡ä»¶çš„æ­£ç¡®æ€§ï¼ˆHiewå°±å¯ä»¥éªŒè¯è¿™ä¸ªæ ¡éªŒå’Œï¼‰ã€‚</p>
<h5 id="æœ¯è¯­"><a class="markdownIt-Anchor" href="#æœ¯è¯­"></a> æœ¯è¯­</h5>
<ul>
<li>æ¨¡å—Moduleï¼šå®ƒæ˜¯æŒ‡ä¸€ä¸ªå•ç‹¬çš„exeæˆ–è€…dllæ–‡ä»¶ã€‚</li>
<li>è¿›ç¨‹Processï¼šåŠ è½½åˆ°å†…å­˜ä¸­å¹¶æ­£åœ¨è¿è¡Œçš„ç¨‹åºï¼Œé€šå¸¸ç”±ä¸€ä¸ªexeæ–‡ä»¶å’Œå¤šä¸ªdllæ–‡ä»¶ç»„æˆã€‚</li>
<li>è¿›ç¨‹å†…å­˜Process memoryï¼šæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰å®Œå…¨å±äºè‡ªå·±çš„ï¼Œè¿›ç¨‹é—´ç‹¬ç«‹çš„ï¼Œä¸è¢«å¹²æ‰°çš„å†…å­˜ç©ºé—´ã€‚ é€šå¸¸æ˜¯æ¨¡å—ã€å †ã€æ ˆç­‰æ•°æ®æ„æˆã€‚</li>
<li>è™šæ‹Ÿåœ°å€VAï¼ˆVirtual Addressï¼‰ï¼šç¨‹åºè®¿é—®å­˜å‚¨å™¨æ‰€ä½¿ç”¨çš„é€»è¾‘åœ°å€ã€‚</li>
<li>åŸºåœ°å€Base Addressï¼šè¿›ç¨‹å†…å­˜ä¸­åŠ è½½æ¨¡å—çš„é¦–åœ°å€ã€‚</li>
<li>ç›¸å¯¹è™šæ‹Ÿåœ°å€RVAï¼ˆRelative Virtual Addressï¼‰ï¼šè™šæ‹Ÿåœ°å€VAä¸åŸºåœ°å€Base Addressçš„å·®å°±æ˜¯ç›¸å¯¹è™šæ‹Ÿåœ°å€RVAã€‚åœ¨PEæ–‡ä»¶è¡¨ä¸­çš„å¾ˆå¤šåœ°å€éƒ½æ˜¯ç›¸å¯¹è™šæ‹Ÿåœ°å€RVAã€‚</li>
<li>å¯¼å…¥åœ°å€è¡¨IATï¼ˆImport Address Tableï¼‰ï¼šå¯¼å…¥ç¬¦å·çš„åœ°å€æ•°ç»„ã€‚PEå¤´é‡Œçš„IMAGE_DIRECTORY_ ENTRY_IATæŒ‡å‘ç¬¬ä¸€ä¸ªå¯¼å…¥åœ°å€è¡¨IATçš„å¼€å§‹ä½ç½®ã€‚å€¼å¾—è¯´æ˜çš„æ˜¯ï¼Œåç¼–è¯‘å·¥å…·IDAå¯èƒ½ä¼šç»™IATè™šæ„ä¸€ä¸ªä¼ªæ®µâ€“.idataæ®µï¼Œå³ä½¿IATæ˜¯å…¶ä»–åœ°å€çš„ä¸€éƒ¨åˆ†ã€‚</li>
<li>å¯¼å…¥ç¬¦å·åç§°è¡¨INTï¼ˆImport Name Tableï¼‰ï¼šå­˜å‚¨ç€æ‰€éœ€ç¬¦å·åç§°çš„æ•°ç»„ã€‚</li>
</ul>
<h5 id="åŸºåœ°å€"><a class="markdownIt-Anchor" href="#åŸºåœ°å€"></a> åŸºåœ°å€</h5>
<p>åœ¨å¼€å‘å„è‡ªçš„DLLåŠ¨æ€é“¾æ¥åº“æ–‡ä»¶æ—¶ï¼Œå¤šæ•°å¼€å‘å›¢é˜Ÿéƒ½æœ‰æ„è®©å…¶ä»–äººç›´æ¥è°ƒç”¨è‡ªå·±çš„åŠ¨æ€é“¾æ¥åº“ã€‚</p>
<p>å› æ­¤ï¼Œ**å½“åŒä¸€ä¸ªè¿›ç¨‹çš„ä¸¤ä¸ªDLLåº“å…·æœ‰ç›¸åŒçš„åŸºåœ°å€æ—¶ï¼Œåªä¼šæœ‰ä¸€ä¸ªDLLè¢«çœŸæ­£åŠ è½½åˆ°åŸºåœ°å€ä¸Šã€‚è€Œå¦å¤–ä¸€ä¸ªDLLåˆ™ä¼šåˆ†é…åˆ°è¿›ç¨‹å†…å­˜çš„æŸæ®µç©ºé—²ç©ºé—´é‡Œã€‚**<strong>åœ¨è°ƒç”¨åè€…æ—¶ï¼Œæ¯ä¸ªè™šæ‹Ÿåœ°å€éƒ½ä¼šè¢«é‡æ–°æ ¡å¯¹ã€‚</strong></p>
<p>é€šå¸¸æ¥è¯´ï¼ŒMSVCç¼–è¯‘æˆçš„å¯æ‰§è¡Œç¨‹åºçš„åŸºåœ°å€éƒ½æ˜¯0x400000ï¼Œè€Œä»£ç æ®µåˆ™ä»0x401000å¼€å§‹ã€‚ç”±æ­¤å¯çŸ¥ï¼Œè¿™ç§ç¨‹åºä»£ç æ®µçš„ç›¸å¯¹è™šæ‹Ÿåœ°å€RVAçš„é¦–åœ°å€éƒ½æ˜¯0x1000ã€‚è€ŒMSVCé€šå¸¸æŠŠDLLçš„åŸºåœ°å€è®¾å®šä¸º0x10000000ã€‚</p>
<p>æ“çºµç³»ç»Ÿå¯èƒ½ä¼šæŠŠæ¨¡å—åŠ è½½åˆ°ä¸åŒçš„åŸºåœ°å€ä¸­ï¼Œè¿˜å¯èƒ½æ˜¯å› ä¸ºç¨‹åºè‡ªèº«çš„è¦æ±‚ã€‚å½“ç¨‹åºâ€œç‚¹åâ€<strong>å¯ç”¨åœ°å€ç©ºé—´åˆ†å¸ƒçš„éšæœºåŒ–ï¼ˆAddress Space Layout Randomizationï¼ŒASLRï¼‰æŠ€æœ¯çš„æ—¶å€™ï¼Œæ“ä½œç³»ç»Ÿä¼šæŠŠå…¶å„ä¸ªæ¨¡å—åŠ è½½åˆ°éšæœºçš„åŸºåœ°å€ä¸Šã€‚</strong></p>
<h5 id="å­ç³»ç»Ÿ"><a class="markdownIt-Anchor" href="#å­ç³»ç»Ÿ"></a> å­ç³»ç»Ÿ</h5>
<p>PEæ–‡ä»¶æœ‰ä¸€ä¸ªå­ç³»ç»Ÿå­—æ®µã€‚è¿™ä¸ªå­—æ®µçš„å€¼é€šå¸¸æ˜¯ä¸‹åˆ—ä¹‹ä¸€ï¼š</p>
<ul>
<li>NATIVEï¼ˆç³»ç»Ÿé©±åŠ¨ç¨‹åºï¼‰ã€‚</li>
<li>consoleæ§åˆ¶å°ç¨‹åºã€‚</li>
<li>GUIï¼ˆéæ§åˆ¶å°ç¨‹åºï¼Œä¹Ÿå°±æ˜¯æœ€å¸¸è§çš„å›¾æ–‡ç•Œé¢ç¨‹åºï¼‰ã€‚</li>
</ul>
<h5 id="æ®µ"><a class="markdownIt-Anchor" href="#æ®µ"></a> æ®µ</h5>
<p>æ‰€æœ‰çš„å¯æ‰§è¡Œæ–‡ä»¶éƒ½å¯åˆ†è§£ä¸ºè‹¥å¹²æ®µï¼ˆsectionsï¼‰ã€‚æ®µæ˜¯ä»£ç å’Œæ•°æ®ã€ä»¥åŠå¸¸é‡å’Œå…¶ä»–æ•°æ®çš„ç»„ç»‡å½¢å¼ã€‚</p>
<ul>
<li>å¸¦æœ‰IMAGE_SCN_CNT_CODEæˆ–IMAGE_SCN_MEM_EXECUTEæ ‡è¯†çš„æ®µï¼Œå°è£…çš„æ˜¯å¯æ‰§è¡Œä»£ç ã€‚</li>
<li>æ•°æ®æ®µçš„æ ‡è¯†ä¸ºIMAGE_SCN_CNT_INITIALIZED_DATAã€IMAGE_SCN_MEM_READæˆ–IMAGE_ SCN_MEM_WRITEæ ‡è®°ã€‚</li>
<li>æœªåˆå§‹åŒ–çš„æ•°æ®çš„ç©ºæ®µçš„æ ‡è¯†ä¸ºIMAGE_SCN_CNT_UNINITIALIZED_DATAã€IMAGE_SCN_ MEM_READæˆ–IMAGE_SCN_MEM_WRITEã€‚</li>
<li>å¸¸æ•°æ•°æ®æ®µï¼ˆå…¶ä¸­çš„æ•°æ®ä¸å¯è¢«é‡æ–°èµ‹å€¼ï¼‰çš„æ ‡è¯†æ˜¯IMAGE_SCN_CNT_ INITIALIZED_ DATAä»¥åŠIMAGE_SCN_MEM_READï¼Œä½†æ˜¯ä¸åŒ…æ‹¬æ ‡è¯†IMAGE_SCN_MEM_WRITEã€‚å¦‚æœè¿›ç¨‹è¯•å›¾å¾€è¿™ä¸ªæ•°æ®æ®µå†™å…¥æ•°æ®ï¼Œé‚£ä¹ˆæ•´ä¸ªè¿›ç¨‹å°±ä¼šå´©æºƒã€‚</li>
</ul>
<p>PEå¯æ‰§è¡Œæ–‡ä»¶çš„æ¯ä¸ªæ®µéƒ½å¯ä»¥æ‹¥æœ‰ä¸€ä¸ªæ®µåç§°ã€‚ç„¶è€Œï¼Œåç§°ä¸æ˜¯æ®µçš„é‡è¦ç‰¹å¾ã€‚é€šå¸¸æ¥è¯´ï¼Œä»£ç æ®µçš„æ®µåç§°æ˜¯.textï¼Œæ•°æ®æ®µçš„æ®µåç§°æ˜¯.dataï¼Œå¸¸æ•°æ®µçš„æ®µåç§°.rdataï¼ˆåªè¯»æ•°æ®ï¼‰ã€‚å…¶ä»–ç±»å‹çš„å¸¸è§æ®µåç§°è¿˜æœ‰ï¼š</p>
<ul>
<li>.idataï¼šå¯¼å…¥æ®µã€‚IDAå¯èƒ½ä¼šç»™è¿™ä¸ªæ®µåˆ†é…ä¸€ä¸ªä¼ªåç§°ï¼›è¯¦æƒ…è¯·å‚è€ƒæœ¬ä¹¦68.2.1èŠ‚ã€‚</li>
<li>.edataï¼šå¯¼å‡ºæ®µã€‚è¿™ä¸ªæ®µååˆ†ç½•è§ã€‚</li>
<li>.pdataï¼šè¿™ä¸ªæ®µå­˜å‚¨çš„æ˜¯ç”¨äºå¼‚å¸¸å¤„ç†çš„å‡½æ•°è¡¨é¡¹ã€‚å®ƒåŒ…å«äº†Windors NT For MIPSã€IA64ä»¥åŠx64æ‰€éœ€çš„å…¨éƒ¨å¼‚å¸¸å¤„ç†ä¿¡æ¯ã€‚è¯¦æƒ…è¯·å‚è€ƒæœ¬ä¹¦çš„68.3.3èŠ‚ã€‚</li>
<li>.relocï¼šï¼ˆåŠ è½½ï¼‰é‡å®šå‘æ®µã€‚</li>
<li>.bssï¼šæœªåˆå§‹åŒ–çš„æ•°æ®æ®µï¼ˆBSSï¼‰ã€‚</li>
<li>.tlsï¼šçº¿ç¨‹æœ¬åœ°å­˜å‚¨æ®µï¼ˆTLSï¼‰ã€‚</li>
<li>.rsrcï¼šèµ„æºã€‚</li>
<li>.CRTï¼šåœ¨æ—©æœŸç‰ˆæœ¬çš„MSVCç¼–è¯‘å‡ºçš„å¯æ‰§è¡Œæ–‡ä»¶é‡Œï¼Œå¯èƒ½å‡ºç°è¿™ä¸ªè¿™ä¸ªæ®µã€‚</li>
</ul>
<p>ç»è¿‡åŠ å¯†æˆ–è€…å‹ç¼©å¤„ç†ä¹‹åï¼ŒPEæ–‡ä»¶sectionæ®µçš„æ®µåç§°é€šå¸¸ä¼šè¢«æ›¿æ¢æˆ–æ··æ·†ã€‚</p>
<p>éƒ¨åˆ†ç¼–è¯‘å™¨ï¼ˆä¾‹å¦‚MinGWï¼‰å’Œé“¾æ¥å™¨å¯ä»¥åœ¨ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­åŠ å…¥å¸¦æœ‰è°ƒè¯•ç¬¦å·ã€æˆ–è€…å…¶ä»–çš„è°ƒè¯•ä¿¡æ¯çš„ç‹¬ç«‹æ®µã€‚ç„¶è€Œæ–°è¿‘ç‰ˆæœ¬çš„MSVCä¸å†æ”¯æŒè¿™é¡¹åŠŸèƒ½ã€‚ä¸ºäº†ä¾¿äºä¸“ä¸šäººå‘˜åˆ†æå’Œè°ƒè¯•åº”ç”¨ç¨‹åºï¼ŒMSVCæ¨å‡ºäº†å…¨ç§°ä¸ºâ€œç¨‹åºæ•°æ®åº“â€çš„PDBæ–‡ä»¶æ ¼å¼ã€‚</p>
<p>PEæ ¼å¼çš„sectionæ®µçš„æ•°æ®ç»“æ„å¤§ä½“å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_IMAGE_SECTION_HEADER</span> <span class="token punctuation">&#123;</span>
  BYTE Name<span class="token punctuation">[</span>IMAGE_SIZEOF_SHORT_NAME<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">union</span> <span class="token punctuation">&#123;</span>
    DWORD PhysicalAddress<span class="token punctuation">;</span>
    DWORD VirtualSize<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> Misc<span class="token punctuation">;</span>
  DWORD VirtualAddress<span class="token punctuation">;</span>
  DWORD SizeOfRawData<span class="token punctuation">;</span>
  DWORD PointerToRawData<span class="token punctuation">;</span>
  DWORD PointerToRelocations<span class="token punctuation">;</span>
  DWORD PointerToLinenumbers<span class="token punctuation">;</span>
  WORD NumberOfRelocations<span class="token punctuation">;</span>
  WORD NumberOfLinenumbers<span class="token punctuation">;</span>
  DWORD Characteristics<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> IMAGE_SECTION_HEADER<span class="token punctuation">,</span> <span class="token operator">*</span>PIMAGE_SECTION_HEADER<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ„Ÿè§‰è®²çš„ä¸æ€ä¹ˆè¡Œ</p>
<p>è·³äº†</p>
<h5 id="tls"><a class="markdownIt-Anchor" href="#tls"></a> TLS</h5>
<p>è¿™ä¸ªæ®µé‡Œå­˜å‚¨äº†TLSæ•°æ®ï¼ˆç¬¬65ç« ï¼‰çš„åˆå§‹åŒ–æ•°æ®ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰ã€‚å½“å¯åŠ¨ä¸€ä¸ªæ–°çš„çº¿ç¨‹æ—¶ï¼ŒTLSçš„æ•°æ®å°±æ˜¯é€šè¿‡æœ¬æ®µçš„æ•°æ®æ¥åˆå§‹åŒ–çš„ã€‚</p>
<p>é™¤æ­¤ä¹‹å¤–ï¼ŒPEæ–‡ä»¶è§„èŒƒè¿˜çº¦å®šäº†â€œTLSï¼â€çš„åˆå§‹åŒ–è§„èŒƒï¼Œå³TLS callbacks/TLSå›è°ƒå‡½æ•°ã€‚<strong>å¦‚æœç¨‹åºå£°æ˜äº†TLSå›è°ƒå‡½æ•°ï¼Œé‚£ä¹ˆTLSå›è°ƒå‡½æ•°ä¼šå…ˆäºOEPæ‰§è¡Œã€‚</strong></p>
<h4 id="seh"><a class="markdownIt-Anchor" href="#seh"></a> SEH</h4>
<p>æ¯ä¸ªè¿è¡Œçš„è¿›ç¨‹éƒ½æœ‰ä¸€æ¡SEHå¥æŸ„é“¾ï¼Œçº¿ç¨‹ä¿¡æ¯å—ï¼ˆThread Information Blockï¼ŒTIBï¼‰æœ‰SHEçš„æœ€åä¸€ä¸ªå¥æŸ„ã€‚å½“å‡ºç°å¼‚å¤–æ—¶ï¼ˆæ¯”å¦‚å‡ºç°äº†è¢«é›¶é™¤ã€åœ°å€è®¿é—®ä¸æ­£ç¡®æˆ–è€…ç¨‹åºä¸»åŠ¨è°ƒç”¨RaiseException()å‡½æ•°ç­‰æƒ…å†µï¼‰ï¼Œæ“ä½œç³»ç»Ÿä¼šåœ¨çº¿ç¨‹ä¿¡æ¯å—TIBé‡Œå¯»æ‰¾SEHçš„æœ€åä¸€ä¸ªå¥æŸ„ã€‚å¹¶ä¸”æŠŠå‡ºç°å¼‚å¸¸æƒ…å†µæ—¶ä¸CPUæœ‰å…³çš„æ‰€æœ‰çŠ¶æ€ï¼ˆåŒ…æ‹¬å¯„å­˜å™¨çš„å€¼ç­‰æ•°æ®ï¼‰ä¼ é€’ç»™é‚£ä¸ªSEHå¥æŸ„ã€‚æ­¤æ—¶å¼‚å¸¸å¤„ç†å‡½æ•°å¼€å§‹åˆ¤æ–­è‡ªå·±èƒ½å¦åº”å¯¹è¿™ç§å¼‚å¸¸æƒ…å†µã€‚å¦‚æœç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œé‚£ä¹ˆå¼‚å¸¸å¤„ç†å‡½æ•°å°±ä¼šç€æ‰‹æ¥ç®¡ã€‚å¦‚æœå¼‚å¸¸å¤„ç†å‡½æ•°æ— æ³•å¤„ç†è¿™ç§æƒ…å†µï¼Œå®ƒå°±ä¼šé€šçŸ¥æ“ä½œç³»ç»Ÿæ— æ³•å¤„ç†å®ƒï¼Œæ­¤åæ“ä½œç³»ç»Ÿä¼šé€ä¸€å°è¯•å¼‚å¸¸å¤„ç†é“¾ä¸­çš„å…¶ä»–å¤„ç†ç¨‹åºï¼Œç›´åˆ°æ‰¾åˆ°èƒ½å¤Ÿåº”å¯¹è¿™ç§æƒ…å†µçš„å¼‚å¸¸å¤„ç†ç¨‹åºä¸ºæ­¢ã€‚</p>
</div></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2024/05/27/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="prev" title="æ•°æ®ç»“æ„å¤ä¹ ç¬”è®°"><span class="icon iconify" data-icon="ri:arrow-left-s-line"></span><span class="post-nav-text">æ•°æ®ç»“æ„å¤ä¹ ç¬”è®°</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2024/05/09/PwnCollege1-ProgramMiuse/" rel="next" title="pwnCollege1-ProgramMiuse"><span class="post-nav-text">pwnCollege1-ProgramMiuse</span><span class="icon iconify" data-icon="ri:arrow-right-s-line"></span></a></div></div></div><div class="hty-card" id="comment"><div class="comment-tooltip text-center"><span>æ‚¨éœ€è¦ç§‘å­¦ä¸Šç½‘ï¼Œæ‰å¯ä½¿ç”¨è¯„è®ºåŒºåŠŸèƒ½ã€‚</span><br></div><div id="waline"></div><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@waline/client@v2/dist/waline.css"><script>window.CONFIG.waline.config.path = "/2024/05/23/re4b%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0/"</script><div class="js-Pjax"><script src="/js/comments/waline.js" type="module" defer></script></div></div></main><footer class="sidebar-translate" id="footer"><div class="beian"><a rel="noopener" href="https://beian.miit.gov.cn/" target="_blank"></a></div><div class="copyright"><span>&copy; 2023 â€“ 2025 </span><span class="with-love" id="animate"><span class="icon iconify" data-icon="ri:cloud-line"></span></span><span class="author"> Npc</span></div><div class="footer-custom-text">=w=</div></footer></div><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><span class="icon iconify" data-icon="ri:arrow-up-s-line"></span><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="Search"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:search-line"></span></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script src="https://fastly.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js"></script><script src="/js/search/local-search.js" defer type="module"></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><span class="icon iconify" data-icon="ri:close-line"></span></span></div><div class="search-input-container"><input class="search-input" id="local-search-input" type="text" placeholder="Searching..." value=""></div><div class="search-result-container"></div></div><script src="https://fastly.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js"></script><script>const images = [...document.querySelectorAll('.markdown-body img')]
mediumZoom(images)</script><style>.medium-zoom-image {
  z-index: 99;
}</style></body></html>