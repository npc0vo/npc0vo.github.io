<!DOCTYPE html><html lang="[&quot;en&quot;,&quot;zh-CN&quot;,&quot;default&quot;]"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="Npc"><meta name="copyright" content="Npc"><meta name="generator" content="Hexo 7.1.1"><meta name="theme" content="hexo-theme-yun"><title>åˆè¯†WindowsPE | Npc | Blog</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/star-markdown-css@0.4.1/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/my_blog_prism@1.0.5/prism.css"><script src="https://cdn.jsdelivr.net/npm/my_blog_prism@1.0.5/prism.js"></script><script src="https://fastly.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".markdown-body img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link rel="icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="preconnect" href="https://fastly.jsdelivr.net/npm/" crossorigin><script id="yun-config">
    window.Yun = {}
    window.CONFIG = {"hostname":"npc0vo.github.io","root":"/","title":"Npcå°ç«™","version":"1.10.11","mode":"light","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}.","hits":"${hits} results found","hits_time":"${hits} results found in ${time} ms"},"anonymous_image":"https://cdn.yunyoujun.cn/img/avatar/none.jpg","say":{"api":"https://el-bot-api.vercel.app/api/words/young"},"local_search":{"path":"/search.xml"},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"fireworks":{"colors":null},"waline":{"config":{"enable":true,"serverURL":"https://waline-onelastchicks-projects.vercel.app/","comment":false,"el":"#waline","lang":["en","zh-CN","default"]},"cdn":"https://fastly.jsdelivr.net/npm/@waline/client@v2/dist/waline.js","dark":"html.dark"},"vendors":{"host":"https://fastly.jsdelivr.net/npm/","darken":"https://fastly.jsdelivr.net/npm/darken@1.5.0"}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/hexo-theme-yun.js" type="module"></script><script src="//at.alicdn.com/t/font_1140697_dxory92pb0h.js" async></script><link rel="preconnect" href="https://www.google-analytics.com" crossorigin><script async src="https://www.googletagmanager.com/gtag/js?id=G-1LL0D86CY9"></script><script>if (CONFIG.hostname === location.hostname) {
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-1LL0D86CY9');
}</script><script data-ad-client="ca-pub-2245427233262012" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(function(){
  var bp = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https') {
    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else {
    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})();</script><!-- Google Tag Manager --><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-M9KWR9L');</script><!-- End Google Tag Manager --><meta name="description" content="å…ˆç®€å•äº†è§£ä¸€ä¸‹ï¼ŒåæœŸè·Ÿç€&quot;PEæƒå¨æŒ‡å—&quot;è¯¦ç»†å­¦ä¹  PEï¼ˆPortableæ–‡ä»¶æ˜¯Windowsä¸‹ä½¿ç”¨çš„å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼ åŸºäºUNIXå¹³å°çš„COFF(Common Object File Format é€šç”¨å¯¹è±¡æ–‡ä»¶æ ¼å¼)åŸºç¡€ä¸Šåˆ¶ä½œè€Œæˆ  åŸºç¡€æ¦‚å¿µ  æ–‡ä»¶æ ¼å¼    ç§ç±» ä¸»æ‹“å±•å ç§ç±» ä¸»æ‹“å±•å     å¯æ‰§è¡Œ EXE,SCR é©±åŠ¨ç¨‹åº SYS,VXD   åº“ç³»åˆ— DLL,OCX,C">
<meta property="og:type" content="article">
<meta property="og:title" content="åˆè¯†WindowsPE">
<meta property="og:url" content="http://npc0vo.github.io/2024/07/09/%E5%88%9D%E8%AF%86WindowsPE/index.html">
<meta property="og:site_name" content="Npc | Blog">
<meta property="og:description" content="å…ˆç®€å•äº†è§£ä¸€ä¸‹ï¼ŒåæœŸè·Ÿç€&quot;PEæƒå¨æŒ‡å—&quot;è¯¦ç»†å­¦ä¹  PEï¼ˆPortableæ–‡ä»¶æ˜¯Windowsä¸‹ä½¿ç”¨çš„å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼ åŸºäºUNIXå¹³å°çš„COFF(Common Object File Format é€šç”¨å¯¹è±¡æ–‡ä»¶æ ¼å¼)åŸºç¡€ä¸Šåˆ¶ä½œè€Œæˆ  åŸºç¡€æ¦‚å¿µ  æ–‡ä»¶æ ¼å¼    ç§ç±» ä¸»æ‹“å±•å ç§ç±» ä¸»æ‹“å±•å     å¯æ‰§è¡Œ EXE,SCR é©±åŠ¨ç¨‹åº SYS,VXD   åº“ç³»åˆ— DLL,OCX,C">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://npc0vo.github.io/2024/07/09/%E5%88%9D%E8%AF%86WindowsPE/8a74e7185d9f4d0e911e64800af9fba1.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/07/09/%E5%88%9D%E8%AF%86WindowsPE/4c40b78e815349a3b42a12836a162426.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/07/09/%E5%88%9D%E8%AF%86WindowsPE/43be0b18f2c845d2ab1d11cebde7a1e3.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/07/09/%E5%88%9D%E8%AF%86WindowsPE/6005873b9fc2440989a720fe1e34700f.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/07/09/%E5%88%9D%E8%AF%86WindowsPE/4a9dbb4f18724329aae2b2e23a77d709.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/07/09/%E5%88%9D%E8%AF%86WindowsPE/8a74e7185d9f4d0e911e64800af9fba1.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/07/09/%E5%88%9D%E8%AF%86WindowsPE/image-20240709221525439.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/07/09/%E5%88%9D%E8%AF%86WindowsPE/image-20240709224937160.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/07/09/%E5%88%9D%E8%AF%86WindowsPE/image-20240710193542122.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/07/09/%E5%88%9D%E8%AF%86WindowsPE/image-20240710224952220.png">
<meta property="article:published_time" content="2024-07-09T10:59:58.000Z">
<meta property="article:modified_time" content="2024-07-10T15:50:51.603Z">
<meta property="article:author" content="Npc">
<meta property="article:tag" content="Reverse">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://npc0vo.github.io/2024/07/09/%E5%88%9D%E8%AF%86WindowsPE/8a74e7185d9f4d0e911e64800af9fba1.png"><script>(function() {
  if (CONFIG.mode !== 'auto') return
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script></head><body><script src="https://code.iconify.design/2/2.1.1/iconify.min.js"></script><script>// Define global variable
IconifyProviders = {
  // Empty prefix: overwrite default API provider configuration
  '': {
    // Use custom API first, use Iconify public API as backup
    resources: [
        'https://api.iconify.design',
    ],
    // Wait for 1 second before switching API hosts
    rotate: 1000,
  },
};</script><script defer src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js" type="module"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="Table of Contents"><span class="icon iconify" data-icon="ri:list-ordered"></span></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="Overview"><span class="icon iconify" data-icon="ri:passport-line"></span></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="Npc"><img width="96" loading="lazy" src="/images/avatar.jpg" alt="Npc"><span class="site-author-status">ğŸ˜­</span></a><div class="site-author-name"><a href="/about/">Npc</a></div><span class="site-name">Npc | Blog</span><sub class="site-subtitle">æƒ³s</sub><div class="site-description"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="Home"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:home-4-line"></span></span></a><div class="site-state-item"><a href="/archives/" title="Archives"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:archive-line"></span></span><span class="site-state-item-count">70</span></a></div><div class="site-state-item"><a href="/categories/" title="Categories"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:folder-2-line"></span></span><span class="site-state-item-count">11</span></a></div><div class="site-state-item"><a href="/tags/" title="Tags"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="site-state-item-count">14</span></a></div><a class="site-state-item hty-icon-button" href="/about/#comment" title="ç•™è¨€æ¿"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:clipboard-line"></span></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/npc0vo" title="GitHub" target="_blank" style="color:#6e5494"><span class="icon iconify" data-icon="ri:github-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:me@1930278836@qq.com" title="E-Mail" target="_blank" style="color:#8E71C1"><span class="icon iconify" data-icon="ri:mail-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.yuque.com/npc0vo" title="Yuque" target="_blank" style="color:#a0c69d"><span class="icon iconify" data-icon="ri:yuque-line"></span></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="æˆ‘çš„å°ä¼™ä¼´ä»¬" style="color:dodgerblue"><span class="icon iconify" data-icon="ri:genderless-line"></span></a></div></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span class="toc-number">1.</span> <span class="toc-text"> åŸºç¡€æ¦‚å¿µ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F"><span class="toc-number">1.1.</span> <span class="toc-text"> æ–‡ä»¶æ ¼å¼</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pe%E8%A3%85%E8%BD%BD"><span class="toc-number">1.2.</span> <span class="toc-text"> PEè£…è½½</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pe%E7%BB%84%E6%88%90"><span class="toc-number">1.3.</span> <span class="toc-text"> PEç»„æˆ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#pe%E6%96%87%E4%BB%B6%E5%A4%B4"><span class="toc-number">1.3.1.</span> <span class="toc-text"> PEæ–‡ä»¶å¤´</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#pe%E5%A4%B4-image_nt_headers"><span class="toc-number">1.3.1.1.</span> <span class="toc-text"> PEå¤´ IMAGE_NT_HEADERS</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A9%E5%B1%95pe%E5%A4%B4%E5%8F%AF%E9%80%89%E5%A4%B4image_optional_header32"><span class="toc-number">1.3.2.</span> <span class="toc-text"> æ‰©å±•PEå¤´ï¼å¯é€‰å¤´(IMAGE_OPTIONAL_HEADERï¼“ï¼’)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#image_data_directory"><span class="toc-number">1.3.2.1.</span> <span class="toc-text"> IMAGE_DATA_DIRECTORY</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2"><span class="toc-number">1.4.</span> <span class="toc-text"> åœ°å€è½¬æ¢</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98"><span class="toc-number">1.4.1.</span> <span class="toc-text"> è™šæ‹Ÿå†…å­˜</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8A%82%E5%81%8F%E7%A7%BB"><span class="toc-number">1.4.2.</span> <span class="toc-text"> èŠ‚åç§»</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A5%E5%8F%A3%E7%82%B9oep"><span class="toc-number">1.5.</span> <span class="toc-text"> å…¥å£ç‚¹ï¼ˆOEPï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E6%98%A0%E5%83%8F"><span class="toc-number">1.6.</span> <span class="toc-text"> å†…å­˜æ˜ åƒ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%AF%E6%89%A7%E8%A1%8C%E7%A8%8B%E5%BA%8F%E5%9C%A8%E5%86%85%E5%AD%98%E4%B8%AD%E7%9A%84%E7%BB%84%E6%88%90"><span class="toc-number">1.6.1.</span> <span class="toc-text"> å¯æ‰§è¡Œç¨‹åºåœ¨å†…å­˜ä¸­çš„ç»„æˆ</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pe%E5%A4%B4"><span class="toc-number">2.</span> <span class="toc-text"> PEå¤´</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#dos%E5%A4%B4"><span class="toc-number">2.1.</span> <span class="toc-text"> DOSå¤´</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dosstub"><span class="toc-number">2.2.</span> <span class="toc-text"> DOSstub</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nt%E5%A4%B4"><span class="toc-number">2.3.</span> <span class="toc-text"> NTå¤´</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#nt%E5%A4%B4file-header"><span class="toc-number">2.3.1.</span> <span class="toc-text"> NTå¤´:FILE Header</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#nt%E5%A4%B4%E5%8F%AF%E9%80%89%E5%A4%B4"><span class="toc-number">2.3.2.</span> <span class="toc-text"> NTå¤´:å¯é€‰å¤´</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8A%82%E5%8C%BA%E5%A4%B4"><span class="toc-number">2.4.</span> <span class="toc-text"> èŠ‚åŒºå¤´</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#image_section_header"><span class="toc-number">2.4.1.</span> <span class="toc-text"> IMAGE_SECTION_HEADER</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rva-to-raw"><span class="toc-number">3.</span> <span class="toc-text"> RVA to RAW</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#iat"><span class="toc-number">4.</span> <span class="toc-text"> IAT</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#dll"><span class="toc-number">4.1.</span> <span class="toc-text"> DLL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#image_import_descriptor"><span class="toc-number">4.2.</span> <span class="toc-text"> IMAGE_IMPORT_DESCRIPTOR</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#eat"><span class="toc-number">5.</span> <span class="toc-text"> EAT</span></a></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#0078E7;"><link itemprop="mainEntityOfPage" href="http://npc0vo.github.io/2024/07/09/%E5%88%9D%E8%AF%86WindowsPE/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="Npc"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="Npc | Blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">åˆè¯†WindowsPE</h1><div class="post-meta"><div class="post-time" style="display:block"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-line"></span></span> <time title="Created: 2024-07-09 18:59:58" itemprop="dateCreated datePublished" datetime="2024-07-09T18:59:58+08:00">2024-07-09</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-2-line"></span></span> <time title="Modified: 2024-07-10 23:50:51" itemprop="dateModified" datetime="2024-07-10T23:50:51+08:00">2024-07-10</time></div><span class="post-count"><span class="post-symbolcount"><span class="post-meta-item-icon" title="Word count in article"><span class="icon iconify" data-icon="ri:file-word-line"></span></span> <span title="Word count in article">4.9k</span><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="Reading time"><span class="icon iconify" data-icon="ri:timer-line"></span></span> <span title="Reading time">19m</span></span></span><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><span class="icon iconify" data-icon="ri:folder-line"></span></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/Reverse/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">Reverse</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/Reverse/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="tag-name">Reverse</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><p>å…ˆç®€å•äº†è§£ä¸€ä¸‹ï¼ŒåæœŸè·Ÿç€&quot;PEæƒå¨æŒ‡å—&quot;è¯¦ç»†å­¦ä¹ </p>
<p><code>PE</code>ï¼ˆPortableæ–‡ä»¶æ˜¯<code>Windows</code>ä¸‹ä½¿ç”¨çš„å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼</p>
<p>åŸºäºUNIXå¹³å°çš„<code>COFF</code>(Common Object File Format é€šç”¨å¯¹è±¡æ–‡ä»¶æ ¼å¼)åŸºç¡€ä¸Šåˆ¶ä½œè€Œæˆ</p>
<h2 id="åŸºç¡€æ¦‚å¿µ"><a class="markdownIt-Anchor" href="#åŸºç¡€æ¦‚å¿µ"></a> åŸºç¡€æ¦‚å¿µ</h2>
<h3 id="æ–‡ä»¶æ ¼å¼"><a class="markdownIt-Anchor" href="#æ–‡ä»¶æ ¼å¼"></a> æ–‡ä»¶æ ¼å¼</h3>
<table>
<thead>
<tr>
<th>ç§ç±»</th>
<th>ä¸»æ‹“å±•å</th>
<th>ç§ç±»</th>
<th>ä¸»æ‹“å±•å</th>
</tr>
</thead>
<tbody>
<tr>
<td>å¯æ‰§è¡Œ</td>
<td>EXE,SCR</td>
<td>é©±åŠ¨ç¨‹åº</td>
<td>SYS,VXD</td>
</tr>
<tr>
<td>åº“ç³»åˆ—</td>
<td>DLL,OCX,CPL,DRV</td>
<td>å¯¹è±¡æ–‡ä»¶</td>
<td>OBJ</td>
</tr>
</tbody>
</table>
<p>ä¸¥æ ¼æ¥è¯´ï¼Œé™¤äº†<code>OBJ</code>çš„æ‰€æœ‰æ–‡ä»¶éƒ½å¯ä»¥æ‰§è¡Œï¼Œåªæ˜¯<code>DLL</code>,<code>SYS</code>ç­‰æ–‡ä»¶ä¸èƒ½ç›´æ¥åœ¨<code>SHELL</code>(explorer.exe)ä¸­æ‰§è¡Œï¼Œä½†æ˜¯å¯ä»¥åœ¨å…¶ä»–ç¯å¢ƒä¸‹(è°ƒè¯•å™¨ï¼ŒæœåŠ¡)ç­‰æ‰§è¡Œ</p>
<h3 id="peè£…è½½"><a class="markdownIt-Anchor" href="#peè£…è½½"></a> PEè£…è½½</h3>
<ul>
<li>å½“PEæ–‡ä»¶è¢«æ‰§è¡Œï¼ŒPEè£…è½½å™¨æ£€æŸ¥<code>DOS MZ header</code>é‡Œçš„<code>PE header</code>åç§»é‡ï¼Œå¦‚æœæ‰¾åˆ°ï¼Œåˆ™è·³è½¬åˆ°<code>PE header</code></li>
<li><code>PE</code>è£…è½½å™¨æ£€æŸ¥<code>PE header</code>çš„æœ‰æ•ˆæ€§ï¼Œå¦‚æœæœ‰æ•ˆï¼Œåˆ™è·³è½¬åˆ°<code>PE header</code>çš„å°¾éƒ¨</li>
<li><code>PE header</code>åé¢æ˜¯èŠ‚è¡¨ã€‚PEè£…è½½å™¨è¯»å–å…¶ä¸­çš„èŠ‚ä¿¡æ¯ï¼Œå¹¶é‡‡ç”¨æ–‡ä»¶æ˜ å°„çš„æ–¹æ³•ï¼Œå°†è¿™äº›èŠ‚æ˜ å°„åˆ°å†…å­˜ï¼ŒåŒæ—¶èµ‹ä¸ŠèŠ‚è¡¨é‡ŒæŒ‡å®šçš„èŠ‚å±æ€§</li>
<li>PEæ–‡ä»¶æ˜ å°„å…¥å†…å­˜åï¼Œ<code>PE</code>è£…è½½å™¨å°†å¤„ç†<code>PE</code>æ–‡ä»¶ä¸­ç±»ä¼¼<code>import table</code>å¼•å…¥è¡¨é€»è¾‘éƒ¨åˆ†</li>
</ul>
<h3 id="peç»„æˆ"><a class="markdownIt-Anchor" href="#peç»„æˆ"></a> PEç»„æˆ</h3>
<p>PEæ–‡ä»¶å¤§ä½“åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</p>
<p>å¤´ (åŒ…æ‹¬ä¸‹å›¾ä¸­çš„DOSå¤´ï¼ŒPEæ–‡ä»¶å¤´ï¼Œå—è¡¨ Section Table)</p>
<p>ä¸»ä½“ ( å—Section)ã€‚</p>
<img src="/2024/07/09/%E5%88%9D%E8%AF%86WindowsPE/8a74e7185d9f4d0e911e64800af9fba1.png" class="" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" loading="lazy">
<h4 id="peæ–‡ä»¶å¤´"><a class="markdownIt-Anchor" href="#peæ–‡ä»¶å¤´"></a> PEæ–‡ä»¶å¤´</h4>
<img src="/2024/07/09/%E5%88%9D%E8%AF%86WindowsPE/4c40b78e815349a3b42a12836a162426.png" class="" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" loading="lazy">
<h5 id="peå¤´-image_nt_headers"><a class="markdownIt-Anchor" href="#peå¤´-image_nt_headers"></a> PEå¤´ IMAGE_NT_HEADERS</h5>
<p>åŒ…å«ä¸‰éƒ¨åˆ†</p>
<ul>
<li>â€œPE\0\0â€</li>
<li>IMAGE_FILE_HEADER</li>
<li>IMAGE_OPTIONAL_HEADER32</li>
</ul>
<h4 id="æ‰©å±•peå¤´å¯é€‰å¤´image_optional_header32"><a class="markdownIt-Anchor" href="#æ‰©å±•peå¤´å¯é€‰å¤´image_optional_header32"></a> æ‰©å±•PEå¤´ï¼å¯é€‰å¤´(IMAGE_OPTIONAL_HEADERï¼“ï¼’)</h4>
<img src="/2024/07/09/%E5%88%9D%E8%AF%86WindowsPE/43be0b18f2c845d2ab1d11cebde7a1e3.png" class="" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" loading="lazy">
<h5 id="image_data_directory"><a class="markdownIt-Anchor" href="#image_data_directory"></a> IMAGE_DATA_DIRECTORY</h5>
<p>æ•°æ®ç›®å½•é¡¹ï¼Œç»„æˆæœ‰</p>
<ul>
<li>å¯¼å‡ºè¡¨ã€</li>
<li>å¯¼å…¥è¡¨ã€</li>
<li>èµ„æºè¡¨ã€</li>
<li>å¼‚å¸¸å¤„ç†è¡¨ã€</li>
<li>å®‰å…¨è¡¨ã€(Certificate Table)</li>
<li>é‡å®šä½è¡¨ã€</li>
<li>è°ƒè¯•è¡¨ã€</li>
<li>ç‰ˆæƒã€</li>
<li>æŒ‡é’ˆç›®å½•ã€</li>
<li>TLSã€</li>
<li>è½½å…¥é…ç½®ã€</li>
<li>ç»‘å®šè¾“å…¥ç›®å½•ã€</li>
<li>å¯¼å…¥åœ°å€è¡¨ã€</li>
<li>å»¶è¿Ÿè½½å…¥ã€</li>
<li>COMä¿¡æ¯ã€‚</li>
</ul>
<h3 id="åœ°å€è½¬æ¢"><a class="markdownIt-Anchor" href="#åœ°å€è½¬æ¢"></a> åœ°å€è½¬æ¢</h3>
<h4 id="è™šæ‹Ÿå†…å­˜"><a class="markdownIt-Anchor" href="#è™šæ‹Ÿå†…å­˜"></a> è™šæ‹Ÿå†…å­˜</h4>
<p>æ–‡ä»¶åç§»åœ°å€ï¼ˆFile Offset Addressï¼‰ ï¼šæ–‡ä»¶ç›¸å¯¹äºæ–‡ä»¶å¼€å¤´çš„åç§»</p>
<p>è£…è½½åŸºå€ï¼ˆImage Baseï¼‰ ï¼šPEè£…å…¥å†…å­˜æ—¶çš„åŸºåœ°å€ï¼ŒEXEåœ¨å†…å­˜ä¸­çš„åŸºåœ°å€æ˜¯0x00400000,DLLçš„åŸºåœ°å€æ˜¯0x10000000ï¼Œè¿™äº›ä½ç½®å¯ä»¥é€šè¿‡ä¿®æ”¹ç¼–è¯‘é€‰é¡¹æ›´æ”¹</p>
<p>è™šæ‹Ÿå†…å­˜åœ°å€ ï¼ˆVirtual Addressï¼Œ VAï¼‰ ï¼šPEæ–‡ä»¶ä¸­çš„æŒ‡ä»¤è¢«è£…å…¥å†…å­˜åçš„åœ°å€ï¼Œåœ¨Windowsç³»ç»Ÿä¸­ï¼ŒPEæ–‡ä»¶è¢«ç³»ç»ŸåŠ è½½å™¨æ˜ å°„åˆ°å†…å­˜ä¸­ã€‚æ¯ä¸ªç¨‹åºéƒ½æœ‰è‡ªå·±çš„è™šæ‹Ÿç©ºé—´ï¼Œè¿™ä¸ªè™šæ‹Ÿç©ºé—´çš„å†…å­˜åœ°å€ç§°ä¸ºè™šæ‹Ÿåœ°å€ï¼ˆVirtual Address,VAï¼‰ã€‚</p>
<p>ç›¸å¯¹è™šæ‹Ÿåœ°å€ï¼ˆRelative Virtual Addressï¼ŒRVAï¼‰ ï¼šç›¸å¯¹è™šæ‹Ÿåœ°å€æ˜¯å†…å­˜åœ°å€ç›¸å¯¹äºæ˜ å°„åŸºåœ°å€åç§»é‡</p>
<p><mark>VA=ImageBase+RVA</mark></p>
<h4 id="èŠ‚åç§»"><a class="markdownIt-Anchor" href="#èŠ‚åç§»"></a> èŠ‚åç§»</h4>
<p>èŠ‚åç§» ï¼šPEæ–‡ä»¶ä¸­çš„æ•°æ®æŒ‰ç…§ç£ç›˜æ•°æ®æ ‡å‡†å­˜æ”¾ï¼Œä»¥0x200å­—èŠ‚ä¸ºåŸºæœ¬å•ä½è¿›è¡Œç»„ç»‡ï¼Œå½“PEæ–‡ä»¶è£…è½½åˆ°å†…å­˜æ—¶ï¼Œå°†æŒ‰ç…§å†…å­˜æ•°æ®æ ‡å‡†å­˜æ”¾ï¼Œä»¥0x1000å­—èŠ‚ä¸ºåŸºæœ¬å•ä½ï¼Œæ‰€ä»¥æ–‡ä»¶åç§»åœ°å€å’Œç›¸å¯¹è™šæ‹Ÿå†…å­˜ä¼šæœ‰ç»†å¾®çš„å·®åˆ«ï¼Œè¿™ç§å·®åˆ«ç§°ä¸ºèŠ‚åç§»</p>
<p>SectionAlignment : å†…å­˜å½“ä¸­çš„å—å¯¹é½æ•°ï¼Œä¸€èˆ¬ä¸º0x1000ã€‚</p>
<p>FileAlignment :ç£ç›˜å½“ä¸­å—å¯¹é½æ•°ï¼Œä¸€èˆ¬ä¸º0x200ã€‚</p>
<p><mark>æ–‡ä»¶åç§»åœ°å€ = è™šæ‹Ÿå†…å­˜åœ°å€ï¼ˆVAï¼‰- è£…è½½åŸºå€ï¼ˆImageBaseï¼‰- èŠ‚åç§»<br />
= RVA â€“èŠ‚åç§»</mark></p>
<h3 id="å…¥å£ç‚¹oep"><a class="markdownIt-Anchor" href="#å…¥å£ç‚¹oep"></a> å…¥å£ç‚¹ï¼ˆOEPï¼‰</h3>
<p>å…¥å£ç‚¹(Original Entry Point) ï¼š é¦–å…ˆæ˜ç¡®ä¸€ä¸ªæ¦‚å¿µå°±æ˜¯<strong>OEPæ˜¯ä¸€ä¸ªRVA</strong>ï¼Œç„¶åä½¿ç”¨OEP +Imagebase ==å…¥å£ç‚¹çš„VAï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼ŒOEPæŒ‡å‘çš„ä¸æ˜¯mainå‡½æ•°ã€‚</p>
<p>(å¾€å¾€æ˜¯CRT)</p>
<h3 id="å†…å­˜æ˜ åƒ"><a class="markdownIt-Anchor" href="#å†…å­˜æ˜ åƒ"></a> å†…å­˜æ˜ åƒ</h3>
<p>PEæ–‡ä»¶ä¸æ˜¯ä½œä¸ºå•ä¸€å†…å­˜æ˜ å°„æ–‡ä»¶ï¼Œè¢«è½½å…¥çš„å†…å­˜æ˜¯å¾ˆé‡è¦çš„ã€‚WindowsåŠ è½½å™¨ï¼ˆåˆç§°PEè£…è½½å™¨ï¼‰éå†PEæ–‡ä»¶å¹¶å†³å®šæ–‡ä»¶çš„å“ªä¸€éƒ¨åˆ†è¢«æ˜ å°„ï¼Œè¿™ç§æ˜ å°„æ–¹å¼æ˜¯å°†æ–‡ä»¶è¾ƒé«˜çš„åç§»ä½ç½®æ˜ å°„åˆ°è¾ƒé«˜çš„å†…å­˜åœ°å€ä¸­ã€‚ç£ç›˜æ–‡ä»¶ä¸€æ—¦è¢«è½½å…¥å†…å­˜ï¼Œç£ç›˜ä¸Šçš„æ•°æ®ç»“æ„å¸ƒå±€å’Œå†…å­˜ä¸­çš„æ•°æ®ç»“æ„å¸ƒå±€å°±æ˜¯ä¸€è‡´çš„ã€‚</p>
<img src="/2024/07/09/%E5%88%9D%E8%AF%86WindowsPE/6005873b9fc2440989a720fe1e34700f.png" class="" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" loading="lazy">
<p>å½“PEæ–‡ä»¶é€šè¿‡<code>Windows</code>åŠ è½½å™¨è½½å…¥å†…å­˜åï¼ŒPEåœ¨å†…å­˜ä¸­çš„ç‰ˆæœ¬ç§°ä¸ºæ¨¡å—(Module)</p>
<p>æ˜ å°„æ–‡ä»¶çš„èµ·å§‹åœ°å€ç§°ä¸ºæ¨¡å—å¥æŸ„(hModule)</p>
<p>å¯ä»¥é€šè¿‡æ¨¡å—å¥æŸ„è®¿é—®å†…å­˜ä¸­çš„å…¶ä»–æ•°æ®ç»“æ„ï¼Œè¿™ä¸ªåˆå§‹å†…å­˜åœ°å€ä¹Ÿç§°ä¸ºåŸºåœ°å€ImageBase</p>
<h4 id="å¯æ‰§è¡Œç¨‹åºåœ¨å†…å­˜ä¸­çš„ç»„æˆ"><a class="markdownIt-Anchor" href="#å¯æ‰§è¡Œç¨‹åºåœ¨å†…å­˜ä¸­çš„ç»„æˆ"></a> å¯æ‰§è¡Œç¨‹åºåœ¨å†…å­˜ä¸­çš„ç»„æˆ</h4>
<p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸€ä¸ªå¯æ‰§è¡ŒCç¨‹åºåœ¨å†…å­˜ä¸­ä¸»è¦åŒ…å«5ä¸ªåŒºåŸŸï¼Œåˆ†åˆ«æ˜¯**ä»£ç æ®µï¼ˆtextï¼‰ï¼Œæ•°æ®æ®µï¼ˆdataï¼‰ï¼ŒBSSæ®µï¼Œå †æ®µï¼ˆheapï¼‰å’Œæ ˆæ®µï¼ˆstackï¼‰ã€‚**å…¶ä¸­å‰ä¸‰ä¸ªæ®µï¼ˆtextï¼Œdataï¼Œbssï¼‰æ˜¯ç¨‹åºç¼–è¯‘å®Œæˆå°±å­˜åœ¨çš„ï¼Œæ­¤æ—¶ç¨‹åºå¹¶æœªè½½å…¥å†…å­˜è¿›è¡Œæ‰§è¡Œã€‚åä¸¤ä¸ªæ®µï¼ˆheapï¼Œstackï¼‰æ˜¯ç¨‹åºè¢«åŠ è½½åˆ°å†…å­˜ä¸­æ—¶ï¼Œæ‰å­˜åœ¨çš„ã€‚å…·ä½“çš„æ ·å­å¯ä»¥å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<img src="/2024/07/09/%E5%88%9D%E8%AF%86WindowsPE/4a9dbb4f18724329aae2b2e23a77d709.png" class="" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" loading="lazy">
<p>æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡ï¼Œå­˜å‚¨åœ¨bssåŒºï¼Œ æœªåˆå§‹åŒ–çš„å±€éƒ¨å˜é‡ä¿å­˜åœ¨æ ˆåŒºã€‚</p>
<p>ä»£ç æ®µï¼ˆtextï¼‰ï¼šå°±æ˜¯Cç¨‹åºç¼–è¯‘åçš„æœºå™¨æŒ‡ä»¤ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è§çš„æ±‡ç¼–ä»£ç ã€‚</p>
<p>æ•°æ®æ®µï¼ˆdataï¼‰ï¼šç”¨æ¥å­˜æ”¾æ˜¾å¼åˆå§‹åŒ–çš„å…¨å±€å˜é‡æˆ–è€…é™æ€ï¼ˆå…¨å±€ï¼‰å˜é‡ï¼Œå¸¸é‡æ•°æ®ã€‚</p>
<p>BSSæ®µï¼ˆBlock Started by Symbol): å­˜å‚¨æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡æˆ–è€…é™æ€ï¼ˆå…¨å±€ï¼‰å˜é‡ã€‚ç¼–è¯‘å™¨ç»™å¤„ç†æˆ0ï¼›</p>
<p>æ ˆæ®µ(stack)ï¼šå­˜æ”¾å‡½æ•°è°ƒç”¨ç›¸å…³çš„å‚æ•°ã€å±€éƒ¨å˜é‡çš„å€¼ï¼Œä»¥åŠåœ¨ä»»åŠ¡åˆ‡æ¢çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚æ ˆåŒºæ˜¯ç”±æ“ä½œç³»ç»Ÿåˆ†é…å’Œç®¡ç†çš„åŒºåŸŸã€‚</p>
<p>å †æ®µï¼ˆheap): åŠ¨æ€å†…å­˜åˆ†é…çš„åŒºåŸŸï¼Œä¹Ÿå°±æ˜¯mallocç”³è¯·çš„å†…å­˜åŒºï¼Œä½¿ç”¨free()å‡½æ•°æ¥é‡Šæ”¾å†…å­˜ï¼Œå †çš„ç”³è¯·é‡Šæ”¾å·¥ä½œç”±ç¨‹åºå‘˜æ§åˆ¶ï¼Œå®¹æ˜“äº§ç”Ÿå†…å­˜æ³„æ¼ã€‚</p>
<p>åŒ…å«dataæ®µå’Œbssæ®µçš„æ•´ä¸ªåŒºæ®µæ­¤æ—¶é€šå¸¸ç§°ä¸ºæ•°æ®åŒºã€‚<br />
<strong>auto</strong>å­˜å‚¨ç±»å‹ï¼šautoåªèƒ½ç”¨æ¥æ ‡è¯†å±€éƒ¨å˜é‡çš„å­˜å‚¨ç±»å‹ï¼Œå¯¹äºå±€éƒ¨å˜é‡ï¼Œautoæ˜¯é»˜è®¤çš„å­˜å‚¨ç±»å‹ï¼Œä¸éœ€è¦æ˜¾ç¤ºçš„æŒ‡å®šã€‚å› æ­¤ï¼Œautoæ ‡è¯†çš„å˜é‡å­˜å‚¨åœ¨<strong>æ ˆåŒº</strong>ä¸­ã€‚</p>
<p><strong>extern</strong>å­˜å‚¨ç±»å‹ï¼šexternç”¨æ¥å£°æ˜åœ¨å½“å‰æ–‡ä»¶ä¸­å¼•ç”¨åœ¨å½“å‰é¡¹ç›®ä¸­çš„å…¶å®ƒæ–‡ä»¶ä¸­å®šä¹‰çš„å…¨å±€å˜é‡ã€‚å¦‚æœå…¨å±€å˜é‡<strong>æœªè¢«åˆå§‹åŒ–ï¼Œé‚£ä¹ˆå°†è¢«å­˜åœ¨BBSåŒºä¸­ï¼Œä¸”åœ¨ç¼–è¯‘æ—¶ï¼Œè‡ªåŠ¨å°†å…¶å€¼èµ‹å€¼ä¸º0ï¼Œå¦‚æœå·²ç»è¢«åˆå§‹åŒ–ï¼Œé‚£ä¹ˆå°±è¢«å­˜åœ¨æ•°æ®åŒºä¸­ã€‚</strong></p>
<p><strong>register</strong>å­˜å‚¨ç±»å‹ï¼šå£°æ˜ä¸ºregisterçš„å˜é‡åœ¨ç”±å†…å­˜è°ƒå…¥åˆ°CPUå¯„å­˜å™¨åï¼Œåˆ™å¸¸é©»åœ¨CPUçš„<strong>å¯„å­˜å™¨</strong>ä¸­ï¼Œå› æ­¤è®¿é—®registerå˜é‡å°†åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šæé«˜æ•ˆç‡ï¼Œå› ä¸ºçœå»äº†å˜é‡ç”±å†…å­˜è°ƒå…¥åˆ°å¯„å­˜å™¨è¿‡ç¨‹ä¸­çš„å¥½å‡ ä¸ªæŒ‡ä»¤å‘¨æœŸã€‚åœ¨C++ä¸­ï¼Œä¾‹å¦‚ while(iâ€“){}; å¯¹å˜é‡ i æœ‰é¢‘ç¹çš„æ“ä½œï¼Œç¼–è¯‘å™¨ä¼šå°†å…¶å­˜å‚¨åœ¨å¯„å­˜å™¨ä¸­ã€‚</p>
<p><strong>static</strong>å­˜å‚¨ç±»å‹ï¼šè¢«å£°æ˜ä¸ºé™æ€ç±»å‹çš„å˜é‡ï¼Œæ— è®ºæ˜¯å…¨å±€çš„è¿˜æ˜¯å±€éƒ¨çš„ï¼Œéƒ½å­˜å‚¨åœ¨æ•°æ®åŒºä¸­ï¼Œå…¶ç”Ÿå‘½å‘¨æœŸä¸ºæ•´ä¸ªç¨‹åºï¼Œå¦‚æœæ˜¯é™æ€å±€éƒ¨å˜é‡ï¼Œå…¶ä½œç”¨åŸŸä¸ºä¸€å¯¹{}å†…ï¼Œå¦‚æœæ˜¯é™æ€å…¨å±€å˜é‡ï¼Œå…¶ä½œç”¨åŸŸä¸ºå½“å‰æ–‡ä»¶ã€‚é™æ€å˜é‡å¦‚æœæ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œåˆ™è‡ªåŠ¨åˆå§‹åŒ–ä¸º0ã€‚é™æ€å˜é‡åªèƒ½å¤Ÿåˆå§‹åŒ–ä¸€æ¬¡ã€‚</p>
<p><strong>å­—ç¬¦ä¸²å¸¸é‡</strong>ï¼šå­—ç¬¦ä¸²å¸¸é‡å­˜å‚¨åœ¨æ•°æ®åŒºä¸­ï¼Œå…¶ç”Ÿå­˜æœŸä¸ºæ•´ä¸ªç¨‹åºè¿è¡Œæ—¶é—´ï¼Œä½†ä½œç”¨åŸŸä¸ºå½“å‰æ–‡ä»¶ã€‚</p>
<h2 id="peå¤´"><a class="markdownIt-Anchor" href="#peå¤´"></a> PEå¤´</h2>
<img src="/2024/07/09/%E5%88%9D%E8%AF%86WindowsPE/8a74e7185d9f4d0e911e64800af9fba1.png" class="" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" loading="lazy">
<h3 id="doså¤´"><a class="markdownIt-Anchor" href="#doså¤´"></a> DOSå¤´</h3>
<p>è¿™æ˜¯å¾®è½¯è€ƒè™‘PEæ–‡ä»¶å¯¹DOSæ–‡ä»¶çš„å…¼å®¹æ€§æ‰€åŠ </p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_IMAGE_DOS_HEADER</span> <span class="token punctuation">&#123;</span>      <span class="token comment">// DOS .EXE header</span>
    WORD   e_magic<span class="token punctuation">;</span>                     <span class="token comment">// Magic number</span>
    WORD   e_cblp<span class="token punctuation">;</span>                      <span class="token comment">// Bytes on last page of file</span>
    WORD   e_cp<span class="token punctuation">;</span>                        <span class="token comment">// Pages in file</span>
    WORD   e_crlc<span class="token punctuation">;</span>                      <span class="token comment">// Relocations</span>
    WORD   e_cparhdr<span class="token punctuation">;</span>                   <span class="token comment">// Size of header in paragraphs</span>
    WORD   e_minalloc<span class="token punctuation">;</span>                  <span class="token comment">// Minimum extra paragraphs needed</span>
    WORD   e_maxalloc<span class="token punctuation">;</span>                  <span class="token comment">// Maximum extra paragraphs needed</span>
    WORD   e_ss<span class="token punctuation">;</span>                        <span class="token comment">// Initial (relative) SS value</span>
    WORD   e_sp<span class="token punctuation">;</span>                        <span class="token comment">// Initial SP value</span>
    WORD   e_csum<span class="token punctuation">;</span>                      <span class="token comment">// Checksum</span>
    WORD   e_ip<span class="token punctuation">;</span>                        <span class="token comment">// Initial IP value</span>
    WORD   e_cs<span class="token punctuation">;</span>                        <span class="token comment">// Initial (relative) CS value</span>
    WORD   e_lfarlc<span class="token punctuation">;</span>                    <span class="token comment">// File address of relocation table</span>
    WORD   e_ovno<span class="token punctuation">;</span>                      <span class="token comment">// Overlay number</span>
    WORD   e_res<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                    <span class="token comment">// Reserved words</span>
    WORD   e_oemid<span class="token punctuation">;</span>                     <span class="token comment">// OEM identifier (for e_oeminfo)</span>
    WORD   e_oeminfo<span class="token punctuation">;</span>                   <span class="token comment">// OEM information; e_oemid specific</span>
    WORD   e_res2<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                  <span class="token comment">// Reserved words</span>
    LONG   e_lfanew<span class="token punctuation">;</span>                    <span class="token comment">// File address of new exe header</span>
  <span class="token punctuation">&#125;</span> IMAGE_DOS_HEADER<span class="token punctuation">,</span> <span class="token operator">*</span>PIMAGE_DOS_HEADER<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><mark>IMAGE_DOS_HEADER</mark>ç»“æ„ä½“çš„å¤§å°ä¸º<mark>40ä¸ªå­—èŠ‚</mark></p>
<p>å¿…é¡»çŸ¥é“çš„ä¸¤ä¸ªé‡è¦æˆå‘˜</p>
<ul>
<li>
<p><mark>e_magic</mark> DOSç­¾å   4D5A - &gt;  â€œMZâ€</p>
</li>
<li>
<p><mark>e_lfanew</mark>æŒ‡ç¤ºNTå¤´çš„åç§»(ä¸åŒæ–‡ä»¶å€¼ä¸åŒ)</p>
</li>
</ul>
<h3 id="dosstub"><a class="markdownIt-Anchor" href="#dosstub"></a> DOSstub</h3>
<p>DOSå­˜æ ¹(stub)åœ¨IAMGE_DOS_HEADERä¸‹æ–¹</p>
<img src="/2024/07/09/%E5%88%9D%E8%AF%86WindowsPE/image-20240709221525439.png" class="" alt="image-20240709221525439" loading="lazy">
<p>ç”±ä»£ç ä¸æ•°æ®æ··åˆè€Œæˆï¼Œå³ä½¿æ²¡æœ‰DOSå­˜æ ¹ï¼Œæ–‡ä»¶ä¹Ÿèƒ½æ­£å¸¸è¿è¡Œ</p>
<h3 id="ntå¤´"><a class="markdownIt-Anchor" href="#ntå¤´"></a> NTå¤´</h3>
<p><mark>IMAGE_NT_HEADERS</mark>ç»“æ„ä½“çš„å¤§å°ä¸º<mark>F8</mark>ï¼Œå¾ˆå¤§</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_IMAGE_NT_HEADERS</span> <span class="token punctuation">&#123;</span>
    DWORD Signature<span class="token punctuation">;</span>
    IMAGE_FILE_HEADER FileHeader<span class="token punctuation">;</span>
    IMAGE_OPTIONAL_HEADER32 OptionalHeader<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> IMAGE_NT_HEADERS32<span class="token punctuation">,</span> <span class="token operator">*</span>PIMAGE_NT_HEADERS32<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>Signature å€¼ä¸º0x50450000h å³PE00</li>
<li>FILE Header æ–‡ä»¶å¤´</li>
<li>OptionalHeader å¯é€‰å¤´æ–‡ä»¶ç»“æ„ä½“</li>
</ul>
<h4 id="ntå¤´file-header"><a class="markdownIt-Anchor" href="#ntå¤´file-header"></a> NTå¤´:FILE Header</h4>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_IMAGE_FILE_HEADER</span> <span class="token punctuation">&#123;</span>
    WORD    Machine<span class="token punctuation">;</span>
    WORD    NumberOfSections<span class="token punctuation">;</span>
    DWORD   TimeDateStamp<span class="token punctuation">;</span>
    DWORD   PointerToSymbolTable<span class="token punctuation">;</span>
    DWORD   NumberOfSymbols<span class="token punctuation">;</span>
    WORD    SizeOfOptionalHeader<span class="token punctuation">;</span>
    WORD    Characteristics<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> IMAGE_FILE_HEADER<span class="token punctuation">,</span> <span class="token operator">*</span>PIMAGE_FILE_HEADER<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æœ‰4ä¸ªæ¯”è¾ƒé‡è¦çš„æˆå‘˜</p>
<ol>
<li>
<p>Machine æ¯ä¸ªä¸åŒç§ç±»çš„CPUéƒ½æœ‰å”¯ä¸€çš„<code>Machine</code>ç </p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_MACHINE_I386</span>              <span class="token expression"><span class="token number">0x014c</span>  </span><span class="token comment">// Intel 386.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_MACHINE_R3000</span>             <span class="token expression"><span class="token number">0x0162</span>  </span><span class="token comment">// MIPS little-endian, 0x160 big-endian</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_MACHINE_R4000</span>             <span class="token expression"><span class="token number">0x0166</span>  </span><span class="token comment">// MIPS little-endian</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_MACHINE_R10000</span>            <span class="token expression"><span class="token number">0x0168</span>  </span><span class="token comment">// MIPS little-endian</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_MACHINE_WCEMIPSV2</span>         <span class="token expression"><span class="token number">0x0169</span>  </span><span class="token comment">// MIPS little-endian WCE v2</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_MACHINE_ALPHA</span>             <span class="token expression"><span class="token number">0x0184</span>  </span><span class="token comment">// Alpha_AXP</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_MACHINE_SH3</span>               <span class="token expression"><span class="token number">0x01a2</span>  </span><span class="token comment">// SH3 little-endian</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_MACHINE_SH3DSP</span>            <span class="token expression"><span class="token number">0x01a3</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_MACHINE_SH3E</span>              <span class="token expression"><span class="token number">0x01a4</span>  </span><span class="token comment">// SH3E little-endian</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_MACHINE_SH4</span>               <span class="token expression"><span class="token number">0x01a6</span>  </span><span class="token comment">// SH4 little-endian</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_MACHINE_SH5</span>               <span class="token expression"><span class="token number">0x01a8</span>  </span><span class="token comment">// SH5</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_MACHINE_ARM</span>               <span class="token expression"><span class="token number">0x01c0</span>  </span><span class="token comment">// ARM Little-Endian</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_MACHINE_THUMB</span>             <span class="token expression"><span class="token number">0x01c2</span>  </span><span class="token comment">// ARM Thumb/Thumb-2 Little-Endian</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_MACHINE_ARMNT</span>             <span class="token expression"><span class="token number">0x01c4</span>  </span><span class="token comment">// ARM Thumb-2 Little-Endian</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_MACHINE_AM33</span>              <span class="token expression"><span class="token number">0x01d3</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_MACHINE_POWERPC</span>           <span class="token expression"><span class="token number">0x01F0</span>  </span><span class="token comment">// IBM PowerPC Little-Endian</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_MACHINE_POWERPCFP</span>         <span class="token expression"><span class="token number">0x01f1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_MACHINE_IA64</span>              <span class="token expression"><span class="token number">0x0200</span>  </span><span class="token comment">// Intel 64</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_MACHINE_MIPS16</span>            <span class="token expression"><span class="token number">0x0266</span>  </span><span class="token comment">// MIPS</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_MACHINE_ALPHA64</span>           <span class="token expression"><span class="token number">0x0284</span>  </span><span class="token comment">// ALPHA64</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_MACHINE_MIPSFPU</span>           <span class="token expression"><span class="token number">0x0366</span>  </span><span class="token comment">// MIPS</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_MACHINE_MIPSFPU16</span>         <span class="token expression"><span class="token number">0x0466</span>  </span><span class="token comment">// MIPS</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_MACHINE_AXP64</span>             <span class="token expression">IMAGE_FILE_MACHINE_ALPHA64</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_MACHINE_TRICORE</span>           <span class="token expression"><span class="token number">0x0520</span>  </span><span class="token comment">// Infineon</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_MACHINE_CEF</span>               <span class="token expression"><span class="token number">0x0CEF</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_MACHINE_EBC</span>               <span class="token expression"><span class="token number">0x0EBC</span>  </span><span class="token comment">// EFI Byte Code</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_MACHINE_AMD64</span>             <span class="token expression"><span class="token number">0x8664</span>  </span><span class="token comment">// AMD64 (K8)</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_MACHINE_M32R</span>              <span class="token expression"><span class="token number">0x9041</span>  </span><span class="token comment">// M32R little-endian</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_MACHINE_ARM64</span>             <span class="token expression"><span class="token number">0xAA64</span>  </span><span class="token comment">// ARM64 Little-Endian</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_MACHINE_CEE</span>               <span class="token expression"><span class="token number">0xC0EE</span></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>
<p>NumberOfSections</p>
<p>PEæ–‡ä»¶æŠŠä»£ç ï¼Œæ•°æ®ï¼Œèµ„æºç­‰ä¾æ®å±æ€§åˆ†ç±»åˆ°å„èŠ‚ä¸­å­˜å‚¨</p>
<p>è¿™ä¸ªå€¼æŒ‡å‡ºäº†æ–‡ä»¶ä¸­å­˜åœ¨çš„èŠ‚åŒºæ•°é‡ï¼Œå€¼æ¯”å¤§äº0ï¼Œå¦‚æœå®šä¹‰çš„èŠ‚åŒºæ•°é‡ä¸å®é™…æƒ…å†µä¸ç¬¦ï¼Œè¿è¡Œé”™è¯¯</p>
</li>
<li>
<p>SizeOfOptionalHeader</p>
<p><code>IMAGE_NT_HEADER</code>ç»“æ„ä½“çš„æœ€åä¸€ä¸ªæˆå‘˜ä¸º<code>IAMGE_OPTIONAL_HEADER32</code>ç»“æ„ä½“</p>
<p>è€Œè¿™ä¸ªå€¼ç”¨äºæŒ‡å‡º<code>IMAGE_OPTIONAL_HEADER32</code>ç»“æ„ä½“çš„é•¿åº¦</p>
</li>
<li>
<p>Characteristics</p>
<p>è¯¥å­—æ®µç”¨äºæ ‡è¯†æ–‡ä»¶çš„å±æ€§ï¼Œæ–‡ä»¶æ˜¯å¦å¯è¿è¡Œçš„å½¢æ€ï¼Œæ˜¯å¦ä¸ºDLLç­‰ä¿¡æ¯</p>
<p>ä»¥bitå¼‚æˆ–å½¢å¼ç»„åˆèµ·æ¥</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_RELOCS_STRIPPED</span>           <span class="token expression"><span class="token number">0x0001</span>  </span><span class="token comment">// Relocation info stripped from file.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_EXECUTABLE_IMAGE</span>          <span class="token expression"><span class="token number">0x0002</span>  </span><span class="token comment">// File is executable  (i.e. no unresolved external references).</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_LINE_NUMS_STRIPPED</span>        <span class="token expression"><span class="token number">0x0004</span>  </span><span class="token comment">// Line nunbers stripped from file.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_LOCAL_SYMS_STRIPPED</span>       <span class="token expression"><span class="token number">0x0008</span>  </span><span class="token comment">// Local symbols stripped from file.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_AGGRESIVE_WS_TRIM</span>         <span class="token expression"><span class="token number">0x0010</span>  </span><span class="token comment">// Aggressively trim working set</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_LARGE_ADDRESS_AWARE</span>       <span class="token expression"><span class="token number">0x0020</span>  </span><span class="token comment">// App can handle >2gb addresses</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_BYTES_REVERSED_LO</span>         <span class="token expression"><span class="token number">0x0080</span>  </span><span class="token comment">// Bytes of machine word are reversed.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_32BIT_MACHINE</span>             <span class="token expression"><span class="token number">0x0100</span>  </span><span class="token comment">// 32 bit word machine.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_DEBUG_STRIPPED</span>            <span class="token expression"><span class="token number">0x0200</span>  </span><span class="token comment">// Debugging info stripped from file in .DBG file</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_REMOVABLE_RUN_FROM_SWAP</span>   <span class="token expression"><span class="token number">0x0400</span>  </span><span class="token comment">// If Image is on removable media, copy and run from the swap file.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_NET_RUN_FROM_SWAP</span>         <span class="token expression"><span class="token number">0x0800</span>  </span><span class="token comment">// If Image is on Net, copy and run from the swap file.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_SYSTEM</span>                    <span class="token expression"><span class="token number">0x1000</span>  </span><span class="token comment">// System File.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_DLL</span>                       <span class="token expression"><span class="token number">0x2000</span>  </span><span class="token comment">// File is a DLL.</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_UP_SYSTEM_ONLY</span>            <span class="token expression"><span class="token number">0x4000</span>  </span><span class="token comment">// File should only be run on a UP machine</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_FILE_BYTES_REVERSED_HI</span>         <span class="token expression"><span class="token number">0x8000</span>  </span><span class="token comment">// Bytes of machine word are reversed.</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¦å¤–,PEæ–‡ä»¶å¤´ä¸­çš„Characteristicså¯èƒ½ä¸æ˜¯0002hï¼Œæ¯”å¦‚*.obj</p>
<p>IMAGE_FILE_HEADERçš„TimeDataStampæˆå‘˜ï¼Œä¸å½±å“æ–‡ä»¶è¿è¡Œï¼Œç”¨æ¥è®°å½•ç¼–è¯‘å™¨åˆ›å»ºè¯¥æ–‡ä»¶çš„æ—¶é—´</p>
</li>
</ol>
<h4 id="ntå¤´å¯é€‰å¤´"><a class="markdownIt-Anchor" href="#ntå¤´å¯é€‰å¤´"></a> NTå¤´:å¯é€‰å¤´</h4>
<p><code>IMAGE_OPTIONAL_HEADER32</code>æ˜¯PEå¤´ç»“æ„ä½“ä¸­æœ€å¤§çš„</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_IMAGE_OPTIONAL_HEADER</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//</span>
    <span class="token comment">// Standard fields.</span>
    <span class="token comment">//</span>

    WORD    Magic<span class="token punctuation">;</span>
    BYTE    MajorLinkerVersion<span class="token punctuation">;</span>
    BYTE    MinorLinkerVersion<span class="token punctuation">;</span>
    DWORD   SizeOfCode<span class="token punctuation">;</span>
    DWORD   SizeOfInitializedData<span class="token punctuation">;</span>
    DWORD   SizeOfUninitializedData<span class="token punctuation">;</span>
    DWORD   AddressOfEntryPoint<span class="token punctuation">;</span>
    DWORD   BaseOfCode<span class="token punctuation">;</span>
    DWORD   BaseOfData<span class="token punctuation">;</span>

    <span class="token comment">//</span>
    <span class="token comment">// NT additional fields.</span>
    <span class="token comment">//</span>

    DWORD   ImageBase<span class="token punctuation">;</span>
    DWORD   SectionAlignment<span class="token punctuation">;</span>
    DWORD   FileAlignment<span class="token punctuation">;</span>
    WORD    MajorOperatingSystemVersion<span class="token punctuation">;</span>
    WORD    MinorOperatingSystemVersion<span class="token punctuation">;</span>
    WORD    MajorImageVersion<span class="token punctuation">;</span>
    WORD    MinorImageVersion<span class="token punctuation">;</span>
    WORD    MajorSubsystemVersion<span class="token punctuation">;</span>
    WORD    MinorSubsystemVersion<span class="token punctuation">;</span>
    DWORD   Win32VersionValue<span class="token punctuation">;</span>
    DWORD   SizeOfImage<span class="token punctuation">;</span>
    DWORD   SizeOfHeaders<span class="token punctuation">;</span>
    DWORD   CheckSum<span class="token punctuation">;</span>
    WORD    Subsystem<span class="token punctuation">;</span>
    WORD    DllCharacteristics<span class="token punctuation">;</span>
    DWORD   SizeOfStackReserve<span class="token punctuation">;</span>
    DWORD   SizeOfStackCommit<span class="token punctuation">;</span>
    DWORD   SizeOfHeapReserve<span class="token punctuation">;</span>
    DWORD   SizeOfHeapCommit<span class="token punctuation">;</span>
    DWORD   LoaderFlags<span class="token punctuation">;</span>
    DWORD   NumberOfRvaAndSizes<span class="token punctuation">;</span>
    IMAGE_DATA_DIRECTORY DataDirectory<span class="token punctuation">[</span>IMAGE_NUMBEROF_DIRECTORY_ENTRIES<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> IMAGE_OPTIONAL_HEADER32<span class="token punctuation">,</span> <span class="token operator">*</span>PIMAGE_OPTIONAL_HEADER32<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ–‡ä»¶è¿è¡Œå¿…é¡»åŒ…å«æŒ‡å®šçš„æˆå‘˜</p>
<ol>
<li>
<p>Magic</p>
<p>ä¸º<code>IMAGE_OPTIONAL_HEADER32</code>ç»“æ„ä½“æ—¶ï¼Œ<code>Magic</code>ç ä¸º<code>10B</code>ï¼›</p>
<p>ä¸º<code>IMAGE_OPTIONALHEADER64</code>ç»“æ„ä½“æ—¶ï¼Œ<code>Magic</code>ç ä¸º<code>20B</code></p>
</li>
<li>
<p>AddressOfEntryPoint</p>
<p>æŒæœ‰EPçš„RVAå€¼ï¼ŒæŒ‡å‡ºç¨‹åºæœ€å…ˆæ‰§è¡Œçš„ä»£ç èµ·å§‹åœ°å€</p>
</li>
<li>
<p>ImageBase</p>
<p>è¿›ç¨‹è™šæ‹Ÿå†…å­˜çš„èŒƒå›´æ˜¯0~FFFFFFFF(32ä½)ã€‚PEæ–‡ä»¶è¢«åŠ è½½åˆ°å¦‚æ­¤å¤§çš„å†…å­˜ä¸­æ—¶ï¼Œ<code>ImageBase</code>æŒ‡å‡ºæ–‡ä»¶çš„ä¼˜å…ˆè£…å…¥åœ°å€</p>
<p><code>EXEï¼Œdll</code>ç­‰è£…è½½åˆ°ç”¨æˆ·å†…å­˜çš„<code>0x7FFFFFFF</code></p>
<p><code>SYS</code>æ–‡ä»¶è¢«è½½å…¥åˆ°å†…æ ¸å†…å­˜çš„<code>80000000-FFFFFFFF</code>ä¸­</p>
<p>ä¸€èˆ¬è€Œè¨€<code>EXE</code>çš„IMAGEBASEå€¼ä¸º00400000</p>
<p>DLLçš„IMAGEBASEå€¼ä¸º10000000ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šä¸ºå…¶ä»–å€¼</p>
<p>æ‰§è¡ŒPEæ–‡ä»¶æ—¶ï¼ŒPEè£…è½½å™¨å…ˆåˆ›å»ºè¿›ç¨‹ï¼Œå†å°†æ–‡ä»¶è½½å…¥å†…å­˜ï¼Œç„¶åæŠŠEIPå¯„å­˜å™¨çš„å€¼è®¾ç½®ä¸º<code>IMAGEBASE+OEP</code></p>
</li>
<li>
<p>SectionAliginment,FileAlignment</p>
<p>PEæ–‡ä»¶çš„bodyéƒ¨åˆ†åˆ’åˆ†ä¸ºè‹¥å¹²èŠ‚åŒºï¼Œè¿™äº›èŠ‚å­˜å‚¨ä¸åŒç±»å‹çš„æ•°æ®</p>
<p><code>FileAlignment</code>æŒ‡å®šäº†èŠ‚åŒºç£ç›˜æ–‡ä»¶ä¸­çš„æœ€å°å•ä½</p>
<p><code>SectionAlignment</code>æŒ‡å®šäº†èŠ‚åŒºåœ¨å†…å­˜ä¸­çš„æœ€å°å•ä½</p>
<p>ç£ç›˜æ–‡ä»¶æˆ–å†…å­˜çš„èŠ‚åŒºå¤§å°å¿…å®šä¸º<code>File/SecitonAlignment</code>çš„æ•´æ•°å€</p>
</li>
<li>
<p>SizeOfImage</p>
<p>åŠ è½½PEæ–‡ä»¶åˆ°å†…å­˜æ—¶ï¼ŒSizeOfImageæŒ‡å®šäº†PE Imageåœ¨è™šæ‹Ÿå†…å­˜ä¸­æ‰€å çš„ç©ºé—´å¤§å°ï¼ˆæ–‡ä»¶å¤§å°ä¸åŠ è½½çš„å†…å­˜å¤§å°æ˜¯ä¸ä¸€æ ·çš„ï¼Œä¼šç»è¿‡æ˜ å°„</p>
</li>
<li>
<p>SizeOfHeader</p>
<p>ç”¨æ¥æŒ‡å‡ºæ•´ä¸ªPEå¤´çš„å¤§å°,ä¹Ÿå¿…é¡»æ˜¯	<code>FileAlignment</code>çš„æ•´æ•°å€</p>
</li>
<li>
<p>Subsystem</p>
<p>åŒºåˆ«ç³»ç»Ÿé©±åŠ¨æ–‡ä»¶(<em>/sys)ä¸æ™®é€šçš„å¯æ‰§è¡Œæ–‡ä»¶(</em>.dll,.exe)</p>
<p>å€¼ä¸º1  Driveræ–‡ä»¶   ç³»ç»Ÿé©±åŠ¨(ntfs.sys)</p>
<p>å€¼ä¸º2  GUIæ–‡ä»¶   çª—å£åº”ç”¨ç¨‹åº(notepad.exe)</p>
<p>å€¼ä¸º3 CUIæ–‡ä»¶  æ§åˆ¶å°åº”ç”¨ç¨‹åº(cmd.exe)</p>
</li>
<li>
<p>NumberOfRvaAndSizes</p>
<p>ç”¨æ¥æŒ‡å®š<code>DataDirectory</code>ï¼ˆå³<code>IMAGE_OPTIONAL_HEADER32</code>ç»“æ„ä½“çš„æœ€åä¸€ä¸ªæˆå‘˜ï¼‰æ•°ç»„çš„ä¸ªæ•°ã€‚å®šä¹‰ä¸Šæ˜¯16ï¼Œä¹Ÿå¯èƒ½ä¸æ˜¯16</p>
</li>
<li>
<p>DataDirectory</p>
<p>è¿™äº›æ•°æ®æ®µåŒ…æ‹¬ä½†ä¸é™äºå¯¼å…¥è¡¨ã€å¯¼å‡ºè¡¨ã€èµ„æºã€å¼‚å¸¸å¤„ç†ä¿¡æ¯ã€è°ƒè¯•ä¿¡æ¯ç­‰ã€‚</p>
<p><code>IMAGE_DATA_DIRECTORY</code>ç»“æ„ä½“é€šå¸¸åŒ…å«ä¸¤ä¸ªå­—æ®µï¼š</p>
<ol>
<li><code>VirtualAddress</code>ï¼šè¡¨ç¤ºè¯¥æ•°æ®æ®µåœ¨è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´</li>
<li><code>Size</code>ï¼šè¡¨ç¤ºè¯¥æ•°æ®æ®µçš„å¤§å°ï¼Œä»¥å­—èŠ‚ä¸ºå•ä½ã€‚</li>
</ol>
<img src="/2024/07/09/%E5%88%9D%E8%AF%86WindowsPE/image-20240709224937160.png" class="" alt="image-20240709224937160" loading="lazy">
</li>
</ol>
<h3 id="èŠ‚åŒºå¤´"><a class="markdownIt-Anchor" href="#èŠ‚åŒºå¤´"></a> èŠ‚åŒºå¤´</h3>
<p><code>PE</code>æ–‡ä»¶ä¸­çš„<code>code</code>,<code>data</code>,<code>resource</code>ç­‰æŒ‰ç…§å±æ€§åˆ†ç±»å­˜å‚¨åœ¨ä¸åŒèŠ‚åŒº</p>
<p>æŠŠPEæ–‡ä»¶åˆ›å»ºæˆå¤šä¸ªèŠ‚åŒºçš„ç»“æ„çš„å¥½å¤„æ˜¯ å¯ä»¥ä¿è¯ç¨‹åºçš„å®‰å…¨æ€§</p>
<p>è‹¥æŠŠ<code>code</code>ä¸<code>data</code>æ”¾åœ¨ä¸€ä¸ªèŠ‚åŒºä¸­ç›¸äº’çº ç¼ å¾ˆå®¹æ˜“å¼•å‘å®‰å…¨é—®é¢˜</p>
<p>åŠ å…¥æˆ‘ä»¬å‘dataå†™æ•°æ®ï¼Œç”±äºæŸä¸ªåŸå› å¯¼è‡´æº¢å‡ºï¼Œé‚£ä¹ˆ<code>code</code>å°±ä¼šè¢«è¦†ç›–ï¼Œç¨‹åºå°±å®¹æ˜“å´©æºƒ</p>
<p>å› æ­¤<code>PE</code>æ–‡ä»¶æ ¼å¼çš„è®¾è®¡è€…å†³å®šæŠŠå…·æœ‰ç›¸ä¼¼å±æ€§çš„æ•°æ®ç»Ÿä¸€ä¿å­˜åœ¨ä¸€ä¸ªè¢«ç§°ä¸º<code>èŠ‚åŒº</code>çš„åœ°æ–¹ï¼Œå¹¶ä¸”æŠŠå„èŠ‚åŒºå±æ€§è®°å½•åœ¨èŠ‚åŒºå¤´ä¸­</p>
<table>
<thead>
<tr>
<th>ç±»åˆ«</th>
<th>è®¿é—®æƒé™</th>
</tr>
</thead>
<tbody>
<tr>
<td>code</td>
<td>æ‰§è¡Œï¼Œè¯»å–æƒé™</td>
</tr>
<tr>
<td>data</td>
<td>éæ‰§è¡Œï¼Œè¯»å†™æƒé™</td>
</tr>
<tr>
<td>resource</td>
<td>éæ‰§è¡Œï¼Œè¯»å–æƒé™</td>
</tr>
</tbody>
</table>
<h4 id="image_section_header"><a class="markdownIt-Anchor" href="#image_section_header"></a> IMAGE_SECTION_HEADER</h4>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_SIZEOF_SHORT_NAME</span>              <span class="token expression"><span class="token number">8</span></span></span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_IMAGE_SECTION_HEADER</span> <span class="token punctuation">&#123;</span>
    BYTE    Name<span class="token punctuation">[</span>IMAGE_SIZEOF_SHORT_NAME<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">union</span> <span class="token punctuation">&#123;</span>
            DWORD   PhysicalAddress<span class="token punctuation">;</span>
            DWORD   VirtualSize<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> Misc<span class="token punctuation">;</span>
    DWORD   VirtualAddress<span class="token punctuation">;</span>
    DWORD   SizeOfRawData<span class="token punctuation">;</span>
    DWORD   PointerToRawData<span class="token punctuation">;</span>
    DWORD   PointerToRelocations<span class="token punctuation">;</span>
    DWORD   PointerToLinenumbers<span class="token punctuation">;</span>
    WORD    NumberOfRelocations<span class="token punctuation">;</span>
    WORD    NumberOfLinenumbers<span class="token punctuation">;</span>
    DWORD   Characteristics<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> IMAGE_SECTION_HEADER<span class="token punctuation">,</span> <span class="token operator">*</span>PIMAGE_SECTION_HEADER<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å‡ ä¸ªé‡è¦çš„æˆå‘˜</p>
<ul>
<li>
<p>VirtualSize   å†…å­˜ä¸­èŠ‚åŒºæ‰€å å¤§å°</p>
</li>
<li>
<p>VirtualAddress å†…å­˜ä¸­èŠ‚åŒºèµ·å§‹åœ°å€(RVA)</p>
</li>
<li>
<p>SizeOfRawData  ç£ç›˜æ–‡ä»¶ä¸­èŠ‚åŒºæ‰€å å¤§å°</p>
</li>
<li>
<p>PointerToRawData  ç£ç›˜æ–‡ä»¶ä¸­èŠ‚åŒºèµ·å§‹åœ°å€</p>
</li>
<li>
<p>Charateristics   èŠ‚åŒºå±æ€§(bit OR)</p>
</li>
</ul>
<p><code>VirtualAddress</code>ä¸<code>PointerToRawData</code>ä¸å¸¦æœ‰ä»»ä½•åªã€‚ç”±å®šä¹‰åœ¨<code>IMAGE_OPTIONAL_HEADER32</code>ä¸­çš„<code>SectionAlignment</code>ä¸<code>FileAlignment</code>	ç¡®å®š</p>
<p><code>VirtualSize</code>ä¸<code>SizeOfRawData</code>ä¸€èˆ¬å…·æœ‰ä¸åŒçš„å€¼ï¼Œå› ä¸º</p>
<p>ç£ç›˜ä¸­å’Œå†…å­˜ä¸­çš„èŠ‚åŒºå¤§å°æ˜¯ä¸ä¸€æ ·çš„</p>
<ul>
<li>
<p>å†äº†è§£ä¸€ä¸‹<code>Name</code>å­—æ®µï¼Œnameæˆå‘˜ä¸åƒCè¯­è¨€çš„å­—ç¬¦ä¸²ä¸€æ ·ä»¥NULLç»“æŸï¼Œå¯ä»¥æ”¾å…¥ä»»ä½•å€¼ç”šè‡³å¡«å……NULLå€¼</p>
</li>
<li>
<p>æœ¯è¯­<code>IMAGE</code>å®é™…ä¸ŠæŒ‡çš„çš„å†…å­˜ä¸­çš„PEæ˜ åƒ</p>
</li>
</ul>
<h2 id="rva-to-raw"><a class="markdownIt-Anchor" href="#rva-to-raw"></a> RVA to RAW</h2>
<p>RAWæ˜¯ç£ç›˜ä¸­æ•°æ®å¯¹æ–‡ä»¶çš„åç§»</p>
<p>PEæ–‡ä»¶ä»ç£ç›˜åˆ°å†…å­˜æ˜ å°„çš„å†…å®¹</p>
<pre class="line-numbers language-none"><code class="language-none">èŠ‚ä¸­æ•°æ®çš„RAW-èŠ‚å¤´çš„RAW&#x3D;èŠ‚ä¸­æ•°æ®RVA-èŠ‚å¤´çš„RVA
RAW-PointerToRawData&#x3D;RVA-VirtualAddress
RAW&#x3D;RVA-VirtualAddress+PointerToRawData<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<img src="/2024/07/09/%E5%88%9D%E8%AF%86WindowsPE/image-20240710193542122.png" class="" alt="image-20240710193542122" loading="lazy">
<p>å› æ­¤RAW=(RVA-èŠ‚çš„VirtualAddress)+èŠ‚çš„PonterToRawData</p>
<p>åŒç† RVA=RAW-èŠ‚çš„PonterToRawData+èŠ‚çš„VirtualAddress</p>
<p>å‡ ä¸ªç»ƒä¹ </p>
<p>RVA=5000,File Offset=</p>
<p>RAW=5000(RVA)-1000(VirtualAddress)+400(PointerToRawData)=4400</p>
<p>FileOffset=RAW+ImageBse</p>
<h2 id="iat"><a class="markdownIt-Anchor" href="#iat"></a> IAT</h2>
<p><strong>IAT</strong>(Import Address Table å¯¼å…¥åœ°å€è¡¨)</p>
<p>IATä¿å­˜çš„å†…å®¹ä¸Windowsæ“ä½œç³»ç»Ÿçš„æ ¸å¿ƒè¿›ç¨‹ï¼Œå†…å­˜ï¼ŒDLLç»“æ„ç­‰æœ‰å…³</p>
<h3 id="dll"><a class="markdownIt-Anchor" href="#dll"></a> DLL</h3>
<p>DLL(DynamicLinkedLibrary)</p>
<ul>
<li>ä¸éœ€è¦æŠŠåº“åŒ…å«åˆ°ç¨‹åºï¼Œå•ç‹¬ç»„æˆDLLæ–‡ä»¶ï¼Œéœ€è¦æ—¶è°ƒç”¨å³å¯</li>
<li>å†…å­˜æ˜ å°„æŠ€æœ¯ä½¿åŠ è½½åçš„DLLä»£ç èµ„æºåœ¨å¤šä¸ªè¿›ç¨‹ä¸­å®ç°å…±äº«</li>
<li>æ›´æ–°åº“æ—¶åªè¦æ›¿æ¢ç›¸å…³DLLæ–‡ä»¶ï¼Œæ“ä½œç®€å•</li>
</ul>
<p><strong>åŠ è½½DLLçš„æ–¹å¼å®é™…æœ‰ä¸¤ç§</strong></p>
<ul>
<li>
<p>æ˜¾å¼é“¾æ¥(Explicit Linking)</p>
<p>ç¨‹åºä½¿ç”¨DLLæ—¶åŠ è½½ï¼Œä½¿ç”¨å®Œæ¯•åé‡Šæ”¾å†…å­˜</p>
</li>
<li>
<p>éšå¼é“¾æ¥(Implicit Linking)</p>
<p>ç¨‹åºå¼€å§‹æ—¶å°±åŠ è½½DLLï¼Œç¨‹åºç»ˆæ­¢æ—¶å†é‡Šæ”¾å ç”¨çš„å†…å­˜</p>
</li>
</ul>
<p>ä¾‹å¦‚è°ƒç”¨<code>CreateFileW</code>å‡½æ•°çš„ä»£ç ï¼ˆä½äºkernel32.dll)</p>
<p>è°ƒç”¨CreateFileW()å¹¶éç›´æ¥è°ƒç”¨ï¼Œè€Œæ˜¯é€šè¿‡è·å–01001104åœ°å€çš„å€¼æ¥å®ç°</p>
<p>è¿™ä¸ªåœ°å€æ˜¯*.exeä¸­textèŠ‚åŒºçš„å†…å­˜åŒºåŸŸï¼Œè¿™ä¸ªåŒºåŸŸçš„å€¼ä¸º7C8107F0æ˜¯åŠ è½½åˆ°<code>*.exe</code>è¿›ç¨‹å†…å­˜ä¸­çš„<code>CreateFileW()</code>å‡½æ•°(ä½äºkernel32.dll)ä¸­çš„åœ°å€</p>
<hr />
<p>ä¸ºä»€ä¹ˆè¦è¿™æ ·æ“ä½œï¼Œå› ä¸ºå®é™…æ“ä½œä¸­æ— æ³•ä¿è¯<code>DLL</code>ä¸€å®šä¼šè¢«åŠ è½½åˆ°PEå¤´å†…æŒ‡å®šçš„<code>ImageBase</code>å¤„ã€‚ä½†æ˜¯<code>EXE</code>æ–‡ä»¶å´èƒ½å‡†ç¡®åŠ è½½åˆ°è‡ªèº«çš„<code>ImageBase</code></p>
<h3 id="image_import_descriptor"><a class="markdownIt-Anchor" href="#image_import_descriptor"></a> IMAGE_IMPORT_DESCRIPTOR</h3>
<p>è¿™ä¸ªç»“æ„ä½“ä¸­è®°å½•ç€<code>PE</code>æ–‡ä»¶è¦å¯¼å…¥é‚£äº›åº“æ–‡ä»¶</p>
<p>æ‰§è¡Œä¸€ä¸ªæ™®é€šç¨‹åºå¾€å¾€éœ€è¦å¯¼å…¥å¤šä¸ªåº“ï¼Œå¯¼å…¥å¤šå°‘åº“å°±å­˜åœ¨å¤šå°‘ä¸ª<code>IMAGE_IMPOET_DESCRIPTOR</code>ç»“æ„ä½“</p>
<blockquote>
<p>Import:å¯¼å…¥ å‘åº“æä¾›æœåŠ¡(å‡½æ•°)</p>
<p>Export:å¯¼å‡º  ä»åº“å‘å…¶ä»–PEæ–‡ä»¶æä¾›æœåŠ¡ï¼ˆå‡½æ•°)</p>
</blockquote>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_IMAGE_IMPORT_DESCRIPTOR</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">union</span> <span class="token punctuation">&#123;</span>
        DWORD   Characteristics<span class="token punctuation">;</span>            <span class="token comment">// 0 for terminating null import descriptor</span>
        DWORD   OriginalFirstThunk<span class="token punctuation">;</span>         <span class="token comment">// RVA to original unbound IAT (PIMAGE_THUNK_DATA)</span>
    <span class="token punctuation">&#125;</span> DUMMYUNIONNAME<span class="token punctuation">;</span>
    DWORD   TimeDateStamp<span class="token punctuation">;</span>                  <span class="token comment">// 0 if not bound,</span>
                                            <span class="token comment">// -1 if bound, and real date\time stamp</span>
                                            <span class="token comment">//     in IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT (new BIND)</span>
                                            <span class="token comment">// O.W. date/time stamp of DLL bound to (Old BIND)</span>

    DWORD   ForwarderChain<span class="token punctuation">;</span>                 <span class="token comment">// -1 if no forwarders</span>
    DWORD   Name<span class="token punctuation">;</span>
    DWORD   FirstThunk<span class="token punctuation">;</span>                     <span class="token comment">// RVA to IAT (if bound this IAT has actual addresses)</span>
<span class="token punctuation">&#125;</span> IMAGE_IMPORT_DESCRIPTOR<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>OriginalFirstThunk  INT(import name table)çš„åœ°å€(RVA)</li>
<li>Name      åº“åç§°å­—ç¬¦ä¸²çš„åœ°å€(RVA)</li>
<li>FirstThunk  IATçš„åœ°å€(RVA)</li>
</ul>
<blockquote>
<p>PEå¤´ä¸­æåˆ°çš„<code>Table</code>å³æŒ‡æ•°ç»„</p>
<p>INTä¸IATæ˜¯é•¿æ•´å‹æ•°ç»„ï¼Œä»¥NULLç»“æŸ</p>
<p>INTä¸­å„å…ƒç´ çš„å€¼ä¸º<code>IMAGE_IMPORT_BY_NAME</code>ç»“æ„ä½“æŒ‡é’ˆ(æœ‰æ—¶IATä¹Ÿæ‹¥æœ‰ç›¸åŒçš„å€¼)</p>
<p>INTä¸IATçš„å¤§å°ç›¸åŒ</p>
</blockquote>
<p>INTä¸IATæŒ‡å‘çš„åœ°å€å¯èƒ½ä¸åŒ(ä¼šæœ‰å¾ˆå¤šå˜å½¢çš„PEæ–‡ä»¶)</p>
<p><mark>PEè£…è½½å™¨æŠŠå¯¼å…¥å‡½æ•°è¾“å…¥è‡³IATçš„é¡ºåº</mark></p>
<ol>
<li>
<p>è¯»å–IID(image_import_descriptor)çš„Nameæˆå‘˜ï¼Œè·å–åº“åç§°å­—ç¬¦ä¸²(â€œkernel32.dllâ€)</p>
</li>
<li>
<p>è£…è½½ç›¸åº”åº“</p>
<p>-&gt;LoadLibrary(â€œkernel32.dllâ€)</p>
</li>
<li>
<p>è¯»å–IIDçš„OriginalFirstThunkæˆå‘˜ï¼Œè·å–INTåœ°å€</p>
</li>
<li>
<p>é€ä¸€è¯»å–INTä¸­æ•°ç»„çš„å€¼ï¼Œè·å–ç›¸åº”IMAGE_IMPORT_BY_NAMEåœ°å€(RVA)</p>
</li>
<li>
<p>ä½¿ç”¨IMAGE_IMPORT_BY_NAMEçš„Hintæˆ–Nameé¡¹ï¼Œè·å–ç›¸åº”å‡½æ•°çš„èµ·å§‹åœ°å€</p>
<p>-&gt;GetProcAddress(â€œGetCurrentThreadldâ€)</p>
</li>
<li>
<p>è¯»å–IIDçš„FirstThunk(IAT)æˆå‘˜ï¼Œè·å¾—IATåœ°å€</p>
</li>
<li>
<p>å°†ä¸Šé¢è·å¾—çš„å‡½æ•°åœ°å€å¡«å…¥ç›¸åº”çš„IATæ•°ç»„å€¼</p>
</li>
<li>
<p>é‡å¤ä»¥ä¸Šæ­¥éª¤4-7 ç›´åˆ°INTç»“æŸ(é‡åˆ°NULL)</p>
</li>
</ol>
<hr />
<p>å¯»æ‰¾<code>IMAGE_IMPORT_DESCRIPTOR</code></p>
<p>è¿™ä¸ªä¸œè¥¿ä¸åœ¨PEå¤´ï¼Œè€Œåœ¨PEä½“ï¼Œä½†æ˜¯æŸ¥æ‰¾å…¶ä½ç½®çš„ä¿¡æ¯åœ¨PEå¤´ä¸­ï¼Œ<code>IMAGE_ORPTIONAL_HEADER32_DATADIRECTORY[1].VirtualAddress</code>çš„å€¼å³æ˜¯<code>IMAGE_IMPORT_DESCRIPTOR</code>ç»“æ„ä½“æ•°ç»„çš„èµ·å§‹åœ°å€(RVA)</p>
<p>ç„¶åä½¿ç”¨<code>RVA TO RAW</code>çš„è½¬æ¢å…¬å¼,è®¡ç®—æ–‡ä»¶åç§»æ‰¾åˆ°åœ°å€</p>
<h2 id="eat"><a class="markdownIt-Anchor" href="#eat"></a> EAT</h2>
<p>åœ¨Windowsä¸­ï¼Œåº“æ˜¯ä¸ºäº†æ–¹ä¾¿å…¶ä»–ç¨‹åºè°ƒç”¨è€Œé›†ä¸­åŒ…å«ç›¸å…³å‡½æ•°çš„æ–‡ä»¶(DLL/SYS)</p>
<p>win32apiæ˜¯æœ€å…·ä»£è¡¨æ€§çš„åº“ï¼Œå…¶ä¸­kernel32.dllè¢«ç§°ä¸ºæœ€æ ¸å¿ƒçš„åº“æ–‡ä»¶</p>
<p><mark>EATæ˜¯ä¸€ç§æ ¸å¿ƒæœºåˆ¶ï¼Œå®ƒä½¿ä¸åŒçš„åº”ç”¨ç¨‹åºå¯ä»¥è°ƒç”¨åº“æ–‡ä»¶ä¸­æä¾›çš„å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯åªæœ‰é€šè¿‡EATæ‰èƒ½å‡†ç¡®æ±‚å¾—ä»ç›¸åº”åº“ä¸­å¯¼å‡ºå‡½æ•°çš„èµ·å§‹åœ°å€</mark></p>
<p>ä¸å‰æ–‡è®²è§£çš„IATç›¸å¯¹ï¼ŒPEæ–‡ä»¶å†…çš„ç‰¹å®šç»“æ„ä½“(IMAGE_EXPORT_DIRECTORY)ä¿å­˜ç€å¯¼å‡ºä¿¡æ¯ï¼Œä¸”PEæ–‡ä»¶ä¸­ä»…æœ‰ä¸€ä¸ªç”¨æ¥è¯´æ˜åº“EATçš„<code>IMAGE_EXPORT_DIRECTORY</code>ç»“æ„ä½“</p>
<blockquote>
<p>IATçš„IMAGE_IMPORT_DESCRIPTORç»“æ„ä½“ä»¥æ•°ç»„å½¢å¼å­˜åœ¨ï¼Œä¸”æ‹¥æœ‰å¤šä¸ªæˆå‘˜ã€‚è¿™æ ·æ˜¯å› ä¸ºPEæ–‡ä»¶å¯ä»¥åŒæ—¶å¯¼å…¥å¤šä¸ªåº“</p>
</blockquote>
<p><code>IMAGE_EXPORT_DIRECTORY</code>ç»“æ„ä½“çš„RVAå°±æ˜¯<code>IMAGE_OPTIONAL_HEADER32.DataDirectory[0].VirtualAddress</code></p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_IMAGE_EXPORT_DIRECTORY</span> <span class="token punctuation">&#123;</span>
    DWORD   Characteristics<span class="token punctuation">;</span>
    DWORD   TimeDateStamp<span class="token punctuation">;</span>
    WORD    MajorVersion<span class="token punctuation">;</span>
    WORD    MinorVersion<span class="token punctuation">;</span>
    DWORD   Name<span class="token punctuation">;</span>
    DWORD   Base<span class="token punctuation">;</span>
    DWORD   NumberOfFunctions<span class="token punctuation">;</span>
    DWORD   NumberOfNames<span class="token punctuation">;</span>
    DWORD   AddressOfFunctions<span class="token punctuation">;</span>     <span class="token comment">// RVA from base of image</span>
    DWORD   AddressOfNames<span class="token punctuation">;</span>         <span class="token comment">// RVA from base of image</span>
    DWORD   AddressOfNameOrdinals<span class="token punctuation">;</span>  <span class="token comment">// RVA from base of image</span>
<span class="token punctuation">&#125;</span> IMAGE_EXPORT_DIRECTORY<span class="token punctuation">,</span> <span class="token operator">*</span>PIMAGE_EXPORT_DIRECTORY<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>
<p>NumberOfFunctions  å®é™…Exportå‡½æ•°çš„ä¸ªæ•°</p>
</li>
<li>
<p>NumberOfNames  Exportå‡½æ•°ä¸­å…·åçš„å‡½æ•°ä¸ªæ•°</p>
</li>
<li>
<p>AddressOfFunctions   Exportå‡½æ•°åœ°å€æ•°ç»„(æ•°ç»„å…ƒç´ ä¸ªæ•°=NumberOfFunctions)</p>
</li>
<li>
<p>AddressOfNames å‡½æ•°åç§°åœ°å€æ•°ç»„(æ•°ç»„å…ƒç´ ä¸ªæ•°=NumberOfNames)</p>
</li>
<li>
<p>AddressOfNameOridinals  Ordinalåœ°å€æ•°ç»„(æ•°ç»„å…ƒç´ ä¸ªæ•°=NumberOfNames)</p>
</li>
</ul>
<img src="/2024/07/09/%E5%88%9D%E8%AF%86WindowsPE/image-20240710224952220.png" class="" alt="image-20240710224952220" loading="lazy">
<hr />
<p>ä»åº“ä¸­è·å¾—å‡½æ•°åœ°å€çš„APIä¸º<code>GetProcAddress()</code>å‡½æ•°</p>
<p>è¯¥APIå¼•ç”¨EATæ¥è·å–æŒ‡å®šAPIçš„åœ°å€</p>
<p><code>GetProcAddress</code>åŸç†</p>
<ol>
<li>åˆ©ç”¨AddressOfNamesæˆå‘˜è½¬åˆ°å‡½æ•°åç§°æ•°ç»„</li>
<li>æ¯”è¾ƒå­—ç¬¦ä¸²æŸ¥æ‰¾æŒ‡å®šçš„å‡½æ•°åç§°</li>
<li>åˆ©ç”¨<code>AddressOfNameOridinals</code>æˆå‘˜,è½¬åˆ°<code>orinal</code>æ•°ç»„</li>
<li>åœ¨<code>ordinal</code>æ•°ç»„ä¸­é€šè¿‡<code>name_index</code>æŸ¥æ‰¾ç›¸åº”çš„<code>ordinal</code>å€¼</li>
<li>åˆ©ç”¨<code>AddressOfFunctions</code>æˆå‘˜è½¬åˆ°EAT</li>
<li>åœ¨EATå°†åˆšåˆšæ±‚å¾—çš„<code>oridinal</code>å½“åšæ•°ç»„ç´¢å¼•ï¼Œè·å¾—æŒ‡å®šå‡½æ•°çš„èµ·å§‹åœ°å€</li>
</ol>
<p><code>kernel32.dll</code>ä¸­æ‰€æœ‰å¯¼å‡ºå‡½æ•°å‡æœ‰ç›¸åº”åç§°</p>
<p>å¯¼å‡ºå‡½æ•°ä¹Ÿæœ‰ä¸€äº›å‡½æ•°æ²¡æœ‰åç§°(ä»…é€šè¿‡ordinalå¯¼å‡º)</p>
<blockquote>
<p>æŠŠOrdinalå½“åšå¯¼å‡ºå‡½æ•°çš„å›ºæœ‰ç¼–å·å°±è¡Œäº†ï¼Œå› ä¸ºæœ‰æ—¶å€™æŸäº›å‡½æ•°å¯¹å¤–ä¸ä¼šå…¬å¸ƒå‡½æ•°åï¼Œä»…ä»…å…¬å¼€å‡½æ•°çš„å›ºæœ‰ç¼–å·</p>
</blockquote>
</div></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2024/07/09/%E5%88%9D%E8%AF%86Windows%E5%86%85%E6%A0%B8/" rel="prev" title="åˆè¯†Windowså†…æ ¸"><span class="icon iconify" data-icon="ri:arrow-left-s-line"></span><span class="post-nav-text">åˆè¯†Windowså†…æ ¸</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2024/07/08/XXElab%E9%80%9A%E5%85%B3%E8%AE%B0%E5%BD%95/" rel="next" title="XXElabé€šå…³è®°å½•"><span class="post-nav-text">XXElabé€šå…³è®°å½•</span><span class="icon iconify" data-icon="ri:arrow-right-s-line"></span></a></div></div></div><div class="hty-card" id="comment"><div class="comment-tooltip text-center"><span>æ‚¨éœ€è¦ç§‘å­¦ä¸Šç½‘ï¼Œæ‰å¯ä½¿ç”¨è¯„è®ºåŒºåŠŸèƒ½ã€‚</span><br></div><div id="waline"></div><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@waline/client@v2/dist/waline.css"><script>window.CONFIG.waline.config.path = "/2024/07/09/%E5%88%9D%E8%AF%86WindowsPE/"</script><div class="js-Pjax"><script src="/js/comments/waline.js" type="module" defer></script></div></div></main><footer class="sidebar-translate" id="footer"><div class="beian"><a rel="noopener" href="https://beian.miit.gov.cn/" target="_blank"></a></div><div class="copyright"><span>&copy; 2023 â€“ 2024 </span><span class="with-love" id="animate"><span class="icon iconify" data-icon="ri:cloud-line"></span></span><span class="author"> Npc</span></div><div class="footer-custom-text">=w=</div></footer></div><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><span class="icon iconify" data-icon="ri:arrow-up-s-line"></span><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="Search"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:search-line"></span></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script src="https://fastly.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js"></script><script src="/js/search/local-search.js" defer type="module"></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><span class="icon iconify" data-icon="ri:close-line"></span></span></div><div class="search-input-container"><input class="search-input" id="local-search-input" type="text" placeholder="Searching..." value=""></div><div class="search-result-container"></div></div><script src="https://fastly.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js"></script><script>const images = [...document.querySelectorAll('.markdown-body img')]
mediumZoom(images)</script><style>.medium-zoom-image {
  z-index: 99;
}</style></body></html>