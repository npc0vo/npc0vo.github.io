<!DOCTYPE html><html lang="[&quot;en&quot;,&quot;zh-CN&quot;,&quot;default&quot;]"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="Npc"><meta name="copyright" content="Npc"><meta name="generator" content="Hexo 7.1.1"><meta name="theme" content="hexo-theme-yun"><title>初识SEH | Npc | Blog</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/star-markdown-css@0.4.1/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/my_blog_prism@1.0.5/prism.css"><script src="https://cdn.jsdelivr.net/npm/my_blog_prism@1.0.5/prism.js"></script><script src="https://fastly.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".markdown-body img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link rel="icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="preconnect" href="https://fastly.jsdelivr.net/npm/" crossorigin><script id="yun-config">
    window.Yun = {}
    window.CONFIG = {"hostname":"npc0vo.github.io","root":"/","title":"Npc小站","version":"1.10.11","mode":"light","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}.","hits":"${hits} results found","hits_time":"${hits} results found in ${time} ms"},"anonymous_image":"https://cdn.yunyoujun.cn/img/avatar/none.jpg","say":{"api":"https://el-bot-api.vercel.app/api/words/young"},"local_search":{"path":"/search.xml"},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"fireworks":{"colors":null},"waline":{"config":{"enable":true,"serverURL":"https://waline-onelastchicks-projects.vercel.app/","comment":false,"el":"#waline","lang":["en","zh-CN","default"]},"cdn":"https://fastly.jsdelivr.net/npm/@waline/client@v2/dist/waline.js","dark":"html.dark"},"vendors":{"host":"https://fastly.jsdelivr.net/npm/","darken":"https://fastly.jsdelivr.net/npm/darken@1.5.0"}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/hexo-theme-yun.js" type="module"></script><script src="//at.alicdn.com/t/font_1140697_dxory92pb0h.js" async></script><link rel="preconnect" href="https://www.google-analytics.com" crossorigin><script async src="https://www.googletagmanager.com/gtag/js?id=G-1LL0D86CY9"></script><script>if (CONFIG.hostname === location.hostname) {
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-1LL0D86CY9');
}</script><script data-ad-client="ca-pub-2245427233262012" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(function(){
  var bp = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https') {
    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else {
    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})();</script><!-- Google Tag Manager --><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-M9KWR9L');</script><!-- End Google Tag Manager --><meta name="description" content="Windows下的异常处理  基础 开发人员主要使用两种异常处理技术，一种是 SEH （结构化异常处理），另一种是 VEH （向量化异常处理，XP 以上） Intel公司在从386开始的IA-32家族处理器中引人了**中断(Interrupt)和异常(Exception)**的概念。 中断是由外部硬件设备或异步事件产生的，而异常是由内部事件产生的，又可分为故障、陷阱和终止3类。故障和陷阱，正如其">
<meta property="og:type" content="article">
<meta property="og:title" content="初识SEH">
<meta property="og:url" content="http://npc0vo.github.io/2024/07/17/%E5%88%9D%E8%AF%86SEH/index.html">
<meta property="og:site_name" content="Npc | Blog">
<meta property="og:description" content="Windows下的异常处理  基础 开发人员主要使用两种异常处理技术，一种是 SEH （结构化异常处理），另一种是 VEH （向量化异常处理，XP 以上） Intel公司在从386开始的IA-32家族处理器中引人了**中断(Interrupt)和异常(Exception)**的概念。 中断是由外部硬件设备或异步事件产生的，而异常是由内部事件产生的，又可分为故障、陷阱和终止3类。故障和陷阱，正如其">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://npc0vo.github.io/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201028211144501-231721940.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201113165754480-2139854787.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201113165712305-1289399362.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/07/17/%E5%88%9D%E8%AF%86SEH/image-20240721214916816.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201029205350300-1326375967.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201029205536545-1869624930.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201030101610385-1590170892.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201030102136333-1354367145.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201030175658771-1414756359.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/07/17/%E5%88%9D%E8%AF%86SEH/image-20240722104414440.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201030192439381-1236684328.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/07/17/%E5%88%9D%E8%AF%86SEH/image-20240722105849770.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/07/17/%E5%88%9D%E8%AF%86SEH/image-20240722110928854.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201101211034456-891047377.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201103120306392-55524503.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201103132200583-687171570.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201103132334849-571852046.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201103133459031-730947958.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201103133001234-867631965.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201103144843386-1287950374.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201103144916327-706602587.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201103192755633-206883248.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201103193234467-1705026147.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201106184837825-922006010.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201108142253285-970722145.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201108200945501-250148316.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201108201314930-684464001.png">
<meta property="og:image" content="http://npc0vo.github.io/2024/07/17/%E5%88%9D%E8%AF%86SEH/image-20240722140843472.png">
<meta property="article:published_time" content="2024-07-17T04:09:41.000Z">
<meta property="article:modified_time" content="2024-07-22T12:53:56.463Z">
<meta property="article:author" content="Npc">
<meta property="article:tag" content="Reverse">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://npc0vo.github.io/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201028211144501-231721940.png"><script>(function() {
  if (CONFIG.mode !== 'auto') return
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script></head><body><script src="https://code.iconify.design/2/2.1.1/iconify.min.js"></script><script>// Define global variable
IconifyProviders = {
  // Empty prefix: overwrite default API provider configuration
  '': {
    // Use custom API first, use Iconify public API as backup
    resources: [
        'https://api.iconify.design',
    ],
    // Wait for 1 second before switching API hosts
    rotate: 1000,
  },
};</script><script defer src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js" type="module"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="Table of Contents"><span class="icon iconify" data-icon="ri:list-ordered"></span></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="Overview"><span class="icon iconify" data-icon="ri:passport-line"></span></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="Npc"><img width="96" loading="lazy" src="/images/avatar.jpg" alt="Npc"><span class="site-author-status">😭</span></a><div class="site-author-name"><a href="/about/">Npc</a></div><span class="site-name">Npc | Blog</span><sub class="site-subtitle">又活了一天</sub><div class="site-description"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="Home"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:home-4-line"></span></span></a><div class="site-state-item"><a href="/archives/" title="Archives"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:archive-line"></span></span><span class="site-state-item-count">80</span></a></div><div class="site-state-item"><a href="/categories/" title="Categories"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:folder-2-line"></span></span><span class="site-state-item-count">13</span></a></div><div class="site-state-item"><a href="/tags/" title="Tags"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="site-state-item-count">17</span></a></div><a class="site-state-item hty-icon-button" href="/about/#comment" title="留言板"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:clipboard-line"></span></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/npc0vo" title="GitHub" target="_blank" style="color:#6e5494"><span class="icon iconify" data-icon="ri:github-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:me@1930278836@qq.com" title="E-Mail" target="_blank" style="color:#8E71C1"><span class="icon iconify" data-icon="ri:mail-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.yuque.com/npc0vo" title="Yuque" target="_blank" style="color:#a0c69d"><span class="icon iconify" data-icon="ri:yuque-line"></span></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="我的小伙伴们" style="color:dodgerblue"><span class="icon iconify" data-icon="ri:genderless-line"></span></a></div></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#windows%E4%B8%8B%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">1.</span> <span class="toc-text"> Windows下的异常处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80"><span class="toc-number">1.1.</span> <span class="toc-text"> 基础</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E7%9A%84%E5%9F%BA%E6%9C%AC%E8%BF%87%E7%A8%8B"><span class="toc-number">1.2.</span> <span class="toc-text"> 异常处理的基本过程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#idt"><span class="toc-number">1.2.1.</span> <span class="toc-text"> IDT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E7%9A%84%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">1.2.2.</span> <span class="toc-text"> 异常处理的准备工作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E6%A0%B8%E6%80%81%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E8%BF%87%E7%A8%8B"><span class="toc-number">1.2.3.</span> <span class="toc-text"> 内核态的异常处理过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E6%80%81%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E8%BF%87%E7%A8%8B"><span class="toc-number">1.2.4.</span> <span class="toc-text"> 用户态的异常处理过程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#seh"><span class="toc-number">2.</span> <span class="toc-text"> SEH</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#tib"><span class="toc-number">2.1.</span> <span class="toc-text"> TIB</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_exception_registration_record%E7%BB%93%E6%9E%84"><span class="toc-number">2.2.</span> <span class="toc-text"> _EXCEPTION_REGISTRATION_RECORD结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exception_record%E7%BB%93%E6%9E%84%E5%92%8Ccontext%E7%BB%93%E6%9E%84"><span class="toc-number">2.3.</span> <span class="toc-text"> EXCEPTION_RECORD结构和CONTEXT结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#__exception_pointers-%E7%BB%93%E6%9E%84"><span class="toc-number">2.4.</span> <span class="toc-text"> __EXCEPTION_POINTERS 结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#seh%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%AE%89%E8%A3%85%E5%92%8C%E5%8D%B8%E8%BD%BD"><span class="toc-number">2.5.</span> <span class="toc-text"> SEH处理程序的安装和卸载</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#seh%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8F%E5%8E%9F%E7%90%86%E4%BB%A5%E5%8F%8A%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.</span> <span class="toc-text"> SEH异常处理程序原理以及设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E5%88%86%E5%8F%91%E7%9A%84%E8%AF%A6%E7%BB%86%E8%BF%87%E7%A8%8B"><span class="toc-number">3.1.</span> <span class="toc-text"> 异常分发的详细过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">3.2.</span> <span class="toc-text"> 线程异常处理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E7%9A%84%E5%B7%A5%E4%BD%9C%E7%BB%86%E8%8A%82"><span class="toc-number">3.2.1.</span> <span class="toc-text"> 线程异常处理的工作细节</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0%E7%9A%84%E6%A0%88%E5%B1%95%E5%BC%80rtlunwind"><span class="toc-number">3.3.</span> <span class="toc-text"> 异常处理函数的栈展开(RtlUnwind)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%A0%88%E5%B1%95%E5%BC%80"><span class="toc-number">3.3.1.</span> <span class="toc-text"> 什么是栈展开</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E8%BF%9B%E8%A1%8C%E6%A0%88%E5%B1%95%E5%BC%80"><span class="toc-number">3.3.2.</span> <span class="toc-text"> 为什么要进行栈展开</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E6%A0%88%E5%B1%95%E5%BC%80"><span class="toc-number">3.3.3.</span> <span class="toc-text"> 如何进行栈展开</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#msc%E7%BC%96%E8%AF%91%E5%99%A8%E5%AF%B9%E7%BA%BF%E7%A8%8B%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E7%9A%84%E5%A2%9E%E5%BC%BA"><span class="toc-number">3.4.</span> <span class="toc-text"> MSC编译器对线程异常处理的增强</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%99%A8%E7%9A%84seh%E5%A2%9E%E5%BC%BA%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.5.</span> <span class="toc-text"> 编译器的SEH增强设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%99%A8%E7%9A%84%E5%AE%9E%E9%99%85%E5%B7%A5%E4%BD%9C"><span class="toc-number">3.6.</span> <span class="toc-text"> 编译器的实际工作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#__except_handler3-%E5%87%BD%E6%95%B0%E6%B5%81%E7%A8%8B%E8%A7%A3%E6%9E%90"><span class="toc-number">3.7.</span> <span class="toc-text"> __except_handler3 函数流程解析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B6%E5%B1%82%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">3.8.</span> <span class="toc-text"> 顶层异常处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B6%E5%B1%82%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E7%9A%84%E5%85%B8%E5%9E%8B%E5%BA%94%E7%94%A8%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.9.</span> <span class="toc-text"> 顶层异常处理的典型应用模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%AE%89%E5%85%A8%E6%80%A7"><span class="toc-number">3.10.</span> <span class="toc-text"> 异常处理程序的安全性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#safeseh%E6%9C%BA%E5%88%B6"><span class="toc-number">3.10.1.</span> <span class="toc-text"> SafeSEH机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sehop%E6%9C%BA%E5%88%B6"><span class="toc-number">3.10.2.</span> <span class="toc-text"> SEHOP机制</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9D%E8%AF%86sehop"><span class="toc-number">3.10.2.1.</span> <span class="toc-text"> 初识SEHOP</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sehop%E4%B8%8E%E9%A1%B6%E5%B1%82%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">3.10.3.</span> <span class="toc-text"> SEHOP与顶层异常处理</span></a></li></ol></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#0078E7;"><link itemprop="mainEntityOfPage" href="http://npc0vo.github.io/2024/07/17/%E5%88%9D%E8%AF%86SEH/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="Npc"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="Npc | Blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">初识SEH</h1><div class="post-meta"><div class="post-time" style="display:block"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-line"></span></span> <time title="Created: 2024-07-17 12:09:41" itemprop="dateCreated datePublished" datetime="2024-07-17T12:09:41+08:00">2024-07-17</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-2-line"></span></span> <time title="Modified: 2024-07-22 20:53:56" itemprop="dateModified" datetime="2024-07-22T20:53:56+08:00">2024-07-22</time></div><span class="post-count"><span class="post-symbolcount"><span class="post-meta-item-icon" title="Word count in article"><span class="icon iconify" data-icon="ri:file-word-line"></span></span> <span title="Word count in article">12.6k</span><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="Reading time"><span class="icon iconify" data-icon="ri:timer-line"></span></span> <span title="Reading time">48m</span></span></span><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><span class="icon iconify" data-icon="ri:folder-line"></span></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/Reverse/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">Reverse</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/Reverse/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="tag-name">Reverse</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><h2 id="windows下的异常处理"><a class="markdownIt-Anchor" href="#windows下的异常处理"></a> Windows下的异常处理</h2>
<h3 id="基础"><a class="markdownIt-Anchor" href="#基础"></a> 基础</h3>
<p>开发人员主要使用两种异常处理技术，一种是 <strong>SEH （结构化异常处理）</strong>，另一种是 <strong>VEH （向量化异常处理，XP 以上）</strong></p>
<p>Intel公司在从386开始的IA-32家族处理器中引人了**中断(Interrupt)<strong>和</strong>异常(Exception)**的概念。</p>
<p>中断是由外部硬件设备或异步事件产生的，而异常是由内部事件产生的，又可分为故障、陷阱和终止3类。故障和陷阱，正如其名称所示的，是可恢复的;终止类异常是不可恢复的，如果发生了这种异常，系统必须重启。</p>
<p>CPU 访问无效内存，是<strong>硬件异常</strong>；操作系统或软件引发的异常，是<strong>软件</strong></p>
<p>常见异常</p>
<img src="/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201028211144501-231721940.png" class="" alt="img" loading="lazy">
<p>同时代码可以通过函数 RaiseException ，主动引发一个异常</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">VOID RaiseException<span class="token punctuation">&#123;</span>
    DWORD dwExceptionCode<span class="token punctuation">,</span><span class="token comment">//标识所引发异常的代码</span>
    DWORD dwExceptionFlags<span class="token punctuation">,</span><span class="token comment">//异常是否继续执行的标识</span>
    DWORD nNumberOfArguments<span class="token punctuation">,</span><span class="token comment">//附加信息</span>
    CONST DWORD <span class="token operator">*</span>lpArguments<span class="token comment">//附加信息</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="异常处理的基本过程"><a class="markdownIt-Anchor" href="#异常处理的基本过程"></a> 异常处理的基本过程</h3>
<p>Windows 正常启动后，会运行在保护模式下，当有中断或异常发生时，CPU 会通过**中断描述符（Interrupt Descriptor Table）**来寻找处理函数。</p>
<p><mark>因此,IDT表是CPU与操作系统交接终端和异常的关口</mark></p>
<h4 id="idt"><a class="markdownIt-Anchor" href="#idt"></a> IDT</h4>
<p>IDT 是一张位于物理内存中的线性表,共有 <strong>256 项</strong>。在 32 位模式下每个 IDT 项的长度是 **8 字节，**在 64 位模式下则为 <strong>16</strong> 字节。</p>
<p>操作<strong>系统</strong>在<strong>启动</strong>阶段会<strong>初始化</strong>这个表，系统中的<strong>每个 CPU</strong> 都有一份 <strong>IDT 的拷贝</strong>。IDT 的位置和长度是由 CPU 的 <strong>IDTR</strong> 寄存器描述的。IDTR 寄存器共有 <strong>48</strong> 位，其中高 32 位是表的<strong>基址</strong>，低 <strong>16</strong> 位是表的<strong>长度</strong>。尽管可以使用 <strong>SIDT</strong> 和 <strong>LIDT</strong> <strong>指令</strong>来读写该寄存器，但 <strong>LIDT</strong> 是特权指令，只能在 <strong>Ring 0</strong> 特权级下运行。</p>
<p><strong>SIDT</strong> 指令的功能 （仅对当前的 CPU）: 将中断描述符表寄存器IDTR－－64位宽，16～47Bit 存有中断描述符表 IDT 基地址的内容存入指定地址单元。获得 IDT 的基地址后，可以修改 IDT，增加一个中断门安置自己的中断服务。</p>
<p><strong>IDT</strong> 的每一项都是一个<strong>门结构</strong>，它是发生中断或异常时 CPU 转移控制权的必经之路，包括如下</p>
<p><strong>•</strong> <strong>任务门(Task-gate)</strong> 描述符，主要用于 CPU 的<strong>任务切换</strong>(TSS功能)。（微软没有采用该方式，内存频繁读写，拖慢系统速度，在 x64 中被废除）</p>
<p><strong>•</strong> <strong>中断门( Interrupt-gate）<strong>描述符，主要用于描述</strong>中断处理程序的入口</strong>。</p>
<p><strong>•</strong> <strong>陷阱门(Trap-gate）<strong>描述符，主要用于描述</strong>异常处理程序的入口</strong>。(Windows 64 位下，系统本身的运行没有使用任务门)</p>
<img src="/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201113165754480-2139854787.png" class="" alt="img" loading="lazy">
<img src="/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201113165712305-1289399362.png" class="" alt="img" loading="lazy">
<img src="/2024/07/17/%E5%88%9D%E8%AF%86SEH/image-20240721214916816.png" class="" alt="image-20240721214916816" loading="lazy">
<p>02 08 12项就是任务门的处理过程，其他项是陷阱门的处理过程，在一些没有显示的内容中包含了中断门的处理过程</p>
<h4 id="异常处理的准备工作"><a class="markdownIt-Anchor" href="#异常处理的准备工作"></a> 异常处理的准备工作</h4>
<p>当有中断或异常发生时，CPU 会根据<strong>中断类型号</strong>（这里其实把异常也视为一种中断）转而执行对应的中断处理程序，对异常来说就是上面看到的 KiTrapXX 函数。例如，中断号03对应于一个断点异常，当该异常发生时,CPU就会执行 nt!KiTrap03 函数来处理该异常。各个异常处理函数除了针对本异常的特定处理之外,通常会将异常信息进行封装，以便进行后续处理。</p>
<p>封装的内容主要有两部分：一部分是<strong>异常记录</strong>，包含本次异常的信息,该结构定义如下。</p>
<img src="/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201029205350300-1326375967.png" class="" alt="img" loading="lazy">
<p>这个结构体其实就是 SEH 处理函数的第一个参数。<strong>ExceptionCode</strong> 可以自己定义，自定义代码在 <strong>RaiseException</strong> 函数中使用</p>
<img src="/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201029205536545-1869624930.png" class="" alt="img" loading="lazy">
<p>另一部分被封装的内容称为陷阱帧，它精确描述了发生异常时线程的状态( Windows 的任务调度是基于线程的)。该结构与处理器高度相关,因此在不同的平台上（Intel x86/x64、MIPS、Alpha 和 PowerPC 处理器等）有不同的定义。在常见的 x86 平台上，该结构定义如下。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_KTRAP_FRAME</span>
<span class="token punctuation">&#123;</span>     <span class="token comment">// 以下四项仅为调试系统服务</span>
     ULONG DbgEbp<span class="token punctuation">;</span> 　　　　<span class="token comment">//用户EBP指针的拷贝,用于支持栈回溯命令KB</span>
     ULONG DbgEip<span class="token punctuation">;</span> 　　　　<span class="token comment">//用于 系统调用时的 EIP 同上，用于 KB 命令</span>
     ULONG DbgArgMark<span class="token punctuation">;</span> 　 <span class="token comment">//标记显示这里没有参数</span>
     ULONG DbgArgPointer<span class="token punctuation">;</span> <span class="token comment">//指向实际参数　　　// 当需要调整栈帧时使用以下值作为临时变量</span>
     WORD TempSegCs<span class="token punctuation">;</span>
     UCHAR Logging<span class="token punctuation">;</span>
     UCHAR Reserved<span class="token punctuation">;</span>
     ULONG TempEsp<span class="token punctuation">;</span>　　　<span class="token comment">// 调试寄存器</span>
     ULONG Dr0<span class="token punctuation">;</span>
     ULONG Dr1<span class="token punctuation">;</span>
     ULONG Dr2<span class="token punctuation">;</span>
     ULONG Dr3<span class="token punctuation">;</span>
     ULONG Dr6<span class="token punctuation">;</span>
     ULONG Dr7<span class="token punctuation">;</span>　　　<span class="token comment">// 段寄存器</span>
     ULONG SegGs<span class="token punctuation">;</span>
     ULONG SegEs<span class="token punctuation">;</span>
     ULONG SegDs<span class="token punctuation">;</span>　　　<span class="token comment">// 易失寄存器</span>
     ULONG Edx<span class="token punctuation">;</span>
     ULONG Ecx<span class="token punctuation">;</span>
     ULONG Eax<span class="token punctuation">;</span>　　　<span class="token comment">// 调试系统使用</span>
     ULONG PreviousPreviousMode<span class="token punctuation">;</span>
     PEXCEPTION_REGISTRATION_RECORD ExceptionList<span class="token punctuation">;</span>
     ULONG SegFs<span class="token punctuation">;</span>　　　<span class="token comment">// 非易失寄存器</span>
     ULONG Edi<span class="token punctuation">;</span>
     ULONG Esi<span class="token punctuation">;</span>
     ULONG Ebx<span class="token punctuation">;</span>
     ULONG Ebp<span class="token punctuation">;</span>　　　<span class="token comment">// 控制寄存器</span>
     ULONG ErrCode<span class="token punctuation">;</span>
     ULONG Eip<span class="token punctuation">;</span>
     ULONG SegCs<span class="token punctuation">;</span>
     ULONG EFlags<span class="token punctuation">;</span>　　　<span class="token comment">// 其它特殊变量</span>
     ULONG HardwareEsp<span class="token punctuation">;</span>
     ULONG HardwareSegSs<span class="token punctuation">;</span>
     ULONG V86Es<span class="token punctuation">;</span>
     ULONG V86Ds<span class="token punctuation">;</span>
     ULONG V86Fs<span class="token punctuation">;</span>
     ULONG V86Gs<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> KTRAP_FRAME<span class="token punctuation">,</span> <span class="token operator">*</span>PKTRAP_FRAME<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，上述结构中包含每个寄存器的状态，但该结构一般<strong>仅</strong>供<strong>系统内核自身</strong>或者<strong>调试系统</strong>使用。</p>
<p>当需要把控制权交给<strong>用户注册的异常处理程序</strong>时,会将上述结构<strong>转换</strong>成一个名为 <strong>CONTEXT</strong> 的结构，它包含线程运行时处理器各主要寄存器的完整镜像，用于保存线程运行环境。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_CONTEXT</span>
<span class="token punctuation">&#123;</span>　　　<span class="token comment">// 调试寄存器</span>
    DWORD           ContextFlags                   <span class="token operator">+</span><span class="token number">00</span>h
    DWORD           Dr0                            <span class="token operator">+</span><span class="token number">04</span>h
    DWORD           Dr1                            <span class="token operator">+</span><span class="token number">08</span>h
    DWORD           Dr2                  　　　　　　<span class="token operator">+</span><span class="token number">0</span>Ch
    DWORD           Dr3                            <span class="token operator">+</span><span class="token number">10</span>h
    DWORD           Dr6                            <span class="token operator">+</span><span class="token number">14</span>h
    DWORD           Dr7                            <span class="token operator">+</span><span class="token number">18</span>h

    FLOATING_SAVE_AREA FloatSave<span class="token punctuation">;</span>   <span class="token comment">//浮点寄存器区      +1Ch~~~88h</span>
　　　<span class="token comment">// 段寄存器</span>
    DWORD           SegGs                  　 <span class="token operator">+</span><span class="token number">8</span>Ch
    DWORD           SegFs                  　 <span class="token operator">+</span><span class="token number">90</span>h
    DWORD           SegEs                     <span class="token operator">+</span><span class="token number">94</span>h
    DWORD           SegDs                     <span class="token operator">+</span><span class="token number">98</span>h
　　　<span class="token comment">// 通用寄存器</span>
    DWORD           Edi                       <span class="token operator">+</span><span class="token number">9</span>Ch
    DWORD           Esi                       <span class="token operator">+</span>A0h
    DWORD           Ebx                       <span class="token operator">+</span>A4h
    DWORD           Edx                       <span class="token operator">+</span>A8h
    DWORD           Ecx                       <span class="token operator">+</span>ACh
    DWORD           Eax                       <span class="token operator">+</span>B0h
　　　<span class="token comment">// 控制寄存器</span>
    DWORD           Ebp                         <span class="token operator">+</span>B4h
    DWORD           Eip                         <span class="token operator">+</span>B8h
    DWORD           SegCs                       <span class="token operator">+</span>BCh
    DWORD           EFlag                       <span class="token operator">+</span>C0h
    DWORD           Esp                         <span class="token operator">+</span>C4h
    DWORD           SegSs                       <span class="token operator">+</span>C8h

    BYTE    ExtendedRegisters<span class="token punctuation">[</span>MAXIMUM_SUPPORTED_EXTENSION<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> CONTEXT<span class="token punctuation">;</span>
    <span class="token keyword">typedef</span>     CONTEXT     <span class="token operator">*</span>PCONTEXT<span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">MAXIMUM_SUPPORTED_EXTENSION</span>     <span class="token expression"><span class="token number">512</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第一个域 ContexFlags 表示该结构体中的哪些域有效，恢复信息时可有选择的更新数据。</p>
<img src="/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201030101610385-1590170892.png" class="" alt="img" loading="lazy">
<p>包装完毕，异常处理函数会进一步调用系统内核的 <strong>nt!KiDispatchException 函数来处理异常</strong>。因此，只有深入分析 KiDispatchException 函数的执行过程，才能理解异常是如何被处理的。该函数原型及各参数的含义如下，其第1个和第3个参数正是上面封装的两个结构。</p>
<img src="/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201030102136333-1354367145.png" class="" alt="img" loading="lazy">
<p>在这个函数中，系统会根据是否存在内核调试器，用户态调试器以及调试器对异常的干预过程而进行不同的处理过程</p>
<h4 id="内核态的异常处理过程"><a class="markdownIt-Anchor" href="#内核态的异常处理过程"></a> 内核态的异常处理过程</h4>
<p>当 <strong>PreviousMode</strong> 为 <strong>KernelMode</strong> 时，表示是内核模式下产生的异常,此时 <strong>KiDispatchException</strong> 会按以下步骤<strong>分发异常</strong>。</p>
<p>① 检测当前系统是否正在被<strong>内核调试器</strong>调试。如果内核调试器不存在，就跳过本步骤。如果内核调试器存在，系统就会把异常处理的控制权转交给内核调试器，并注明是第1次处理机会( <strong>FirstChance</strong> )。内核调试器取得控制权之后，会根据用户对异常处理的设置来确定是否要处理该异常。如果无法确定该异常是否需要处理,就会发生中断,把控制权交给用户，由用户决定是否处理。如果调试器正确处理了该异常，那么发生异常的线程就会回到原来产生异常的位置继续执行。</p>
<p>② 如果不存在内核调试器，或者在第1次处理机会出现时调试器选择不处理该异常，系统就会调用 <strong>nt!RtIDispatchException</strong> 函数，根据线程注册的结构化异常处理(<strong>Structured Exception Handling</strong>,<strong>SEH</strong> )过程来处理该异常。</p>
<p>③ 如果 <strong>nt!RtIDispatchException</strong> 函数没有处理该异常,系统会给调试器第2次处理机会( <strong>SecondChance</strong> )，此时调试器可以再次取得对异常的处理权。</p>
<p>④如果不存在内核调试器，或者在第2次机会调试器仍不处理，系统就认为在这种情况下不能继续运行了。为了避免引起更加严重的、不可预知的错误，系统会直接调用 <strong>KeBugCheckEx</strong> 产生一个错误码为“<strong>KERNEL_MODE_EXCEPTION_NOT_HANDLED</strong>”(其值为 <strong>0x0000008E</strong> )的 <strong>BSOD</strong> (俗称蓝屏错误)。</p>
<h4 id="用户态的异常处理过程"><a class="markdownIt-Anchor" href="#用户态的异常处理过程"></a> 用户态的异常处理过程</h4>
<p>当 <strong>PreviousMode</strong> 为 <strong>UserMode</strong> 时，表示是用户模式下产生的异常。此时 <strong>KiDispatchException</strong> 函数仍然会检测内核调试器是否存在。如果内核调试器存在，会优先把控制权交给内核调试器进行处理。所以，使用内核调试器调试用户态程序是完全可行的，并且不依赖进程的调试端口。在大多数情况下，内核调试器对用户态的异常不感兴趣，也就不会去处理它，此时 <strong>nt!KiDispatchException</strong> 函数仍然像处理内核态异常一样按两次处理机会进行分发，主要过程如下。</p>
<p>① 如果发生异常的程序正在被调试，那么将异常信息发送给正在调试它的用户态调试器，给调试器第1次处理机会;如果没有被调试,跳过本步。<br />
② 如果不存在用户态调试器或调试器未处理该异常，那么在栈上放置 <strong>EXCEPTION_RECORD</strong> 和 <strong>CONTEXT</strong> 两个结构，并将控制权返回用户态 <strong>ntdll.dll</strong> 中的 <strong>KiUserExceptionDispatcher</strong> 函数，由它调用 <strong>ntdll!RtIDispatchException</strong> 函数进行用户态的异常处理。这一部分涉及 <strong>SEH</strong> 和 <strong>VEH</strong> 两种异常处理机制。其中，S**EH 部分包括应用程序调用 API 函数 SetUnhandledExceptionFilter 设置的顶级异常处理，但如果有调试器存在，顶级异常处理会被跳过，进入下一阶段的处理，**否则将由顶级异常处理程序进行终结处理（通常是显示一个应用程序错误对话框并根据用户的选择决定是终止程序还是附加到调试器)。如果没有调试器能附加于其上或调试器还是处理不了异常，系统就调用 <strong>ExitProcess</strong> 函数来终结程序。</p>
<p>③ 如果 <strong>ntdlRtIDispatchException</strong> 函数在调用用户态的异常处理过程中未能处理该异常，那么异常处理过程会再次返回 <strong>nt!KiDispatchException</strong>，它将再次把异常信息发送给用户态的调试器，给调试器第2次处理机会。如果没有调试器存在，则不会进行第2次分发,而是直接结束进程。</p>
<p>④ 如果第2次机会调试器仍不处理, <strong>nt!KiDispatchException</strong> 会再次尝试把异常分发给进程的<strong>异常端口</strong>进行处理。该端口通常由子系统进程 <strong>csrss.exe</strong> 进行<strong>监听</strong>。子系统监听到该错误后，通常会显示一个“应用程序错误”对话框，如果没有调试器能附加于其上,或者调试器还是处理不了异常，系统就调用 <strong>ExitProcess</strong> 函数来终结程序。</p>
<p>⑤ 在终结程序之前，系统会再次调用发生异常的线程中的所有异常处理过程，这是线程异常处理过程所获得的清理未释放资源的最后机会，此后程序就终结了。</p>
<h2 id="seh"><a class="markdownIt-Anchor" href="#seh"></a> SEH</h2>
<p>在没有调试器参与的情况下，系统主要依靠SEH机制(用户态内核态都可使用),VEH（仅支持用户模式)</p>
<h3 id="tib"><a class="markdownIt-Anchor" href="#tib"></a> TIB</h3>
<p><strong>TIB</strong> (Thread Information Block，线程信息块）是保存线程基本信息的数据结构。在用户模式下，它位于 <strong>TEB</strong> (Thread Environment Block,线程环境块)的头部，而TEB是操作系统为了保存每个线程的私有数据创建的,每个线程都有自己的TEB。在Windows 2000 DDK中、TIB的定义如下。</p>
<img src="/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201030175658771-1414756359.png" class="" alt="img" loading="lazy">
<p><code>fs:[0]</code>即是ExceptionList的地址</p>
<p>在x64平台上的异常处理 这个关系变成了<code>gs:[0]</code></p>
<h3 id="_exception_registration_record结构"><a class="markdownIt-Anchor" href="#_exception_registration_record结构"></a> _EXCEPTION_REGISTRATION_RECORD结构</h3>
<p><code>TEB</code>偏移量为0的<code>_EXCEPTION_REGISTRATION_RECORD</code>主要用于描述线程异常处理的地址，多个该结构的链表描述了多个线程异常处理过程的嵌套层次关系，其定义如下</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_EXCEPTION_REGISTRATION_RECORD</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">_EXCEPTION_REGISTRATION_RECORD</span> <span class="token operator">*</span>Next<span class="token punctuation">;</span> <span class="token comment">//指向下一个结构的指针</span>
    PEXCEPTION_ROUTINE Handler<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>EXCEPTION_REGISTRATION_RECORD<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中，<code>Next</code>是指向下一个 <code>_EXCEPTION_REGISTRATION_RECORD</code>(简称ERR)的指针，形成一链状结构，而链表头就存放在<code>fs:[0]</code>指向的TEB中</p>
<p><code>Handler</code>指向异常处理回调函数</p>
<img src="/2024/07/17/%E5%88%9D%E8%AF%86SEH/image-20240722104414440.png" class="" alt="image-20240722104414440" loading="lazy">
<p>当程序运行过程中产生异常，系统的异常分发器就会从<code>fs:[0]</code>处取得异常处理的链表头，然后查找异常处理链表并一次调用各个链表节点中的异常处理回调函数。由于<code>TEB</code>是线程的私有数据结构，相应地，每个线程也都有自己的异常处理链表，即SEH机制的作用范围仅限于当前线程</p>
<p>从数据结构的角度，<code>SEH</code>链是一个只允许在链表头部进行增加和删除节点操作的单向链表，且头部永远保存在<code>fs:[0]</code>的TEB结构中</p>
<h3 id="exception_record结构和context结构"><a class="markdownIt-Anchor" href="#exception_record结构和context结构"></a> EXCEPTION_RECORD结构和CONTEXT结构</h3>
<p>这两个结构分别描述了异常发生的异常相关信息和线程状态信息</p>
<h3 id="__exception_pointers-结构"><a class="markdownIt-Anchor" href="#__exception_pointers-结构"></a> <strong>__EXCEPTION_POINTERS 结构</strong></h3>
<p>当一个异常发生时，在没有调试器干预的情况下，操作系统会将异常信息转交给用户态的异常处理过程。实际上，由于同一个线程在<strong>用户态</strong>和<strong>内核态</strong>使用的是两个<strong>不同的栈</strong>，为了让用户态的异常处理程序能够访问与异常相关的数据，操作系统必须把与本次异常相关联的 <strong>EXCEPTION_RECORD</strong> 结构和 <strong>CONTEXT</strong> 结构放到用户态栈中，同时在栈中放置一个 <strong>_EXCEPTION_POINTERS</strong> 结构，它包含两个指针，一个指向 <strong>EXCEPTION_RECORD</strong> 结构，另一个指向 <strong>CONTEXT</strong> 结构，示例如下。</p>
<img src="/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201030192439381-1236684328.png" class="" alt="img" loading="lazy">
<p>这样用户态的异常处理程序就能够取得异常的具体信息和发生异常时线程的状态信息，并根据具体情况进行处理</p>
<h3 id="seh处理程序的安装和卸载"><a class="markdownIt-Anchor" href="#seh处理程序的安装和卸载"></a> SEH处理程序的安装和卸载</h3>
<p>从汇编的角度来看</p>
<p><code>fs:[0]</code>总是指向当前异常处理程序的链表头，当程序需要安装一个新的SEH异常处理程序时，只要填写一个新的<code>EXCEPTION_REGISTRATION_RECORD</code>结构，并将其插入SEH链表的头部,根据SEH的设计要求，SEH的作用返回与安装它的函数相同，因此需要在函数头部安装SEH异常程序 然后在函数返回前卸载，因此SEH是基于栈帧的异常处理机制</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">assume <span class="token register variable">fs</span>:nothing
	push offset SEHandler
	push <span class="token register variable">fs</span>:<span class="token operator">[</span><span class="token number">0</span><span class="token operator">]</span>
	mov <span class="token register variable">fs</span>:<span class="token operator">[</span><span class="token number">0</span><span class="token operator">]</span>,<span class="token register variable">esp</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>例如上，后面三行是注册回调函数</p>
<p>前两行相继向栈中压入了<code>Handler</code>和目前的<code>SEH链表头</code>，这两个元素构成了一个新的<code>_EXCEPTION_REGISTRATION_rECORD</code>结构，此时位置正在栈顶</p>
<p>然后把<code>esp</code>的值保存在fs:0，就相当于向链表中插入了一个新节点</p>
<img src="/2024/07/17/%E5%88%9D%E8%AF%86SEH/image-20240722105849770.png" class="" alt="image-20240722105849770" loading="lazy">
<p>再看如何卸载SEH</p>
<p>我们只需要将原来的fs:[0]的原始值给回复并且恢复栈的平衡即可</p>
<p>相当于删除SEH链的一个节点</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">mov esp<span class="token punctuation">,</span>dword ptr fs<span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
pop dword ptr fs<span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="seh异常处理程序原理以及设计"><a class="markdownIt-Anchor" href="#seh异常处理程序原理以及设计"></a> SEH异常处理程序原理以及设计</h2>
<p>在实际应用中，大部分情况没有调试器的存在，此时异常将如何分发是我们关注的重点</p>
<h3 id="异常分发的详细过程"><a class="markdownIt-Anchor" href="#异常分发的详细过程"></a> 异常分发的详细过程</h3>
<p>异常处理的实际过程实际上是系统将异常发送到各个异常处置单元中进行处理的过程，这个过程叫做异常的分发。</p>
<p>下面是用户态的异常分发</p>
<p>首先用户态的异常分发从<code>ntdll!KiUserExceptionDispatcher</code>函数开始</p>
<p>此时栈中有<code>EXCEPTION_RECORD</code>和<code>CONTEXT</code>两个结构</p>
<img src="/2024/07/17/%E5%88%9D%E8%AF%86SEH/image-20240722110928854.png" class="" alt="image-20240722110928854" loading="lazy">
<p>从上述代码可以看出</p>
<ul>
<li>
<p><code>ntdll!RtlDispatchException</code>函数用来具体分发异常</p>
</li>
<li>
<p>当异常被处理后，会使用<code>NtCountinue</code>服务恢复该线程的执行</p>
</li>
<li>
<p>如果异常没被处理，就调用<code>NtRaiseException</code>函数引发第二次异常</p>
<p>（其中第三个参数BOOLEAN FirstChance FALSE 表示不是第一次机会)</p>
</li>
</ul>
<p><code>btdll!RtlDispatchException</code>的实现和细节很复杂</p>
<p>代码太长就不贴了</p>
<p>大部分都是各类安全验证，抛开核心验证，只看核心流程</p>
<p>RtlDispatchException 函数总体的流程是：</p>
<p>① 首先调用 VEH 异常处理，返回值不是 <strong>EXCEPTION_CONTINUE_SEARCH</strong> 就结束异常分发,继续调用SEH部分的处理</p>
<p>② 返回值符合要求，则查询 SEHOP 是否启用，未开启则会进行校验（对每个 Record 结构体都会进行验证）</p>
<p>③ 对 Handler 进行增强验证，即 SafeSEH 机制（通过调用函数 RtlIsValidHandler 来实现）</p>
<p>④ 开始依次执行 Handler，并对返回值进行对比（Switch-Case），执行相应的操作</p>
<ul>
<li>对<code>ExceptionContinueExecution</code>结束遍历并返回(对标记EXCEPTION_NONCONTINTINUABLE的异常不允许再次恢复执行，会调用RtlRaiseException)</li>
<li>对<code>ExceptionContinueSearch</code>继续遍历下一个节点</li>
<li>对<code>ExceptionNestedException</code>从指定的新异常开始继续遍历</li>
</ul>
<p>⑤ 必会执行的最后一步，调用 RtlCallVectoredContinueHandlers 函数，然后程序返回</p>
<h3 id="线程异常处理"><a class="markdownIt-Anchor" href="#线程异常处理"></a> 线程异常处理</h3>
<p>线程异常处理就是指SEH异常处理</p>
<p>SEH的整体设计思路就是基于线程的</p>
<p>一般来说A西安餐发生的异常无法被B线程的异常处理程序捕获</p>
<h4 id="线程异常处理的工作细节"><a class="markdownIt-Anchor" href="#线程异常处理的工作细节"></a> 线程异常处理的工作细节</h4>
<p>在上文，我们已经知道如何安装和卸载SEH异常回调函数</p>
<p>实际上，回调函数的原型是这样定义</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">Handler proc C pExcept<span class="token punctuation">,</span>pFrame<span class="token punctuation">,</span>pContext<span class="token punctuation">,</span>pDispatch<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li><code>pExcept</code>指前面介绍的包含异常处理信息的<code>Exception_Record</code>结构的地址</li>
<li><code>pFrame</code>指向<code>SEH</code>链中当前<code>_EXCEPTION_REGISTARTION</code>结构的地址</li>
<li><code>pContext</code>指向与线程相关的寄存器映像<code>CONTEXT</code>结构的地址</li>
<li><code>pDispatch</code>该域用于内嵌异常处理</li>
</ul>
<p>相应的C格式声明</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token class-name">_EXCEPTION_DISPOSITION</span><span class="token punctuation">&#123;</span>
	ExceptionContinueExecution<span class="token punctuation">,</span><span class="token comment">//0</span>
    ExceptionContinueSearch<span class="token punctuation">,</span><span class="token comment">//1</span>
    ExceptionNestedException<span class="token punctuation">,</span><span class="token comment">//2</span>
    ExceptionCollidedUnwind <span class="token comment">//3</span>
<span class="token punctuation">&#125;</span>EXCEPTION_DISPOSITION<span class="token punctuation">;</span>

EXCEPTION_DISPOSITION _cdecl <span class="token function">_Except_handler</span><span class="token punctuation">(</span>
<span class="token keyword">struct</span> <span class="token class-name">_EXCEPTION_RECORD</span> <span class="token operator">*</span>ExceptionRecord<span class="token punctuation">,</span>
<span class="token keyword">void</span> <span class="token operator">*</span> EstablisherFrame
<span class="token keyword">struct</span> <span class="token class-name">_CONTEXT</span> <span class="token operator">*</span>ContextRecord<span class="token punctuation">,</span>
<span class="token keyword">void</span> <span class="token operator">*</span> DispatcherContext<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>各个参数的意义很明确，回调函数要做的就是通过<code>EXCEPTION_rECORD</code>结构中的信息判断当前异常自己是否能处理，如果能，就要根据异常产生的原因进行修正，必要时修改CONTEXT结构，然后恢复执行，如果不能就去寻找下一个处理程序</p>
<p>系统会根据每个回调函数的返回值进行相应动作</p>
<p><strong>(1) ExceptionContinueExecution</strong></p>
<p>异常已处理，根据 Contex 结构体的相关信息恢复线程的执行</p>
<p><strong>(2) ExceptionContinueSearch</strong></p>
<p>回调函数不能处理该异常，需要交由链表中的下一个函数来处理</p>
<p><strong>(3) ExceptionNestedException</strong></p>
<p>回调函数在处理该异常时也发生了异常，即嵌套异常。在内核中发生将会停止系统的运行</p>
<p><strong>(4) ExceptionCollidedUnwind</strong></p>
<p>回调函数在进行<strong>异常展开</strong>操作时发生了异常。展开操作可以理解为恢复发生异常的第一现场，并在恢复过程中的系统资源进行回收。展开操作由系统在处理异常时进行，用户自定义的回调函数通常不返回这个值。</p>
<p>后两个返回值一般只见于<strong>系统内部</strong>的处理过程，用户自定义的回调函数只返回前两个值。</p>
<p>SEH 链的最后一个函数是系统设置的<strong>终结处理函数</strong>。</p>
<h3 id="异常处理函数的栈展开rtlunwind"><a class="markdownIt-Anchor" href="#异常处理函数的栈展开rtlunwind"></a> 异常处理函数的栈展开(RtlUnwind)</h3>
<h4 id="什么是栈展开"><a class="markdownIt-Anchor" href="#什么是栈展开"></a> 什么是栈展开</h4>
<p>传递给回调函数的<code>EXCEPTIO_RECORD</code>结构的<code>ExceptionFlags</code>有三个可选值</p>
<p>分别是012,0表示可修复异常，1表示不可修复异常，2代表展开操作</p>
<p>当所有异常回调函数都不处理异常时，系统在终结程序之前会给发生异常的线程中所有注册的回调函数一个调用。不同的是，在调用之前要将<code>EXCEPTION_RECORD</code>中的<code>EXCEPTIONFLAGS</code>域置2，将<code>ExceptionCode</code>域置为<code>STATUS_UNWIND</code></p>
<p>这个回调的目的是给他们一个清理的机会，例如释放重要的系统资源，保存异常发生时关键变量的值等善后工作</p>
<p>进行栈展开的另一个目的是，如果不进行栈展开操作，就有可能引发未知的错误，</p>
<h4 id="为什么要进行栈展开"><a class="markdownIt-Anchor" href="#为什么要进行栈展开"></a> 为什么要进行栈展开</h4>
<p>一般情况下，只有在系统总结程序之前，栈展开才会发生，目的是给程序清理未释放资源的机会，如果决定要自己处理大部分异常，并在处理后继续正常执行，也可以参照系统的设计自己进行栈展开，给异常回调函数链表上的其他回调函数清理的机会</p>
<p><strong>ExceptionRecord</strong> 结构的 <strong>ExceptionFlags</strong> 成员有三个值 <strong>0</strong>，<strong>1</strong>，<strong>2</strong>，分别代表 <strong>可修复异常</strong>，<strong>不可修复异常</strong>，<strong>栈展开</strong></p>
<p><strong>栈展开：所有回调函数都不处理异常时，系统在终结程序之前会调用发生异常的线程中所有注册的回调函数（被调用的函数执行自定义的操作，调用顺序是：从Fs：[0]开始依次到目前正在执行的异常处理函数之前，不包括当前回调函数）</strong>。在开始调用前，ExceptionFlags 会被置为 2，ExceptionCode 会被置为 STATUS_UNWIND（0x0C0000027），回调的目的是给程序一个清理占用的资源以及保存关键变量的值等等操作。利用汇编代码写 SEH 时可以不执行这个函数。</p>
<p>栈展开的另一个目的是，如果在调用了多重函数并在内层函数遇到异常，返回到最外层函数后，经过一系列的 Push 操作，而再次遇到异常时，由于 Fs：[0] 的值指向的还是原来的栈地址，会造成程序出现问题。</p>
<img src="/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201101211034456-891047377.png" class="" alt="img" loading="lazy">
<h4 id="如何进行栈展开"><a class="markdownIt-Anchor" href="#如何进行栈展开"></a> 如何进行栈展开</h4>
<p>微软提供了现成的API函数<code>RtlUnwind</code>调用方式如下</p>
<p><code>RtlUnwind(VirtualTargetFrame,TargetPC,ExceptionRecord,ReturnValue)</code></p>
<ul>
<li><code>VirtualTargetFrame</code>:展开时，最后在SEH链上停止于回调函数所对应的<code>EXCEPTION_REGISTRATION</code>的指针，即希望在哪个回调函数前展开调用停止，其对应的<code>EXCEPTION_REGISTRATION</code>结构的指针就作为该参数使用（在大部分情况下是引发调用的回调函数所对应的<code>EXCEPTION_REGISTRATION</code>结构的指针</li>
<li><code>TargetPC</code>:调用<code>RtlUnwind</code>返回后应执行指令的地址。如果为0，则自然返回<code>RtlUnwind</code>调用后的下一条指令，与正常的API调用相同</li>
<li><code>ExceptionRecord</code>:当前异常的<code>EXCEPTION_RECORD</code>结构，可以直接使用在异常中传递给回调函数的该参数</li>
<li><code>ReturnValue</code>:返回值，通常不使用</li>
</ul>
<h3 id="msc编译器对线程异常处理的增强"><a class="markdownIt-Anchor" href="#msc编译器对线程异常处理的增强"></a> MSC编译器对线程异常处理的增强</h3>
<p>上面那些例子都是用汇编语言写的。但是，这个操作过程是极其不便的,尤其对高级语言来说，直接操作寄存器、读写fs[0]并不合适且非常烦琐。为此，各主流编译器都对 SEH 机制进行了扩充和增强，使程序员能更简便地使用异常处理机制。所以，在<strong>现实程序设计中，除了保护壳、反调试等特殊用途，基本上没有直接使用系统的SEH 机制，而是使用编译器提供的增强版本</strong>。C语言是Windows操作系统的开发语言，下面就看看微软的 C 编译器（MSC）提供的增强版本异常处理机制。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_EXCEPTION_REGISTRATION</span> PEXCEPTION_REGISTRATION<span class="token punctuation">;</span>
<span class="token comment">//异常回调函数原型</span>
<span class="token keyword">typedef</span> <span class="token function">EXCEPTION_DISPOSITION</span><span class="token punctuation">(</span>__cdecl <span class="token operator">*</span>PEXCEPTION_ROUTINE<span class="token punctuation">)</span><span class="token punctuation">(</span>
　　　　　　<span class="token keyword">struct</span> <span class="token class-name">_EXCEPTION_RECORD</span> <span class="token operator">*</span>__ExceptionRecord<span class="token punctuation">,</span>　　　　　　<span class="token keyword">void</span> <span class="token operator">*</span>_EstablisherFrame<span class="token punctuation">,</span>
　　　　　　<span class="token keyword">struct</span> <span class="token class-name">_cONTEXT</span> <span class="token operator">*</span>_ContextRecord<span class="token punctuation">,</span>　　　　　　<span class="token keyword">void</span> <span class="token operator">*</span>_DispatcherContext
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//C/C++运行库使用的_SCOPETABLE_ENTRY 结构typdef struct_SCOPETABLE_ ENTRY &#123;</span>
　　DWORD EnclosingLevel<span class="token punctuation">;</span> <span class="token comment">//上一层__try块</span>
　　PVOID FilterFunc<span class="token punctuation">;</span>　　  <span class="token comment">//过滤表达式</span>
　　PVOID HandlerFunc<span class="token punctuation">;</span>　　 <span class="token comment">//_except 块代码或 _finally 块代码</span>
<span class="token punctuation">&#125;</span>SCOPETABLE_ENTRY<span class="token punctuation">,</span> <span class="token operator">*</span>PSCOPETABLE_ENTRY<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">_EH3_EXCEPTION_REGISTRATION</span>
<span class="token punctuation">&#123;</span>　　<span class="token keyword">struct</span> <span class="token class-name">_EH3_EXCEPTION_REGISTRATION</span> <span class="token operator">*</span>Next<span class="token punctuation">;</span>　　PVOID ExceptionHandler<span class="token punctuation">;</span>　　PSCOPETABLE_ENTRY scopeTable<span class="token punctuation">;</span>　　DWORD TryLevel<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token comment">// C/C++编译器扩展 SEH 的异常帧结构 </span>
<span class="token keyword">struct</span> <span class="token class-name">CPPEH_RECORD</span><span class="token punctuation">&#123;</span>　　DWORD old_esp<span class="token operator">:</span>　　EXCEPTION_POINTERS <span class="token operator">*</span>exc_ptr<span class="token punctuation">;</span>　　struct_EH3_EXCEPTION_REGISTRATION registration<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>编译器真正使用的结构是 <strong>CPPEH_RECORD</strong>，其成员 <strong>_EH3_EXCEPTION_RECISTRATION</strong> 结构是对原始的 SEH结构 <strong>_EXCEPTION_RECISTRATION_RECORD</strong> 的扩充。该结构在原始版本的基础上增加了4个域成员（<strong>ScopeTable</strong>、<strong>Trylevel</strong>、<strong>old_esp</strong>、**exc_ptr )**来支持它的增强功能。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">__try
<span class="token punctuation">&#123;</span>
    <span class="token comment">/*可能产生异常的代码*/</span>
<span class="token punctuation">&#125;</span>
<span class="token function">__except</span><span class="token punctuation">(</span>  <span class="token comment">/*异常筛选代码*/</span> <span class="token function">FilterFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">/*异常处理代码*/</span>
    <span class="token function">ExceptionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
__try<span class="token punctuation">&#123;</span>　　<span class="token comment">/*可能产生异常的代码*/</span><span class="token punctuation">&#125;</span>__fina1ly
<span class="token punctuation">&#123;</span>　　<span class="token comment">/*终结处理代码*/</span>
　　<span class="token function">FinallyHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>__try</strong> / <strong>__finally</strong> 暂时可以看成 <strong>__try</strong> /<strong>__except</strong> 模型的一个特例,它本身不能处理异常,但是不管有没有发生异常，<strong>__finally 块总会被执行</strong>，通常用来进行一些<strong>收尾和清理工作</strong>。<br />
现在程序员再进行异常处理就非常简单了，只要把可能产生异常的代码用 <strong>__try</strong> 包裹起来，然后在 <strong>FilterFunc</strong> 中判断是不是预料之中的异常即可。如果是，在 <strong>ExceptionHandler</strong> 中进行处理就可以了。而且，<strong>__try</strong> / <strong>__except</strong> ( <strong>__finally</strong> ) 结构可以进行多层嵌套，每层相应地只处理自己关心的异常。</p>
<p>这里的 <strong>FilterFunc</strong> 称为<strong>异常筛选器</strong>，它实际上是一个逗号表达式(<strong>注意，逗号表达式最后的值取决于最右边的表达式值，因为逗号表达式从左至右计算</strong>)。我们可以在这里完成任何工作——哪怕是计算圆周率,只要最后返回符合要求的结果就可以了。</p>
<p>正常来说__except 的表达式内的函数通过调用 <strong>GetExceptionCode</strong> 或 <strong>GetExceptionInformation</strong> 函数获取异常的详细信息，对特定的异常进行处理返回不同的值。通常有3种返回值,示例如下。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name">EXCEPTION_EXECUTE_HANDLER</span>  <span class="token expression"><span class="token number">1</span>　　　 表示该异常在预料之中，请直接执行下面的 Exception</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name">EXCEPTION_CONTINUE_SEARCH</span>  <span class="token expression"><span class="token number">0</span>　　　 表示不处理该异常<span class="token punctuation">,</span>请继续寻找其他处理程序</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name">EXCEPTION_CONTINUE_EXECUTION</span>  <span class="token expression"><span class="token operator">-</span><span class="token number">1</span>  表示该异常已被修复<span class="token punctuation">,</span>请回到异常现场再次执行</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="编译器的seh增强设计"><a class="markdownIt-Anchor" href="#编译器的seh增强设计"></a> 编译器的SEH增强设计</h3>
<p>按照原始版本的设计，每一对“触发异常/处理异常”都有一个注册信息，即 <strong>EXCEPTION_REGISTRATION_RECORD</strong> (以下简称“<strong>ERR结构</strong>”)。也就是说，按照原始设计，每一个**__tryl_except(_finally)<strong>都应该对应于一个 <strong>ERR</strong> 结构。但是，而 <strong>MSC</strong> 编译器的实现是</strong>:每个使用_tryl_except (_finally)的函数,不管其内部嵌套或反复使用多少_tryl_exeept ( _finally),都只注册1遍,即只将1个ERR 结构挂入当前线程的异常链表中**。每对 <strong>__try / _except(_finally)</strong> 称为一个 <strong>Try</strong> 块。<strong>对于递归函数，每次调用都会创建一个ERR结构，并将其挂入线程的异常链表。</strong></p>
<p>对于多个 <strong>Try</strong> 块而只有一个 <strong>Handler</strong>， <strong>MSC</strong> 提供一个代理函数，即 <strong>_EH3_EXCEPTION_RECISTRATION:ExceptionHandler</strong> 被设置为 <strong>MSC</strong> 的某个库函数。开发人员提供的多个 <strong>__exeept</strong> 块被存储在 <strong>_EH3_EXCEPTION_REGISTRATION::ScopeTable</strong> 数组中。</p>
<p>在由 <strong>VC6.0</strong> 编译生成的程序中，这个由编译器提供的异常处理函数叫作 <strong>_except_handler3</strong> ，它实际上是<strong>公共库的一部分</strong>，<strong>系统的每个 DLL 里都有这个函数的实现</strong>。根据编译设置的不同,它的具体实现可能出现在 <strong>msvcrt.dl、kernel32.dll</strong> 这样的<strong>公共库</strong>中，也可能直接<strong>内联</strong>到 <strong>exe</strong> 本身，但具体代码都是一样的。这样，当异常发生时，系统会根据 <strong>SEH</strong> <strong>链表</strong>找到**_except_handler3** 函数并执行它，<strong>_except_handler3</strong> 再根据编译时生成的 <strong>ScopeTable</strong> 执行开发人员提供的 <strong>FilterFunc</strong> 和 <strong>HandlerFunc</strong> ,也就是说,<strong>编译器提供的异常处理函数实现了一层代理的工作</strong>。</p>
<h3 id="编译器的实际工作"><a class="markdownIt-Anchor" href="#编译器的实际工作"></a> 编译器的实际工作</h3>
<p>① 把 <strong>FilterFunc</strong> 和 <strong>HandlerFunc</strong> 编译成<strong>单独的函数</strong>（<strong>FilterFunc</strong> 代码块和 Finally 代码块的尾部都有 <strong>retn</strong> 指令；而 <strong>HandlerFunc</strong> 尾部有 <strong>Jmp</strong> 指令，它跳转到 <strong>Try</strong> 块的结束；它们都是以函数的形式被调用的），并按照 <strong>Try</strong> 块出现的顺序及嵌套关系生成正确的 ScopeTable。</p>
<p>编译器对 <strong>SCOPETABLE_ENTRY</strong> 是这样定义的:对 <strong>__try</strong> / <strong>__except</strong> 组合来说，其中的 <strong>FilterFunc</strong> 就是过滤表达式代码块，<strong>HandlerFunc</strong> 就是异常处理代码块;对 <strong>__try</strong> / <strong>__finally</strong> 组合来说，<strong>FilterFunc</strong> 被置为 “NULL”, <strong>HandlerFunc</strong> 就是终结处理代码块。</p>
<p>对于函数中的每一个 <strong>Try</strong> 块,编译器都会生成一个 <strong>SCOPETABLE_ENTRY</strong> ,并按照 <strong>Try</strong> 块的出现顺序确定各个 <strong>Try</strong> 块的索引,索引值遵从C语言的习惯(从0开始)。在执行对应的 <strong>Try</strong> 块之前,编译器会把当前 <strong>Try</strong> 块的索引保存到 <strong>_EH3_EXCEPTION_RECISTRATION</strong> 结构的 <strong>TryLevel</strong> 成员中，它是函数中当前 <strong>Try</strong> 块的<strong>索引</strong>。每个 <strong>SCOPETABLE_ENTRY</strong> 结构中的 <strong>EnclosingLevel</strong> 则表示:如果当前 <strong>Try</strong> 块未能处理异常，那么要寻找下一级 <strong>Try</strong> 块(也就是包含当前 <strong>Try</strong> 块的父 <strong>Try</strong> 块)的索引。如果它的值是 <strong>-1</strong>，表示当前块已经没有父块了，当前函数已经不能处理该异常了。同时，-1也是 <strong>TryLevel</strong> 的默认值。</p>
<p>② 在函数开头布置 <strong>CPPEH_RECORD</strong> 结构，并安装 <strong>SEH</strong> 异常处理函数。在由 VC 6.0 编译的程序中，这个函数的名字是 _except_handler3。如果想详细分析 _except_handler3 函数,了解栈中的数据布局是非常有必要的。</p>
<img src="/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201103120306392-55524503.png" class="" alt="img" loading="lazy">
<p>③ 在进入每个 Try 块之后,先设置当前 Try 块的 TryLevel 值,再执行 Try 块内的代码。退出 Try 块保护区域后,恢复为原来的 TryLevel.</p>
<p>④ 在函数返回前,卸载 SEH 异常处理函数。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">VOID <span class="token function">TwoException</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> <span class="token operator">*</span>pValue <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>
    __try
    <span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"In Try0.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        __try
        <span class="token punctuation">&#123;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"In Try1.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">*</span>pValue <span class="token operator">=</span> <span class="token number">0x55555555</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">__except</span><span class="token punctuation">(</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"In Filter1\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>EXCEPTION_CONTINUE_SEARCH<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"In Handler1.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">__except</span><span class="token punctuation">(</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"In Filter0\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>EXCEPTION_EXECUTE_HANDLER<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"In Handler0.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"After All Trys.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

Two Exceptions<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401200</span>                   sub_401200 proc near          <span class="token punctuation">;</span> CODE XREF<span class="token operator">:</span> _main<span class="token operator">+</span>F↑p
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401200</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401200</span>                   ms_exc<span class="token operator">=</span> CPPEH_RECORD ptr <span class="token operator">-</span><span class="token number">18</span>h
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401200</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401200</span>                   <span class="token punctuation">;</span> __unwind <span class="token punctuation">&#123;</span> <span class="token comment">// __except_handler3</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401200</span> <span class="token number">55</span>                push    ebp
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401201</span> <span class="token number">8</span>B EC             mov     ebp<span class="token punctuation">,</span> esp
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401203</span> <span class="token number">6</span>A FF             push    <span class="token number">0FFFF</span>FFFFh
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401205</span> <span class="token number">68</span> <span class="token number">10</span> <span class="token number">71</span> <span class="token number">40</span> <span class="token number">00</span>    push    offset stru_407110
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0040120</span>A <span class="token number">68</span> <span class="token number">30</span> <span class="token number">17</span> <span class="token number">40</span> <span class="token number">00</span>    push    offset __except_handler3
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0040120F</span> <span class="token number">64</span> A1 <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> mov     eax<span class="token punctuation">,</span> large fs<span class="token operator">:</span><span class="token number">0</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401215</span> <span class="token number">50</span>                push    eax
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401216</span> <span class="token number">64</span> <span class="token number">89</span> <span class="token number">25</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span><span class="token operator">+</span>mov     large fs<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> esp
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0040121</span>D <span class="token number">83</span> EC <span class="token number">0</span>C          sub     esp<span class="token punctuation">,</span> <span class="token number">0</span>Ch
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401220</span> <span class="token number">53</span>                push    ebx
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401221</span> <span class="token number">56</span>                push    esi
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401222</span> <span class="token number">57</span>                push    edi
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401223</span> <span class="token number">89</span> <span class="token number">65</span> E8          mov     <span class="token punctuation">[</span>ebp<span class="token operator">+</span>ms_exc<span class="token punctuation">.</span>old_esp<span class="token punctuation">]</span><span class="token punctuation">,</span> esp
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401226</span> <span class="token number">33</span> F6             <span class="token operator">xor</span>     esi<span class="token punctuation">,</span> esi
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401228</span>                   <span class="token punctuation">;</span>   __try <span class="token punctuation">&#123;</span> <span class="token comment">// __except at loc_401293</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401228</span> <span class="token number">89</span> <span class="token number">75</span> FC          mov     <span class="token punctuation">[</span>ebp<span class="token operator">+</span>ms_exc<span class="token punctuation">.</span>registration<span class="token punctuation">.</span>TryLevel<span class="token punctuation">]</span><span class="token punctuation">,</span> esi
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0040122</span>B <span class="token number">68</span> B0 <span class="token number">82</span> <span class="token number">40</span> <span class="token number">00</span>    push    offset aInTry0        <span class="token punctuation">;</span> <span class="token string">"In Try0.\n"</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401230</span> E8 D1 <span class="token number">03</span> <span class="token number">00</span> <span class="token number">00</span>    call    sub_401606
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401235</span> <span class="token number">83</span> C4 <span class="token number">04</span>          add     esp<span class="token punctuation">,</span> <span class="token number">4</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401235</span>                   <span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span> <span class="token comment">// starts at 401228</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401238</span>                   <span class="token punctuation">;</span>   __try <span class="token punctuation">&#123;</span> <span class="token comment">// __except at loc_401267</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401238</span>                   <span class="token punctuation">;</span>     __try <span class="token punctuation">&#123;</span> <span class="token comment">// __except at loc_401293</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401238</span> C7 <span class="token number">45</span> FC <span class="token number">01</span> <span class="token number">00</span> <span class="token number">00</span><span class="token operator">+</span>mov     <span class="token punctuation">[</span>ebp<span class="token operator">+</span>ms_exc<span class="token punctuation">.</span>registration<span class="token punctuation">.</span>TryLevel<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0040123F</span> <span class="token number">68</span> A4 <span class="token number">82</span> <span class="token number">40</span> <span class="token number">00</span>    push    offset aInTry1        <span class="token punctuation">;</span> <span class="token string">"In Try1.\n"</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401244</span> E8 BD <span class="token number">03</span> <span class="token number">00</span> <span class="token number">00</span>    call    sub_401606
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401249</span> <span class="token number">83</span> C4 <span class="token number">04</span>          add     esp<span class="token punctuation">,</span> <span class="token number">4</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0040124</span>C C7 <span class="token number">06</span> <span class="token number">55</span> <span class="token number">55</span> <span class="token number">55</span> <span class="token number">55</span> mov     dword ptr <span class="token punctuation">[</span>esi<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">55555555</span>h
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0040124</span>C                   <span class="token punctuation">;</span>     <span class="token punctuation">&#125;</span> <span class="token comment">// starts at 401238</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0040124</span>C                   <span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span> <span class="token comment">// starts at 401238</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401252</span>                   <span class="token punctuation">;</span>   __try <span class="token punctuation">&#123;</span> <span class="token comment">// __except at loc_401293</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401252</span> <span class="token number">89</span> <span class="token number">75</span> FC          mov     <span class="token punctuation">[</span>ebp<span class="token operator">+</span>ms_exc<span class="token punctuation">.</span>registration<span class="token punctuation">.</span>TryLevel<span class="token punctuation">]</span><span class="token punctuation">,</span> esi
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401255</span> EB <span class="token number">4</span>C             jmp     <span class="token keyword">short</span> loc_4012A3
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401257</span>                   <span class="token punctuation">;</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401257</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401257</span>                   loc_401257<span class="token operator">:</span>                   <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> <span class="token punctuation">.</span>rdata<span class="token operator">:</span>stru_407110↓o
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401257</span>                   <span class="token punctuation">;</span>   __except filter <span class="token comment">// owned by 401238</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401257</span> <span class="token number">68</span> <span class="token number">98</span> <span class="token number">82</span> <span class="token number">40</span> <span class="token number">00</span>    push    offset aInFilter1     <span class="token punctuation">;</span> <span class="token string">"In Filter1\n"</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0040125</span>C E8 A5 <span class="token number">03</span> <span class="token number">00</span> <span class="token number">00</span>    call    sub_401606
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401261</span> <span class="token number">83</span> C4 <span class="token number">04</span>          add     esp<span class="token punctuation">,</span> <span class="token number">4</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401264</span> <span class="token number">33</span> C0             <span class="token operator">xor</span>     eax<span class="token punctuation">,</span> eax
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401266</span> C3                retn
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401267</span>                   <span class="token punctuation">;</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401267</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401267</span>                   loc_401267<span class="token operator">:</span>                   <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> <span class="token punctuation">.</span>rdata<span class="token operator">:</span>stru_407110↓o
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401267</span>                   <span class="token punctuation">;</span>   <span class="token function">__except</span><span class="token punctuation">(</span>loc_401257<span class="token punctuation">)</span> <span class="token comment">// owned by 401238</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401267</span> <span class="token number">8</span>B <span class="token number">65</span> E8          mov     esp<span class="token punctuation">,</span> <span class="token punctuation">[</span>ebp<span class="token operator">+</span>ms_exc<span class="token punctuation">.</span>old_esp<span class="token punctuation">]</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0040126</span>A <span class="token number">68</span> <span class="token number">88</span> <span class="token number">82</span> <span class="token number">40</span> <span class="token number">00</span>    push    offset aInHandler1    <span class="token punctuation">;</span> <span class="token string">"In Handler1.\n"</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0040126F</span> E8 <span class="token number">92</span> <span class="token number">03</span> <span class="token number">00</span> <span class="token number">00</span>    call    sub_401606
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401274</span> <span class="token number">83</span> C4 <span class="token number">04</span>          add     esp<span class="token punctuation">,</span> <span class="token number">4</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401274</span>                   <span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span> <span class="token comment">// starts at 401252</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401277</span>                   <span class="token punctuation">;</span>   __try <span class="token punctuation">&#123;</span> <span class="token comment">// __except at loc_401293</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401277</span> C7 <span class="token number">45</span> FC <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span><span class="token operator">+</span>mov     <span class="token punctuation">[</span>ebp<span class="token operator">+</span>ms_exc<span class="token punctuation">.</span>registration<span class="token punctuation">.</span>TryLevel<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0040127</span>E EB <span class="token number">23</span>             jmp     <span class="token keyword">short</span> loc_4012A3
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401280</span>                   <span class="token punctuation">;</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401280</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401280</span>                   loc_401280<span class="token operator">:</span>                   <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> <span class="token punctuation">.</span>rdata<span class="token operator">:</span>stru_407110↓o
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401280</span>                   <span class="token punctuation">;</span>   __except filter <span class="token comment">// owned by 401228</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401280</span>                   <span class="token punctuation">;</span>   __except filter <span class="token comment">// owned by 401238</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401280</span>                   <span class="token punctuation">;</span>   __except filter <span class="token comment">// owned by 401252</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401280</span>                   <span class="token punctuation">;</span>   __except filter <span class="token comment">// owned by 401277</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401280</span> <span class="token number">68</span> <span class="token number">7</span>C <span class="token number">82</span> <span class="token number">40</span> <span class="token number">00</span>    push    offset aInFilter0     <span class="token punctuation">;</span> <span class="token string">"In Filter0\n"</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401285</span> E8 <span class="token number">7</span>C <span class="token number">03</span> <span class="token number">00</span> <span class="token number">00</span>    call    sub_401606
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0040128</span>A <span class="token number">83</span> C4 <span class="token number">04</span>          add     esp<span class="token punctuation">,</span> <span class="token number">4</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0040128</span>D B8 <span class="token number">01</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>    mov     eax<span class="token punctuation">,</span> <span class="token number">1</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401292</span> C3                retn
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401293</span>                   <span class="token punctuation">;</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401293</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401293</span>                   loc_401293<span class="token operator">:</span>                   <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> <span class="token punctuation">.</span>rdata<span class="token operator">:</span>stru_407110↓o
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401293</span>                   <span class="token punctuation">;</span>   <span class="token function">__except</span><span class="token punctuation">(</span>loc_401280<span class="token punctuation">)</span> <span class="token comment">// owned by 401228</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401293</span>                   <span class="token punctuation">;</span>   <span class="token function">__except</span><span class="token punctuation">(</span>loc_401280<span class="token punctuation">)</span> <span class="token comment">// owned by 401238</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401293</span>                   <span class="token punctuation">;</span>   <span class="token function">__except</span><span class="token punctuation">(</span>loc_401280<span class="token punctuation">)</span> <span class="token comment">// owned by 401252</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401293</span>                   <span class="token punctuation">;</span>   <span class="token function">__except</span><span class="token punctuation">(</span>loc_401280<span class="token punctuation">)</span> <span class="token comment">// owned by 401277</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401293</span> <span class="token number">8</span>B <span class="token number">65</span> E8          mov     esp<span class="token punctuation">,</span> <span class="token punctuation">[</span>ebp<span class="token operator">+</span>ms_exc<span class="token punctuation">.</span>old_esp<span class="token punctuation">]</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00401296</span> <span class="token number">68</span> <span class="token number">6</span>C <span class="token number">82</span> <span class="token number">40</span> <span class="token number">00</span>    push    offset aInHandler0    <span class="token punctuation">;</span> <span class="token string">"In Handler0.\n"</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0040129</span>B E8 <span class="token number">66</span> <span class="token number">03</span> <span class="token number">00</span> <span class="token number">00</span>    call    sub_401606
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">004012</span>A0 <span class="token number">83</span> C4 <span class="token number">04</span>          add     esp<span class="token punctuation">,</span> <span class="token number">4</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">004012</span>A0                   <span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span> <span class="token comment">// starts at 401277</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">004012</span>A3
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">004012</span>A3                   loc_4012A3<span class="token operator">:</span>                   <span class="token punctuation">;</span> CODE XREF<span class="token operator">:</span> sub_401200<span class="token operator">+</span><span class="token number">55</span>↑j
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">004012</span>A3                                                 <span class="token punctuation">;</span> sub_401200<span class="token operator">+</span><span class="token number">7</span>E↑j
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">004012</span>A3 C7 <span class="token number">45</span> FC FF FF FF<span class="token operator">+</span>mov     <span class="token punctuation">[</span>ebp<span class="token operator">+</span>ms_exc<span class="token punctuation">.</span>registration<span class="token punctuation">.</span>TryLevel<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0FFFF</span>FFFFh
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">004012</span>AA <span class="token number">68</span> <span class="token number">58</span> <span class="token number">82</span> <span class="token number">40</span> <span class="token number">00</span>    push    offset aAfterAllTrys  <span class="token punctuation">;</span> <span class="token string">"After All Trys.\n"</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">004012</span>AF E8 <span class="token number">52</span> <span class="token number">03</span> <span class="token number">00</span> <span class="token number">00</span>    call    sub_401606
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">004012</span>B4 <span class="token number">83</span> C4 <span class="token number">04</span>          add     esp<span class="token punctuation">,</span> <span class="token number">4</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">004012</span>B7 <span class="token number">8</span>B <span class="token number">4</span>D F0          mov     ecx<span class="token punctuation">,</span> <span class="token punctuation">[</span>ebp<span class="token operator">+</span>ms_exc<span class="token punctuation">.</span>registration<span class="token punctuation">.</span>Next<span class="token punctuation">]</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">004012</span>BA <span class="token number">64</span> <span class="token number">89</span> <span class="token number">0</span>D <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span><span class="token operator">+</span>mov     large fs<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span> ecx
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">004012</span>C1 <span class="token number">5F</span>                pop     edi
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">004012</span>C2 <span class="token number">5</span>E                pop     esi
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">004012</span>C3 <span class="token number">5</span>B                pop     ebx
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">004012</span>C4 <span class="token number">8</span>B E5             mov     esp<span class="token punctuation">,</span> ebp
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">004012</span>C6 <span class="token number">5</span>D                pop     ebp
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">004012</span>C7 C3                retn
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">004012</span>C7                   <span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token comment">// starts at 401200</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">004012</span>C7                   sub_401200 endp

反编译得到的代码<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>要注意，<strong>最外层的异常筛选器以及处理函数</strong>从属的代码段</p>
<img src="/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201103132200583-687171570.png" class="" alt="img" loading="lazy">
<p>他们分别覆盖了__except 代码段和编译器自己加的代码，对 TryLevel 进行赋值时也会检测其是否产生异常</p>
<img src="/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201103132334849-571852046.png" class="" alt="img" loading="lazy">
<p>而<strong>内层的异常筛选器以及处理函数</strong>：</p>
<img src="/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201103133459031-730947958.png" class="" alt="img" loading="lazy">
<p>只包含了 __except 代码段：</p>
<img src="/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201103133001234-867631965.png" class="" alt="img" loading="lazy">
<h3 id="__except_handler3-函数流程解析"><a class="markdownIt-Anchor" href="#__except_handler3-函数流程解析"></a> <strong>__except_handler3 函数流程解析</strong></h3>
<p>__except_handler3函数主要按以下流程工作。</p>
<p>① 在栈上生成一个EXCEPTION_POINTES结构，并将其保存到 [ebp-10] 处。<br />
② 获取当前的 TryLevel，判断其值是否等于 -1。若等于，则表示当前不在 Try 块中（嵌套的里面也没有能处理的），返回 ExceptionContinueSearch，继续寻找其他异常处理程序。<br />
③ 若 TryLevel 的值不等于-1，并根据 TryLevel 在 ScopeTable 中找到相应的 SCOPTETABLE_ENTRY,判断 FilterFunc 是否为“NULL”。<strong>若为“NULL”,说明是 __try / __finally组合。因为该组合不直接处理异常，所以也返回 ExceptionContinueSearch</strong>。<br />
④ 若FilterFunc 不为“NULL”，说明是 __try / __except 组合，那么执行 FilterFunc，然后判断其返回值(也就是前面讲到的3种返回值)，根据返回值的不同执行不同的动作。EXCEPTION_CONTINUE_SEARCH 和 EXCEPTION_CONTINUE_EXECUTION 的意义比较明确，就不多介绍了。若返回值是 EXCEPTION_EXECUTE_HANDLER,就是去执行 HandlerFunc,执行完毕会跳转到当前 Try 块的结束位置，同时表示本次异常处理结束，此时 <strong>_except_handler3 将不返回</strong>。<br />
⑤ 如果异常没有被处理，最后会由系统默认的异常处理函数进行处理，它在<strong>展开时会调用 finally 块的代码</strong>。</p>
<p>因为几乎所有由 MSC 编译生成的 sys、dll 、exe文件都需要使用 _except_handler3 异常处理函数,并且都需要进行 SEH 的安装和卸载，所以编译器把这部分代码提取出来，形成了两个独立的函数,分别叫作 _SEH_prolog 和 _SEH_epilog。它们的主要作用就是把 _except_handler3 安装为 SEH 处理函数及卸载，这也是在反汇编那些使用了 SEH 的系统 API 时总会看到如下代码的原因。</p>
<img src="/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201103144843386-1287950374.png" class="" alt="img" loading="lazy">
<img src="/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201103144916327-706602587.png" class="" alt="img" loading="lazy">
<p>更新一点版本的编译器增加了 SecurityCookie ，防止缓冲区溢出而设置的栈验证机制（即GS 保护机制），在函数开头会对栈中的 ScopeTable 使用 Cookie 进行加密，异常函数也变成了 _except_handler4。</p>
<p>C++ 的异常处理</p>
<img src="/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201103192755633-206883248.png" class="" alt="img" loading="lazy">
<p>多个 Catch 用于捕获多个异常</p>
<img src="/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201103193234467-1705026147.png" class="" alt="img" loading="lazy">
<p>上面代码中的 stru_40DE48 实际指向了一个非常复杂的结构，它主要包含各个 try 块、 catch 块的位置信息、异常类型信息等,而 <strong>_CxxFrameHandler</strong> 的工作与 _except_handler3有很多相似之处,也需要定位发生异常的 <strong>try</strong> 块、匹配异常类型并执行相应的 <strong>catch</strong> 块。C++ 涉及各种对象的操作，复杂度比 C 要高很多。</p>
<h3 id="顶层异常处理"><a class="markdownIt-Anchor" href="#顶层异常处理"></a> 顶层异常处理</h3>
<p><strong>顶层(Top-level）异常处理</strong>是系统设置的一个默认异常处理程序，<strong>所有</strong>在线程中发生的异常，<strong>只要没有被线程异常处理过程或调试器处理</strong>，<strong>最终均交由顶层异常回调函数处理</strong>。</p>
<p><strong>Win XP</strong> <strong>系统</strong>中：</p>
<p>进程的实际启动位置是 <strong>kemel32!BaseProcessStartTunk</strong> ,然后才跳转到 <strong>kernel32!BaseProcessStart</strong> ，它的反汇编结果如下。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">70817054</span> <span class="token punctuation">;</span> <span class="token keyword">int</span> __stdcall <span class="token function">BaseProcessstart</span> <span class="token punctuation">(</span>PVOID ThreadStartAddress<span class="token punctuation">)</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">7</span>C817054  uExitCode    dword ptr <span class="token operator">-</span><span class="token number">1</span>Ch
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">7</span>C817054  ms_exc <span class="token operator">=</span> CPPEH_RECORD ptr <span class="token operator">-</span><span class="token number">18</span>h
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">7</span>C817054  ThreadStartAddress <span class="token operator">=</span> dword ptr <span class="token number">8</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">7</span>C817054                    push    　　<span class="token number">0</span>ch
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">7</span>C817056                    push 　　　　offset stru_7C817080
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">7</span>C81705B                    call__SEH_prolog
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">7</span>C817060                    <span class="token operator">and</span> 　　 　　<span class="token punctuation">[</span>ebp<span class="token operator">+</span> ms_exc<span class="token punctuation">.</span>registration<span class="token punctuation">.</span>TryLevel<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">7</span>C817064                    push   　　  <span class="token number">4</span>　　　<span class="token punctuation">;</span> ThreadInformationLength
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">7</span>C817066                    lea  　　 　 eax<span class="token punctuation">,</span> <span class="token punctuation">[</span>ebp<span class="token operator">+</span> ThreadstartAddress<span class="token punctuation">]</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">7</span>C817069                    push     　　eax　　<span class="token punctuation">;</span> ThreadInformation
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">7</span>C81706A                    push     　　<span class="token number">9</span>　　　<span class="token punctuation">;</span> ThreadInformationclass
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">7</span>C81706C　　　　　　　　　　　　push　　 　　 <span class="token number">0FFFF</span>FFEEh　　<span class="token punctuation">;</span> ThreadHandle
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">7</span>C81706E　　　　　　　　　　　　call　　  　　ds<span class="token operator">:</span> <span class="token function">NtSetInformationThread</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> x<span class="token punctuation">,</span> x<span class="token punctuation">,</span> x<span class="token punctuation">)</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">7</span>C817074　　　　　　　　　　　　call     　　<span class="token punctuation">[</span>ebp<span class="token operator">+</span>ThreadStartAddress<span class="token punctuation">]</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">7</span>C817077　　　　　　　　　　　　push　　　　　eax　　　　<span class="token punctuation">;</span> dwExitcode
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">7</span>C817078　　　　　　　　　　　　call　　　　　<span class="token function">ExitThread</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">7</span>C817078　　　　　　　　　　　　__stdcall 　 <span class="token function">BaseProcessStart</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> endp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<img src="/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201106184837825-922006010.png" class="" alt="img" loading="lazy">
<p>在使用 <strong>CreatThread</strong> 函数创建线程时，线程运行的起点是 <strong>kernel!BaseStartThunk</strong> ，而后跳转到 <strong>kernel32!BaseThreadStart</strong>，并由该函数执行 <strong>ThreadProc</strong> 。<strong>BaseThreadStart</strong> 也包含上述的异常处理代码，并且二者的 <strong>FilterFunc</strong> 都是 <strong>kernel!UnhandledExceptionFilter</strong> 。操作系统在执行任意一个用户线程(不管是不是主线程)之前，都已经为它安装了一个默认的 SEH 处理程序，这是该线程的第1个 SEH 处理程序，即<strong>顶层异常处理程序</strong>。</p>
<p><strong>(1）对预定错误的预处理</strong></p>
<p>①检测当前异常中是否是嵌套了异常，即<strong>异常处理的过程中是否又产生了异常</strong>。由于在这种情况下已经很难恢复现场和执行后续的异常处理过程了，UEF 函数会直接调用 <strong>NtTerminateProcess</strong> 结束当前进程。这大概解释了为什么明明设置了错误报告但是某些程序在出错退出时却依然悄无声息这个问题。</p>
<p>② 检测异常代码是不是 <strong>EXCEPTION_ACCESS_VIOLATION</strong> (0xc0000005)，以及引起异常的操作是不是写操作。如果是，会进一步检测要写入的内存位置是否在资源段中，然后通过改变页属性来尝试修复该错误。<br />
③ 检测当前进程是否正在被调试，这是通过查询当前进程的 <strong>DebugPort</strong> 实现的。如果进程正在被调试，那么 UEF 函数会打印一些调试信息并返回 <strong>EXCEPTION_CONTINUE_ SEARCH</strong>,也就是不进行后续的终结处理。由于这已经是最后一个异常处理程序了,该返回值会导致<strong>异常进行第2次分发</strong>。如果想调试后面的代码，在这里必须通过调试器干预 UEF 的查询结果，使它认为调试器不存在。例如，使 <strong>NtQueryInformationProcess</strong> 函数返回失败,或者使查询到的 <strong>ProcessDebugPort</strong> 值为0。</p>
<p><strong>(2）调用用户设置的回调函数</strong></p>
<p>为了在 UEF 阶段给用户一个干预的机会、微软提供了一个API函数 <strong>SetUnhandledExceptionFilter</strong> 。用户设置一个顶层异常过滤回调函数，在 <strong>kernel32!UnhandledExceptionFilter</strong> 中会调用它并根据它的返回值进行相应的操作，平时所说的“顶层异常回调函数”指的就是这个回调函数，而不是 UEF 函数。该API原型及参数类型定义如下。</p>
<img src="/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201108142253285-970722145.png" class="" alt="img" loading="lazy">
<p>API 函数 <strong>kernel32!SetUnhandledExceptionFilter</strong> 实际上把用户设置的回调函数地址加密并保存在一个全局变量 <strong>kernel32!BasepCurrentTopLevelFilter</strong> 中，因此：<br />
① 不管调用这个 API 多少次，只有最后一次设置的结果才是有效的，所以在同一时刻每个进程只可能有一个有效的顶层回调函数。有些程序为了保证自己设置的异常处理过滤函数不会被其他模块覆盖，会在调用该函数后对其入口进行Patch，使它不再执行实际功能，这样就保证了不会有其他模块能够修改这个回调函数。</p>
<p>② 因为系统在创建用户线程时总会安装顶层异常处理过程，并把 UEF 函数作为异常过滤函数，所以该全局变量不仅对所有已经创建了的线程有效，对那些尚未“出生”的线程同样有效。这就为什么顶层异常处理是基于 SEH 和线程的，而它的有效范围却是整个进程。</p>
<p>UEF 函数会判断用户有没有设置回调函数，如果设置了就会进行调用。由于实际的异常过滤函数是 UEF 函数,用户设置的回调函数只是它的一个<strong>子函数调用</strong>,回调函数的返回值只在某些情况下等于UEF 函数的返回值。异常过滤函数有3种有效的返回值。</p>
<img src="/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201108200945501-250148316.png" class="" alt="img" loading="lazy">
<p><strong>• EXCEPTION_EXECUTE_HANDLER</strong>：表示异常已经被顶层异常处理过程处理了，这会使异常处理程序执行 HandlerFunc，也就是<strong>退出当前线程（服务程序）或进程（非服务进程)</strong>，操作系统不会出现非法操作框。如果在回调函数中已经做了必要的收尾工作，可利用返回该值来优雅地结束程序。<br />
<strong>•</strong> <strong>EXCEPTION_CONTINUE_EXECUTION</strong>：表示顶层异常处理过程处理了异常，程序应该从原异常发生的指令处继续执行（Contex 结构体）。如果回调函数要这么做，那么在返回之前应该做出必要的修复异常现场的动作，这一点与普通的SEH处理程序是一样的。</p>
<img src="/2024/07/17/%E5%88%9D%E8%AF%86SEH/2052083-20201108201314930-684464001.png" class="" alt="img" loading="lazy">
<p><strong>•</strong> <strong>EXCEPTION_CONTINUE_SEARCH</strong>：表示顶层异常处理过程不能处理异常,需要将异常交给其他异常处理过程继续处理，这一般会导致调用操作系统默认的异常处理过程，也就是第3阶段的终结处理过程。</p>
<p><strong>(3）终结处理如何进行严重依赖用户的设置</strong></p>
<p>① 检查应用程序是否使用 API <strong>SetErrorMode()</strong> 设置了 <strong>SEM_NOGPFAULTERRORBOX</strong> 标志。如果设置了，就<strong>不会出现任何错误提示</strong>，直接返回 <strong>EXCEPTION_EXECUTE_HANDLER</strong> 以结束进程。</p>
<p>② 判断当前进程是否在 <strong>Job</strong> 中。如果在且设置了有未处理异常时结束，将直接结束进程</p>
<p>③ 读取用户关于<strong>JIT调试器</strong>(<strong>Just-In-Time</strong>,<strong>即时调试器</strong>)的设置,它保存在注册表中。设置相对应的值可以带命令行参数的将调试器附加到出错的进程上</p>
<p>④ 如果经过查询不需要，会加载 faultrep.dll，以异常信息为参数调用 ReportFault 函数，根据组策略的设置的不同，弹出不同类型的提示窗口。如果根据设置，不需要启动错误报告程序，ReportFault 会直接返回。这时,会调用系统服务 <strong>NtRaiseHardError</strong>，由子系统进程 <strong>csrss.exe</strong> 进行相关操作</p>
<h3 id="顶层异常处理的典型应用模式"><a class="markdownIt-Anchor" href="#顶层异常处理的典型应用模式"></a> 顶层异常处理的典型应用模式</h3>
<p>在程序设计中，开发人员普遍使用 SEH 机制来捕获可能产生的异常。但 SEH 不是万能的，总会有一些无法预料的情况发生，却不能被 SEH 处理。所以，一般的使用模式是:使用 SEH 捕获异常，并对那些预料之中的异常进行处理，其他无法处理的异常都会到达 UEF 函数处,由用户设置的回调函数进行收尾处理。</p>
<p>于是可以把异常现场的所有信息保存下来，形成一个快照文件，作为分析异常的依据（Dump文件)。用户可以手动把这个文件发送给开发人员,或者将文件自动上传到专门用于收集 Dump 的服务器中（通常还会生成一个文本类的文件用于保存本次异常的一些概要信息和那些无法保存到 Dump 文件中的信息)。“拍照”时的参数不同,生成的 Dump 文件所包含信息的丰富。</p>
<p>下面是一段典型 的在UEF回调中生成<code>Dump</code>文件的代码</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// WriteDump.cpp : Defines the entry point for the console application.</span>
<span class="token comment">// Author:achillis</span>
<span class="token comment">// 本程序用于演示顶层异常处理的使用及生成Dump技术</span>
<span class="token comment">//</span>
<span class="token comment">/*-----------------------------------------------------------------------
第8章  Windows下的异常处理
《加密与解密（第四版）》
(c)  看雪学院 www.kanxue.com 2000-2018
-----------------------------------------------------------------------*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdafx.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;WINDOWS.H></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;DbgHelp.h></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">comment</span><span class="token punctuation">(</span>lib<span class="token punctuation">,</span></span><span class="token string">"Dbghelp.lib"</span><span class="token expression"><span class="token punctuation">)</span></span></span>

LONG WINAPI <span class="token function">TopLevelExceptionFilter</span><span class="token punctuation">(</span>
    <span class="token keyword">struct</span> <span class="token class-name">_EXCEPTION_POINTERS</span><span class="token operator">*</span> ExceptionInfo
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">//安装顶层异常处理回调</span>
    <span class="token function">SetUnhandledExceptionFilter</span><span class="token punctuation">(</span>TopLevelExceptionFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token operator">*</span>pValue <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>pValue <span class="token operator">=</span> <span class="token number">5</span> <span class="token punctuation">;</span> <span class="token comment">//引发内存访问异常</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

LONG WINAPI <span class="token function">TopLevelExceptionFilter</span><span class="token punctuation">(</span>
    <span class="token keyword">struct</span> <span class="token class-name">_EXCEPTION_POINTERS</span><span class="token operator">*</span> ExceptionInfo
    <span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Exception Catched, Code = 0x%08X EIP = 0x%p\n"</span><span class="token punctuation">,</span>
        ExceptionInfo<span class="token operator">-></span>ExceptionRecord<span class="token operator">-></span>ExceptionCode<span class="token punctuation">,</span>
        ExceptionInfo<span class="token operator">-></span>ExceptionRecord<span class="token operator">-></span>ExceptionAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">".exr = 0x%p\n"</span><span class="token punctuation">,</span>ExceptionInfo<span class="token operator">-></span>ExceptionRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">".cxr = 0x%p\n"</span><span class="token punctuation">,</span>ExceptionInfo<span class="token operator">-></span>ContextRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>

    HANDLE hDumpFile <span class="token operator">=</span> <span class="token function">CreateFile</span><span class="token punctuation">(</span><span class="token string">"Dump.dmp"</span><span class="token punctuation">,</span>
        GENERIC_WRITE<span class="token punctuation">,</span>
        FILE_SHARE_READ<span class="token punctuation">,</span>
        <span class="token constant">NULL</span><span class="token punctuation">,</span>
        CREATE_ALWAYS<span class="token punctuation">,</span>
        FILE_ATTRIBUTE_NORMAL<span class="token punctuation">,</span>
        <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hDumpFile <span class="token operator">==</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> EXCEPTION_CONTINUE_SEARCH<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    MINIDUMP_EXCEPTION_INFORMATION MinidumpExpInfo<span class="token punctuation">;</span>
    <span class="token function">ZeroMemory</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>MinidumpExpInfo<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>MINIDUMP_EXCEPTION_INFORMATION<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    MinidumpExpInfo<span class="token punctuation">.</span>ThreadId <span class="token operator">=</span> <span class="token function">GetCurrentThreadId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    MinidumpExpInfo<span class="token punctuation">.</span>ExceptionPointers <span class="token operator">=</span> ExceptionInfo<span class="token punctuation">;</span>
    MinidumpExpInfo<span class="token punctuation">.</span>ClientPointers <span class="token operator">=</span> TRUE <span class="token punctuation">;</span>

    BOOL bResult <span class="token operator">=</span> <span class="token function">MiniDumpWriteDump</span><span class="token punctuation">(</span><span class="token function">GetCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">GetCurrentProcessId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        hDumpFile<span class="token punctuation">,</span>
        MiniDumpWithProcessThreadData<span class="token punctuation">,</span>
        <span class="token operator">&amp;</span>MinidumpExpInfo<span class="token punctuation">,</span>
        <span class="token constant">NULL</span><span class="token punctuation">,</span>
        <span class="token constant">NULL</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Write Dump File %s .\n"</span><span class="token punctuation">,</span>bResult <span class="token operator">?</span> <span class="token string">"Success"</span><span class="token operator">:</span><span class="token string">"Failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CloseHandle</span><span class="token punctuation">(</span>hDumpFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//Dump文件生成完毕，可以结束进程了</span>
    <span class="token keyword">return</span> EXCEPTION_EXECUTE_HANDLER<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="异常处理程序的安全性"><a class="markdownIt-Anchor" href="#异常处理程序的安全性"></a> 异常处理程序的安全性</h3>
<p>SEH的结构是存储在栈中</p>
<p>由于栈中数据的安全性有时无法得到保证，如溢出攻击时，栈中的SEHandler可能被覆盖为非法过程，从而执行攻击者预设的功能代码，为了防止此类的攻击，微软提供了<code>SafeSEH</code>机制和<code>SEHOP</code>机制，防止非法的<code>SEHandler</code>程序执行</p>
<h4 id="safeseh机制"><a class="markdownIt-Anchor" href="#safeseh机制"></a> SafeSEH机制</h4>
<p>这是从<code>WindowsXP SP2</code>开始引入的一种安全机制，由操作系统和编译器联合提供，即由编译器提供SEH基础数据，由操作系统在产生异常时进行验证</p>
<ul>
<li>
<p>编译器的工作</p>
<p>从VisualStudio 开始，在编译PE文件时加入了一个<code>SafeSEH</code>开关。如果编译时打开了这个开关，就会在PE偷的<code>DLLCharacteristics</code>加入一个标志</p>
<p>并在编译阶段提取所有异常处理程序的RVA，将它放入一个表。这个表的位置是由PE头部的`IMAGE_OPTIONAL_HEADER结构中数据目录的第10项决定的</p>
<p><code>SEHandlerTable</code>是指向一个SEH处理函数的RVA的表格，<code>SEHandlercount</code>是这个表格的项数，指出了有几个有效的SEHandler</p>
<p>当PE被载入，PE的基址，大小,SEHandlerTable(表格的地址),SEHandlerCount（长度)会保存在<code>ntdll.dll</code>的一个表格中。当异常发生时，系统会根据每个PE的机制和大小检查当前的<code>SEHandler</code>处理函数属于哪一个PE模块，然后取出相应的表格地址和长度。在载入时就已经取出，载入后<code>SEHandlerTable</code>和<code>SEHandlerCount</code>就没有用处了，所以对它进行修改不会影响系统对<code>SEHandler</code>的验证结果</p>
</li>
<li>
<p>操作系统的验证</p>
<p>我们在分析应用层异常分发的主要流程。系统对栈以及栈中的<code>EXCEPTION_REGISTRATION_RECORD</code>结构进行初步验证后，会调用<code>RtlIsValidHandler</code>对异常回调函数的有效性进行验证</p>
<p>伪代码如下</p>
<img src="/2024/07/17/%E5%88%9D%E8%AF%86SEH/image-20240722140843472.png" class="" alt="image-20240722140843472" loading="lazy">
<p>伪代码里面的<code>ExecuteDispatchEnable</code>和<code>ImageDispatchEnable</code>位标志是内核<code>KPROCESS</code>结构的一部分，用于控制当异常处理函数在不可执行内存或者不在异常模块的IMAGE内是否执行异常处理函数。这两个位的值可以在运行时修改。不过，在默认情况下，如果进程的DEP(data Execution Prevention数据执行保护)处于关闭状态，则这两个位置1，如果进程的DEP处于开启状态，则这两个位置0</p>
<p>在进程的DEP开启的情况下，如下两种异常处理函数被异常分发器认为是有效的</p>
<ul>
<li>异常处理函数在进程Image的<code>SafeSEH</code>表中，没有<code>NO_SEH</code>标志</li>
<li>异常处理函数在进程映像的可执行页中，没有<code>NO_SEH</code>标志，没有<code>SafeSEH</code>表，也没有<code>.NET</code>的<code>ILonly</code>标志</li>
</ul>
<p>在进程DEP关闭的情况下，如下3中异常处理函数被异常分发器认为是有效的</p>
<ul>
<li>异常处理函数在进程Image的<code>SafeSEH</code>表中，没有<code>NO_SEH</code>标志</li>
<li>异常处理函数在进程Image的可执行页中，没有<code>NO_SEH</code>标志，没有<code>SafeSEH</code>表，也没有<code>.NET</code>的<code>ILonly</code>标志</li>
<li>异常处理函数不在当前进程的映像里，也不在当前线程的栈上</li>
</ul>
</li>
<li>
<p>如果SEHandler处于动态申请的内存中，因为它不处于任何一个PE Image内，所以SEH是没有任何限制的；否则，不在相应的表格中，会导致SEH部分的异常处理终端，跳过后面所有的SEH节点遍历。</p>
</li>
<li>
<p>在<code>visualC++</code>中使用的<code>try</code>和<code>except</code>和<code>finally</code>以及C++的<code>try</code>,<code>catch</code>以及<code>finally</code>等SEH处理函数，都会被编译器自动放入该表格</p>
</li>
<li>
<p>但如果使用<code>inline asm</code>对<code>fs:[0]</code>进行操作设置的SEH就是无效的</p>
</li>
</ul>
<h4 id="sehop机制"><a class="markdownIt-Anchor" href="#sehop机制"></a> SEHOP机制</h4>
<p>SEHOP是微软为了进一步增强SEH处理程序的安全性从2009年开始在<code>Windows Server 2008 SP0</code> ,<code>Windows Vista SP1 </code>和<code>Windows 7</code>以及后续版本中加入的一种保护机制，全称是</p>
<p><code>Structured Exception Handling Overwrite Protection</code></p>
<p>SEH覆写保护机制，即可作为SEH的拓展，用于检测SEH是否被覆写</p>
<h5 id="初识sehop"><a class="markdownIt-Anchor" href="#初识sehop"></a> 初识SEHOP</h5>
<p>SEHOP的核心检测主要包括如下两点</p>
<ul>
<li>检测SEH链的完整性，即每一个节点都必须在栈中并且都可以正常访问</li>
<li>检测最后一个节点的异常处理函数是不是位于<code>ntdll</code>汇总的<code>ntdll!FinalExceptionHandler()</code></li>
</ul>
<p>一般使用SEH攻击执行Shellcode时，通常是用<code>jmp 06 pop pop ret</code>等命令来覆盖SEH结构，此时从当前SEH节点已经无法正确指向下一个SEH节点，更不用说到达最后那个特殊的SEH节点。</p>
<p>因此通过SEHOP的检测就可以判断SEH结构链表的完整性是否遭到破坏，</p>
<p>从而阻止Shellcode的执行</p>
<p>SEHOP默认在Server中是开启的，而在Win7是默认关闭的</p>
<h4 id="sehop与顶层异常处理"><a class="markdownIt-Anchor" href="#sehop与顶层异常处理"></a> SEHOP与顶层异常处理</h4>
<p>开启SEHOP保护后，在SEH链的最后增加了一个节点</p>
<p>此时倒数第二个节点才是前面介绍的线程顶层异常处理函数所在的节点</p>
<p>似乎与顶层异常处理机制矛盾</p>
<p>其实不然</p>
<p>当系统沿SEH链查找异常处理程序时，在倒数第2个节点会执行<code>kernel32!UnhandledExceptionHandler</code>函数进行终结处理，此时最后一个节点的异常处理函数根本不会发挥作用</p>
<p>最后一个节点实际上只在对SEHandler进行验证时起到辅助作用</p>
<p>即使基于某些原因或者在某些特殊的线程中，执行到最后一个节点的异常处理函数</p>
<p><code>ntdll!FinalExceptionHandler</code>，该函数内部依然会调用<code>kernel32.dll</code>中的<code>UEF</code>函数或<code>ntdll.dll</code>自己的<code>UEF</code>函数，</p>
<p>所以这与顶层异常处理的过程并不矛盾</p>
<p>SEHOP的保护是系统层的，很难绕过，而且不用修改原有的应用程序，而且对性能的影响很小</p>
<p>常见的绕过思路是，攻击者能够实现操纵栈中的数据，同时可以伪造节点以保证整个SEH链有效，保证最终到达Safe节点</p>
</div></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2024/07/18/%E5%88%9D%E8%AF%86IA-32/" rel="prev" title="初识IA-32指令解析"><span class="icon iconify" data-icon="ri:arrow-left-s-line"></span><span class="post-nav-text">初识IA-32指令解析</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2024/07/16/%E5%88%9D%E8%AF%86DLL%E6%B3%A8%E5%85%A5/" rel="next" title="初识DLL注入"><span class="post-nav-text">初识DLL注入</span><span class="icon iconify" data-icon="ri:arrow-right-s-line"></span></a></div></div></div><div class="hty-card" id="comment"><div class="comment-tooltip text-center"><span>您需要科学上网，才可使用评论区功能。</span><br></div><div id="waline"></div><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@waline/client@v2/dist/waline.css"><script>window.CONFIG.waline.config.path = "/2024/07/17/%E5%88%9D%E8%AF%86SEH/"</script><div class="js-Pjax"><script src="/js/comments/waline.js" type="module" defer></script></div></div></main><footer class="sidebar-translate" id="footer"><div class="beian"><a rel="noopener" href="https://beian.miit.gov.cn/" target="_blank"></a></div><div class="copyright"><span>&copy; 2023 – 2025 </span><span class="with-love" id="animate"><span class="icon iconify" data-icon="ri:cloud-line"></span></span><span class="author"> Npc</span></div><div class="footer-custom-text">=w=</div></footer></div><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><span class="icon iconify" data-icon="ri:arrow-up-s-line"></span><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="Search"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:search-line"></span></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script src="https://fastly.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js"></script><script src="/js/search/local-search.js" defer type="module"></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><span class="icon iconify" data-icon="ri:close-line"></span></span></div><div class="search-input-container"><input class="search-input" id="local-search-input" type="text" placeholder="Searching..." value=""></div><div class="search-result-container"></div></div><script src="https://fastly.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js"></script><script>const images = [...document.querySelectorAll('.markdown-body img')]
mediumZoom(images)</script><style>.medium-zoom-image {
  z-index: 99;
}</style></body></html>