<!DOCTYPE html><html lang="[&quot;en&quot;,&quot;zh-CN&quot;,&quot;default&quot;]"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="Npc"><meta name="copyright" content="Npc"><meta name="generator" content="Hexo 7.1.1"><meta name="theme" content="hexo-theme-yun"><title>vmp相关3:vmp原理初探 | Npc | Blog</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/star-markdown-css@0.4.1/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/my_blog_prism@1.0.5/prism.css"><script src="https://cdn.jsdelivr.net/npm/my_blog_prism@1.0.5/prism.js"></script><script src="https://fastly.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".markdown-body img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link rel="icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="preconnect" href="https://fastly.jsdelivr.net/npm/" crossorigin><script id="yun-config">
    window.Yun = {}
    window.CONFIG = {"hostname":"npc0vo.github.io","root":"/","title":"Npc小站","version":"1.10.11","mode":"light","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}.","hits":"${hits} results found","hits_time":"${hits} results found in ${time} ms"},"anonymous_image":"https://cdn.yunyoujun.cn/img/avatar/none.jpg","say":{"api":"https://el-bot-api.vercel.app/api/words/young"},"local_search":{"path":"/search.xml"},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"fireworks":{"colors":null},"waline":{"config":{"enable":true,"serverURL":"https://waline-onelastchicks-projects.vercel.app/","comment":false,"el":"#waline","lang":["en","zh-CN","default"]},"cdn":"https://fastly.jsdelivr.net/npm/@waline/client@v2/dist/waline.js","dark":"html.dark"},"vendors":{"host":"https://fastly.jsdelivr.net/npm/","darken":"https://fastly.jsdelivr.net/npm/darken@1.5.0"}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/hexo-theme-yun.js" type="module"></script><script src="//at.alicdn.com/t/font_1140697_dxory92pb0h.js" async></script><link rel="preconnect" href="https://www.google-analytics.com" crossorigin><script async src="https://www.googletagmanager.com/gtag/js?id=G-1LL0D86CY9"></script><script>if (CONFIG.hostname === location.hostname) {
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-1LL0D86CY9');
}</script><script data-ad-client="ca-pub-2245427233262012" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(function(){
  var bp = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https') {
    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else {
    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})();</script><!-- Google Tag Manager --><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-M9KWR9L');</script><!-- End Google Tag Manager --><meta name="description" content="记录阅读vmp分析博客中过程中vmp涉及到的大部分原理   VMP简单介绍 虚拟机保护特征  将由编译器生成的本机代码(Native Code)转换成字节码(Bytecode) 将控制权交由虚拟机，由虚拟机来控制执行 转换后的字节码非常难以阅读，增加了破解的复杂性  虚拟机其实就是一个字节码解释器，它循环的读取指令并执行，并且它 只有一个入口和一个出口(vm_exit)。大量的fake jcc（">
<meta property="og:type" content="article">
<meta property="og:title" content="vmp相关3:vmp原理初探">
<meta property="og:url" content="http://npc0vo.github.io/2025/02/19/vmp%E7%9B%B8%E5%85%B33_vmp%E5%8E%9F%E7%90%86%E5%88%9D%E6%8E%A2/index.html">
<meta property="og:site_name" content="Npc | Blog">
<meta property="og:description" content="记录阅读vmp分析博客中过程中vmp涉及到的大部分原理   VMP简单介绍 虚拟机保护特征  将由编译器生成的本机代码(Native Code)转换成字节码(Bytecode) 将控制权交由虚拟机，由虚拟机来控制执行 转换后的字节码非常难以阅读，增加了破解的复杂性  虚拟机其实就是一个字节码解释器，它循环的读取指令并执行，并且它 只有一个入口和一个出口(vm_exit)。大量的fake jcc（">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://npc0vo.github.io/2025/02/19/vmp%E7%9B%B8%E5%85%B33_vmp%E5%8E%9F%E7%90%86%E5%88%9D%E6%8E%A2/1740916463674-408a56d4-383a-42ed-b3e4-83b48505441f.png">
<meta property="og:image" content="http://npc0vo.github.io/2025/02/19/vmp%E7%9B%B8%E5%85%B33_vmp%E5%8E%9F%E7%90%86%E5%88%9D%E6%8E%A2/1740916506340-f5715bab-5309-4fdb-9c59-57b0a75ee4b1.png">
<meta property="og:image" content="http://npc0vo.github.io/2025/02/19/vmp%E7%9B%B8%E5%85%B33_vmp%E5%8E%9F%E7%90%86%E5%88%9D%E6%8E%A2/1741074631778-6cf296f8-bbe3-41ff-9028-37e219e8d1f0.png">
<meta property="og:image" content="http://npc0vo.github.io/2025/02/19/vmp%E7%9B%B8%E5%85%B33_vmp%E5%8E%9F%E7%90%86%E5%88%9D%E6%8E%A2/1741255396781-b7d17276-652a-4546-bf5e-0c26c07f9cc2.png">
<meta property="og:image" content="http://npc0vo.github.io/2025/02/19/vmp%E7%9B%B8%E5%85%B33_vmp%E5%8E%9F%E7%90%86%E5%88%9D%E6%8E%A2/1741255429584-1fb51fdd-0f4b-4f06-b734-61d9ab01d34e.png">
<meta property="og:image" content="http://npc0vo.github.io/2025/02/19/vmp%E7%9B%B8%E5%85%B33_vmp%E5%8E%9F%E7%90%86%E5%88%9D%E6%8E%A2/1741255482748-7a6ab801-ee03-431f-875e-8ad93b087221.png">
<meta property="og:image" content="http://npc0vo.github.io/2025/02/19/vmp%E7%9B%B8%E5%85%B33_vmp%E5%8E%9F%E7%90%86%E5%88%9D%E6%8E%A2/1740918273673-a29374e2-5aa0-45fa-a6ab-253788993de4.png">
<meta property="og:image" content="http://npc0vo.github.io/2025/02/19/vmp%E7%9B%B8%E5%85%B33_vmp%E5%8E%9F%E7%90%86%E5%88%9D%E6%8E%A2/1740918290468-07f7f9fc-ce60-4c02-af54-d9c2e32a86f8.png">
<meta property="article:published_time" content="2025-02-19T04:52:15.000Z">
<meta property="article:modified_time" content="2025-03-20T05:03:44.902Z">
<meta property="article:author" content="Npc">
<meta property="article:tag" content="Reverse">
<meta property="article:tag" content="vmp">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://npc0vo.github.io/2025/02/19/vmp%E7%9B%B8%E5%85%B33_vmp%E5%8E%9F%E7%90%86%E5%88%9D%E6%8E%A2/1740916463674-408a56d4-383a-42ed-b3e4-83b48505441f.png"><script>(function() {
  if (CONFIG.mode !== 'auto') return
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script></head><body><script src="https://code.iconify.design/2/2.1.1/iconify.min.js"></script><script>// Define global variable
IconifyProviders = {
  // Empty prefix: overwrite default API provider configuration
  '': {
    // Use custom API first, use Iconify public API as backup
    resources: [
        'https://api.iconify.design',
    ],
    // Wait for 1 second before switching API hosts
    rotate: 1000,
  },
};</script><script defer src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js" type="module"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="Table of Contents"><span class="icon iconify" data-icon="ri:list-ordered"></span></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="Overview"><span class="icon iconify" data-icon="ri:passport-line"></span></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="Npc"><img width="96" loading="lazy" src="/images/avatar.jpg" alt="Npc"><span class="site-author-status">😭</span></a><div class="site-author-name"><a href="/about/">Npc</a></div><span class="site-name">Npc | Blog</span><sub class="site-subtitle">又活了一天</sub><div class="site-description"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="Home"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:home-4-line"></span></span></a><div class="site-state-item"><a href="/archives/" title="Archives"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:archive-line"></span></span><span class="site-state-item-count">81</span></a></div><div class="site-state-item"><a href="/categories/" title="Categories"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:folder-2-line"></span></span><span class="site-state-item-count">13</span></a></div><div class="site-state-item"><a href="/tags/" title="Tags"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="site-state-item-count">17</span></a></div><a class="site-state-item hty-icon-button" href="/about/#comment" title="留言板"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:clipboard-line"></span></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/npc0vo" title="GitHub" target="_blank" style="color:#6e5494"><span class="icon iconify" data-icon="ri:github-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:me@1930278836@qq.com" title="E-Mail" target="_blank" style="color:#8E71C1"><span class="icon iconify" data-icon="ri:mail-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.yuque.com/npc0vo" title="Yuque" target="_blank" style="color:#a0c69d"><span class="icon iconify" data-icon="ri:yuque-line"></span></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="我的小伙伴们" style="color:dodgerblue"><span class="icon iconify" data-icon="ri:genderless-line"></span></a></div></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#vmp%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text"> VMP简单介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E5%8C%96"><span class="toc-number">2.</span> <span class="toc-text"> 虚拟化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#vm%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84"><span class="toc-number">2.1.</span> <span class="toc-text"> vm基本结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#font-stylecolorrgb25-27-31dispatcherfont"><span class="toc-number">2.2.</span> <span class="toc-text"> dispatcher</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#handler"><span class="toc-number">2.3.</span> <span class="toc-text"> Handler</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A0%86%E6%A0%88%E6%93%8D%E4%BD%9C"><span class="toc-number">2.3.1.</span> <span class="toc-text"> 堆栈操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%97%E6%9C%AF%E8%BF%90%E7%AE%97%E5%92%8C%E7%A7%BB%E4%BD%8D%E8%BF%90%E7%AE%97"><span class="toc-number">2.3.2.</span> <span class="toc-text"> 算术运算和移位运算</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%BB%E8%BE%91%E8%BF%90%E7%AE%97%E6%8C%87%E4%BB%A4"><span class="toc-number">2.3.3.</span> <span class="toc-text"> 逻辑运算指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#jcc"><span class="toc-number">2.3.4.</span> <span class="toc-text"> jcc</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#font-stylecolorrgb68-68-68jge%E5%92%8Cjl%E6%8C%87%E4%BB%A4%E5%88%86%E6%9E%90font"><span class="toc-number">2.3.4.1.</span> <span class="toc-text"> Jge和Jl指令分析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#font-stylecolorrgb68-68-68jne%E5%92%8Cje%E6%8C%87%E4%BB%A4%E5%88%86%E6%9E%90font"><span class="toc-number">2.3.4.2.</span> <span class="toc-text"> Jne和Je指令分析</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%84%E5%AD%98%E5%99%A8%E8%BD%AE%E8%BD%AC"><span class="toc-number">2.3.5.</span> <span class="toc-text"> 寄存器轮转</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E7%A0%81%E5%8A%A0%E5%AF%86%E5%92%8C%E9%9A%8F%E6%9C%BA%E6%95%88%E9%AA%8C"><span class="toc-number">2.3.6.</span> <span class="toc-text"> 字节码加密和随机效验</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%AA%E6%8C%87%E4%BB%A4%E6%80%BB%E7%BB%93"><span class="toc-number">2.3.7.</span> <span class="toc-text"> 伪指令总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E6%8A%97%E6%80%9D%E8%B7%AF"><span class="toc-number">2.4.</span> <span class="toc-text"> 对抗思路</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E7%A0%81%E5%8F%8D%E7%BC%96%E8%AF%91"><span class="toc-number">2.4.1.</span> <span class="toc-text"> 字节码反编译</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%84%E5%AD%98%E5%99%A8%E8%AF%86%E5%88%AB"><span class="toc-number">2.4.2.</span> <span class="toc-text"> 寄存器识别</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%87%E4%BB%A4%E5%8C%96%E7%AE%80%E5%92%8C%E4%BC%98%E5%8C%96"><span class="toc-number">2.4.3.</span> <span class="toc-text"> 指令化简和优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BD%AC%E6%8D%A2%E6%B1%87%E7%BC%96"><span class="toc-number">2.4.4.</span> <span class="toc-text"> 转换汇编</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%8F%98%E5%BC%82"><span class="toc-number">3.</span> <span class="toc-text"> 代码变异</span></a></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#0078E7;"><link itemprop="mainEntityOfPage" href="http://npc0vo.github.io/2025/02/19/vmp%E7%9B%B8%E5%85%B33_vmp%E5%8E%9F%E7%90%86%E5%88%9D%E6%8E%A2/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="Npc"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="Npc | Blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">vmp相关3:vmp原理初探</h1><div class="post-meta"><div class="post-time" style="display:block"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-line"></span></span> <time title="Created: 2025-02-19 12:52:15" itemprop="dateCreated datePublished" datetime="2025-02-19T12:52:15+08:00">2025-02-19</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-2-line"></span></span> <time title="Modified: 2025-03-20 13:03:44" itemprop="dateModified" datetime="2025-03-20T13:03:44+08:00">2025-03-20</time></div><span class="post-count"><span class="post-symbolcount"><span class="post-meta-item-icon" title="Word count in article"><span class="icon iconify" data-icon="ri:file-word-line"></span></span> <span title="Word count in article">3.2k</span><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="Reading time"><span class="icon iconify" data-icon="ri:timer-line"></span></span> <span title="Reading time">12m</span></span></span><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><span class="icon iconify" data-icon="ri:folder-line"></span></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/vmp/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">vmp</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/Reverse/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="tag-name">Reverse</span></a><a class="tag-item" href="/tags/vmp/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="tag-name">vmp</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><blockquote>
<p>记录阅读vmp分析博客中过程中vmp涉及到的大部分原理</p>
</blockquote>
<h2 id="vmp简单介绍"><a class="markdownIt-Anchor" href="#vmp简单介绍"></a> VMP简单介绍</h2>
<p>虚拟机保护特征</p>
<ol>
<li>将由编译器生成的本机代码(Native Code)转换成字节码(Bytecode)</li>
<li>将控制权交由虚拟机，由虚拟机来控制执行</li>
<li>转换后的字节码非常难以阅读，增加了破解的复杂性</li>
</ol>
<p>虚拟机其实就是一个字节码解释器，它循环的读取指令并执行，并且它</p>
<p>只有一个入口和一个出口(vm_exit)。大量的fake jcc（虚假跳转）和 垃圾指令使原来十分简单的代码 变得非常复杂</p>
<img src="/2025/02/19/vmp%E7%9B%B8%E5%85%B33_vmp%E5%8E%9F%E7%90%86%E5%88%9D%E6%8E%A2/1740916463674-408a56d4-383a-42ed-b3e4-83b48505441f.png" class="" loading="lazy">
<p>加入垃圾指令以及虚假跳转后的cfg</p>
<img src="/2025/02/19/vmp%E7%9B%B8%E5%85%B33_vmp%E5%8E%9F%E7%90%86%E5%88%9D%E6%8E%A2/1740916506340-f5715bab-5309-4fdb-9c59-57b0a75ee4b1.png" class="" loading="lazy">
<p>vmp进行代码保护的<strong>关键功能</strong>是**虚拟化 **和 **代码变异 **</p>
<p>其他小功能包括:</p>
<ul>
<li>调试器检测</li>
<li>虚拟机检测</li>
<li>内存保护</li>
<li>资源保护</li>
<li>文件压缩</li>
</ul>
<p>…</p>
<img src="/2025/02/19/vmp%E7%9B%B8%E5%85%B33_vmp%E5%8E%9F%E7%90%86%E5%88%9D%E6%8E%A2/1741074631778-6cf296f8-bbe3-41ff-9028-37e219e8d1f0.png" class="" loading="lazy">
<h2 id="虚拟化"><a class="markdownIt-Anchor" href="#虚拟化"></a> 虚拟化</h2>
<h3 id="vm基本结构"><a class="markdownIt-Anchor" href="#vm基本结构"></a> vm基本结构</h3>
<p>在详细介绍vmp虚拟化保护之前，首先要介绍一下虚拟化保护所用到的几个结构体</p>
<h3 id="font-stylecolorrgb25-27-31dispatcherfont"><a class="markdownIt-Anchor" href="#font-stylecolorrgb25-27-31dispatcherfont"></a> <font style="color:rgb(25, 27, 31);">dispatcher</font></h3>
<p><font style="color:rgb(25, 27, 31);">在VMP1/2中会有一个分发器，所有Handler的地址都存在一个数组中，很容易就能把所有Handler找出来；但到了3，分发方式变成从字节码中解码出下一条指令的地址。</font></p>
<h3 id="handler"><a class="markdownIt-Anchor" href="#handler"></a> Handler</h3>
<p>VMP是基于<strong>堆栈的虚拟机</strong>（Stack-Based VirtualMachine）</p>
<p>vmp通过dispatcher将程序流程的字节码分发到各个handler，模拟执行各种指令，因此分析vmp的关键逻辑就需要分析清楚走到的每个handler</p>
<p>汇编指令在转换到虚拟机的指令体系的过程中，被最大限度的化简和归类了，VMP中的<br />
指令大体分以下几类：</p>
<ol>
<li>算术运算和移位运算</li>
<li>堆栈操作</li>
<li>内存操作</li>
<li>系统相关（无法模拟指令）</li>
<li>逻辑运算</li>
<li>jcc跳转</li>
</ol>
<h4 id="堆栈操作"><a class="markdownIt-Anchor" href="#堆栈操作"></a> 堆栈操作</h4>
<p>在vmp初始化的过程中，会随机挑选一个寄存器当做虚拟机的堆栈，并维护一个结构体指向<code>VM_Context</code>保存虚拟机状态的寄存器</p>
<p>涉及到的伪指令包括<code>vPushReg``vPushImm``vPopReg``vPopImm</code>等</p>
<h4 id="算术运算和移位运算"><a class="markdownIt-Anchor" href="#算术运算和移位运算"></a> 算术运算和移位运算</h4>
<p>由于<code>vmp</code>是基于堆栈的虚拟机，因此算术运算也都是利用堆栈进行的</p>
<ol>
<li>vAdd</li>
</ol>
<p>一般是 先出栈两个值 计算结果后保存到栈顶；往往计算完成后，之后的处理实际上是计算<code>add_eflags</code>然后再保存到栈顶</p>
<ol start="2">
<li>vshl</li>
</ol>
<p>一般是 先出栈两个值 次栈顶 &lt;&lt;  栈顶  计算结果后保存到栈顶</p>
<h4 id="逻辑运算指令"><a class="markdownIt-Anchor" href="#逻辑运算指令"></a> 逻辑运算指令</h4>
<blockquote>
<p>关键转换公式 ： nor电路   把nor操作(只有not 和and) 记为P操作:</p>
<p>P(a,b) = ~a &amp; ~b</p>
<p>not(a) = P(a,a)       1次P运算</p>
<p>and(a,b)= P(P(a,a),P(b,b))  	3次P运算</p>
<p>or(a,b) = P(P(a,b),P(a,b))   	2次P运算</p>
<p>xor(a,b)= P(P(P(a,a),P(b,b)),P(a,b))  	5次P运算</p>
<p>简单运用离散数学的知识就可以证明</p>
</blockquote>
<p>Vmp中的逻辑运算只有一条指令:nor。这个指令在电路门中叫NOR门，它</p>
<p>由三条指令组成，即not not and，</p>
<p>与NAND门一样，用它可以模拟not</p>
<p>and xor or这四条逻辑运算指令</p>
<h4 id="jcc"><a class="markdownIt-Anchor" href="#jcc"></a> jcc</h4>
<p>vmp固然很强，但是带来的运行开销实在太大了。把一个大型应用全部放在vmp运行必然是不现实的，因此绝大多数程序只会在验证等关键函数加上vmp，而程序的主体逻辑并不会加vmp,因此如果我们能找到vmp的jcc关键逻辑，并强行修改，我们就相当于直接破解了这个程序</p>
<p>同时，识别<code>jcc</code>指令后我们可以用模拟执行程序构建出整个程序的cfg，</p>
<p><a target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-1696058-1-1.html">https://www.52pojie.cn/thread-1696058-1-1.html</a></p>
<p><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-254445.htm">[分享]VMP学习笔记之万用门（七）-加壳脱壳-看雪-安全社区|安全招聘|kanxue.com</a></p>
<p><code>vmp</code><strong>实际上是通过</strong><code>eflags</code><strong>和</strong><code>cmp</code><strong>来模拟</strong><code>jcc</code><strong>指令</strong></p>
<p><font style="color:rgb(68, 68, 68);">x86指令的cmp实际是执行的减法操作，只是不改变操作数的值，而是程序状态寄存器eflags的值。vmp模拟的减法指令如下：</font></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">x<span class="token operator">-</span>y <span class="token operator">=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token operator">~</span>x<span class="token operator">+</span>y<span class="token punctuation">)</span>
简单证明<span class="token punctuation">:</span>  <span class="token operator">-</span>A<span class="token operator">=</span><span class="token operator">~</span>A<span class="token operator">+</span><span class="token number">1</span>
<span class="token operator">~</span><span class="token punctuation">(</span><span class="token operator">~</span>x<span class="token operator">+</span>y<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token operator">-</span>x<span class="token operator">+</span>y<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">-</span><span class="token punctuation">(</span><span class="token operator">-</span>x<span class="token operator">+</span>y<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">=</span>x<span class="token operator">-</span>y<span class="token operator">+</span><span class="token number">1</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">=</span>x<span class="token operator">-</span>y<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><code>eflags</code>的计算</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">eflags1 <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">~</span>x<span class="token operator">+</span>y<span class="token punctuation">)</span>
eflags2 <span class="token punctuation">:</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token operator">~</span>x<span class="token operator">+</span>y<span class="token punctuation">)</span>
eflags <span class="token operator">=</span> <span class="token punctuation">(</span>eflags1 <span class="token operator">&amp;</span> <span class="token number">0x815</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>elfags2 <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token number">0x815</span><span class="token punctuation">)</span>
至于eflags1<span class="token punctuation">,</span>eflags2我们可以并不关心<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>eflags</code>的reg图</p>
<img src="/2025/02/19/vmp%E7%9B%B8%E5%85%B33_vmp%E5%8E%9F%E7%90%86%E5%88%9D%E6%8E%A2/1741255396781-b7d17276-652a-4546-bf5e-0c26c07f9cc2.png" class="" loading="lazy">
<p><font style="color:rgb(0, 0, 0);">数字:0x815     0x246    0x206    0x216    0x40 会在</font><font style="color:rgb(0, 0, 0);">vmp</font><font style="color:rgb(0, 0, 0);">经常出现</font></p>
<p><font style="color:rgb(0, 0, 0);">0x815的二进制：100000010101</font></p>
<img src="/2025/02/19/vmp%E7%9B%B8%E5%85%B33_vmp%E5%8E%9F%E7%90%86%E5%88%9D%E6%8E%A2/1741255429584-1fb51fdd-0f4b-4f06-b734-61d9ab01d34e.png" class="" loading="lazy">
<p><font style="color:rgb(0, 0, 0);">其实等价于OF AF PF CF的mask。</font></p>
<img src="/2025/02/19/vmp%E7%9B%B8%E5%85%B33_vmp%E5%8E%9F%E7%90%86%E5%88%9D%E6%8E%A2/1741255482748-7a6ab801-ee03-431f-875e-8ad93b087221.png" class="" loading="lazy">
<p>0x0040其实是ZF的mask</p>
<p><font style="color:rgb(0, 0, 0);">eflags = and( eflags1, 0x815) + and( eflags2, not(0x815))   </font></p>
<p>例如在<code>vmp</code>我们可以类似找到<code>ZF</code>的计算过程</p>
<p><font style="color:rgb(0, 0, 0);">~zf  = and(0x40,not(eflags)) = 0     </font></p>
<p><font style="color:rgb(0, 0, 0);">zf=p(not(0x40),eflags)</font></p>
<h5 id="font-stylecolorrgb68-68-68jge和jl指令分析font"><a class="markdownIt-Anchor" href="#font-stylecolorrgb68-68-68jge和jl指令分析font"></a> <font style="color:rgb(68, 68, 68);">Jge和Jl指令分析</font></h5>
<p><code>Jge</code>指令分析</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">y <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">~</span><span class="token punctuation">(</span>eflags10_0 <span class="token operator">^</span> eflags12_68<span class="token punctuation">)</span>  <span class="token operator">&amp;</span>  <span class="token punctuation">(</span><span class="token operator">~</span><span class="token number">0xffffffbf</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token operator">>></span>  <span class="token number">6</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><font style="color:rgb(68, 68, 68);">判断SF标志位是否等于OF标志位，如果等于则输出为1，否则为0。SF==OF刚好是jge指令的跳转条件，这里~0xffffffbf </font></p>
<p><font style="color:rgb(68, 68, 68);">= 0x40是取zf标志位的值</font></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">令dword_ss<span class="token punctuation">[</span><span class="token number">0xffffcf14</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xffffffff</span> <span class="token operator">+</span> y，y等于<span class="token number">0</span>或<span class="token number">1</span>
则vmbytecode读取指针vm_ip <span class="token operator">=</span> <span class="token punctuation">(</span>dword_ss<span class="token punctuation">[</span><span class="token number">0xffffcf14</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x43db9e</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token operator">~</span>dword_ss<span class="token punctuation">[</span><span class="token number">0xffffcf14</span><span class="token punctuation">]</span>  <span class="token operator">&amp;</span> <span class="token number">0x43dc22</span><span class="token punctuation">)</span> <span class="token operator">+</span> dword_ss<span class="token punctuation">[</span><span class="token number">0xffffcfcc</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><font style="color:rgb(68, 68, 68);">0x43dc22为满足跳转条件时的读取地址，否则为0x43db9e。这里加一个dword_ss[0xffffcfcc]是为了重定位，如果程序加载的是默认基址的话dword_ss[0xffffcfcc]为0。同理，vmp访问全局变量前也是要重定位处理。需要注意的是模拟执行的过程中出现的一些常量并不是固定的。比如0xffffffbf、0x815、0x80、0x800等，有时候会对这些常量取反。</font></p>
<p><code>JL</code>:</p>
<p><font style="color:rgb(68, 68, 68);">jl指令和jge指令的区别在于上面的异或运算结果有没有取反，其它都差不多。</font></p>
<h5 id="font-stylecolorrgb68-68-68jne和je指令分析font"><a class="markdownIt-Anchor" href="#font-stylecolorrgb68-68-68jne和je指令分析font"></a> <font style="color:rgb(68, 68, 68);">Jne和Je指令分析</font></h5>
<p><font style="color:rgb(68, 68, 68);">jne指令和jge指令模拟执行的区别在于上图下面的异或运算被替换成了eflags的还原运算，直接获取ZF标志位进行判断，其它都差不多。而jne指令与je指令的区别在于eflags的还原运算后有没有取反。</font></p>
<p><font style="color:rgb(68, 68, 68);">vmp模拟执行分支指令的一些特征如下：<br />
</font><font style="color:rgb(68, 68, 68);">1、eflags寄存器的值参与了运算，正常编写程序几乎不会用到eflags寄存器。<br />
</font><font style="color:rgb(68, 68, 68);">2、模拟分支指令的过程中会用到一些常量，比如0xffffffbf、0x815、0x80、0x800等。<br />
</font><font style="color:rgb(68, 68, 68);">3、vm_ip的两个跳转地址也参与了运算。<br />
</font><font style="color:rgb(68, 68, 68);">根据以上几个特征以及一些模拟运算的特征，可以判断vmp是否在模拟分支指令的执行。模拟过程中的常量比如0x40、0x800等可以确定可能使用了哪些分支指令，一般是两个相反跳转条件的分支指令。再根据eflags还原后的结果或者异或运算后的结果有没有取反来确定是哪一个分支指令。最后根据用于修改vm_ip的两个目的地址中，有兄弟节点是取反运算的则为满足跳转条件的地址，比如je指令的DAG图里的0x40add8就是满足跳转条件的目的地址。</font></p>
<h4 id="寄存器轮转"><a class="markdownIt-Anchor" href="#寄存器轮转"></a> 寄存器轮转</h4>
<p>VMP将所有寄存器都存放在了堆栈的结构中（VM_CONTEXT）， 结构中的每一项代表一个寄存器或者临时变量。</p>
<p>但在运行过程中，其中的项所映射的真实寄存器都是不固 定的，可以把它比作一个齿轮，每做完一个动作，部分项 的映射就互换了一下位置，或者执行完一段指令，齿轮就 按不固定的方向和度数转动一下，然后全部的项映射就改 变了。</p>
<p>VMP在生成字节码的过程中，维护了一份结构中每一项所映射的真实寄存器，但这只存在于编译过程，而在运行时 是没有明确的信息的。这直接导致了分析和识别的难度。</p>
<h4 id="字节码加密和随机效验"><a class="markdownIt-Anchor" href="#字节码加密和随机效验"></a> 字节码加密和随机效验</h4>
<p>VMP把解码算法分布到了Dispatch和每个 Handler中，只有在取指令和取数据时才会解密</p>
<p>，而每个解码的算法也都是不同的，并且它的 Seed每次解密都会变化的。</p>
<ul>
<li>可以写出字节码的逆算法-代价较高</li>
<li>实战还是Hook更省事(需要解决代码hash检测)(vmp运行的过程中会随机对代码段进行检测，如果出错就无法运行</li>
</ul>
<p>VMP注册版中有一条叫指令（ calchash），就 是用来做检测的。VMP会在编译好的字节码中加 一些自己的指令，每次执行都会随机对一段代码 生成一个Hash结果，然后与另一个随机的数相加 ，结果必须为0，否则就会出错。如果要爆破或者修改VMP的代码，还需要处理这个过程。</p>
<h4 id="伪指令总结"><a class="markdownIt-Anchor" href="#伪指令总结"></a> 伪指令总结</h4>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-54535.htm">https://bbs.kanxue.com/thread-54535.htm</a></p>
</blockquote>
<p><font style="color:rgb(0, 0, 0);">PUSH类：</font><br />
<font style="color:rgb(0, 0, 0);">VM_PUSHW                     1000177F   </font><br />
<font style="color:rgb(0, 0, 0);">VM_PUSHW_CONTEXT             10001957   </font><br />
<font style="color:rgb(0, 0, 0);">VM_PUSHW_CONTEXTBH           100019A7   </font><br />
<font style="color:rgb(0, 0, 0);">VM_PUSHW_CONTEXTBL           10001A61   </font><br />
<font style="color:rgb(0, 0, 0);">VM_PUSHW_IMMW                10001B68   </font><br />
<font style="color:rgb(0, 0, 0);">VM_PUSH_CONTEXT              10001AB3   </font><br />
<font style="color:rgb(0, 0, 0);">VM_PUSH_CR0                  1000185E   </font><br />
<font style="color:rgb(0, 0, 0);">VM_PUSH_CR1                  10001164   </font><br />
<font style="color:rgb(0, 0, 0);">VM_PUSH_CR2                  10001820   </font><br />
<font style="color:rgb(0, 0, 0);">VM_PUSH_CR3                  100012D9   </font><br />
<font style="color:rgb(0, 0, 0);">VM_PUSH_CR4                  10001776   </font><br />
<font style="color:rgb(0, 0, 0);">VM_PUSH_CR5                  10001A31   </font><br />
<font style="color:rgb(0, 0, 0);">VM_PUSH_CR6                  10001AF6   </font><br />
<font style="color:rgb(0, 0, 0);">VM_PUSH_CR7                  100012F4   </font><br />
<font style="color:rgb(0, 0, 0);">VM_PUSH_CS                   10001B44   </font><br />
<font style="color:rgb(0, 0, 0);">VM_PUSH_DR0                  100045CB   </font><br />
<font style="color:rgb(0, 0, 0);">VM_PUSH_DR1                  100012EB   </font><br />
<font style="color:rgb(0, 0, 0);">VM_PUSH_DR2                  10001180   </font><br />
<font style="color:rgb(0, 0, 0);">VM_PUSH_DR3                  10001090   </font><br />
<font style="color:rgb(0, 0, 0);">VM_PUSH_DR4                  10001087   </font><br />
<font style="color:rgb(0, 0, 0);">VM_PUSH_DR5                  10001019   </font><br />
<font style="color:rgb(0, 0, 0);">VM_PUSH_DR6                  100010F6   </font><br />
<font style="color:rgb(0, 0, 0);">VM_PUSH_DR7                  10001855   </font><br />
<font style="color:rgb(0, 0, 0);">VM_PUSH_DS                   1000123B   </font><br />
<font style="color:rgb(0, 0, 0);">VM_PUSH_ES                   1000122C   </font><br />
<font style="color:rgb(0, 0, 0);">VM_PUSH_ESP                  100017DE   </font><br />
<font style="color:rgb(0, 0, 0);">VM_PUSH_FS                   1000114D   </font><br />
<font style="color:rgb(0, 0, 0);">VM_PUSH_GS                   100045A7   </font><br />
<font style="color:rgb(0, 0, 0);">VM_PUSH_IMM                  10001A41   </font><br />
<font style="color:rgb(0, 0, 0);">VM_PUSH_IMMB                 10001099   </font><br />
<font style="color:rgb(0, 0, 0);">VM_PUSH_IMMW                 100019F7   </font><br />
<font style="color:rgb(0, 0, 0);">VM_PUSH_SP                   1000458F   </font><br />
<font style="color:rgb(0, 0, 0);">VM_PUSH_SS                   1000184B   </font></p>
<p><font style="color:rgb(0, 0, 0);">POP类：</font><br />
<font style="color:rgb(0, 0, 0);">VM_POPW_CONTEXT              100012FD   </font><br />
<font style="color:rgb(0, 0, 0);">VM_POPW_CONTEXTBH            10001867   </font><br />
<font style="color:rgb(0, 0, 0);">VM_POPW_CONTEXTBL            10001BE1   </font><br />
<font style="color:rgb(0, 0, 0);">VM_POP_CONTEXT               10001BBB   </font><br />
<font style="color:rgb(0, 0, 0);">VM_POP_CR0                   100012E2   </font><br />
<font style="color:rgb(0, 0, 0);">VM_POP_CR1                   100018E7   </font><br />
<font style="color:rgb(0, 0, 0);">VM_POP_CR2                   100012A8   </font><br />
<font style="color:rgb(0, 0, 0);">VM_POP_CR3                   10001032   </font><br />
<font style="color:rgb(0, 0, 0);">VM_POP_CR4                   100018DE   </font><br />
<font style="color:rgb(0, 0, 0);">VM_POP_CR5                   10001A9E   </font><br />
<font style="color:rgb(0, 0, 0);">VM_POP_CR6                   1000116D   </font><br />
<font style="color:rgb(0, 0, 0);">VM_POP_CR7                   10001A7B   </font><br />
<font style="color:rgb(0, 0, 0);">VM_POP_CX                    10001368   </font><br />
<font style="color:rgb(0, 0, 0);">VM_POP_DR0                   100017B7   </font><br />
<font style="color:rgb(0, 0, 0);">VM_POP_DR1                   1000119F   </font><br />
<font style="color:rgb(0, 0, 0);">VM_POP_DR2                   10001AED   </font><br />
<font style="color:rgb(0, 0, 0);">VM_POP_DR3                   10001BFB   </font><br />
<font style="color:rgb(0, 0, 0);">VM_POP_DR4                   10001BA7   </font><br />
<font style="color:rgb(0, 0, 0);">VM_POP_DR5                   10001945   </font><br />
<font style="color:rgb(0, 0, 0);">VM_POP_DR6                   1000113A   </font><br />
<font style="color:rgb(0, 0, 0);">VM_POP_DR7                   100011B0   </font><br />
<font style="color:rgb(0, 0, 0);">VM_POP_DS                    100018F0   </font><br />
<font style="color:rgb(0, 0, 0);">VM_POP_ECX                   100018B4   </font><br />
<font style="color:rgb(0, 0, 0);">VM_POP_ES                    100012CF   </font><br />
<font style="color:rgb(0, 0, 0);">VM_POP_ESP                   100011CB   </font><br />
<font style="color:rgb(0, 0, 0);">VM_POP_FS                    100011A8   </font><br />
<font style="color:rgb(0, 0, 0);">VM_POP_GS                    100045C1   </font><br />
<font style="color:rgb(0, 0, 0);">VM_POP_SP                    1000102B   </font></p>
<p><font style="color:rgb(0, 0, 0);">MUL/ADD/DIV类：</font><br />
<font style="color:rgb(0, 0, 0);">VM_ADD                       10001838   </font><br />
<font style="color:rgb(0, 0, 0);">VM_ADDB                      100010DD   </font><br />
<font style="color:rgb(0, 0, 0);">VM_ADDB_F                    10001AA7   </font><br />
<font style="color:rgb(0, 0, 0);">VM_ADDW                      10001BB0   </font><br />
<font style="color:rgb(0, 0, 0);">VM_ADDW_F                    100012B1   </font><br />
<font style="color:rgb(0, 0, 0);">VM_ADD_F                     100019C2   </font><br />
<font style="color:rgb(0, 0, 0);">VM_DIV                       1000190A   </font><br />
<font style="color:rgb(0, 0, 0);">VM_DIVW                      100010CB   </font><br />
<font style="color:rgb(0, 0, 0);">VM_DIVW_QUOTIENT             10001123   </font><br />
<font style="color:rgb(0, 0, 0);">VM_IDIV                      100018A8   </font><br />
<font style="color:rgb(0, 0, 0);">VM_IDIVW                     1000121A   </font><br />
<font style="color:rgb(0, 0, 0);">VM_IDIVW_QUOTIENT            10001B24   </font><br />
<font style="color:rgb(0, 0, 0);">VM_IMULB_F                   1000104A   </font><br />
<font style="color:rgb(0, 0, 0);">VM_IMULW_F                   1000124A   </font><br />
<font style="color:rgb(0, 0, 0);">VM_IMUL_F                    10001157  </font><br />
<font style="color:rgb(0, 0, 0);">VM_MULB_F                    1000196D   </font><br />
<font style="color:rgb(0, 0, 0);">VM_MULW_F                    1000197C   </font><br />
<font style="color:rgb(0, 0, 0);">VM_MUL_F                     100019EA  </font></p>
<p><font style="color:rgb(0, 0, 0);">FLOAT类：</font><br />
<font style="color:rgb(0, 0, 0);">VM_F2XM1                     10001898   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FABS                      100011F9   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FADD                      100018BA   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FADDQ                     10001060   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FCHS                      10001998   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FCOMP                     10001AE5   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FCOMPQ                    1000199F   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FCOS                      1000136F   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FDECSTP                   10001AFF   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FDIV                      10001233   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FDIVQ                     100017EF   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FILD                      1000455C   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FILDQ                     10001916   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FINCSTP                   10001071   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FISTP                     10004554   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FISTPQ                    100012A0   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FISTPW                    1000100A   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FISUB                     10001200   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FISUBW                    10001B52   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FLD                       10001932   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FLD1                      100010FF   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FLDCW                     100017A8   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FLDLG2                    100017B0   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FLDLN2                    10001346   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FLDPI                     10001A3A   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FLDQ                      10001208   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FLDT                      10001B15   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FLDZ                      10001B1D   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FMUL                      10001242   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FMULQ                     10001A84   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FNCLEX                    10001059   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FNINIT                    100017CA   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FNSTCWW                   100018F7   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FNSTSWW                   10001A28   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FPATAN                    10001829   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FPREM                     1000453A   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FPREM1                    100010EF   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FPTAN                     10001B4B   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FRNDINT                   100019DC   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FSIN                      1000133F   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FSQRT                     10001012   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FST                       100010E7   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FSTP                      10001830   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FSTPQ                     1000457D   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FSTPT                     10001890   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FSTQ                      100018CF   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FSUB                      10001B85   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FSUBQ                     10001805   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FSUBR                     10001197   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FSUBRQ                    100011C3   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FTST                      100018D7   </font><br />
<font style="color:rgb(0, 0, 0);">VM_FYL2X                     100019E3   </font></p>
<p><font style="color:rgb(0, 0, 0);">MOV类（分为byte,Word,DW几种），将[esp+0]定义为参数A,[esp+sizeof(operand)]定义为参数B,</font><br />
<font style="color:rgb(0, 0, 0);">VM_MOVB_A_TO_B               10004571   </font><br />
<font style="color:rgb(0, 0, 0);">VM_MOVB_B_TO_A               100011EF   </font><br />
<font style="color:rgb(0, 0, 0);">VM_MOVB_B_TO_CSA             10001ACA   </font><br />
<font style="color:rgb(0, 0, 0);">VM_MOVB_B_TO_ESA             100011E4   </font><br />
<font style="color:rgb(0, 0, 0);">VM_MOVB_B_TO_FSA             100017E4   </font><br />
<font style="color:rgb(0, 0, 0);">VM_MOVB_B_TO_GSA             1000193A   </font><br />
<font style="color:rgb(0, 0, 0);">VM_MOVB_B_TO_SSA             1000135D   </font><br />
<font style="color:rgb(0, 0, 0);">VM_MOVB_CSA_TO_B             1000191E   </font><br />
<font style="color:rgb(0, 0, 0);">VM_MOVB_GSA_TO_B             100010C0   </font><br />
<font style="color:rgb(0, 0, 0);">VM_MOVW_A_TO_B               10001887   </font><br />
<font style="color:rgb(0, 0, 0);">VM_MOVW_A_TO_SS              100011B9   </font><br />
<font style="color:rgb(0, 0, 0);">VM_MOVW_B_TO_A               10001B31   </font><br />
<font style="color:rgb(0, 0, 0);">VM_MOVW_B_TO_CSA             10001176   </font><br />
<font style="color:rgb(0, 0, 0);">VM_MOVW_B_TO_ESA             100017C0   </font><br />
<font style="color:rgb(0, 0, 0);">VM_MOVW_B_TO_FSA             1000125C   </font><br />
<font style="color:rgb(0, 0, 0);">VM_MOVW_B_TO_GSA             100045AF   </font><br />
<font style="color:rgb(0, 0, 0);">VM_MOVW_B_TO_SSA             1000198E   </font><br />
<font style="color:rgb(0, 0, 0);">VM_MOVW_CSA_TO_B             10001B3A   </font><br />
<font style="color:rgb(0, 0, 0);">VM_MOVW_ESA_TO_B             10001143   </font><br />
<font style="color:rgb(0, 0, 0);">VM_MOVW_FSA_TO_B             10001130   </font><br />
<font style="color:rgb(0, 0, 0);">VM_MOVW_GSA_TO_B             10001841   </font><br />
<font style="color:rgb(0, 0, 0);">VM_MOVW_SSA_TO_B             10004585   </font><br />
<font style="color:rgb(0, 0, 0);">VM_MOVZXB_ESA_TO_B           10001B9A   </font><br />
<font style="color:rgb(0, 0, 0);">VM_MOVZXB_FSA_TO_B           100018C2   </font><br />
<font style="color:rgb(0, 0, 0);">VM_MOVZXB_SSA_TO_B           10001BD4   </font><br />
<font style="color:rgb(0, 0, 0);">VM_MOV_A_TO_B                10004541   </font><br />
<font style="color:rgb(0, 0, 0);">VM_MOV_B_TO_A                100045B9   </font><br />
<font style="color:rgb(0, 0, 0);">VM_MOV_B_TO_CSA              10001068   </font><br />
<font style="color:rgb(0, 0, 0);">VM_MOV_B_TO_ESA              10001078   </font><br />
<font style="color:rgb(0, 0, 0);">VM_MOV_B_TO_FSA              1000194E   </font><br />
<font style="color:rgb(0, 0, 0);">VM_MOV_B_TO_GSA              10001A95   </font><br />
<font style="color:rgb(0, 0, 0);">VM_MOV_B_TO_SSA              10001929   </font><br />
<font style="color:rgb(0, 0, 0);">VM_MOV_CSA_TO_B              10001A8C   </font><br />
<font style="color:rgb(0, 0, 0);">VM_MOV_ESA_TO_B              1000179F   </font><br />
<font style="color:rgb(0, 0, 0);">VM_MOV_FSA_TO_B              10001022   </font><br />
<font style="color:rgb(0, 0, 0);">VM_MOV_GSA_TO_B              1000189F   </font><br />
<font style="color:rgb(0, 0, 0);">VM_MOV_SSA_TO_B              1000111A</font><br />
<font style="color:rgb(0, 0, 0);">  </font></p>
<p><font style="color:rgb(0, 0, 0);">移位类</font><br />
<font style="color:rgb(0, 0, 0);">VM_SHL                       10004549   </font><br />
<font style="color:rgb(0, 0, 0);">VM_SHLB                      10004564   </font><br />
<font style="color:rgb(0, 0, 0);">VM_SHLB_F                    100019CD   </font><br />
<font style="color:rgb(0, 0, 0);">VM_SHLD_F                    10001811   </font><br />
<font style="color:rgb(0, 0, 0);">VM_SHLW                      10004599   </font><br />
<font style="color:rgb(0, 0, 0);">VM_SHLW_F                    1000134D   </font><br />
<font style="color:rgb(0, 0, 0);">VM_SHL_F                     10001B8D   </font><br />
<font style="color:rgb(0, 0, 0);">VM_SHR                       100018FF   </font><br />
<font style="color:rgb(0, 0, 0);">VM_SHRB                      10001322   </font><br />
<font style="color:rgb(0, 0, 0);">VM_SHRB_F                    10001313   </font><br />
<font style="color:rgb(0, 0, 0);">VM_SHRD_F                    10001B06   </font><br />
<font style="color:rgb(0, 0, 0);">VM_SHRW                      10001B5A   </font><br />
<font style="color:rgb(0, 0, 0);">VM_SHRW_F                    10001AD5   </font><br />
<font style="color:rgb(0, 0, 0);">VM_SHR_F                     100017D1   </font></p>
<p><font style="color:rgb(0, 0, 0);">变形类</font><br />
<font style="color:rgb(0, 0, 0);">VM_NA_B_ANDW                 100017F7   </font><br />
<font style="color:rgb(0, 0, 0);">VM_NA_B_ANDW_F               1000132F   </font><br />
<font style="color:rgb(0, 0, 0);">VM_NA_NB_AND                 10001189   </font><br />
<font style="color:rgb(0, 0, 0);">VM_NA_NB_ANDW                100012BE   </font><br />
<font style="color:rgb(0, 0, 0);">VM_NA_NB_ANDW_F              100011D1   </font><br />
<font style="color:rgb(0, 0, 0);">VM_NA_NB_AND_F               10001A14   </font></p>
<p><font style="color:rgb(0, 0, 0);">杂类</font><br />
<font style="color:rgb(0, 0, 0);">VM_RETF                      1000180D   </font><br />
<font style="color:rgb(0, 0, 0);">VM_RETN                      10001A24  </font><br />
<font style="color:rgb(0, 0, 0);">VM_WAIT                      10001081  </font></p>
<h3 id="对抗思路"><a class="markdownIt-Anchor" href="#对抗思路"></a> 对抗思路</h3>
<p>目前已经提出针对vmp的保护措施的对抗思路:</p>
<h4 id="字节码反编译"><a class="markdownIt-Anchor" href="#字节码反编译"></a> 字节码反编译</h4>
<p>传统的逆向思路:</p>
<p>要逆向一个vmp</p>
<p>首先要看穿vmp插入的大量垃圾指令，虚假跳转的汇编中寻找真实的指令，并且要顾虑寄存器轮转的问题</p>
<p>分析清楚几百个handler</p>
<p>然后根据handler把基于堆栈低级汇编写出来，再进一步优化成标准的汇编</p>
<p>遇到稍微复杂点的程序，工作量实在是太大了</p>
<p>我的评价是:<strong>人生苦短，远离vmp</strong></p>
<h4 id="寄存器识别"><a class="markdownIt-Anchor" href="#寄存器识别"></a> 寄存器识别</h4>
<p>在虚拟机运行时，寄存器的作用发生了交替</p>
<p>要识别前面所代表的寄存器，要从以下几个方面进行分析：</p>
<ol>
<li>
<p>初始化虚拟机时各项所映射的寄存器</p>
</li>
<li>
<p>根据汇编转换规则映射或者结束映射某项到某寄存器</p>
</li>
<li>
<p>退出虚拟机时通过弹出各项时确定各项最终映射的寄存器</p>
</li>
</ol>
<p>从这三方面可以大体推理出各项所映射的寄存器</p>
<p>但仅仅是这样的话，只有在没有跳转指令的字节码中，成功率才最高。</p>
<p>因为还得考虑寄存器轮转</p>
<ul>
<li>基本块内的寄存器轮转</li>
<li>基本块间的寄存器轮转</li>
</ul>
<h4 id="指令化简和优化"><a class="markdownIt-Anchor" href="#指令化简和优化"></a> 指令化简和优化</h4>
<ul>
<li>常数收缩</li>
</ul>
<img src="/2025/02/19/vmp%E7%9B%B8%E5%85%B33_vmp%E5%8E%9F%E7%90%86%E5%88%9D%E6%8E%A2/1740918273673-a29374e2-5aa0-45fa-a6ab-253788993de4.png" class="" loading="lazy">
<ul>
<li>活跃变量分析</li>
</ul>
<img src="/2025/02/19/vmp%E7%9B%B8%E5%85%B33_vmp%E5%8E%9F%E7%90%86%E5%88%9D%E6%8E%A2/1740918290468-07f7f9fc-ce60-4c02-af54-d9c2e32a86f8.png" class="" loading="lazy">
<ul>
<li>删除无关代码</li>
</ul>
<p>VMP在生成的字节码中夹杂了一些自己的指令流，这些指令与原汇编代码没有任何关系，且对还原分析没有任何好处，只会起到干扰的 作用。需要根据特征制定一些规则来识别这些垃圾指令.</p>
<p>目前也有人提出了应用<strong>机器学习</strong>来进行自动化匹配的指令化简和优化的方法</p>
<h4 id="转换汇编"><a class="markdownIt-Anchor" href="#转换汇编"></a> 转换汇编</h4>
<ul>
<li>文本表达转换为树形表达</li>
<li>收集转换规则</li>
<li>使用匹配规则迭代匹配汇编指令</li>
<li>编译优化</li>
</ul>
<p>…</p>
<h2 id="代码变异"><a class="markdownIt-Anchor" href="#代码变异"></a> 代码变异</h2>
<p>特征是:插入大量junkcode</p>
<p>控制流的混淆（将一个函数块拆分然后跳来跳去）</p>
</div></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2025/02/23/vmp%E7%9B%B8%E5%85%B34%EF%BC%9Avmp1.8%E5%88%9D%E6%8E%A2/" rel="prev" title="vmp相关4:vmp1.8初探"><span class="icon iconify" data-icon="ri:arrow-left-s-line"></span><span class="post-nav-text">vmp相关4:vmp1.8初探</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2025/02/17/vmp%E7%9B%B8%E5%85%B32%EF%BC%9A%E5%8F%8D%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90/" rel="next" title="vmp相关2：反调试分析"><span class="post-nav-text">vmp相关2：反调试分析</span><span class="icon iconify" data-icon="ri:arrow-right-s-line"></span></a></div></div></div><div class="hty-card" id="comment"><div class="comment-tooltip text-center"><span>您需要科学上网，才可使用评论区功能。</span><br></div><div id="waline"></div><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@waline/client@v2/dist/waline.css"><script>window.CONFIG.waline.config.path = "/2025/02/19/vmp%E7%9B%B8%E5%85%B33_vmp%E5%8E%9F%E7%90%86%E5%88%9D%E6%8E%A2/"</script><div class="js-Pjax"><script src="/js/comments/waline.js" type="module" defer></script></div></div></main><footer class="sidebar-translate" id="footer"><div class="beian"><a rel="noopener" href="https://beian.miit.gov.cn/" target="_blank"></a></div><div class="copyright"><span>&copy; 2023 – 2025 </span><span class="with-love" id="animate"><span class="icon iconify" data-icon="ri:cloud-line"></span></span><span class="author"> Npc</span></div><div class="footer-custom-text">=w=</div></footer></div><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><span class="icon iconify" data-icon="ri:arrow-up-s-line"></span><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="Search"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:search-line"></span></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script src="https://fastly.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js"></script><script src="/js/search/local-search.js" defer type="module"></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><span class="icon iconify" data-icon="ri:close-line"></span></span></div><div class="search-input-container"><input class="search-input" id="local-search-input" type="text" placeholder="Searching..." value=""></div><div class="search-result-container"></div></div><script src="https://fastly.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js"></script><script>const images = [...document.querySelectorAll('.markdown-body img')]
mediumZoom(images)</script><style>.medium-zoom-image {
  z-index: 99;
}</style></body></html>